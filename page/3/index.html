<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="“你好，我是李帅奇，Android 系统工程师，MineCraft 忠实玩家，设计和绘画爱好者，缺妹纸晚期患者，熬夜星人。”"><meta name="keywords" content=""><meta name="author" content="Coolqi.Li,undefined"><meta name="copyright" content="Coolqi.Li"><title>Every day is always sleepy. | Coolqi`s Blog</title><link rel="shortcut icon" href="/my-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.5.6"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.5.6"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="author-info"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">Coolqi.Li</div><div class="author-info__description text-center">“你好，我是李帅奇，Android 系统工程师，MineCraft 忠实玩家，设计和绘画爱好者，缺妹纸晚期患者，熬夜星人。”</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">64</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">14</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">15</span></a></div></div></div><nav class="no-bg" id="nav"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Coolqi`s Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span></div><div id="site-info"><div id="site-title">Coolqi`s Blog</div><div id="site-sub-title">Every day is always sleepy.</div></div></nav><div id="sidebar"><div class="author-info"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">Coolqi.Li</div><div class="author-info__description text-center">“你好，我是李帅奇，Android 系统工程师，MineCraft 忠实玩家，设计和绘画爱好者，缺妹纸晚期患者，熬夜星人。”</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">64</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">14</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">15</span></a></div></div></div><div id="content-outer"><div class="layout" id="content-inner"><div class="recent-post-item article-container"><a class="article-title" href="/2017/08/13/AppOps 第 2 篇 - AppOpsManager 分析/">AppOps 第 2 篇 - AppOpsManager 分析</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2017-08-13</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/AndroidFramework源码分析/">AndroidFramework源码分析</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/AndroidFramework源码分析/AppOps应用操作管理/">AppOps应用操作管理</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/AppOps应用操作管理/">AppOps应用操作管理</a></span><div class="content"><p>[toc]</p>
<p>本文基于 Android 7.1.1 源码分析，如有错误，欢迎指正，谢谢！</p>
<h1 id="0-综述"><a href="#0-综述" class="headerlink" title="0 综述"></a>0 综述</h1><p>AppOpsService 实现了大部分的核心功能逻辑，但它不能被其他模块直接调用访问，而是通过 AppOpsManager 提供访问接口。</p>
<h1 id="1-重要常量和变量"><a href="#1-重要常量和变量" class="headerlink" title="1 重要常量和变量"></a>1 重要常量和变量</h1><p>下面我们来看下 AppOpsManager 中定义的一些重要的变量和常量！</p>
<h2 id="1-1-Operation-Code"><a href="#1-1-Operation-Code" class="headerlink" title="1.1 Operation Code"></a>1.1 Operation Code</h2><p>AppOpsManager 一共定义了 64 种 Op Code，我们一起看下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// when adding one of these:</span></span><br><span class="line"><span class="comment">//  - increment _NUM_OP</span></span><br><span class="line"><span class="comment">//  - add rows to sOpToSwitch, sOpToString, sOpNames, sOpToPerms, sOpDefault</span></span><br><span class="line"><span class="comment">//  - add descriptive strings to Settings/res/values/arrays.xml</span></span><br><span class="line"><span class="comment">//  - add the op to the appropriate template in AppOpsState.OpsTemplate (settings app)</span></span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> No operation specified. */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_NONE = -<span class="number">1</span>;</span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> Access to coarse location information. */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_COARSE_LOCATION = <span class="number">0</span>;</span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> Access to fine location information. */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_FINE_LOCATION = <span class="number">1</span>;</span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> Causing GPS to run. */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_GPS = <span class="number">2</span>;</span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_VIBRATE = <span class="number">3</span>;</span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_READ_CONTACTS = <span class="number">4</span>;</span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_WRITE_CONTACTS = <span class="number">5</span>;</span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_READ_CALL_LOG = <span class="number">6</span>;</span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_WRITE_CALL_LOG = <span class="number">7</span>;</span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_READ_CALENDAR = <span class="number">8</span>;</span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_WRITE_CALENDAR = <span class="number">9</span>;</span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_WIFI_SCAN = <span class="number">10</span>;</span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_POST_NOTIFICATION = <span class="number">11</span>;</span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_NEIGHBORING_CELLS = <span class="number">12</span>;</span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_CALL_PHONE = <span class="number">13</span>;</span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_READ_SMS = <span class="number">14</span>;</span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_WRITE_SMS = <span class="number">15</span>;</span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_RECEIVE_SMS = <span class="number">16</span>;</span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_RECEIVE_EMERGECY_SMS = <span class="number">17</span>;</span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_RECEIVE_MMS = <span class="number">18</span>;</span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_RECEIVE_WAP_PUSH = <span class="number">19</span>;</span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_SEND_SMS = <span class="number">20</span>;</span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_READ_ICC_SMS = <span class="number">21</span>;</span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_WRITE_ICC_SMS = <span class="number">22</span>;</span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_WRITE_SETTINGS = <span class="number">23</span>;</span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_SYSTEM_ALERT_WINDOW = <span class="number">24</span>;</span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_ACCESS_NOTIFICATIONS = <span class="number">25</span>;</span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_CAMERA = <span class="number">26</span>;</span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_RECORD_AUDIO = <span class="number">27</span>;</span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_PLAY_AUDIO = <span class="number">28</span>;</span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_READ_CLIPBOARD = <span class="number">29</span>;</span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_WRITE_CLIPBOARD = <span class="number">30</span>;</span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_TAKE_MEDIA_BUTTONS = <span class="number">31</span>;</span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_TAKE_AUDIO_FOCUS = <span class="number">32</span>;</span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_AUDIO_MASTER_VOLUME = <span class="number">33</span>;</span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_AUDIO_VOICE_VOLUME = <span class="number">34</span>;</span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_AUDIO_RING_VOLUME = <span class="number">35</span>;</span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_AUDIO_MEDIA_VOLUME = <span class="number">36</span>;</span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_AUDIO_ALARM_VOLUME = <span class="number">37</span>;</span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_AUDIO_NOTIFICATION_VOLUME = <span class="number">38</span>;</span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_AUDIO_BLUETOOTH_VOLUME = <span class="number">39</span>;</span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_WAKE_LOCK = <span class="number">40</span>;</span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> Continually monitoring location data. */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_MONITOR_LOCATION = <span class="number">41</span>;</span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> Continually monitoring location data with a relatively high power request. */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_MONITOR_HIGH_POWER_LOCATION = <span class="number">42</span>;</span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> Retrieve current usage stats via &#123;<span class="doctag">@link</span> UsageStatsManager&#125;. */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_GET_USAGE_STATS = <span class="number">43</span>;</span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_MUTE_MICROPHONE = <span class="number">44</span>;</span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_TOAST_WINDOW = <span class="number">45</span>;</span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> Capture the device's display contents and/or audio */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_PROJECT_MEDIA = <span class="number">46</span>;</span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> Activate a VPN connection without user intervention. */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_ACTIVATE_VPN = <span class="number">47</span>;</span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> Access the WallpaperManagerAPI to write wallpapers. */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_WRITE_WALLPAPER = <span class="number">48</span>;</span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> Received the assist structure from an app. */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_ASSIST_STRUCTURE = <span class="number">49</span>;</span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> Received a screenshot from assist. */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_ASSIST_SCREENSHOT = <span class="number">50</span>;</span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> Read the phone state. */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_READ_PHONE_STATE = <span class="number">51</span>;</span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> Add voicemail messages to the voicemail content provider. */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_ADD_VOICEMAIL = <span class="number">52</span>;</span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> Access APIs for SIP calling over VOIP or WiFi. */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_USE_SIP = <span class="number">53</span>;</span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> Intercept outgoing calls. */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_PROCESS_OUTGOING_CALLS = <span class="number">54</span>;</span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> User the fingerprint API. */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_USE_FINGERPRINT = <span class="number">55</span>;</span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> Access to body sensors such as heart rate, etc. */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_BODY_SENSORS = <span class="number">56</span>;</span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> Read previously received cell broadcast messages. */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_READ_CELL_BROADCASTS = <span class="number">57</span>;</span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> Inject mock location into the system. */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_MOCK_LOCATION = <span class="number">58</span>;</span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> Read external storage. */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_READ_EXTERNAL_STORAGE = <span class="number">59</span>;</span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> Write external storage. */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_WRITE_EXTERNAL_STORAGE = <span class="number">60</span>;</span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> Turned on the screen. */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_TURN_SCREEN_ON = <span class="number">61</span>;</span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> Get device accounts. */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_GET_ACCOUNTS = <span class="number">62</span>;</span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> Control whether an application is allowed to run in the background. */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OP_RUN_IN_BACKGROUND = <span class="number">63</span>;</span><br></pre></td></tr></table></figure>
<p>具体的意思，这里就暂时不解释了！</p>
<p>我们可以看到，原生定义了 64 个 Operation Code，但是也支持扩充，从第一行的 log 中可以看出：如果想扩充，需要更新相应的集合！</p>
<p>同时，AppOpsManager 内部也定义了一些数组：</p>
<h3 id="1-1-1-数组-RUNTIME-PERMISSIONS-OPS"><a href="#1-1-1-数组-RUNTIME-PERMISSIONS-OPS" class="headerlink" title="1.1.1 数组 RUNTIME_PERMISSIONS_OPS"></a>1.1.1 数组 RUNTIME_PERMISSIONS_OPS</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span>[] RUNTIME_PERMISSIONS_OPS = &#123;</span><br><span class="line">        <span class="comment">// Contacts</span></span><br><span class="line">        OP_READ_CONTACTS,</span><br><span class="line">        OP_WRITE_CONTACTS,</span><br><span class="line">        OP_GET_ACCOUNTS,</span><br><span class="line">        <span class="comment">// Calendar</span></span><br><span class="line">        OP_READ_CALENDAR,</span><br><span class="line">        OP_WRITE_CALENDAR,</span><br><span class="line">        <span class="comment">// SMS</span></span><br><span class="line">        OP_SEND_SMS,</span><br><span class="line">        OP_RECEIVE_SMS,</span><br><span class="line">        OP_READ_SMS,</span><br><span class="line">        OP_RECEIVE_WAP_PUSH,</span><br><span class="line">        OP_RECEIVE_MMS,</span><br><span class="line">        OP_READ_CELL_BROADCASTS,</span><br><span class="line">        <span class="comment">// Storage</span></span><br><span class="line">        OP_READ_EXTERNAL_STORAGE,</span><br><span class="line">        OP_WRITE_EXTERNAL_STORAGE,</span><br><span class="line">        <span class="comment">// Location</span></span><br><span class="line">        OP_COARSE_LOCATION,</span><br><span class="line">        OP_FINE_LOCATION,</span><br><span class="line">        <span class="comment">// Phone</span></span><br><span class="line">        OP_READ_PHONE_STATE,</span><br><span class="line">        OP_CALL_PHONE,</span><br><span class="line">        OP_READ_CALL_LOG,</span><br><span class="line">        OP_WRITE_CALL_LOG,</span><br><span class="line">        OP_ADD_VOICEMAIL,</span><br><span class="line">        OP_USE_SIP,</span><br><span class="line">        OP_PROCESS_OUTGOING_CALLS,</span><br><span class="line">        <span class="comment">// Microphone</span></span><br><span class="line">        OP_RECORD_AUDIO,</span><br><span class="line">        <span class="comment">// Camera</span></span><br><span class="line">        OP_CAMERA,</span><br><span class="line">        <span class="comment">// Body sensors</span></span><br><span class="line">        OP_BODY_SENSORS</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>RUNTIME_PERMISSIONS_OPS 中定义了一些运行时权限相关的 Op，从名字我们能很容易看出他们映射的是什么运行时权限！</p>
<h3 id="1-1-2-数组-sOpToSwitch"><a href="#1-1-2-数组-sOpToSwitch" class="headerlink" title="1.1.2 数组 sOpToSwitch"></a>1.1.2 数组 sOpToSwitch</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span>[] sOpToSwitch = <span class="keyword">new</span> <span class="keyword">int</span>[] &#123;</span><br><span class="line">        OP_COARSE_LOCATION,</span><br><span class="line">        OP_COARSE_LOCATION,</span><br><span class="line">        OP_COARSE_LOCATION,</span><br><span class="line">        OP_VIBRATE,</span><br><span class="line">        OP_READ_CONTACTS,</span><br><span class="line">        OP_WRITE_CONTACTS,</span><br><span class="line">        OP_READ_CALL_LOG,</span><br><span class="line">        OP_WRITE_CALL_LOG,</span><br><span class="line">        OP_READ_CALENDAR,</span><br><span class="line">        OP_WRITE_CALENDAR,</span><br><span class="line">        OP_COARSE_LOCATION,</span><br><span class="line">        OP_POST_NOTIFICATION,</span><br><span class="line">        OP_COARSE_LOCATION,</span><br><span class="line">        OP_CALL_PHONE,</span><br><span class="line">        OP_READ_SMS,</span><br><span class="line">        OP_WRITE_SMS,</span><br><span class="line">        OP_RECEIVE_SMS,</span><br><span class="line">        OP_RECEIVE_SMS,</span><br><span class="line">        OP_RECEIVE_SMS,</span><br><span class="line">        OP_RECEIVE_SMS,</span><br><span class="line">        OP_SEND_SMS,</span><br><span class="line">        OP_READ_SMS,</span><br><span class="line">        OP_WRITE_SMS,</span><br><span class="line">        OP_WRITE_SETTINGS,</span><br><span class="line">        OP_SYSTEM_ALERT_WINDOW,</span><br><span class="line">        OP_ACCESS_NOTIFICATIONS,</span><br><span class="line">        OP_CAMERA,</span><br><span class="line">        OP_RECORD_AUDIO,</span><br><span class="line">        OP_PLAY_AUDIO,</span><br><span class="line">        OP_READ_CLIPBOARD,</span><br><span class="line">        OP_WRITE_CLIPBOARD,</span><br><span class="line">        OP_TAKE_MEDIA_BUTTONS,</span><br><span class="line">        OP_TAKE_AUDIO_FOCUS,</span><br><span class="line">        OP_AUDIO_MASTER_VOLUME,</span><br><span class="line">        OP_AUDIO_VOICE_VOLUME,</span><br><span class="line">        OP_AUDIO_RING_VOLUME,</span><br><span class="line">        OP_AUDIO_MEDIA_VOLUME,</span><br><span class="line">        OP_AUDIO_ALARM_VOLUME,</span><br><span class="line">        OP_AUDIO_NOTIFICATION_VOLUME,</span><br><span class="line">        OP_AUDIO_BLUETOOTH_VOLUME,</span><br><span class="line">        OP_WAKE_LOCK,</span><br><span class="line">        OP_COARSE_LOCATION,</span><br><span class="line">        OP_COARSE_LOCATION,</span><br><span class="line">        OP_GET_USAGE_STATS,</span><br><span class="line">        OP_MUTE_MICROPHONE,</span><br><span class="line">        OP_TOAST_WINDOW,</span><br><span class="line">        OP_PROJECT_MEDIA,</span><br><span class="line">        OP_ACTIVATE_VPN,</span><br><span class="line">        OP_WRITE_WALLPAPER,</span><br><span class="line">        OP_ASSIST_STRUCTURE,</span><br><span class="line">        OP_ASSIST_SCREENSHOT,</span><br><span class="line">        OP_READ_PHONE_STATE,</span><br><span class="line">        OP_ADD_VOICEMAIL,</span><br><span class="line">        OP_USE_SIP,</span><br><span class="line">        OP_PROCESS_OUTGOING_CALLS,</span><br><span class="line">        OP_USE_FINGERPRINT,</span><br><span class="line">        OP_BODY_SENSORS,</span><br><span class="line">        OP_READ_CELL_BROADCASTS,</span><br><span class="line">        OP_MOCK_LOCATION,</span><br><span class="line">        OP_READ_EXTERNAL_STORAGE,</span><br><span class="line">        OP_WRITE_EXTERNAL_STORAGE,</span><br><span class="line">        OP_TURN_SCREEN_ON,</span><br><span class="line">        OP_GET_ACCOUNTS,</span><br><span class="line">        OP_RUN_IN_BACKGROUND,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>数组 sOpToSwitch 的长度是 64，保存的是 Op 和 Op 的映射，下标 i 是具体的 Operation，而 value 对应 Operation 的允许情况将决定下标对应的 Operation 的允许情况！</p>
<p>一般情况下，是一对一的映射关系，比如 OP_RUN_IN_BACKGROUND 只和自身相对应，而 OP_COARSE_LOCATION，OP_FINE_LOCATION 和 OP_GPS 则是由 OP_COARSE_LOCATION 是否被运允许来统一决定！！</p>
<p>映射到界面上，就是一个 op 所谓 switch 开关决定一个或者多个 op 的允许情况！</p>
<h3 id="1-1-3-数组-sOpToString"><a href="#1-1-3-数组-sOpToString" class="headerlink" title="1.1.3 数组 sOpToString"></a>1.1.3 数组 sOpToString</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> String[] sOpToString = <span class="keyword">new</span> String[] &#123;</span><br><span class="line">        OPSTR_COARSE_LOCATION,</span><br><span class="line">        OPSTR_FINE_LOCATION,</span><br><span class="line">        <span class="keyword">null</span>,</span><br><span class="line">        <span class="keyword">null</span>,</span><br><span class="line">        OPSTR_READ_CONTACTS,</span><br><span class="line">        OPSTR_WRITE_CONTACTS,</span><br><span class="line">        OPSTR_READ_CALL_LOG,</span><br><span class="line">        OPSTR_WRITE_CALL_LOG,</span><br><span class="line">        OPSTR_READ_CALENDAR,</span><br><span class="line">        OPSTR_WRITE_CALENDAR,</span><br><span class="line">        <span class="keyword">null</span>,</span><br><span class="line">        <span class="keyword">null</span>,</span><br><span class="line">        <span class="keyword">null</span>,</span><br><span class="line">        OPSTR_CALL_PHONE,</span><br><span class="line">        OPSTR_READ_SMS,</span><br><span class="line">        <span class="keyword">null</span>,</span><br><span class="line">        OPSTR_RECEIVE_SMS,</span><br><span class="line">        <span class="keyword">null</span>,</span><br><span class="line">        OPSTR_RECEIVE_MMS,</span><br><span class="line">        OPSTR_RECEIVE_WAP_PUSH,</span><br><span class="line">        OPSTR_SEND_SMS,</span><br><span class="line">        <span class="keyword">null</span>,</span><br><span class="line">        <span class="keyword">null</span>,</span><br><span class="line">        OPSTR_WRITE_SETTINGS,</span><br><span class="line">        OPSTR_SYSTEM_ALERT_WINDOW,</span><br><span class="line">        <span class="keyword">null</span>,</span><br><span class="line">        OPSTR_CAMERA,</span><br><span class="line">        OPSTR_RECORD_AUDIO,</span><br><span class="line">        <span class="keyword">null</span>,</span><br><span class="line">        <span class="keyword">null</span>,</span><br><span class="line">        <span class="keyword">null</span>,</span><br><span class="line">        <span class="keyword">null</span>,</span><br><span class="line">        <span class="keyword">null</span>,</span><br><span class="line">        <span class="keyword">null</span>,</span><br><span class="line">        <span class="keyword">null</span>,</span><br><span class="line">        <span class="keyword">null</span>,</span><br><span class="line">        <span class="keyword">null</span>,</span><br><span class="line">        <span class="keyword">null</span>,</span><br><span class="line">        <span class="keyword">null</span>,</span><br><span class="line">        <span class="keyword">null</span>,</span><br><span class="line">        <span class="keyword">null</span>,</span><br><span class="line">        OPSTR_MONITOR_LOCATION,</span><br><span class="line">        OPSTR_MONITOR_HIGH_POWER_LOCATION,</span><br><span class="line">        OPSTR_GET_USAGE_STATS,</span><br><span class="line">        <span class="keyword">null</span>,</span><br><span class="line">        <span class="keyword">null</span>,</span><br><span class="line">        <span class="keyword">null</span>,</span><br><span class="line">        OPSTR_ACTIVATE_VPN,</span><br><span class="line">        <span class="keyword">null</span>,</span><br><span class="line">        <span class="keyword">null</span>,</span><br><span class="line">        <span class="keyword">null</span>,</span><br><span class="line">        OPSTR_READ_PHONE_STATE,</span><br><span class="line">        OPSTR_ADD_VOICEMAIL,</span><br><span class="line">        OPSTR_USE_SIP,</span><br><span class="line">        <span class="keyword">null</span>,</span><br><span class="line">        OPSTR_USE_FINGERPRINT,</span><br><span class="line">        OPSTR_BODY_SENSORS,</span><br><span class="line">        OPSTR_READ_CELL_BROADCASTS,</span><br><span class="line">        OPSTR_MOCK_LOCATION,</span><br><span class="line">        OPSTR_READ_EXTERNAL_STORAGE,</span><br><span class="line">        OPSTR_WRITE_EXTERNAL_STORAGE,</span><br><span class="line">        <span class="keyword">null</span>,</span><br><span class="line">        OPSTR_GET_ACCOUNTS,</span><br><span class="line">        <span class="keyword">null</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>数组 sOpToString 的长度是 64，保存的是 Op 和对应的字符串常量的映射，如果没有对应的字符串相映射，可以为 null；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Access to coarse location information. */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String OPSTR_COARSE_LOCATION = <span class="string">"android:coarse_location"</span>;</span><br><span class="line"><span class="comment">/** Access to fine location information. */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String OPSTR_FINE_LOCATION =</span><br><span class="line">        <span class="string">"android:fine_location"</span>;</span><br><span class="line"><span class="comment">/** Continually monitoring location data. */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String OPSTR_MONITOR_LOCATION</span><br><span class="line">        = <span class="string">"android:monitor_location"</span>;</span><br><span class="line"><span class="comment">/** Continually monitoring location data with a relatively high power request. */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String OPSTR_MONITOR_HIGH_POWER_LOCATION</span><br><span class="line">... ... ...</span><br></pre></td></tr></table></figure>
<p>可以看出来，这个 op 对应的 str 的格式是：“android:xxxxxx”</p>
<h3 id="1-1-4-数组-sOpPerms"><a href="#1-1-4-数组-sOpPerms" class="headerlink" title="1.1.4 数组 sOpPerms"></a>1.1.4 数组 sOpPerms</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> String[] sOpPerms = <span class="keyword">new</span> String[] &#123;</span><br><span class="line">        android.Manifest.permission.ACCESS_COARSE_LOCATION,</span><br><span class="line">        android.Manifest.permission.ACCESS_FINE_LOCATION,</span><br><span class="line">        <span class="keyword">null</span>,</span><br><span class="line">        android.Manifest.permission.VIBRATE,</span><br><span class="line">        android.Manifest.permission.READ_CONTACTS,</span><br><span class="line">        android.Manifest.permission.WRITE_CONTACTS,</span><br><span class="line">        android.Manifest.permission.READ_CALL_LOG,</span><br><span class="line">        android.Manifest.permission.WRITE_CALL_LOG,</span><br><span class="line">        android.Manifest.permission.READ_CALENDAR,</span><br><span class="line">        android.Manifest.permission.WRITE_CALENDAR,</span><br><span class="line">        android.Manifest.permission.ACCESS_WIFI_STATE,</span><br><span class="line">        <span class="keyword">null</span>, <span class="comment">// no permission required for notifications</span></span><br><span class="line">        <span class="keyword">null</span>, <span class="comment">// neighboring cells shares the coarse location perm</span></span><br><span class="line">        android.Manifest.permission.CALL_PHONE,</span><br><span class="line">        android.Manifest.permission.READ_SMS,</span><br><span class="line">        <span class="keyword">null</span>, <span class="comment">// no permission required for writing sms</span></span><br><span class="line">        android.Manifest.permission.RECEIVE_SMS,</span><br><span class="line">        android.Manifest.permission.RECEIVE_EMERGENCY_BROADCAST,</span><br><span class="line">        android.Manifest.permission.RECEIVE_MMS,</span><br><span class="line">        android.Manifest.permission.RECEIVE_WAP_PUSH,</span><br><span class="line">        android.Manifest.permission.SEND_SMS,</span><br><span class="line">        android.Manifest.permission.READ_SMS,</span><br><span class="line">        <span class="keyword">null</span>, <span class="comment">// no permission required for writing icc sms</span></span><br><span class="line">        android.Manifest.permission.WRITE_SETTINGS,</span><br><span class="line">        android.Manifest.permission.SYSTEM_ALERT_WINDOW,</span><br><span class="line">        android.Manifest.permission.ACCESS_NOTIFICATIONS,</span><br><span class="line">        android.Manifest.permission.CAMERA,</span><br><span class="line">        android.Manifest.permission.RECORD_AUDIO,</span><br><span class="line">        <span class="keyword">null</span>, <span class="comment">// no permission for playing audio</span></span><br><span class="line">        <span class="keyword">null</span>, <span class="comment">// no permission for reading clipboard</span></span><br><span class="line">        <span class="keyword">null</span>, <span class="comment">// no permission for writing clipboard</span></span><br><span class="line">        <span class="keyword">null</span>, <span class="comment">// no permission for taking media buttons</span></span><br><span class="line">        <span class="keyword">null</span>, <span class="comment">// no permission for taking audio focus</span></span><br><span class="line">        <span class="keyword">null</span>, <span class="comment">// no permission for changing master volume</span></span><br><span class="line">        <span class="keyword">null</span>, <span class="comment">// no permission for changing voice volume</span></span><br><span class="line">        <span class="keyword">null</span>, <span class="comment">// no permission for changing ring volume</span></span><br><span class="line">        <span class="keyword">null</span>, <span class="comment">// no permission for changing media volume</span></span><br><span class="line">        <span class="keyword">null</span>, <span class="comment">// no permission for changing alarm volume</span></span><br><span class="line">        <span class="keyword">null</span>, <span class="comment">// no permission for changing notification volume</span></span><br><span class="line">        <span class="keyword">null</span>, <span class="comment">// no permission for changing bluetooth volume</span></span><br><span class="line">        android.Manifest.permission.WAKE_LOCK,</span><br><span class="line">        <span class="keyword">null</span>, <span class="comment">// no permission for generic location monitoring</span></span><br><span class="line">        <span class="keyword">null</span>, <span class="comment">// no permission for high power location monitoring</span></span><br><span class="line">        android.Manifest.permission.PACKAGE_USAGE_STATS,</span><br><span class="line">        <span class="keyword">null</span>, <span class="comment">// no permission for muting/unmuting microphone</span></span><br><span class="line">        <span class="keyword">null</span>, <span class="comment">// no permission for displaying toasts</span></span><br><span class="line">        <span class="keyword">null</span>, <span class="comment">// no permission for projecting media</span></span><br><span class="line">        <span class="keyword">null</span>, <span class="comment">// no permission for activating vpn</span></span><br><span class="line">        <span class="keyword">null</span>, <span class="comment">// no permission for supporting wallpaper</span></span><br><span class="line">        <span class="keyword">null</span>, <span class="comment">// no permission for receiving assist structure</span></span><br><span class="line">        <span class="keyword">null</span>, <span class="comment">// no permission for receiving assist screenshot</span></span><br><span class="line">        Manifest.permission.READ_PHONE_STATE,</span><br><span class="line">        Manifest.permission.ADD_VOICEMAIL,</span><br><span class="line">        Manifest.permission.USE_SIP,</span><br><span class="line">        Manifest.permission.PROCESS_OUTGOING_CALLS,</span><br><span class="line">        Manifest.permission.USE_FINGERPRINT,</span><br><span class="line">        Manifest.permission.BODY_SENSORS,</span><br><span class="line">        Manifest.permission.READ_CELL_BROADCASTS,</span><br><span class="line">        <span class="keyword">null</span>,</span><br><span class="line">        Manifest.permission.READ_EXTERNAL_STORAGE,</span><br><span class="line">        Manifest.permission.WRITE_EXTERNAL_STORAGE,</span><br><span class="line">        <span class="keyword">null</span>, <span class="comment">// no permission for turning the screen on</span></span><br><span class="line">        Manifest.permission.GET_ACCOUNTS,</span><br><span class="line">        <span class="keyword">null</span>, <span class="comment">// no permission for running in background</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>数组 sOpPerms 的长度是 64，保存的是 Op 和对应权限的映射，如果没有对应的权限相映射，可以为 null；</p>
<p>可以看到，AppOps 不仅映射 dangerous 权限，还映射了 signature 权限！</p>
<h3 id="1-1-4-数组-sOpRestrictions"><a href="#1-1-4-数组-sOpRestrictions" class="headerlink" title="1.1.4 数组 sOpRestrictions"></a>1.1.4 数组 sOpRestrictions</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> String[] sOpRestrictions = <span class="keyword">new</span> String[] &#123;</span><br><span class="line">        UserManager.DISALLOW_SHARE_LOCATION, <span class="comment">//COARSE_LOCATION</span></span><br><span class="line">        UserManager.DISALLOW_SHARE_LOCATION, <span class="comment">//FINE_LOCATION</span></span><br><span class="line">        UserManager.DISALLOW_SHARE_LOCATION, <span class="comment">//GPS</span></span><br><span class="line">        <span class="keyword">null</span>, <span class="comment">//VIBRATE</span></span><br><span class="line">        <span class="keyword">null</span>, <span class="comment">//READ_CONTACTS</span></span><br><span class="line">        <span class="keyword">null</span>, <span class="comment">//WRITE_CONTACTS</span></span><br><span class="line">        UserManager.DISALLOW_OUTGOING_CALLS, <span class="comment">//READ_CALL_LOG</span></span><br><span class="line">        UserManager.DISALLOW_OUTGOING_CALLS, <span class="comment">//WRITE_CALL_LOG</span></span><br><span class="line">        <span class="keyword">null</span>, <span class="comment">//READ_CALENDAR</span></span><br><span class="line">        <span class="keyword">null</span>, <span class="comment">//WRITE_CALENDAR</span></span><br><span class="line">        UserManager.DISALLOW_SHARE_LOCATION, <span class="comment">//WIFI_SCAN</span></span><br><span class="line">        <span class="keyword">null</span>, <span class="comment">//POST_NOTIFICATION</span></span><br><span class="line">        <span class="keyword">null</span>, <span class="comment">//NEIGHBORING_CELLS</span></span><br><span class="line">        <span class="keyword">null</span>, <span class="comment">//CALL_PHONE</span></span><br><span class="line">        UserManager.DISALLOW_SMS, <span class="comment">//READ_SMS</span></span><br><span class="line">        UserManager.DISALLOW_SMS, <span class="comment">//WRITE_SMS</span></span><br><span class="line">        UserManager.DISALLOW_SMS, <span class="comment">//RECEIVE_SMS</span></span><br><span class="line">        <span class="keyword">null</span>, <span class="comment">//RECEIVE_EMERGENCY_SMS</span></span><br><span class="line">        UserManager.DISALLOW_SMS, <span class="comment">//RECEIVE_MMS</span></span><br><span class="line">        <span class="keyword">null</span>, <span class="comment">//RECEIVE_WAP_PUSH</span></span><br><span class="line">        UserManager.DISALLOW_SMS, <span class="comment">//SEND_SMS</span></span><br><span class="line">        UserManager.DISALLOW_SMS, <span class="comment">//READ_ICC_SMS</span></span><br><span class="line">        UserManager.DISALLOW_SMS, <span class="comment">//WRITE_ICC_SMS</span></span><br><span class="line">        <span class="keyword">null</span>, <span class="comment">//WRITE_SETTINGS</span></span><br><span class="line">        UserManager.DISALLOW_CREATE_WINDOWS, <span class="comment">//SYSTEM_ALERT_WINDOW</span></span><br><span class="line">        <span class="keyword">null</span>, <span class="comment">//ACCESS_NOTIFICATIONS</span></span><br><span class="line">        UserManager.DISALLOW_CAMERA, <span class="comment">//CAMERA</span></span><br><span class="line">        UserManager.DISALLOW_RECORD_AUDIO, <span class="comment">//RECORD_AUDIO</span></span><br><span class="line">        <span class="keyword">null</span>, <span class="comment">//PLAY_AUDIO</span></span><br><span class="line">        <span class="keyword">null</span>, <span class="comment">//READ_CLIPBOARD</span></span><br><span class="line">        <span class="keyword">null</span>, <span class="comment">//WRITE_CLIPBOARD</span></span><br><span class="line">        <span class="keyword">null</span>, <span class="comment">//TAKE_MEDIA_BUTTONS</span></span><br><span class="line">        <span class="keyword">null</span>, <span class="comment">//TAKE_AUDIO_FOCUS</span></span><br><span class="line">        UserManager.DISALLOW_ADJUST_VOLUME, <span class="comment">//AUDIO_MASTER_VOLUME</span></span><br><span class="line">        UserManager.DISALLOW_ADJUST_VOLUME, <span class="comment">//AUDIO_VOICE_VOLUME</span></span><br><span class="line">        UserManager.DISALLOW_ADJUST_VOLUME, <span class="comment">//AUDIO_RING_VOLUME</span></span><br><span class="line">        UserManager.DISALLOW_ADJUST_VOLUME, <span class="comment">//AUDIO_MEDIA_VOLUME</span></span><br><span class="line">        UserManager.DISALLOW_ADJUST_VOLUME, <span class="comment">//AUDIO_ALARM_VOLUME</span></span><br><span class="line">        UserManager.DISALLOW_ADJUST_VOLUME, <span class="comment">//AUDIO_NOTIFICATION_VOLUME</span></span><br><span class="line">        UserManager.DISALLOW_ADJUST_VOLUME, <span class="comment">//AUDIO_BLUETOOTH_VOLUME</span></span><br><span class="line">        <span class="keyword">null</span>, <span class="comment">//WAKE_LOCK</span></span><br><span class="line">        UserManager.DISALLOW_SHARE_LOCATION, <span class="comment">//MONITOR_LOCATION</span></span><br><span class="line">        UserManager.DISALLOW_SHARE_LOCATION, <span class="comment">//MONITOR_HIGH_POWER_LOCATION</span></span><br><span class="line">        <span class="keyword">null</span>, <span class="comment">//GET_USAGE_STATS</span></span><br><span class="line">        UserManager.DISALLOW_UNMUTE_MICROPHONE, <span class="comment">// MUTE_MICROPHONE</span></span><br><span class="line">        UserManager.DISALLOW_CREATE_WINDOWS, <span class="comment">// TOAST_WINDOW</span></span><br><span class="line">        <span class="keyword">null</span>, <span class="comment">//PROJECT_MEDIA</span></span><br><span class="line">        <span class="keyword">null</span>, <span class="comment">// ACTIVATE_VPN</span></span><br><span class="line">        UserManager.DISALLOW_WALLPAPER, <span class="comment">// WRITE_WALLPAPER</span></span><br><span class="line">        <span class="keyword">null</span>, <span class="comment">// ASSIST_STRUCTURE</span></span><br><span class="line">        <span class="keyword">null</span>, <span class="comment">// ASSIST_SCREENSHOT</span></span><br><span class="line">        <span class="keyword">null</span>, <span class="comment">// READ_PHONE_STATE</span></span><br><span class="line">        <span class="keyword">null</span>, <span class="comment">// ADD_VOICEMAIL</span></span><br><span class="line">        <span class="keyword">null</span>, <span class="comment">// USE_SIP</span></span><br><span class="line">        <span class="keyword">null</span>, <span class="comment">// PROCESS_OUTGOING_CALLS</span></span><br><span class="line">        <span class="keyword">null</span>, <span class="comment">// USE_FINGERPRINT</span></span><br><span class="line">        <span class="keyword">null</span>, <span class="comment">// BODY_SENSORS</span></span><br><span class="line">        <span class="keyword">null</span>, <span class="comment">// READ_CELL_BROADCASTS</span></span><br><span class="line">        <span class="keyword">null</span>, <span class="comment">// MOCK_LOCATION</span></span><br><span class="line">        <span class="keyword">null</span>, <span class="comment">// READ_EXTERNAL_STORAGE</span></span><br><span class="line">        <span class="keyword">null</span>, <span class="comment">// WRITE_EXTERNAL_STORAGE</span></span><br><span class="line">        <span class="keyword">null</span>, <span class="comment">// TURN_ON_SCREEN</span></span><br><span class="line">        <span class="keyword">null</span>, <span class="comment">// GET_ACCOUNTS</span></span><br><span class="line">        <span class="keyword">null</span>, <span class="comment">// RUN_IN_BACKGROUND</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>数组 sOpRestrictions 的长度为 64，用来指定 Op 是否应该受到用户限制的影响。每一个 Op 都应该和一个用户限制相映射，如果某个 Op 不受任何用户限制的影响，那么 value 为 null。</p>
<h3 id="1-1-5-数组-sOpAllowSystemRestrictionBypass"><a href="#1-1-5-数组-sOpAllowSystemRestrictionBypass" class="headerlink" title="1.1.5 数组 sOpAllowSystemRestrictionBypass"></a>1.1.5 数组 sOpAllowSystemRestrictionBypass</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">private static boolean[] sOpAllowSystemRestrictionBypass = new boolean[] &#123;</span><br><span class="line">        true, //COARSE_LOCATION</span><br><span class="line">        true, //FINE_LOCATION</span><br><span class="line">        false, //GPS</span><br><span class="line">        false, //VIBRATE</span><br><span class="line">        false, //READ_CONTACTS</span><br><span class="line">        false, //WRITE_CONTACTS</span><br><span class="line">        false, //READ_CALL_LOG</span><br><span class="line">        false, //WRITE_CALL_LOG</span><br><span class="line">        false, //READ_CALENDAR</span><br><span class="line">        false, //WRITE_CALENDAR</span><br><span class="line">        true, //WIFI_SCAN</span><br><span class="line">        false, //POST_NOTIFICATION</span><br><span class="line">        false, //NEIGHBORING_CELLS</span><br><span class="line">        false, //CALL_PHONE</span><br><span class="line">        false, //READ_SMS</span><br><span class="line">        false, //WRITE_SMS</span><br><span class="line">        false, //RECEIVE_SMS</span><br><span class="line">        false, //RECEIVE_EMERGECY_SMS</span><br><span class="line">        false, //RECEIVE_MMS</span><br><span class="line">        false, //RECEIVE_WAP_PUSH</span><br><span class="line">        false, //SEND_SMS</span><br><span class="line">        false, //READ_ICC_SMS</span><br><span class="line">        false, //WRITE_ICC_SMS</span><br><span class="line">        false, //WRITE_SETTINGS</span><br><span class="line">        true, //SYSTEM_ALERT_WINDOW</span><br><span class="line">        false, //ACCESS_NOTIFICATIONS</span><br><span class="line">        false, //CAMERA</span><br><span class="line">        false, //RECORD_AUDIO</span><br><span class="line">        false, //PLAY_AUDIO</span><br><span class="line">        false, //READ_CLIPBOARD</span><br><span class="line">        false, //WRITE_CLIPBOARD</span><br><span class="line">        false, //TAKE_MEDIA_BUTTONS</span><br><span class="line">        false, //TAKE_AUDIO_FOCUS</span><br><span class="line">        false, //AUDIO_MASTER_VOLUME</span><br><span class="line">        false, //AUDIO_VOICE_VOLUME</span><br><span class="line">        false, //AUDIO_RING_VOLUME</span><br><span class="line">        false, //AUDIO_MEDIA_VOLUME</span><br><span class="line">        false, //AUDIO_ALARM_VOLUME</span><br><span class="line">        false, //AUDIO_NOTIFICATION_VOLUME</span><br><span class="line">        false, //AUDIO_BLUETOOTH_VOLUME</span><br><span class="line">        false, //WAKE_LOCK</span><br><span class="line">        false, //MONITOR_LOCATION</span><br><span class="line">        false, //MONITOR_HIGH_POWER_LOCATION</span><br><span class="line">        false, //GET_USAGE_STATS</span><br><span class="line">        false, //MUTE_MICROPHONE</span><br><span class="line">        true, //TOAST_WINDOW</span><br><span class="line">        false, //PROJECT_MEDIA</span><br><span class="line">        false, //ACTIVATE_VPN</span><br><span class="line">        false, //WALLPAPER</span><br><span class="line">        false, //ASSIST_STRUCTURE</span><br><span class="line">        false, //ASSIST_SCREENSHOT</span><br><span class="line">        false, //READ_PHONE_STATE</span><br><span class="line">        false, //ADD_VOICEMAIL</span><br><span class="line">        false, // USE_SIP</span><br><span class="line">        false, // PROCESS_OUTGOING_CALLS</span><br><span class="line">        false, // USE_FINGERPRINT</span><br><span class="line">        false, // BODY_SENSORS</span><br><span class="line">        false, // READ_CELL_BROADCASTS</span><br><span class="line">        false, // MOCK_LOCATION</span><br><span class="line">        false, // READ_EXTERNAL_STORAGE</span><br><span class="line">        false, // WRITE_EXTERNAL_STORAGE</span><br><span class="line">        false, // TURN_ON_SCREEN</span><br><span class="line">        false, // GET_ACCOUNTS</span><br><span class="line">        false, // RUN_IN_BACKGROUND</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>数组 sOpAllowSystemRestrictionBypass 的长度为 64，数组下标表示具体的 Op，值表示相应的 Operation 是否允许 system 和 system ui 要绕开用户限制！</p>
<h3 id="1-1-5-数组-sOpDefaultMode"><a href="#1-1-5-数组-sOpDefaultMode" class="headerlink" title="1.1.5 数组 sOpDefaultMode"></a>1.1.5 数组 sOpDefaultMode</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span>[] sOpDefaultMode = <span class="keyword">new</span> <span class="keyword">int</span>[] &#123;</span><br><span class="line">        AppOpsManager.MODE_ALLOWED,</span><br><span class="line">        AppOpsManager.MODE_ALLOWED,</span><br><span class="line">        AppOpsManager.MODE_ALLOWED,</span><br><span class="line">        AppOpsManager.MODE_ALLOWED,</span><br><span class="line">        AppOpsManager.MODE_ALLOWED,</span><br><span class="line">        AppOpsManager.MODE_ALLOWED,</span><br><span class="line">        AppOpsManager.MODE_ALLOWED,</span><br><span class="line">        AppOpsManager.MODE_ALLOWED,</span><br><span class="line">        AppOpsManager.MODE_ALLOWED,</span><br><span class="line">        AppOpsManager.MODE_ALLOWED,</span><br><span class="line">        AppOpsManager.MODE_ALLOWED,</span><br><span class="line">        AppOpsManager.MODE_ALLOWED,</span><br><span class="line">        AppOpsManager.MODE_ALLOWED,</span><br><span class="line">        AppOpsManager.MODE_ALLOWED,</span><br><span class="line">        AppOpsManager.MODE_ALLOWED,</span><br><span class="line">        AppOpsManager.MODE_IGNORED, <span class="comment">// OP_WRITE_SMS</span></span><br><span class="line">        AppOpsManager.MODE_ALLOWED,</span><br><span class="line">        AppOpsManager.MODE_ALLOWED,</span><br><span class="line">        AppOpsManager.MODE_ALLOWED,</span><br><span class="line">        AppOpsManager.MODE_ALLOWED,</span><br><span class="line">        AppOpsManager.MODE_ALLOWED,</span><br><span class="line">        AppOpsManager.MODE_ALLOWED,</span><br><span class="line">        AppOpsManager.MODE_ALLOWED,</span><br><span class="line">        AppOpsManager.MODE_DEFAULT, <span class="comment">// OP_WRITE_SETTINGS</span></span><br><span class="line">        AppOpsManager.MODE_DEFAULT, <span class="comment">// OP_SYSTEM_ALERT_WINDOW</span></span><br><span class="line">        AppOpsManager.MODE_ALLOWED,</span><br><span class="line">        AppOpsManager.MODE_ALLOWED,</span><br><span class="line">        AppOpsManager.MODE_ALLOWED,</span><br><span class="line">        AppOpsManager.MODE_ALLOWED,</span><br><span class="line">        AppOpsManager.MODE_ALLOWED,</span><br><span class="line">        AppOpsManager.MODE_ALLOWED,</span><br><span class="line">        AppOpsManager.MODE_ALLOWED,</span><br><span class="line">        AppOpsManager.MODE_ALLOWED,</span><br><span class="line">        AppOpsManager.MODE_ALLOWED,</span><br><span class="line">        AppOpsManager.MODE_ALLOWED,</span><br><span class="line">        AppOpsManager.MODE_ALLOWED,</span><br><span class="line">        AppOpsManager.MODE_ALLOWED,</span><br><span class="line">        AppOpsManager.MODE_ALLOWED,</span><br><span class="line">        AppOpsManager.MODE_ALLOWED,</span><br><span class="line">        AppOpsManager.MODE_ALLOWED,</span><br><span class="line">        AppOpsManager.MODE_ALLOWED,</span><br><span class="line">        AppOpsManager.MODE_ALLOWED,</span><br><span class="line">        AppOpsManager.MODE_ALLOWED,</span><br><span class="line">        AppOpsManager.MODE_DEFAULT, <span class="comment">// OP_GET_USAGE_STATS</span></span><br><span class="line">        AppOpsManager.MODE_ALLOWED,</span><br><span class="line">        AppOpsManager.MODE_ALLOWED,</span><br><span class="line">        AppOpsManager.MODE_IGNORED, <span class="comment">// OP_PROJECT_MEDIA</span></span><br><span class="line">        AppOpsManager.MODE_IGNORED, <span class="comment">// OP_ACTIVATE_VPN</span></span><br><span class="line">        AppOpsManager.MODE_ALLOWED,</span><br><span class="line">        AppOpsManager.MODE_ALLOWED,</span><br><span class="line">        AppOpsManager.MODE_ALLOWED,</span><br><span class="line">        AppOpsManager.MODE_ALLOWED,</span><br><span class="line">        AppOpsManager.MODE_ALLOWED,</span><br><span class="line">        AppOpsManager.MODE_ALLOWED,</span><br><span class="line">        AppOpsManager.MODE_ALLOWED,</span><br><span class="line">        AppOpsManager.MODE_ALLOWED,</span><br><span class="line">        AppOpsManager.MODE_ALLOWED,</span><br><span class="line">        AppOpsManager.MODE_ALLOWED,</span><br><span class="line">        AppOpsManager.MODE_ERRORED,  <span class="comment">// OP_MOCK_LOCATION</span></span><br><span class="line">        AppOpsManager.MODE_ALLOWED,</span><br><span class="line">        AppOpsManager.MODE_ALLOWED,</span><br><span class="line">        AppOpsManager.MODE_ALLOWED,  <span class="comment">// OP_TURN_ON_SCREEN</span></span><br><span class="line">        AppOpsManager.MODE_ALLOWED,</span><br><span class="line">        AppOpsManager.MODE_ALLOWED,  <span class="comment">// OP_RUN_IN_BACKGROUND</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>数组 sOpDefaultMode 的长度为 64，用来指定每个 Operation 的默认允许情况（Mode）。</p>
<h3 id="1-1-5-数组-sOpDisableReset"><a href="#1-1-5-数组-sOpDisableReset" class="headerlink" title="1.1.5 数组 sOpDisableReset"></a>1.1.5 数组 sOpDisableReset</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span>[] sOpDisableReset = <span class="keyword">new</span> <span class="keyword">boolean</span>[] &#123;</span><br><span class="line">        <span class="keyword">false</span>,</span><br><span class="line">        <span class="keyword">false</span>,</span><br><span class="line">        <span class="keyword">false</span>,</span><br><span class="line">        <span class="keyword">false</span>,</span><br><span class="line">        <span class="keyword">false</span>,</span><br><span class="line">        <span class="keyword">false</span>,</span><br><span class="line">        <span class="keyword">false</span>,</span><br><span class="line">        <span class="keyword">false</span>,</span><br><span class="line">        <span class="keyword">false</span>,</span><br><span class="line">        <span class="keyword">false</span>,</span><br><span class="line">        <span class="keyword">false</span>,</span><br><span class="line">        <span class="keyword">false</span>,</span><br><span class="line">        <span class="keyword">false</span>,</span><br><span class="line">        <span class="keyword">false</span>,</span><br><span class="line">        <span class="keyword">false</span>,</span><br><span class="line">        <span class="keyword">true</span>,      <span class="comment">// OP_WRITE_SMS</span></span><br><span class="line">        <span class="keyword">false</span>,</span><br><span class="line">        <span class="keyword">false</span>,</span><br><span class="line">        <span class="keyword">false</span>,</span><br><span class="line">        <span class="keyword">false</span>,</span><br><span class="line">        <span class="keyword">false</span>,</span><br><span class="line">        <span class="keyword">false</span>,</span><br><span class="line">        <span class="keyword">false</span>,</span><br><span class="line">        <span class="keyword">false</span>,</span><br><span class="line">        <span class="keyword">false</span>,</span><br><span class="line">        <span class="keyword">false</span>,</span><br><span class="line">        <span class="keyword">false</span>,</span><br><span class="line">        <span class="keyword">false</span>,</span><br><span class="line">        <span class="keyword">false</span>,</span><br><span class="line">        <span class="keyword">false</span>,</span><br><span class="line">        <span class="keyword">false</span>,</span><br><span class="line">        <span class="keyword">false</span>,</span><br><span class="line">        <span class="keyword">false</span>,</span><br><span class="line">        <span class="keyword">false</span>,</span><br><span class="line">        <span class="keyword">false</span>,</span><br><span class="line">        <span class="keyword">false</span>,</span><br><span class="line">        <span class="keyword">false</span>,</span><br><span class="line">        <span class="keyword">false</span>,</span><br><span class="line">        <span class="keyword">false</span>,</span><br><span class="line">        <span class="keyword">false</span>,</span><br><span class="line">        <span class="keyword">false</span>,</span><br><span class="line">        <span class="keyword">false</span>,</span><br><span class="line">        <span class="keyword">false</span>,</span><br><span class="line">        <span class="keyword">false</span>,</span><br><span class="line">        <span class="keyword">false</span>,</span><br><span class="line">        <span class="keyword">false</span>,</span><br><span class="line">        <span class="keyword">false</span>,</span><br><span class="line">        <span class="keyword">false</span>,</span><br><span class="line">        <span class="keyword">false</span>,</span><br><span class="line">        <span class="keyword">false</span>,</span><br><span class="line">        <span class="keyword">false</span>,</span><br><span class="line">        <span class="keyword">false</span>,</span><br><span class="line">        <span class="keyword">false</span>,</span><br><span class="line">        <span class="keyword">false</span>,</span><br><span class="line">        <span class="keyword">false</span>,</span><br><span class="line">        <span class="keyword">false</span>,</span><br><span class="line">        <span class="keyword">false</span>,</span><br><span class="line">        <span class="keyword">false</span>,</span><br><span class="line">        <span class="keyword">false</span>,</span><br><span class="line">        <span class="keyword">false</span>,</span><br><span class="line">        <span class="keyword">false</span>,</span><br><span class="line">        <span class="keyword">false</span>,</span><br><span class="line">        <span class="keyword">false</span>,</span><br><span class="line">        <span class="keyword">false</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>数组 sOpDisableReset 的长度为 64，用来指定是否允许在重置所有应用偏好设置后，重置 Operation 的授予情况，true 表示禁止重置，false 表示允许重置。</p>
<h3 id="1-1-7-哈希表-sOpStrToOp-和-sRuntimePermToOp"><a href="#1-1-7-哈希表-sOpStrToOp-和-sRuntimePermToOp" class="headerlink" title="1.1.7 哈希表 sOpStrToOp 和 sRuntimePermToOp"></a>1.1.7 哈希表 sOpStrToOp 和 sRuntimePermToOp</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 用于保存 Op name 和 Op Code 的映射关系！</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> HashMap&lt;String, Integer&gt; sOpStrToOp = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用于保存运行时权限和 Op Code 的映射关系！</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> HashMap&lt;String, Integer&gt; sRuntimePermToOp = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br></pre></td></tr></table></figure>
<p>AppOpsManager 有一个静态代码块，static 静态代码块中，会对 AppOpsManager 的每个数组的长度进行 check，如果与 _NUM_OP 值不一致，就会抛异常，会导致开不了机。</p>
<p>同时也会对 sOpStrToOp 和 sRuntimePermToOp 进行初始化！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (sOpToSwitch.length != _NUM_OP) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"sOpToSwitch length "</span> + sOpToSwitch.length</span><br><span class="line">                + <span class="string">" should be "</span> + _NUM_OP);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (sOpToString.length != _NUM_OP) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"sOpToString length "</span> + sOpToString.length</span><br><span class="line">                + <span class="string">" should be "</span> + _NUM_OP);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (sOpNames.length != _NUM_OP) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"sOpNames length "</span> + sOpNames.length</span><br><span class="line">                + <span class="string">" should be "</span> + _NUM_OP);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (sOpPerms.length != _NUM_OP) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"sOpPerms length "</span> + sOpPerms.length</span><br><span class="line">                + <span class="string">" should be "</span> + _NUM_OP);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (sOpDefaultMode.length != _NUM_OP) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"sOpDefaultMode length "</span> + sOpDefaultMode.length</span><br><span class="line">                + <span class="string">" should be "</span> + _NUM_OP);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (sOpDisableReset.length != _NUM_OP) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"sOpDisableReset length "</span> + sOpDisableReset.length</span><br><span class="line">                + <span class="string">" should be "</span> + _NUM_OP);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (sOpRestrictions.length != _NUM_OP) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"sOpRestrictions length "</span> + sOpRestrictions.length</span><br><span class="line">                + <span class="string">" should be "</span> + _NUM_OP);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (sOpAllowSystemRestrictionBypass.length != _NUM_OP) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"sOpAllowSYstemRestrictionsBypass length "</span></span><br><span class="line">                + sOpRestrictions.length + <span class="string">" should be "</span> + _NUM_OP);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【1】初始化 sOpStrToOp</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;_NUM_OP; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (sOpToString[i] != <span class="keyword">null</span>) &#123;</span><br><span class="line">            sOpStrToOp.put(sOpToString[i], i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】初始化 sRuntimePermToOp</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> op : RUNTIME_PERMISSIONS_OPS) &#123;</span><br><span class="line">        <span class="keyword">if</span> (sOpPerms[op] != <span class="keyword">null</span>) &#123;</span><br><span class="line">            sRuntimePermToOp.put(sOpPerms[op], op);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="1-2-Operation-Mode"><a href="#1-2-Operation-Mode" class="headerlink" title="1.2 Operation Mode"></a>1.2 Operation Mode</h2><p>每一个 Operation Code 都会有如下的 4 中控制状态：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MODE_ALLOWED = <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<p>该值是 checkOp/noteOp/startOp 方法的返回结果之一，同时也是 Operation 的控制状态之一，表示调用者允许执行相应的操作！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MODE_IGNORED = <span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<p>该值是 checkOp/noteOp/startOp 方法的返回结果之一，同时也是 Operation 的控制状态之一，表示调用者不允许执行相应的操作！</p>
<p>返回该值不会导致应用因为没权限而 crash！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MODE_DEFAULT = <span class="number">3</span>;</span><br></pre></td></tr></table></figure>
<p>该值是 checkOp/noteOp/startOp 方法的返回结果之一，表示给定的调用者应该进行权限检查。这种模式通常不被使用; 它只能与 appop 权限一起使用，调用者必须明确检查并处理它。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MODE_ERRORED = <span class="number">2</span>;</span><br></pre></td></tr></table></figure>
<p>该值是 checkOpNoThrow/noteOpNoThrow/startOpNoThrow 方法的返回结果之一，表示调用者不允许执行相应的操作！</p>
<p>返回该值的同时，会抛出异常 SecurityException，导致应用因为没权限而 crash！</p>
<h2 id="1-3-属性相关方法"><a href="#1-3-属性相关方法" class="headerlink" title="1.3 属性相关方法"></a>1.3 属性相关方法</h2><h3 id="1-3-1-opToSwitch"><a href="#1-3-1-opToSwitch" class="headerlink" title="1.3.1 opToSwitch"></a>1.3.1 opToSwitch</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">opToSwitch</span><span class="params">(<span class="keyword">int</span> op)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> sOpToSwitch[op];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该方法会返回控制给定 op 的 op 开关（也是一个 op）</p>
<h3 id="1-3-2-opToName"><a href="#1-3-2-opToName" class="headerlink" title="1.3.2 opToName"></a>1.3.2 opToName</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">opToName</span><span class="params">(<span class="keyword">int</span> op)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (op == OP_NONE) <span class="keyword">return</span> <span class="string">"NONE"</span>;</span><br><span class="line">    <span class="keyword">return</span> op &lt; sOpNames.length ? sOpNames[op] : (<span class="string">"Unknown("</span> + op + <span class="string">")"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">strDebugOpToOp</span><span class="params">(String op)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;sOpNames.length; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (sOpNames[i].equals(op)) &#123;</span><br><span class="line">            <span class="keyword">return</span> i;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unknown operation string: "</span> + op);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上述两个方法用于在给定 op 和其对应的字符串名称之间相互转换，用于 debug，通过数组 sOpNames 获得对应的！</p>
<h3 id="1-3-3-opToName"><a href="#1-3-3-opToName" class="headerlink" title="1.3.3 opToName"></a>1.3.3 opToName</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">opToPermission</span><span class="params">(<span class="keyword">int</span> op)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> sOpPerms[op];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该方法会返回给定 op 对应的权限，如果没有返回 null，通过数组 sOpPerms 获得权限！</p>
<h3 id="1-3-4-opToRestriction"><a href="#1-3-4-opToRestriction" class="headerlink" title="1.3.4 opToRestriction"></a>1.3.4 opToRestriction</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">opToRestriction</span><span class="params">(<span class="keyword">int</span> op)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> sOpRestrictions[op];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该方法会返回和给定 op 相关联的用户限制，如果没有返回 null，通过数组 sOpRestrictions 获得权限！</p>
<h3 id="1-3-5-permissionToOpCode"><a href="#1-3-5-permissionToOpCode" class="headerlink" title="1.3.5 permissionToOpCode"></a>1.3.5 permissionToOpCode</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">permissionToOpCode</span><span class="params">(String permission)</span> </span>&#123;</span><br><span class="line">    Integer boxedOpCode = sRuntimePermToOp.get(permission);</span><br><span class="line">    <span class="keyword">return</span> boxedOpCode != <span class="keyword">null</span> ? boxedOpCode : OP_NONE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该方法会返回和指定运行时权限相关联的 Operation，如果没有返回 null，通过数组 sRuntimePermToOp 获得权限！</p>
<h3 id="1-3-6-opAllowSystemBypassRestriction"><a href="#1-3-6-opAllowSystemBypassRestriction" class="headerlink" title="1.3.6 opAllowSystemBypassRestriction"></a>1.3.6 opAllowSystemBypassRestriction</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">opAllowSystemBypassRestriction</span><span class="params">(<span class="keyword">int</span> op)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> sOpAllowSystemRestrictionBypass[op];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该方法用于判断指定的 Op 是否允许系统（和系统UI）绕过用户对操作的限制！</p>
<h3 id="1-3-7-opToDefaultMode"><a href="#1-3-7-opToDefaultMode" class="headerlink" title="1.3.7 opToDefaultMode"></a>1.3.7 opToDefaultMode</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">opToDefaultMode</span><span class="params">(<span class="keyword">int</span> op)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> sOpDefaultMode[op];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该方法用于返回指定的 op 的默认控制情况！</p>
<h3 id="1-3-8-opAllowsReset"><a href="#1-3-8-opAllowsReset" class="headerlink" title="1.3.8 opAllowsReset"></a>1.3.8 opAllowsReset</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">opAllowsReset</span><span class="params">(<span class="keyword">int</span> op)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> !sOpDisableReset[op];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该方法用于判断指定的 op 的是否允许自身的状态被重置！</p>
<h3 id="1-3-9-permissionToOp"><a href="#1-3-9-permissionToOp" class="headerlink" title="1.3.9 permissionToOp"></a>1.3.9 permissionToOp</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">permissionToOp</span><span class="params">(String permission)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Integer opCode = sRuntimePermToOp.get(permission);</span><br><span class="line">    <span class="keyword">if</span> (opCode == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sOpToString[opCode];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该方法用于获得指定的 permission 对应的 op 的名称！</p>
<h3 id="1-3-10-strOpToOp"><a href="#1-3-10-strOpToOp" class="headerlink" title="1.3.10 strOpToOp"></a>1.3.10 strOpToOp</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">strOpToOp</span><span class="params">(String op)</span> </span>&#123;</span><br><span class="line">    Integer val = sOpStrToOp.get(op);</span><br><span class="line">    <span class="keyword">if</span> (val == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unknown operation string: "</span> + op);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> val;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该方法用于获得指定的 op 字符串名称对应的 Operation Code！</p>
<p>#2 重要函数和接口</p>
<p>AppOpsManager 提供了大量的接口，用于设置和检查权限：</p>
<h2 id="2-1-setUidMode-相关方法"><a href="#2-1-setUidMode-相关方法" class="headerlink" title="2.1 setUidMode 相关方法"></a>2.1 setUidMode 相关方法</h2><p>设置 uid 的 mode：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUidMode</span><span class="params">(<span class="keyword">int</span> code, <span class="keyword">int</span> uid, <span class="keyword">int</span> mode)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        mService.setUidMode(code, uid, mode);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="meta">@SystemApi</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUidMode</span><span class="params">(String appOp, <span class="keyword">int</span> uid, <span class="keyword">int</span> mode)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        mService.setUidMode(AppOpsManager.strOpToOp(appOp), uid, mode);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>setUidMode 方法能够给属于该 uid 的所有应用程序的指定 op 设置控制状态！</p>
<h2 id="2-2-setUserRestriction-相关方法"><a href="#2-2-setUserRestriction-相关方法" class="headerlink" title="2.2 setUserRestriction 相关方法"></a>2.2 setUserRestriction 相关方法</h2><p>设置用户限制：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUserRestriction</span><span class="params">(<span class="keyword">int</span> code, <span class="keyword">boolean</span> restricted, IBinder token)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】调用了第二个方法！</span></span><br><span class="line">    setUserRestriction(code, restricted, token, <span class="comment">/*exceptionPackages*/</span><span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUserRestriction</span><span class="params">(<span class="keyword">int</span> code, <span class="keyword">boolean</span> restricted, IBinder token,</span></span></span><br><span class="line"><span class="function"><span class="params">        String[] exceptionPackages)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【2】调用了第三个方法！</span></span><br><span class="line">    setUserRestrictionForUser(code, restricted, token, exceptionPackages, mContext.getUserId());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUserRestrictionForUser</span><span class="params">(<span class="keyword">int</span> code, <span class="keyword">boolean</span> restricted, IBinder token,</span></span></span><br><span class="line"><span class="function"><span class="params">        String[] exceptionPackages, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        mService.setUserRestriction(code, restricted, token, userId, exceptionPackages);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>setUserRestriction 方法用于给指定的 op 设置用户限制！</p>
<h2 id="2-3-checkOp-相关方法"><a href="#2-3-checkOp-相关方法" class="headerlink" title="2.3 checkOp 相关方法"></a>2.3 checkOp 相关方法</h2><p>检查权限：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">checkOp</span><span class="params">(String op, <span class="keyword">int</span> uid, String packageName)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> checkOp(strOpToOp(op), uid, packageName);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">checkOp</span><span class="params">(<span class="keyword">int</span> op, <span class="keyword">int</span> uid, String packageName)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">int</span> mode = mService.checkOperation(op, uid, packageName);</span><br><span class="line">        <span class="keyword">if</span> (mode == MODE_ERRORED) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(buildSecurityExceptionMsg(op, uid, packageName));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> mode;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>checkOp 用于判断 package 是否允许执行相应的操作，如果不允许，会抛出 SecurityException 异常</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">checkOpNoThrow</span><span class="params">(String op, <span class="keyword">int</span> uid, String packageName)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> checkOpNoThrow(strOpToOp(op), uid, packageName);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">checkOpNoThrow</span><span class="params">(<span class="keyword">int</span> op, <span class="keyword">int</span> uid, String packageName)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mService.checkOperation(op, uid, packageName);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>checkOpNoThrow 用于判断 package 是否允许执行相应的操作，如果不允许，不会抛出 SecurityException 异常，会返回 MODE_ERRORED！</p>
<h2 id="2-4-noteOp-相关方法"><a href="#2-4-noteOp-相关方法" class="headerlink" title="2.4 noteOp 相关方法"></a>2.4 noteOp 相关方法</h2><p>检查权限，在检验后会做记录校验结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">noteOp</span><span class="params">(String op, <span class="keyword">int</span> uid, String packageName)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> noteOp(strOpToOp(op), uid, packageName);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span>    </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">noteOp</span><span class="params">(<span class="keyword">int</span> op, <span class="keyword">int</span> uid, String packageName)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">int</span> mode = mService.noteOperation(op, uid, packageName);</span><br><span class="line">        <span class="keyword">if</span> (mode == MODE_ERRORED) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(buildSecurityExceptionMsg(op, uid, packageName));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> mode;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>noteOp 和 checkOp 类似，但是在检验后会做记录校验结果，在结果为 MODE_ERRORED 的情况下，会抛出异常 SecurityException。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">noteOpNoThrow</span><span class="params">(String op, <span class="keyword">int</span> uid, String packageName)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> noteOpNoThrow(strOpToOp(op), uid, packageName);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">noteOpNoThrow</span><span class="params">(<span class="keyword">int</span> op, <span class="keyword">int</span> uid, String packageName)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mService.noteOperation(op, uid, packageName);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>noteOp 用于判断 package 是否允许执行相应的操作，在结果为 MODE_ERRORED 的情况下，不会抛出异常 SecurityException。</p>
<h2 id="2-5-noteProxyOp-相关方法"><a href="#2-5-noteProxyOp-相关方法" class="headerlink" title="2.5 noteProxyOp 相关方法"></a>2.5 noteProxyOp 相关方法</h2><p>检查跨进程 ipc 通信时，调用方 proxiedPackageName 是否有权限，在检验后会做记录校验结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">noteProxyOp</span><span class="params">(<span class="keyword">int</span> op, String proxiedPackageName)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】调用另外一个 noteProxyOpNoThrow 方法！</span></span><br><span class="line">    <span class="keyword">int</span> mode = noteProxyOpNoThrow(op, proxiedPackageName);</span><br><span class="line">    <span class="keyword">if</span> (mode == MODE_ERRORED) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"Proxy package "</span> + mContext.getOpPackageName()</span><br><span class="line">                + <span class="string">" from uid "</span> + Process.myUid() + <span class="string">" or calling package "</span></span><br><span class="line">                + proxiedPackageName + <span class="string">" from uid "</span> + Binder.getCallingUid()</span><br><span class="line">                + <span class="string">" not allowed to perform "</span> + sOpNames[op]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> mode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>另外一个方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">noteProxyOpNoThrow</span><span class="params">(<span class="keyword">int</span> op, String proxiedPackageName)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【1】调用服务端的 noteProxyOperation 方法！</span></span><br><span class="line">        <span class="keyword">return</span> mService.noteProxyOperation(op, mContext.getOpPackageName(),</span><br><span class="line">                Binder.getCallingUid(), proxiedPackageName);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>不多说了！</p>
<h2 id="2-6-startOp-相关方法"><a href="#2-6-startOp-相关方法" class="headerlink" title="2.6 startOp 相关方法"></a>2.6 startOp 相关方法</h2><p>用于监控长时间的 op 操作！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">startOp</span><span class="params">(<span class="keyword">int</span> op)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> startOp(op, Process.myUid(), mContext.getOpPackageName());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">startOp</span><span class="params">(<span class="keyword">int</span> op, <span class="keyword">int</span> uid, String packageName)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">int</span> mode = mService.startOperation(getToken(mService), op, uid, packageName);</span><br><span class="line">        <span class="keyword">if</span> (mode == MODE_ERRORED) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(buildSecurityExceptionMsg(op, uid, packageName));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> mode;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>startOp 用于报告应用程序已开始执行长时间运行的操作。 必须同时传入要检查的应用程序的 uid 和 packageName; 这个函数将验证这两个匹配，如果不匹配，则返回 MODE_IGNORED 。</p>
<p>如果此调用成功，则此应用程序的最后执行时间将更新为当前时间，并且该操作将被标记为 “正在运行”。 </p>
<p>在这种情况下，稍后必须调用 finishOp 来报告应用程序何时不再执行操作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">startOpNoThrow</span><span class="params">(<span class="keyword">int</span> op, <span class="keyword">int</span> uid, String packageName)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mService.startOperation(getToken(mService), op, uid, packageName);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>startOpNoThrow 和 startOp 类似，只是当结果为 MODE_ERRORED 时，不会抛出异常！</p>
<p>startOpNoThrow 方法调用的是 AppOpsService 的 startOperation 方法，第一个参数传入的是 getToken(mService)，这个方法会返回一个 ClientState 对象！</p>
<h2 id="2-7-finishOp-相关方法"><a href="#2-7-finishOp-相关方法" class="headerlink" title="2.7 finishOp 相关方法"></a>2.7 finishOp 相关方法</h2><p>结束 startOp 方法监控的操作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">finishOp</span><span class="params">(<span class="keyword">int</span> op)</span> </span>&#123;</span><br><span class="line">    finishOp(op, Process.myUid(), mContext.getOpPackageName());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">finishOp</span><span class="params">(String op, <span class="keyword">int</span> uid, String packageName)</span> </span>&#123;</span><br><span class="line">    finishOp(strOpToOp(op), uid, packageName);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">finishOp</span><span class="params">(<span class="keyword">int</span> op, <span class="keyword">int</span> uid, String packageName)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        mService.finishOperation(getToken(mService), op, uid, packageName);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>报告应用程序不再执行之前使用 startOp 开始的操作，此处提供的参数必须与 startOp 时传递的参数完全相同。</p>
<h2 id="2-8-startWatchingMode-相关方法"><a href="#2-8-startWatchingMode-相关方法" class="headerlink" title="2.8 startWatchingMode 相关方法"></a>2.8 startWatchingMode 相关方法</h2><p>这里我们一起看下 stopWatchingMode 方法！</p>
<ul>
<li><strong>startWatchingMode 方法</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startWatchingMode</span><span class="params">(String op, String packageName,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> OnOpChangedListener callback)</span> </span>&#123;</span><br><span class="line">    startWatchingMode(strOpToOp(op), packageName, callback);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startWatchingMode</span><span class="params">(<span class="keyword">int</span> op, String packageName, <span class="keyword">final</span> OnOpChangedListener callback)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mModeWatchers) &#123;</span><br><span class="line">        IAppOpsCallback cb = mModeWatchers.get(callback);</span><br><span class="line">        <span class="keyword">if</span> (cb == <span class="keyword">null</span>) &#123;</span><br><span class="line">            cb = <span class="keyword">new</span> IAppOpsCallback.Stub() &#123;</span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">opChanged</span><span class="params">(<span class="keyword">int</span> op, <span class="keyword">int</span> uid, String packageName)</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">if</span> (callback <span class="keyword">instanceof</span> OnOpChangedInternalListener) &#123;</span><br><span class="line">                        ((OnOpChangedInternalListener)callback).onOpChanged(op, packageName);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (sOpToString[op] != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        callback.onOpChanged(sOpToString[op], packageName);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            mModeWatchers.put(callback, cb);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//【1】调用了 AppOpsService 的相关接口！</span></span><br><span class="line">            mService.startWatchingMode(op, packageName, cb);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>startWatchingMode 监视给定应用程序中给定操作的模式的变化！当发生变化后会回调 OnOpChangedListener 接口！</p>
<ul>
<li><strong>stopWatchingMode 方法</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stopWatchingMode</span><span class="params">(OnOpChangedListener callback)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mModeWatchers) &#123;</span><br><span class="line">        IAppOpsCallback cb = mModeWatchers.get(callback);</span><br><span class="line">        <span class="keyword">if</span> (cb != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                mService.stopWatchingMode(cb);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>停止监控。 与 callback 回调相关的所有监控都将被删除！</p>
<h2 id="2-9-setMode-相关方法"><a href="#2-9-setMode-相关方法" class="headerlink" title="2.9 setMode 相关方法"></a>2.9 setMode 相关方法</h2><p>同样是设置 op 的 mode，setMode 方法选择更多些：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMode</span><span class="params">(<span class="keyword">int</span> code, <span class="keyword">int</span> uid, String packageName, <span class="keyword">int</span> mode)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        mService.setMode(code, uid, packageName, mode);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2017/08/13/Permission第 4 篇 - requestPermission 权限申请/">Permission第 4 篇 - requestPermission 权限申请</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2017-08-13</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/AndroidFramework源码分析/">AndroidFramework源码分析</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/AndroidFramework源码分析/Permission权限管理/">Permission权限管理</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/Permission权限管理/">Permission权限管理</a></span><div class="content"><p>[TOC]</p>
<h1 id="0-综述"><a href="#0-综述" class="headerlink" title="0 综述"></a>0 综述</h1><p>基于 Android 7.1.1 源码，分析系统的权限管理机制！</p>
<p>我们来分析下 dangerous 权限的申请，这类权限只能在 Activity 中申请，Activity 提供了如下接口，来帮助程序申请权限：</p>
<h1 id="1-Activity-requestPermissions-请求入口"><a href="#1-Activity-requestPermissions-请求入口" class="headerlink" title="1 Activity.requestPermissions - 请求入口"></a>1 Activity.requestPermissions - 请求入口</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">requestPermissions</span><span class="params">(@NonNull String[] permissions, <span class="keyword">int</span> requestCode)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mHasCurrentPermissionsRequest) &#123;</span><br><span class="line">        Log.w(TAG, <span class="string">"Can reqeust only one set of permissions at a time"</span>);</span><br><span class="line">        <span class="comment">//【1】防止同一时间多次申请权限！</span></span><br><span class="line">        onRequestPermissionsResult(requestCode, <span class="keyword">new</span> String[<span class="number">0</span>], <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】设置了发送给 packageInstaller 的 intent！</span></span><br><span class="line">    Intent intent = getPackageManager().buildRequestPermissionsIntent(permissions);</span><br><span class="line">    startActivityForResult(REQUEST_PERMISSIONS_WHO_PREFIX, intent, requestCode, <span class="keyword">null</span>);</span><br><span class="line">    mHasCurrentPermissionsRequest = <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="1-1-PackageManager-buildRequestPermissionsIntent"><a href="#1-1-PackageManager-buildRequestPermissionsIntent" class="headerlink" title="1.1 PackageManager.buildRequestPermissionsIntent"></a>1.1 PackageManager.buildRequestPermissionsIntent</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Intent <span class="title">buildRequestPermissionsIntent</span><span class="params">(@NonNull String[] permissions)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (ArrayUtils.isEmpty(permissions)) &#123;</span><br><span class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"permission cannot be null or empty"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    Intent intent = <span class="keyword">new</span> Intent(ACTION_REQUEST_PERMISSIONS);</span><br><span class="line">    intent.putExtra(EXTRA_REQUEST_PERMISSIONS_NAMES, permissions);</span><br><span class="line">    intent.setPackage(getPermissionControllerPackageName());</span><br><span class="line">    <span class="keyword">return</span> intent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里创建了一个 intent，action 为 android.content.pm.action.REQUEST_PERMISSIONS，同时用 intent 封装了权限信息！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SystemApi</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String ACTION_REQUEST_PERMISSIONS =</span><br><span class="line">        <span class="string">"android.content.pm.action.REQUEST_PERMISSIONS"</span>; <span class="comment">// hide</span></span><br><span class="line"><span class="meta">@SystemApi</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String EXTRA_REQUEST_PERMISSIONS_NAMES =</span><br><span class="line">        <span class="string">"android.content.pm.extra.REQUEST_PERMISSIONS_NAMES"</span>;</span><br></pre></td></tr></table></figure></p>
<p>接下来，我们要问，谁会接受这个 intent 呢？</p>
<p>下面还调用了 getPermissionControllerPackageName 方法，设置了 intent 的接收者<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getPermissionControllerPackageName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="keyword">return</span> mRequiredInstallerPackage; <span class="comment">// 就是 PackageInstaller！</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>就是 PackageInstaller，我们需要进入 PackageInstaller，分析接下来的逻辑！</p>
<h1 id="2-PackageInstaller-GrantPermissionsActivity"><a href="#2-PackageInstaller-GrantPermissionsActivity" class="headerlink" title="2 PackageInstaller.GrantPermissionsActivity"></a>2 PackageInstaller.GrantPermissionsActivity</h1><p>通过分析 PackageInstaller 的代码，我们知道了 GrantPermissionsActivity 会接受该 intent！</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">".permission.ui.GrantPermissionsActivity"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:configChanges</span>=<span class="string">"orientation|keyboardHidden|screenSize"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:excludeFromRecents</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:theme</span>=<span class="string">"@style/GrantPermissions"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">"android.content.pm.action.REQUEST_PERMISSIONS"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">"android.intent.category.DEFAULT"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>GrantPermissionsActivity 虽然是一个 Activity，但实际的现实效果是一个 Dialog，下面我们会一个一个分析！</p>
<h2 id="2-1-GrantPermissionsActivity-onCreate"><a href="#2-1-GrantPermissionsActivity-onCreate" class="headerlink" title="2.1 GrantPermissionsActivity.onCreate"></a>2.1 GrantPermissionsActivity.onCreate</h2><p>我们去 onCreate 方法中去看看：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GrantPermissionsActivity</span> <span class="keyword">extends</span> <span class="title">OverlayTouchActivity</span></span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">GrantPermissionsViewHandler</span>.<span class="title">ResultListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle icicle)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(icicle);</span><br><span class="line">        setFinishOnTouchOutside(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">        setTitle(R.string.permission_request_title);</span><br><span class="line">        <span class="comment">// 根据不同的设备类型进行不同的操作！</span></span><br><span class="line">        <span class="keyword">if</span> (DeviceUtils.isTelevision(<span class="keyword">this</span>)) &#123;</span><br><span class="line">            mViewHandler = <span class="keyword">new</span> com.android.packageinstaller.permission.ui.television</span><br><span class="line">                    .GrantPermissionsViewHandlerImpl(<span class="keyword">this</span>).setResultListener(<span class="keyword">this</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (DeviceUtils.isWear(<span class="keyword">this</span>)) &#123;</span><br><span class="line">            mViewHandler = <span class="keyword">new</span> GrantPermissionsWatchViewHandler(<span class="keyword">this</span>).setResultListener(<span class="keyword">this</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//【2.1.1】对于 Android 来说，进入这里，创建了一个 GrantPermissionsViewHandlerImpl，用于显示权限弹窗</span></span><br><span class="line">            <span class="comment">// 以及和处理和弹窗相关的逻辑！</span></span><br><span class="line">            mViewHandler = <span class="keyword">new</span> com.android.packageinstaller.permission.ui.handheld</span><br><span class="line">                    .GrantPermissionsViewHandlerImpl(<span class="keyword">this</span>).setResultListener(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【1】获得应用本次要请求的运行时权限！</span></span><br><span class="line">        mRequestedPermissions = getIntent().getStringArrayExtra(</span><br><span class="line">                PackageManager.EXTRA_REQUEST_PERMISSIONS_NAMES);</span><br><span class="line">        <span class="keyword">if</span> (mRequestedPermissions == <span class="keyword">null</span>) &#123;</span><br><span class="line">            mRequestedPermissions = <span class="keyword">new</span> String[<span class="number">0</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【2】创建每个权限对应的授结果况数组，默认值为！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> requestedPermCount = mRequestedPermissions.length;</span><br><span class="line">        mGrantResults = <span class="keyword">new</span> <span class="keyword">int</span>[requestedPermCount];</span><br><span class="line">        Arrays.fill(mGrantResults, PackageManager.PERMISSION_DENIED);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (requestedPermCount == <span class="number">0</span>) &#123; <span class="comment">// 如果请求权限的数量为 0 ，无法申请！</span></span><br><span class="line">            <span class="comment">//【2.1.2】调用 setResultAndFinish 结束申请！</span></span><br><span class="line">            setResultAndFinish();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【2.1.3】获得请求的应用程序信息</span></span><br><span class="line">        PackageInfo callingPackageInfo = getCallingPackageInfo();</span><br><span class="line">        <span class="comment">// 如果应用程序不存在，或者应用程序没有申请权限，无法申请！</span></span><br><span class="line">        <span class="keyword">if</span> (callingPackageInfo == <span class="keyword">null</span> || callingPackageInfo.requestedPermissions == <span class="keyword">null</span></span><br><span class="line">                || callingPackageInfo.requestedPermissions.length &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            setResultAndFinish();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果应用程序的 targetSdkVersion 低于 Android M，不能申请运行时权限，直接取消！</span></span><br><span class="line">        <span class="keyword">if</span> (callingPackageInfo.applicationInfo.targetSdkVersion &lt; Build.VERSION_CODES.M) &#123;</span><br><span class="line">            mRequestedPermissions = <span class="keyword">new</span> String[<span class="number">0</span>];</span><br><span class="line">            mGrantResults = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">0</span>];</span><br><span class="line">            setResultAndFinish();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2.1.4】通过 DevicePolicyManager 获得设备对于权限的配置，然后根据配置信息，更新运行时权限的默认状态！</span></span><br><span class="line">        DevicePolicyManager devicePolicyManager = getSystemService(DevicePolicyManager.class);</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> permissionPolicy = devicePolicyManager.getPermissionPolicy(<span class="keyword">null</span>);</span><br><span class="line">        updateDefaultResults(callingPackageInfo, permissionPolicy);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2.1.5】创建了一个 AppPermissions 对象！</span></span><br><span class="line">        mAppPermissions = <span class="keyword">new</span> AppPermissions(<span class="keyword">this</span>, callingPackageInfo, <span class="keyword">null</span>, <span class="keyword">false</span>,</span><br><span class="line">                <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        setResultAndFinish();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【3】接着遍历本次请求的所有运行时权限！</span></span><br><span class="line">        <span class="keyword">for</span> (String requestedPermission : mRequestedPermissions) &#123;</span><br><span class="line">            AppPermissionGroup group = <span class="keyword">null</span>;</span><br><span class="line">            <span class="comment">//【3.1】找到该运行时权限所在的 group，我们会授予该组内的所有运行时权限！</span></span><br><span class="line">            <span class="keyword">for</span> (AppPermissionGroup nextGroup : mAppPermissions.getPermissionGroups()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (nextGroup.hasPermission(requestedPermission)) &#123;</span><br><span class="line">                    group = nextGroup;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (group == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【2.1.6】处理那些没有被 fix 的需要提醒的权限！</span></span><br><span class="line">            <span class="keyword">if</span> (!group.isUserFixed() &amp;&amp; !group.isPolicyFixed()) &#123;</span><br><span class="line">                <span class="comment">// 根据设备配置，对权限做不同的处理！</span></span><br><span class="line">                <span class="keyword">switch</span> (permissionPolicy) &#123;</span><br><span class="line">                    <span class="keyword">case</span> DevicePolicyManager.PERMISSION_POLICY_AUTO_GRANT: &#123;</span><br><span class="line">                        <span class="comment">// 如果设备策略管理设定的是自动授予，</span></span><br><span class="line">                        <span class="comment">// 如果该 group 中有权限未授予，那就授予他们！</span></span><br><span class="line">                        <span class="keyword">if</span> (!group.areRuntimePermissionsGranted()) &#123;</span><br><span class="line">                            group.grantRuntimePermissions(<span class="keyword">false</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        group.setPolicyFixed(); <span class="comment">// 设置 policy fix 标志，不再提醒！</span></span><br><span class="line">                    &#125; <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">case</span> DevicePolicyManager.PERMISSION_POLICY_AUTO_DENY: &#123;</span><br><span class="line">                        <span class="comment">// 如果设备策略管理设定的是自动拒绝，</span></span><br><span class="line">                        <span class="comment">// 如果该 group 中有权限已授予，那就拒绝他们！</span></span><br><span class="line">                        <span class="keyword">if</span> (group.areRuntimePermissionsGranted()) &#123;</span><br><span class="line">                            group.revokeRuntimePermissions(<span class="keyword">false</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        group.setPolicyFixed();</span><br><span class="line">                    &#125; <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">default</span>: &#123;</span><br><span class="line">                        <span class="comment">// 如果设备策略管理设定的是其他策略（也是正常情况），</span></span><br><span class="line">                        <span class="comment">// 如果 group 中有权限未授予，那就将其添加到 mRequestGrantPermissionGroups，接下来要申请！</span></span><br><span class="line">                        <span class="comment">// 如果 group 中有权限已授予，那就授予所有的权限，并更新授予结果；</span></span><br><span class="line">                        <span class="keyword">if</span> (!group.areRuntimePermissionsGranted()) &#123;</span><br><span class="line">                            mRequestGrantPermissionGroups.put(group.getName(),</span><br><span class="line">                                    <span class="keyword">new</span> GroupState(group));</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            group.grantRuntimePermissions(<span class="keyword">false</span>);</span><br><span class="line">                            updateGrantResults(group); <span class="comment">// 更新申请结果</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 如果权限已经被 fix，不用再提醒，那就直接更新权限的申请结果！</span></span><br><span class="line">                updateGrantResults(group);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2.1.7】显示权限申请弹窗界面！</span></span><br><span class="line">        setContentView(mViewHandler.createView());</span><br><span class="line"></span><br><span class="line">        Window window = getWindow();</span><br><span class="line">        WindowManager.LayoutParams layoutParams = window.getAttributes();</span><br><span class="line">        mViewHandler.updateWindowAttributes(layoutParams);</span><br><span class="line">        window.setAttributes(layoutParams);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2.1.8】显示权限请求 ui，处理权限的授予和拒绝！</span></span><br><span class="line">        <span class="keyword">if</span> (!showNextPermissionGroupGrantRequest()) &#123;</span><br><span class="line">            <span class="comment">//【2.1.9】返回处理结果！</span></span><br><span class="line">            setResultAndFinish();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-1-1-new-GrantPermissionsViewHandlerImpl-this"><a href="#2-1-1-new-GrantPermissionsViewHandlerImpl-this" class="headerlink" title="2.1.1 new GrantPermissionsViewHandlerImpl(this)"></a>2.1.1 new GrantPermissionsViewHandlerImpl(this)</h3><p>有一个成员变量 private GrantPermissionsViewHandler mViewHandler，用于处理权限弹窗的显示和相关逻辑显示，在 onCreate 方法中，首先会创建一个 GrantPermissionsViewHandlerImpl 对象！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">GrantPermissionsViewHandlerImpl</span></span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">GrantPermissionsViewHandler</span>, <span class="title">OnClickListener</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GrantPermissionsViewHandlerImpl</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        mContext = context;</span><br><span class="line">    &#125; </span><br><span class="line">        </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>同时，又调用了 setResultListener，设置监听器！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> GrantPermissionsViewHandlerImpl <span class="title">setResultListener</span><span class="params">(ResultListener listener)</span> </span>&#123;</span><br><span class="line">    mResultListener = listener;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的 ResultListener 就是 GrantPermissionsActivity，因为其实现了 ResultListener 接口！</p>
<h3 id="2-1-2-GrantPermissionsActivity-setResultAndFinish"><a href="#2-1-2-GrantPermissionsActivity-setResultAndFinish" class="headerlink" title="2.1.2 GrantPermissionsActivity.setResultAndFinish"></a>2.1.2 GrantPermissionsActivity.setResultAndFinish</h3><p>当遇到一些特殊情况，不能继续申请权限的时候，我们会调用 setResultAndFinish 结束申请！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setResultAndFinish</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    setResultIfNeeded(RESULT_OK);</span><br><span class="line">    finish();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>继续调用了 setResultIfNeeded 方法！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setResultIfNeeded</span><span class="params">(<span class="keyword">int</span> resultCode)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!mResultSet) &#123;</span><br><span class="line">        mResultSet = <span class="keyword">true</span>;</span><br><span class="line">        logRequestedPermissionGroups();</span><br><span class="line">        Intent result = <span class="keyword">new</span> Intent(PackageManager.ACTION_REQUEST_PERMISSIONS);</span><br><span class="line">        result.putExtra(PackageManager.EXTRA_REQUEST_PERMISSIONS_NAMES, mRequestedPermissions);</span><br><span class="line">        result.putExtra(PackageManager.EXTRA_REQUEST_PERMISSIONS_RESULTS, mGrantResults);</span><br><span class="line">        <span class="comment">// 调用 Activity.setResult 方法！</span></span><br><span class="line">        setResult(resultCode, result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="2-1-3-GrantPermissionsActivity-getCallingPackageInfo"><a href="#2-1-3-GrantPermissionsActivity-getCallingPackageInfo" class="headerlink" title="2.1.3 GrantPermissionsActivity.getCallingPackageInfo"></a>2.1.3 GrantPermissionsActivity.getCallingPackageInfo</h3><p>该方法用于获得申请运行时权限的应用的 PackageInfo 对象！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> PackageInfo <span class="title">getCallingPackageInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【2.1.3.1】最终调用 PMS 的 getPackageInfo 方法！</span></span><br><span class="line">        <span class="keyword">return</span> getPackageManager().getPackageInfo(getCallingPackage(),</span><br><span class="line">                PackageManager.GET_PERMISSIONS);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NameNotFoundException e) &#123;</span><br><span class="line">        Log.i(LOG_TAG, <span class="string">"No package: "</span> + getCallingPackage(), e);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>PackageManager.GET_PERMISSIONS 标志是为了限制查询到的数据的量！</p>
<h4 id="2-1-3-1-PackageManagerS-getPackageInfo"><a href="#2-1-3-1-PackageManagerS-getPackageInfo" class="headerlink" title="2.1.3.1 PackageManagerS.getPackageInfo"></a>2.1.3.1 PackageManagerS.getPackageInfo</h4><p>flags 传入 PackageManager.GET_PERMISSIONS！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> PackageInfo <span class="title">getPackageInfo</span><span class="params">(String packageName, <span class="keyword">int</span> flags, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!sUserManager.exists(userId)) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    flags = updateFlagsForPackage(flags, userId, packageName);</span><br><span class="line">    enforceCrossUserPermission(Binder.getCallingUid(), userId,</span><br><span class="line">            <span class="keyword">false</span> <span class="comment">/* requireFullPermission */</span>, <span class="keyword">false</span> <span class="comment">/* checkShell */</span>, <span class="string">"get package info"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="comment">// 如果 package 重命名过，返回旧名字！</span></span><br><span class="line">        packageName = normalizePackageNameLPr(packageName);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> matchFactoryOnly = (flags &amp; MATCH_FACTORY_ONLY) != <span class="number">0</span>;</span><br><span class="line">        PackageParser.Package p = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (matchFactoryOnly) &#123;</span><br><span class="line">            <span class="keyword">final</span> PackageSetting ps = mSettings.getDisabledSystemPkgLPr(packageName);</span><br><span class="line">            <span class="keyword">if</span> (ps != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> generatePackageInfo(ps, flags, userId);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 从 PMS.mPackages 中获取扫描解析后的 PackageParser.Package 对象！</span></span><br><span class="line">        <span class="keyword">if</span> (p == <span class="keyword">null</span>) &#123;</span><br><span class="line">            p = mPackages.get(packageName);</span><br><span class="line">            <span class="keyword">if</span> (matchFactoryOnly &amp;&amp; p != <span class="keyword">null</span> &amp;&amp; !isSystemApp(p)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_PACKAGE_INFO)</span><br><span class="line">            Log.v(TAG, <span class="string">"getPackageInfo "</span> + packageName + <span class="string">": "</span> + p);</span><br><span class="line">        <span class="keyword">if</span> (p != <span class="keyword">null</span>) &#123; </span><br><span class="line">            <span class="comment">//【2.1.3.2】如果有扫描结果，那就调用 generatePackageInfo 返回包信息！</span></span><br><span class="line">            <span class="keyword">return</span> generatePackageInfo((PackageSetting)p.mExtras, flags, userId);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果没有扫描结果，那么我们从上一次的安装信息中获取包信息！</span></span><br><span class="line">        <span class="keyword">if</span> (!matchFactoryOnly &amp;&amp; (flags &amp; MATCH_UNINSTALLED_PACKAGES) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> PackageSetting ps = mSettings.mPackages.get(packageName);</span><br><span class="line">            <span class="keyword">return</span> generatePackageInfo(ps, flags, userId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>流程很简单，不多说了！</p>
<h4 id="2-1-3-2-PackageManagerS-generatePackageInfo"><a href="#2-1-3-2-PackageManagerS-generatePackageInfo" class="headerlink" title="2.1.3.2 PackageManagerS.generatePackageInfo"></a>2.1.3.2 PackageManagerS.generatePackageInfo</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> PackageInfo <span class="title">generatePackageInfo</span><span class="params">(PackageSetting ps, <span class="keyword">int</span> flags, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!sUserManager.exists(userId)) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (ps == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获得扫描信息！</span></span><br><span class="line">    <span class="keyword">final</span> PackageParser.Package p = ps.pkg;</span><br><span class="line">    <span class="keyword">if</span> (p == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获得该 package 的权限状态信息！</span></span><br><span class="line">    <span class="keyword">final</span> PermissionsState permissionsState = ps.getPermissionsState();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果 flags 设置了 GET_GIDS，说明我们要获得 gids 信息，那就计算 gid！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span>[] gids = (flags &amp; PackageManager.GET_GIDS) == <span class="number">0</span></span><br><span class="line">            ? EMPTY_INT_ARRAY : permissionsState.computeGids(userId);</span><br><span class="line">    <span class="comment">// 获取应用已经被授予的所有权限！</span></span><br><span class="line">    <span class="keyword">final</span> Set&lt;String&gt; permissions = ArrayUtils.isEmpty(p.requestedPermissions)</span><br><span class="line">            ? Collections.&lt;String&gt;emptySet() : permissionsState.getPermissions(userId);</span><br><span class="line">    <span class="comment">// 获取应用在当前 userId 下的状态信息！</span></span><br><span class="line">    <span class="keyword">final</span> PackageUserState state = ps.readUserState(userId);</span><br><span class="line">    <span class="comment">//【2.1.3.3】继续调用 generatePackageInfo！</span></span><br><span class="line">    <span class="keyword">return</span> PackageParser.generatePackageInfo(p, gids, flags,</span><br><span class="line">            ps.firstInstallTime, ps.lastUpdateTime, permissions, state, userId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>继续看：</p>
<h4 id="2-1-3-3-PackageManagerS-generatePackageInfo"><a href="#2-1-3-3-PackageManagerS-generatePackageInfo" class="headerlink" title="2.1.3.3 PackageManagerS.generatePackageInfo"></a>2.1.3.3 PackageManagerS.generatePackageInfo</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> PackageInfo <span class="title">generatePackageInfo</span><span class="params">(PackageParser.Package p,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> gids[], <span class="keyword">int</span> flags, <span class="keyword">long</span> firstInstallTime, <span class="keyword">long</span> lastUpdateTime,</span></span></span><br><span class="line"><span class="function"><span class="params">        Set&lt;String&gt; grantedPermissions, PackageUserState state, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!checkUseInstalledOrHidden(flags, state) || !p.isMatch(flags)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【1】创建了一个 PackageInfo 对象，保存应用的包信息的拷贝！</span></span><br><span class="line">    PackageInfo pi = <span class="keyword">new</span> PackageInfo();</span><br><span class="line">    pi.packageName = p.packageName;</span><br><span class="line">    pi.splitNames = p.splitNames;</span><br><span class="line">    pi.versionCode = p.mVersionCode;</span><br><span class="line">    pi.baseRevisionCode = p.baseRevisionCode;</span><br><span class="line">    pi.splitRevisionCodes = p.splitRevisionCodes;</span><br><span class="line">    pi.versionName = p.mVersionName;</span><br><span class="line">    pi.sharedUserId = p.mSharedUserId;</span><br><span class="line">    pi.sharedUserLabel = p.mSharedUserLabel;</span><br><span class="line">    pi.applicationInfo = generateApplicationInfo(p, flags, state, userId);</span><br><span class="line">    pi.installLocation = p.installLocation;</span><br><span class="line">    pi.coreApp = p.coreApp;</span><br><span class="line">    <span class="keyword">if</span> ((pi.applicationInfo.flags&amp;ApplicationInfo.FLAG_SYSTEM) != <span class="number">0</span></span><br><span class="line">            || (pi.applicationInfo.flags&amp;ApplicationInfo.FLAG_UPDATED_SYSTEM_APP) != <span class="number">0</span>) &#123;</span><br><span class="line">        pi.requiredForAllUsers = p.mRequiredForAllUsers;</span><br><span class="line">    &#125;</span><br><span class="line">    pi.restrictedAccountType = p.mRestrictedAccountType;</span><br><span class="line">    pi.requiredAccountType = p.mRequiredAccountType;</span><br><span class="line">    pi.overlayTarget = p.mOverlayTarget;</span><br><span class="line">    pi.firstInstallTime = firstInstallTime;</span><br><span class="line">    pi.lastUpdateTime = lastUpdateTime;</span><br><span class="line">    <span class="comment">//【2】根据 flags 设置的标志位，获取标志为对应的信息！</span></span><br><span class="line">    <span class="keyword">if</span> ((flags&amp;PackageManager.GET_GIDS) != <span class="number">0</span>) &#123;</span><br><span class="line">        pi.gids = gids;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((flags&amp;PackageManager.GET_CONFIGURATIONS) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> N = p.configPreferences != <span class="keyword">null</span> ? p.configPreferences.size() : <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (N &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            pi.configPreferences = <span class="keyword">new</span> ConfigurationInfo[N];</span><br><span class="line">            p.configPreferences.toArray(pi.configPreferences);</span><br><span class="line">        &#125;</span><br><span class="line">        N = p.reqFeatures != <span class="keyword">null</span> ? p.reqFeatures.size() : <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (N &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            pi.reqFeatures = <span class="keyword">new</span> FeatureInfo[N];</span><br><span class="line">            p.reqFeatures.toArray(pi.reqFeatures);</span><br><span class="line">        &#125;</span><br><span class="line">        N = p.featureGroups != <span class="keyword">null</span> ? p.featureGroups.size() : <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (N &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            pi.featureGroups = <span class="keyword">new</span> FeatureGroupInfo[N];</span><br><span class="line">            p.featureGroups.toArray(pi.featureGroups);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((flags &amp; PackageManager.GET_ACTIVITIES) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> N = p.activities.size();</span><br><span class="line">        <span class="keyword">if</span> (N &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> num = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">final</span> ActivityInfo[] res = <span class="keyword">new</span> ActivityInfo[N];</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">                <span class="keyword">final</span> Activity a = p.activities.get(i);</span><br><span class="line">                <span class="keyword">if</span> (state.isMatch(a.info, flags)) &#123;</span><br><span class="line">                    res[num++] = generateActivityInfo(a, flags, state, userId);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            pi.activities = ArrayUtils.trimToSize(res, num);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((flags &amp; PackageManager.GET_RECEIVERS) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> N = p.receivers.size();</span><br><span class="line">        <span class="keyword">if</span> (N &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> num = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">final</span> ActivityInfo[] res = <span class="keyword">new</span> ActivityInfo[N];</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">                <span class="keyword">final</span> Activity a = p.receivers.get(i);</span><br><span class="line">                <span class="keyword">if</span> (state.isMatch(a.info, flags)) &#123;</span><br><span class="line">                    res[num++] = generateActivityInfo(a, flags, state, userId);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            pi.receivers = ArrayUtils.trimToSize(res, num);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((flags &amp; PackageManager.GET_SERVICES) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> N = p.services.size();</span><br><span class="line">        <span class="keyword">if</span> (N &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> num = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">final</span> ServiceInfo[] res = <span class="keyword">new</span> ServiceInfo[N];</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">                <span class="keyword">final</span> Service s = p.services.get(i);</span><br><span class="line">                <span class="keyword">if</span> (state.isMatch(s.info, flags)) &#123;</span><br><span class="line">                    res[num++] = generateServiceInfo(s, flags, state, userId);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            pi.services = ArrayUtils.trimToSize(res, num);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((flags &amp; PackageManager.GET_PROVIDERS) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> N = p.providers.size();</span><br><span class="line">        <span class="keyword">if</span> (N &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> num = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">final</span> ProviderInfo[] res = <span class="keyword">new</span> ProviderInfo[N];</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">                <span class="keyword">final</span> Provider pr = p.providers.get(i);</span><br><span class="line">                <span class="keyword">if</span> (state.isMatch(pr.info, flags)) &#123;</span><br><span class="line">                    res[num++] = generateProviderInfo(pr, flags, state, userId);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            pi.providers = ArrayUtils.trimToSize(res, num);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((flags&amp;PackageManager.GET_INSTRUMENTATION) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> N = p.instrumentation.size();</span><br><span class="line">        <span class="keyword">if</span> (N &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            pi.instrumentation = <span class="keyword">new</span> InstrumentationInfo[N];</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">                pi.instrumentation[i] = generateInstrumentationInfo(</span><br><span class="line">                        p.instrumentation.get(i), flags);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 因为我们只设置了 GET_PERMISSIONS，所以只会手机和权限相关的信息！</span></span><br><span class="line">    <span class="keyword">if</span> ((flags&amp;PackageManager.GET_PERMISSIONS) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 处理该应用定义的所有权限！</span></span><br><span class="line">        <span class="keyword">int</span> N = p.permissions.size();</span><br><span class="line">        <span class="keyword">if</span> (N &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            pi.permissions = <span class="keyword">new</span> PermissionInfo[N];</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">                pi.permissions[i] = generatePermissionInfo(p.permissions.get(i), flags);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 处理该应用请求的所有权限！</span></span><br><span class="line">        N = p.requestedPermissions.size();</span><br><span class="line">        <span class="keyword">if</span> (N &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            pi.requestedPermissions = <span class="keyword">new</span> String[N];</span><br><span class="line">            pi.requestedPermissionsFlags = <span class="keyword">new</span> <span class="keyword">int</span>[N];</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">                <span class="keyword">final</span> String perm = p.requestedPermissions.get(i);</span><br><span class="line">                <span class="comment">// requestedPermissions[i] 表示应用申请的权限名；</span></span><br><span class="line">                pi.requestedPermissions[i] = perm;</span><br><span class="line">                <span class="comment">// requestedPermissionsFlags[i] 表示应用申请的权限的授予情况；</span></span><br><span class="line">                <span class="comment">// 开始默认初始化为需要再次请求，然后比较该权限是否已经被授予，如果授予，改为授予状态！</span></span><br><span class="line">                pi.requestedPermissionsFlags[i] |= PackageInfo.REQUESTED_PERMISSION_REQUIRED;</span><br><span class="line">                <span class="keyword">if</span> (grantedPermissions != <span class="keyword">null</span> &amp;&amp; grantedPermissions.contains(perm)) &#123;</span><br><span class="line">                    pi.requestedPermissionsFlags[i] |= PackageInfo.REQUESTED_PERMISSION_GRANTED;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((flags&amp;PackageManager.GET_SIGNATURES) != <span class="number">0</span>) &#123;</span><br><span class="line">       <span class="keyword">int</span> N = (p.mSignatures != <span class="keyword">null</span>) ? p.mSignatures.length : <span class="number">0</span>;</span><br><span class="line">       <span class="keyword">if</span> (N &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            pi.signatures = <span class="keyword">new</span> Signature[N];</span><br><span class="line">            System.arraycopy(p.mSignatures, <span class="number">0</span>, pi.signatures, <span class="number">0</span>, N);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> pi;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后，返回的是一个 PackageInfo 对象！</p>
<h3 id="2-1-4-GrantPermissionsActivity-updateDefaultResults"><a href="#2-1-4-GrantPermissionsActivity-updateDefaultResults" class="headerlink" title="2.1.4 GrantPermissionsActivity.updateDefaultResults"></a>2.1.4 GrantPermissionsActivity.updateDefaultResults</h3><p>更新下权限的默认授予情况！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateDefaultResults</span><span class="params">(PackageInfo callingPackageInfo, <span class="keyword">int</span> permissionPolicy)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> requestedPermCount = mRequestedPermissions.length;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; requestedPermCount; i++) &#123;</span><br><span class="line">        String permission = mRequestedPermissions[i];</span><br><span class="line">        <span class="comment">//【2.1.3.1 】如果申请应用的信息存在，那么会调用 computePermissionGrantState 方法，获得权限的默认授予状态！</span></span><br><span class="line">        <span class="comment">// 否则，所有运行时权限默认为 deny！</span></span><br><span class="line">        mGrantResults[i] = callingPackageInfo != <span class="keyword">null</span></span><br><span class="line">                ? computePermissionGrantState(callingPackageInfo, permission, permissionPolicy)</span><br><span class="line">                : PERMISSION_DENIED;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>关键的实现是在 computePermissionGrantState 中！</p>
<h4 id="2-1-4-1-GrantPermissionsActivity-computePermissionGrantState"><a href="#2-1-4-1-GrantPermissionsActivity-computePermissionGrantState" class="headerlink" title="2.1.4.1 GrantPermissionsActivity.computePermissionGrantState"></a>2.1.4.1 GrantPermissionsActivity.computePermissionGrantState</h4><p>该方法用于根据参数，计算该运行时权限的授予情况，这里的 permission 是应用本次申请的运行时权限！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">computePermissionGrantState</span><span class="params">(PackageInfo callingPackageInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">        String permission, <span class="keyword">int</span> permissionPolicy)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> permissionRequested = <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">//【1】如果运行时权限 permission 在 package 请求权限列表中</span></span><br><span class="line">    <span class="comment">// 并且已经授予，那么就返回 PERMISSION_GRANTED！</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; callingPackageInfo.requestedPermissions.length; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (permission.equals(callingPackageInfo.requestedPermissions[i])) &#123;</span><br><span class="line">            permissionRequested = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">if</span> ((callingPackageInfo.requestedPermissionsFlags[i]</span><br><span class="line">                    &amp; PackageInfo.REQUESTED_PERMISSION_GRANTED) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> PERMISSION_GRANTED;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】申请的运行时权限，应用没有申明，返回 PERMISSION_DENIED！</span></span><br><span class="line">    <span class="keyword">if</span> (!permissionRequested) &#123;</span><br><span class="line">        <span class="keyword">return</span> PERMISSION_DENIED;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【3】只有基本权限类型为 dangerous 的权限才需要动态申请，其他类型的权限，默认返回 PERMISSION_DENIED！</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        PermissionInfo pInfo = getPackageManager().getPermissionInfo(permission, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> ((pInfo.protectionLevel &amp; PermissionInfo.PROTECTION_MASK_BASE)</span><br><span class="line">                != PermissionInfo.PROTECTION_DANGEROUS) &#123;</span><br><span class="line">            <span class="keyword">return</span> PERMISSION_DENIED;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NameNotFoundException e) &#123;</span><br><span class="line">        <span class="keyword">return</span> PERMISSION_DENIED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【4】根据 permissionPolicy 的值来处理权限的授予情况，如果是 PERMISSION_POLICY_AUTO_GRANT，表示自动授予；</span></span><br><span class="line">    <span class="comment">// 那么返回 PERMISSION_GRANTED，否则返回 PERMISSION_DENIED！</span></span><br><span class="line">    <span class="keyword">switch</span> (permissionPolicy) &#123;</span><br><span class="line">        <span class="keyword">case</span> DevicePolicyManager.PERMISSION_POLICY_AUTO_GRANT: &#123;</span><br><span class="line">            <span class="keyword">return</span> PERMISSION_GRANTED;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">default</span>: &#123;</span><br><span class="line">            <span class="keyword">return</span> PERMISSION_DENIED;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>最后 computePermissionGrantState 的结果会保存 mGrantResults 数组中！</p>
<p>不多说了！</p>
<h3 id="2-1-5-new-AppPermissions-封装-App-的权限请求信息"><a href="#2-1-5-new-AppPermissions-封装-App-的权限请求信息" class="headerlink" title="2.1.5 new AppPermissions - 封装 App 的权限请求信息"></a>2.1.5 new AppPermissions - 封装 App 的权限请求信息</h3><p>这里的 onErrorCallback 是一个 Runnable，执行后会触发 setResultAndFinish 方法！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">AppPermissions</span><span class="params">(Context context, PackageInfo packageInfo, String[] permissions,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> sortGroups, Runnable onErrorCallback)</span> </span>&#123;</span><br><span class="line">    mContext = context;</span><br><span class="line">    mPackageInfo = packageInfo; <span class="comment">// 请求权限的应用的 PackageInfo 实例！</span></span><br><span class="line">    mFilterPermissions = permissions; <span class="comment">// 传入 null；</span></span><br><span class="line">    mAppLabel = BidiFormatter.getInstance().unicodeWrap(</span><br><span class="line">            packageInfo.applicationInfo.loadSafeLabel(</span><br><span class="line">            context.getPackageManager()).toString());</span><br><span class="line">    mSortGroups = sortGroups; <span class="comment">// 传入 false；</span></span><br><span class="line">    mOnErrorCallback = onErrorCallback;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2.1.4.1】加载权限组信息！</span></span><br><span class="line">    loadPermissionGroups();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>mFilterPermissions 属性表示要过滤的权限，这里我们传入的是 null；</p>
<p>同时，AppPermissions 还有如下的属性：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 保存所有运行时权限所属的组信息 AppPermissionGroup</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ArrayList&lt;AppPermissionGroup&gt; mGroups = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"><span class="comment">// 保存组名和 AppPermissionGroup 的映射关系</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> LinkedHashMap&lt;String, AppPermissionGroup&gt; mNameToGroupMap = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br></pre></td></tr></table></figure>
<h4 id="2-1-5-1-AppPermissions-loadPermissionGroups"><a href="#2-1-5-1-AppPermissions-loadPermissionGroups" class="headerlink" title="2.1.5.1 AppPermissions.loadPermissionGroups"></a>2.1.5.1 AppPermissions.loadPermissionGroups</h4><p>加载权限组信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadPermissionGroups</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mGroups.clear();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mPackageInfo.requestedPermissions == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mFilterPermissions != <span class="keyword">null</span>) &#123; <span class="comment">//【1】mFilterPermissions 为 null，不进入！</span></span><br><span class="line">        <span class="keyword">for</span> (String filterPermission : mFilterPermissions) &#123;</span><br><span class="line">            <span class="keyword">for</span> (String requestedPerm : mPackageInfo.requestedPermissions) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!filterPermission.equals(requestedPerm)) &#123; <span class="comment">// 过滤掉那些不是 filterPermission 的权限！</span></span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (hasGroupForPermission(requestedPerm)) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                AppPermissionGroup group = AppPermissionGroup.create(mContext,</span><br><span class="line">                        mPackageInfo, requestedPerm);</span><br><span class="line">                <span class="keyword">if</span> (group == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                mGroups.add(group);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//【2】遍历该 package 请求的所有权限（安装/运行），</span></span><br><span class="line">        <span class="keyword">for</span> (String requestedPerm : mPackageInfo.requestedPermissions) &#123;</span><br><span class="line">            <span class="comment">//【2.1.4.1.1】判断是否已经有对应的 group 存在，存在的话，那就不处理！</span></span><br><span class="line">            <span class="keyword">if</span> (hasGroupForPermission(requestedPerm)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【2.1.4.1.2】如果不存在，那就创建一个 AppPermissionGroup 对象，封装运行时权限所属的组信息！</span></span><br><span class="line">            AppPermissionGroup group = AppPermissionGroup.create(mContext,</span><br><span class="line">                    mPackageInfo, requestedPerm);</span><br><span class="line">            <span class="keyword">if</span> (group == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            mGroups.add(group); <span class="comment">//【2.1】添加到 mGroups 中！</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mSortGroups) &#123; <span class="comment">//【3】如果 mSortGroups 为 true，表示对 group 进行排序！</span></span><br><span class="line">        Collections.sort(mGroups);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【4】mNameToGroupMap 用于保存组名和 AppPermissionGroup 的映射关系！</span></span><br><span class="line">    mNameToGroupMap.clear();</span><br><span class="line">    <span class="keyword">for</span> (AppPermissionGroup group : mGroups) &#123;</span><br><span class="line">        mNameToGroupMap.put(group.getName(), group);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于 mPackageInfo.requestedPermissions，不仅包含运行时权限，还包含安装时权限！</p>
<h5 id="2-1-5-1-1-AppPermissions-hasGroupForPermission"><a href="#2-1-5-1-1-AppPermissions-hasGroupForPermission" class="headerlink" title="2.1.5.1.1 AppPermissions.hasGroupForPermission"></a>2.1.5.1.1 AppPermissions.hasGroupForPermission</h5><p>加载权限组信息！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">hasGroupForPermission</span><span class="params">(String permission)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】遍历所有的 AppPermissionGroup，如果 permission 在 group 的权限集合中，返回 true！</span></span><br><span class="line">    <span class="keyword">for</span> (AppPermissionGroup group : mGroups) &#123;</span><br><span class="line">        <span class="keyword">if</span> (group.hasPermission(permission)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>AppPermissions 内部有一个 mGroups，保存所有的权限组信息 AppPermissionGroup 实例！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">AppPermissionGroup</span> <span class="keyword">implements</span> <span class="title">Comparable</span>&lt;<span class="title">AppPermissionGroup</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ArrayMap&lt;String, Permission&gt; mPermissions = <span class="keyword">new</span> ArrayMap&lt;&gt;();</span><br><span class="line">    <span class="comment">//【2】在该 group 中是否有该权限！</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasPermission</span><span class="params">(String permission)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mPermissions.get(permission) != <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>AppPermissionGroup 内部有一个 mPermissions 哈希表，用于保存该 group 中所有权限的权限名和其 Permission 的映射关系！</p>
<h5 id="2-1-5-1-2-AppPermissionGroup-create-3-创建运行时权限组信息"><a href="#2-1-5-1-2-AppPermissionGroup-create-3-创建运行时权限组信息" class="headerlink" title="2.1.5.1.2 AppPermissionGroup.create[3] - 创建运行时权限组信息"></a>2.1.5.1.2 AppPermissionGroup.create[3] - 创建运行时权限组信息</h5><p>接下来我们看下，AppPermissionGroup 的创建，String permissionName 表示的是该 package 的申请的权限：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> AppPermissionGroup <span class="title">create</span><span class="params">(Context context, PackageInfo packageInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">        String permissionName)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】获得运行时权限的信息，找不到，返回 null；</span></span><br><span class="line">    PermissionInfo permissionInfo;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        permissionInfo = context.getPackageManager().getPermissionInfo(permissionName, <span class="number">0</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (PackageManager.NameNotFoundException e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】校验权限的类型，如果该权限的基本类型不是 dangerous 或者说权限的 flags 没有设置 FLAG_INSTALLED 属性</span></span><br><span class="line">    <span class="comment">// 或者权限的 flags 设置了 FLAG_REMOVED 属性，那么，返回 null!</span></span><br><span class="line">    <span class="keyword">if</span> (permissionInfo.protectionLevel != PermissionInfo.PROTECTION_DANGEROUS</span><br><span class="line">            || (permissionInfo.flags &amp; PermissionInfo.FLAG_INSTALLED) == <span class="number">0</span></span><br><span class="line">            || (permissionInfo.flags &amp; PermissionInfo.FLAG_REMOVED) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【3】查询该权限所属 group 的信息，如果权限的 group 属性不为 null，说明其有所属组；</span></span><br><span class="line">    PackageItemInfo groupInfo = permissionInfo;</span><br><span class="line">    <span class="keyword">if</span> (permissionInfo.group != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            groupInfo = context.getPackageManager().getPermissionGroupInfo(</span><br><span class="line">                    permissionInfo.group, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (PackageManager.NameNotFoundException e) &#123;</span><br><span class="line">            <span class="comment">/* ignore */</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【4】查询所有属于该 group 的权限信息，保存到 permissionInfos 列表中！！</span></span><br><span class="line">    <span class="comment">// 注意这里的 permissionInfos 会包含应用没有申请的权限！</span></span><br><span class="line">    List&lt;PermissionInfo&gt; permissionInfos = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (groupInfo <span class="keyword">instanceof</span> PermissionGroupInfo) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            permissionInfos = context.getPackageManager().queryPermissionsByGroup(</span><br><span class="line">                    groupInfo.name, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (PackageManager.NameNotFoundException e) &#123;</span><br><span class="line">            <span class="comment">/* ignore */</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2.1.4.1.3】创建 AppPermissionGroup 对象！！</span></span><br><span class="line">    <span class="keyword">return</span> create(context, packageInfo, groupInfo, permissionInfos,</span><br><span class="line">            Process.myUserHandle());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里可以看到，流程【2】中，会排除掉所有的非 dangerous 类型的权限！</p>
<p>在创建一个 group 的时候，会将属于该 group 的所有权限都查出来！！</p>
<p>这里继续调用了五参数的 create 方法！</p>
<h5 id="2-1-5-1-3-AppPermissionGroup-create-5"><a href="#2-1-5-1-3-AppPermissionGroup-create-5" class="headerlink" title="2.1.5.1.3 AppPermissionGroup.create[5]"></a>2.1.5.1.3 AppPermissionGroup.create[5]</h5><p>继续调用 create 方法来创建 AppPermissionGroup 对象！</p>
<p>参数分析：</p>
<ul>
<li><strong>PackageInfo packageInfo</strong>：本次请求权限的 package 的 PackageInfo 对象；</li>
<li><strong>PackageItemInfo groupInfo</strong>：该 package 的请求的权限所属的组信息；</li>
<li><strong>List<permissioninfo> permissionInfos</permissioninfo></strong>：属于该组的所有权限信息；</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> AppPermissionGroup <span class="title">create</span><span class="params">(Context context, PackageInfo packageInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">        PackageItemInfo groupInfo, List&lt;PermissionInfo&gt; permissionInfos,</span></span></span><br><span class="line"><span class="function"><span class="params">        UserHandle userHandle)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【2.1.5.1.3.1】创建一个 AppPermissionGroup 对象，封装了 group name，label 相关信息！</span></span><br><span class="line">    AppPermissionGroup group = <span class="keyword">new</span> AppPermissionGroup(context, packageInfo, groupInfo.name,</span><br><span class="line">            groupInfo.packageName, groupInfo.loadLabel(context.getPackageManager()),</span><br><span class="line">            loadGroupDescription(context, groupInfo), groupInfo.packageName, groupInfo.icon,</span><br><span class="line">            userHandle);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果 groupInfo 不是权限组对象，而是一个运行时权限，那就添加到 permissionInfos 中！</span></span><br><span class="line">    <span class="keyword">if</span> (groupInfo <span class="keyword">instanceof</span> PermissionInfo) &#123;</span><br><span class="line">        permissionInfos = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        permissionInfos.add((PermissionInfo) groupInfo);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】如果权限组没有权限，返回 null，该 group 无效！</span></span><br><span class="line">    <span class="keyword">if</span> (permissionInfos == <span class="keyword">null</span> || permissionInfos.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】遍历该 package 请求的所有权限（安装/运行）！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> permissionCount = packageInfo.requestedPermissions.length;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; permissionCount; i++) &#123;</span><br><span class="line">        String requestedPermission = packageInfo.requestedPermissions[i];</span><br><span class="line"></span><br><span class="line">        PermissionInfo requestedPermissionInfo = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">//【2.1】如果应用请求的权限（安装/运行）中有权限属于该权限组，我们会处理该权限！</span></span><br><span class="line">        <span class="comment">// permissionInfos 是该权限组中的所有权限，这里我们要过滤掉非应用申请的权限！</span></span><br><span class="line">        <span class="keyword">for</span> (PermissionInfo permissionInfo : permissionInfos) &#123;</span><br><span class="line">            <span class="keyword">if</span> (requestedPermission.equals(permissionInfo.name)) &#123;</span><br><span class="line">                requestedPermissionInfo = permissionInfo;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (requestedPermissionInfo == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2.2】我们只处理运行时权限，对于非 dangerous 权限，直接跳过！！</span></span><br><span class="line">        <span class="keyword">if</span> (requestedPermissionInfo.protectionLevel != PermissionInfo.PROTECTION_DANGEROUS) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Don't allow toggling non-platform permission groups for legacy apps via app ops.</span></span><br><span class="line">        <span class="comment">// 如果应用程序的 targetSdkVersion 不高于 Android 5.1，并且定义权限组的 package 不是 android！</span></span><br><span class="line">        <span class="comment">// 不处理该运行时权限！</span></span><br><span class="line">        <span class="keyword">if</span> (packageInfo.applicationInfo.targetSdkVersion &lt;= Build.VERSION_CODES.LOLLIPOP_MR1</span><br><span class="line">                &amp;&amp; !PLATFORM_PACKAGE_NAME.equals(groupInfo.packageName)) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2.3】判断该运行时权限是否已经授予！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> granted = (packageInfo.requestedPermissionsFlags[i]</span><br><span class="line">                &amp; PackageInfo.REQUESTED_PERMISSION_GRANTED) != <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2.4】当该运行时权限的定义者不为系统时，appOp 为 null，如果为系统权限的话，匹配其对应的 AppOps，</span></span><br><span class="line">        <span class="comment">// 也有可能为 null！</span></span><br><span class="line">        <span class="keyword">final</span> String appOp = PLATFORM_PACKAGE_NAME.equals(requestedPermissionInfo.packageName)</span><br><span class="line">                ? AppOpsManager.permissionToOp(requestedPermissionInfo.name) : <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">//【2.5】如果该系统权限有对应的 AppOps，获得其模式的值是否为 ALLOWED!</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> appOpAllowed = appOp != <span class="keyword">null</span></span><br><span class="line">                &amp;&amp; context.getSystemService(AppOpsManager.class).checkOpNoThrow(appOp,</span><br><span class="line">                packageInfo.applicationInfo.uid, packageInfo.packageName)</span><br><span class="line">                == AppOpsManager.MODE_ALLOWED;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【2.6】获得权限的 flags，可以取值为 user set,user fixed 等等！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> flags = context.getPackageManager().getPermissionFlags(</span><br><span class="line">                requestedPermission, packageInfo.packageName, userHandle);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2.1.5.1.3.2】创建一个 Permission 对象，保存该运行时权限的信息！</span></span><br><span class="line">        Permission permission = <span class="keyword">new</span> Permission(requestedPermission, granted,</span><br><span class="line">                appOp, appOpAllowed, flags);</span><br><span class="line">        <span class="comment">//【2.1.5.1.3.3】添加到 AppPermissionGroup 中去！</span></span><br><span class="line">        group.addPermission(permission);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> group;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>到这里，AppPermissionGroup 就正式创建完了！</p>
<h6 id="2-1-5-1-3-1-new-AppPermissionGroup"><a href="#2-1-5-1-3-1-new-AppPermissionGroup" class="headerlink" title="2.1.5.1.3.1 new AppPermissionGroup"></a>2.1.5.1.3.1 new AppPermissionGroup</h6><p>创建了一个 AppPermissionGroup，封装运行时权限所在权限组信息！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">AppPermissionGroup</span> <span class="keyword">implements</span> <span class="title">Comparable</span>&lt;<span class="title">AppPermissionGroup</span>&gt; </span>&#123;</span><br><span class="line">    ... ... ...</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">AppPermissionGroup</span><span class="params">(Context context, PackageInfo packageInfo, String name,</span></span></span><br><span class="line"><span class="function"><span class="params">            String declaringPackage, CharSequence label, CharSequence description,</span></span></span><br><span class="line"><span class="function"><span class="params">            String iconPkg, <span class="keyword">int</span> iconResId, UserHandle userHandle)</span> </span>&#123;</span><br><span class="line">        mContext = context;</span><br><span class="line">        mUserHandle = userHandle;</span><br><span class="line">        mPackageManager = mContext.getPackageManager();</span><br><span class="line">        mPackageInfo = packageInfo;</span><br><span class="line">        mAppSupportsRuntimePermissions = packageInfo.applicationInfo</span><br><span class="line">                .targetSdkVersion &gt; Build.VERSION_CODES.LOLLIPOP_MR1; <span class="comment">// 该应用是否支持运行时权限！</span></span><br><span class="line">        mAppOps = context.getSystemService(AppOpsManager.class);</span><br><span class="line">        mActivityManager = context.getSystemService(ActivityManager.class);</span><br><span class="line">        mDeclaringPackage = declaringPackage;</span><br><span class="line">        mName = name;</span><br><span class="line">        mLabel = label;</span><br><span class="line">        mDescription = description;</span><br><span class="line">        <span class="keyword">if</span> (iconResId != <span class="number">0</span>) &#123;</span><br><span class="line">            mIconPkg = iconPkg;</span><br><span class="line">            mIconResId = iconResId;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mIconPkg = context.getPackageName();</span><br><span class="line">            mIconResId = R.drawable.ic_perm_device_info;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>AppPermissionGroup 内部有一个 mPermissions 集合，负责管理该 group 中该 package 申请的权限！</p>
<h6 id="2-1-5-1-3-2-new-Permission"><a href="#2-1-5-1-3-2-new-Permission" class="headerlink" title="2.1.5.1.3.2 new Permission"></a>2.1.5.1.3.2 new Permission</h6><p>该 Permission 是 PackageInstaller 定义的一个类，和系统中的不一样！</p>
<p>Permission 用来封装一个运行时权限信息！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Permission</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String mName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String mAppOp;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mGranted; <span class="comment">// 是否已经授予该权限！</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mAppOpAllowed;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mFlags;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Permission</span><span class="params">(String name, <span class="keyword">boolean</span> granted,</span></span></span><br><span class="line"><span class="function"><span class="params">            String appOp, <span class="keyword">boolean</span> appOpAllowed, <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">        mName = name; <span class="comment">//</span></span><br><span class="line">        mGranted = granted;</span><br><span class="line">        mAppOp = appOp;</span><br><span class="line">        mAppOpAllowed = appOpAllowed;</span><br><span class="line">        mFlags = flags;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<h6 id="2-1-5-1-3-3-AppPermissionGroup-addPermission"><a href="#2-1-5-1-3-3-AppPermissionGroup-addPermission" class="headerlink" title="2.1.5.1.3.3 AppPermissionGroup.addPermission"></a>2.1.5.1.3.3 AppPermissionGroup.addPermission</h6><p>将该运行时权限添加到 AppPermissionGroup.mPermissions 中去！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addPermission</span><span class="params">(Permission permission)</span> </span>&#123;</span><br><span class="line">    mPermissions.put(permission.getName(), permission);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="2-1-6-处理运行时权限组"><a href="#2-1-6-处理运行时权限组" class="headerlink" title="2.1.6 处理运行时权限组"></a>2.1.6 处理运行时权限组</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//【3】接着遍历本次请求的所有运行时权限！</span></span><br><span class="line"><span class="keyword">for</span> (String requestedPermission : mRequestedPermissions) &#123;</span><br><span class="line">    AppPermissionGroup group = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">//【3.1】找到该运行时权限所在的 group!！</span></span><br><span class="line">    <span class="keyword">for</span> (AppPermissionGroup nextGroup : mAppPermissions.getPermissionGroups()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (nextGroup.hasPermission(requestedPermission)) &#123;</span><br><span class="line">            group = nextGroup;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (group == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2.1.6.1】处理那些 no fix 的需要提醒的权限！</span></span><br><span class="line">    <span class="keyword">if</span> (!group.isUserFixed() &amp;&amp; !group.isPolicyFixed()) &#123;</span><br><span class="line">        <span class="comment">// 根据设备配置，对权限做不同的处理！</span></span><br><span class="line">        <span class="keyword">switch</span> (permissionPolicy) &#123;</span><br><span class="line">            <span class="keyword">case</span> DevicePolicyManager.PERMISSION_POLICY_AUTO_GRANT: &#123;</span><br><span class="line">                <span class="comment">// 如果设备策略管理设定的是自动授予，</span></span><br><span class="line">                <span class="comment">//【2.1.6.2】且该 group 中有权限未授予，那就授予他们！</span></span><br><span class="line">                <span class="keyword">if</span> (!group.areRuntimePermissionsGranted()) &#123;</span><br><span class="line">                    <span class="comment">//【3.1】授予权限</span></span><br><span class="line">                    group.grantRuntimePermissions(<span class="keyword">false</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                group.setPolicyFixed(); <span class="comment">// 设置 policy fix 标志位</span></span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> DevicePolicyManager.PERMISSION_POLICY_AUTO_DENY: &#123;</span><br><span class="line">                <span class="comment">// 如果设备策略管理设定的是自动拒绝，</span></span><br><span class="line">                <span class="comment">//【2.1.6.2】且该 group 中有权限已授予，那就拒绝他们！</span></span><br><span class="line">                <span class="keyword">if</span> (group.areRuntimePermissionsGranted()) &#123;</span><br><span class="line">                    <span class="comment">//【3.2】撤掉权限</span></span><br><span class="line">                    group.revokeRuntimePermissions(<span class="keyword">false</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                group.setPolicyFixed();  <span class="comment">// 设置 policy fix 标志位</span></span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">default</span>: &#123;</span><br><span class="line">                <span class="comment">// 如果设备策略管理设定的是其他策略（正常情况），</span></span><br><span class="line">                <span class="comment">// 如果 group 中有权限未授予，那就将其添加到 mRequestGrantPermissionGroups，接下来要申请！</span></span><br><span class="line">                <span class="comment">// 如果 group 中有权限已授予，那就授予所有的权限，并更新授予结果；</span></span><br><span class="line">                <span class="keyword">if</span> (!group.areRuntimePermissionsGranted()) &#123; <span class="comment">// 同【2.1.6.2】</span></span><br><span class="line">                    mRequestGrantPermissionGroups.put(group.getName(),</span><br><span class="line">                            <span class="keyword">new</span> GroupState(group));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//【3.1】直接授予运行时权限！</span></span><br><span class="line">                    group.grantRuntimePermissions(<span class="keyword">false</span>);</span><br><span class="line">                    updateGrantResults(group); <span class="comment">// 更新申请结果！</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 如果权限已经被 fix，不用再提醒，那就直接更新权限的申请结果！</span></span><br><span class="line">        updateGrantResults(group);</span><br><span class="line">    &#125;</span><br><span class="line">    ... ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当然，一般情况下，我们会进入 default 分支！</p>
<p>这里的 mRequestGrantPermissionGroups 用于保存所有的需要申请的 group 信息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">GroupState</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STATE_UNKNOWN = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STATE_ALLOWED = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STATE_DENIED = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> AppPermissionGroup mGroup;</span><br><span class="line">    <span class="keyword">int</span> mState = STATE_UNKNOWN;</span><br><span class="line"></span><br><span class="line">    GroupState(AppPermissionGroup group) &#123;</span><br><span class="line">        mGroup = group;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>AppPermissionGroup 会被封装为一个 GroupState 对象，GroupState.mState 保存了该组的授予情况！</p>
<h4 id="2-1-6-1-AppPermissionGroup-isUserFixed-isPolicyFixed"><a href="#2-1-6-1-AppPermissionGroup-isUserFixed-isPolicyFixed" class="headerlink" title="2.1.6.1 AppPermissionGroup.isUserFixed/isPolicyFixed"></a>2.1.6.1 AppPermissionGroup.isUserFixed/isPolicyFixed</h4><p>判断该权限组中是否包含没被 user fix 的权限，如果包含，返回 false！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isUserFixed</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> permissionCount = mPermissions.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; permissionCount; i++) &#123;</span><br><span class="line">        Permission permission = mPermissions.valueAt(i);</span><br><span class="line">        <span class="comment">//【1】该权限组只要有一个 no user fix 的权限，那个这个组就是 no user fix 的！</span></span><br><span class="line">        <span class="keyword">if</span> (!permission.isUserFixed()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用了 Permission.isUserFixed 方法！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isUserFixed</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (mFlags &amp; PackageManager.FLAG_PERMISSION_USER_FIXED) != <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>同样的，isPolicyFixed 也是类似的作用，判断该权限组中是否包含没有被 policy fix 的权限！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isPolicyFixed</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> permissionCount = mPermissions.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; permissionCount; i++) &#123;</span><br><span class="line">        Permission permission = mPermissions.valueAt(i);</span><br><span class="line">        <span class="comment">//【1】该权限组中没有任何一个 policy fix 的权限，那个这个组才是 no policy fix 的！</span></span><br><span class="line">        <span class="keyword">if</span> (permission.isPolicyFixed()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这是因为 policy fix 属于系统的默认授予机制，针对整个组的权限！</p>
<p>同样的调用了 Permission.isPolicyFixed 方法！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isPolicyFixed</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (mFlags &amp; PackageManager.FLAG_PERMISSION_POLICY_FIXED) != <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="2-1-6-2-AppPermissionGroup-areRuntimePermissionsGranted"><a href="#2-1-6-2-AppPermissionGroup-areRuntimePermissionsGranted" class="headerlink" title="2.1.6.2 AppPermissionGroup.areRuntimePermissionsGranted"></a>2.1.6.2 AppPermissionGroup.areRuntimePermissionsGranted</h4><p>该方法用户判断该 group 中是否有运行时权限被授予！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">areRuntimePermissionsGranted</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> areRuntimePermissionsGranted(<span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>接着会调用一参数的 areRuntimePermissionsGranted 方法，参数的意思不多说了！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">areRuntimePermissionsGranted</span><span class="params">(String[] filterPermissions)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (LocationUtils.isLocationGroupAndProvider(mName, mPackageInfo.packageName)) &#123;</span><br><span class="line">        <span class="keyword">return</span> LocationUtils.isLocationEnabled(mContext);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【1】遍历该组中的所有运行时权限，根据前面知道，该组中的权限都是该 package 申请的！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> permissionCount = mPermissions.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; permissionCount; i++) &#123;</span><br><span class="line">        Permission permission = mPermissions.valueAt(i);</span><br><span class="line">        <span class="keyword">if</span> (filterPermissions != <span class="keyword">null</span> <span class="comment">// 如果 filterPermissions 不为 null，那就只处理其内部的权限！</span></span><br><span class="line">                &amp;&amp; !ArrayUtils.contains(filterPermissions, permission.getName())) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【1.1】如果应用支持运行时权限机制，并且该权限已经被授予，那就返回 true！</span></span><br><span class="line">        <span class="keyword">if</span> (mAppSupportsRuntimePermissions) &#123;</span><br><span class="line">            <span class="keyword">if</span> (permission.isGranted()) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (permission.isGranted() &amp;&amp; (permission.getAppOp() == <span class="keyword">null</span></span><br><span class="line">                || permission.isAppOpAllowed())) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>; <span class="comment">// 如果该 group 中没有运行时权限被授予，返回 false！</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果有一个运行时权限被授予，那么就会返回 true！</p>
<p>如果没有一个运行时权限被授予，那么就会返回 false！</p>
<h3 id="2-1-7-GPViewHandlerImpl-createView"><a href="#2-1-7-GPViewHandlerImpl-createView" class="headerlink" title="2.1.7 GPViewHandlerImpl.createView"></a>2.1.7 GPViewHandlerImpl.createView</h3><p>接着，通过 setContentView，创建布局界面！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> View <span class="title">createView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mRootView = (ManualLayoutFrame) LayoutInflater.from(mContext)</span><br><span class="line">            .inflate(R.layout.grant_permissions, <span class="keyword">null</span>);</span><br><span class="line">    mButtonBar = (ButtonBarLayout) mRootView.findViewById(R.id.button_group);</span><br><span class="line">    mButtonBar.setAllowStacking(<span class="keyword">true</span>);</span><br><span class="line">    mMessageView = (TextView) mRootView.findViewById(R.id.permission_message);</span><br><span class="line">    mIconView = (ImageView) mRootView.findViewById(R.id.permission_icon);</span><br><span class="line">    mCurrentGroupView = (TextView) mRootView.findViewById(R.id.current_page_text);</span><br><span class="line">    mDoNotAskCheckbox = (CheckBox) mRootView.findViewById(R.id.do_not_ask_checkbox);</span><br><span class="line">    mAllowButton = (Button) mRootView.findViewById(R.id.permission_allow_button);</span><br><span class="line"></span><br><span class="line">    mDialogContainer = (ViewGroup) mRootView.findViewById(R.id.dialog_container);</span><br><span class="line">    mDescContainer = (ViewGroup) mRootView.findViewById(R.id.desc_container);</span><br><span class="line">    mCurrentDesc = (ViewGroup) mRootView.findViewById(R.id.perm_desc_root);</span><br><span class="line"></span><br><span class="line">    mAllowButton.setOnClickListener(<span class="keyword">this</span>); <span class="comment">// 授予按钮！</span></span><br><span class="line">    mRootView.findViewById(R.id.permission_deny_button).setOnClickListener(<span class="keyword">this</span>); <span class="comment">// 拒绝按钮！</span></span><br><span class="line">    mDoNotAskCheckbox.setOnClickListener(<span class="keyword">this</span>); <span class="comment">// 不在提醒按钮！</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mGroupName != <span class="keyword">null</span>) &#123; <span class="comment">// mGroupName 用于恢复界面显示！</span></span><br><span class="line">        updateDescription();</span><br><span class="line">        updateGroup();</span><br><span class="line">        updateDoNotAskCheckBox();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mRootView;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们看到，这里给三个按钮绑定的点击事件！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (view.getId()) &#123;</span><br><span class="line">        <span class="keyword">case</span> R.id.permission_allow_button: <span class="comment">// 授予权限</span></span><br><span class="line">            <span class="keyword">if</span> (mResultListener != <span class="keyword">null</span>) &#123;</span><br><span class="line">                view.clearAccessibilityFocus();</span><br><span class="line">                mResultListener.onPermissionGrantResult(mGroupName, <span class="keyword">true</span>, <span class="keyword">false</span>); </span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> R.id.permission_deny_button: <span class="comment">// 拒绝权限</span></span><br><span class="line">            mAllowButton.setEnabled(<span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">if</span> (mResultListener != <span class="keyword">null</span>) &#123;</span><br><span class="line">                view.clearAccessibilityFocus();</span><br><span class="line">                mResultListener.onPermissionGrantResult(mGroupName, <span class="keyword">false</span>,</span><br><span class="line">                        mShowDonNotAsk &amp;&amp; mDoNotAskCheckbox.isChecked());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> R.id.do_not_ask_checkbox: <span class="comment">// 不再提醒</span></span><br><span class="line">            mAllowButton.setEnabled(!mDoNotAskCheckbox.isChecked());</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当我们点击 allow 或者 deny 后，会回调 mResultListener.onPermissionGrantResult 方法！</p>
<p>当我们点击授予后，执行：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mResultListener.onPermissionGrantResult(mGroupName, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br></pre></td></tr></table></figure></p>
<p>当我们点击拒绝后，执行：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mResultListener.onPermissionGrantResult(mGroupName, <span class="keyword">false</span>, mShowDonNotAsk &amp;&amp; mDoNotAskCheckbox.isChecked());</span><br></pre></td></tr></table></figure></p>
<ul>
<li><strong>onPermissionGrantResult 参数解析</strong></li>
</ul>
<p>onPermissionGrantResult 的第二个参数 granted 表示授予或者拒绝，为 true 表示授予，为 false 表示拒绝；</p>
<p>onPermissionGrantResult 的第三个参数 doNotAskAgain 表示是否不再询问，为 true 表示不再询问，为 false 需再次询问；</p>
<ul>
<li><p><strong>onPermissionGrantResult 参数处理</strong></p>
<ul>
<li>如果用户本次授予了权限，那么 doNotAskAgain 为 false，意味着下次会继续询问；</li>
<li>如果用户本次拒绝了权限，但是没有选择不再提醒，那么 doNotAskAgain 为 false，意味着下次会继续询问；</li>
<li>如果用户本次拒绝了权限，但是同时选择不再提醒，那么 doNotAskAgain 为 true，那么下次就不会再提醒询问了；</li>
</ul>
</li>
</ul>
<p>当我们点击不再提醒 CheckBox 后，可以看到，授予按钮是无法点击的！</p>
<h4 id="2-1-7-1-GrantPermissionsActivity-onPermissionGrantResult"><a href="#2-1-7-1-GrantPermissionsActivity-onPermissionGrantResult" class="headerlink" title="2.1.7.1 GrantPermissionsActivity.onPermissionGrantResult"></a>2.1.7.1 GrantPermissionsActivity.onPermissionGrantResult</h4><p>mResultListener 实际上就是 GrantPermissionsActivity，我们去看看 onPermissionGrantResult 方法！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPermissionGrantResult</span><span class="params">(String name, <span class="keyword">boolean</span> granted, <span class="keyword">boolean</span> doNotAskAgain)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】根据 name 获得对应的运行时权限组！</span></span><br><span class="line">    GroupState groupState = mRequestGrantPermissionGroups.get(name);</span><br><span class="line">    <span class="keyword">if</span> (groupState.mGroup != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (granted) &#123; </span><br><span class="line">            <span class="comment">//【2.1.6.3】处理授予情况！</span></span><br><span class="line">            groupState.mGroup.grantRuntimePermissions(doNotAskAgain); </span><br><span class="line">            groupState.mState = GroupState.STATE_ALLOWED; <span class="comment">// 更新 group 状态！</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">            <span class="comment">//【2.1.6.4】处理拒绝情况！</span></span><br><span class="line">            groupState.mGroup.revokeRuntimePermissions(doNotAskAgain);</span><br><span class="line">            groupState.mState = GroupState.STATE_DENIED;</span><br><span class="line">        &#125;</span><br><span class="line">        updateGrantResults(groupState.mGroup); <span class="comment">// 更新结果！</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!showNextPermissionGroupGrantRequest()) &#123; <span class="comment">//【2.1.8】继续下一个组的处理！</span></span><br><span class="line">        setResultAndFinish(); <span class="comment">//【2.1.9】处理请求结果，结束！</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，对于每个组的运行时权限，最后调用的是 setResultAndFinish 会将权限处理的结果返回给请求的 activity！</p>
<h3 id="2-1-8-GPViewHandlerImpl-showNextPermissionGroupGrantRequest"><a href="#2-1-8-GPViewHandlerImpl-showNextPermissionGroupGrantRequest" class="headerlink" title="2.1.8 GPViewHandlerImpl.showNextPermissionGroupGrantRequest"></a>2.1.8 GPViewHandlerImpl.showNextPermissionGroupGrantRequest</h3><p>接下来，就是请求运行时权限了！mRequestGrantPermissionGroups 中保存了所有需要请求的运行时权限组！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">showNextPermissionGroupGrantRequest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> groupCount = mRequestGrantPermissionGroups.size();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> currentIndex = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (GroupState groupState : mRequestGrantPermissionGroups.values()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (groupState.mState == GroupState.STATE_UNKNOWN) &#123;</span><br><span class="line">            CharSequence appLabel = mAppPermissions.getAppLabel();</span><br><span class="line">            Spanned message = Html.fromHtml(getString(R.string.permission_warning_template,</span><br><span class="line">                    appLabel, groupState.mGroup.getDescription()), <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【1】将权限信息作为 titile！</span></span><br><span class="line">            setTitle(message);</span><br><span class="line"></span><br><span class="line">            Resources resources;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                resources = getPackageManager().getResourcesForApplication(</span><br><span class="line">                        groupState.mGroup.getIconPkg());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NameNotFoundException e) &#123;</span><br><span class="line">                <span class="comment">// Fallback to system.</span></span><br><span class="line">                resources = Resources.getSystem();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">int</span> icon = groupState.mGroup.getIconResId();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【2.1.8.1】更新 ui 显示！</span></span><br><span class="line">            mViewHandler.updateUi(groupState.mGroup.getName(), groupCount, currentIndex,</span><br><span class="line">                    Icon.createWithResource(resources, icon), message,</span><br><span class="line">                    groupState.mGroup.isUserSet());</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        currentIndex++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后会调用了 updateUi 方法，更新 ui 显示！</p>
<p>updateUi 的最后一个参数：boolean showDonNotAsk 表示是否显示　“不再提醒”　的 CheckBox，为 true，表示不显示，其值取决于：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">groupState.mGroup.isUserSet()</span><br></pre></td></tr></table></figure></p>
<p>我们去看看 group 的 isUserSet 方法！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isUserSet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> permissionCount = mPermissions.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; permissionCount; i++) &#123;</span><br><span class="line">        Permission permission = mPermissions.valueAt(i);</span><br><span class="line">        <span class="keyword">if</span> (!permission.isUserSet()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>也就是说，取决于该 group 中该应用请求的运行时权限是否都是 user set 的，即：<strong>之前用户是否拒绝授予过权限</strong>，只有之前拒绝过并且没有选择不在提醒，下一次提醒用户时，才会显示 checkbox！</p>
<h4 id="2-1-8-1-GPViewHandlerImpl-updateUi"><a href="#2-1-8-1-GPViewHandlerImpl-updateUi" class="headerlink" title="2.1.8.1 GPViewHandlerImpl.updateUi"></a>2.1.8.1 GPViewHandlerImpl.updateUi</h4><p>showDonNotAsk 的取值为 groupState.mGroup.isUserSet()，就似乎说，如果用户之前拒绝了该权限并且没有选择不再提醒，那么再次提示时 showDonNotAsk 为 true！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateUi</span><span class="params">(String groupName, <span class="keyword">int</span> groupCount, <span class="keyword">int</span> groupIndex, Icon icon,</span></span></span><br><span class="line"><span class="function"><span class="params">        CharSequence message, <span class="keyword">boolean</span> showDonNotAsk)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】保存当前的显示内容和进度！</span></span><br><span class="line">    mGroupName = groupName; <span class="comment">// group 名！</span></span><br><span class="line">    mGroupCount = groupCount; <span class="comment">// group 的总数！</span></span><br><span class="line">    mGroupIndex = groupIndex; <span class="comment">// 当前处理的 group！ </span></span><br><span class="line">    mGroupIcon = icon;</span><br><span class="line">    mGroupMessage = message;</span><br><span class="line">    mShowDonNotAsk = showDonNotAsk; <span class="comment">// 是否显示 checkBox</span></span><br><span class="line">    mDoNotAskChecked = <span class="keyword">false</span>; <span class="comment">// 是否不再提醒！</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// If this is a second (or later) permission and the views exist, then animate.</span></span><br><span class="line">    <span class="keyword">if</span> (mIconView != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mGroupIndex &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// The first message will be announced as the title of the activity, all others</span></span><br><span class="line">            <span class="comment">// we need to announce ourselves.</span></span><br><span class="line">            mDescContainer.announceForAccessibility(message);</span><br><span class="line">            animateToPermission();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            updateDescription();</span><br><span class="line">            updateGroup();</span><br><span class="line">            updateDoNotAskCheckBox();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来，就会显示出权限弹窗了！</p>
<p>用户会通过点击弹窗中的按钮，授予或者拒绝权限！</p>
<h5 id="2-1-8-1-1-GPViewHandlerImpl-updateDescription"><a href="#2-1-8-1-1-GPViewHandlerImpl-updateDescription" class="headerlink" title="2.1.8.1.1 GPViewHandlerImpl.updateDescription"></a>2.1.8.1.1 GPViewHandlerImpl.updateDescription</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateDescription</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mIconView.setImageDrawable(mGroupIcon.loadDrawable(mContext));</span><br><span class="line">    mMessageView.setText(mGroupMessage);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="2-1-8-1-2-GPViewHandlerImpl-updateGroup"><a href="#2-1-8-1-2-GPViewHandlerImpl-updateGroup" class="headerlink" title="2.1.8.1.2 GPViewHandlerImpl.updateGroup"></a>2.1.8.1.2 GPViewHandlerImpl.updateGroup</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateGroup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mGroupCount &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        mCurrentGroupView.setVisibility(View.VISIBLE);</span><br><span class="line">        mCurrentGroupView.setText(mContext.getString(R.string.current_permission_template,</span><br><span class="line">                mGroupIndex + <span class="number">1</span>, mGroupCount));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mCurrentGroupView.setVisibility(View.INVISIBLE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="2-1-8-1-3-GPViewHandlerImpl-updateDoNotAskCheckBox"><a href="#2-1-8-1-3-GPViewHandlerImpl-updateDoNotAskCheckBox" class="headerlink" title="2.1.8.1.3 GPViewHandlerImpl.updateDoNotAskCheckBox"></a>2.1.8.1.3 GPViewHandlerImpl.updateDoNotAskCheckBox</h5><p>是否显示 CheckBox 取决于 mShowDonNotAsk，如果 mShowDonNotAsk 为 true，那就显示 checkBox！</p>
<p>CheckBox 的默认状态则是由 mDoNotAskChecked 来决定，默认 mDoNotAskChecked 为 false，此时 CheckBox 没有被选中！</p>
<p>同时 CheckBox 的点击也会修改 mDoNotAskChecked 的值！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateDoNotAskCheckBox</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mShowDonNotAsk) &#123;</span><br><span class="line">        <span class="comment">// 显示 CheckBox</span></span><br><span class="line">        mDoNotAskCheckbox.setVisibility(View.VISIBLE);</span><br><span class="line">        mDoNotAskCheckbox.setOnClickListener(<span class="keyword">this</span>);</span><br><span class="line">        mDoNotAskCheckbox.setChecked(mDoNotAskChecked); <span class="comment">// 根据 mDoNotAskChecked 的值设置 CheckBox 的状态！</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 不显示 CheckBox</span></span><br><span class="line">        mDoNotAskCheckbox.setVisibility(View.GONE);</span><br><span class="line">        mDoNotAskCheckbox.setOnClickListener(<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="2-1-9-GrantPermissionsActivity-setResultAndFinish"><a href="#2-1-9-GrantPermissionsActivity-setResultAndFinish" class="headerlink" title="2.1.9 GrantPermissionsActivity.setResultAndFinish"></a>2.1.9 GrantPermissionsActivity.setResultAndFinish</h3><p>处理结果：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setResultAndFinish</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    setResultIfNeeded(RESULT_OK);</span><br><span class="line">    finish(); <span class="comment">// 调用 finish，结束当前 activity！</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>setResultAndFinish 会调用 setResultIfNeeded 方法！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setResultIfNeeded</span><span class="params">(<span class="keyword">int</span> resultCode)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!mResultSet) &#123;</span><br><span class="line">        mResultSet = <span class="keyword">true</span>;</span><br><span class="line">        logRequestedPermissionGroups();</span><br><span class="line">        <span class="comment">// 同样的，创建一个 intent，action 为 ACTION_REQUEST_PERMISSIONS！</span></span><br><span class="line">        Intent result = <span class="keyword">new</span> Intent(PackageManager.ACTION_REQUEST_PERMISSIONS);</span><br><span class="line">        <span class="comment">// 保存了请求的权限和请求结果！</span></span><br><span class="line">        result.putExtra(PackageManager.EXTRA_REQUEST_PERMISSIONS_NAMES, mRequestedPermissions);</span><br><span class="line">        result.putExtra(PackageManager.EXTRA_REQUEST_PERMISSIONS_RESULTS, mGrantResults);</span><br><span class="line">        <span class="comment">// 将结果返回给请求权限的 activity</span></span><br><span class="line">        setResult(resultCode, result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在调用了 finish 后，请求结果会返回到请求的 acitivty！</p>
<h4 id="2-1-9-1-RequestActivity-onRequestPermissionsResult"><a href="#2-1-9-1-RequestActivity-onRequestPermissionsResult" class="headerlink" title="2.1.9.1 RequestActivity.onRequestPermissionsResult"></a>2.1.9.1 RequestActivity.onRequestPermissionsResult</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRequestPermissionsResult</span><span class="params">(<span class="keyword">int</span> requestCode, String[] permissions, <span class="keyword">int</span>[] grantResults)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onRequestPermissionsResult(requestCode, permissions, grantResults);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后，我们会在请求的 activity 中收到权限请求的结果！</p>
<h1 id="3-AppPermissionGroup-Grant-or-Revoke-授予-拒绝"><a href="#3-AppPermissionGroup-Grant-or-Revoke-授予-拒绝" class="headerlink" title="3 AppPermissionGroup: Grant or Revoke - 授予/拒绝"></a>3 AppPermissionGroup: Grant or Revoke - 授予/拒绝</h1><p>下面我们来看看 AppPermissionGroup 是如何授予和拒绝权限的！</p>
<h2 id="3-1-AppPermissionGroup-grantRuntimePermissions"><a href="#3-1-AppPermissionGroup-grantRuntimePermissions" class="headerlink" title="3.1 AppPermissionGroup.grantRuntimePermissions"></a>3.1 AppPermissionGroup.grantRuntimePermissions</h2><p>fixedByTheUser 表示是否是被用户 fix 的:</p>
<p>对于 permissionPolicy 如果为 DevicePolicyManager.PERMISSION_POLICY_AUTO_GRANT 的情况，其值为 false，我们会自动授予权限！</p>
<p>正常情况下，是需要根据用户的选择来设置这个值的，如果用户本次授予了权限，那么 fixedByTheUser 依然为 false； </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">grantRuntimePermissions</span><span class="params">(<span class="keyword">boolean</span> fixedByTheUser)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> grantRuntimePermissions(fixedByTheUser, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用的二参数的同名方法！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">grantRuntimePermissions</span><span class="params">(<span class="keyword">boolean</span> fixedByTheUser, String[] filterPermissions)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> uid = mPackageInfo.applicationInfo.uid;</span><br><span class="line">    <span class="comment">//【1】我们仅将权限切换到支持运行时权限的应用程序，否则，如果权限授予应用程序，则会切换与权限对应的应用程序op。</span></span><br><span class="line">    <span class="keyword">for</span> (Permission permission : mPermissions.values()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (filterPermissions != <span class="keyword">null</span> <span class="comment">// 处理权限过滤，这里不关注！</span></span><br><span class="line">                &amp;&amp; !ArrayUtils.contains(filterPermissions, permission.getName())) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mAppSupportsRuntimePermissions) &#123; <span class="comment">//【1.1】对于运行时权限进入这里！</span></span><br><span class="line">            <span class="keyword">if</span> (permission.isSystemFixed()) &#123; <span class="comment">// 如果运行时权限被 system fix 了，结束处理！</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【1.1.1】确保运行时权限在授予之前，AppOp 为 allow 状态！</span></span><br><span class="line">            <span class="comment">// 判断该权限是否有对应的 AppOps，如果有且不处于 Allow 状态，设置其为 Allow！</span></span><br><span class="line">            <span class="keyword">if</span> (permission.hasAppOp() &amp;&amp; !permission.isAppOpAllowed()) &#123;</span><br><span class="line">                permission.setAppOpAllowed(<span class="keyword">true</span>);</span><br><span class="line">                mAppOps.setUidMode(permission.getAppOp(), uid, AppOpsManager.MODE_ALLOWED);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!permission.isGranted()) &#123;</span><br><span class="line">                permission.setGranted(<span class="keyword">true</span>);</span><br><span class="line">                <span class="comment">//【4.1】调用了 pms 的接口授予用户权限</span></span><br><span class="line">                mPackageManager.grantRuntimePermission(mPackageInfo.packageName,</span><br><span class="line">                        permission.getName(), mUserHandle);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【1.1.2】如果 fixedByTheUser 为 false，更新权限的 flags。</span></span><br><span class="line">            <span class="keyword">if</span> (!fixedByTheUser) &#123;</span><br><span class="line">                <span class="comment">// 如果该运行时权限处于 user fix 或者 user set 状态，那么我们会强制取消 user fix 状态！</span></span><br><span class="line">                <span class="comment">// 这样用户就可以再次请求请求权限，因为其不处于 user fix 状态！</span></span><br><span class="line">                <span class="keyword">if</span> (permission.isUserFixed() || permission.isUserSet()) &#123;</span><br><span class="line">                    permission.setUserFixed(<span class="keyword">false</span>);</span><br><span class="line">                    permission.setUserSet(<span class="keyword">true</span>);</span><br><span class="line">                    <span class="comment">// 更新权限的 flags，</span></span><br><span class="line">                    <span class="comment">// 去掉 flags 中 FLAG_PERMISSION_USER_FIXED 和 FLAG_PERMISSION_USER_SET 位！</span></span><br><span class="line">                    mPackageManager.updatePermissionFlags(permission.getName(),</span><br><span class="line">                            mPackageInfo.packageName,</span><br><span class="line">                            PackageManager.FLAG_PERMISSION_USER_FIXED</span><br><span class="line">                                    | PackageManager.FLAG_PERMISSION_USER_SET,</span><br><span class="line">                            <span class="number">0</span>, mUserHandle);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//【1.2】如果应用不支持运行时权限，这里不处理未授予情况，因为在 API 23 之前运行时权限是自动授予的！</span></span><br><span class="line">            <span class="keyword">if</span> (!permission.isGranted()) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> killUid = -<span class="number">1</span>;</span><br><span class="line">            <span class="keyword">int</span> mask = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 如果权限没有对应的 app op，那么说明这是一个第三方应用，那么我们不对其做调整；</span></span><br><span class="line">            <span class="comment">// 否则，我们会调整其 app op！</span></span><br><span class="line">            <span class="keyword">if</span> (permission.hasAppOp()) &#123;</span><br><span class="line">                <span class="comment">// 如果权限不允许 app op，那就开启 app ops！</span></span><br><span class="line">                <span class="keyword">if</span> (!permission.isAppOpAllowed()) &#123;</span><br><span class="line">                    permission.setAppOpAllowed(<span class="keyword">true</span>);</span><br><span class="line">                    <span class="comment">// 开启 app op</span></span><br><span class="line">                    mAppOps.setUidMode(permission.getAppOp(), uid, AppOpsManager.MODE_ALLOWED);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 对于旧版本的不支持运行时权限的应用，当其运行时权限改变后，其不会尝试重试资源的访问，</span></span><br><span class="line">                    <span class="comment">// 所以我们需要杀掉其进程，使其重新加载！</span></span><br><span class="line">                    killUid = uid;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 如果应用从不支持运行时权限升级到了支持运行时权限的版本，升级后不能自动授予权限！</span></span><br><span class="line">                <span class="comment">// 权限设置了 FLAG_PERMISSION_REVOKE_ON_UPGRADE 标志位！</span></span><br><span class="line">                <span class="keyword">if</span> (permission.shouldRevokeOnUpgrade()) &#123;</span><br><span class="line">                    permission.setRevokeOnUpgrade(<span class="keyword">false</span>);</span><br><span class="line">                    mask |= PackageManager.FLAG_PERMISSION_REVOKE_ON_UPGRADE;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mask != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// 更新该权限的 flags，取消 FLAG_PERMISSION_REVOKE_ON_UPGRADE 标志位！</span></span><br><span class="line">                mPackageManager.updatePermissionFlags(permission.getName(),</span><br><span class="line">                        mPackageInfo.packageName, mask, <span class="number">0</span>, mUserHandle);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (killUid != -<span class="number">1</span>) &#123; <span class="comment">// 杀掉进程！</span></span><br><span class="line">                mActivityManager.killUid(uid, KILL_REASON_APP_OP_CHANGE);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>对于允许权限的情况：</p>
<ul>
<li>那么 fixedByTheUser 只能是 false，我们会取消 user set 和 user fix 标志位！</li>
</ul>
<h2 id="3-2-AppPermissionGroup-revokeRuntimePermissions"><a href="#3-2-AppPermissionGroup-revokeRuntimePermissions" class="headerlink" title="3.2 AppPermissionGroup.revokeRuntimePermissions"></a>3.2 AppPermissionGroup.revokeRuntimePermissions</h2><p>对于 permissionPolicy 为 DevicePolicyManager.PERMISSION_POLICY_AUTO_DENY 的情况，fixedByTheUser 为 false，同时会自动撤销权限！</p>
<p>正常情况下，是需要根据用户的选择来设置这个值的，如果用户本次拒绝了权限，但是 fixedByTheUser 可能有两种情况：</p>
<ul>
<li>如果用户只是拒绝了权限，但是没有点击不再提醒，那么 fixedByTheUser 为 false；</li>
<li>如果用户不仅拒绝了权限，同时选择了不再提醒，那么 fixedByTheUser 为 true；</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">revokeRuntimePermissions</span><span class="params">(<span class="keyword">boolean</span> fixedByTheUser)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> revokeRuntimePermissions(fixedByTheUser, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用了 revokeRuntimePermissions 的另一个方法！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">revokeRuntimePermissions</span><span class="params">(<span class="keyword">boolean</span> fixedByTheUser, String[] filterPermissions)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> uid = mPackageInfo.applicationInfo.uid;</span><br><span class="line">    <span class="comment">//【1】我们仅将权限切换到支持运行时权限的应用程序，否则，如果权限授予应用程序，则会切换与权限对应的应用程序 op。</span></span><br><span class="line">    <span class="keyword">for</span> (Permission permission : mPermissions.values()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (filterPermissions != <span class="keyword">null</span></span><br><span class="line">                &amp;&amp; !ArrayUtils.contains(filterPermissions, permission.getName())) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mAppSupportsRuntimePermissions) &#123; <span class="comment">//【1.1】对于运行时权限进入这里！</span></span><br><span class="line">            <span class="keyword">if</span> (permission.isSystemFixed()) &#123; <span class="comment">// 如果运行时权限被 system fix 了，结束处理！</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (permission.isGranted()) &#123;</span><br><span class="line">                permission.setGranted(<span class="keyword">false</span>);</span><br><span class="line">                <span class="comment">//【4.2】调用了 PMS 的接口撤销权限</span></span><br><span class="line">                mPackageManager.revokeRuntimePermission(mPackageInfo.packageName,</span><br><span class="line">                        permission.getName(), mUserHandle);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【1.1.1】更新权限的标志位！</span></span><br><span class="line">            <span class="keyword">if</span> (fixedByTheUser) &#123;</span><br><span class="line">                <span class="comment">//【1.1.1.1】如果 fixedByTheUser 是 true，且权限是 user set 或者不是 user fix，</span></span><br><span class="line">                <span class="comment">// 我们取消 set 设置其为 user fix！</span></span><br><span class="line">                <span class="keyword">if</span> (permission.isUserSet() || !permission.isUserFixed()) &#123;</span><br><span class="line">                    permission.setUserSet(<span class="keyword">false</span>);</span><br><span class="line">                    permission.setUserFixed(<span class="keyword">true</span>);</span><br><span class="line">                    <span class="comment">// 取消 user set 标志，设置 user fix 标志！</span></span><br><span class="line">                    mPackageManager.updatePermissionFlags(permission.getName(),</span><br><span class="line">                            mPackageInfo.packageName,</span><br><span class="line">                            PackageManager.FLAG_PERMISSION_USER_SET</span><br><span class="line">                                    | PackageManager.FLAG_PERMISSION_USER_FIXED,</span><br><span class="line">                            PackageManager.FLAG_PERMISSION_USER_FIXED,</span><br><span class="line">                            mUserHandle);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//【1.1.1.2】如果 fixedByTheUser 是 false，且权限不是 user set，我们设置其为 user set！</span></span><br><span class="line">                <span class="keyword">if</span> (!permission.isUserSet()) &#123;</span><br><span class="line">                    permission.setUserSet(<span class="keyword">true</span>);</span><br><span class="line">                    <span class="comment">// 设置 user set 标志，表示用户已经做过选择！！</span></span><br><span class="line">                    mPackageManager.updatePermissionFlags(permission.getName(),</span><br><span class="line">                            mPackageInfo.packageName,</span><br><span class="line">                            PackageManager.FLAG_PERMISSION_USER_SET,</span><br><span class="line">                            PackageManager.FLAG_PERMISSION_USER_SET,</span><br><span class="line">                            mUserHandle);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//【1.2】如果应用不支持运行时权限，这里不处理未授予情况，因为在 API 23 之前运行时权限是自动授予的！</span></span><br><span class="line">            <span class="keyword">if</span> (!permission.isGranted()) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> mask = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">int</span> flags = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">int</span> killUid = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 如果权限没有对应的 app op，那么说明这是一个第三方应用，那么我们不对其做调整；</span></span><br><span class="line">            <span class="comment">// 否则，我们会调整其 app op！</span></span><br><span class="line">            <span class="keyword">if</span> (permission.hasAppOp()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (permission.isAppOpAllowed()) &#123; <span class="comment">// 如果权限允许 app op，那就关闭 app ops！</span></span><br><span class="line">                    permission.setAppOpAllowed(<span class="keyword">false</span>);</span><br><span class="line">                    mAppOps.setUidMode(permission.getAppOp(), uid, AppOpsManager.MODE_IGNORED);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 对于旧版本的不支持运行时权限的引用，当其运行时权限改变后，其不会尝试重试资源的访问，</span></span><br><span class="line">                    <span class="comment">// 所以我们需要杀掉其进程，使其重新加载！</span></span><br><span class="line">                    killUid = uid;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 如果应用从不支持运行时权限升级到了支持运行时权限的版本，升级后不能自动授予权限！</span></span><br><span class="line">                <span class="comment">// 权限未设置 FLAG_PERMISSION_REVOKE_ON_UPGRADE 标志位！</span></span><br><span class="line">                <span class="keyword">if</span> (!permission.shouldRevokeOnUpgrade()) &#123;</span><br><span class="line">                    permission.setRevokeOnUpgrade(<span class="keyword">true</span>);</span><br><span class="line">                    mask |= PackageManager.FLAG_PERMISSION_REVOKE_ON_UPGRADE;</span><br><span class="line">                    flags |= PackageManager.FLAG_PERMISSION_REVOKE_ON_UPGRADE;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mask != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// 更新该权限的 flags，增加 FLAG_PERMISSION_REVOKE_ON_UPGRADE 标志位！</span></span><br><span class="line">                mPackageManager.updatePermissionFlags(permission.getName(),</span><br><span class="line">                        mPackageInfo.packageName, mask, flags, mUserHandle);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (killUid != -<span class="number">1</span>) &#123; <span class="comment">// 杀掉进程！</span></span><br><span class="line">                mActivityManager.killUid(uid, KILL_REASON_APP_OP_CHANGE);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>对于拒绝权限的情况：</p>
<ul>
<li><p>如果用户没有选择不再提醒，那么 fixedByTheUser 为 false，我们会设置 user set 标志位！</p>
</li>
<li><p>如果用户同时还选择了不再提醒，那么 fixedByTheUser 为 true，那么会取消 user set 标志位，同时设置 user fix 标志位！</p>
</li>
</ul>
<h1 id="4-PackageManagerService-Grant-or-Revoke-核心接口"><a href="#4-PackageManagerService-Grant-or-Revoke-核心接口" class="headerlink" title="4 PackageManagerService: Grant or Revoke - 核心接口"></a>4 PackageManagerService: Grant or Revoke - 核心接口</h1><p>当然，核心方法是调用 pms 的接口完成的，我们去看看这些方法！</p>
<h2 id="4-1-PackageManagerS-grantRuntimePermission"><a href="#4-1-PackageManagerS-grantRuntimePermission" class="headerlink" title="4.1 PackageManagerS.grantRuntimePermission"></a>4.1 PackageManagerS.grantRuntimePermission</h2><p>授予运行时权限：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">grantRuntimePermission</span><span class="params">(String packageName, String name, <span class="keyword">final</span> <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!sUserManager.exists(userId)) &#123; <span class="comment">//【1】校验用户是否存在！</span></span><br><span class="line">        Log.e(TAG, <span class="string">"No such user:"</span> + userId);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mContext.enforceCallingOrSelfPermission( <span class="comment">//【2】校验调用者是否有相应权限；</span></span><br><span class="line">            android.Manifest.permission.GRANT_RUNTIME_PERMISSIONS,</span><br><span class="line">            <span class="string">"grantRuntimePermission"</span>);</span><br><span class="line"></span><br><span class="line">    enforceCrossUserPermission(Binder.getCallingUid(), userId,</span><br><span class="line">            <span class="keyword">true</span> <span class="comment">/* requireFullPermission */</span>, <span class="keyword">true</span> <span class="comment">/* checkShell */</span>,</span><br><span class="line">            <span class="string">"grantRuntimePermission"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> uid;</span><br><span class="line">    <span class="keyword">final</span> SettingBase sb;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="keyword">final</span> PackageParser.Package pkg = mPackages.get(packageName);</span><br><span class="line">        <span class="keyword">if</span> (pkg == <span class="keyword">null</span>) &#123; <span class="comment">//【3】package 不存在，异常！</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unknown package: "</span> + packageName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> BasePermission bp = mSettings.mPermissions.get(name);</span><br><span class="line">        <span class="keyword">if</span> (bp == <span class="keyword">null</span>) &#123; <span class="comment">//【4】权限不存在，异常！</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unknown permission: "</span> + name);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        enforceDeclaredAsUsedAndRuntimeOrDevelopmentPermission(pkg, bp);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【5】如果 targetSdkVersion 小于 M，那么是不支持运行时权限的，我们在安装的时候会自动授予运行时权限！</span></span><br><span class="line">        <span class="keyword">if</span> (Build.PERMISSIONS_REVIEW_REQUIRED</span><br><span class="line">                &amp;&amp; pkg.applicationInfo.targetSdkVersion &lt; Build.VERSION_CODES.M</span><br><span class="line">                &amp;&amp; bp.isRuntime()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        uid = UserHandle.getUid(userId, pkg.applicationInfo.uid);</span><br><span class="line">        sb = (SettingBase) pkg.mExtras;</span><br><span class="line">        <span class="keyword">if</span> (sb == <span class="keyword">null</span>) &#123;<span class="comment">//【6】升级包未安装过，异常！</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unknown package: "</span> + packageName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> PermissionsState permissionsState = sb.getPermissionsState();</span><br><span class="line">        <span class="comment">//【7】获得权限的 flags 标志位，如果该权限是被 system fix 的，我们不能操作这样的权限！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> flags = permissionsState.getPermissionFlags(name, userId);</span><br><span class="line">        <span class="keyword">if</span> ((flags &amp; PackageManager.FLAG_PERMISSION_SYSTEM_FIXED) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"Cannot grant system fixed permission "</span></span><br><span class="line">                    + name + <span class="string">" for package "</span> + packageName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【8】如果该权限是开发者权限，特殊处理，作为安装时权限，立刻授予！</span></span><br><span class="line">        <span class="comment">// 授予成功，会触发 Settings.writeLPr 方法，该方法会更新多个文件</span></span><br><span class="line">        <span class="comment">// 包括 pacakges.xml，pacakges.list，runtime-permissions.xml 等文件！</span></span><br><span class="line">        <span class="keyword">if</span> (bp.isDevelopment()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (permissionsState.grantInstallPermission(bp) !=</span><br><span class="line">                    PermissionsState.PERMISSION_OPERATION_FAILURE) &#123;</span><br><span class="line">                scheduleWriteSettingsLocked();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (pkg.applicationInfo.targetSdkVersion &lt; Build.VERSION_CODES.M) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Cannot grant runtime permission to a legacy app"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【9】授予权限，并处理授予结果！！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> result = permissionsState.grantRuntimePermission(bp, userId);</span><br><span class="line">        <span class="keyword">switch</span> (result) &#123;</span><br><span class="line">            <span class="keyword">case</span> PermissionsState.PERMISSION_OPERATION_FAILURE: &#123;</span><br><span class="line">                <span class="comment">//【9.1】授予失败，可能应用已经被授予权限了！</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> PermissionsState.PERMISSION_OPERATION_SUCCESS_GIDS_CHANGED: &#123;</span><br><span class="line">                <span class="comment">//【9.2】授予成功，但是应用映射的 gids 变化了！</span></span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> appId = UserHandle.getAppId(pkg.applicationInfo.uid);</span><br><span class="line">                mHandler.post(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        <span class="comment">//【9.2.1】杀掉应用的进程，应用后续会重启！</span></span><br><span class="line">                        killUid(appId, userId, KILL_APP_REASON_GIDS_CHANGED);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mOnPermissionChangeListeners.onPermissionsChanged(uid);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【10】更新 runtime-permissions.xml 文件！</span></span><br><span class="line">        mSettings.writeRuntimePermissionsForUserLPr(userId, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Only need to do this if user is initialized. Otherwise it's a new user</span></span><br><span class="line">    <span class="comment">// and there are no processes running as the user yet and there's no need</span></span><br><span class="line">    <span class="comment">// to make an expensive call to remount processes for the changed permissions.</span></span><br><span class="line">    <span class="keyword">if</span> (READ_EXTERNAL_STORAGE.equals(name)</span><br><span class="line">            || WRITE_EXTERNAL_STORAGE.equals(name)) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> token = Binder.clearCallingIdentity();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (sUserManager.isInitialized(userId)) &#123;</span><br><span class="line">                MountServiceInternal mountServiceInternal = LocalServices.getService(</span><br><span class="line">                        MountServiceInternal.class);</span><br><span class="line">                mountServiceInternal.onExternalStoragePolicyChanged(uid, packageName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            Binder.restoreCallingIdentity(token);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-2-PackageManagerS-revokeRuntimePermission"><a href="#4-2-PackageManagerS-revokeRuntimePermission" class="headerlink" title="4.2 PackageManagerS.revokeRuntimePermission"></a>4.2 PackageManagerS.revokeRuntimePermission</h2><p>拒绝运行时权限！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">revokeRuntimePermission</span><span class="params">(String packageName, String name, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!sUserManager.exists(userId)) &#123; <span class="comment">//【1】校验用户是否存在！</span></span><br><span class="line">        Log.e(TAG, <span class="string">"No such user:"</span> + userId);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mContext.enforceCallingOrSelfPermission( <span class="comment">//【2】校验调用者是否有相应权限；</span></span><br><span class="line">            android.Manifest.permission.REVOKE_RUNTIME_PERMISSIONS,</span><br><span class="line">            <span class="string">"revokeRuntimePermission"</span>);</span><br><span class="line"></span><br><span class="line">    enforceCrossUserPermission(Binder.getCallingUid(), userId,</span><br><span class="line">            <span class="keyword">true</span> <span class="comment">/* requireFullPermission */</span>, <span class="keyword">true</span> <span class="comment">/* checkShell */</span>,</span><br><span class="line">            <span class="string">"revokeRuntimePermission"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> appId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="keyword">final</span> PackageParser.Package pkg = mPackages.get(packageName);</span><br><span class="line">        <span class="keyword">if</span> (pkg == <span class="keyword">null</span>) &#123; <span class="comment">//【3】package 不存在，异常！</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unknown package: "</span> + packageName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> BasePermission bp = mSettings.mPermissions.get(name);</span><br><span class="line">        <span class="keyword">if</span> (bp == <span class="keyword">null</span>) &#123; <span class="comment">//【4】权限不存在，异常！</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unknown permission: "</span> + name);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        enforceDeclaredAsUsedAndRuntimeOrDevelopmentPermission(pkg, bp);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【5】如果 targetSdkVersion 小于 M，那么是不支持运行时权限的，我们在安装的时候会自动授予运行时权限！</span></span><br><span class="line">        <span class="keyword">if</span> (Build.PERMISSIONS_REVIEW_REQUIRED</span><br><span class="line">                &amp;&amp; pkg.applicationInfo.targetSdkVersion &lt; Build.VERSION_CODES.M</span><br><span class="line">                &amp;&amp; bp.isRuntime()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        SettingBase sb = (SettingBase) pkg.mExtras;</span><br><span class="line">        <span class="keyword">if</span> (sb == <span class="keyword">null</span>) &#123; <span class="comment">//【6】升级包未安装过，异常！</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unknown package: "</span> + packageName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> PermissionsState permissionsState = sb.getPermissionsState();</span><br><span class="line">        <span class="comment">//【7】获得权限的 flags 标志位，如果该权限是被 system fix 的，我们不能撤销这样的权限！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> flags = permissionsState.getPermissionFlags(name, userId);</span><br><span class="line">        <span class="keyword">if</span> ((flags &amp; PackageManager.FLAG_PERMISSION_SYSTEM_FIXED) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"Cannot revoke system fixed permission "</span></span><br><span class="line">                    + name + <span class="string">" for package "</span> + packageName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【8】如果该权限是开发者权限，特殊处理，立刻授予！</span></span><br><span class="line">        <span class="comment">// 授予成功，会触发 Settings.writeLPr 方法，该方法会更新多个文件</span></span><br><span class="line">        <span class="comment">// 包括 pacakges.xml，pacakges.list，runtime-permissions.xml 等文件！</span></span><br><span class="line">        <span class="keyword">if</span> (bp.isDevelopment()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (permissionsState.revokeInstallPermission(bp) !=</span><br><span class="line">                    PermissionsState.PERMISSION_OPERATION_FAILURE) &#123;</span><br><span class="line">                scheduleWriteSettingsLocked();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【9】撤销运行时权限！</span></span><br><span class="line">        <span class="keyword">if</span> (permissionsState.revokeRuntimePermission(bp, userId) ==</span><br><span class="line">                PermissionsState.PERMISSION_OPERATION_FAILURE) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mOnPermissionChangeListeners.onPermissionsChanged(pkg.applicationInfo.uid);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【10】更新 runtime-permissions.xml 文件！</span></span><br><span class="line">        mSettings.writeRuntimePermissionsForUserLPr(userId, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        appId = UserHandle.getAppId(pkg.applicationInfo.uid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    killUid(appId, userId, KILL_APP_REASON_PERMISSIONS_REVOKED); <span class="comment">// 杀掉应用的进程！</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后的又进入了 PermissionsState 对象，这个我在 PMS 中有分析过，这里就不在多说了！！</p>
<h1 id="5-Activity-shouldShowRequestPermissionRationale-解释权限含义"><a href="#5-Activity-shouldShowRequestPermissionRationale-解释权限含义" class="headerlink" title="5 Activity.shouldShowRequestPermissionRationale - 解释权限含义"></a>5 Activity.shouldShowRequestPermissionRationale - 解释权限含义</h1><p>为了防止用户因为不理解而拒绝了权限，我们可以在恰当的时间给用户解释为什么申请权限，这里要用到 shouldShowRequestPermissionRationale 方法！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">shouldShowRequestPermissionRationale</span><span class="params">(@NonNull String permission)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> getPackageManager().shouldShowRequestPermissionRationale(permission);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最终会调用 PackageManagerService 中的方法！</p>
<h2 id="5-1-PackageManagerS-shouldShowRequestPermissionRationale"><a href="#5-1-PackageManagerS-shouldShowRequestPermissionRationale" class="headerlink" title="5.1 PackageManagerS.shouldShowRequestPermissionRationale"></a>5.1 PackageManagerS.shouldShowRequestPermissionRationale</h2><p>该方法的返回值决定了是否应该给用户解释权限！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">shouldShowRequestPermissionRationale</span><span class="params">(String permissionName,</span></span></span><br><span class="line"><span class="function"><span class="params">        String packageName, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (UserHandle.getCallingUserId() != userId) &#123;</span><br><span class="line">        mContext.enforceCallingPermission(</span><br><span class="line">                android.Manifest.permission.INTERACT_ACROSS_USERS_FULL,</span><br><span class="line">                <span class="string">"canShowRequestPermissionRationale for user "</span> + userId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> uid = getPackageUid(packageName, MATCH_DEBUG_TRIAGED_MISSING, userId);</span><br><span class="line">    <span class="keyword">if</span> (UserHandle.getAppId(getCallingUid()) != UserHandle.getAppId(uid)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【1】如果已经拒绝权限，那么就返回 false！</span></span><br><span class="line">    <span class="keyword">if</span> (checkPermission(permissionName, packageName, userId)</span><br><span class="line">            == PackageManager.PERMISSION_GRANTED) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> flags;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> identity = Binder.clearCallingIdentity();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 获得权限的标志位！</span></span><br><span class="line">        flags = getPermissionFlags(permissionName,</span><br><span class="line">                packageName, userId);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Binder.restoreCallingIdentity(identity);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// fixedFlags 包含了所有的被 fix 的情况！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> fixedFlags  = PackageManager.FLAG_PERMISSION_SYSTEM_FIXED</span><br><span class="line">            | PackageManager.FLAG_PERMISSION_POLICY_FIXED</span><br><span class="line">            | PackageManager.FLAG_PERMISSION_USER_FIXED;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】如果该权限被 fix 了，那就返回 false；</span></span><br><span class="line">    <span class="keyword">if</span> ((flags &amp; fixedFlags) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【3】判断权限是否被 user set，如果被用户 set 了，返回 true！</span></span><br><span class="line">    <span class="keyword">return</span> (flags &amp; PackageManager.FLAG_PERMISSION_USER_SET) != <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>policy fix 和 system fix 这些状态都是系统机制的处理！</p>
<p>我们可以看到：</p>
<ul>
<li>如果用户授予了权限，那么该方法返回的是 false；</li>
<li>如果该权限被 system/policy/user fix 了，即用户拒绝了授权，又点击了不再提醒，那返回的是 false；</li>
<li>如果该权限被 user set 了，即用户拒绝了授权，但是没有点击不再提醒，那么会返回 true；</li>
</ul>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2017/08/03/UsageStats 第 4 篇 - UsageStatsService 和其他服务和进程的交互/">UsageStats 第 4 篇 - UsageStatsService 和其他服务和进程的交互</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2017-08-03</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/AndroidFramework源码分析/">AndroidFramework源码分析</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/AndroidFramework源码分析/UsageStats使用状态管理/">UsageStats使用状态管理</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/UsageStats使用状态管理/">UsageStats使用状态管理</a></span><div class="content"><p>[toc]</p>
<p>基于 Android7.1.1 源码分析 UsageStatsService 的架构和原理！</p>
<h1 id="0-综述"><a href="#0-综述" class="headerlink" title="0 综述"></a>0 综述</h1><p>本文主要分析 UsageStatsService 和其他服务 / 进程交互！</p>
<p>我们知道 UsageStatsService 内部有两个类 LocalService 和 BinderService，他们是 UsageStatsService 提供給其他服务或进程的通信接口类！</p>
<ul>
<li><strong>BinderService</strong></li>
</ul>
<p>BinderService 主要用于跨进程调用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">BinderService</span> <span class="keyword">extends</span> <span class="title">IUsageStatsManager</span>.<span class="title">Stub</span> </span>&#123;...&#125;</span><br></pre></td></tr></table></figure>
<p>BinderService 继承了 IUsageStatsManager.Stub，作为服务端桩对象，注册进 ServiceManager！</p>
<p>我们在其他进程中可以通过 UsageStatsManager 来获得客户端代理对象！</p>
<ul>
<li><strong>LocalService</strong></li>
</ul>
<p>LocalService 用于系统进程中的其他服务调用，比如 ActivityManagerService，NotificationManagerService 等服务，下面是一些主要接口的调用逻辑：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">LocalService.reportEvent                 -&gt; UsageStatsService.H.MSG_REPORT_EVENT</span><br><span class="line">LocalService.reportConfigurationChange   -&gt; UsageStatsService.H.MSG_REPORT_EVENT</span><br><span class="line">LocalService.reportShortcutUsage         -&gt; UsageStatsService.H.MSG_REPORT_EVENT</span><br><span class="line">LocalService.reportContentProviderUsage  -&gt; UsageStatsService.H.MSG_REPORT_CONTENT_PROVIDER_USAGE</span><br><span class="line"></span><br><span class="line">LocalService.isAppIdle                   -&gt; UsageStatsService.isAppIdleFiltered</span><br><span class="line">LocalService.getIdleUidsForUser          -&gt; UsageStatsService.getIdleUidsForUse</span><br><span class="line">LocalService.isAppIdleParoleOn           -&gt; UsageStatsService.isParoledOrCharging</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">LocalService.addAppIdleStateChangeListener  -&gt; UsageStatsService.addListener</span><br></pre></td></tr></table></figure>
<p>我们重点关注 LocalService 的逻辑调用！</p>
<h1 id="1-和-UsageStatsService-通信的服务"><a href="#1-和-UsageStatsService-通信的服务" class="headerlink" title="1 和 UsageStatsService 通信的服务"></a>1 和 UsageStatsService 通信的服务</h1><ul>
<li><strong>ActivityManagerService</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mActivityManagerService.setUsageStatsManager(</span><br><span class="line">        LocalServices.getService(UsageStatsManagerInternal.class));</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>NotificationManagerService</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ... ... ...</span><br><span class="line">    mAppUsageStats = LocalServices.getService(UsageStatsManagerInternal.class);</span><br><span class="line">    ... ... ..</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>NetworkPolicyManagerService</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">systemReady</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Trace.traceBegin(Trace.TRACE_TAG_NETWORK, <span class="string">"systemReady"</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!isBandwidthControlEnabled()) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"bandwidth controls disabled, unable to enforce policy"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mUsageStats = LocalServices.getService(UsageStatsManagerInternal.class);</span><br><span class="line">    ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>AppIdleController</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">AppIdleController</span><span class="params">(JobSchedulerService service, Context context, Object lock)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(service, context, lock);</span><br><span class="line">    mJobSchedulerService = service;</span><br><span class="line">    mUsageStatsInternal = LocalServices.getService(UsageStatsManagerInternal.class);</span><br><span class="line">    mAppIdleParoleOn = <span class="keyword">true</span>;</span><br><span class="line">    mUsageStatsInternal.addAppIdleStateChangeListener(<span class="keyword">new</span> AppIdleStateChangeListener());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>主要有以上的服务！</p>
<h1 id="2-ActivityManagerService"><a href="#2-ActivityManagerService" class="headerlink" title="2 ActivityManagerService"></a>2 ActivityManagerService</h1><p>ActivityManagerService 和 UsageStatsService 交互可算是重头戏！</p>
<h2 id="2-1-updateUsageStats"><a href="#2-1-updateUsageStats" class="headerlink" title="2.1 updateUsageStats"></a>2.1 updateUsageStats</h2><p>updateUsageStats 方法用于更新 Activity 的使用信息！</p>
<h3 id="2-1-1-调用时机"><a href="#2-1-1-调用时机" class="headerlink" title="2.1.1 调用时机"></a>2.1.1 调用时机</h3><p>我们来看看调用时机：</p>
<ul>
<li><strong>ActivityStack.startPausingLocked</strong></li>
</ul>
<p>当 activty 进入 paused 状态的时候，会触发 startPausingLocked 方法！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">startPausingLocked</span><span class="params">(<span class="keyword">boolean</span> userLeaving, <span class="keyword">boolean</span> uiSleeping,</span></span></span><br><span class="line"><span class="function"><span class="params">        ActivityRecord resuming, <span class="keyword">boolean</span> dontWait)</span> </span>&#123;</span><br><span class="line">    ... ... ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (prev.app != <span class="keyword">null</span> &amp;&amp; prev.app.thread != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_PAUSE) Slog.v(TAG_PAUSE, <span class="string">"Enqueueing pending pause: "</span> + prev);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            EventLog.writeEvent(EventLogTags.AM_PAUSE_ACTIVITY,</span><br><span class="line">                    prev.userId, System.identityHashCode(prev),</span><br><span class="line">                    prev.shortComponentName);</span><br><span class="line">            <span class="comment">//【2.1.2】记录 activity 组件的 UsageEvents.Event.MOVE_TO_BACKGROUND 事件！</span></span><br><span class="line">            mService.updateUsageStats(prev, <span class="keyword">false</span>);</span><br><span class="line">            <span class="comment">//【1】拉起 activity 的 onPause 方法！</span></span><br><span class="line">            prev.app.thread.schedulePauseActivity(prev.appToken, prev.finishing,</span><br><span class="line">                    userLeaving, prev.configChangeFlags, dontWait);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// Ignore exception, if process died other code will cleanup.</span></span><br><span class="line">            Slog.w(TAG, <span class="string">"Exception thrown during pause"</span>, e);</span><br><span class="line">            mPausingActivity = <span class="keyword">null</span>;</span><br><span class="line">            mLastPausedActivity = <span class="keyword">null</span>;</span><br><span class="line">            mLastNoHistoryActivity = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mPausingActivity = <span class="keyword">null</span>;</span><br><span class="line">        mLastPausedActivity = <span class="keyword">null</span>;</span><br><span class="line">        mLastNoHistoryActivity = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>ActivityStackSupervisor.reportResumedActivityLocked</strong></li>
</ul>
<p>当 activty 进入 resume 状态的时候，会触发 reportResumedActivityLocked 方法！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">reportResumedActivityLocked</span><span class="params">(ActivityRecord r)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ActivityStack stack = r.task.stack;</span><br><span class="line">    <span class="keyword">if</span> (isFocusedStack(stack)) &#123;</span><br><span class="line">        <span class="comment">//【2.1.2】记录 activity 组件的 UsageEvents.Event.MOVE_TO_FOREGROUND 事件！</span></span><br><span class="line">        mService.updateUsageStats(r, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (allResumedActivitiesComplete()) &#123;</span><br><span class="line">        ensureActivitiesVisibleLocked(<span class="keyword">null</span>, <span class="number">0</span>, !PRESERVE_WINDOWS);</span><br><span class="line">        mWindowManager.executeAppTransition();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ul>
<li><strong>ActivityStack.handleAppDiedLocked</strong></li>
</ul>
<p>当 app process 死亡后，会触发 ActivityStack.handleAppDiedLocked 方法！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">handleAppDiedLocked</span><span class="params">(ProcessRecord app)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mPausingActivity != <span class="keyword">null</span> &amp;&amp; mPausingActivity.app == app) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_PAUSE || DEBUG_CLEANUP) Slog.v(TAG_PAUSE,</span><br><span class="line">                <span class="string">"App died while pausing: "</span> + mPausingActivity);</span><br><span class="line">        mPausingActivity = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mLastPausedActivity != <span class="keyword">null</span> &amp;&amp; mLastPausedActivity.app == app) &#123;</span><br><span class="line">        mLastPausedActivity = <span class="keyword">null</span>;</span><br><span class="line">        mLastNoHistoryActivity = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【1】调用自身的 removeHistoryRecordsForAppLocked 方法！</span></span><br><span class="line">    <span class="keyword">return</span> removeHistoryRecordsForAppLocked(app);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>进入 removeHistoryRecordsForAppLocked 方法！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">removeHistoryRecordsForAppLocked</span><span class="params">(ProcessRecord app)</span> </span>&#123;</span><br><span class="line">     ... ... ...</span><br><span class="line">     <span class="keyword">for</span> (<span class="keyword">int</span> taskNdx = mTaskHistory.size() - <span class="number">1</span>; taskNdx &gt;= <span class="number">0</span>; --taskNdx) &#123;</span><br><span class="line">         <span class="keyword">final</span> ArrayList&lt;ActivityRecord&gt; activities = mTaskHistory.get(taskNdx).mActivities;</span><br><span class="line">         <span class="keyword">for</span> (<span class="keyword">int</span> activityNdx = activities.size() - <span class="number">1</span>; activityNdx &gt;= <span class="number">0</span>; --activityNdx) &#123;</span><br><span class="line">             <span class="keyword">final</span> ActivityRecord r = activities.get(activityNdx);</span><br><span class="line">             --i;</span><br><span class="line">             <span class="keyword">if</span> (DEBUG_CLEANUP) Slog.v(TAG_CLEANUP,</span><br><span class="line">                     <span class="string">"Record #"</span> + i + <span class="string">" "</span> + r + <span class="string">": app="</span> + r.app);</span><br><span class="line">             <span class="keyword">if</span> (r.app == app) &#123;</span><br><span class="line">                 <span class="keyword">if</span> (r.visible) &#123;</span><br><span class="line">                     hasVisibleActivities = <span class="keyword">true</span>;</span><br><span class="line">                 &#125;</span><br><span class="line">                 <span class="keyword">final</span> <span class="keyword">boolean</span> remove;</span><br><span class="line">                 ... ... ...</span><br><span class="line">                 <span class="keyword">if</span> (remove) &#123;</span><br><span class="line">                     <span class="keyword">if</span> (DEBUG_ADD_REMOVE || DEBUG_CLEANUP) Slog.i(TAG_ADD_REMOVE,</span><br><span class="line">                             <span class="string">"Removing activity "</span> + r + <span class="string">" from stack at "</span> + i</span><br><span class="line">                             + <span class="string">": haveState="</span> + r.haveState</span><br><span class="line">                             + <span class="string">" stateNotNeeded="</span> + r.stateNotNeeded</span><br><span class="line">                             + <span class="string">" finishing="</span> + r.finishing</span><br><span class="line">                             + <span class="string">" state="</span> + r.state + <span class="string">" callers="</span> + Debug.getCallers(<span class="number">5</span>));</span><br><span class="line">                     <span class="keyword">if</span> (!r.finishing) &#123;</span><br><span class="line">                         Slog.w(TAG, <span class="string">"Force removing "</span> + r + <span class="string">": app died, no saved state"</span>);</span><br><span class="line">                         EventLog.writeEvent(EventLogTags.AM_FINISH_ACTIVITY,</span><br><span class="line">                                 r.userId, System.identityHashCode(r),</span><br><span class="line">                                 r.task.taskId, r.shortComponentName,</span><br><span class="line">                                 <span class="string">"proc died without state saved"</span>);</span><br><span class="line">                         <span class="keyword">if</span> (r.state == ActivityState.RESUMED) &#123;</span><br><span class="line">                             <span class="comment">//【2.2.2】如果 activity 处于 resume 状态，记录状态！</span></span><br><span class="line">                             mService.updateUsageStats(r, <span class="keyword">false</span>);</span><br><span class="line">                         &#125;</span><br><span class="line">                     &#125;</span><br><span class="line">                 &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                     ... ... ..</span><br><span class="line">                 &#125;</span><br><span class="line">                 ... ... ...</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">return</span> hasVisibleActivities;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>逻辑很简单，不多说！</p>
<h3 id="2-1-2-方法流程分析"><a href="#2-1-2-方法流程分析" class="headerlink" title="2.1.2 方法流程分析"></a>2.1.2 方法流程分析</h3><p>参数 boolean resumed 表示是否处于 resume 状态！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">updateUsageStats</span><span class="params">(ActivityRecord component, <span class="keyword">boolean</span> resumed)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_SWITCH) Slog.d(TAG_SWITCH,</span><br><span class="line">            <span class="string">"updateUsageStats: comp="</span> + component + <span class="string">"res="</span> + resumed);</span><br><span class="line">    <span class="keyword">final</span> BatteryStatsImpl stats = mBatteryStatsService.getActiveStatistics();</span><br><span class="line">    <span class="keyword">if</span> (resumed) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mUsageStatsService != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//【2.1.3】如果是 resume 状态，记录 UsageEvents.Event.MOVE_TO_FOREGROUND 事件！</span></span><br><span class="line">            mUsageStatsService.reportEvent(component.realActivity, component.userId,</span><br><span class="line">                    UsageEvents.Event.MOVE_TO_FOREGROUND);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">synchronized</span> (stats) &#123;</span><br><span class="line">            stats.noteActivityResumedLocked(component.app.uid);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mUsageStatsService != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//【2.1.3】如果不是 resume 状态，记录 UsageEvents.Event.MOVE_TO_BACKGROUND 事件！</span></span><br><span class="line">            mUsageStatsService.reportEvent(component.realActivity, component.userId,</span><br><span class="line">                    UsageEvents.Event.MOVE_TO_BACKGROUND);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">synchronized</span> (stats) &#123;</span><br><span class="line">            stats.noteActivityPausedLocked(component.app.uid);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不多说了！</p>
<h3 id="2-1-3-LocalService-reportEvent"><a href="#2-1-3-LocalService-reportEvent" class="headerlink" title="2.1.3 LocalService.reportEvent"></a>2.1.3 LocalService.reportEvent</h3><p>这里最终调用了 reportEvent 方法，传入的 ComponentName component 为 Activity！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reportEvent</span><span class="params">(ComponentName component, <span class="keyword">int</span> userId, <span class="keyword">int</span> eventType)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (component == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Event reported without a component name"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    UsageEvents.Event event = <span class="keyword">new</span> UsageEvents.Event();</span><br><span class="line">    event.mPackage = component.getPackageName();</span><br><span class="line">    event.mClass = component.getClassName();</span><br><span class="line"></span><br><span class="line">    event.mTimeStamp = SystemClock.elapsedRealtime();</span><br><span class="line"></span><br><span class="line">    event.mEventType = eventType;</span><br><span class="line">    <span class="comment">//【1】发送了 MSG_REPORT_EVENT 消息！</span></span><br><span class="line">    mHandler.obtainMessage(MSG_REPORT_EVENT, userId, <span class="number">0</span>, event).sendToTarget();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>不多说了！</p>
<h2 id="2-2-updateConfigurationLocked"><a href="#2-2-updateConfigurationLocked" class="headerlink" title="2.2 updateConfigurationLocked"></a>2.2 updateConfigurationLocked</h2><h3 id="2-2-1-调用时机"><a href="#2-2-1-调用时机" class="headerlink" title="2.2.1 调用时机"></a>2.2.1 调用时机</h3><p>主要是和 Configuration 配置更新相关的内容，调用地方过多，这里先不列出！</p>
<h3 id="2-2-2-方法流程分析"><a href="#2-2-2-方法流程分析" class="headerlink" title="2.2.2 方法流程分析"></a>2.2.2 方法流程分析</h3><p>和 updateConfigurationLocked 相关的有多个重载函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateConfiguration</span><span class="params">(Configuration values)</span> </span>&#123;</span><br><span class="line">    enforceCallingPermission(android.Manifest.permission.CHANGE_CONFIGURATION,</span><br><span class="line">            <span class="string">"updateConfiguration()"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (values == <span class="keyword">null</span> &amp;&amp; mWindowManager != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// sentinel: fetch the current configuration from the window manager</span></span><br><span class="line">            values = mWindowManager.computeNewConfiguration();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mWindowManager != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mProcessList.applyDisplaySize(mWindowManager);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> origId = Binder.clearCallingIdentity();</span><br><span class="line">        <span class="keyword">if</span> (values != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Settings.System.clearConfiguration(values);</span><br><span class="line">        &#125;</span><br><span class="line">        updateConfigurationLocked(values, <span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">        Binder.restoreCallingIdentity(origId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">updateUserConfigurationLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Configuration configuration = <span class="keyword">new</span> Configuration(mConfiguration);</span><br><span class="line">    Settings.System.adjustConfigurationForUser(mContext.getContentResolver(), configuration,</span><br><span class="line">            mUserController.getCurrentUserIdLocked(), Settings.System.canWrite(mContext));</span><br><span class="line">    updateConfigurationLocked(configuration, <span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">updateConfigurationLocked</span><span class="params">(Configuration values, ActivityRecord starting,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> initLocale)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> updateConfigurationLocked(values, starting, initLocale, <span class="keyword">false</span> <span class="comment">/* deferResume */</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">updateConfigurationLocked</span><span class="params">(Configuration values, ActivityRecord starting,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> initLocale, <span class="keyword">boolean</span> deferResume)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// pass UserHandle.USER_NULL as userId because we don't persist configuration for any user</span></span><br><span class="line">    <span class="keyword">return</span> updateConfigurationLocked(values, starting, initLocale, <span class="keyword">false</span> <span class="comment">/* persistent */</span>,</span><br><span class="line">            UserHandle.USER_NULL, deferResume);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>updateConfigurationLocked 方法用于更新指定 activity 的 Configuration 属性，主要有两个作用：</p>
<ul>
<li>改变当前的配置；</li>
<li>确保指定的 activity 使用的是当前最新的 activity；</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">updateConfigurationLocked</span><span class="params">(Configuration values, ActivityRecord starting,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> initLocale, <span class="keyword">boolean</span> persistent, <span class="keyword">int</span> userId, <span class="keyword">boolean</span> deferResume)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> changes = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//【1】停止布局！</span></span><br><span class="line">    <span class="keyword">if</span> (mWindowManager != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mWindowManager.deferSurfaceLayout();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】处理配置变化！</span></span><br><span class="line">    <span class="keyword">if</span> (values != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//【2.1】获得旧配置的拷贝；</span></span><br><span class="line">        Configuration newConfig = <span class="keyword">new</span> Configuration(mConfiguration);</span><br><span class="line">        <span class="comment">//【2.2】获得配置的更新信息！</span></span><br><span class="line">        changes = newConfig.updateFrom(values);</span><br><span class="line">        <span class="keyword">if</span> (changes != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_SWITCH || DEBUG_CONFIGURATION) Slog.i(TAG_CONFIGURATION,</span><br><span class="line">                    <span class="string">"Updating configuration to: "</span> + values);</span><br><span class="line"></span><br><span class="line">            EventLog.writeEvent(EventLogTags.CONFIGURATION_CHANGED, changes);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//【2.3】处理多语言的更新！</span></span><br><span class="line">            <span class="keyword">if</span> (!initLocale &amp;&amp; !values.getLocales().isEmpty() &amp;&amp; values.userSetLocale) &#123;</span><br><span class="line">                <span class="keyword">final</span> LocaleList locales = values.getLocales();</span><br><span class="line">                <span class="keyword">int</span> bestLocaleIndex = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">if</span> (locales.size() &gt; <span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (mSupportedSystemLocales == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        mSupportedSystemLocales =</span><br><span class="line">                                Resources.getSystem().getAssets().getLocales();</span><br><span class="line">                    &#125;</span><br><span class="line">                    bestLocaleIndex = Math.max(<span class="number">0</span>,</span><br><span class="line">                            locales.getFirstMatchIndex(mSupportedSystemLocales));</span><br><span class="line">                &#125;</span><br><span class="line">                SystemProperties.set(<span class="string">"persist.sys.locale"</span>,</span><br><span class="line">                        locales.get(bestLocaleIndex).toLanguageTag());</span><br><span class="line">                LocaleList.setDefault(locales, bestLocaleIndex);</span><br><span class="line">                mHandler.sendMessage(mHandler.obtainMessage(SEND_LOCALE_TO_MOUNT_DAEMON_MSG,</span><br><span class="line">                        locales.get(bestLocaleIndex)));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【2.4】计算本次更新的序列号；</span></span><br><span class="line">            mConfigurationSeq++;</span><br><span class="line">            <span class="keyword">if</span> (mConfigurationSeq &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                mConfigurationSeq = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【2.5】更新配置引用对象！</span></span><br><span class="line">            newConfig.seq = mConfigurationSeq;</span><br><span class="line">            mConfiguration = newConfig;</span><br><span class="line">            Slog.i(TAG, <span class="string">"Config changes="</span> + Integer.toHexString(changes) + <span class="string">" "</span> + newConfig);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//【×2.2.3】调用 reportConfigurationChange 方法！</span></span><br><span class="line">            mUsageStatsService.reportConfigurationChange(newConfig,</span><br><span class="line">                    mUserController.getCurrentUserIdLocked());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> Configuration configCopy = <span class="keyword">new</span> Configuration(mConfiguration);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> If our config changes, should we auto dismiss any currently</span></span><br><span class="line">            <span class="comment">// showing dialogs?</span></span><br><span class="line">            mShowDialogs = shouldShowDialogs(newConfig, mInVrMode);</span><br><span class="line"></span><br><span class="line">            AttributeCache ac = AttributeCache.instance();</span><br><span class="line">            <span class="keyword">if</span> (ac != <span class="keyword">null</span>) &#123;</span><br><span class="line">                ac.updateConfiguration(configCopy);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【2.6】更新资源配置！</span></span><br><span class="line">            mSystemThread.applyConfigurationToResources(configCopy);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (persistent &amp;&amp; Settings.System.hasInterestingConfigurationChanges(changes)) &#123;</span><br><span class="line">                Message msg = mHandler.obtainMessage(UPDATE_CONFIGURATION_MSG);</span><br><span class="line">                msg.obj = <span class="keyword">new</span> Configuration(configCopy);</span><br><span class="line">                msg.arg1 = userId;</span><br><span class="line">                mHandler.sendMessage(msg);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【2.7】调整屏幕密度改变</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> isDensityChange = (changes &amp; ActivityInfo.CONFIG_DENSITY) != <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> (isDensityChange) &#123;</span><br><span class="line">                <span class="comment">// Reset the unsupported display size dialog.</span></span><br><span class="line">                mUiHandler.sendEmptyMessage(SHOW_UNSUPPORTED_DISPLAY_SIZE_DIALOG_MSG);</span><br><span class="line"></span><br><span class="line">                killAllBackgroundProcessesExcept(Build.VERSION_CODES.N,</span><br><span class="line">                        ActivityManager.PROCESS_STATE_FOREGROUND_SERVICE);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【2.8】修改进程的配置信息！</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=mLruProcesses.size()-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</span><br><span class="line">                ProcessRecord app = mLruProcesses.get(i);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (app.thread != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (DEBUG_CONFIGURATION) Slog.v(TAG_CONFIGURATION, <span class="string">"Sending to proc "</span></span><br><span class="line">                                + app.processName + <span class="string">" new config "</span> + mConfiguration);</span><br><span class="line">                        app.thread.scheduleConfigurationChanged(configCopy);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【2.9】发送配置改变的广播！</span></span><br><span class="line">            Intent intent = <span class="keyword">new</span> Intent(Intent.ACTION_CONFIGURATION_CHANGED);</span><br><span class="line">            intent.addFlags(Intent.FLAG_RECEIVER_REGISTERED_ONLY</span><br><span class="line">                    | Intent.FLAG_RECEIVER_REPLACE_PENDING</span><br><span class="line">                    | Intent.FLAG_RECEIVER_FOREGROUND);</span><br><span class="line">            broadcastIntentLocked(<span class="keyword">null</span>, <span class="keyword">null</span>, intent, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="number">0</span>, <span class="keyword">null</span>, <span class="keyword">null</span>,</span><br><span class="line">                    <span class="keyword">null</span>, AppOpsManager.OP_NONE, <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">false</span>,</span><br><span class="line">                    MY_PID, Process.SYSTEM_UID, UserHandle.USER_ALL);</span><br><span class="line">            <span class="keyword">if</span> ((changes&amp;ActivityInfo.CONFIG_LOCALE) != <span class="number">0</span>) &#123;</span><br><span class="line">                intent = <span class="keyword">new</span> Intent(Intent.ACTION_LOCALE_CHANGED);</span><br><span class="line">                intent.addFlags(Intent.FLAG_RECEIVER_FOREGROUND);</span><br><span class="line">         <span class="keyword">if</span> (initLocale || !mProcessesReady) &#123;</span><br><span class="line">                    intent.addFlags(Intent.FLAG_RECEIVER_REGISTERED_ONLY);</span><br><span class="line">                &#125;</span><br><span class="line">                broadcastIntentLocked(<span class="keyword">null</span>, <span class="keyword">null</span>, intent,</span><br><span class="line">                        <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="number">0</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, AppOpsManager.OP_NONE,</span><br><span class="line">                        <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, MY_PID, Process.SYSTEM_UID, UserHandle.USER_ALL);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2.10】更新 wms 中的配置信息，并且检查在更新了配置后，是否有 stack 需要被 resize；</span></span><br><span class="line">        <span class="comment">// 如果有的话，那就进行 resize 和 relaunch！</span></span><br><span class="line">        <span class="keyword">if</span> (mWindowManager != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span>[] resizedStacks = mWindowManager.setNewConfiguration(mConfiguration);</span><br><span class="line">            <span class="keyword">if</span> (resizedStacks != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> stackId : resizedStacks) &#123;</span><br><span class="line">                    <span class="keyword">final</span> Rect newBounds = mWindowManager.getBoundsForNewConfiguration(stackId);</span><br><span class="line">                    mStackSupervisor.resizeStackLocked(</span><br><span class="line">                            stackId, newBounds, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, deferResume);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> kept = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">final</span> ActivityStack mainStack = mStackSupervisor.getFocusedStack();</span><br><span class="line">    <span class="comment">//【4】获得焦点栈，调整 top activity 的配置信息！</span></span><br><span class="line">    <span class="comment">// mainStack is null during startup.</span></span><br><span class="line">    <span class="keyword">if</span> (mainStack != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (changes != <span class="number">0</span> &amp;&amp; starting == <span class="keyword">null</span>) &#123;</span><br><span class="line">            starting = mainStack.topRunningActivityLocked();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (starting != <span class="keyword">null</span>) &#123;</span><br><span class="line">            kept = mainStack.ensureActivityConfigurationLocked(starting, changes, <span class="keyword">false</span>);</span><br><span class="line">            mStackSupervisor.ensureActivitiesVisibleLocked(starting, changes,</span><br><span class="line">                    !PRESERVE_WINDOWS);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【5】继续布局！</span></span><br><span class="line">    <span class="keyword">if</span> (mWindowManager != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mWindowManager.continueSurfaceLayout();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> kept;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里调用了 UsageStatsService.reportConfigurationChange 方法，更新配置信息！</p>
<h3 id="2-2-3-LocalService-updateConfigurationLocked"><a href="#2-2-3-LocalService-updateConfigurationLocked" class="headerlink" title="2.2.3 LocalService.updateConfigurationLocked"></a>2.2.3 LocalService.updateConfigurationLocked</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reportConfigurationChange</span><span class="params">(Configuration config, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (config == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Configuration event reported with a null config"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    UsageEvents.Event event = <span class="keyword">new</span> UsageEvents.Event();</span><br><span class="line">    event.mPackage = <span class="string">"android"</span>;</span><br><span class="line"></span><br><span class="line">    event.mTimeStamp = SystemClock.elapsedRealtime();</span><br><span class="line"></span><br><span class="line">    event.mEventType = UsageEvents.Event.CONFIGURATION_CHANGE;</span><br><span class="line">    event.mConfiguration = <span class="keyword">new</span> Configuration(config);</span><br><span class="line">    mHandler.obtainMessage(MSG_REPORT_EVENT, userId, <span class="number">0</span>, event).sendToTarget();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于 config 相关的 event 来说，目标包名是 android！</p>
<h2 id="2-3-maybeUpdateProviderUsageStatsLocked"><a href="#2-3-maybeUpdateProviderUsageStatsLocked" class="headerlink" title="2.3 maybeUpdateProviderUsageStatsLocked"></a>2.3 maybeUpdateProviderUsageStatsLocked</h2><h3 id="2-3-1-调用时机"><a href="#2-3-1-调用时机" class="headerlink" title="2.3.1 调用时机"></a>2.3.1 调用时机</h3><ul>
<li><strong>ActivityManagerService.publishContentProviders</strong></li>
</ul>
<p>当注册 ContentProvider 的时候，会触发 publishContentProviders 方法！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">publishContentProviders</span><span class="params">(IApplicationThread caller,</span></span></span><br><span class="line"><span class="function"><span class="params">        List&lt;ContentProviderHolder&gt; providers)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (providers == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    enforceNotIsolatedCaller(<span class="string">"publishContentProviders"</span>);</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> ProcessRecord r = getRecordForAppLocked(caller);</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_MU) Slog.v(TAG_MU, <span class="string">"ProcessRecord uid = "</span> + r.uid);</span><br><span class="line">        <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(</span><br><span class="line">                    <span class="string">"Unable to find app for caller "</span> + caller</span><br><span class="line">                  + <span class="string">" (pid="</span> + Binder.getCallingPid()</span><br><span class="line">                  + <span class="string">") when publishing content providers"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> origId = Binder.clearCallingIdentity();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> N = providers.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">            ContentProviderHolder src = providers.get(i);</span><br><span class="line">                ... ... ...</span><br><span class="line">                updateOomAdjLocked(r);</span><br><span class="line">                <span class="comment">//【2.3.2】调用 maybeUpdateProviderUsageStatsLocked 方法，记录 ContentProvider 使用信息！</span></span><br><span class="line">                maybeUpdateProviderUsageStatsLocked(r, src.info.packageName,</span><br><span class="line">                        src.info.authority);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Binder.restoreCallingIdentity(origId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>ActivityManagerService.getContentProviderImpl</strong></li>
</ul>
<p>当获得 ContentProvider 的时候，会触发 getContentProviderImpl 方法！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> ContentProviderHolder <span class="title">getContentProviderImpl</span><span class="params">(IApplicationThread caller,</span></span></span><br><span class="line"><span class="function"><span class="params">        String name, IBinder token, <span class="keyword">boolean</span> stable, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    ContentProviderRecord cpr;</span><br><span class="line">    ContentProviderConnection conn = <span class="keyword">null</span>;</span><br><span class="line">    ProviderInfo cpi = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">long</span> startTime = SystemClock.uptimeMillis();</span><br><span class="line">        </span><br><span class="line">        ... ... ...</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">boolean</span> providerRunning = cpr != <span class="keyword">null</span> &amp;&amp; cpr.proc != <span class="keyword">null</span> &amp;&amp; !cpr.proc.killed;</span><br><span class="line">        <span class="keyword">if</span> (providerRunning) &#123;</span><br><span class="line">            cpi = cpr.info;</span><br><span class="line">            String msg;</span><br><span class="line">            checkTime(startTime, <span class="string">"getContentProviderImpl: before checkContentProviderPermission"</span>);</span><br><span class="line">            <span class="keyword">if</span> ((msg = checkContentProviderPermissionLocked(cpi, r, userId, checkCrossUser))</span><br><span class="line">                    != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(msg);</span><br><span class="line">            &#125;</span><br><span class="line">            checkTime(startTime, <span class="string">"getContentProviderImpl: after checkContentProviderPermission"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (r != <span class="keyword">null</span> &amp;&amp; cpr.canRunHere(r)) &#123;</span><br><span class="line">                ContentProviderHolder holder = cpr.newHolder(<span class="keyword">null</span>);</span><br><span class="line">                holder.provider = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">return</span> holder;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> origId = Binder.clearCallingIdentity();</span><br><span class="line"></span><br><span class="line">            checkTime(startTime, <span class="string">"getContentProviderImpl: incProviderCountLocked"</span>);</span><br><span class="line"></span><br><span class="line">            conn = incProviderCountLocked(r, cpr, token, stable);</span><br><span class="line">            <span class="keyword">if</span> (conn != <span class="keyword">null</span> &amp;&amp; (conn.stableCount+conn.unstableCount) == <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (cpr.proc != <span class="keyword">null</span> &amp;&amp; r.setAdj &lt;= ProcessList.PERCEPTIBLE_APP_ADJ) &#123;</span><br><span class="line">                    checkTime(startTime, <span class="string">"getContentProviderImpl: before updateLruProcess"</span>);</span><br><span class="line">                    updateLruProcessLocked(cpr.proc, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">                    checkTime(startTime, <span class="string">"getContentProviderImpl: after updateLruProcess"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            checkTime(startTime, <span class="string">"getContentProviderImpl: before updateOomAdj"</span>);</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> verifiedAdj = cpr.proc.verifiedAdj;</span><br><span class="line">            <span class="keyword">boolean</span> success = updateOomAdjLocked(cpr.proc);</span><br><span class="line">            <span class="keyword">if</span> (success &amp;&amp; verifiedAdj != cpr.proc.setAdj &amp;&amp; !isProcessAliveLocked(cpr.proc)) &#123;</span><br><span class="line">                success = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【2.2.2】调用 maybeUpdateProviderUsageStatsLocked 方法再次记录！</span></span><br><span class="line">            maybeUpdateProviderUsageStatsLocked(r, cpr.info.packageName, name);</span><br><span class="line">            checkTime(startTime, <span class="string">"getContentProviderImpl: after updateOomAdj"</span>);</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_PROVIDER) Slog.i(TAG_PROVIDER, <span class="string">"Adjust success: "</span> + success);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">                Slog.i(TAG, <span class="string">"Existing provider "</span> + cpr.name.flattenToShortString()</span><br><span class="line">                        + <span class="string">" is crashing; detaching "</span> + r);</span><br><span class="line">                <span class="keyword">boolean</span> lastRef = decProviderCountLocked(conn, cpr, token, stable);</span><br><span class="line">                checkTime(startTime, <span class="string">"getContentProviderImpl: before appDied"</span>);</span><br><span class="line">                appDiedLocked(cpr.proc);</span><br><span class="line">                checkTime(startTime, <span class="string">"getContentProviderImpl: after appDied"</span>);</span><br><span class="line">                <span class="keyword">if</span> (!lastRef) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                providerRunning = <span class="keyword">false</span>;</span><br><span class="line">                conn = <span class="keyword">null</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                cpr.proc.verifiedAdj = cpr.proc.setAdj;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Binder.restoreCallingIdentity(origId);</span><br><span class="line">        &#125;</span><br><span class="line">        ... ... ...</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> cpr != <span class="keyword">null</span> ? cpr.newHolder(conn) : <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>对于 getContentProviderImpl 这里我们不再过多分析！</p>
<h3 id="2-3-2-方法流程分析"><a href="#2-3-2-方法流程分析" class="headerlink" title="2.3.2 方法流程分析"></a>2.3.2 方法流程分析</h3><p>maybeUpdateProviderUsageStatsLocked 方法中会进行事件上报！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">maybeUpdateProviderUsageStatsLocked</span><span class="params">(ProcessRecord app, String providerPkgName,</span></span></span><br><span class="line"><span class="function"><span class="params">        String authority)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (app == <span class="keyword">null</span>) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span> (app.curProcState &lt;= ActivityManager.PROCESS_STATE_IMPORTANT_FOREGROUND) &#123;</span><br><span class="line">        UserState userState = mUserController.getStartedUserStateLocked(app.userId);</span><br><span class="line">        <span class="keyword">if</span> (userState == <span class="keyword">null</span>) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> now = SystemClock.elapsedRealtime();</span><br><span class="line">        Long lastReported = userState.mProviderLastReportedFg.get(authority);</span><br><span class="line">        <span class="keyword">if</span> (lastReported == <span class="keyword">null</span> || lastReported &lt; now - <span class="number">60</span> * <span class="number">1000L</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mSystemReady) &#123;</span><br><span class="line">                <span class="comment">//【2.3.3】调用了 reportContentProviderUsage 方法！</span></span><br><span class="line">                mUsageStatsService.reportContentProviderUsage(</span><br><span class="line">                        authority, providerPkgName, app.userId);</span><br><span class="line">            &#125;</span><br><span class="line">            userState.mProviderLastReportedFg.put(authority, now);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="2-3-3-LocalService-reportContentProviderUsage"><a href="#2-3-3-LocalService-reportContentProviderUsage" class="headerlink" title="2.3.3 LocalService.reportContentProviderUsage"></a>2.3.3 LocalService.reportContentProviderUsage</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reportContentProviderUsage</span><span class="params">(String name, String packageName, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    SomeArgs args = SomeArgs.obtain();</span><br><span class="line">    args.arg1 = name;</span><br><span class="line">    args.arg2 = packageName;</span><br><span class="line">    args.arg3 = userId;</span><br><span class="line">    <span class="comment">//【1】发送了 MSG_REPORT_CONTENT_PROVIDER_USAGE 消息！</span></span><br><span class="line">    mHandler.obtainMessage(MSG_REPORT_CONTENT_PROVIDER_USAGE, args)</span><br><span class="line">            .sendToTarget();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不多说了！</p>
<h2 id="2-4-maybeUpdateUsageStatsLocked"><a href="#2-4-maybeUpdateUsageStatsLocked" class="headerlink" title="2.4 maybeUpdateUsageStatsLocked"></a>2.4 maybeUpdateUsageStatsLocked</h2><h3 id="2-4-1-调用时机"><a href="#2-4-1-调用时机" class="headerlink" title="2.4.1 调用时机"></a>2.4.1 调用时机</h3><ul>
<li><strong>ActivityManagerService.applyOomAdjLocked</strong></li>
</ul>
<p>在调整进程的 oomAdj 的时候，会触发 maybeUpdateUsageStatsLocked！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">applyOomAdjLocked</span><span class="params">(ProcessRecord app, <span class="keyword">boolean</span> doingAll, <span class="keyword">long</span> now,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">long</span> nowElapsed)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> success = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (app.curRawAdj != app.setRawAdj) &#123;</span><br><span class="line">        app.setRawAdj = app.curRawAdj;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> changes = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (app.curAdj != app.setAdj) &#123;</span><br><span class="line">        ProcessList.setOomAdj(app.pid, app.info.uid, app.curAdj);</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_SWITCH || DEBUG_OOM_ADJ) Slog.v(TAG_OOM_ADJ,</span><br><span class="line">                <span class="string">"Set "</span> + app.pid + <span class="string">" "</span> + app.processName + <span class="string">" adj "</span> + app.curAdj + <span class="string">": "</span></span><br><span class="line">                + app.adjType);</span><br><span class="line">        app.setAdj = app.curAdj;</span><br><span class="line">        app.verifiedAdj = ProcessList.INVALID_ADJ;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ... ... ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】当进程的 ProcState 发生了变化是，进入 IF 分支！</span></span><br><span class="line">    <span class="keyword">if</span> (app.setProcState != app.curProcState) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_SWITCH || DEBUG_OOM_ADJ) Slog.v(TAG_OOM_ADJ,</span><br><span class="line">                <span class="string">"Proc state change of "</span> + app.processName</span><br><span class="line">                        + <span class="string">" to "</span> + app.curProcState);</span><br><span class="line">        <span class="keyword">boolean</span> setImportant = app.setProcState &lt; ActivityManager.PROCESS_STATE_SERVICE;</span><br><span class="line">        <span class="keyword">boolean</span> curImportant = app.curProcState &lt; ActivityManager.PROCESS_STATE_SERVICE;</span><br><span class="line">        <span class="keyword">if</span> (setImportant &amp;&amp; !curImportant) &#123;</span><br><span class="line">            BatteryStatsImpl stats = mBatteryStatsService.getActiveStatistics();</span><br><span class="line">            <span class="keyword">synchronized</span> (stats) &#123;</span><br><span class="line">                app.lastWakeTime = stats.getProcessWakeTime(app.info.uid,</span><br><span class="line">                        app.pid, nowElapsed);</span><br><span class="line">            &#125;</span><br><span class="line">            app.lastCpuTime = app.curCpuTime;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2.4.1】在更新进程的状态之前，调用 maybeUpdateUsageStatsLocked 方法</span></span><br><span class="line">        <span class="comment">// 记录进程的信息！</span></span><br><span class="line">        maybeUpdateUsageStatsLocked(app, nowElapsed);</span><br><span class="line"></span><br><span class="line">        app.setProcState = app.curProcState;</span><br><span class="line">        <span class="keyword">if</span> (app.setProcState &gt;= ActivityManager.PROCESS_STATE_HOME) &#123;</span><br><span class="line">            app.notCachedSinceIdle = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!doingAll) &#123;</span><br><span class="line">            setProcessTrackerStateLocked(app, mProcessStats.getMemFactorLocked(), now);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            app.procStateChanged = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (app.reportedInteraction &amp;&amp; (nowElapsed-app.interactionEventTime)</span><br><span class="line">            &gt; USAGE_STATS_INTERACTION_INTERVAL) &#123;</span><br><span class="line">        <span class="comment">//【2.4.1】对于长期处于互动状态的应用，我们需要每天至少报告一次，以免它们进入 idle 状态。</span></span><br><span class="line">        maybeUpdateUsageStatsLocked(app, nowElapsed);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ... ... ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> success;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里调用了 maybeUpdateUsageStatsLocked 方法！</p>
<h3 id="2-4-2-方法流程分析"><a href="#2-4-2-方法流程分析" class="headerlink" title="2.4.2 方法流程分析"></a>2.4.2 方法流程分析</h3><p>下面我们来看看 maybeUpdateUsageStatsLocked 方法流程：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">maybeUpdateUsageStatsLocked</span><span class="params">(ProcessRecord app, <span class="keyword">long</span> nowElapsed)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_USAGE_STATS) &#123;</span><br><span class="line">        Slog.d(TAG, <span class="string">"Checking proc ["</span> + Arrays.toString(app.getPackageList())</span><br><span class="line">                + <span class="string">"] state changes: old = "</span> + app.setProcState + <span class="string">", new = "</span></span><br><span class="line">                + app.curProcState);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mUsageStatsService == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【1】判断此时进程是否处于交互中！        </span></span><br><span class="line">    <span class="keyword">boolean</span> isInteraction;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (app.curProcState &lt;= ActivityManager.PROCESS_STATE_BOUND_FOREGROUND_SERVICE) &#123;</span><br><span class="line">        <span class="comment">//【2】如果进程的 curProcState 小于等于 PROCESS_STATE_BOUND_FOREGROUND_SERVICE: 3</span></span><br><span class="line">        <span class="comment">// 此时是处于交互状态的！</span></span><br><span class="line">        isInteraction = <span class="keyword">true</span>;</span><br><span class="line">        app.fgInteractionTime = <span class="number">0</span>;</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (app.curProcState &lt;= ActivityManager.PROCESS_STATE_TOP_SLEEPING) &#123;</span><br><span class="line">        <span class="comment">//【3】如果进程的 curProcState 小于等于 PROCESS_STATE_TOP_SLEEPING: 5</span></span><br><span class="line">        <span class="comment">// 进入这里！！</span></span><br><span class="line">        <span class="keyword">if</span> (app.fgInteractionTime == <span class="number">0</span>) &#123;</span><br><span class="line">            app.fgInteractionTime = nowElapsed;</span><br><span class="line">            isInteraction = <span class="keyword">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            isInteraction = nowElapsed &gt; app.fgInteractionTime + SERVICE_USAGE_INTERACTION_TIME;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//【4】如果 app.forcingToForeground 为 null，并且进程的 curProcState </span></span><br><span class="line">        <span class="comment">// 小于等于 PROCESS_STATE_IMPORTANT_FOREGROUND:6 说明该进程是可以被感知的重要进程！</span></span><br><span class="line">        <span class="comment">// isInteraction 为 true！</span></span><br><span class="line">        isInteraction = app.forcingToForeground == <span class="keyword">null</span></span><br><span class="line">                &amp;&amp; app.curProcState &lt;= ActivityManager.PROCESS_STATE_IMPORTANT_FOREGROUND;</span><br><span class="line">        app.fgInteractionTime = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【5】如果本次进程是处于交互状态，并且上次是处于非交互状态（或者此时距离上次交互时间点超过了交互间隔）</span></span><br><span class="line">    <span class="comment">// 那么我们会上报一次记录！</span></span><br><span class="line">    <span class="keyword">if</span> (isInteraction &amp;&amp; (!app.reportedInteraction</span><br><span class="line">            || (nowElapsed-app.interactionEventTime) &gt; USAGE_STATS_INTERACTION_INTERVAL)) &#123;</span><br><span class="line">        app.interactionEventTime = nowElapsed;</span><br><span class="line">        String[] packages = app.getPackageList();</span><br><span class="line">        <span class="keyword">if</span> (packages != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; packages.length; i++) &#123;</span><br><span class="line">                <span class="comment">//【5.1】调用了 reportEvent 方法，更新进程中所有 pacakge 的使用信息</span></span><br><span class="line">                <span class="comment">// event 类型为 SYSTEM_INTERACTION！</span></span><br><span class="line">                mUsageStatsService.reportEvent(packages[i], app.userId,</span><br><span class="line">                        UsageEvents.Event.SYSTEM_INTERACTION);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【6】更新 app.reportedInteraction 和 app.interactionEventTime！</span></span><br><span class="line">    app.reportedInteraction = isInteraction;</span><br><span class="line">    <span class="keyword">if</span> (!isInteraction) &#123;</span><br><span class="line">        app.interactionEventTime = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最终调用了 UsageStatsService.reportEvent 方法！</p>
<h3 id="2-4-3-LocalService-reportEvent"><a href="#2-4-3-LocalService-reportEvent" class="headerlink" title="2.4.3 LocalService.reportEvent"></a>2.4.3 LocalService.reportEvent</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reportEvent</span><span class="params">(String packageName, <span class="keyword">int</span> userId, <span class="keyword">int</span> eventType)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (packageName == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Event reported without a package name"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    UsageEvents.Event event = <span class="keyword">new</span> UsageEvents.Event();</span><br><span class="line">    event.mPackage = packageName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This will later be converted to system time.</span></span><br><span class="line">    event.mTimeStamp = SystemClock.elapsedRealtime();</span><br><span class="line"></span><br><span class="line">    event.mEventType = eventType;</span><br><span class="line">    mHandler.obtainMessage(MSG_REPORT_EVENT, userId, <span class="number">0</span>, event).sendToTarget();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-5-shutdown"><a href="#2-5-shutdown" class="headerlink" title="2.5 shutdown"></a>2.5 shutdown</h2><p>shutdown 主要用关机时候，保存重要的信息！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">shutdown</span><span class="params">(<span class="keyword">int</span> timeout)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (checkCallingPermission(android.Manifest.permission.SHUTDOWN)</span><br><span class="line">            != PackageManager.PERMISSION_GRANTED) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"Requires permission "</span></span><br><span class="line">                + android.Manifest.permission.SHUTDOWN);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> timedout = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">        mShuttingDown = <span class="keyword">true</span>;</span><br><span class="line">        updateEventDispatchingLocked();</span><br><span class="line">        timedout = mStackSupervisor.shutdownLocked(timeout);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mAppOpsService.shutdown();</span><br><span class="line">    <span class="keyword">if</span> (mUsageStatsService != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//【1】调用 UsageStatsService 的 prepareShutdown 方法！</span></span><br><span class="line">        mUsageStatsService.prepareShutdown();</span><br><span class="line">    &#125;</span><br><span class="line">    mBatteryStatsService.shutdown();</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        mProcessStats.shutdownLocked();</span><br><span class="line">        notifyTaskPersisterLocked(<span class="keyword">null</span>, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> timedout;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个逻辑不多说了！</p>
<h1 id="3-NotificationManagerService"><a href="#3-NotificationManagerService" class="headerlink" title="3 NotificationManagerService"></a>3 NotificationManagerService</h1><p>我们来看看 NotificationManagerService 和 UsageStatsService 的通信：</p>
<h2 id="3-1-onStart"><a href="#3-1-onStart" class="headerlink" title="3.1 onStart"></a>3.1 onStart</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     Resources resources = getContext().getResources();</span><br><span class="line"></span><br><span class="line">     mMaxPackageEnqueueRate = Settings.Global.getFloat(getContext().getContentResolver(),</span><br><span class="line">             Settings.Global.MAX_NOTIFICATION_ENQUEUE_RATE,</span><br><span class="line">             DEFAULT_MAX_NOTIFICATION_ENQUEUE_RATE);</span><br><span class="line">     ... ... ...</span><br><span class="line"></span><br><span class="line">     mAppUsageStats = LocalServices.getService(UsageStatsManagerInternal.class);</span><br></pre></td></tr></table></figure>
<h2 id="3-2-setNotificationsShownFromListener"><a href="#3-2-setNotificationsShownFromListener" class="headerlink" title="3.2 setNotificationsShownFromListener"></a>3.2 setNotificationsShownFromListener</h2><p>当通知可见后 setNotificationsShownFromListener 会被触发！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNotificationsShownFromListener</span><span class="params">(INotificationListener token, String[] keys)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> identity = Binder.clearCallingIdentity();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mNotificationList) &#123;</span><br><span class="line">            <span class="keyword">final</span> ManagedServiceInfo info = mListeners.checkServiceTokenLocked(token);</span><br><span class="line">            <span class="keyword">if</span> (keys != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> N = keys.length;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">                    NotificationRecord r = mNotificationsByKey.get(keys[i]);</span><br><span class="line">                    <span class="keyword">if</span> (r == <span class="keyword">null</span>) <span class="keyword">continue</span>;</span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">int</span> userId = r.sbn.getUserId();</span><br><span class="line">                    <span class="keyword">if</span> (userId != info.userid &amp;&amp; userId != UserHandle.USER_ALL &amp;&amp;</span><br><span class="line">                            !mUserProfiles.isCurrentProfile(userId)) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"Disallowed call from listener: "</span></span><br><span class="line">                                + info.service);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (!r.isSeen()) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (DBG) Slog.d(TAG, <span class="string">"Marking notification as seen "</span> + keys[i]);</span><br><span class="line">                        <span class="comment">//【1】调用了 UsageStatsService 的 reportEvent 方法！</span></span><br><span class="line">                        mAppUsageStats.reportEvent(r.sbn.getPackageName(),</span><br><span class="line">                                userId == UserHandle.USER_ALL ? UserHandle.USER_SYSTEM</span><br><span class="line">                                        : userId,</span><br><span class="line">                                UsageEvents.Event.USER_INTERACTION);</span><br><span class="line">                        r.setSeen();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Binder.restoreCallingIdentity(identity);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里对传入的 UserId 做了一个判断，如果为 UserHandle.USER_ALL，那么就设置为 UserHandle.USER_SYSTEM！</p>
<p>最终，调用了 UsageStatsService.reportEvent 上报事件：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mAppUsageStats.reportEvent(r.sbn.getPackageName(),</span><br><span class="line">        userId == UserHandle.USER_ALL ? UserHandle.USER_SYSTEM</span><br><span class="line">                : userId,</span><br><span class="line">        UsageEvents.Event.USER_INTERACTION);</span><br></pre></td></tr></table></figure></p>
<h1 id="4-NetworkPolicyManagerService"><a href="#4-NetworkPolicyManagerService" class="headerlink" title="4 NetworkPolicyManagerService"></a>4 NetworkPolicyManagerService</h1><p>我们来看看 NetworkPolicyManagerService 和 UsageStatsService 的通信方式！</p>
<h2 id="4-1-systemReady"><a href="#4-1-systemReady" class="headerlink" title="4.1 systemReady"></a>4.1 systemReady</h2><p>先来看看 NetworkPolicyManagerService 的 systemReady 方法！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">systemReady</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Trace.traceBegin(Trace.TRACE_TAG_NETWORK, <span class="string">"systemReady"</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!isBandwidthControlEnabled()) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"bandwidth controls disabled, unable to enforce policy"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【1】获得了 UsageStats 对象！</span></span><br><span class="line">        mUsageStats = LocalServices.getService(UsageStatsManagerInternal.class);</span><br><span class="line">        ... ... ... ...</span><br><span class="line">        <span class="comment">//【2】注册 AppIdleStateChangeListener 监听器！</span></span><br><span class="line">        mUsageStats.addAppIdleStateChangeListener(<span class="keyword">new</span> AppIdleStateChangeListener());</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Trace.traceEnd(Trace.TRACE_TAG_NETWORK);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，最关键的一个地方，就是监听器的注册！</p>
<h2 id="4-2-new-AppIdleStateChangeListener"><a href="#4-2-new-AppIdleStateChangeListener" class="headerlink" title="4.2 new AppIdleStateChangeListener"></a>4.2 new AppIdleStateChangeListener</h2><p>AppIdleStateChangeListener 继承了 UsageStatsManagerInternal.AppIdleStateChangeListener，覆写了两个父类方法：</p>
<ul>
<li><strong>onAppIdleStateChanged</strong>：用于监听 app idle 状态变化！</li>
</ul>
<ul>
<li><strong>onParoleStateChanged</strong>：用于监听 app 假释状态的变化！</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">AppIdleStateChangeListener</span></span></span><br><span class="line"><span class="class">        <span class="keyword">extends</span> <span class="title">UsageStatsManagerInternal</span>.<span class="title">AppIdleStateChangeListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAppIdleStateChanged</span><span class="params">(String packageName, <span class="keyword">int</span> userId, <span class="keyword">boolean</span> idle)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> uid = mContext.getPackageManager().getPackageUidAsUser(packageName,</span><br><span class="line">                    PackageManager.MATCH_UNINSTALLED_PACKAGES, userId);</span><br><span class="line">            <span class="keyword">if</span> (LOGV) Log.v(TAG, <span class="string">"onAppIdleStateChanged(): uid="</span> + uid + <span class="string">", idle="</span> + idle);</span><br><span class="line">            <span class="keyword">synchronized</span> (mUidRulesFirstLock) &#123;</span><br><span class="line">                <span class="comment">//【4.3.1】更新 app idle 规则；</span></span><br><span class="line">                updateRuleForAppIdleUL(uid);</span><br><span class="line">                <span class="comment">//【4.3.2】更新省电模式的规则；</span></span><br><span class="line">                updateRulesForPowerRestrictionsUL(uid);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NameNotFoundException nnfe) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onParoleStateChanged</span><span class="params">(<span class="keyword">boolean</span> isParoleOn)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mUidRulesFirstLock) &#123;</span><br><span class="line">            <span class="comment">//【4.4.1】更新 app idle parole 规则；</span></span><br><span class="line">            updateRulesForAppIdleParoleUL();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-3-App-Idle-State-Changed"><a href="#4-3-App-Idle-State-Changed" class="headerlink" title="4.3 App Idle State Changed"></a>4.3 App Idle State Changed</h2><p>处理 app idle 状态的改变！</p>
<p>当 AppIdleStateChangeListener.onAppIdleStateChanged 触发！</p>
<h3 id="4-3-1-updateRuleForAppIdleUL"><a href="#4-3-1-updateRuleForAppIdleUL" class="headerlink" title="4.3.1 updateRuleForAppIdleUL"></a>4.3.1 updateRuleForAppIdleUL</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">updateRuleForAppIdleUL</span><span class="params">(<span class="keyword">int</span> uid)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】判断 uid 是否在名单中，在名单中的应用不受机制影响！！</span></span><br><span class="line">    <span class="keyword">if</span> (!isUidValidForBlacklistRules(uid)) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> appId = UserHandle.getAppId(uid);</span><br><span class="line">    <span class="keyword">if</span> (!mPowerSaveTempWhitelistAppIds.get(appId) &amp;&amp; isUidIdle(uid)</span><br><span class="line">            &amp;&amp; !isUidForegroundOnRestrictPowerUL(uid)) &#123;</span><br><span class="line">        <span class="comment">//【4.3.1.1】修改 FIREWALL_CHAIN_STANDBY 的规则为 FIREWALL_RULE_DENY</span></span><br><span class="line">        setUidFirewallRule(FIREWALL_CHAIN_STANDBY, uid, FIREWALL_RULE_DENY);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//【4.3.1.2】修改 FIREWALL_CHAIN_STANDBY 的规则为 FIREWALL_RULE_DEFAULT</span></span><br><span class="line">        setUidFirewallRule(FIREWALL_CHAIN_STANDBY, uid, FIREWALL_RULE_DEFAULT);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4-3-1-1-setUidFirewallRule"><a href="#4-3-1-1-setUidFirewallRule" class="headerlink" title="4.3.1.1 setUidFirewallRule"></a>4.3.1.1 setUidFirewallRule</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setUidFirewallRule</span><span class="params">(<span class="keyword">int</span> chain, <span class="keyword">int</span> uid, <span class="keyword">int</span> rule)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (chain == FIREWALL_CHAIN_DOZABLE) &#123;</span><br><span class="line">        mUidFirewallDozableRules.put(uid, rule);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (chain == FIREWALL_CHAIN_STANDBY) &#123;</span><br><span class="line">        <span class="comment">//【1】将 FIREWALL_CHAIN_STANDBY 相关的规则加入 mUidFirewallStandbyRules！</span></span><br><span class="line">        mUidFirewallStandbyRules.put(uid, rule);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (chain == FIREWALL_CHAIN_POWERSAVE) &#123;</span><br><span class="line">        mUidFirewallPowerSaveRules.put(uid, rule);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        mNetworkManager.setFirewallUidRule(chain, uid, rule);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalStateException e) &#123;</span><br><span class="line">        Log.wtf(TAG, <span class="string">"problem setting firewall uid rules"</span>, e);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="comment">// ignored; service lives in system_server</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-3-2-updateRulesForPowerRestrictionsUL-1"><a href="#4-3-2-updateRulesForPowerRestrictionsUL-1" class="headerlink" title="4.3.2 updateRulesForPowerRestrictionsUL[1]"></a>4.3.2 updateRulesForPowerRestrictionsUL[1]</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateRulesForPowerRestrictionsUL</span><span class="params">(<span class="keyword">int</span> uid)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> oldUidRules = mUidRules.get(uid, RULE_NONE);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> newUidRules = updateRulesForPowerRestrictionsUL(uid, oldUidRules, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (newUidRules == RULE_NONE) &#123;</span><br><span class="line">        mUidRules.delete(uid);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mUidRules.put(uid, newUidRules);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-4-Parole-State-Changed"><a href="#4-4-Parole-State-Changed" class="headerlink" title="4.4 Parole State Changed"></a>4.4 Parole State Changed</h2><p>处理 app 假释状态的改变！</p>
<h3 id="4-4-1-updateRulesForAppIdleParoleUL"><a href="#4-4-1-updateRulesForAppIdleParoleUL" class="headerlink" title="4.4.1 updateRulesForAppIdleParoleUL"></a>4.4.1 updateRulesForAppIdleParoleUL</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">updateRulesForAppIdleParoleUL</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//【1】判断此时是否处于假释状态！</span></span><br><span class="line">        <span class="keyword">boolean</span> paroled = mUsageStats.isAppIdleParoleOn();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2】判断是否可以访问网网络！</span></span><br><span class="line">        <span class="keyword">boolean</span> enableChain = !paroled;</span><br><span class="line">        enableFirewallChainUL(FIREWALL_CHAIN_STANDBY, enableChain);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【3】遍历 mUidFirewallStandbyRules 中的所有 rule！</span></span><br><span class="line">        <span class="keyword">int</span> ruleCount = mUidFirewallStandbyRules.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; ruleCount; i++) &#123;</span><br><span class="line">            <span class="keyword">int</span> uid = mUidFirewallStandbyRules.keyAt(i);</span><br><span class="line">            <span class="keyword">int</span> oldRules = mUidRules.get(uid);</span><br><span class="line">            <span class="keyword">if</span> (enableChain) &#123;</span><br><span class="line">                <span class="comment">//【3.1】如果可以访问网络，取消掉 RULE_ALLOW_ALL/RULE_REJECT_ALL 位！</span></span><br><span class="line">                oldRules &amp;= MASK_METERED_NETWORKS;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//【3.2】如果不可以访问网络，并且 oldRules 没有设置 RULE_ALLOW_ALL/RULE_REJECT_ALL 位！</span></span><br><span class="line">                <span class="comment">// 那就跳过，否则进入下面的环节！</span></span><br><span class="line">                <span class="keyword">if</span> ((oldRules &amp; MASK_ALL_NETWORKS) == <span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【4.4.2】进入 updateRulesForPowerRestrictionsUL 方法！</span></span><br><span class="line">            updateRulesForPowerRestrictionsUL(uid, oldRules, paroled);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">``` </span><br><span class="line">### 4.4.2 updateRulesForPowerRestrictionsUL[3]</span><br><span class="line"></span><br><span class="line">```java</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">updateRulesForPowerRestrictionsUL</span><span class="params">(<span class="keyword">int</span> uid, <span class="keyword">int</span> oldUidRules, <span class="keyword">boolean</span> paroled)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!isUidValidForBlacklistRules(uid)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (LOGD) Slog.d(TAG, <span class="string">"no need to update restrict power rules for uid "</span> + uid);</span><br><span class="line">            <span class="keyword">return</span> RULE_NONE;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【1】判断是否是 idle 状态！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> isIdle = !paroled &amp;&amp; isUidIdle(uid);</span><br><span class="line">        <span class="comment">//【2】判断是否是强制模式！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> restrictMode = isIdle || mRestrictPower || mDeviceIdleMode;</span><br><span class="line">        <span class="comment">//【3】判断 uid 下的进程是否是前台进程！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> isForeground = isUidForegroundOnRestrictPowerUL(uid);</span><br><span class="line">        <span class="comment">//【4】判断 uid 是否在省电白名单中！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> isWhitelisted = isWhitelistedBatterySaverUL(uid);</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> oldRule = oldUidRules &amp; MASK_ALL_NETWORKS;</span><br><span class="line">        <span class="keyword">int</span> newRule = RULE_NONE;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【5】</span></span><br><span class="line">        <span class="keyword">if</span> (isForeground) &#123;</span><br><span class="line">            <span class="keyword">if</span> (restrictMode) &#123;</span><br><span class="line">                newRule = RULE_ALLOW_ALL;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (restrictMode) &#123;</span><br><span class="line">            newRule = isWhitelisted ? RULE_ALLOW_ALL : RULE_REJECT_ALL;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【6】计算新的 rules,oldUidRules &amp; MASK_METERED_NETWORKS 取消旧的高四位！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> newUidRules = (oldUidRules &amp; MASK_METERED_NETWORKS) | newRule;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (LOGV) &#123;</span><br><span class="line">            Log.v(TAG, <span class="string">"updateRulesForPowerRestrictionsUL("</span> + uid + <span class="string">")"</span></span><br><span class="line">                    + <span class="string">", isIdle: "</span> + isIdle</span><br><span class="line">                    + <span class="string">", mRestrictPower: "</span> + mRestrictPower</span><br><span class="line">                    + <span class="string">", mDeviceIdleMode: "</span> + mDeviceIdleMode</span><br><span class="line">                    + <span class="string">", isForeground="</span> + isForeground</span><br><span class="line">                    + <span class="string">", isWhitelisted="</span> + isWhitelisted</span><br><span class="line">                    + <span class="string">", oldRule="</span> + uidRulesToString(oldRule)</span><br><span class="line">                    + <span class="string">", newRule="</span> + uidRulesToString(newRule)</span><br><span class="line">                    + <span class="string">", newUidRules="</span> + uidRulesToString(newUidRules)</span><br><span class="line">                    + <span class="string">", oldUidRules="</span> + uidRulesToString(oldUidRules));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【7】如果规则发生了变化，那就发送 MSG_RULES_CHANGED 消息！</span></span><br><span class="line">        <span class="keyword">if</span> (newRule != oldRule) &#123;</span><br><span class="line">            <span class="keyword">if</span> (newRule == RULE_NONE || (newRule &amp; RULE_ALLOW_ALL) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (LOGV) Log.v(TAG, <span class="string">"Allowing non-metered access for UID "</span> + uid);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((newRule &amp; RULE_REJECT_ALL) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (LOGV) Log.v(TAG, <span class="string">"Rejecting non-metered access for UID "</span> + uid);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Log.wtf(TAG, <span class="string">"Unexpected change of non-metered UID state for "</span> + uid</span><br><span class="line">                        + <span class="string">": foreground="</span> + isForeground</span><br><span class="line">                        + <span class="string">", whitelisted="</span> + isWhitelisted</span><br><span class="line">                        + <span class="string">", newRule="</span> + uidRulesToString(newUidRules)</span><br><span class="line">                        + <span class="string">", oldRule="</span> + uidRulesToString(oldUidRules));</span><br><span class="line">            &#125;</span><br><span class="line">            mHandler.obtainMessage(MSG_RULES_CHANGED, uid, newUidRules).sendToTarget();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> newUidRules;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h1 id="5-AppIdleController"><a href="#5-AppIdleController" class="headerlink" title="5 AppIdleController"></a>5 AppIdleController</h1><p>学习过 JobSchedulerSerivce，我们知道 AppIdleController 会判断 app 是否进入 idle 状态，这样动态控制 app 对应的 job！</p>
<h2 id="5-1-new-AppIdleController"><a href="#5-1-new-AppIdleController" class="headerlink" title="5.1 new AppIdleController"></a>5.1 new AppIdleController</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">AppIdleController</span><span class="params">(JobSchedulerService service, Context context, Object lock)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(service, context, lock);</span><br><span class="line">    mJobSchedulerService = service;</span><br><span class="line">    <span class="comment">//【1】获得 UsageStatsService 的 LocalService 对象！</span></span><br><span class="line">    mUsageStatsInternal = LocalServices.getService(UsageStatsManagerInternal.class);</span><br><span class="line">    <span class="comment">//【2】初始化 mAppIdleParoleOn 为 true！</span></span><br><span class="line">    mAppIdleParoleOn = <span class="keyword">true</span>;</span><br><span class="line">    <span class="comment">//【3】注册 AppIdleStateChangeListener 监听器！</span></span><br><span class="line">    mUsageStatsInternal.addAppIdleStateChangeListener(<span class="keyword">new</span> AppIdleStateChangeListener());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="5-2-new-AppIdleStateChangeListener"><a href="#5-2-new-AppIdleStateChangeListener" class="headerlink" title="5.2 new AppIdleStateChangeListener"></a>5.2 new AppIdleStateChangeListener</h2><p>AppIdleStateChangeListener 用于监听 app idle 状态的变化！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">AppIdleStateChangeListener</span></span></span><br><span class="line"><span class="class">        <span class="keyword">extends</span> <span class="title">UsageStatsManagerInternal</span>.<span class="title">AppIdleStateChangeListener</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAppIdleStateChanged</span><span class="params">(String packageName, <span class="keyword">int</span> userId, <span class="keyword">boolean</span> idle)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> changed = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">            <span class="comment">//【1】如果此时应用进入了假释状态，不处理！</span></span><br><span class="line">            <span class="keyword">if</span> (mAppIdleParoleOn) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【2】为系统中的所有 Job 执行 PackageUpdateFunc 操作！</span></span><br><span class="line">            <span class="comment">// idle 表示是否处于 idle 状态！</span></span><br><span class="line">            PackageUpdateFunc update = <span class="keyword">new</span> PackageUpdateFunc(userId, packageName, idle);</span><br><span class="line">            mJobSchedulerService.getJobStore().forEachJob(update);</span><br><span class="line">            <span class="keyword">if</span> (update.mChanged) &#123;</span><br><span class="line">                changed = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【3】通知 JobSchedulerService，AppIdleController 状态发生了变化！</span></span><br><span class="line">        <span class="comment">// 需要执行/停止 Job！</span></span><br><span class="line">        <span class="keyword">if</span> (changed) &#123;</span><br><span class="line">            mStateChangedListener.onControllerStateChanged();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onParoleStateChanged</span><span class="params">(<span class="keyword">boolean</span> isParoleOn)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">            Slog.d(LOG_TAG, <span class="string">"Parole on: "</span> + isParoleOn);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【4】当应用的假释模式发生变化后，调用 setAppIdleParoleOn 方法！</span></span><br><span class="line">        setAppIdleParoleOn(isParoleOn);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ul>
<li>当应用的 app idle 状态发生了变化，会触发 onAppIdleStateChanged 方法！</li>
<li>当应用的 app 假释状态发生了变化，会触发 onParoleStateChanged 方法！</li>
</ul>
<h3 id="5-2-1-PackageUpdateFunc-process"><a href="#5-2-1-PackageUpdateFunc-process" class="headerlink" title="5.2.1 PackageUpdateFunc.process"></a>5.2.1 PackageUpdateFunc.process</h3><p>当 app idle 状态变化后，会触发 AppIdleController.AppIdleStateChangeListener.onAppIdleStateChanged 方法！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">PackageUpdateFunc</span> <span class="keyword">implements</span> <span class="title">JobStore</span>.<span class="title">JobStatusFunctor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> mUserId;</span><br><span class="line">    <span class="keyword">final</span> String mPackage;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> mIdle;</span><br><span class="line">    <span class="keyword">boolean</span> mChanged; <span class="comment">// 是否有 job 的条件发生变化！</span></span><br><span class="line"></span><br><span class="line">    PackageUpdateFunc(<span class="keyword">int</span> userId, String pkg, <span class="keyword">boolean</span> idle) &#123;</span><br><span class="line">        mUserId = userId;</span><br><span class="line">        mPackage = pkg;</span><br><span class="line">        mIdle = idle;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(JobStatus jobStatus)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//【1】匹配到对应的 JobStatus！</span></span><br><span class="line">        <span class="keyword">if</span> (jobStatus.getSourcePackageName().equals(mPackage)</span><br><span class="line">                &amp;&amp; jobStatus.getSourceUserId() == mUserId) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【1.1】设置 Job 的 AppNotIdle 条件，如果 Job 的条件发生变化</span></span><br><span class="line">            <span class="comment">// mChanged 为 true！</span></span><br><span class="line">            <span class="keyword">if</span> (jobStatus.setAppNotIdleConstraintSatisfied(!mIdle)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                    Slog.d(LOG_TAG, <span class="string">"App Idle state changed, setting idle state of "</span></span><br><span class="line">                            + mPackage + <span class="string">" to "</span> + mIdle);</span><br><span class="line">                &#125;</span><br><span class="line">                mChanged = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>jobStatus.setAppNotIdleConstraintSatisfied 方法用于设置 app 是否满足不处于 idle 状态下的条件！</p>
<h3 id="5-2-2-setAppIdleParoleOn"><a href="#5-2-2-setAppIdleParoleOn" class="headerlink" title="5.2.2 setAppIdleParoleOn"></a>5.2.2 setAppIdleParoleOn</h3><p>当应用的 app 假释状态发生了变化，会触发 setAppIdleParoleOn 方法！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setAppIdleParoleOn</span><span class="params">(<span class="keyword">boolean</span> isAppIdleParoleOn)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> changed = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="comment">//【1】如果假释状态没有变化，不处理!</span></span><br><span class="line">        <span class="keyword">if</span> (mAppIdleParoleOn == isAppIdleParoleOn) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【2】保存最新的假释状态！</span></span><br><span class="line">        mAppIdleParoleOn = isAppIdleParoleOn;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【3】对所有的 Job 执行 GlobalUpdateFunc！</span></span><br><span class="line">        GlobalUpdateFunc update = <span class="keyword">new</span> GlobalUpdateFunc();</span><br><span class="line">        mJobSchedulerService.getJobStore().forEachJob(update);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【4】如果 Job 触发条件变化，changed 为 true！</span></span><br><span class="line">        <span class="keyword">if</span> (update.mChanged) &#123;</span><br><span class="line">            changed = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【4】通知 JobSchedulerService，AppIdleController 状态发生了变化！</span></span><br><span class="line">    <span class="comment">// 需要执行/停止 Job！</span></span><br><span class="line">    <span class="keyword">if</span> (changed) &#123;</span><br><span class="line">        mStateChangedListener.onControllerStateChanged();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>方法流程很简单！</p>
<h4 id="5-2-2-1-GlobalUpdateFunc-process"><a href="#5-2-2-1-GlobalUpdateFunc-process" class="headerlink" title="5.2.2.1 GlobalUpdateFunc.process"></a>5.2.2.1 GlobalUpdateFunc.process</h4><p>我们来看看 GlobalUpdateFunc 的逻辑！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">GlobalUpdateFunc</span> <span class="keyword">implements</span> <span class="title">JobStore</span>.<span class="title">JobStatusFunctor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> mChanged;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(JobStatus jobStatus)</span> </span>&#123;</span><br><span class="line">        String packageName = jobStatus.getSourcePackageName();</span><br><span class="line">        <span class="comment">//【1】判断 app 是否处于 idle 状态，满足条件是进入了 idle 状态，但是不能是假释状态！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> appIdle = !mAppIdleParoleOn &amp;&amp; mUsageStatsInternal.isAppIdle(packageName,</span><br><span class="line">                jobStatus.getSourceUid(), jobStatus.getSourceUserId());</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">            Slog.d(LOG_TAG, <span class="string">"Setting idle state of "</span> + packageName + <span class="string">" to "</span> + appIdle);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【2】修改 Job 的 appNotIdle 执行条件，如果条件发生了变化，mChanged 为 true！</span></span><br><span class="line">        <span class="keyword">if</span> (jobStatus.setAppNotIdleConstraintSatisfied(!appIdle)) &#123;</span><br><span class="line">            mChanged = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>方法流程很简单！</p>
<h2 id="5-3-maybeStartTrackingJobLocked"><a href="#5-3-maybeStartTrackingJobLocked" class="headerlink" title="5.3 maybeStartTrackingJobLocked"></a>5.3 maybeStartTrackingJobLocked</h2><p>AppIdleController 开始监控指定的 Job！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">maybeStartTrackingJobLocked</span><span class="params">(JobStatus jobStatus, JobStatus lastJob)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】如果还没有初始化过假释状态，进行初始化！</span></span><br><span class="line">    <span class="keyword">if</span> (!mInitializedParoleOn) &#123;</span><br><span class="line">        mInitializedParoleOn = <span class="keyword">true</span>;</span><br><span class="line">        <span class="comment">//【1.1】调用 UsageStatsService.isAppIdleParoleOn 方法判断此时是否是应用假释模式！</span></span><br><span class="line">        mAppIdleParoleOn = mUsageStatsInternal.isAppIdleParoleOn();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String packageName = jobStatus.getSourcePackageName();</span><br><span class="line">    <span class="comment">//【2】判断 app 是否处于 app idle ，满足 2 个条件，应用处于 idle 状态，但是不能处于假释模式！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> appIdle = !mAppIdleParoleOn &amp;&amp; mUsageStatsInternal.isAppIdle(packageName,</span><br><span class="line">            jobStatus.getSourceUid(), jobStatus.getSourceUserId());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">        Slog.d(LOG_TAG, <span class="string">"Start tracking, setting idle state of "</span></span><br><span class="line">                + packageName + <span class="string">" to "</span> + appIdle);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【3】设置 Job 的条件属性！</span></span><br><span class="line">    jobStatus.setAppNotIdleConstraintSatisfied(!appIdle);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>方法流程很简单！</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2017/08/01/AppOps 第 1 篇 - AppOpsService 的启动/">AppOps 第 1 篇 - AppOpsService 的启动</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2017-08-01</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/AndroidFramework源码分析/">AndroidFramework源码分析</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/AndroidFramework源码分析/AppOps应用操作管理/">AppOps应用操作管理</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/AppOps应用操作管理/">AppOps应用操作管理</a></span><div class="content"><p>[toc]</p>
<p>本文基于 Android 7.1.1 源码分析，如有错误，欢迎指正，谢谢！</p>
<h1 id="0-综述"><a href="#0-综述" class="headerlink" title="0 综述"></a>0 综述</h1><p>AppOpsService 的初始化是在 ActivityManagerService 启动的时候：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ActivityManagerService</span><span class="params">(Context systemContext)</span> </span>&#123;</span><br><span class="line">    ... ... ...   </span><br><span class="line">    mHandlerThread = <span class="keyword">new</span> ServiceThread(TAG,</span><br><span class="line">            android.os.Process.THREAD_PRIORITY_FOREGROUND, <span class="keyword">false</span> <span class="comment">/*allowIo*/</span>);</span><br><span class="line">    mHandlerThread.start();</span><br><span class="line">    mHandler = <span class="keyword">new</span> MainHandler(mHandlerThread.getLooper());</span><br><span class="line">    </span><br><span class="line">    ... ... ... </span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Move creation of battery stats service outside of activity manager service.</span></span><br><span class="line">    File dataDir = Environment.getDataDirectory();</span><br><span class="line">    File systemDir = <span class="keyword">new</span> File(dataDir, <span class="string">"system"</span>);</span><br><span class="line">    systemDir.mkdirs();</span><br><span class="line"></span><br><span class="line">    ... ... ...</span><br><span class="line">    <span class="comment">//【1】创建了 AppOpsService 对象！</span></span><br><span class="line">    mAppOpsService = <span class="keyword">new</span> AppOpsService(<span class="keyword">new</span> File(systemDir, <span class="string">"appops.xml"</span>), mHandler);</span><br><span class="line">    <span class="comment">//【2】启动监听，开始监听是否有应用要在后台运行！</span></span><br><span class="line">    mAppOpsService.startWatchingMode(AppOpsManager.OP_RUN_IN_BACKGROUND, <span class="keyword">null</span>,</span><br><span class="line">            <span class="keyword">new</span> IAppOpsCallback.Stub() &#123;</span><br><span class="line">                <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">opChanged</span><span class="params">(<span class="keyword">int</span> op, <span class="keyword">int</span> uid, String packageName)</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">if</span> (op == AppOpsManager.OP_RUN_IN_BACKGROUND &amp;&amp; packageName != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (mAppOpsService.checkOperation(op, uid, packageName)</span><br><span class="line">                                != AppOpsManager.MODE_ALLOWED) &#123;</span><br><span class="line">                            runInBackgroundDisabled(uid);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">    ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="1-new-AppOpsService"><a href="#1-new-AppOpsService" class="headerlink" title="1 new AppOpsService"></a>1 new AppOpsService</h1><p>创建 AppOpsService 的时候，传入了一个 File 对象，用于访问 /data/system/appops.xml 文件！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">AppOpsService</span><span class="params">(File storagePath, Handler handler)</span> </span>&#123;</span><br><span class="line">    mFile = <span class="keyword">new</span> AtomicFile(storagePath);</span><br><span class="line">    mHandler = handler;</span><br><span class="line">    <span class="comment">//【2】从 /data/system/appops.xml 文件中读取记录！</span></span><br><span class="line">    readState();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们来看下，appops.xml 文件的内容：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">'1.0'</span> encoding=<span class="string">'utf-8'</span> standalone=<span class="string">'yes'</span> ?&gt;</span><br><span class="line">&lt;app-ops&gt;</span><br><span class="line">    &lt;uid n=<span class="string">"1001"</span>&gt;</span><br><span class="line">        &lt;op m=<span class="string">"0"</span> n=<span class="string">"15"</span>/&gt;</span><br><span class="line">    &lt;/uid&gt;</span><br><span class="line">    &lt;pkg n=<span class="string">"android"</span>&gt;</span><br><span class="line">        &lt;uid n=<span class="string">"1000"</span> p=<span class="string">"true"</span>&gt;</span><br><span class="line">            &lt;op n=<span class="string">"0"</span> pu=<span class="string">"0"</span> t=<span class="string">"1514736165168"</span>/&gt;</span><br><span class="line">            &lt;op n=<span class="string">"1"</span> pu=<span class="string">"0"</span> t=<span class="string">"1514738472778"</span>/&gt;</span><br><span class="line">            &lt;op d=<span class="string">"133"</span> n=<span class="string">"3"</span> t=<span class="string">"1514752786349"</span>/&gt;</span><br><span class="line">            &lt;op n=<span class="string">"24"</span> r=<span class="string">"1514738089301"</span>/&gt;</span><br><span class="line">            &lt;op n=<span class="string">"40"</span> t=<span class="string">"1514756174224"</span>/&gt;</span><br><span class="line">            &lt;op d=<span class="string">"20027926"</span> n=<span class="string">"41"</span> t=<span class="string">"1514736155960"</span>/&gt;</span><br><span class="line">            &lt;op n=<span class="string">"61"</span> pu=<span class="string">"0"</span> t=<span class="string">"1514756174065"</span>/&gt;</span><br><span class="line">        &lt;/uid&gt;</span><br><span class="line">    &lt;/pkg&gt;</span><br><span class="line">    &lt;pkg n=<span class="string">"com.android.settings"</span>&gt;</span><br><span class="line">        &lt;uid n=<span class="string">"1000"</span> p=<span class="string">"true"</span>&gt;</span><br><span class="line">            &lt;op d=<span class="string">"135"</span> n=<span class="string">"3"</span> t=<span class="string">"1514738402132"</span>/&gt;</span><br><span class="line">            &lt;op m=<span class="string">"0"</span> n=<span class="string">"15"</span>/&gt;</span><br><span class="line">            &lt;op n=<span class="string">"59"</span> pp=<span class="string">"com.android.providers.media"</span> pu=<span class="string">"0"</span> t=<span class="string">"1514738336945"</span>/&gt;</span><br><span class="line">            &lt;op n=<span class="string">"60"</span> pu=<span class="string">"0"</span> t=<span class="string">"1514736151388"</span>/&gt;</span><br><span class="line">            &lt;op n=<span class="string">"63"</span> pu=<span class="string">"0"</span> t=<span class="string">"1514749896628"</span>/&gt;</span><br><span class="line">            &lt;op n=<span class="string">"73"</span> pu=<span class="string">"0"</span> t=<span class="string">"1514749896649"</span>/&gt;</span><br><span class="line">        &lt;/uid&gt;</span><br><span class="line">    &lt;/pkg&gt;</span><br><span class="line">    &lt;pkg n=<span class="string">"com.android.systemui"</span>&gt;</span><br><span class="line">        &lt;uid n=<span class="string">"1000"</span> p=<span class="string">"true"</span>&gt;</span><br><span class="line">            &lt;op d=<span class="string">"74"</span> n=<span class="string">"3"</span> t=<span class="string">"1514752786572"</span>/&gt;</span><br><span class="line">            &lt;op n=<span class="string">"24"</span> r=<span class="string">"1514741582746"</span>/&gt;</span><br><span class="line">            &lt;op d=<span class="string">"98"</span> n=<span class="string">"40"</span> t=<span class="string">"1514752835557"</span>/&gt;</span><br><span class="line">            &lt;op n=<span class="string">"59"</span> pu=<span class="string">"0"</span> t=<span class="string">"493576354"</span>/&gt;</span><br><span class="line">            &lt;op n=<span class="string">"60"</span> pu=<span class="string">"0"</span> t=<span class="string">"493576354"</span>/&gt;</span><br><span class="line">        &lt;/uid&gt;</span><br><span class="line">    &lt;/pkg&gt;</span><br><span class="line">&lt;/app-ops&gt;</span><br></pre></td></tr></table></figure>
<p>内容我们先简单的分析下：</p>
<ul>
<li>uid 用于记录和 uid 相关的限制信息；</li>
<li>pkg 用于记录和具体应用的限制信息；</li>
</ul>
<h1 id="2-AppOpsService-readState"><a href="#2-AppOpsService-readState" class="headerlink" title="2 AppOpsService.readState"></a>2 AppOpsService.readState</h1><p>AppOpsService 启动的时候，会读取本地持久化文件，恢复上一次的数据！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">readState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mFile) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            FileInputStream stream;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                stream = mFile.openRead();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">                Slog.i(TAG, <span class="string">"No existing app ops "</span> + mFile.getBaseFile() + <span class="string">"; starting empty"</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">boolean</span> success = <span class="keyword">false</span>;</span><br><span class="line">            mUidStates.clear();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                XmlPullParser parser = Xml.newPullParser();</span><br><span class="line">                parser.setInput(stream, StandardCharsets.UTF_8.name());</span><br><span class="line">                <span class="keyword">int</span> type;</span><br><span class="line">                <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.START_TAG</span><br><span class="line">                        &amp;&amp; type != XmlPullParser.END_DOCUMENT) &#123;</span><br><span class="line">                    ;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (type != XmlPullParser.START_TAG) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"no start tag found"</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">int</span> outerDepth = parser.getDepth();</span><br><span class="line">                <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">                        &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    String tagName = parser.getName();</span><br><span class="line">                    <span class="keyword">if</span> (tagName.equals(<span class="string">"pkg"</span>)) &#123;</span><br><span class="line">                        <span class="comment">//【1】读取 pkg 标签；</span></span><br><span class="line">                        readPackage(parser);</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"uid"</span>)) &#123;</span><br><span class="line">                        <span class="comment">//【2】读取 uid 标签；</span></span><br><span class="line">                        readUidOps(parser);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        Slog.w(TAG, <span class="string">"Unknown element under &lt;app-ops&gt;: "</span></span><br><span class="line">                                + parser.getName());</span><br><span class="line">                        XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                success = <span class="keyword">true</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IllegalStateException e) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Failed parsing "</span> + e);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NullPointerException e) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Failed parsing "</span> + e);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Failed parsing "</span> + e);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (XmlPullParserException e) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Failed parsing "</span> + e);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Failed parsing "</span> + e);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IndexOutOfBoundsException e) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Failed parsing "</span> + e);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">                    mUidStates.clear();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    stream.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>readState 会 pkg 和 uid 标签的数据，然后保存到内部的数据结构中！</p>
<h2 id="2-1-AppOpsService-readUid-1-读取-uid-的-op-信息"><a href="#2-1-AppOpsService-readUid-1-读取-uid-的-op-信息" class="headerlink" title="2.1 AppOpsService.readUid[1] - 读取 uid 的 op 信息"></a>2.1 AppOpsService.readUid[1] - 读取 uid 的 op 信息</h2><p>首先，解析的是 uid 信息！</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;uid n=<span class="string">"1001"</span>&gt;</span><br><span class="line">    &lt;op m=<span class="string">"0"</span> n=<span class="string">"15"</span>/&gt;</span><br><span class="line">&lt;/uid&gt;</span><br></pre></td></tr></table></figure>
<p>解释一下：</p>
<ul>
<li>uid 的 n 属性表示 uid 的取值；</li>
<li>op 的 n 属性表示 op 的数值，m 表示 op 的 mode 值；</li>
</ul>
<p>我们来看看解析的过程！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">readUidOps</span><span class="params">(XmlPullParser parser)</span> <span class="keyword">throws</span> NumberFormatException,</span></span><br><span class="line"><span class="function">        XmlPullParserException, IOException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> uid = Integer.parseInt(parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"n"</span>));</span><br><span class="line">    <span class="keyword">int</span> outerDepth = parser.getDepth();</span><br><span class="line">    <span class="keyword">int</span> type;</span><br><span class="line">    <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">            &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String tagName = parser.getName();</span><br><span class="line">        <span class="keyword">if</span> (tagName.equals(<span class="string">"op"</span>)) &#123; <span class="comment">// 解析 op 子标签！</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> code = Integer.parseInt(parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"n"</span>)); <span class="comment">//</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> mode = Integer.parseInt(parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"m"</span>));</span><br><span class="line">            <span class="comment">//【2.1.1】调用 getUidStateLocked 获得 uid 对应的状态信息，如果没有，就会创建一个！</span></span><br><span class="line">            UidState uidState = getUidStateLocked(uid, <span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">if</span> (uidState.opModes == <span class="keyword">null</span>) &#123;</span><br><span class="line">                uidState.opModes = <span class="keyword">new</span> SparseIntArray();</span><br><span class="line">            &#125;</span><br><span class="line">            uidState.opModes.put(code, mode);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Unknown element under &lt;uid-ops&gt;: "</span></span><br><span class="line">                    + parser.getName());</span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们看到，创建了一个 UidState 对象，封装对 uid 的 op 控制，uidState.opModes 则保存了该 uid 的所有 op 和控制情况的映射关系！</p>
<h3 id="2-1-1-getUidStateLocked"><a href="#2-1-1-getUidStateLocked" class="headerlink" title="2.1.1 getUidStateLocked"></a>2.1.1 getUidStateLocked</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> UidState <span class="title">getUidStateLocked</span><span class="params">(<span class="keyword">int</span> uid, <span class="keyword">boolean</span> edit)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 通过 uid，获得对应的 UidState 对象！</span></span><br><span class="line">    UidState uidState = mUidStates.get(uid);</span><br><span class="line">    <span class="keyword">if</span> (uidState == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!edit) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【2.1.2】创建一个新的 UidState，并添加到 mUidStates 中！</span></span><br><span class="line">        uidState = <span class="keyword">new</span> UidState(uid);</span><br><span class="line">        mUidStates.put(uid, uidState);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> uidState;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>AppOpsService 有一个内部的 SparseArray，用于保存 uid 和其对应的 UidState 的映射关系！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> SparseArray&lt;UidState&gt; mUidStates = <span class="keyword">new</span> SparseArray&lt;&gt;();</span><br></pre></td></tr></table></figure></p>
<h3 id="2-1-2-new-UidState"><a href="#2-1-2-new-UidState" class="headerlink" title="2.1.2 new UidState"></a>2.1.2 new UidState</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">UidState</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> uid; <span class="comment">// uid 值</span></span><br><span class="line">    <span class="keyword">public</span> ArrayMap&lt;String, Ops&gt; pkgOps; <span class="comment">//【2.1.2.1】属于 uid 的所有 package 和其 Op 集合的映射关系！</span></span><br><span class="line">    <span class="keyword">public</span> SparseIntArray opModes; <span class="comment">// 用于保存该 uid 的 op 集合 ！</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UidState</span><span class="params">(<span class="keyword">int</span> uid)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.uid = uid;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        pkgOps = <span class="keyword">null</span>;</span><br><span class="line">        opModes = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isDefault</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (pkgOps == <span class="keyword">null</span> || pkgOps.isEmpty())</span><br><span class="line">                &amp;&amp; (opModes == <span class="keyword">null</span> || opModes.size() &lt;= <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>UidState.pkgOps 是一个 ArrayMap，key 为 packageName，而 value 为 Ops，Ops 用于封装该 package 所有的 Op 控制数据！</p>
<p>这里涉及到了一个 Ops 类，我们来看下他的结构!</p>
<h4 id="2-1-2-1-new-Ops"><a href="#2-1-2-1-new-Ops" class="headerlink" title="2.1.2.1 new Ops"></a>2.1.2.1 new Ops</h4><p>可以看到 Ops 本质上是一个 SparseArray，用于记录 package 的所有 Op 控制信息！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Ops</span> <span class="keyword">extends</span> <span class="title">SparseArray</span>&lt;<span class="title">Op</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String packageName; <span class="comment">// 所属的 package</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> UidState uidState; <span class="comment">// 所属的 UidState</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> isPrivileged;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Ops</span><span class="params">(String _packageName, UidState _uidState, <span class="keyword">boolean</span> _isPrivileged)</span> </span>&#123;</span><br><span class="line">        packageName = _packageName;</span><br><span class="line">        uidState = _uidState;</span><br><span class="line">        isPrivileged = _isPrivileged;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>保存的规则是：下标为 op，值为控制情况！</p>
<h2 id="2-2-AppOpsService-readPackage-读取-package-的-op-信息"><a href="#2-2-AppOpsService-readPackage-读取-package-的-op-信息" class="headerlink" title="2.2 AppOpsService.readPackage  - 读取 package 的 op 信息"></a>2.2 AppOpsService.readPackage  - 读取 package 的 op 信息</h2><p>我们来看下 readPackage 解析的数据：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;pkg n=<span class="string">"com.android.settings"</span>&gt; <span class="comment">// readPackage 解析</span></span><br><span class="line">    &lt;uid n=<span class="string">"1000"</span> p=<span class="string">"true"</span>&gt; <span class="comment">// readUid[2] 解析</span></span><br><span class="line">        &lt;op d=<span class="string">"135"</span> n=<span class="string">"3"</span> t=<span class="string">"1514738402132"</span>/&gt;</span><br><span class="line">        &lt;op m=<span class="string">"0"</span> n=<span class="string">"15"</span>/&gt;</span><br><span class="line">        &lt;op n=<span class="string">"59"</span> pp=<span class="string">"com.android.providers.media"</span> pu=<span class="string">"0"</span> t=<span class="string">"1514738336945"</span>/&gt;</span><br><span class="line">        &lt;op n=<span class="string">"60"</span> pu=<span class="string">"0"</span> t=<span class="string">"1514736151388"</span>/&gt;</span><br><span class="line">        &lt;op n=<span class="string">"63"</span> pu=<span class="string">"0"</span> t=<span class="string">"1514749896628"</span>/&gt;</span><br><span class="line">        &lt;op n=<span class="string">"73"</span> pu=<span class="string">"0"</span> t=<span class="string">"1514749896649"</span>/&gt;</span><br><span class="line">    &lt;/uid&gt;</span><br><span class="line">&lt;/pkg&gt;</span><br></pre></td></tr></table></figure>
<p>解释一下：</p>
<ul>
<li>pkg 的 n 属性表示包名；</li>
<li>uid 的 n 表示应用包所属的 uid 值，uid 的 p 表示应用包是否是特权应用；</li>
<li>op 的 n 属性表示 op 的数值，m 表示 op 的 mode 值；</li>
</ul>
<p>首先是解析 pkg 标签！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">readPackage</span><span class="params">(XmlPullParser parser)</span> <span class="keyword">throws</span> NumberFormatException,</span></span><br><span class="line"><span class="function">        XmlPullParserException, IOException </span>&#123;</span><br><span class="line">    <span class="comment">//【1】获取包名 package name！</span></span><br><span class="line">    String pkgName = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"n"</span>);</span><br><span class="line">    <span class="keyword">int</span> outerDepth = parser.getDepth();</span><br><span class="line">    <span class="keyword">int</span> type;</span><br><span class="line">    <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">            &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String tagName = parser.getName();</span><br><span class="line">        <span class="keyword">if</span> (tagName.equals(<span class="string">"uid"</span>)) &#123; </span><br><span class="line">            <span class="comment">//【2.1.1】这里的 uid 标签是 pkg 标签的子标签！</span></span><br><span class="line">            readUid(parser, pkgName);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Unknown element under &lt;pkg&gt;: "</span></span><br><span class="line">                    + parser.getName());</span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>继续来看：</p>
<h3 id="2-2-1-AppOpsService-readUid-2"><a href="#2-2-1-AppOpsService-readUid-2" class="headerlink" title="2.2.1 AppOpsService.readUid[2]"></a>2.2.1 AppOpsService.readUid[2]</h3><p>然后是解析子 uid 标签！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">readUid</span><span class="params">(XmlPullParser parser, String pkgName)</span> <span class="keyword">throws</span> NumberFormatException,</span></span><br><span class="line"><span class="function">        XmlPullParserException, IOException </span>&#123;</span><br><span class="line">    <span class="comment">//【1】解析 n 属性，uid；</span></span><br><span class="line">    <span class="keyword">int</span> uid = Integer.parseInt(parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"n"</span>));</span><br><span class="line">    <span class="comment">//【2】解析 p 属性，是否是特权应用；</span></span><br><span class="line">    String isPrivilegedString = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"p"</span>);</span><br><span class="line">    <span class="keyword">boolean</span> isPrivileged = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (isPrivilegedString == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            IPackageManager packageManager = ActivityThread.getPackageManager();</span><br><span class="line">            <span class="keyword">if</span> (packageManager != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">//【3】获得 pkg 对应的 ApplicationInfo 对象！</span></span><br><span class="line">                ApplicationInfo appInfo = ActivityThread.getPackageManager()</span><br><span class="line">                        .getApplicationInfo(pkgName, <span class="number">0</span>, UserHandle.getUserId(uid));</span><br><span class="line">                <span class="keyword">if</span> (appInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    isPrivileged = (appInfo.privateFlags</span><br><span class="line">                            &amp; ApplicationInfo.PRIVATE_FLAG_PRIVILEGED) != <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Could not contact PackageManager"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//【4】是否是特权应用！</span></span><br><span class="line">        isPrivileged = Boolean.parseBoolean(isPrivilegedString);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> outerDepth = parser.getDepth();</span><br><span class="line">    <span class="keyword">int</span> type;</span><br><span class="line">    <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">            &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String tagName = parser.getName();</span><br><span class="line">        <span class="comment">//【5】解析 op 标签！</span></span><br><span class="line">        <span class="keyword">if</span> (tagName.equals(<span class="string">"op"</span>)) &#123;</span><br><span class="line">            <span class="comment">//【2.2.1.1】创建一个 Op 对象，封装 op 标签的属性！</span></span><br><span class="line">            <span class="comment">// 解析 n 属性，表示 op 的类别，保存到 Op.op！</span></span><br><span class="line">            Op op = <span class="keyword">new</span> Op(uid, pkgName, Integer.parseInt(parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"n"</span>)));</span><br><span class="line">            String mode = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"m"</span>); <span class="comment">// 解析 m 属性，用于获取该 op 的 mode 情况！</span></span><br><span class="line">            <span class="keyword">if</span> (mode != <span class="keyword">null</span>) &#123;</span><br><span class="line">                op.mode = Integer.parseInt(mode);</span><br><span class="line">            &#125;</span><br><span class="line">            String time = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"t"</span>); <span class="comment">// 解析 t 属性，用于获取该 op 的授予情况！</span></span><br><span class="line">            <span class="keyword">if</span> (time != <span class="keyword">null</span>) &#123;</span><br><span class="line">                op.time = Long.parseLong(time);</span><br><span class="line">            &#125;</span><br><span class="line">            time = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"r"</span>);  <span class="comment">// 解析 r 属性，用于获取该 op 的拒绝时间！</span></span><br><span class="line">            <span class="keyword">if</span> (time != <span class="keyword">null</span>) &#123;</span><br><span class="line">                op.rejectTime = Long.parseLong(time);</span><br><span class="line">            &#125;</span><br><span class="line">            String dur = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"d"</span>);  <span class="comment">// 解析 d 属性，用于获取该 op 的时间间隔！</span></span><br><span class="line">            <span class="keyword">if</span> (dur != <span class="keyword">null</span>) &#123;</span><br><span class="line">                op.duration = Integer.parseInt(dur);</span><br><span class="line">            &#125;</span><br><span class="line">            String proxyUid = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"pu"</span>);  <span class="comment">// 解析 pu 属性，用于获取该 op 的代理 uid！</span></span><br><span class="line">            <span class="keyword">if</span> (proxyUid != <span class="keyword">null</span>) &#123;</span><br><span class="line">                op.proxyUid = Integer.parseInt(proxyUid);</span><br><span class="line">            &#125;</span><br><span class="line">            String proxyPackageName = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"pp"</span>);  <span class="comment">// 解析 pp 属性，用于获取该 op 的代理 pkg！</span></span><br><span class="line">            <span class="keyword">if</span> (proxyPackageName != <span class="keyword">null</span>) &#123;</span><br><span class="line">                op.proxyPackageName = proxyPackageName;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//【2.1.1】获得 uid 对应的 UidState 状态对象！</span></span><br><span class="line">            UidState uidState = getUidStateLocked(uid, <span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">if</span> (uidState.pkgOps == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 如果 uidState.pkgOps 为 null，初始化！</span></span><br><span class="line">                uidState.pkgOps = <span class="keyword">new</span> ArrayMap&lt;&gt;();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【2.2.1.1】从 uidState.pkgOps 获得该 package 的 Ops 集合</span></span><br><span class="line">            <span class="comment">// 如果为 null，会创建一个新的 Ops！</span></span><br><span class="line">            Ops ops = uidState.pkgOps.get(pkgName);</span><br><span class="line">            <span class="keyword">if</span> (ops == <span class="keyword">null</span>) &#123;</span><br><span class="line">                ops = <span class="keyword">new</span> Ops(pkgName, uidState, isPrivileged);</span><br><span class="line">                <span class="comment">// 将其添加到 uidState.pkgOps 中！</span></span><br><span class="line">                uidState.pkgOps.put(pkgName, ops);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 保存 op 类别和对应的控制情况！</span></span><br><span class="line">            ops.put(op.op, op);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Unknown element under &lt;pkg&gt;: "</span></span><br><span class="line">                    + parser.getName());</span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>整个过程很简单，不多说了！</p>
<h4 id="2-2-1-1-new-Op"><a href="#2-2-1-1-new-Op" class="headerlink" title="2.2.1.1 new Op"></a>2.2.1.1 new Op</h4><p>创建一个 Op 对象，封装 package 的每一个 Operation 信息！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Op</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> uid; <span class="comment">// 所属 uid</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String packageName; <span class="comment">// 所属 package</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> proxyUid = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">public</span> String proxyPackageName;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> op; <span class="comment">// 操作码，表示一个访问操作！</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> mode; <span class="comment">// 操作的控制信息！</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> duration;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">long</span> time;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">long</span> rejectTime;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> nesting;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Op</span><span class="params">(<span class="keyword">int</span> _uid, String _packageName, <span class="keyword">int</span> _op)</span> </span>&#123;</span><br><span class="line">        uid = _uid;</span><br><span class="line">        packageName = _packageName;</span><br><span class="line">        op = _op;</span><br><span class="line">        mode = AppOpsManager.opToDefaultMode(op); <span class="comment">// 计算 op 的默认控制状态！</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="3-AppOpsService-startWatchingMode"><a href="#3-AppOpsService-startWatchingMode" class="headerlink" title="3 AppOpsService.startWatchingMode"></a>3 AppOpsService.startWatchingMode</h1><p>在 AMS 的构造函数中，接着启动了对 AppOpsManager.OP_RUN_IN_BACKGROUND op 操作的监听！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mAppOpsService.startWatchingMode(AppOpsManager.OP_RUN_IN_BACKGROUND, <span class="keyword">null</span>,</span><br><span class="line">        <span class="keyword">new</span> IAppOpsCallback.Stub() &#123;</span><br><span class="line">            <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">opChanged</span><span class="params">(<span class="keyword">int</span> op, <span class="keyword">int</span> uid, String packageName)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (op == AppOpsManager.OP_RUN_IN_BACKGROUND &amp;&amp; packageName != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (mAppOpsService.checkOperation(op, uid, packageName)</span><br><span class="line">                            != AppOpsManager.MODE_ALLOWED) &#123;</span><br><span class="line">                        runInBackgroundDisabled(uid);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure></p>
<p>可以看到，这里传入了一个回调：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> IAppOpsCallback.Stub() &#123;</span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">opChanged</span><span class="params">(<span class="keyword">int</span> op, <span class="keyword">int</span> uid, String packageName)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//【1】当 op 为 AppOpsManager.OP_RUN_IN_BACKGROUND 时，并且 packageName 不为 null</span></span><br><span class="line">        <span class="comment">// 这时候会检查 packageName 是有允许在后台运行！</span></span><br><span class="line">        <span class="keyword">if</span> (op == AppOpsManager.OP_RUN_IN_BACKGROUND &amp;&amp; packageName != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//【1.1】检查是否有权限执行 op 操作，关于这部分内容，我们后面再分析！</span></span><br><span class="line">            <span class="keyword">if</span> (mAppOpsService.checkOperation(op, uid, packageName)</span><br><span class="line">                    != AppOpsManager.MODE_ALLOWED) &#123;</span><br><span class="line">                <span class="comment">//【3.2.1】如果不允许，ams 会 stop 掉该进程！</span></span><br><span class="line">                runInBackgroundDisabled(uid);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个 Callback 是一个 IAppOpsCallback.Stub 对象，用于跨进程通信，为什么是个桩对象呢？我们后面会知道！</p>
<p>op 参数表示的是要监听的 op 操作；packageName 表示要监听的具体的 package，这里传入的是 null；callback 表示当 op 操作发生改变时，要执行的回调！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startWatchingMode</span><span class="params">(<span class="keyword">int</span> op, String packageName, IAppOpsCallback callback)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (callback == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        op = (op != AppOpsManager.OP_NONE) ? AppOpsManager.opToSwitch(op) : op;</span><br><span class="line">        <span class="comment">//【×3.1】将 callback 转为 Binder 对象，封装为一个 Callback 对象，添加到 mModeWatchers 中！</span></span><br><span class="line">        Callback cb = mModeWatchers.get(callback.asBinder());</span><br><span class="line">        <span class="keyword">if</span> (cb == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 创建了一个 Callback 对象，用于监听远程 Binder 对象的死亡布告对象</span></span><br><span class="line">            <span class="comment">// 这样当 IAppOpsCallback.Stub 死亡后，可以停止监听！</span></span><br><span class="line">            cb = <span class="keyword">new</span> Callback(callback);</span><br><span class="line">            <span class="comment">// 将 IAppOpsCallback.Stub 和 Callback 的映射保存到 mModeWatchers 中！</span></span><br><span class="line">            mModeWatchers.put(callback.asBinder(), cb);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【3.2】将要监听的 op 操作和对应的监听回调 Callback 的映射关系保存到 mOpModeWatchers 中！</span></span><br><span class="line">        <span class="keyword">if</span> (op != AppOpsManager.OP_NONE) &#123;</span><br><span class="line">            ArrayList&lt;Callback&gt; cbs = mOpModeWatchers.get(op);</span><br><span class="line">            <span class="keyword">if</span> (cbs == <span class="keyword">null</span>) &#123;</span><br><span class="line">                cbs = <span class="keyword">new</span> ArrayList&lt;Callback&gt;();</span><br><span class="line">                mOpModeWatchers.put(op, cbs);</span><br><span class="line">            &#125;</span><br><span class="line">            cbs.add(cb);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【3.3】将要监听的 package 和对应的监听回调 Callback 的映射关系保存到 mPackageModeWatchers 中！</span></span><br><span class="line">        <span class="keyword">if</span> (packageName != <span class="keyword">null</span>) &#123;</span><br><span class="line">            ArrayList&lt;Callback&gt; cbs = mPackageModeWatchers.get(packageName);</span><br><span class="line">            <span class="keyword">if</span> (cbs == <span class="keyword">null</span>) &#123;</span><br><span class="line">                cbs = <span class="keyword">new</span> ArrayList&lt;Callback&gt;();</span><br><span class="line">                mPackageModeWatchers.put(packageName, cbs);</span><br><span class="line">            &#125;</span><br><span class="line">            cbs.add(cb);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>AppOpsService 内部有多个集合：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//【1】用与 IBinder 作和对应的回调 Callback 的映射关系！</span></span><br><span class="line"><span class="keyword">final</span> ArrayMap&lt;IBinder, Callback&gt; mModeWatchers</span><br><span class="line">        = <span class="keyword">new</span> ArrayMap&lt;IBinder, Callback&gt;();</span><br></pre></td></tr></table></figure></p>
<p>用于保存远程回调 IAppOpsCallback.Stub 和其对应的死亡仆告对象 Callback 的映射关系，当 IAppOpsCallback.Stub 死亡后，Callback.binderDied 会被触发，然</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//【1】用与保存 op 操作和对应的回调 Callback 的映射关系！</span></span><br><span class="line"><span class="keyword">final</span> SparseArray&lt;ArrayList&lt;Callback&gt;&gt; mOpModeWatchers</span><br><span class="line">        = <span class="keyword">new</span> SparseArray&lt;ArrayList&lt;Callback&gt;&gt;();</span><br><span class="line"><span class="comment">//【2】用与保存 package 和对应的回调 Callback 的映射关系！</span></span><br><span class="line"><span class="keyword">final</span> ArrayMap&lt;String, ArrayList&lt;Callback&gt;&gt; mPackageModeWatchers</span><br><span class="line">        = <span class="keyword">new</span> ArrayMap&lt;String, ArrayList&lt;Callback&gt;&gt;();</span><br></pre></td></tr></table></figure>
<p>而 mOpModeWatchers 和 mPackageModeWatchers 则是从不同的角度来建立监听关系：mOpModeWatchers 是从具体 op 的角度，而 mPackageModeWatchers 则是从 package 的角度！</p>
<p>可以看到 Callback 实例的作用是，作为远程回调的死亡仆告对象，用于停止监听！！</p>
<h2 id="3-1-new-Callback-死亡回调"><a href="#3-1-new-Callback-死亡回调" class="headerlink" title="3.1 new Callback - 死亡回调"></a>3.1 new Callback - 死亡回调</h2><p>我们来看下 Callback 对象的创建，同时 Callback 又是一个 DeathRecipient 对象，用来监听远程 IAppOpsCallback 桩对象是否死亡！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Callback</span> <span class="keyword">implements</span> <span class="title">DeathRecipient</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> IAppOpsCallback mCallback;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Callback</span><span class="params">(IAppOpsCallback callback)</span> </span>&#123;</span><br><span class="line">        mCallback = callback;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//【1】将自身注册为一个死亡仆告对象！</span></span><br><span class="line">            mCallback.asBinder().linkToDeath(<span class="keyword">this</span>, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unlinkToDeath</span><span class="params">()</span> </span>&#123; <span class="comment">//【2】解除注册！</span></span><br><span class="line">        mCallback.asBinder().unlinkToDeath(<span class="keyword">this</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">binderDied</span><span class="params">()</span> </span>&#123; <span class="comment">//【3.1.1】当远程桩对象死亡后，停止监听！</span></span><br><span class="line">        stopWatchingMode(mCallback);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>当远程的 IAppOpsCallback.Stub 死亡后，AppOpsService.stopWatchingMode 会被执行！</p>
<h3 id="3-1-1-AppOpsService-stopWatchingMode"><a href="#3-1-1-AppOpsService-stopWatchingMode" class="headerlink" title="3.1.1 AppOpsService.stopWatchingMode"></a>3.1.1 AppOpsService.stopWatchingMode</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stopWatchingMode</span><span class="params">(IAppOpsCallback callback)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (callback == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="comment">//【1】从 mModeWatchers 中移除 Callback！</span></span><br><span class="line">        Callback cb = mModeWatchers.remove(callback.asBinder());</span><br><span class="line">        <span class="keyword">if</span> (cb != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 解除死亡仆告对象注册！</span></span><br><span class="line">            cb.unlinkToDeath();</span><br><span class="line">            <span class="comment">//【2】从 mOpModeWatchers 移除该 Callback！</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=mOpModeWatchers.size()-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</span><br><span class="line">                ArrayList&lt;Callback&gt; cbs = mOpModeWatchers.valueAt(i);</span><br><span class="line">                cbs.remove(cb);</span><br><span class="line">                <span class="keyword">if</span> (cbs.size() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    mOpModeWatchers.removeAt(i);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【3】从 mPackageModeWatchers 移除该 Callback！</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=mPackageModeWatchers.size()-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</span><br><span class="line">                ArrayList&lt;Callback&gt; cbs = mPackageModeWatchers.valueAt(i);</span><br><span class="line">                cbs.remove(cb);</span><br><span class="line">                <span class="keyword">if</span> (cbs.size() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    mPackageModeWatchers.removeAt(i);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>流程很简单，不多说了！</p>
<h2 id="3-2-AMS-对-OP-RUN-IN-BACKGROUND-的处理"><a href="#3-2-AMS-对-OP-RUN-IN-BACKGROUND-的处理" class="headerlink" title="3.2 AMS 对 OP_RUN_IN_BACKGROUND 的处理"></a>3.2 AMS 对 OP_RUN_IN_BACKGROUND 的处理</h2><p>再次回到 AMS 的构造器中去看看：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//【1】当 op 为 AppOpsManager.OP_RUN_IN_BACKGROUND 时，并且 packageName 不为 null</span></span><br><span class="line"><span class="comment">// 这时候会检查 packageName 是有允许在后台运行！</span></span><br><span class="line"><span class="keyword">if</span> (op == AppOpsManager.OP_RUN_IN_BACKGROUND &amp;&amp; packageName != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">//【1.1】检查是否有权限执行 op 操作，关于这部分内容，我们后面再分析！</span></span><br><span class="line">    <span class="keyword">if</span> (mAppOpsService.checkOperation(op, uid, packageName)</span><br><span class="line">            != AppOpsManager.MODE_ALLOWED) &#123;</span><br><span class="line">        <span class="comment">//【3.2.1】如果不允许，ams 会 stop 掉该进程！</span></span><br><span class="line">        runInBackgroundDisabled(uid);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>AMS 中并没有监听某个具体的 package 的 op 变化，所以 packageName 传入的是 null；AMS 关心的是 AppOpsManager.OP_RUN_IN_BACKGROUND 操作的变化！</p>
<p>当有 op 发生变化后，opChanged 方法会被调用，这时 AMS 会判断如果 op 为 AppOpsManager.OP_RUN_IN_BACKGROUND，同时 packageName 不为 null；</p>
<p>这时，AMS 会调用 mAppOpsService.checkOperation 判断该应用是否允许后台运行，如果不允许，那么，会调用 runInBackgroundDisabled 方法 stop 掉进程！</p>
<h3 id="3-2-1-runInBackgroundDisabled"><a href="#3-2-1-runInBackgroundDisabled" class="headerlink" title="3.2.1 runInBackgroundDisabled"></a>3.2.1 runInBackgroundDisabled</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">runInBackgroundDisabled</span><span class="params">(<span class="keyword">int</span> uid)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        UidRecord uidRec = mActiveUids.get(uid);</span><br><span class="line">        <span class="comment">//【1】如果该 uid 仍然在运行，那么只有其处于 idle 状态才能 stop 进程！</span></span><br><span class="line">        <span class="keyword">if</span> (uidRec != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (uidRec.idle) &#123;</span><br><span class="line">                <span class="comment">//【3.2.2】stop 进程！</span></span><br><span class="line">                doStopUidLocked(uidRec.uid, uidRec);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//【2】如果 uid 不再运行，那就 stop 进程！</span></span><br><span class="line">            doStopUidLocked(uid, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-2-2-doStopUidLocked"><a href="#3-2-2-doStopUidLocked" class="headerlink" title="3.2.2 doStopUidLocked"></a>3.2.2 doStopUidLocked</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">doStopUidLocked</span><span class="params">(<span class="keyword">int</span> uid, <span class="keyword">final</span> UidRecord uidRec)</span> </span>&#123;</span><br><span class="line">    mServices.stopInBackgroundLocked(uid); <span class="comment">// stop 掉该进程！</span></span><br><span class="line">    enqueueUidChangeLocked(uidRec, uid, UidRecord.CHANGE_IDLE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里就不多说了！</p>
<h1 id="4-AppOpsService-publish-publish-到-ServiceManager-中！"><a href="#4-AppOpsService-publish-publish-到-ServiceManager-中！" class="headerlink" title="4 AppOpsService.publish - publish 到 ServiceManager 中！"></a>4 AppOpsService.publish - publish 到 ServiceManager 中！</h1><p>我们回到 ActivityManagerService 的 start 方法中去看看：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Process.removeAllProcessGroups();</span><br><span class="line">    mProcessCpuThread.start();</span><br><span class="line"></span><br><span class="line">    mBatteryStatsService.publish(mContext);</span><br><span class="line">    <span class="comment">//【1】调用了 AppOpsService 方法！</span></span><br><span class="line">    mAppOpsService.publish(mContext);</span><br><span class="line">    Slog.d(<span class="string">"AppOps"</span>, <span class="string">"AppOpsService published"</span>);</span><br><span class="line">    LocalServices.addService(ActivityManagerInternal.class, <span class="keyword">new</span> LocalService());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们来看看 AppOpsService.publish！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">publish</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    mContext = context;</span><br><span class="line">    ServiceManager.addService(Context.APP_OPS_SERVICE, asBinder());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>将自身注册进入 ServiceManager 中！</p>
<h1 id="5-AppOpsService-systemReady"><a href="#5-AppOpsService-systemReady" class="headerlink" title="5 AppOpsService.systemReady"></a>5 AppOpsService.systemReady</h1><p>我们回到 ActivityManagerService 的 systemReady 方法中去看看：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">systemReady</span><span class="params">(<span class="keyword">final</span> Runnable goingCallback)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mSystemReady) &#123;</span><br><span class="line">            <span class="comment">// If we're done calling all the receivers, run the next "boot phase" passed in</span></span><br><span class="line">            <span class="comment">// by the SystemServer</span></span><br><span class="line">            <span class="keyword">if</span> (goingCallback != <span class="keyword">null</span>) &#123;</span><br><span class="line">                goingCallback.run();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mLocalDeviceIdleController</span><br><span class="line">                = LocalServices.getService(DeviceIdleController.LocalService.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Make sure we have the current profile info, since it is needed for security checks.</span></span><br><span class="line">        mUserController.onSystemReady();</span><br><span class="line">        mRecentTasks.onSystemReadyLocked();</span><br><span class="line">        <span class="comment">//【1】调用了 mAppOpsService 的 systemReady 方法！</span></span><br><span class="line">        mAppOpsService.systemReady();</span><br><span class="line">        mSystemReady = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ... ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>去看看 mAppOpsService 的 systemReady 方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">systemReady</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">boolean</span> changed = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = mUidStates.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">            UidState uidState = mUidStates.valueAt(i);</span><br><span class="line">            <span class="comment">//【×5.1】获取属于该 uid 的所有 PacakgeName！</span></span><br><span class="line">            String[] packageNames = getPackagesForUid(uidState.uid);</span><br><span class="line">            <span class="keyword">if</span> (ArrayUtils.isEmpty(packageNames)) &#123;</span><br><span class="line">                <span class="comment">//【1】如果属于该 uid 的 package 为 null，从 mUidStates 中移除！</span></span><br><span class="line">                uidState.clear();</span><br><span class="line">                mUidStates.removeAt(i);</span><br><span class="line">                changed = <span class="keyword">true</span>;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果 uidState.pkgOps 为 null，跳过！</span></span><br><span class="line">            ArrayMap&lt;String, Ops&gt; pkgs = uidState.pkgOps;</span><br><span class="line">            <span class="keyword">if</span> (pkgs == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【2】我们知道 uidState.pkgOps 保存了该 uid 下所有的 package 的 op 信息！</span></span><br><span class="line">            Iterator&lt;Ops&gt; it = pkgs.values().iterator();</span><br><span class="line">            <span class="keyword">while</span> (it.hasNext()) &#123; <span class="comment">// 遍历每一个 package 的 Op 信息！</span></span><br><span class="line">                Ops ops = it.next();</span><br><span class="line">                <span class="keyword">int</span> curUid = -<span class="number">1</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">//【2.1】首先，通过包名获得 package 的 uid！</span></span><br><span class="line">                    curUid = AppGlobals.getPackageManager().getPackageUid(ops.packageName,</span><br><span class="line">                            PackageManager.MATCH_UNINSTALLED_PACKAGES,</span><br><span class="line">                            UserHandle.getUserId(ops.uidState.uid));</span><br><span class="line">                &#125; <span class="keyword">catch</span> (RemoteException ignored) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//【2.2】然后和 op 所属的 uid 进行比较，如果不相等，说明 package 信息发生了变化！</span></span><br><span class="line">                <span class="comment">// 移除旧的 Ops 集合！</span></span><br><span class="line">                <span class="keyword">if</span> (curUid != ops.uidState.uid) &#123;</span><br><span class="line">                    Slog.i(TAG, <span class="string">"Pruning old package "</span> + ops.packageName</span><br><span class="line">                            + <span class="string">"/"</span> + ops.uidState + <span class="string">": new uid="</span> + curUid);</span><br><span class="line">                    it.remove();</span><br><span class="line">                    changed = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (uidState.isDefault()) &#123; </span><br><span class="line">                <span class="comment">//【3】移除那些没有对应 Package 和 Ops 的 UidState！</span></span><br><span class="line">                mUidStates.removeAt(i);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (changed) &#123; </span><br><span class="line">            <span class="comment">//【5.2】如果 changed 为 true，表示 UidState，或者 Ops 发生了变化，更新本地持久化文件！</span></span><br><span class="line">            scheduleFastWriteLocked();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    MountServiceInternal mountServiceInternal = LocalServices.getService(</span><br><span class="line">            MountServiceInternal.class);</span><br><span class="line">    mountServiceInternal.addExternalStoragePolicy(</span><br><span class="line">            <span class="keyword">new</span> MountServiceInternal.ExternalStorageMountPolicy() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getMountMode</span><span class="params">(<span class="keyword">int</span> uid, String packageName)</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">if</span> (Process.isIsolated(uid)) &#123;</span><br><span class="line">                        <span class="keyword">return</span> Zygote.MOUNT_EXTERNAL_NONE;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (noteOperation(AppOpsManager.OP_READ_EXTERNAL_STORAGE, uid,</span><br><span class="line">                            packageName) != AppOpsManager.MODE_ALLOWED) &#123;</span><br><span class="line">                        <span class="keyword">return</span> Zygote.MOUNT_EXTERNAL_NONE;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (noteOperation(AppOpsManager.OP_WRITE_EXTERNAL_STORAGE, uid,</span><br><span class="line">                            packageName) != AppOpsManager.MODE_ALLOWED) &#123;</span><br><span class="line">                        <span class="keyword">return</span> Zygote.MOUNT_EXTERNAL_READ;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> Zygote.MOUNT_EXTERNAL_WRITE;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasExternalStorage</span><span class="params">(<span class="keyword">int</span> uid, String packageName)</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">int</span> mountMode = getMountMode(uid, packageName);</span><br><span class="line">                    <span class="keyword">return</span> mountMode == Zygote.MOUNT_EXTERNAL_READ</span><br><span class="line">                            || mountMode == Zygote.MOUNT_EXTERNAL_WRITE;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="5-1-getPackagesForUid"><a href="#5-1-getPackagesForUid" class="headerlink" title="5.1 getPackagesForUid"></a>5.1 getPackagesForUid</h2><p>获取 uid 所有的 package：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> String[] getPackagesForUid(<span class="keyword">int</span> uid) &#123;</span><br><span class="line">    String[] packageNames = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        packageNames = AppGlobals.getPackageManager().getPackagesForUid(uid);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="comment">/* ignore - local call */</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (packageNames == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> EmptyArray.STRING;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> packageNames;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以数组形式放回！</p>
<h2 id="5-2-scheduleFastWriteLocked"><a href="#5-2-scheduleFastWriteLocked" class="headerlink" title="5.2 scheduleFastWriteLocked"></a>5.2 scheduleFastWriteLocked</h2><p>更新本地的持久化文件！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">scheduleFastWriteLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!mFastWriteScheduled) &#123;</span><br><span class="line">        mWriteScheduled = <span class="keyword">true</span>;</span><br><span class="line">        mFastWriteScheduled = <span class="keyword">true</span>;</span><br><span class="line">        mHandler.removeCallbacks(mWriteRunner);</span><br><span class="line">        mHandler.postDelayed(mWriteRunner, <span class="number">10</span>*<span class="number">1000</span>); <span class="comment">// </span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里的 mHandler 是由 AMS 创建的一个子线程的 Handler！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Runnable mWriteRunner = <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (AppOpsService.<span class="keyword">this</span>) &#123;</span><br><span class="line">            mWriteScheduled = <span class="keyword">false</span>;</span><br><span class="line">            mFastWriteScheduled = <span class="keyword">false</span>;</span><br><span class="line">            <span class="comment">//【1】创建一个 AsyncTask 异步任务对象！</span></span><br><span class="line">            AsyncTask&lt;Void, Void, Void&gt; task = <span class="keyword">new</span> AsyncTask&lt;Void, Void, Void&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span> <span class="function"><span class="keyword">protected</span> Void <span class="title">doInBackground</span><span class="params">(Void... params)</span> </span>&#123;</span><br><span class="line">                    <span class="comment">//【5.3】writeState 更新持久化文件！</span></span><br><span class="line">                    writeState();</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="comment">//【2】执行任务！</span></span><br><span class="line">            task.executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR, (Void[])<span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>继续来看！！</p>
<h2 id="5-3-writeState"><a href="#5-3-writeState" class="headerlink" title="5.3 writeState"></a>5.3 writeState</h2><p>我们来看下，如何更新持久化文件！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">writeState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mFile) &#123;</span><br><span class="line">        <span class="comment">//【5.2.1】获得所有 package 的 Op 信息！</span></span><br><span class="line">        List&lt;AppOpsManager.PackageOps&gt; allOps = getPackagesForOps(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        FileOutputStream stream;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            stream = mFile.startWrite();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Failed to write state: "</span> + e);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            XmlSerializer out = <span class="keyword">new</span> FastXmlSerializer();</span><br><span class="line">            out.setOutput(stream, StandardCharsets.UTF_8.name());</span><br><span class="line">            out.startDocument(<span class="keyword">null</span>, <span class="keyword">true</span>);</span><br><span class="line">            out.startTag(<span class="keyword">null</span>, <span class="string">"app-ops"</span>); <span class="comment">//【1】写入 app-ops 标签！</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> uidStateCount = mUidStates.size();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; uidStateCount; i++) &#123; <span class="comment">//【2】首先写入 uid 标签！</span></span><br><span class="line">                UidState uidState = mUidStates.valueAt(i);</span><br><span class="line">                <span class="keyword">if</span> (uidState.opModes != <span class="keyword">null</span> &amp;&amp; uidState.opModes.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    out.startTag(<span class="keyword">null</span>, <span class="string">"uid"</span>);</span><br><span class="line">                    out.attribute(<span class="keyword">null</span>, <span class="string">"n"</span>, Integer.toString(uidState.uid)); <span class="comment">//【2.1】写入 n 属性！</span></span><br><span class="line">                    SparseIntArray uidOpModes = uidState.opModes;</span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">int</span> opCount = uidOpModes.size();</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; opCount; j++) &#123;</span><br><span class="line">                        <span class="keyword">final</span> <span class="keyword">int</span> op = uidOpModes.keyAt(j);</span><br><span class="line">                        <span class="keyword">final</span> <span class="keyword">int</span> mode = uidOpModes.valueAt(j);</span><br><span class="line">                        out.startTag(<span class="keyword">null</span>, <span class="string">"op"</span>); <span class="comment">//【2.2】写入 op 子标签，和对应的 n，m 属性！</span></span><br><span class="line">                        out.attribute(<span class="keyword">null</span>, <span class="string">"n"</span>, Integer.toString(op));</span><br><span class="line">                        out.attribute(<span class="keyword">null</span>, <span class="string">"m"</span>, Integer.toString(mode));</span><br><span class="line">                        out.endTag(<span class="keyword">null</span>, <span class="string">"op"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    out.endTag(<span class="keyword">null</span>, <span class="string">"uid"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (allOps != <span class="keyword">null</span>) &#123; <span class="comment">// 如果 allOps 不为 null，那就开始写入 pkg 标签！</span></span><br><span class="line">                String lastPkg = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;allOps.size(); i++) &#123;</span><br><span class="line">                    AppOpsManager.PackageOps pkg = allOps.get(i);</span><br><span class="line">                    <span class="keyword">if</span> (!pkg.getPackageName().equals(lastPkg)) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (lastPkg != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            out.endTag(<span class="keyword">null</span>, <span class="string">"pkg"</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        lastPkg = pkg.getPackageName();</span><br><span class="line">                        out.startTag(<span class="keyword">null</span>, <span class="string">"pkg"</span>); <span class="comment">// 写入 pkg 标签</span></span><br><span class="line">                        out.attribute(<span class="keyword">null</span>, <span class="string">"n"</span>, lastPkg); <span class="comment">// 写入 n 属性，包名</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    out.startTag(<span class="keyword">null</span>, <span class="string">"uid"</span>); <span class="comment">// 写入 uid 子标签</span></span><br><span class="line">                    out.attribute(<span class="keyword">null</span>, <span class="string">"n"</span>, Integer.toString(pkg.getUid())); <span class="comment">// 写入 n 属性，uid 的值</span></span><br><span class="line">                    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">                        Ops ops = getOpsRawLocked(pkg.getUid(), pkg.getPackageName(), <span class="keyword">false</span>);</span><br><span class="line">                        <span class="comment">// 写入 p 属性，表示是否是 Privileged！</span></span><br><span class="line">                        <span class="keyword">if</span> (ops != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            out.attribute(<span class="keyword">null</span>, <span class="string">"p"</span>, Boolean.toString(ops.isPrivileged));</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            out.attribute(<span class="keyword">null</span>, <span class="string">"p"</span>, Boolean.toString(<span class="keyword">false</span>));</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    List&lt;AppOpsManager.OpEntry&gt; ops = pkg.getOps(); <span class="comment">// 处理该 package 的 Ops！</span></span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> j=<span class="number">0</span>; j&lt;ops.size(); j++) &#123;</span><br><span class="line">                        AppOpsManager.OpEntry op = ops.get(j);</span><br><span class="line">                        out.startTag(<span class="keyword">null</span>, <span class="string">"op"</span>); <span class="comment">// 写入 op 标签；</span></span><br><span class="line">                        out.attribute(<span class="keyword">null</span>, <span class="string">"n"</span>, Integer.toString(op.getOp())); <span class="comment">// 写入 n 属性，op 码；</span></span><br><span class="line">                        <span class="comment">// 写入 m 属性，表示控制状态，这里先调用了 AppOpsManager.opToDefaultMode 来计算下</span></span><br><span class="line">                        <span class="comment">// 默认的控制状态。如果 op 的控制状态不等于默认值才会写入！</span></span><br><span class="line">                        <span class="keyword">if</span> (op.getMode() != AppOpsManager.opToDefaultMode(op.getOp())) &#123;</span><br><span class="line">                            out.attribute(<span class="keyword">null</span>, <span class="string">"m"</span>, Integer.toString(op.getMode()));</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// 写入 t 属性！</span></span><br><span class="line">                        <span class="keyword">long</span> time = op.getTime();</span><br><span class="line">                        <span class="keyword">if</span> (time != <span class="number">0</span>) &#123;</span><br><span class="line">                            out.attribute(<span class="keyword">null</span>, <span class="string">"t"</span>, Long.toString(time));</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// 写入 r 属性！                            </span></span><br><span class="line">                        time = op.getRejectTime();</span><br><span class="line">                        <span class="keyword">if</span> (time != <span class="number">0</span>) &#123;</span><br><span class="line">                            out.attribute(<span class="keyword">null</span>, <span class="string">"r"</span>, Long.toString(time));</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// 写入 d 属性！                               </span></span><br><span class="line">                        <span class="keyword">int</span> dur = op.getDuration();</span><br><span class="line">                        <span class="keyword">if</span> (dur != <span class="number">0</span>) &#123;</span><br><span class="line">                            out.attribute(<span class="keyword">null</span>, <span class="string">"d"</span>, Integer.toString(dur));</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// 写入 pu 属性！                               </span></span><br><span class="line">                        <span class="keyword">int</span> proxyUid = op.getProxyUid();</span><br><span class="line">                        <span class="keyword">if</span> (proxyUid != -<span class="number">1</span>) &#123;</span><br><span class="line">                            out.attribute(<span class="keyword">null</span>, <span class="string">"pu"</span>, Integer.toString(proxyUid));</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// 写入 pp 属性！   </span></span><br><span class="line">                        String proxyPackageName = op.getProxyPackageName();</span><br><span class="line">                        <span class="keyword">if</span> (proxyPackageName != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            out.attribute(<span class="keyword">null</span>, <span class="string">"pp"</span>, proxyPackageName);</span><br><span class="line">                        &#125;</span><br><span class="line">                        out.endTag(<span class="keyword">null</span>, <span class="string">"op"</span>); </span><br><span class="line">                    &#125;</span><br><span class="line">                    out.endTag(<span class="keyword">null</span>, <span class="string">"uid"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (lastPkg != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    out.endTag(<span class="keyword">null</span>, <span class="string">"pkg"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            out.endTag(<span class="keyword">null</span>, <span class="string">"app-ops"</span>);</span><br><span class="line">            out.endDocument();</span><br><span class="line">            mFile.finishWrite(stream);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Failed to write state, restoring backup."</span>, e);</span><br><span class="line">            mFile.failWrite(stream);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>writeState 的流程还是很简单的！</p>
<h3 id="5-3-1-getPackagesForOps"><a href="#5-3-1-getPackagesForOps" class="headerlink" title="5.3.1 getPackagesForOps"></a>5.3.1 getPackagesForOps</h3><p>该方法用于获得所有 package 的 Op 信息，参数 ops 表示只收集其指定的 op 信息！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;AppOpsManager.PackageOps&gt; getPackagesForOps(<span class="keyword">int</span>[] ops) &#123;</span><br><span class="line">    <span class="comment">//【1】首先，强制检查调用者是否有 GET_APP_OPS_STATS 权限！</span></span><br><span class="line">    mContext.enforcePermission(android.Manifest.permission.GET_APP_OPS_STATS,</span><br><span class="line">            Binder.getCallingPid(), Binder.getCallingUid(), <span class="keyword">null</span>);</span><br><span class="line">    ArrayList&lt;AppOpsManager.PackageOps&gt; res = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> uidStateCount = mUidStates.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; uidStateCount; i++) &#123;</span><br><span class="line">            UidState uidState = mUidStates.valueAt(i);</span><br><span class="line">            <span class="keyword">if</span> (uidState.pkgOps == <span class="keyword">null</span> || uidState.pkgOps.isEmpty()) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【1.1】首先，获得 uidState.pkgOps 中保存的该 uid 下，所有的 package 的 Ops！</span></span><br><span class="line">            ArrayMap&lt;String, Ops&gt; packages = uidState.pkgOps;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> packageCount = packages.size();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; packageCount; j++) &#123;</span><br><span class="line">                <span class="comment">//【1.2】处理每一个 package 的 Ops！</span></span><br><span class="line">                Ops pkgOps = packages.valueAt(j); </span><br><span class="line">                <span class="comment">//【5.3.1.1】调用 collectOps 方法,收集 package 的 Op 信息，封装为 OpEntry 对象！！</span></span><br><span class="line">                ArrayList&lt;AppOpsManager.OpEntry&gt; resOps = collectOps(pkgOps, ops);</span><br><span class="line">                <span class="keyword">if</span> (resOps != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (res == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        res = <span class="keyword">new</span> ArrayList&lt;AppOpsManager.PackageOps&gt;();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//【5.3.1.2】创建一个 PackageOps 对象，封装该 package 的所有 Op 信息</span></span><br><span class="line">                    <span class="comment">// 最后添加到 res 列表中！</span></span><br><span class="line">                    AppOpsManager.PackageOps resPackage = <span class="keyword">new</span> AppOpsManager.PackageOps(</span><br><span class="line">                            pkgOps.packageName, pkgOps.uidState.uid, resOps);</span><br><span class="line">                    res.add(resPackage);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 返回列表！</span></span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5-3-1-1-collectOps"><a href="#5-3-1-1-collectOps" class="headerlink" title="5.3.1.1 collectOps"></a>5.3.1.1 collectOps</h4><p>参数 int[] ops 用于指定特定的 Op，这样我们会只收集这些特定的 Ops，当然这里我们要收集所有 package 的 Op 信息，所以 int[] ops 传入 null；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> ArrayList&lt;AppOpsManager.OpEntry&gt; collectOps(Ops pkgOps, <span class="keyword">int</span>[] ops) &#123;</span><br><span class="line">    ArrayList&lt;AppOpsManager.OpEntry&gt; resOps = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (ops == <span class="keyword">null</span>) &#123; <span class="comment">//【1】ops 为 null，我们收集该 package 的所有 Ops！</span></span><br><span class="line">        resOps = <span class="keyword">new</span> ArrayList&lt;AppOpsManager.OpEntry&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j=<span class="number">0</span>; j&lt;pkgOps.size(); j++) &#123;</span><br><span class="line">            Op curOp = pkgOps.valueAt(j); <span class="comment">// 处理每一个 Op 对象！</span></span><br><span class="line">            <span class="comment">//【5.3.1.1.1】创建一个  AppOpsManager.OpEntry 对象，并添加到 resOps 中！</span></span><br><span class="line">            resOps.add(<span class="keyword">new</span> AppOpsManager.OpEntry(curOp.op, curOp.mode, curOp.time,</span><br><span class="line">                    curOp.rejectTime, curOp.duration, curOp.proxyUid,</span><br><span class="line">                    curOp.proxyPackageName));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j=<span class="number">0</span>; j&lt;ops.length; j++) &#123;</span><br><span class="line">            Op curOp = pkgOps.get(ops[j]);</span><br><span class="line">            <span class="keyword">if</span> (curOp != <span class="keyword">null</span>) &#123; <span class="comment">//【2】ops 不为 null，我们收集数组 ops 指定的 Op！</span></span><br><span class="line">                <span class="keyword">if</span> (resOps == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    resOps = <span class="keyword">new</span> ArrayList&lt;AppOpsManager.OpEntry&gt;();</span><br><span class="line">                &#125;</span><br><span class="line">                resOps.add(<span class="keyword">new</span> AppOpsManager.OpEntry(curOp.op, curOp.mode, curOp.time,</span><br><span class="line">                        curOp.rejectTime, curOp.duration, curOp.proxyUid,</span><br><span class="line">                        curOp.proxyPackageName));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【3】返回 resOps</span></span><br><span class="line">    <span class="keyword">return</span> resOps;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>collectOps 方法很简单，不多说了！</p>
<h5 id="5-3-1-1-1-new-AppOpsManager-OpEntry"><a href="#5-3-1-1-1-new-AppOpsManager-OpEntry" class="headerlink" title="5.3.1.1.1 new AppOpsManager.OpEntry"></a>5.3.1.1.1 new AppOpsManager.OpEntry</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">OpEntry</span> <span class="keyword">implements</span> <span class="title">Parcelable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> mOp;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> mMode;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> mTime;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> mRejectTime;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> mDuration;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> mProxyUid;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String mProxyPackageName;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OpEntry</span><span class="params">(<span class="keyword">int</span> op, <span class="keyword">int</span> mode, <span class="keyword">long</span> time, <span class="keyword">long</span> rejectTime, <span class="keyword">int</span> duration,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> proxyUid, String proxyPackage)</span> </span>&#123;</span><br><span class="line">        mOp = op;</span><br><span class="line">        mMode = mode;</span><br><span class="line">        mTime = time;</span><br><span class="line">        mRejectTime = rejectTime;</span><br><span class="line">        mDuration = duration;</span><br><span class="line">        mProxyUid = proxyUid;</span><br><span class="line">        mProxyPackageName = proxyPackage;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ... ... ... ...<span class="comment">// 省略 get 和 set，以及 Parcelable 相关方法！</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>OpEntry 的结构很简单，不多说了！</p>
<h4 id="5-3-1-2-new-AppOpsManager-PackageOps"><a href="#5-3-1-2-new-AppOpsManager-PackageOps" class="headerlink" title="5.3.1.2 new AppOpsManager.PackageOps"></a>5.3.1.2 new AppOpsManager.PackageOps</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">PackageOps</span> <span class="keyword">implements</span> <span class="title">Parcelable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String mPackageName; <span class="comment">// package </span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> mUid; <span class="comment">// uid </span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;OpEntry&gt; mEntries; <span class="comment">// 持有的所有 Op 对应的 OpEntry 对象！</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PackageOps</span><span class="params">(String packageName, <span class="keyword">int</span> uid, List&lt;OpEntry&gt; entries)</span> </span>&#123;</span><br><span class="line">        mPackageName = packageName;</span><br><span class="line">        mUid = uid;</span><br><span class="line">        mEntries = entries;</span><br><span class="line">    &#125;</span><br><span class="line">    ... ... ... ...<span class="comment">// 省略 get 和 set，以及 Parcelable 相关方法！</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>PackageOps 的结构很简单，不多说了！</p>
<h3 id="5-3-2-getOpsRawLocked"><a href="#5-3-2-getOpsRawLocked" class="headerlink" title="5.3.2 getOpsRawLocked"></a>5.3.2 getOpsRawLocked</h3><p>getOpsRawLocked 方法用于获得 package 的 Ops 列表！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Ops <span class="title">getOpsRawLocked</span><span class="params">(<span class="keyword">int</span> uid, String packageName, <span class="keyword">boolean</span> edit)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】获得 uid 对应的 UidState！</span></span><br><span class="line">    UidState uidState = getUidStateLocked(uid, edit);</span><br><span class="line">    <span class="keyword">if</span> (uidState == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (uidState.pkgOps == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!edit) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        uidState.pkgOps = <span class="keyword">new</span> ArrayMap&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】获得 package 对应的 Ops 集合！</span></span><br><span class="line">    Ops ops = uidState.pkgOps.get(packageName);</span><br><span class="line">    <span class="keyword">if</span> (ops == <span class="keyword">null</span>) &#123; <span class="comment">// 处理 package 的 ops 为 null 的特殊情况！</span></span><br><span class="line">        <span class="keyword">if</span> (!edit) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">boolean</span> isPrivileged = <span class="keyword">false</span>;</span><br><span class="line">        <span class="comment">//【3】如果 uid 不为 null，需要校验 uid 是否一致！</span></span><br><span class="line">        <span class="keyword">if</span> (uid != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> ident = Binder.clearCallingIdentity();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">int</span> pkgUid = -<span class="number">1</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">//【3.1】获得该 package 的 ApplicationInfo 对象！</span></span><br><span class="line">                    ApplicationInfo appInfo = ActivityThread.getPackageManager()</span><br><span class="line">                            .getApplicationInfo(packageName,</span><br><span class="line">                                    PackageManager.MATCH_DEBUG_TRIAGED_MISSING,</span><br><span class="line">                                    UserHandle.getUserId(uid));</span><br><span class="line">                    <span class="comment">//【3.2】获得 package 的 uid，并判断是否是 FLAG_PRIVILEGED 的！</span></span><br><span class="line">                    <span class="keyword">if</span> (appInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        pkgUid = appInfo.uid;</span><br><span class="line">                        isPrivileged = (appInfo.privateFlags</span><br><span class="line">                                &amp; ApplicationInfo.PRIVATE_FLAG_PRIVILEGED) != <span class="number">0</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">// 如果 appInfo 为 null，那就判断一些特殊 uid 的情况！</span></span><br><span class="line">                        <span class="keyword">if</span> (<span class="string">"media"</span>.equals(packageName)) &#123;</span><br><span class="line">                            pkgUid = Process.MEDIA_UID;</span><br><span class="line">                            isPrivileged = <span class="keyword">false</span>;</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"audioserver"</span>.equals(packageName)) &#123;</span><br><span class="line">                            pkgUid = Process.AUDIOSERVER_UID;</span><br><span class="line">                            isPrivileged = <span class="keyword">false</span>;</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"cameraserver"</span>.equals(packageName)) &#123;</span><br><span class="line">                            pkgUid = Process.CAMERASERVER_UID;</span><br><span class="line">                            isPrivileged = <span class="keyword">false</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"Could not contact PackageManager"</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//【3.3】检查 uid 是否发生变化，如果有变化，无效，那就返回 null！</span></span><br><span class="line">                <span class="keyword">if</span> (pkgUid != uid) &#123;</span><br><span class="line">                    RuntimeException ex = <span class="keyword">new</span> RuntimeException(<span class="string">"here"</span>);</span><br><span class="line">                    ex.fillInStackTrace();</span><br><span class="line">                    Slog.w(TAG, <span class="string">"Bad call: specified package "</span> + packageName</span><br><span class="line">                            + <span class="string">" under uid "</span> + uid + <span class="string">" but it is really "</span> + pkgUid, ex);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                Binder.restoreCallingIdentity(ident);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【4】如果该 package 的 Ops 为 null，那就会</span></span><br><span class="line">        <span class="comment">// 给该 package 重新创建一个 Ops，并添加到所属的 uidState.pkgOps 中！</span></span><br><span class="line">        ops = <span class="keyword">new</span> Ops(packageName, uidState, isPrivileged);</span><br><span class="line">        uidState.pkgOps.put(packageName, ops);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ops; <span class="comment">// 返回该 package 的 Ops 列表！</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>方法很简单，不多说了！</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2017/07/25/AlarmManager第 2 篇 - set Alarm 流程分析/">AlarmManager第 2 篇 - set Alarm 流程分析</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2017-07-25</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/AndroidFramework源码分析/">AndroidFramework源码分析</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/AndroidFramework源码分析/AlarmManager闹钟管理/">AlarmManager闹钟管理</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/AlarmManager闹钟管理/">AlarmManager闹钟管理</a></span><div class="content"><p>[toc]</p>
<p>基于 Android 7.1.1 源码，分析 AlarmManagerService 的机制</p>
<h1 id="0-综述"><a href="#0-综述" class="headerlink" title="0 综述"></a>0 综述</h1><p>下面是设置精确 alarm 的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setGlobalNoticeDialogForceShowAlarm</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    Intent intent = <span class="keyword">new</span> Intent(<span class="string">"com.coolqi.alarm_start"</span>);</span><br><span class="line">    PendingIntent pi = PendingIntent.getBroadcast(context, <span class="number">0</span>, intent, <span class="number">0</span>);</span><br><span class="line">    AlarmManager alarmManager = (AlarmManager) context.getSystemService(Context.ALARM_SERVICE);</span><br><span class="line">    alarmManager.cancel(pi);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> timeHour = <span class="number">2</span>*<span class="number">24</span>*<span class="number">60</span>*<span class="number">60</span>;<span class="comment">// two days</span></span><br><span class="line"></span><br><span class="line">    OppoLog.d(TAG, <span class="string">"show global time: "</span> + timeHour);</span><br><span class="line">    <span class="keyword">long</span> triggerTime = CommonUtil.getTriggerTime(System.currentTimeMillis(), timeHour);</span><br><span class="line">    alarmManager.setExact(AlarmManager.RTC_WAKEUP, triggerTime, pi);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="1-AlarmManager-setAlarm"><a href="#1-AlarmManager-setAlarm" class="headerlink" title="1 AlarmManager.setAlarm"></a>1 AlarmManager.setAlarm</h1><p>AlarmManagerSerivce 提供了很丰富的接口来设置不同类型的 alarm，可以通过 AlarmManager.java 来看到所有的接口：</p>
<h2 id="1-1-AlarmManager-set"><a href="#1-1-AlarmManager-set" class="headerlink" title="1.1 AlarmManager.set"></a>1.1 AlarmManager.set</h2><p>set 接口用于设置一个一次性的闹钟，该闹钟是非精确的，我们需要传入一个 triggerAtMillis 毫秒值被表示闹钟触发的时间点！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(@AlarmType <span class="keyword">int</span> type, <span class="keyword">long</span> triggerAtMillis, PendingIntent operation)</span> </span>&#123;</span><br><span class="line">    setImpl(type, triggerAtMillis, legacyExactLength(), <span class="number">0</span>, <span class="number">0</span>, operation, <span class="keyword">null</span>, <span class="keyword">null</span>,</span><br><span class="line">            <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个 set 方法最常用：第一个参数是 alarm 的类型，第二个是触发时间，第三个是 PendingIntent，用于启动 Service，activity，或者是 broadcastReceiver！</p>
<p>可以实现跨进程，即：设置该 alarm 的进程和处理 alarm 触发的进程可以不是同一个！</p>
<p><strong>参数传递</strong>：</p>
<ul>
<li><strong>int type</strong>：闹钟类型 type；</li>
<li><strong>long triggerAtMillis</strong>：触发时间，单位毫秒；</li>
<li><strong>long windowMillis</strong>：legacyExactLength()，API 19 以后返回值为 WINDOW_HEURISTIC，即 -1；</li>
<li><strong>long intervalMillis</strong>：0；</li>
<li><strong>int flags</strong>：0；</li>
<li><strong>PendingIntent operation</strong>：operation；</li>
<li><strong>final OnAlarmListener listener</strong>：null；</li>
<li><strong>String listenerTag</strong>：null；</li>
<li><strong>Handler targetHandler</strong>：null；</li>
<li><strong>WorkSource workSource</strong>：null；</li>
<li><strong>AlarmClockInfo alarmCloc</strong>：null；</li>
</ul>
<p><br></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(@AlarmType <span class="keyword">int</span> type, <span class="keyword">long</span> triggerAtMillis, String tag, OnAlarmListener listener,</span></span></span><br><span class="line"><span class="function"><span class="params">        Handler targetHandler)</span> </span>&#123;</span><br><span class="line">    setImpl(type, triggerAtMillis, legacyExactLength(), <span class="number">0</span>, <span class="number">0</span>, <span class="keyword">null</span>, listener, tag,</span><br><span class="line">            targetHandler, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个 set 方法并不适用于跨进程通信，其需要传入一个实现了 OnAlarmListener 接口的对象用于监听 alarm 的触发，当 alarm 触发后，OnAlarmListener 的会被 onAlarm() 执行！</p>
<p>targetHandler 表示的是 OnAlarmListener.onAlarm 执行时，目标线程的 handler 对象！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="meta">@SystemApi</span></span><br><span class="line"><span class="meta">@RequiresPermission</span>(android.Manifest.permission.UPDATE_DEVICE_STATS)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(@AlarmType <span class="keyword">int</span> type, <span class="keyword">long</span> triggerAtMillis, <span class="keyword">long</span> windowMillis,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">long</span> intervalMillis, PendingIntent operation, WorkSource workSource)</span> </span>&#123;</span><br><span class="line">    setImpl(type, triggerAtMillis, windowMillis, intervalMillis, <span class="number">0</span>, operation, <span class="keyword">null</span>, <span class="keyword">null</span>,</span><br><span class="line">            <span class="keyword">null</span>, workSource, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(@AlarmType <span class="keyword">int</span> type, <span class="keyword">long</span> triggerAtMillis, <span class="keyword">long</span> windowMillis,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">long</span> intervalMillis, String tag, OnAlarmListener listener, Handler targetHandler,</span></span></span><br><span class="line"><span class="function"><span class="params">        WorkSource workSource)</span> </span>&#123;</span><br><span class="line">    setImpl(type, triggerAtMillis, windowMillis, intervalMillis, <span class="number">0</span>, <span class="keyword">null</span>, listener, tag,</span><br><span class="line">            targetHandler, workSource, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SystemApi</span></span><br><span class="line"><span class="meta">@RequiresPermission</span>(android.Manifest.permission.UPDATE_DEVICE_STATS)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(@AlarmType <span class="keyword">int</span> type, <span class="keyword">long</span> triggerAtMillis, <span class="keyword">long</span> windowMillis,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">long</span> intervalMillis, OnAlarmListener listener, Handler targetHandler,</span></span></span><br><span class="line"><span class="function"><span class="params">        WorkSource workSource)</span> </span>&#123;</span><br><span class="line">    setImpl(type, triggerAtMillis, windowMillis, intervalMillis, <span class="number">0</span>, <span class="keyword">null</span>, listener, <span class="keyword">null</span>,</span><br><span class="line">            targetHandler, workSource, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>set 方法设置的 alarm <strong>是非精确的</strong>！</p>
<h2 id="1-2-AlarmManager-setExact"><a href="#1-2-AlarmManager-setExact" class="headerlink" title="1.2 AlarmManager.setExact"></a>1.2 AlarmManager.setExact</h2><p>用于设置一个精确的闹钟，该方法是相对于 set 方法的，参数和 set 方法一样，不多说，也有 2 个方法！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setExact</span><span class="params">(@AlarmType <span class="keyword">int</span> type, <span class="keyword">long</span> triggerAtMillis, PendingIntent operation)</span> </span>&#123;</span><br><span class="line">    setImpl(type, triggerAtMillis, WINDOW_EXACT, <span class="number">0</span>, <span class="number">0</span>, operation, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>,</span><br><span class="line">            <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setExact</span><span class="params">(@AlarmType <span class="keyword">int</span> type, <span class="keyword">long</span> triggerAtMillis, String tag,</span></span></span><br><span class="line"><span class="function"><span class="params">        OnAlarmListener listener, Handler targetHandler)</span> </span>&#123;</span><br><span class="line">    setImpl(type, triggerAtMillis, WINDOW_EXACT, <span class="number">0</span>, <span class="number">0</span>, <span class="keyword">null</span>, listener, tag,</span><br><span class="line">            targetHandler, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不多说了！！</p>
<h2 id="1-3-AlarmManager-setWindow"><a href="#1-3-AlarmManager-setWindow" class="headerlink" title="1.3 AlarmManager.setWindow"></a>1.3 AlarmManager.setWindow</h2><p>用于设置一个在给定的时间窗触发的闹钟。该方法允许应用程序精确地控制操作系统调整闹钟触发时间的程度。</p>
<p>其中，windowStartMillis 表示时间窗的起始时间！windowStartMillis 表示时间窗的长度，其他参数和 set 方法一样！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setWindow</span><span class="params">(@AlarmType <span class="keyword">int</span> type, <span class="keyword">long</span> windowStartMillis, <span class="keyword">long</span> windowLengthMillis,</span></span></span><br><span class="line"><span class="function"><span class="params">        PendingIntent operation)</span> </span>&#123;</span><br><span class="line">    setImpl(type, windowStartMillis, windowLengthMillis, <span class="number">0</span>, <span class="number">0</span>, operation,</span><br><span class="line">            <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setWindow</span><span class="params">(@AlarmType <span class="keyword">int</span> type, <span class="keyword">long</span> windowStartMillis, <span class="keyword">long</span> windowLengthMillis,</span></span></span><br><span class="line"><span class="function"><span class="params">        String tag, OnAlarmListener listener, Handler targetHandler)</span> </span>&#123;</span><br><span class="line">    setImpl(type, windowStartMillis, windowLengthMillis, <span class="number">0</span>, <span class="number">0</span>, <span class="keyword">null</span>, listener, tag,</span><br><span class="line">            targetHandler, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>setWindow 设置的是<strong>非精确</strong>的闹钟！</p>
<h2 id="1-4-AlarmManager-setXXXRepeating"><a href="#1-4-AlarmManager-setXXXRepeating" class="headerlink" title="1.4 AlarmManager.setXXXRepeating"></a>1.4 AlarmManager.setXXXRepeating</h2><p>setRepeating 和 setInexactRepeating 用于设置一个可重复触发的闹钟，但是二者却有着不同：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setRepeating</span><span class="params">(@AlarmType <span class="keyword">int</span> type, <span class="keyword">long</span> triggerAtMillis,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">long</span> intervalMillis, PendingIntent operation)</span> </span>&#123;</span><br><span class="line">    setImpl(type, triggerAtMillis, legacyExactLength(), intervalMillis, <span class="number">0</span>, operation,</span><br><span class="line">            <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>setRepeating 方法在 API19 以前是精确的，其时间间隔是固定的，但是在 API19 以后则是<strong>非精确闹钟</strong>，其等价于 setInexactRepeating 方法！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setInexactRepeating</span><span class="params">(@AlarmType <span class="keyword">int</span> type, <span class="keyword">long</span> triggerAtMillis,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">long</span> intervalMillis, PendingIntent operation)</span> </span>&#123;</span><br><span class="line">    setImpl(type, triggerAtMillis, WINDOW_HEURISTIC, intervalMillis, <span class="number">0</span>, operation, <span class="keyword">null</span>,</span><br><span class="line">            <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>setInexactRepeating 则是<strong>非精确闹钟</strong>，间隔时间不固定！</p>
<h2 id="1-5-AlarmManager-setAlarmClock"><a href="#1-5-AlarmManager-setAlarmClock" class="headerlink" title="1.5 AlarmManager.setAlarmClock"></a>1.5 AlarmManager.setAlarmClock</h2><p>setAlarmClock 方法用于通过 AlarmClockInfo 来设置一个<strong>精确闹钟</strong>！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAlarmClock</span><span class="params">(AlarmClockInfo info, PendingIntent operation)</span> </span>&#123;</span><br><span class="line">    setImpl(RTC_WAKEUP, info.getTriggerTime(), WINDOW_EXACT, <span class="number">0</span>, <span class="number">0</span>, operation,</span><br><span class="line">            <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, info);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="1-6-AlarmManager-setIdleUntil"><a href="#1-6-AlarmManager-setIdleUntil" class="headerlink" title="1.6 AlarmManager.setIdleUntil"></a>1.6 AlarmManager.setIdleUntil</h2><p>setIdleUntil 方法会将 alarm manager service 置为 idle 状态，并设置一个精确闹钟，当该闹钟触发后 alarm manager service 才会退出 idle 状态！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setIdleUntil</span><span class="params">(@AlarmType <span class="keyword">int</span> type, <span class="keyword">long</span> triggerAtMillis, String tag,</span></span></span><br><span class="line"><span class="function"><span class="params">        OnAlarmListener listener, Handler targetHandler)</span> </span>&#123;</span><br><span class="line">    setImpl(type, triggerAtMillis, WINDOW_EXACT, <span class="number">0</span>, FLAG_IDLE_UNTIL, <span class="keyword">null</span>,</span><br><span class="line">            listener, tag, targetHandler, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，其调用 setImpl 方法的时候，传入了一个 flag，表示要将 AlarmManagerService 置为 idle 状态！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FLAG_IDLE_UNTIL = <span class="number">1</span>&lt;&lt;<span class="number">4</span>;</span><br></pre></td></tr></table></figure>
<p>该方法只能是系统调用！</p>
<h2 id="1-7-AlarmManager-setXXXAndAllowWhileIdle"><a href="#1-7-AlarmManager-setXXXAndAllowWhileIdle" class="headerlink" title="1.7 AlarmManager.setXXXAndAllowWhileIdle"></a>1.7 AlarmManager.setXXXAndAllowWhileIdle</h2><p>setAndAllowWhileIdle 和 setExactAndAllowWhileIdle 方法用于设置在设备处于 idle 状态下，仍然能够触发的 alarm，但是二者有不同之处：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAndAllowWhileIdle</span><span class="params">(@AlarmType <span class="keyword">int</span> type, <span class="keyword">long</span> triggerAtMillis,</span></span></span><br><span class="line"><span class="function"><span class="params">        PendingIntent operation)</span> </span>&#123;</span><br><span class="line">    setImpl(type, triggerAtMillis, WINDOW_HEURISTIC, <span class="number">0</span>, FLAG_ALLOW_WHILE_IDLE,</span><br><span class="line">            operation, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>setAndAllowWhileIdle 方法设置的是<strong>非精确闹钟</strong>！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setExactAndAllowWhileIdle</span><span class="params">(@AlarmType <span class="keyword">int</span> type, <span class="keyword">long</span> triggerAtMillis,</span></span></span><br><span class="line"><span class="function"><span class="params">        PendingIntent operation)</span> </span>&#123;</span><br><span class="line">    setImpl(type, triggerAtMillis, WINDOW_EXACT, <span class="number">0</span>, FLAG_ALLOW_WHILE_IDLE, operation,</span><br><span class="line">            <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>setExactAndAllowWhileIdle 方法设置的是<strong>精确闹钟</strong>！</p>
<p>当 setXXXAndAllowWhileIdle 设置闹钟时候，会传入一个 flags，表示该闹钟在设别处于 idle 状态时依然可以触发！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FLAG_ALLOW_WHILE_IDLE = <span class="number">1</span>&lt;&lt;<span class="number">2</span>;</span><br></pre></td></tr></table></figure></p>
<h1 id="2-AlarmManager-setImpl"><a href="#2-AlarmManager-setImpl" class="headerlink" title="2 AlarmManager.setImpl"></a>2 AlarmManager.setImpl</h1><p>可以看到，最后都会调用 setImpl 接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setImpl</span><span class="params">(@AlarmType <span class="keyword">int</span> type, <span class="keyword">long</span> triggerAtMillis, <span class="keyword">long</span> windowMillis,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">long</span> intervalMillis, <span class="keyword">int</span> flags, PendingIntent operation, <span class="keyword">final</span> OnAlarmListener listener,</span></span></span><br><span class="line"><span class="function"><span class="params">        String listenerTag, Handler targetHandler, WorkSource workSource,</span></span></span><br><span class="line"><span class="function"><span class="params">        AlarmClockInfo alarmClock)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 触发时间最小为 0；</span></span><br><span class="line">    <span class="keyword">if</span> (triggerAtMillis &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        triggerAtMillis = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ListenerWrapper recipientWrapper = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// 当传入的 listener 不为 null 时候，才会进入下面的逻辑！</span></span><br><span class="line">    <span class="keyword">if</span> (listener != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (AlarmManager.class) &#123;</span><br><span class="line">            <span class="comment">// sWrappers 是一个 ArrayMap 集合，用于保存 OnAlarmListener 和 ListenerWrapper 的映射！</span></span><br><span class="line">            <span class="keyword">if</span> (sWrappers == <span class="keyword">null</span>) &#123;</span><br><span class="line">                sWrappers = <span class="keyword">new</span> ArrayMap&lt;OnAlarmListener, ListenerWrapper&gt;();</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 如果该 OnAlarmListener 已经有了 recipientWrapper 对象，那就复用该实例；</span></span><br><span class="line">            <span class="comment">// 如果没有那就创建一个新的 recipientWrapper 实例，并将应映射关系保存进 sWrappers！</span></span><br><span class="line">            recipientWrapper = sWrappers.get(listener);</span><br><span class="line">            <span class="comment">// no existing wrapper =&gt; build a new one</span></span><br><span class="line">            <span class="keyword">if</span> (recipientWrapper == <span class="keyword">null</span>) &#123;</span><br><span class="line">                recipientWrapper = <span class="keyword">new</span> ListenerWrapper(listener);</span><br><span class="line">                sWrappers.put(listener, recipientWrapper);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 初始化 targetHandler，如果没有设置 targetHandler 那就为主线程的 Handler！</span></span><br><span class="line">        <span class="keyword">final</span> Handler handler = (targetHandler != <span class="keyword">null</span>) ? targetHandler : mMainThreadHandler;</span><br><span class="line">        <span class="comment">// 设置 recipientWrapper 的 Handler 变量！</span></span><br><span class="line">        recipientWrapper.setHandler(handler);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【3】调用 AlarmManagerService 的 set 方法，设置闹钟！</span></span><br><span class="line">        mService.set(mPackageName, type, triggerAtMillis, windowMillis, intervalMillis, flags,</span><br><span class="line">                operation, recipientWrapper, listenerTag, workSource, alarmClock);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> ex.rethrowFromSystemServer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-1-new-ListenerWrapper"><a href="#2-1-new-ListenerWrapper" class="headerlink" title="2.1 new ListenerWrapper"></a>2.1 new ListenerWrapper</h2><p>如果我们指定了 OnAlarmListener，那么就会创建对应的 ListenerWrapper 实例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ListenerWrapper</span> <span class="keyword">extends</span> <span class="title">IAlarmListener</span>.<span class="title">Stub</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> OnAlarmListener mListener; </span><br><span class="line">    Handler mHandler;</span><br><span class="line">    IAlarmCompleteListener mCompletion;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ListenerWrapper</span><span class="params">(OnAlarmListener listener)</span> </span>&#123;</span><br><span class="line">        mListener = listener;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setHandler</span><span class="params">(Handler h)</span> </span>&#123;</span><br><span class="line">       mHandler = h;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其实 ListenerWrapper 是一个 Runnable 对象，其构造函数和 setHandler 都很简单，这里就不说了！</p>
<h3 id="2-1-1-ListenerWrapper-doAlarm"><a href="#2-1-1-ListenerWrapper-doAlarm" class="headerlink" title="2.1.1 ListenerWrapper.doAlarm"></a>2.1.1 ListenerWrapper.doAlarm</h3><p>这里先简单说一下，当闹钟触发后，会回调其 doAlarm 方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doAlarm</span><span class="params">(IAlarmCompleteListener alarmManager)</span> </span>&#123;</span><br><span class="line">    mCompletion = alarmManager;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从本地的 sWrappers 中移除映射关系！</span></span><br><span class="line">    <span class="keyword">synchronized</span> (AlarmManager.class) &#123;</span><br><span class="line">        <span class="keyword">if</span> (sWrappers != <span class="keyword">null</span>) &#123;</span><br><span class="line">            sWrappers.remove(mListener);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 调用 set alarm 是传入的 mHandler，执行任务!</span></span><br><span class="line">    mHandler.post(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里的 IAlarmCompleteListener 是一个接口，支持 Binder 通信，当闹钟触发后，AlarmManagerService 会传递一个实现了 IAlarmCompleteListener 接口的对象给当前进程</p>
<p>然后会调用自身的 run 方法，<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 执行 onAlarm 回调！</span></span><br><span class="line">        mListener.onAlarm();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// No catch -- make sure to report completion to the system process,</span></span><br><span class="line">        <span class="comment">// but continue to allow the exception to crash the app.</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mCompletion.alarmComplete(<span class="keyword">this</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            Log.e(TAG, <span class="string">"Unable to report completion to Alarm Manager!"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>逻辑很简单，不多说了！</p>
<h1 id="3-AlarmManagerService"><a href="#3-AlarmManagerService" class="headerlink" title="3 AlarmManagerService"></a>3 AlarmManagerService</h1><p>我们知道 set 方法最后调用了：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mService.set(mPackageName, type, triggerAtMillis, windowMillis, intervalMillis, flags,</span><br><span class="line">                   operation, recipientWrapper, listenerTag, workSource, alarmClock);</span><br></pre></td></tr></table></figure></p>
<p>这个 mService 是服务端的 proxy 对象！AlarmManager 框架实现了 Aidl 模板，实现跨进程通讯：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">IAlarmManager</span> </span>&#123;</span><br><span class="line">	<span class="comment">/** windowLength == 0 means exact; windowLength &lt; 0 means the let the OS decide */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">set</span><span class="params">(String callingPackage, <span class="keyword">int</span> type, <span class="keyword">long</span> triggerAtTime, <span class="keyword">long</span> windowLength,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">long</span> interval, <span class="keyword">int</span> flags, in PendingIntent operation, in IAlarmListener listener,</span></span></span><br><span class="line"><span class="function"><span class="params">            String listenerTag, in WorkSource workSource, in AlarmManager.AlarmClockInfo alarmClock)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">setTime</span><span class="params">(<span class="keyword">long</span> millis)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setTimeZone</span><span class="params">(String zone)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">remove</span><span class="params">(in PendingIntent operation, in IAlarmListener listener)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">getNextWakeFromIdleTime</span><span class="params">()</span></span>;</span><br><span class="line">    AlarmManager.<span class="function">AlarmClockInfo <span class="title">getNextAlarmClock</span><span class="params">(<span class="keyword">int</span> userId)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>AlarmManagerService 内部有一个 IBinder 对象，是 IAlarmManager.Stub 的实现对象，作为服务端的 “桩”：</p>
<h2 id="3-1-AlarmMS-mService-set"><a href="#3-1-AlarmMS-mService-set" class="headerlink" title="3.1 AlarmMS.mService.set"></a>3.1 AlarmMS.mService.set</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> IBinder mService = <span class="keyword">new</span> IAlarmManager.Stub() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(String callingPackage,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> type, <span class="keyword">long</span> triggerAtTime, <span class="keyword">long</span> windowLength, <span class="keyword">long</span> interval, <span class="keyword">int</span> flags,</span></span></span><br><span class="line"><span class="function"><span class="params">            PendingIntent operation, IAlarmListener directReceiver, String listenerTag,</span></span></span><br><span class="line"><span class="function"><span class="params">            WorkSource workSource, AlarmManager.AlarmClockInfo alarmClock)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> callingUid = Binder.getCallingUid();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【1】通过 appOps 校验 uid 和包名是匹配的！</span></span><br><span class="line">        mAppOps.checkPackage(callingUid, callingPackage);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2】重复 alarm 必须要使用 PendingIntent，不能使用 directReceiver，那就是异常！</span></span><br><span class="line">        <span class="keyword">if</span> (interval != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (directReceiver != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Repeating alarms cannot use AlarmReceivers"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【3】如果 workSource 不为 null，</span></span><br><span class="line">        <span class="comment">// 那就检查调用者是否具有 android.Manifest.permission.UPDATE_DEVICE_STATS 权限！</span></span><br><span class="line">        <span class="keyword">if</span> (workSource != <span class="keyword">null</span>) &#123;</span><br><span class="line">            getContext().enforcePermission(</span><br><span class="line">                    android.Manifest.permission.UPDATE_DEVICE_STATS,</span><br><span class="line">                    Binder.getCallingPid(), callingUid, <span class="string">"AlarmManager.set"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【4】清除 flags 中的 FLAG_WAKE_FROM_IDLE 和 FLAG_ALLOW_WHILE_IDLE_UNRESTRICTED 标志位</span></span><br><span class="line">        <span class="comment">// 后续会添加！</span></span><br><span class="line">        flags &amp;= ~(AlarmManager.FLAG_WAKE_FROM_IDLE</span><br><span class="line">                | AlarmManager.FLAG_ALLOW_WHILE_IDLE_UNRESTRICTED);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【5】如果调用者不是 system 进程，那么其不能调用 setIdleUntil 方法设置闹钟，</span></span><br><span class="line">        <span class="comment">// 所以 flags 需要去掉 FLAG_IDLE_UNTIL 位！这个标志位是告诉 AlarmManagerService 什么时候退出 idle 状态！</span></span><br><span class="line">        <span class="comment">// 被 DeviceIdleController 调用！</span></span><br><span class="line">        <span class="keyword">if</span> (callingUid != Process.SYSTEM_UID) &#123;</span><br><span class="line">            flags &amp;= ~AlarmManager.FLAG_IDLE_UNTIL;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【6】如果闹钟的精确闹钟，那就设置 FLAG_STANDALONE 标志位，精确闹钟不会和其他闹钟进行批处理！</span></span><br><span class="line">        <span class="comment">// Flags 设置 FLAG_STANDALONE 标志位！</span></span><br><span class="line">        <span class="keyword">if</span> (windowLength == AlarmManager.WINDOW_EXACT) &#123;</span><br><span class="line">            flags |= AlarmManager.FLAG_STANDALONE;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【7】如果是通过 setAlarmClock 方法设置的闹钟，那么其是精确的并且是 idle 状态依然生效的</span></span><br><span class="line">        <span class="comment">// flags 设置 FLAG_WAKE_FROM_IDLE 和 FLAG_STANDALONE！</span></span><br><span class="line">        <span class="keyword">if</span> (alarmClock != <span class="keyword">null</span>) &#123;</span><br><span class="line">            flags |= AlarmManager.FLAG_WAKE_FROM_IDLE | AlarmManager.FLAG_STANDALONE;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【7】如果不是调用 setAlarmClock 方法设置 alarm，进入下面的分支！</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (workSource == <span class="keyword">null</span> &amp;&amp; (callingUid &lt; Process.FIRST_APPLICATION_UID</span><br><span class="line">                || Arrays.binarySearch(mDeviceIdleUserWhitelist,</span><br><span class="line">                        UserHandle.getAppId(callingUid)) &gt;= <span class="number">0</span>)) &#123;</span><br><span class="line">                        </span><br><span class="line">            <span class="comment">// 如果 workSource 为 null，且调用者是系统应用，或者调用者在 doze 模式白名单中</span></span><br><span class="line">            <span class="comment">// 那么该 alarm 在 idle 状态下，不受限制，flags 设置 FLAG_ALLOW_WHILE_IDLE_UNRESTRICTED！</span></span><br><span class="line">            <span class="comment">// 取消 FLAG_ALLOW_WHILE_IDLE 标志位！</span></span><br><span class="line">            flags |= AlarmManager.FLAG_ALLOW_WHILE_IDLE_UNRESTRICTED;</span><br><span class="line">            flags &amp;= ~AlarmManager.FLAG_ALLOW_WHILE_IDLE;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【3.2】调用 AlarmManagerService 的 setImpl 方法继续设置闹钟！</span></span><br><span class="line">        setImpl(type, triggerAtTime, windowLength, interval, operation, directReceiver,</span><br><span class="line">                listenerTag, flags, workSource, alarmClock, callingUid, callingPackage);</span><br><span class="line">    &#125;</span><br><span class="line">    ... ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>标志位</strong>：</p>
<ul>
<li>AlarmManager.FLAG_WAKE_FROM_IDLE: <ul>
<li>如果设备处于 idle 状态，该类型的 alarm 会将设别唤醒！</li>
<li>AlarmClock 默认就是 FLAG_WAKE_FROM_IDLE 类型的！</li>
</ul>
</li>
</ul>
<p><br></p>
<ul>
<li>AlarmManager.FLAG_IDLE_UNTIL: <ul>
<li>doze 模式的闹钟，只能由系统通过 setIdleUtil 来设置，这个方法会使得系统进入 idle 状态，直到这个 alarm 触发；如果系统中已经有 FLAG_WAKE_FROM_IDLE 类型的 alarm，那么 FLAG_IDLE_UNTIL 类型的 alarm 的触发事件会提前！</li>
</ul>
</li>
</ul>
<p><br></p>
<ul>
<li>AlarmManager.FLAG_STANDALONE: <ul>
<li>精确闹钟，如果设置 alarm 时，指定了闹钟为精确闹钟：WINDOW_EXACT，那么该 flags 会被设置 FLAG_STANDALONE 标志位</li>
</ul>
</li>
</ul>
<p><br></p>
<ul>
<li>AlarmManager.FLAG_ALLOW_WHILE_IDLE：<ul>
<li>即使设备处于 idle 状态，该 alarm 也能触发，通过 setAndAllowWhileIdle 和 setExactAndAllowWhileIdle 设置！</li>
</ul>
</li>
</ul>
<p><br></p>
<ul>
<li>AlarmManager.FLAG_ALLOW_WHILE_IDLE_UNRESTRICTED<ul>
<li>如果是系统应用， 或者调用者在 doze 模式的白名单中，那么会设置 FLAG_ALLOW_WHILE_IDLE_UNRESTRICTED 标志位，而不是 FLAG_ALLOW_WHILE_IDLE 标志位！</li>
</ul>
</li>
</ul>
<p><strong>方法流程总结</strong>：</p>
<ul>
<li>通过 appOps 校验，uid 和包名是否一致；</li>
<li>重复触发的 alarm 必须要使用 PendingIntent，不能使用 directReceiver！</li>
<li>如果 workSource 不为 null，调用者必须有 android.Manifest.permission.UPDATE_DEVICE_STATS 的权限！</li>
<li>非 system uid 的调用者，其不能调用 setIdleUntil 方法设置 FLAG_IDLE_UNTIL！</li>
<li>如果是精确闹钟，那就设置 AlarmManager.FLAG_STANDALONE 标志位！</li>
<li>如果是 alarmClock，那就设置 AlarmManager.FLAG_WAKE_FROM_IDLE 和 AlarmManager.FLAG_STANDALONE！</li>
<li>如果是系统应用， 或者调用者在 doze 模式的白名单中，那么会设置 FLAG_ALLOW_WHILE_IDLE_UNRESTRICTED 标志位，而不是 FLAG_ALLOW_WHILE_IDLE 标志位！</li>
<li>最后，调用 setImpl 方法继续设置！</li>
</ul>
<p>可以看到，我们在 AlarmManager 中调用的 set 接口，会调用该“桩”对象的 set 方法，桩对象的 set 最后会调用 AlarmManagerService 的 setImpl 方法！</p>
<h2 id="3-2-AlarmMS-setImpl"><a href="#3-2-AlarmMS-setImpl" class="headerlink" title="3.2 AlarmMS.setImpl"></a>3.2 AlarmMS.setImpl</h2><p>setImpl 方法中，首先会做一些参数校验！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setImpl</span><span class="params">(<span class="keyword">int</span> type, <span class="keyword">long</span> triggerAtTime, <span class="keyword">long</span> windowLength, <span class="keyword">long</span> interval,</span></span></span><br><span class="line"><span class="function"><span class="params">        PendingIntent operation, IAlarmListener directReceiver, String listenerTag,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> flags, WorkSource workSource, AlarmManager.AlarmClockInfo alarmClock,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> callingUid, String callingPackage)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】校验 PendingIntent 和 directReceiver 是否设置正确！</span></span><br><span class="line">    <span class="keyword">if</span> ((operation == <span class="keyword">null</span> &amp;&amp; directReceiver == <span class="keyword">null</span>)</span><br><span class="line">            || (operation != <span class="keyword">null</span> &amp;&amp; directReceiver != <span class="keyword">null</span>)) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Alarms must either supply a PendingIntent or an AlarmReceiver"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】校验时间窗的长度</span></span><br><span class="line">    <span class="comment">// 如果时间窗长度超过 12h，那就设置为 1h</span></span><br><span class="line">    <span class="keyword">if</span> (windowLength &gt; AlarmManager.INTERVAL_HALF_DAY) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Window length "</span> + windowLength</span><br><span class="line">                + <span class="string">"ms suspiciously long; limiting to 1 hour"</span>);</span><br><span class="line">        windowLength = AlarmManager.INTERVAL_HOUR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】校验重复触发的时间间隔，最小的重复触发的时间间隔为 1min!</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> minInterval = mConstants.MIN_INTERVAL;</span><br><span class="line">    <span class="keyword">if</span> (interval &gt; <span class="number">0</span> &amp;&amp; interval &lt; minInterval) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Suspiciously short interval "</span> + interval</span><br><span class="line">                + <span class="string">" millis; expanding to "</span> + (minInterval/<span class="number">1000</span>)</span><br><span class="line">                + <span class="string">" seconds"</span>);</span><br><span class="line">        interval = minInterval;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【4】校验闹钟的类型 type 是否设置的正确！</span></span><br><span class="line">    <span class="keyword">if</span> (type &lt; RTC_WAKEUP || type &gt; ELAPSED_REALTIME) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Invalid alarm type "</span> + type);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【5】校验触发时间是否正确！</span></span><br><span class="line">    <span class="keyword">if</span> (triggerAtTime &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> what = Binder.getCallingPid();</span><br><span class="line">        Slog.w(TAG, <span class="string">"Invalid alarm trigger time! "</span> + triggerAtTime + <span class="string">" from uid="</span> + callingUid</span><br><span class="line">                + <span class="string">" pid="</span> + what);</span><br><span class="line">        triggerAtTime = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【3.2.1】计算触发时间，根据闹钟是否是 RTC 类型的，进行调整！</span></span><br><span class="line">    <span class="comment">// 如果是 RTC 格式，就将其转换成 elapsedRealtime 格式的触发时间！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> nowElapsed = SystemClock.elapsedRealtime();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> nominalTrigger = convertToElapsed(triggerAtTime, type);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【7】校验触发时间是否大于最低触发时间，默认是 5s，防止 alarm 频繁触发！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> minTrigger = nowElapsed + mConstants.MIN_FUTURITY;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> triggerElapsed = (nominalTrigger &gt; minTrigger) ? nominalTrigger : minTrigger;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【8】根据时间窗取值，设置最晚触发时间！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> maxElapsed;</span><br><span class="line">    <span class="keyword">if</span> (windowLength == AlarmManager.WINDOW_EXACT) &#123;</span><br><span class="line">        <span class="comment">//【8.1】如果取值为 WINDOW_EXACT，那就为精确闹钟，最晚触发时间和设置的时间一样！</span></span><br><span class="line">        maxElapsed = triggerElapsed;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (windowLength &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//【3.2.2】如果取值小于 0，其为非精确闹钟，那么这里会计算最晚触发时间！</span></span><br><span class="line">        <span class="comment">// 并根据最晚触发时间重新计算时间窗！</span></span><br><span class="line">        maxElapsed = maxTriggerTime(nowElapsed, triggerElapsed, interval);</span><br><span class="line">        windowLength = maxElapsed - triggerElapsed;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//【8.3】其他情况，也是非精确闹钟，说明用户显示指定了时间窗，那就依此计算最晚触发时间！</span></span><br><span class="line">        maxElapsed = triggerElapsed + windowLength;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_BATCH) &#123;</span><br><span class="line">            Slog.v(TAG, <span class="string">"set("</span> + operation + <span class="string">") : type="</span> + type</span><br><span class="line">                    + <span class="string">" triggerAtTime="</span> + triggerAtTime + <span class="string">" win="</span> + windowLength</span><br><span class="line">                    + <span class="string">" tElapsed="</span> + triggerElapsed + <span class="string">" maxElapsed="</span> + maxElapsed</span><br><span class="line">                    + <span class="string">" interval="</span> + interval + <span class="string">" flags=0x"</span> + Integer.toHexString(flags));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【3.1】调用 setImplLocked 继续设置 alarm！</span></span><br><span class="line">        setImplLocked(type, triggerAtTime, triggerElapsed, windowLength, maxElapsed,</span><br><span class="line">                interval, operation, directReceiver, listenerTag, flags, <span class="keyword">true</span>, workSource,</span><br><span class="line">                alarmClock, callingUid, callingPackage);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们来看看这个过程：</p>
<ul>
<li>校验 PendingIntent 和 directReceiver 是否设置正确，二者只能设置一个！</li>
<li>检验时间窗，如果 windowLength 超过 12h，那就设置为 1h！</li>
<li>校验重复触发的时间间隔，最小的重复触发的时间间隔为 1min!</li>
<li><p>调整触发时间</p>
<ul>
<li>如果是 RTC 类型的闹钟，将触发事件转为相对于开机的时间！</li>
<li>触发时间最短是 5s</li>
</ul>
</li>
<li><p>调整最晚触发时间和时间窗</p>
<ul>
<li>精确闹钟，最晚触发时间和设置的时间一样，无时间窗！</li>
<li>非精确闹钟，如果没有显式设置时间窗，那么就根据 triggerElapsed，nowElapsed 和 interval 计算合适的最晚触发时间和时间窗！</li>
<li>非精确闹钟，如果显式设置了时间窗。那么最晚触发时间为：triggerElapsed + windowLength！</li>
</ul>
</li>
<li><p>最后，调用 setImplLocked 进一步设置 alarm！</p>
</li>
</ul>
<h3 id="3-2-1-AlarmMS-convertToElapsed"><a href="#3-2-1-AlarmMS-convertToElapsed" class="headerlink" title="3.2.1 AlarmMS.convertToElapsed"></a>3.2.1 AlarmMS.convertToElapsed</h3><p>对于触发事件，要根据闹钟的类型，来修正：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">long</span> <span class="title">convertToElapsed</span><span class="params">(<span class="keyword">long</span> when, <span class="keyword">int</span> type)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】判断是否是 RTC 闹钟类型！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> isRtc = (type == RTC || type == RTC_WAKEUP);</span><br><span class="line">    <span class="comment">//【2】如果是 RTC 类型的，就将其转为相对于开机的时间点！</span></span><br><span class="line">    <span class="keyword">if</span> (isRtc) &#123;</span><br><span class="line">        when -= System.currentTimeMillis() - SystemClock.elapsedRealtime();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> when;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>计算结果：<br>when = when - System.currentTimeMillis() + SystemClock.elapsedRealtime();</p>
<p>如果是 rtc 类型，那就将其转为了相对于开机的时间！</p>
<h3 id="3-2-2-AlarmMS-maxTriggerTime"><a href="#3-2-2-AlarmMS-maxTriggerTime" class="headerlink" title="3.2.2 AlarmMS.maxTriggerTime"></a>3.2.2 AlarmMS.maxTriggerTime</h3><p>接着是计算最大的触发时间，这里的 MIN_FUZZABLE_INTERVAL 表示的是最小的时间窗间隔！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// minimum recurrence period or alarm futurity for us to be able to fuzz it</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> MIN_FUZZABLE_INTERVAL = <span class="number">10000</span>;</span><br></pre></td></tr></table></figure>
<p>继续来看：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">long</span> <span class="title">maxTriggerTime</span><span class="params">(<span class="keyword">long</span> now, <span class="keyword">long</span> triggerAtTime, <span class="keyword">long</span> interval)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】如果没有设置重复的时间间隔 interval，那么时间间隔为触发时间 triggerAtTime - 当前时间 now！</span></span><br><span class="line">    <span class="comment">// 否则，时间间隔为 interval！</span></span><br><span class="line">    <span class="keyword">long</span> futurity = (interval == <span class="number">0</span>)</span><br><span class="line">            ? (triggerAtTime - now)</span><br><span class="line">            : interval;</span><br><span class="line">    <span class="comment">//【2】如果计算出的时间间隔 futurity 小于 10s，那么设置其为 0；</span></span><br><span class="line">    <span class="keyword">if</span> (futurity &lt; MIN_FUZZABLE_INTERVAL) &#123;</span><br><span class="line">        futurity = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【3】最后，最大的触发时间点为：开始触发时间点 + 0.75 倍的时间间隔 futurity！</span></span><br><span class="line">    <span class="keyword">return</span> triggerAtTime + (<span class="keyword">long</span>)(.<span class="number">75</span> * futurity);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>对于非精确的 alarm，这里通过 maxTriggerTime 方法计算其批处理的时间窗为：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0.75</span> * (interval or triggerAtTime - now)</span><br></pre></td></tr></table></figure></p>
<p>如果计算出的时间窗小于 10 s，那么就不设置最晚执行时间！</p>
<h2 id="3-3-AlarmMS-setImplLocked-15"><a href="#3-3-AlarmMS-setImplLocked-15" class="headerlink" title="3.3 AlarmMS.setImplLocked[15]"></a>3.3 AlarmMS.setImplLocked[15]</h2><p><strong>参数传递</strong>：</p>
<ul>
<li><strong>int type</strong>：闹钟的类型</li>
<li><strong>long when</strong>: 触发时间点；</li>
<li><strong>long whenElapsed</strong>：触发时间点，相对于开机时间；</li>
<li><strong>long windowLength</strong>：时间窗；</li>
<li><strong>long maxWhen</strong>：最晚触发的时间点，触发时间点，相对于开机时间！</li>
<li><strong>long interval</strong>：重复触发的时间间隔；</li>
<li><strong>PendingIntent operation</strong>：这个很简单，不多说！</li>
<li><strong>IAlarmListener directReceiver</strong>：这个很简单，也不多说！</li>
<li><strong>String listenerTag</strong>：AlarmListener 的字符串描述信息！</li>
<li><strong>int flags</strong>：alarm 属性标志位！</li>
<li><strong>boolean doValidate</strong>：传入 true！</li>
<li><strong>WorkSource workSource</strong>：工作源对象！</li>
<li><strong>AlarmManager.AlarmClockInfo alarmClock</strong>：通过 setAlarmClock 方法设置才不为 null；</li>
<li><strong>int callingUid</strong>：调用者的 uid；</li>
<li><strong>String callingPackage</strong>：调用者的 package name；</li>
</ul>
<p>对于参数，就简单的介绍到这里！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setImplLocked</span><span class="params">(<span class="keyword">int</span> type, <span class="keyword">long</span> when, <span class="keyword">long</span> whenElapsed, <span class="keyword">long</span> windowLength,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">long</span> maxWhen, <span class="keyword">long</span> interval, PendingIntent operation, IAlarmListener directReceiver,</span></span></span><br><span class="line"><span class="function"><span class="params">        String listenerTag, <span class="keyword">int</span> flags, <span class="keyword">boolean</span> doValidate, WorkSource workSource,</span></span></span><br><span class="line"><span class="function"><span class="params">        AlarmManager.AlarmClockInfo alarmClock, <span class="keyword">int</span> callingUid, String callingPackage)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【3.3.1】创建一个 Alarm 对象！</span></span><br><span class="line">    Alarm a = <span class="keyword">new</span> Alarm(type, when, whenElapsed, windowLength, maxWhen, interval,</span><br><span class="line">            operation, directReceiver, listenerTag, workSource, flags, alarmClock,</span><br><span class="line">            callingUid, callingPackage);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 如果不允许设置 alarm，就退出！</span></span><br><span class="line">        <span class="keyword">if</span> (ActivityManagerNative.getDefault().getAppStartMode(callingUid, callingPackage)</span><br><span class="line">                == ActivityManager.APP_START_MODE_DISABLED) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Not setting alarm from "</span> + callingUid + <span class="string">":"</span> + a</span><br><span class="line">                    + <span class="string">" -- package not allowed to start"</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3.3.2】移除已经设置的相同的 alarm！</span></span><br><span class="line">    removeLocked(operation, directReceiver);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3.3.3】进一步设置 alarm！</span></span><br><span class="line">    setImplLocked(a, <span class="keyword">false</span>, doValidate);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-3-1-AlarmMS-Alarm"><a href="#3-3-1-AlarmMS-Alarm" class="headerlink" title="3.3.1 AlarmMS.Alarm"></a>3.3.1 AlarmMS.Alarm</h3><p>下面是会创建一个 Alarm 对象，保存本次 set 的 alarm 的信息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Alarm</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> type;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">long</span> origWhen;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> wakeup;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> PendingIntent operation;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> IAlarmListener listener;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String listenerTag;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String statsTag;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> WorkSource workSource;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> flags;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> AlarmManager.AlarmClockInfo alarmClock;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> uid;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> creatorUid;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String packageName;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> count;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">long</span> when;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">long</span> windowLength;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">long</span> whenElapsed;    <span class="comment">// 'when' in the elapsed time base</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">long</span> maxWhenElapsed; <span class="comment">// also in the elapsed time base</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">long</span> repeatInterval;</span><br><span class="line">    <span class="keyword">public</span> PriorityClass priorityClass;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Alarm</span><span class="params">(<span class="keyword">int</span> _type, <span class="keyword">long</span> _when, <span class="keyword">long</span> _whenElapsed, <span class="keyword">long</span> _windowLength, <span class="keyword">long</span> _maxWhen,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">long</span> _interval, PendingIntent _op, IAlarmListener _rec, String _listenerTag,</span></span></span><br><span class="line"><span class="function"><span class="params">            WorkSource _ws, <span class="keyword">int</span> _flags, AlarmManager.AlarmClockInfo _info,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> _uid, String _pkgName)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        type = _type; <span class="comment">// 闹钟类型，对应的是 AlarmManager 中的四种类型！</span></span><br><span class="line">        origWhen = _when; <span class="comment">// 触发时间点！</span></span><br><span class="line">        wakeup = _type == AlarmManager.ELAPSED_REALTIME_WAKEUP <span class="comment">// 是否是 wake up 类型的！</span></span><br><span class="line">                || _type == AlarmManager.RTC_WAKEUP;</span><br><span class="line">        when = _when; <span class="comment">// 触发事件点！</span></span><br><span class="line">        whenElapsed = _whenElapsed; <span class="comment">// 触发时间点，相对于开机时间！</span></span><br><span class="line">        windowLength = _windowLength; <span class="comment">// 时间窗；</span></span><br><span class="line">        maxWhenElapsed = _maxWhen; <span class="comment">// 最晚触发的时间点，触发时间点，相对于开机时间！</span></span><br><span class="line">        repeatInterval = _interval; <span class="comment">// 重复触发的时间间隔！</span></span><br><span class="line">        operation = _op;</span><br><span class="line">        listener = _rec;</span><br><span class="line">        listenerTag = _listenerTag;</span><br><span class="line">        statsTag = makeTag(_op, _listenerTag, _type);</span><br><span class="line">        workSource = _ws;</span><br><span class="line">        flags = _flags; <span class="comment">// 闹钟属性的标志位！</span></span><br><span class="line">        alarmClock = _info;</span><br><span class="line">        uid = _uid;</span><br><span class="line">        packageName = _pkgName;</span><br><span class="line">        creatorUid = (operation != <span class="keyword">null</span>) ? operation.getCreatorUid() : uid; <span class="comment">// 创建 intent 的 uid</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">makeTag</span><span class="params">(PendingIntent pi, String tag, <span class="keyword">int</span> type)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> String alarmString = type == ELAPSED_REALTIME_WAKEUP || type == RTC_WAKEUP</span><br><span class="line">                ? <span class="string">"*walarm*:"</span> : <span class="string">"*alarm*:"</span>;</span><br><span class="line">        <span class="keyword">return</span> (pi != <span class="keyword">null</span>) ? pi.getTag(alarmString) : (alarmString + tag);</span><br><span class="line">    &#125;</span><br><span class="line">    ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Alarm 有几个方法，我们来看下：</p>
<h4 id="3-3-1-1-Alarm-make"><a href="#3-3-1-1-Alarm-make" class="headerlink" title="3.3.1.1 Alarm.make"></a>3.3.1.1 Alarm.make</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> WakeupEvent <span class="title">makeWakeupEvent</span><span class="params">(<span class="keyword">long</span> nowRTC)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> WakeupEvent(nowRTC, creatorUid,</span><br><span class="line">            (operation != <span class="keyword">null</span>)</span><br><span class="line">                ? operation.getIntent().getAction()</span><br><span class="line">                : (<span class="string">"&lt;listener&gt;:"</span> + listenerTag));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个方法是用来创建一个 wake up event！</p>
<h4 id="3-3-1-2-Alarm-matches"><a href="#3-3-1-2-Alarm-matches" class="headerlink" title="3.3.1.2 Alarm.matches"></a>3.3.1.2 Alarm.matches</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Returns true if either matches</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(PendingIntent pi, IAlarmListener rec)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (operation != <span class="keyword">null</span>)</span><br><span class="line">            ? operation.equals(pi)</span><br><span class="line">            : rec != <span class="keyword">null</span> &amp;&amp; listener.asBinder().equals(rec.asBinder());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(String packageName)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (operation != <span class="keyword">null</span>)</span><br><span class="line">            ? packageName.equals(operation.getTargetPackage())</span><br><span class="line">            : packageName.equals(<span class="keyword">this</span>.packageName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个方法是用来匹配 Alarm 的，代码逻辑很简单，使用 packageName 或者 PendingIntent，AlarmListener 进行匹配！</p>
<p>我们继续来看：</p>
<h3 id="3-3-2-AlarmMS-removeLocked"><a href="#3-3-2-AlarmMS-removeLocked" class="headerlink" title="3.3.2 AlarmMS.removeLocked"></a>3.3.2 AlarmMS.removeLocked</h3><p>removeLocked 方法用于移除一个已经存在的 alarm！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">removeLocked</span><span class="params">(PendingIntent operation, IAlarmListener directReceiver)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> didRemove = <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">//【1】遍历 mAlarmBatches 中所有的 Batch 批处理对象，从 Batch 中移除该 alarm！</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = mAlarmBatches.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        Batch b = mAlarmBatches.get(i);</span><br><span class="line">        <span class="comment">//【3.3.2.1】匹配并移除成功会返回 true！</span></span><br><span class="line">        didRemove |= b.remove(operation, directReceiver);</span><br><span class="line">        <span class="keyword">if</span> (b.size() == <span class="number">0</span>) &#123; <span class="comment">// 如果该 Batch 中没有了其他的 alarm，就移除这个 Batch！</span></span><br><span class="line">            mAlarmBatches.remove(i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】遍历 mPendingWhileIdleAlarms 中所有因为进入 idle 状态而等待执行的 Alarm 对象！</span></span><br><span class="line">    <span class="comment">// 移除和本次 alarm 匹配的 alarm！</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = mPendingWhileIdleAlarms.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mPendingWhileIdleAlarms.get(i).matches(operation, directReceiver)) &#123;</span><br><span class="line">            mPendingWhileIdleAlarms.remove(i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】如果 didRemove 为 true，表示确实是移除了一个相同的 alarm！</span></span><br><span class="line">    <span class="keyword">if</span> (didRemove) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_BATCH) &#123;</span><br><span class="line">            Slog.v(TAG, <span class="string">"remove(operation) changed bounds; rebatching"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">boolean</span> restorePending = <span class="keyword">false</span>; <span class="comment">// 表示是否恢复正在等待中的 alarm</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果 mPendingIdleUntil 不为 null，且移除的 alarm 和 mPendingIdleUntil 匹配，那就说明</span></span><br><span class="line">        <span class="comment">// 要退出 idle 状态！</span></span><br><span class="line">        <span class="keyword">if</span> (mPendingIdleUntil != <span class="keyword">null</span> &amp;&amp; mPendingIdleUntil.matches(operation, directReceiver)) &#123;</span><br><span class="line">            <span class="comment">// 那就设置 mPendingIdleUntil 为 null，同时设置 restorePending 为 true！</span></span><br><span class="line">            mPendingIdleUntil = <span class="keyword">null</span>;</span><br><span class="line">            restorePending = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 如果 mNextWakeFromIdle 不为 null，且移除的 alarm 和 mPendingIdleUntil 匹配，</span></span><br><span class="line">        <span class="comment">// 那就设置 mNextWakeFromIdle 为 null！！</span></span><br><span class="line">        <span class="keyword">if</span> (mNextWakeFromIdle != <span class="keyword">null</span> &amp;&amp; mNextWakeFromIdle.matches(operation, directReceiver)) &#123;</span><br><span class="line">            mNextWakeFromIdle = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【3.3.2.2】对其他的 alarm 重新进行批处理分配！</span></span><br><span class="line">        rebatchAllAlarmsLocked(<span class="keyword">true</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【3.3.2.3】如果 restorePending 为 true，说明从 idle 状态恢复了，那就要恢复 mPendingWhileIdleAlarms</span></span><br><span class="line">        <span class="comment">// 中所有 alarm！</span></span><br><span class="line">        <span class="keyword">if</span> (restorePending) &#123;</span><br><span class="line">            restorePendingWhileIdleAlarmsLocked();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【3.4.5】更新下一个 AlarmClock 的时间！</span></span><br><span class="line">        updateNextAlarmClockLocked();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这边是匹配到和本次设置的 alarm 相同的 alarm，然后做移除操作，然后恢复一些需要执行的 alarm！</p>
<h4 id="3-3-2-1-AlarmMS-Batch-remove"><a href="#3-3-2-1-AlarmMS-Batch-remove" class="headerlink" title="3.3.2.1 AlarmMS.Batch.remove"></a>3.3.2.1 AlarmMS.Batch.remove</h4><p>从一个 Batch 中移除一个 alarm，Batch 中的非精确 alarm 是按照触发事件排序的，同时 Batch 也有一个 start 变量，表示批处理内部所有 alarm 的时间点！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">remove</span><span class="params">(<span class="keyword">final</span> PendingIntent operation, <span class="keyword">final</span> IAlarmListener listener)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (operation == <span class="keyword">null</span> &amp;&amp; listener == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (localLOGV) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"requested remove() of null operation"</span>,</span><br><span class="line">                    <span class="keyword">new</span> RuntimeException(<span class="string">"here"</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">boolean</span> didRemove = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">long</span> newStart = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">long</span> newEnd = Long.MAX_VALUE;</span><br><span class="line">    <span class="keyword">int</span> newFlags = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; alarms.size(); ) &#123;</span><br><span class="line">        Alarm alarm = alarms.get(i);</span><br><span class="line">        <span class="comment">//【3.3.1.2】这里用到了 alarm 的 matches 匹配方法，前面有说过！</span></span><br><span class="line">        <span class="keyword">if</span> (alarm.matches(operation, listener)) &#123;</span><br><span class="line">            alarms.remove(i);</span><br><span class="line">            <span class="comment">//【1】设置 didRemove 为 true；</span></span><br><span class="line">            didRemove = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【2】如果匹配的 alarm 是通过 setAlarmClock 设置的，就设置 mNextAlarmClockMayChange 为 true！</span></span><br><span class="line">            <span class="keyword">if</span> (alarm.alarmClock != <span class="keyword">null</span>) &#123;</span><br><span class="line">                mNextAlarmClockMayChange = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (alarm.whenElapsed &gt; newStart) &#123; <span class="comment">// 更新 newStart 时间点！</span></span><br><span class="line">                newStart = alarm.whenElapsed;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (alarm.maxWhenElapsed &lt; newEnd) &#123; <span class="comment">// 更新 newStart 时间点！</span></span><br><span class="line">                newEnd = alarm.maxWhenElapsed;</span><br><span class="line">            &#125;</span><br><span class="line">            newFlags |= alarm.flags; <span class="comment">// 获得该 Batch 中所有 Alarm 的标志位！</span></span><br><span class="line">            i++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【3】如果移除了，那就更新 Batch 的 start 和 end 时间点！</span></span><br><span class="line">    <span class="keyword">if</span> (didRemove) &#123;</span><br><span class="line">        start = newStart;</span><br><span class="line">        end = newEnd;</span><br><span class="line">        flags = newFlags;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> didRemove;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以看到：</p>
<ul>
<li><p>从这个 batch 移除 operation 或者 listener 匹配的 alarm，并更新 batch 的 start， end 和 flags 对象！</p>
</li>
<li><p>如果被移除的 alarm 是通过 setAlarmClock 设置的，那么 mNextAlarmClockMayChange 为 true，后面系统会调用指定方法来更新下一个 AlarmClock！</p>
</li>
</ul>
<p>我们可以看到，当我们从 Batch 中移除一个 Alarm 后，Batch 的 start 和 end 时间点发生了变化，这样会导致 Batch 在 mAlarmBatches 中的顺序发生变化！</p>
<h4 id="3-3-2-2-AlarmMS-rebatchAllAlarmsLocked"><a href="#3-3-2-2-AlarmMS-rebatchAllAlarmsLocked" class="headerlink" title="3.3.2.2 AlarmMS.rebatchAllAlarmsLocked"></a>3.3.2.2 AlarmMS.rebatchAllAlarmsLocked</h4><p>该方法用于重新对所有的 alarm 进行 batch 批处理！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rebatchAllAlarmsLocked</span><span class="params">(<span class="keyword">boolean</span> doValidate)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】将 mAlarmBatches 拷贝一份到 oldSet 中，并清空 mAlarmBatches！</span></span><br><span class="line">    ArrayList&lt;Batch&gt; oldSet = (ArrayList&lt;Batch&gt;) mAlarmBatches.clone();</span><br><span class="line">    mAlarmBatches.clear();</span><br><span class="line"></span><br><span class="line">    Alarm oldPendingIdleUntil = mPendingIdleUntil;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> nowElapsed = SystemClock.elapsedRealtime();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> oldBatches = oldSet.size();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】遍历每一个 Batch 的中 Alarm，重新进行批处理分配！</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> batchNum = <span class="number">0</span>; batchNum &lt; oldBatches; batchNum++) &#123;</span><br><span class="line">        Batch batch = oldSet.get(batchNum);</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> N = batch.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">            <span class="comment">//【3.3.2.1.1】重新添加 Alarm！</span></span><br><span class="line">            reAddAlarmLocked(batch.get(i), nowElapsed, doValidate);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【3】如果 oldPendingIdleUntil 不为 null，而 mPendingIdleUntil 为 null</span></span><br><span class="line">    <span class="comment">// 说明，此时推出了 idle 状态，那就恢复那些因为 idle 状态而等待的 alarm！</span></span><br><span class="line">    <span class="comment">// × 这里感觉是为了解决 bug，因为看逻辑，不会进入这里</span></span><br><span class="line">    <span class="keyword">if</span> (oldPendingIdleUntil != <span class="keyword">null</span> &amp;&amp; oldPendingIdleUntil != mPendingIdleUntil) &#123;</span><br><span class="line">        Slog.wtf(TAG, <span class="string">"Rebatching: idle until changed from "</span> + oldPendingIdleUntil</span><br><span class="line">                + <span class="string">" to "</span> + mPendingIdleUntil);</span><br><span class="line">        <span class="keyword">if</span> (mPendingIdleUntil == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//【3.3.2.3】恢复等待中的 alarm！</span></span><br><span class="line">            restorePendingWhileIdleAlarmsLocked();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【3.4.4】重新调度并设置下一个 alarm！</span></span><br><span class="line">    rescheduleKernelAlarmsLocked();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3.4.5】更新下一个 AlarmClock 闹钟！</span></span><br><span class="line">    updateNextAlarmClockLocked();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="3-3-2-2-1-AlarmManagerService-reAddAlarmLocked"><a href="#3-3-2-2-1-AlarmManagerService-reAddAlarmLocked" class="headerlink" title="3.3.2.2.1 AlarmManagerService.reAddAlarmLocked"></a>3.3.2.2.1 AlarmManagerService.reAddAlarmLocked</h5><p>该方法用于重新添加 alarm！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">reAddAlarmLocked</span><span class="params">(Alarm a, <span class="keyword">long</span> nowElapsed, <span class="keyword">boolean</span> doValidate)</span> </span>&#123;</span><br><span class="line">    a.when = a.origWhen;</span><br><span class="line">    <span class="keyword">long</span> whenElapsed = convertToElapsed(a.when, a.type);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> maxElapsed;</span><br><span class="line">    <span class="keyword">if</span> (a.windowLength == AlarmManager.WINDOW_EXACT) &#123; <span class="comment">// 根据类型的不同，计算最大触发时间！</span></span><br><span class="line">        maxElapsed = whenElapsed; <span class="comment">// 精确闹钟！</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//【3.2.2】非精确闹钟！</span></span><br><span class="line">        maxElapsed = (a.windowLength &gt; <span class="number">0</span>)</span><br><span class="line">                ? (whenElapsed + a.windowLength)</span><br><span class="line">                : maxTriggerTime(nowElapsed, whenElapsed, a.repeatInterval);</span><br><span class="line">    &#125;</span><br><span class="line">    a.whenElapsed = whenElapsed;</span><br><span class="line">    a.maxWhenElapsed = maxElapsed;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3.4】调用 setImplLocked 方法重新设置 alarm，注意这里的 rebatching 值为 true！</span></span><br><span class="line">    setImplLocked(a, <span class="keyword">true</span>, doValidate);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到这里调用了 setImplLocked 三参数方法，重新设置该 alarm！</p>
<p>在 setImplLocked 方法中，会重新为 Alarm 分配 Batch，并对 mAlarmBatches 中的所有 Batch 重新排序，后面我们能够看到对该方法的分析，在第 3.4 节！</p>
<h4 id="3-3-2-3-AlarmMS-restorePendingWhileIdleAlarmsLocked"><a href="#3-3-2-3-AlarmMS-restorePendingWhileIdleAlarmsLocked" class="headerlink" title="3.3.2.3 AlarmMS.restorePendingWhileIdleAlarmsLocked"></a>3.3.2.3 AlarmMS.restorePendingWhileIdleAlarmsLocked</h4><p>接着，当系统退出 idle 状态后，要恢复那些因为 idle 状态而等待触发的 alarm！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">restorePendingWhileIdleAlarmsLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (RECORD_DEVICE_IDLE_ALARMS) &#123; <span class="comment">// RECORD_DEVICE_IDLE_ALARMS 默认为 false，用于 dump 不处理；</span></span><br><span class="line">        IdleDispatchEntry ent = <span class="keyword">new</span> IdleDispatchEntry();</span><br><span class="line">        ent.uid = <span class="number">0</span>;</span><br><span class="line">        ent.pkg = <span class="string">"FINISH IDLE"</span>;</span><br><span class="line">        ent.elapsedRealtime = SystemClock.elapsedRealtime();</span><br><span class="line">        mAllowWhileIdleDispatches.add(ent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果此时 mPendingWhileIdleAlarms 不为 empty，那就说明有等待触发的 alarm！</span></span><br><span class="line">    <span class="comment">// 将其重新进行批处理分配！</span></span><br><span class="line">    <span class="keyword">if</span> (mPendingWhileIdleAlarms.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        ArrayList&lt;Alarm&gt; alarms = mPendingWhileIdleAlarms;</span><br><span class="line">        mPendingWhileIdleAlarms = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> nowElapsed = SystemClock.elapsedRealtime();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=alarms.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">            Alarm a = alarms.get(i);</span><br><span class="line">            <span class="comment">//【3.3.2.1.1】这里调用了 reAddAlarmLocked 方法，重新批处理 alarm，该方法上面有说过！</span></span><br><span class="line">            reAddAlarmLocked(a, nowElapsed, <span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 更新 ALLOW_WHILE_IDLE 最小时间！</span></span><br><span class="line">    mConstants.updateAllowWhileIdleMinTimeLocked();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3.3.2.4】重新调度，设置 alarm！</span></span><br><span class="line">    rescheduleKernelAlarmsLocked();</span><br><span class="line">    <span class="comment">//【3.3.2.5】更新下一个 Alarm 的触发时间！</span></span><br><span class="line">    updateNextAlarmClockLocked();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发送一个时间改变的广播，用于更新 ui！</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        mTimeTickSender.send();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (PendingIntent.CanceledException e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>继续看！</p>
<h2 id="3-4-AlarmMS-setImplLocked-3"><a href="#3-4-AlarmMS-setImplLocked-3" class="headerlink" title="3.4 AlarmMS.setImplLocked[3]"></a>3.4 AlarmMS.setImplLocked[3]</h2><p>接下来，我们来看一个非常重要的方法 setImplLocked！，第二个参数 rebatching 表示是否是 rebatch，正常流程下，rebatching 是为 false；</p>
<p>但是，当我们 rebatch 或者 restore 其他 alarm 时，rebatching 传入的是 true！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setImplLocked</span><span class="params">(Alarm a, <span class="keyword">boolean</span> rebatching, <span class="keyword">boolean</span> doValidate)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】如果 alarm 设置了 AlarmManager.FLAG_IDLE_UNTIL 标志位，说明是 setIdleUtil 方法设置的！</span></span><br><span class="line">    <span class="comment">// 这是一种很特殊的闹钟，用于将系统设置为 idle 状态，但其触发后退出 idle 状态！</span></span><br><span class="line">    <span class="comment">// 如果有其他 alarm 会将系统从 idle 状态唤醒的话，并且其触发事件比 setIdleUtil 更早的的话，我们需要将</span></span><br><span class="line">    <span class="comment">// setIdleUtil 闹钟的时间提前！</span></span><br><span class="line">    <span class="keyword">if</span> ((a.flags&amp;AlarmManager.FLAG_IDLE_UNTIL) != <span class="number">0</span>) &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 如果 mNextWakeFromIdle 不为 null，说明有 alarm 会在设备处于 idle 的状态下唤醒设备</span></span><br><span class="line">        <span class="comment">// 如果 mNextWakeFromIdle 的触发时间更早，那么需要调整 setIdleUtil 的时间为 mNextWakeFromIdle 的触发时间！</span></span><br><span class="line">        <span class="keyword">if</span> (mNextWakeFromIdle != <span class="keyword">null</span> &amp;&amp; a.whenElapsed &gt; mNextWakeFromIdle.whenElapsed) &#123;</span><br><span class="line">            <span class="comment">// 因为是精确闹钟，所以所有时间相同！</span></span><br><span class="line">            a.when = a.whenElapsed = a.maxWhenElapsed = mNextWakeFromIdle.whenElapsed;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【3.4.1】接着对 setIdleUtil 闹钟的触发时间做一个细微调整，将前面设置的触发时间提前一个时间段！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> nowElapsed = SystemClock.elapsedRealtime();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> fuzz = fuzzForDuration(a.whenElapsed-nowElapsed);</span><br><span class="line">        <span class="keyword">if</span> (fuzz &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mRandom == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mRandom = <span class="keyword">new</span> Random();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 可以看到，最后进一步调整的提前时间间隔为 0 到 fuzz 的一个随机整数时间，单位是分钟！</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> delta = mRandom.nextInt(fuzz);</span><br><span class="line">            a.whenElapsed -= delta;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">false</span>) &#123;</span><br><span class="line">                Slog.d(TAG, <span class="string">"Alarm when: "</span> + a.whenElapsed);</span><br><span class="line">                Slog.d(TAG, <span class="string">"Delta until alarm: "</span> + (a.whenElapsed-nowElapsed));</span><br><span class="line">                Slog.d(TAG, <span class="string">"Applied fuzz: "</span> + fuzz);</span><br><span class="line">                Slog.d(TAG, <span class="string">"Final delta: "</span> + delta);</span><br><span class="line">                Slog.d(TAG, <span class="string">"Final when: "</span> + a.whenElapsed);</span><br><span class="line">            &#125;</span><br><span class="line">            a.when = a.maxWhenElapsed = a.whenElapsed;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mPendingIdleUntil != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果没有设置 FLAG_IDLE_UNTIL 标志位，那么就要判断下 mPendingIdleUntil 是否为 null；</span></span><br><span class="line">        <span class="comment">// 其不为 null，说明系统现在处于 idle 状态，如果 alarm 没有设置一下的几种标志位的话，</span></span><br><span class="line">        <span class="comment">// 那就将其加入到 mPendingWhileIdleAlarms 列表中，等到系统退出 idle 状态后，再设置这些闹钟！</span></span><br><span class="line">        <span class="keyword">if</span> ((a.flags&amp;(AlarmManager.FLAG_ALLOW_WHILE_IDLE</span><br><span class="line">                | AlarmManager.FLAG_ALLOW_WHILE_IDLE_UNRESTRICTED</span><br><span class="line">                | AlarmManager.FLAG_WAKE_FROM_IDLE))</span><br><span class="line">                == <span class="number">0</span>) &#123;</span><br><span class="line">            mPendingWhileIdleAlarms.add(a);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// RECORD_DEVICE_IDLE_ALARMS 变量默认为 false，如果为 true，那么系统会记录那些在 idle 状态下能够触发的 alarm！</span></span><br><span class="line">    <span class="comment">// 保存到 mAllowWhileIdleDispatches 中，我们在 dumpsys alarm 的时候能看到！</span></span><br><span class="line">    <span class="keyword">if</span> (RECORD_DEVICE_IDLE_ALARMS) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((a.flags &amp; AlarmManager.FLAG_ALLOW_WHILE_IDLE) != <span class="number">0</span>) &#123;</span><br><span class="line">            IdleDispatchEntry ent = <span class="keyword">new</span> IdleDispatchEntry();</span><br><span class="line">            ent.uid = a.uid;</span><br><span class="line">            ent.pkg = a.operation.getCreatorPackage();</span><br><span class="line">            ent.tag = a.operation.getTag(<span class="string">""</span>);</span><br><span class="line">            ent.op = <span class="string">"SET"</span>;</span><br><span class="line">            ent.elapsedRealtime = SystemClock.elapsedRealtime();</span><br><span class="line">            ent.argRealtime = a.whenElapsed;</span><br><span class="line">            mAllowWhileIdleDispatches.add(ent);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3.4.2】为新的 alarm 选择一个合适的 Batch，</span></span><br><span class="line">    <span class="comment">// 如果闹钟的 alarm 的 flags 设置了 AlarmManager.FLAG_STANDALONE 标志</span></span><br><span class="line">    <span class="comment">// 那么其为精确闹钟，那么必须单独在一个 Batch 中！</span></span><br><span class="line">    <span class="keyword">int</span> whichBatch = ((a.flags&amp;AlarmManager.FLAG_STANDALONE) != <span class="number">0</span>)</span><br><span class="line">            ? -<span class="number">1</span> : attemptCoalesceLocked(a.whenElapsed, a.maxWhenElapsed);</span><br><span class="line">            </span><br><span class="line">    <span class="keyword">if</span> (whichBatch &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//【3.4.3】创建一个新的 Batch，并添加到 mAlarmBatch，并对 mAlarmBatches 按开始时间升序排列！</span></span><br><span class="line">        Batch batch = <span class="keyword">new</span> Batch(a);</span><br><span class="line">        addBatchLocked(mAlarmBatches, batch);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//【3.4.3】如果 whichBatch &gt;= 0，说明已经找到合适的 Batch 了，那我们就将其添加进去</span></span><br><span class="line">        Batch batch = mAlarmBatches.get(whichBatch);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果当前 alarm 的加入使得了 batch 开始时间和结束时间的改变，则 add 返回 true</span></span><br><span class="line">        <span class="comment">// 那么此时，我们需要对 mAlarmBatches 重新排序！</span></span><br><span class="line">        <span class="keyword">if</span> (batch.add(a)) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 排序方法很简单，先移除这个 Batch，再重新添加！</span></span><br><span class="line">            mAlarmBatches.remove(whichBatch);</span><br><span class="line">            addBatchLocked(mAlarmBatches, batch);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果 a.alarmClock 不为 null，则是通过 setAlarmClock 设置的，那就设置 mNextAlarmClockMayChange 为 true！</span></span><br><span class="line">    <span class="comment">// 下面会根据这个变量更新 AlarmClock！</span></span><br><span class="line">    <span class="keyword">if</span> (a.alarmClock != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mNextAlarmClockMayChange = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> needRebatch = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果是通过 setIdleUtil 设置的闹钟，系统此时将进入 idle 状态！</span></span><br><span class="line">    <span class="keyword">if</span> ((a.flags&amp;AlarmManager.FLAG_IDLE_UNTIL) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (RECORD_DEVICE_IDLE_ALARMS) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mPendingIdleUntil == <span class="keyword">null</span>) &#123;</span><br><span class="line">                IdleDispatchEntry ent = <span class="keyword">new</span> IdleDispatchEntry();</span><br><span class="line">                ent.uid = <span class="number">0</span>;</span><br><span class="line">                ent.pkg = <span class="string">"START IDLE"</span>;</span><br><span class="line">                ent.elapsedRealtime = SystemClock.elapsedRealtime();</span><br><span class="line">                mAllowWhileIdleDispatches.add(ent);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 设置 mPendingIdleUntil，更新 allow while idle 最小时间！</span></span><br><span class="line">        <span class="comment">// 因为此时系统进入了 idle 状态，需要 rebatch 其他的闹钟，needRebatch 置为 true！</span></span><br><span class="line">        mPendingIdleUntil = a;</span><br><span class="line">        mConstants.updateAllowWhileIdleMinTimeLocked();</span><br><span class="line">        needRebatch = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((a.flags&amp;AlarmManager.FLAG_WAKE_FROM_IDLE) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果该 alarm 是会在 idle 状态下唤醒，如果此时 mNextWakeFromIdle 为 null，或者</span></span><br><span class="line">        <span class="comment">// mNextWakeFromIdle 的触发时间晚，那就更新 mNextWakeFromIdle 为本次设置的新的 alarm！</span></span><br><span class="line">        <span class="keyword">if</span> (mNextWakeFromIdle == <span class="keyword">null</span> || mNextWakeFromIdle.whenElapsed &gt; a.whenElapsed) &#123;</span><br><span class="line">            mNextWakeFromIdle = a;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If this wake from idle is earlier than whatever was previously scheduled,</span></span><br><span class="line">            <span class="comment">// and we are currently idling, then we need to rebatch alarms in case the idle</span></span><br><span class="line">            <span class="comment">// until time needs to be updated.</span></span><br><span class="line">            <span class="comment">// 如果此时</span></span><br><span class="line">            <span class="keyword">if</span> (mPendingIdleUntil != <span class="keyword">null</span>) &#123;</span><br><span class="line">                needRebatch = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果 rebatching 为 true，表示本次是 rebatch 恢复操作，那么就不会进入下面的分支，原因很简单</span></span><br><span class="line">    <span class="comment">// 因为 rebatch 在前面就已经执行的相应的操作了！</span></span><br><span class="line">    <span class="keyword">if</span> (!rebatching) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_VALIDATE) &#123; <span class="comment">// 用于 debug。</span></span><br><span class="line">            <span class="keyword">if</span> (doValidate &amp;&amp; !validateConsistencyLocked()) &#123;</span><br><span class="line">                Slog.v(TAG, <span class="string">"Tipping-point operation: type="</span> + a.type + <span class="string">" when="</span> + a.when</span><br><span class="line">                        + <span class="string">" when(hex)="</span> + Long.toHexString(a.when)</span><br><span class="line">                        + <span class="string">" whenElapsed="</span> + a.whenElapsed</span><br><span class="line">                        + <span class="string">" maxWhenElapsed="</span> + a.maxWhenElapsed</span><br><span class="line">                        + <span class="string">" interval="</span> + a.repeatInterval + <span class="string">" op="</span> + a.operation</span><br><span class="line">                        + <span class="string">" flags=0x"</span> + Integer.toHexString(a.flags));</span><br><span class="line">                rebatchAllAlarmsLocked(<span class="keyword">false</span>);</span><br><span class="line">                needRebatch = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (needRebatch) &#123; <span class="comment">// 如果 needRebatch 为 true，那么我们要重新批处理所有的 alarm！</span></span><br><span class="line">            rebatchAllAlarmsLocked(<span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 调度 kernel 设置 alarm！</span></span><br><span class="line">        rescheduleKernelAlarmsLocked();</span><br><span class="line">        <span class="comment">// 更新下一个 AlarmClock！</span></span><br><span class="line">        updateNextAlarmClockLocked();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该方法的主要逻辑如下：</p>
<h3 id="3-4-1-AlarmMS-fuzzForDuration"><a href="#3-4-1-AlarmMS-fuzzForDuration" class="headerlink" title="3.4.1 AlarmMS.fuzzForDuration"></a>3.4.1 AlarmMS.fuzzForDuration</h3><p>我们来看看 fuzzForDuration 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">fuzzForDuration</span><span class="params">(<span class="keyword">long</span> duration)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (duration &lt; <span class="number">15</span>*<span class="number">60</span>*<span class="number">1000</span>) &#123;</span><br><span class="line">        <span class="comment">//【1】如果 duration 小于 15 分钟，那么我们要调整的时间间隔为 duration</span></span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">int</span>)duration;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (duration &lt; <span class="number">90</span>*<span class="number">60</span>*<span class="number">1000</span>) &#123;</span><br><span class="line">        <span class="comment">//【2】如果 duration 大于等于 15 分钟，小于 1 小时 30 分钟，那么我们要调整的时间间隔为 15 分钟！</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">15</span>*<span class="number">60</span>*<span class="number">1000</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//【2】如果 duration 大于等于 1 小时 30 分钟，那调整的时间间隔为 30 分钟！</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">30</span>*<span class="number">60</span>*<span class="number">1000</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-4-2-AlarmMS-attemptCoalesceLocked"><a href="#3-4-2-AlarmMS-attemptCoalesceLocked" class="headerlink" title="3.4.2 AlarmMS.attemptCoalesceLocked"></a>3.4.2 AlarmMS.attemptCoalesceLocked</h3><p>通过非精确闹钟的触发时间，找到一个合适的 Batch ！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">attemptCoalesceLocked</span><span class="params">(<span class="keyword">long</span> whenElapsed, <span class="keyword">long</span> maxWhen)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> N = mAlarmBatches.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">        Batch b = mAlarmBatches.get(i);</span><br><span class="line">        <span class="comment">// 匹配到合适的 Batch，那就返回该 Batch 下标！</span></span><br><span class="line">        <span class="keyword">if</span> ((b.flags&amp;AlarmManager.FLAG_STANDALONE) == <span class="number">0</span> &amp;&amp; b.canHold(whenElapsed, maxWhen)) &#123;</span><br><span class="line">            <span class="keyword">return</span> i;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 无法找到一个合适的，就返回 -1，创建一个新的！</span></span><br><span class="line">    <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，一个合适的 Batch 满足的条件如下：</p>
<ul>
<li>Batch 的 flags 没有 AlarmManager.FLAG_STANDALONE 标志位，即该 Batch 是只能用于保存非精确闹钟！</li>
<li>canHold 方法返回 true，即：这个 Batch 能够容纳这个 Alarm！</li>
</ul>
<p>下面，我们来看看 canHold 方法的逻辑：</p>
<h4 id="3-4-2-1-AlarmMS-Batch-canHold"><a href="#3-4-2-1-AlarmMS-Batch-canHold" class="headerlink" title="3.4.2.1 AlarmMS.Batch.canHold"></a>3.4.2.1 AlarmMS.Batch.canHold</h4><p>canHold 方法用来判断，该 alarm 是否可以加入到这个 Batch 中：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">canHold</span><span class="params">(<span class="keyword">long</span> whenElapsed, <span class="keyword">long</span> maxWhen)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (end &gt;= whenElapsed) &amp;&amp; (start &lt;= maxWhen);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>从方法中可以看出，可以容纳的依据是：</p>
<ul>
<li>batch.end &gt;= alarm.whenElapsed</li>
<li>batch.start &lt;= alarm.maxWhen</li>
</ul>
<p>即：batch 的时间间隔和 alarm 的触发时间间隔必须有交集！！</p>
<h3 id="3-4-3-AlarmMS-addBatchLocked"><a href="#3-4-3-AlarmMS-addBatchLocked" class="headerlink" title="3.4.3 AlarmMS.addBatchLocked"></a>3.4.3 AlarmMS.addBatchLocked</h3><p>我们来看看 addBatchLocked 方法的逻辑：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">addBatchLocked</span><span class="params">(ArrayList&lt;Batch&gt; list, Batch newBatch)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】其实就是根据 Batch 的 start 时间，查找到一个更合适的 index！</span></span><br><span class="line">    <span class="keyword">int</span> index = Collections.binarySearch(list, newBatch, sBatchOrder);</span><br><span class="line">    <span class="keyword">if</span> (index &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        index = <span class="number">0</span> - index - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】插入 index 位置处！</span></span><br><span class="line">    list.add(index, newBatch);</span><br><span class="line">    <span class="comment">//【3】如果返回 true，表示 Batch 处于 list 的开头位置！</span></span><br><span class="line">    <span class="keyword">return</span> (index == <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的 sBatchOrder 是一个 BatchTimeOrder 实例，实现了 Comparator 接口，用来比较两个 Batch 的 start 时间的大小！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> BatchTimeOrder sBatchOrder = <span class="keyword">new</span> BatchTimeOrder();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">BatchTimeOrder</span> <span class="keyword">implements</span> <span class="title">Comparator</span>&lt;<span class="title">Batch</span>&gt; </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(Batch b1, Batch b2)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">long</span> when1 = b1.start;</span><br><span class="line">            <span class="keyword">long</span> when2 = b2.start;</span><br><span class="line">            <span class="keyword">if</span> (when1 &gt; when2) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (when1 &lt; when2) &#123;</span><br><span class="line">                <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，mAlarmBatches 中的 Batch 是按照开始时间从小到大排序的！！</p>
<p>下面我们来看看 Batch 的相关方法：</p>
<h4 id="3-4-3-1-AlarmMS-Batch-Batch"><a href="#3-4-3-1-AlarmMS-Batch-Batch" class="headerlink" title="3.4.3.1 AlarmMS.Batch.Batch"></a>3.4.3.1 AlarmMS.Batch.Batch</h4><p>当我们要将一个 Alarm 添加到新创建的 Batch 中的时候，会对 Batch 进行初始化：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Batch() &#123;</span><br><span class="line">    start = <span class="number">0</span>;</span><br><span class="line">    end = Long.MAX_VALUE;</span><br><span class="line">    flags = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Batch(Alarm seed) &#123;</span><br><span class="line">    <span class="comment">// 初始化 start 为 alarm 的开始触发时间，end 为 alarm 的最大开始触发时间</span></span><br><span class="line">    start = seed.whenElapsed;</span><br><span class="line">    end = seed.maxWhenElapsed;</span><br><span class="line">    flags = seed.flags;</span><br><span class="line">    alarms.add(seed);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不多说了，继续看！</p>
<h4 id="3-4-3-2-AlarmMS-Batch-add"><a href="#3-4-3-2-AlarmMS-Batch-add" class="headerlink" title="3.4.3.2 AlarmMS.Batch.add"></a>3.4.3.2 AlarmMS.Batch.add</h4><p>将一个 Alarm 添加到已存在的一个 Batch，通过 add 方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">add</span><span class="params">(Alarm alarm)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> newStart = <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">//【1】按照开始触发时间递增的顺序，给这个 alarm 找到合适的位置！</span></span><br><span class="line">    <span class="keyword">int</span> index = Collections.binarySearch(alarms, alarm, sIncreasingTimeOrder);</span><br><span class="line">    <span class="keyword">if</span> (index &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        index = <span class="number">0</span> - index - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】添加到指定的位置！</span></span><br><span class="line">    alarms.add(index, alarm);</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_BATCH) &#123;</span><br><span class="line">        Slog.v(TAG, <span class="string">"Adding "</span> + alarm + <span class="string">" to "</span> + <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【3】更改 Batch 的 start 和 end 时间！</span></span><br><span class="line">    <span class="keyword">if</span> (alarm.whenElapsed &gt; start) &#123;</span><br><span class="line">        start = alarm.whenElapsed;</span><br><span class="line">        newStart = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (alarm.maxWhenElapsed &lt; end) &#123;</span><br><span class="line">        end = alarm.maxWhenElapsed;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【4】更新 Batch 的 flags！</span></span><br><span class="line">    flags |= alarm.flags;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG_BATCH) &#123;</span><br><span class="line">        Slog.v(TAG, <span class="string">"    =&gt; now "</span> + <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> newStart;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到，如果 Batch 的 start 时间发生变化，那么 add 会返回 true！</p>
<p>这里用到了一个比较器对象：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> IncreasingTimeOrder sIncreasingTimeOrder = <span class="keyword">new</span> IncreasingTimeOrder();</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">IncreasingTimeOrder</span> <span class="keyword">implements</span> <span class="title">Comparator</span>&lt;<span class="title">Alarm</span>&gt; </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(Alarm a1, Alarm a2)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">long</span> when1 = a1.whenElapsed;</span><br><span class="line">            <span class="keyword">long</span> when2 = a2.whenElapsed;</span><br><span class="line">            <span class="keyword">if</span> (when1 &gt; when2) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (when1 &lt; when2) &#123;</span><br><span class="line">                <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>sIncreasingTimeOrder 是用来对 Batch 中的 alarm 进行排序的，规则是按照开始时间递增的顺序！</p>
<h3 id="3-4-4-AlarmMS-rescheduleKernelAlarmsLocked"><a href="#3-4-4-AlarmMS-rescheduleKernelAlarmsLocked" class="headerlink" title="3.4.4 AlarmMS.rescheduleKernelAlarmsLocked"></a>3.4.4 AlarmMS.rescheduleKernelAlarmsLocked</h3><p>该方法用于设置下一个 alarm！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">rescheduleKernelAlarmsLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> nextNonWakeup = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 设置最早的 ELAPSED_REALTIME_WAKEUP 类型的 alarm！</span></span><br><span class="line">    <span class="keyword">if</span> (mAlarmBatches.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【3.4.4.1】从 mAlarmBatches 中找到第一个包含 wake up 类型 alarm 的 Batch！</span></span><br><span class="line">        <span class="keyword">final</span> Batch firstWakeup = findFirstWakeupBatchLocked();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【2】从 mAlarmBatches 中找到第一个的 Batch！</span></span><br><span class="line">        <span class="keyword">final</span> Batch firstBatch = mAlarmBatches.get(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【3】如果 firstWakeup 不为 null，且 firstWakeup 中的开始触发时间 start，不等于 mNextWakeup！</span></span><br><span class="line">        <span class="comment">// 那就要更新 mNextWakeup，调整下一个 wake up alarm 的触发时间！</span></span><br><span class="line">        <span class="keyword">if</span> (firstWakeup != <span class="keyword">null</span> &amp;&amp; mNextWakeup != firstWakeup.start) &#123;</span><br><span class="line">            <span class="comment">// 更新 mNextWakeup 和 mLastWakeupSet！</span></span><br><span class="line">            mNextWakeup = firstWakeup.start;</span><br><span class="line">            mLastWakeupSet = SystemClock.elapsedRealtime();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//【3.4.4.2】设置下一个要触发的 wake up 类型的 alarm！</span></span><br><span class="line">            setLocked(ELAPSED_REALTIME_WAKEUP, firstWakeup.start);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【4】如果 firstBatch 不等于 firstWakeup，说明 firstBatch 中不包含 wake up 类型的 alarm！</span></span><br><span class="line">        <span class="comment">// 那就设置下一个非 wake up alarm 的触发时间！</span></span><br><span class="line">        <span class="keyword">if</span> (firstBatch != firstWakeup) &#123;</span><br><span class="line">            nextNonWakeup = firstBatch.start;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// mPendingNonWakeupAlarms 不为 empty，说明系统中存在处于等待状态的 no wakeup 类型的 alarm！</span></span><br><span class="line">    <span class="comment">// 那么如果 nextNonWakeup 为 0，或者 mNextNonWakeupDeliveryTime 小于 nextNonWakeup！</span></span><br><span class="line">    <span class="comment">// 那么更新 nextNonWakeup 为 mNextNonWakeupDeliveryTime 的值！</span></span><br><span class="line">    <span class="keyword">if</span> (mPendingNonWakeupAlarms.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (nextNonWakeup == <span class="number">0</span> || mNextNonWakeupDeliveryTime &lt; nextNonWakeup) &#123;</span><br><span class="line">            nextNonWakeup = mNextNonWakeupDeliveryTime;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 最后如果，本次计算的下一个要触发的 no wake up alarm 的时间和之前的不同，更新 mNextNonWakeup 的值</span></span><br><span class="line">    <span class="comment">// 并设置下一个 no wake up 的 alarm！</span></span><br><span class="line">    <span class="keyword">if</span> (nextNonWakeup != <span class="number">0</span> &amp;&amp; mNextNonWakeup != nextNonWakeup) &#123;</span><br><span class="line">        mNextNonWakeup = nextNonWakeup;</span><br><span class="line">        <span class="comment">//【3.4.4.2】设置下一个要触发的 no wake up 类型的 alarm！</span></span><br><span class="line">        setLocked(ELAPSED_REALTIME, nextNonWakeup);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>变量解释：</strong></p>
<ul>
<li>mNextWakeup 表示下一个最早的 wake up 类型 alarm 的触发时间；</li>
<li>mLastWakeupSet 表示上一次设置 wake up 类型 alarm 的时间，取值为 SystemClock.elapsedRealtime()；</li>
<li>mNextNonWakeup 表示的是下一个最早的 no wake up 类型 alarm 的触发时间；</li>
</ul>
<p>通常，二者是一起设置的！</p>
<p><strong>逻辑梳理</strong>：</p>
<ul>
<li>该方法首先是确定下一个要触发的 wake up 和非 wake up 类型的 alarm 的触发时间：mNextWakeup 和 mNextNonWakeup！<ul>
<li>对于 wake up 类型，那就在所有的 Batch 中找到第一个持有 wake up 类型 alarm 的 Batch，其 Batch.start 就是 mNextWakeup！</li>
<li>对于非 wake up 类型，确定 mNextNonWakeup 要分为以下几步：<ul>
<li>如果第一个持有 wake up 类型 alarm 的 Batch 不是 first batch，那么 firstBatch.Start 为可选值，保存到 nextNonWakeup 中！</li>
<li>如果此时 mPendingNonWakeupAlarms 不为 empty，说明系统中有正在等待的 no wake up 类型的闹钟，如果此时 nextNonWakeup 为 0，或者 mNextNonWakeupDeliveryTime 小于 nextNonWakeup，那么 mNextNonWakeupDeliveryTime 就是一个更优的选择，保存到 nextNonWakeup 中；</li>
<li>最后，如果 nextNonWakeup 和 mNextNonWakeup 不相等，那就使用 nextNonWakeup 更新 mNextNonWakeup！</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><br></p>
<ul>
<li>然后，分别设置两种闹钟！</li>
</ul>
<h4 id="3-4-4-1-AlarmMS-findFirstWakeupBatchLocked"><a href="#3-4-4-1-AlarmMS-findFirstWakeupBatchLocked" class="headerlink" title="3.4.4.1 AlarmMS.findFirstWakeupBatchLocked"></a>3.4.4.1 AlarmMS.findFirstWakeupBatchLocked</h4><p>findFirstWakeupBatchLocked 方法在所有的 Batch 中找到第一个包含 wake up 类型 alarm 的 Batch，然后返回！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Batch <span class="title">findFirstWakeupBatchLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> N = mAlarmBatches.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">        Batch b = mAlarmBatches.get(i);</span><br><span class="line">        <span class="keyword">if</span> (b.hasWakeups()) &#123; <span class="comment">// 判断该 Batch 是否包含 wake up 类型的 alarm！</span></span><br><span class="line">            <span class="keyword">return</span> b;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里调用了 Batch 的 hasWakeups 接口：</p>
<h5 id="3-4-4-1-1-AlarmMS-Batch-hasWakeups"><a href="#3-4-4-1-1-AlarmMS-Batch-hasWakeups" class="headerlink" title="3.4.4.1.1 AlarmMS.Batch.hasWakeups"></a>3.4.4.1.1 AlarmMS.Batch.hasWakeups</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">hasWakeups</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> N = alarms.size();</span><br><span class="line">    <span class="comment">// 遍历其内部的所有的 Alarm！</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">        Alarm a = alarms.get(i);</span><br><span class="line">        <span class="comment">// 这里的 type 取值为 AlarmManager 中的四种</span></span><br><span class="line">        <span class="keyword">if</span> ((a.type &amp; TYPE_NONWAKEUP_MASK) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-4-4-2-AlarmMS-setLocked"><a href="#3-4-4-2-AlarmMS-setLocked" class="headerlink" title="3.4.4.2 AlarmMS.setLocked"></a>3.4.4.2 AlarmMS.setLocked</h4><p>用于设置一个 alarm！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setLocked</span><span class="params">(<span class="keyword">int</span> type, <span class="keyword">long</span> when)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mNativeData != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 记录秒和纳秒！</span></span><br><span class="line">        <span class="keyword">long</span> alarmSeconds, alarmNanoseconds;</span><br><span class="line">        <span class="keyword">if</span> (when &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            alarmSeconds = <span class="number">0</span>;</span><br><span class="line">            alarmNanoseconds = <span class="number">0</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            alarmSeconds = when / <span class="number">1000</span>;</span><br><span class="line">            alarmNanoseconds = (when % <span class="number">1000</span>) * <span class="number">1000</span> * <span class="number">1000</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 设置 alarm！</span></span><br><span class="line">        set(mNativeData, type, alarmSeconds, alarmNanoseconds);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Message msg = Message.obtain();</span><br><span class="line">        msg.what = ALARM_EVENT;</span><br><span class="line">        </span><br><span class="line">        mHandler.removeMessages(ALARM_EVENT);</span><br><span class="line">        mHandler.sendMessageAtTime(msg, when);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们可以看到，这里使用了 2 中方式来设置闹钟！</p>
<p><strong>第一种</strong>：通过 Alarm 驱动来设置</p>
<p>mNativeData 不为 0，表示 Alarm 驱动存在，就直接调用 set 方法，通过 Alarm 驱动设置这个 alarm！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(<span class="keyword">long</span> nativeData, <span class="keyword">int</span> type, <span class="keyword">long</span> seconds, <span class="keyword">long</span> nanoseconds)</span></span>;</span><br></pre></td></tr></table></figure>
<p>当然，正常情况，是通过 Alarm 驱动来设置的，因为这样能够实现休眠唤醒！</p>
<p>除非找不到 Alarm 驱动</p>
<p>mNativeData 为 0，说明 Alarm 驱动不存在，那就通过 Timer 定时器设置，这里通过发送一个 ALARM_EVENT 给 AlarmHandler，然后处理消息，设置 alarm！</p>
<h4 id="3-4-4-3-AlarmMS-updateNextAlarmInfoForUserLocked"><a href="#3-4-4-3-AlarmMS-updateNextAlarmInfoForUserLocked" class="headerlink" title="3.4.4.3 AlarmMS.updateNextAlarmInfoForUserLocked"></a>3.4.4.3 AlarmMS.updateNextAlarmInfoForUserLocked</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateNextAlarmInfoForUserLocked</span><span class="params">(<span class="keyword">int</span> userId,</span></span></span><br><span class="line"><span class="function"><span class="params">        AlarmManager.AlarmClockInfo alarmClock)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (alarmClock != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_ALARM_CLOCK) &#123;</span><br><span class="line">            Log.v(TAG, <span class="string">"Next AlarmClockInfoForUser("</span> + userId + <span class="string">"): "</span> +</span><br><span class="line">                    formatNextAlarm(getContext(), alarmClock, userId));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【1】更新 alarmClock！</span></span><br><span class="line">        mNextAlarmClockForUser.put(userId, alarmClock);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_ALARM_CLOCK) &#123;</span><br><span class="line">            Log.v(TAG, <span class="string">"Next AlarmClockInfoForUser("</span> + userId + <span class="string">"): None"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【1】移除指定的 userId 信息！</span></span><br><span class="line">        mNextAlarmClockForUser.remove(userId);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 将 mPendingSendNextAlarmClockChangedForUser 中 userId 对应的置为 true！</span></span><br><span class="line">    mPendingSendNextAlarmClockChangedForUser.put(userId, <span class="keyword">true</span>);</span><br><span class="line">    </span><br><span class="line">    mHandler.removeMessages(AlarmHandler.SEND_NEXT_ALARM_CLOCK_CHANGED);</span><br><span class="line">    <span class="comment">// 发送 SEND_NEXT_ALARM_CLOCK_CHANGED 给 AlarmHandler！</span></span><br><span class="line">    mHandler.sendEmptyMessage(AlarmHandler.SEND_NEXT_ALARM_CLOCK_CHANGED);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>关于 AlarmHandler 我们后面会提到！</p>
<h3 id="3-4-5-AlarmMS-updateNextAlarmClockLocked"><a href="#3-4-5-AlarmMS-updateNextAlarmClockLocked" class="headerlink" title="3.4.5 AlarmMS.updateNextAlarmClockLocked"></a>3.4.5 AlarmMS.updateNextAlarmClockLocked</h3><p>该方法用于更新下一个 AlarmClock 的时间，当我们触发或者移除了一个 setAlarmClock 设置的 alarm 后，需要更新下一个 AlarmClock 的触发！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateNextAlarmClockLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】如果 mNextAlarmClockMayChange 为 false，表示并没有移除或者触发一个 AlarmClock 闹钟，那就返回！</span></span><br><span class="line">    <span class="keyword">if</span> (!mNextAlarmClockMayChange) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】设置 mNextAlarmClockMayChange 为 false；</span></span><br><span class="line">    mNextAlarmClockMayChange = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】用于缓存更新后的所有的 AlarmClock，用于后续更新 mNextAlarmClockForUser！</span></span><br><span class="line">    SparseArray&lt;AlarmManager.AlarmClockInfo&gt; nextForUser = mTmpSparseAlarmClockArray;</span><br><span class="line">    nextForUser.clear();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【4】遍历所有的 Alarm Batch，找到所有的 AlarmClock 闹钟！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> N = mAlarmBatches.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">        ArrayList&lt;Alarm&gt; alarms = mAlarmBatches.get(i).alarms;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> M = alarms.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; M; j++) &#123;</span><br><span class="line">            Alarm a = alarms.get(j);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【4.1】a.alarmClock 不为 null，说明这是一个 AlarmClock 类型的闹钟！ </span></span><br><span class="line">            <span class="keyword">if</span> (a.alarmClock != <span class="keyword">null</span>) &#123;</span><br><span class="line">            </span><br><span class="line">                <span class="comment">// 获得 AlarmClock 所属的 userId！</span></span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> userId = UserHandle.getUserId(a.uid);</span><br><span class="line">                <span class="comment">// 获得该 userId 下的当前 AlarmClock！</span></span><br><span class="line">                AlarmManager.AlarmClockInfo current = mNextAlarmClockForUser.get(userId);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (DEBUG_ALARM_CLOCK) &#123;</span><br><span class="line">                    Log.v(TAG, <span class="string">"Found AlarmClockInfo "</span> + a.alarmClock + <span class="string">" at "</span> +</span><br><span class="line">                            formatNextAlarm(getContext(), a.alarmClock, userId) +</span><br><span class="line">                            <span class="string">" for user "</span> + userId);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Alarms 和 Batches 是通过时间排序的，所以这需要比较时间！</span></span><br><span class="line">                <span class="keyword">if</span> (nextForUser.get(userId) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// 如果缓存中的 userId 是第一次添加，那将 a.alarmClock 添加到缓存中，不考虑 current！</span></span><br><span class="line">                    nextForUser.put(userId, a.alarmClock); </span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (a.alarmClock.equals(current)</span><br><span class="line">                        &amp;&amp; current.getTriggerTime() &lt;= nextForUser.get(userId).getTriggerTime()) &#123;</span><br><span class="line">                     <span class="comment">// nextForUser.get(userId) 不等于 null，说明该 userId 在缓存中已经有 AlarmClock 了！</span></span><br><span class="line">                    <span class="comment">// 相同 userId，alarmClock 相同，但是 current 触发时间比缓存中的更早，那就用 current 替换缓存中！</span></span><br><span class="line">                    nextForUser.put(userId, current);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【5】通过上面的预处理，缓存 nextForUser 中存储的是每个 userId 下最早触发的 alarmClock！</span></span><br><span class="line">    <span class="comment">// 接着是用缓存 nextForUser 更新 mNextAlarmClockForUser！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> NN = nextForUser.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; NN; i++) &#123;</span><br><span class="line">        AlarmManager.AlarmClockInfo newAlarm = nextForUser.valueAt(i);</span><br><span class="line">        <span class="keyword">int</span> userId = nextForUser.keyAt(i);</span><br><span class="line">        AlarmManager.AlarmClockInfo currentAlarm = mNextAlarmClockForUser.get(userId);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【4.1】相同 userId，但是 AlarmClockInfo 不相等，那就更新 mNextAlarmClockForUser！</span></span><br><span class="line">        <span class="keyword">if</span> (!newAlarm.equals(currentAlarm)) &#123;</span><br><span class="line">            updateNextAlarmInfoForUserLocked(userId, newAlarm);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【6】移除 mNextAlarmClockForUser 已经触发的 AlarmClock！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> NNN = mNextAlarmClockForUser.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = NNN - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        <span class="keyword">int</span> userId = mNextAlarmClockForUser.keyAt(i);</span><br><span class="line">        <span class="keyword">if</span> (nextForUser.get(userId) == <span class="keyword">null</span>) &#123;</span><br><span class="line">        </span><br><span class="line">            <span class="comment">//【3.4.5.1】调用 updateNextAlarmInfoForUserLocked</span></span><br><span class="line">            updateNextAlarmInfoForUserLocked(userId, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>变量说明</strong>：</p>
<p>mNextAlarmClockForUser 用于保存每个 userId 下即将出发的下一个 AlarmClock！</p>
<p><strong>方法的流程总结</strong>：</p>
<ul>
<li>获得当前系统中最新的 AlarmClock 信息，保存到缓存 nextForUser 中；<ul>
<li>如果缓存 nextForUser 中 userId 下还没有 AlarmClock，那就将该 AlarmClock 添加到缓存中！</li>
<li>如果缓存 nextForUser 中 userId 下已经有某个 AlarmClock，那就进一步比较：<ul>
<li>只有当该 userId 下的缓存 AlarmClock 和 mNextAlarmClockForUser 中对应的 AlarmClock 相等，且 mNextAlarmClockForUser 中对应的 AlarmClock 触发时间更早，才会替换缓存；否则，保留缓存！</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><br></p>
<ul>
<li>用缓存 nextForUser 来更新 mNextAlarmClockForUser 列表；<ul>
<li>再次比较缓存 nextForUser 和 mNextAlarmClockForUser 中 userId 相同的 AlarmClock，如果二者不相同，用缓存更新 mNextAlarmClockForUser！</li>
</ul>
</li>
</ul>
<p><br></p>
<ul>
<li>删除 mNextAlarmClockForUser 中某些 userId 下已经无效的 Alarm；</li>
</ul>
<h4 id="3-4-5-1-AlarmMS-updateNextAlarmInfoForUserLocked"><a href="#3-4-5-1-AlarmMS-updateNextAlarmInfoForUserLocked" class="headerlink" title="3.4.5.1 AlarmMS.updateNextAlarmInfoForUserLocked"></a>3.4.5.1 AlarmMS.updateNextAlarmInfoForUserLocked</h4><p>为指定 userId 更新 AlarmClock</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateNextAlarmInfoForUserLocked</span><span class="params">(<span class="keyword">int</span> userId,</span></span></span><br><span class="line"><span class="function"><span class="params">        AlarmManager.AlarmClockInfo alarmClock)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】如果传入的 alarmClock 不为 null，那就替换 userId 下已有的 alarmClock！</span></span><br><span class="line">    <span class="comment">// 如果传入的 alarmClock 为 null，那就移除 userId 和对应的 alarmClock！</span></span><br><span class="line">    <span class="keyword">if</span> (alarmClock != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_ALARM_CLOCK) &#123;</span><br><span class="line">            Log.v(TAG, <span class="string">"Next AlarmClockInfoForUser("</span> + userId + <span class="string">"): "</span> +</span><br><span class="line">                    formatNextAlarm(getContext(), alarmClock, userId));</span><br><span class="line">        &#125;</span><br><span class="line">        mNextAlarmClockForUser.put(userId, alarmClock);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_ALARM_CLOCK) &#123;</span><br><span class="line">            Log.v(TAG, <span class="string">"Next AlarmClockInfoForUser("</span> + userId + <span class="string">"): None"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        mNextAlarmClockForUser.remove(userId);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【2】当某个 userId 下的 AlarmClock 发生了变化，我们会将其记录到 mPendingSendNextAlarmClockChangedForUser 列表中！</span></span><br><span class="line">    mPendingSendNextAlarmClockChangedForUser.put(userId, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】发送 SEND_NEXT_ALARM_CLOCK_CHANGED 给 AlarmHandler，AlarmHandler 会处理该消息！</span></span><br><span class="line">    mHandler.removeMessages(AlarmHandler.SEND_NEXT_ALARM_CLOCK_CHANGED);</span><br><span class="line">    mHandler.sendEmptyMessage(AlarmHandler.SEND_NEXT_ALARM_CLOCK_CHANGED);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>mPendingSendNextAlarmClockChangedForUser 列表用来记录某个 userId 下的 AlarmClock 发生了变化，如果发生了变化，他会用 userId -&gt; true 的映射关系保存！</p>
<p>最后会发送 AlarmHandler.SEND_NEXT_ALARM_CLOCK_CHANGED 给 AlarmHandler 来处理，我们去看看：</p>
<h5 id="3-4-5-1-1-AlarmMS-AlarmHandler-SEND-NEXT-ALARM-CLOCK-CHANGED"><a href="#3-4-5-1-1-AlarmMS-AlarmHandler-SEND-NEXT-ALARM-CLOCK-CHANGED" class="headerlink" title="3.4.5.1.1 AlarmMS.AlarmHandler[SEND_NEXT_ALARM_CLOCK_CHANGED]"></a>3.4.5.1.1 AlarmMS.AlarmHandler[SEND_NEXT_ALARM_CLOCK_CHANGED]</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> SEND_NEXT_ALARM_CLOCK_CHANGED:</span><br><span class="line">    sendNextAlarmClockChanged();</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<p>AlarmHandler 会调用 sendNextAlarmClockChanged 来处理消息：</p>
<h5 id="3-4-5-1-2-AlarmMS-sendNextAlarmClockChanged"><a href="#3-4-5-1-2-AlarmMS-sendNextAlarmClockChanged" class="headerlink" title="3.4.5.1.2 AlarmMS.sendNextAlarmClockChanged"></a>3.4.5.1.2 AlarmMS.sendNextAlarmClockChanged</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sendNextAlarmClockChanged</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】创建了一个 SparseArray 数组，用于保存要处理的 userId 和其 AlarmClock！</span></span><br><span class="line">    SparseArray&lt;AlarmManager.AlarmClockInfo&gt; pendingUsers = mHandlerSparseAlarmClockArray;</span><br><span class="line">    pendingUsers.clear();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】将 mPendingSendNextAlarmClockChangedForUser 的 user Id 和对应的 AlarmClock 保存到 pendingUsers 中！</span></span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> N  = mPendingSendNextAlarmClockChangedForUser.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">            <span class="keyword">int</span> userId = mPendingSendNextAlarmClockChangedForUser.keyAt(i);</span><br><span class="line">            pendingUsers.append(userId, mNextAlarmClockForUser.get(userId));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 清空 mPendingSendNextAlarmClockChangedForUser！</span></span><br><span class="line">        mPendingSendNextAlarmClockChangedForUser.clear();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】保存 AlarmClock 信息，并发送广播！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> N = pendingUsers.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">        <span class="keyword">int</span> userId = pendingUsers.keyAt(i);</span><br><span class="line">        AlarmManager.AlarmClockInfo alarmClock = pendingUsers.valueAt(i);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将这个 AlarmClock 的信息保存到 Settings 数据库中！</span></span><br><span class="line">        Settings.System.putStringForUser(getContext().getContentResolver(),</span><br><span class="line">                Settings.System.NEXT_ALARM_FORMATTED,</span><br><span class="line">                formatNextAlarm(getContext(), alarmClock, userId),</span><br><span class="line">                userId);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 发送 NEXT_ALARM_CLOCK_CHANGED_INTENT 给指定的 userId！</span></span><br><span class="line">        getContext().sendBroadcastAsUser(NEXT_ALARM_CLOCK_CHANGED_INTENT,</span><br><span class="line">                <span class="keyword">new</span> UserHandle(userId));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>mHandlerSparseAlarmClockArray 是一个预先创建的 SparseArray，没有很特殊的用途！</p>
<p>在 sendNextAlarmClockChanged 方法中，我们会处理前面的 mPendingSendNextAlarmClockChangedForUser！</p>
<h2 id="3-5-阶段总结"><a href="#3-5-阶段总结" class="headerlink" title="3.5 阶段总结"></a>3.5 阶段总结</h2><p>到这里，我们 setAlarm 的整个流程就分析完成了，下面，我们来总结一下整个过程！</p>
<p>… … …</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2017/07/06/Permission第 3 篇 - checkPermissions 权限检查/">Permission第 3 篇 - checkPermissions 权限检查</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2017-07-06</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/AndroidFramework源码分析/">AndroidFramework源码分析</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/AndroidFramework源码分析/Permission权限管理/">Permission权限管理</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/Permission权限管理/">Permission权限管理</a></span><div class="content"><p>[toc]</p>
<h1 id="0-综述"><a href="#0-综述" class="headerlink" title="0 综述"></a>0 综述</h1><p>基于 Android 7.1.1 源码，分析系统的权限管理机制！</p>
<p>下面来看下系统中的 check permission 相关的接口：</p>
<h1 id="1-Context-权限检查接口-ContextImpl"><a href="#1-Context-权限检查接口-ContextImpl" class="headerlink" title="1 Context 权限检查接口 - ContextImpl"></a>1 Context 权限检查接口 - ContextImpl</h1><p>在应用中申请权限离不开 Context，Context 中暴露了多个检查权限相关的接口，具体的实现是在 ContextImpl 中！</p>
<h2 id="1-1-checkCallingPermission"><a href="#1-1-checkCallingPermission" class="headerlink" title="1.1 checkCallingPermission"></a>1.1 checkCallingPermission</h2><p>检查来自其他进程的调用者的是否有权限，该接口不能用于检查自身是否具有权限！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">checkCallingPermission</span><span class="params">(String permission)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (permission == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"permission is null"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> pid = Binder.getCallingPid();</span><br><span class="line">    <span class="keyword">if</span> (pid != Process.myPid()) &#123;</span><br><span class="line">        <span class="comment">//【*1.3】调用自身的 checkPermission 方法！</span></span><br><span class="line">        <span class="keyword">return</span> checkPermission(permission, pid, Binder.getCallingUid());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> PackageManager.PERMISSION_DENIED;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>应用程序权限检查，最终需要进入框架层！</p>
<h2 id="1-2-checkCallingOrSelfPermission"><a href="#1-2-checkCallingOrSelfPermission" class="headerlink" title="1.2 checkCallingOrSelfPermission"></a>1.2 checkCallingOrSelfPermission</h2><p>该方法和 checkCallingPermission 不同，他还可以检查自身是否具有权限！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">checkCallingOrSelfPermission</span><span class="params">(String permission)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (permission == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"permission is null"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【*1.3】调用自身的 checkPermission 方法！</span></span><br><span class="line">    <span class="keyword">return</span> checkPermission(permission, Binder.getCallingPid(),</span><br><span class="line">            Binder.getCallingUid());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="1-3-checkPermission"><a href="#1-3-checkPermission" class="headerlink" title="1.3 checkPermission"></a>1.3 checkPermission</h2><ul>
<li><strong>checkPermission[3]</strong></li>
</ul>
<p>该方法需要指定 pid 和 uid：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">checkPermission</span><span class="params">(String permission, <span class="keyword">int</span> pid, <span class="keyword">int</span> uid)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (permission == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"permission is null"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【*2.2】调用了 ams 的 checkPermission 接口</span></span><br><span class="line">        <span class="keyword">return</span> ActivityManagerNative.getDefault().checkPermission(</span><br><span class="line">                permission, pid, uid);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">return</span> PackageManager.PERMISSION_DENIED;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>checkPermission[4]</strong></li>
</ul>
<p>还有一个重载函数，需要额外传入一个 callerToken 实例，这里是一个 hide 方法，目前是隐藏的，只能由系统调用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">checkPermission</span><span class="params">(String permission, <span class="keyword">int</span> pid, <span class="keyword">int</span> uid, IBinder callerToken)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (permission == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"permission is null"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【*2.10】调用了 ams 的 checkPermissionWithToken 接口</span></span><br><span class="line">        <span class="keyword">return</span> ActivityManagerNative.getDefault().checkPermissionWithToken(</span><br><span class="line">                permission, pid, uid, callerToken);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">return</span> PackageManager.PERMISSION_DENIED;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="1-4-Check-Uri-Permissions"><a href="#1-4-Check-Uri-Permissions" class="headerlink" title="1.4 Check Uri Permissions"></a>1.4 Check Uri Permissions</h2><p>ContextImpl 还提供了检查 Uri Permissions 的接口，这些接口依赖于一个 modeFlags 标志位，取值有如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Intent.FLAG_GRANT_READ_URI_PERMISSION</span><br><span class="line">Intent.FLAG_GRANT_WRITE_URI_PERMISSION</span><br></pre></td></tr></table></figure>
<p>下面我们来看下相关的接口的逻辑：</p>
<h3 id="1-4-1-checkCallingUriPermission"><a href="#1-4-1-checkCallingUriPermission" class="headerlink" title="1.4.1 checkCallingUriPermission"></a>1.4.1 checkCallingUriPermission</h3><p>同样的，这个方法只能检查其他进程是否具有访问 uri 权限！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">checkCallingUriPermission</span><span class="params">(Uri uri, <span class="keyword">int</span> modeFlags)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> pid = Binder.getCallingPid();</span><br><span class="line">    <span class="keyword">if</span> (pid != Process.myPid()) &#123;</span><br><span class="line">        <span class="comment">//【*1.4.3】调用 ContextImpl 的 checkUriPermission 方法！</span></span><br><span class="line">        <span class="keyword">return</span> checkUriPermission(uri, pid,</span><br><span class="line">                Binder.getCallingUid(), modeFlags);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> PackageManager.PERMISSION_DENIED;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-4-2-checkCallingOrSelfUriPermission"><a href="#1-4-2-checkCallingOrSelfUriPermission" class="headerlink" title="1.4.2 checkCallingOrSelfUriPermission"></a>1.4.2 checkCallingOrSelfUriPermission</h3><p>同样的，这个方法能检查其他进程或者自身是否具有访问 uri 权限！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">checkCallingOrSelfUriPermission</span><span class="params">(Uri uri, <span class="keyword">int</span> modeFlags)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【*1.4.3】调用 ContextImpl 的 checkUriPermission 方法！</span></span><br><span class="line">    <span class="keyword">return</span> checkUriPermission(uri, Binder.getCallingPid(),</span><br><span class="line">            Binder.getCallingUid(), modeFlags);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-4-3-checkUriPermission"><a href="#1-4-3-checkUriPermission" class="headerlink" title="1.4.3 checkUriPermission"></a>1.4.3 checkUriPermission</h3><p>checkUriPermission 方法一共有三个重载实现：</p>
<ul>
<li><strong>checkUriPermission[6]</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">checkUriPermission</span><span class="params">(Uri uri, String readPermission,</span></span></span><br><span class="line"><span class="function"><span class="params">        String writePermission, <span class="keyword">int</span> pid, <span class="keyword">int</span> uid, <span class="keyword">int</span> modeFlags)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">        Log.i(<span class="string">"foo"</span>, <span class="string">"checkUriPermission: uri="</span> + uri + <span class="string">"readPermission="</span></span><br><span class="line">                + readPermission + <span class="string">" writePermission="</span> + writePermission</span><br><span class="line">                + <span class="string">" pid="</span> + pid + <span class="string">" uid="</span> + uid + <span class="string">" mode"</span> + modeFlags);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【1】如果 flags 设置了 FLAG_GRANT_READ_URI_PERMISSION 标志位，那么</span></span><br><span class="line">    <span class="comment">// 如果 readPermission 不为 null，且 pid uid 是有这个 readPermission 权限的；</span></span><br><span class="line">    <span class="comment">// 那就返回 PERMISSION_GRANTED</span></span><br><span class="line">    <span class="keyword">if</span> ((modeFlags &amp; Intent.FLAG_GRANT_READ_URI_PERMISSION) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (readPermission == <span class="keyword">null</span></span><br><span class="line">                || checkPermission(readPermission, pid, uid)</span><br><span class="line">                == PackageManager.PERMISSION_GRANTED) &#123;</span><br><span class="line">            <span class="keyword">return</span> PackageManager.PERMISSION_GRANTED;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】如果 flags 设置了 FLAG_GRANT_WRITE_URI_PERMISSION 标志位，那么</span></span><br><span class="line">    <span class="comment">// 如果 writePermission 不为 null，且 pid uid 是有这个 writePermission 权限的；</span></span><br><span class="line">    <span class="comment">// 那就返回 PERMISSION_GRANTED</span></span><br><span class="line">    <span class="keyword">if</span> ((modeFlags &amp; Intent.FLAG_GRANT_WRITE_URI_PERMISSION) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (writePermission == <span class="keyword">null</span></span><br><span class="line">                || checkPermission(writePermission, pid, uid)</span><br><span class="line">                == PackageManager.PERMISSION_GRANTED) &#123;</span><br><span class="line">            <span class="keyword">return</span> PackageManager.PERMISSION_GRANTED;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【*self-other】上述条件不满足的话，会进入到这部分中，调用另外一个重载的函数：</span></span><br><span class="line">    <span class="keyword">return</span> uri != <span class="keyword">null</span> ? checkUriPermission(uri, pid, uid, modeFlags)</span><br><span class="line">            : PackageManager.PERMISSION_DENIED;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>checkUriPermission[4]</strong></li>
</ul>
<p>第二个 checkUriPermission 会被第一个方法调用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">checkUriPermission</span><span class="params">(Uri uri, <span class="keyword">int</span> pid, <span class="keyword">int</span> uid, <span class="keyword">int</span> modeFlags)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【*2.9】调用 ams 的 checkUriPermission 方法！</span></span><br><span class="line">        <span class="keyword">return</span> ActivityManagerNative.getDefault().checkUriPermission(</span><br><span class="line">                ContentProvider.getUriWithoutUserId(uri), pid, uid, modeFlags,</span><br><span class="line">                resolveUserId(uri), <span class="keyword">null</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">return</span> PackageManager.PERMISSION_DENIED;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>checkUriPermission[5]</strong></li>
</ul>
<p>第三个 checkUriPermission 方法，需要传入一个 IBinder token 对象，这是一个 hide 方法，只能由系统调用！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">checkUriPermission</span><span class="params">(Uri uri, <span class="keyword">int</span> pid, <span class="keyword">int</span> uid, <span class="keyword">int</span> modeFlags, IBinder callerToken)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【*2.9】调用 ams 的 checkUriPermission 方法！</span></span><br><span class="line">        <span class="keyword">return</span> ActivityManagerNative.getDefault().checkUriPermission(</span><br><span class="line">                ContentProvider.getUriWithoutUserId(uri), pid, uid, modeFlags,</span><br><span class="line">                resolveUserId(uri), callerToken);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">return</span> PackageManager.PERMISSION_DENIED;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="2-框架层权限检查接口-ActivityManagerService"><a href="#2-框架层权限检查接口-ActivityManagerService" class="headerlink" title="2 框架层权限检查接口 - ActivityManagerService"></a>2 框架层权限检查接口 - ActivityManagerService</h1><p>我们来看看 Android 7.1.1 中框架层提供了那些用于校验权限的接口，这些接口主要位于 ActivityManager，ActivityManagerService 中，我们做一个简单的归类！</p>
<ul>
<li>访问 ContentProvider 的权限校验；</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">String <span class="title">checkContentProviderPermissionLocked</span><span class="params">(ProviderInfo cpi, ProcessRecord r, <span class="keyword">int</span> userId, <span class="keyword">boolean</span> checkUser)</span></span></span><br></pre></td></tr></table></figure>
<ul>
<li>判断 pid，uid 对应的进程是否具有某个权限；</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// 检测调用者的权限，第一个方法会调用第二个方法！</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">checkCallingPermission</span><span class="params">(String permission)</span> </span>&#123;...&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">checkPermission</span><span class="params">(String permission, <span class="keyword">int</span> pid, <span class="keyword">int</span> uid)</span> </span>&#123;...&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>检测组件的权限；</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// 检测组件的权限</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">checkComponentPermission</span><span class="params">(String permission, <span class="keyword">int</span> pid, <span class="keyword">int</span> uid, <span class="keyword">int</span> owningUid, <span class="keyword">boolean</span> exported)</span>  </span>&#123;...&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>检测 Uri 相关的权限；</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">checkGrantUriPermission</span><span class="params">(<span class="keyword">int</span> callingUid, String targetPkg, Uri uri, </span></span></span><br><span class="line"><span class="function"><span class="params">                                                    <span class="keyword">final</span> <span class="keyword">int</span> modeFlags, <span class="keyword">int</span> userId)</span>  </span>&#123;...&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">NeededUriGrants <span class="title">checkGrantUriPermissionFromIntentLocked</span><span class="params">(<span class="keyword">int</span> callingUid, String targetPkg, Intent intent,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                    <span class="keyword">int</span> mode, NeededUriGrants needed, <span class="keyword">int</span> targetUserId)</span>  </span>&#123;...&#125;</span><br><span class="line">            </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">checkGrantUriPermissionLocked</span><span class="params">(<span class="keyword">int</span> callingUid, String targetPkg, GrantUri grantUri, </span></span></span><br><span class="line"><span class="function"><span class="params">                                                    <span class="keyword">final</span> <span class="keyword">int</span> modeFlags, <span class="keyword">int</span> lastTargetUid)</span>  </span>&#123;...&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">checkUriPermission</span><span class="params">(Uri uri, <span class="keyword">int</span> pid, <span class="keyword">int</span> uid, <span class="keyword">final</span> <span class="keyword">int</span> modeFlags, <span class="keyword">int</span> userId, IBinder callerToken)</span> </span>&#123;...&#125;</span><br><span class="line">            </span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">checkUriPermissionLocked</span><span class="params">(GrantUri grantUri, <span class="keyword">int</span> uid, <span class="keyword">final</span> <span class="keyword">int</span> modeFlags)</span> </span>&#123;...&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">checkHoldingPermissionsLocked</span><span class="params">(IPackageManager pm, ProviderInfo pi, GrantUri grantUri,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                                    <span class="keyword">int</span> uid, <span class="keyword">final</span> <span class="keyword">int</span> modeFlags)</span>  </span>&#123;...&#125;</span><br><span class="line">                                </span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">checkHoldingPermissionsInternalLocked</span><span class="params">(IPackageManager pm, ProviderInfo pi, GrantUri grantUri,</span></span></span><br><span class="line"><span class="function"><span class="params">                                        <span class="keyword">int</span> uid, <span class="keyword">final</span> <span class="keyword">int</span> modeFlags, <span class="keyword">boolean</span> considerUidPermissions)</span>  </span>&#123;...&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>检测 Binder 对象的权限；</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">checkPermissionWithToken</span><span class="params">(String permission, <span class="keyword">int</span> pid, <span class="keyword">int</span> uid, IBinder callerToken)</span>  </span>&#123;...&#125;</span><br></pre></td></tr></table></figure>
<p>同时，系统也提供了一些强制检查权限的接口，以 enforce 开头，我们在很多的系统调用过程中都会看到，这些接口会调用上面的接口来查询权限是否授予，没有授予会抛出异常，这里就不再列举！</p>
<h2 id="2-1-checkCallingPermission"><a href="#2-1-checkCallingPermission" class="headerlink" title="2.1 checkCallingPermission"></a>2.1 checkCallingPermission</h2><p>该方法用于判断调用者是否具有指定的权限，内部会自动通过 Binder 相关接口获得调用者的 pid 和 uid！！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">checkCallingPermission</span><span class="params">(String permission)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【*2.2】这里调用了 checkPermission 方法！</span></span><br><span class="line">    <span class="keyword">return</span> checkPermission(permission,</span><br><span class="line">            Binder.getCallingPid(),</span><br><span class="line">            UserHandle.getAppId(Binder.getCallingUid()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>该方法内部会通过 Binder.getCallingPid() 和 Binder.getCallingUid() 方法，计算 pid 和 uid！</p>
<h3 id="2-1-1-调用时机"><a href="#2-1-1-调用时机" class="headerlink" title="2.1.1 调用时机"></a>2.1.1 调用时机</h3><p>checkCallingPermission 方法系统中调用的很多，一些重要服务都会调用它来检查权限，比如 InputManagerService，WindowManagerService，NotificationManagerService，DisplayManagerService 等等，下面只简单列出来几个：</p>
<h4 id="2-1-1-1-NotificationManagerService-enforcePolicyAccess"><a href="#2-1-1-1-NotificationManagerService-enforcePolicyAccess" class="headerlink" title="2.1.1.1 NotificationManagerService.enforcePolicyAccess"></a>2.1.1.1 NotificationManagerService.enforcePolicyAccess</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">enforcePolicyAccess</span><span class="params">(String pkg, String method)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】检查调用者是否有 MANAGE_NOTIFICATIONS 权限</span></span><br><span class="line">    <span class="keyword">if</span> (PackageManager.PERMISSION_GRANTED == getContext().checkCallingPermission(</span><br><span class="line">            android.Manifest.permission.MANAGE_NOTIFICATIONS)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    checkCallerIsSameApp(pkg);</span><br><span class="line">    <span class="keyword">if</span> (!checkPolicyAccess(pkg)) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Notification policy access denied calling "</span> + method);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"Notification policy access denied"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>NotificationManagerService 有很多方法设计到了权限校验，这里只是举例展示。</p>
<h4 id="2-1-1-2-InputManagerService-addKeyboardLayoutForInputDevice"><a href="#2-1-1-2-InputManagerService-addKeyboardLayoutForInputDevice" class="headerlink" title="2.1.1.2 InputManagerService.addKeyboardLayoutForInputDevice"></a>2.1.1.2 InputManagerService.addKeyboardLayoutForInputDevice</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span> <span class="comment">// Binder call</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addKeyboardLayoutForInputDevice</span><span class="params">(InputDeviceIdentifier identifier,</span></span></span><br><span class="line"><span class="function"><span class="params">        String keyboardLayoutDescriptor)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】检查调用者是否有 SET_KEYBOARD_LAYOUT 权限</span></span><br><span class="line">    <span class="keyword">if</span> (!checkCallingPermission(android.Manifest.permission.SET_KEYBOARD_LAYOUT,</span><br><span class="line">            <span class="string">"addKeyboardLayoutForInputDevice()"</span>)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"Requires SET_KEYBOARD_LAYOUT permission"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ... ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>InputManagerService 有很多方法设计到了权限校验，这里只是举例展示。</p>
<h4 id="2-1-1-3-WindowManagerService-startAppFreezingScreen"><a href="#2-1-1-3-WindowManagerService-startAppFreezingScreen" class="headerlink" title="2.1.1.3 WindowManagerService.startAppFreezingScreen"></a>2.1.1.3 WindowManagerService.startAppFreezingScreen</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startAppFreezingScreen</span><span class="params">(IBinder token, <span class="keyword">int</span> configChanges)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】检查调用者是否有 MANAGE_APP_TOKENS 权限</span></span><br><span class="line">    <span class="keyword">if</span> (!checkCallingPermission(android.Manifest.permission.MANAGE_APP_TOKENS,</span><br><span class="line">            <span class="string">"setAppFreezingScreen()"</span>)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"Requires MANAGE_APP_TOKENS permission"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span>(mWindowMap) &#123;</span><br><span class="line">        <span class="keyword">if</span> (configChanges == <span class="number">0</span> &amp;&amp; okToDisplay()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_ORIENTATION) Slog.v(TAG_WM, <span class="string">"Skipping set freeze of "</span> + token);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        AppWindowToken wtoken = findAppWindowToken(token);</span><br><span class="line">        <span class="keyword">if</span> (wtoken == <span class="keyword">null</span> || wtoken.appToken == <span class="keyword">null</span>) &#123;</span><br><span class="line">            Slog.w(TAG_WM, <span class="string">"Attempted to freeze screen with non-existing app token: "</span> + wtoken);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> origId = Binder.clearCallingIdentity();</span><br><span class="line">        startAppFreezingScreenLocked(wtoken);</span><br><span class="line">        Binder.restoreCallingIdentity(origId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>WindowManagerService 有很多方法设计到了权限校验，这里只是举例展示。</p>
<h2 id="2-2-checkPermission"><a href="#2-2-checkPermission" class="headerlink" title="2.2 checkPermission"></a>2.2 checkPermission</h2><p>该方法用于判断 pid uid 是否有具体的权限，调用这个方法必须要知道对应的 pid 和 uid：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">checkPermission</span><span class="params">(String permission, <span class="keyword">int</span> pid, <span class="keyword">int</span> uid)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (permission == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> PackageManager.PERMISSION_DENIED;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【*2.12】调用了 checkComponentPermission 方法！</span></span><br><span class="line">    <span class="keyword">return</span> checkComponentPermission(permission, pid, uid, -<span class="number">1</span>, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-2-1-调用时机"><a href="#2-2-1-调用时机" class="headerlink" title="2.2.1 调用时机"></a>2.2.1 调用时机</h3><p>checkPermission 方法的调用也很多，所以简单的看几个：</p>
<h4 id="2-2-1-1-ActivityManagerService-isGetTasksAllowed"><a href="#2-2-1-1-ActivityManagerService-isGetTasksAllowed" class="headerlink" title="2.2.1.1 ActivityManagerService.isGetTasksAllowed"></a>2.2.1.1 ActivityManagerService.isGetTasksAllowed</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isGetTasksAllowed</span><span class="params">(String caller, <span class="keyword">int</span> callingPid, <span class="keyword">int</span> callingUid)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】检查调用者是否具有 REAL_GET_TASKS 和 GET_TASKS 权限！</span></span><br><span class="line">    <span class="keyword">boolean</span> allowed = checkPermission(android.Manifest.permission.REAL_GET_TASKS,</span><br><span class="line">            callingPid, callingUid) == PackageManager.PERMISSION_GRANTED;</span><br><span class="line">    <span class="keyword">if</span> (!allowed) &#123;</span><br><span class="line">        <span class="keyword">if</span> (checkPermission(android.Manifest.permission.GET_TASKS,</span><br><span class="line">                callingPid, callingUid) == PackageManager.PERMISSION_GRANTED) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (AppGlobals.getPackageManager().isUidPrivileged(callingUid)) &#123;</span><br><span class="line">                    allowed = <span class="keyword">true</span>;</span><br><span class="line">                    <span class="keyword">if</span> (DEBUG_TASKS) Slog.w(TAG, caller + <span class="string">": caller "</span> + callingUid</span><br><span class="line">                            + <span class="string">" is using old GET_TASKS but privileged; allowing"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!allowed) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_TASKS) Slog.w(TAG, caller + <span class="string">": caller "</span> + callingUid</span><br><span class="line">                + <span class="string">" does not hold REAL_GET_TASKS; limiting output"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> allowed;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-2-2-跨进程调用"><a href="#2-2-2-跨进程调用" class="headerlink" title="2.2.2 跨进程调用"></a>2.2.2 跨进程调用</h3><p>调用方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    ActivityManagerNative.getDefault().checkPermission(...);</span><br><span class="line">&#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>具体流程：</p>
<ul>
<li><strong>ActivityManagerProxy</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">checkPermission</span><span class="params">(String permission, <span class="keyword">int</span> pid, <span class="keyword">int</span> uid)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    Parcel data = Parcel.obtain();</span><br><span class="line">    Parcel reply = Parcel.obtain();</span><br><span class="line">    data.writeInterfaceToken(IActivityManager.descriptor);</span><br><span class="line">    data.writeString(permission);</span><br><span class="line">    data.writeInt(pid);</span><br><span class="line">    data.writeInt(uid);</span><br><span class="line">    mRemote.transact(CHECK_PERMISSION_TRANSACTION, data, reply, <span class="number">0</span>);</span><br><span class="line">    reply.readException();</span><br><span class="line">    <span class="keyword">int</span> res = reply.readInt();</span><br><span class="line">    data.recycle();</span><br><span class="line">    reply.recycle();</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>ActivityManagerNative</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> CHECK_PERMISSION_TRANSACTION: &#123;</span><br><span class="line">    data.enforceInterface(IActivityManager.descriptor);</span><br><span class="line">    String perm = data.readString();</span><br><span class="line">    <span class="keyword">int</span> pid = data.readInt();</span><br><span class="line">    <span class="keyword">int</span> uid = data.readInt();</span><br><span class="line">    <span class="keyword">int</span> res = checkPermission(perm, pid, uid);</span><br><span class="line">    reply.writeNoException();</span><br><span class="line">    reply.writeInt(res);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-3-checkContentProviderPermissionLocked"><a href="#2-3-checkContentProviderPermissionLocked" class="headerlink" title="2.3 checkContentProviderPermissionLocked"></a>2.3 checkContentProviderPermissionLocked</h2><p>checkContentProviderPermissionLocked 方法用于判断：</p>
<ul>
<li>进程 ProcessRecord 是否可以访问目标 ContentProvider 对象，该方法返回 null 表示该进程是有这个权限的！</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> String <span class="title">checkContentProviderPermissionLocked</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        ProviderInfo cpi, ProcessRecord r, <span class="keyword">int</span> userId, <span class="keyword">boolean</span> checkUser)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】获得进程的 pid 和 uid！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> callingPid = (r != <span class="keyword">null</span>) ? r.pid : Binder.getCallingPid();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> callingUid = (r != <span class="keyword">null</span>) ? r.uid : Binder.getCallingUid();</span><br><span class="line">    <span class="keyword">boolean</span> checkedGrants = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】如果 checkUser 为 true 的话，会进入下面的分支，检查 userId</span></span><br><span class="line">    <span class="keyword">if</span> (checkUser) &#123;</span><br><span class="line">        <span class="comment">// Looking for cross-user grants before enforcing the typical cross-users permissions</span></span><br><span class="line">        <span class="keyword">int</span> tmpTargetUserId = mUserController.unsafeConvertIncomingUserLocked(userId);</span><br><span class="line">        <span class="keyword">if</span> (tmpTargetUserId != UserHandle.getUserId(callingUid)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (checkAuthorityGrants(callingUid, cpi, tmpTargetUserId, checkUser)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            checkedGrants = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        userId = mUserController.handleIncomingUser(callingPid, callingUid, userId, <span class="keyword">false</span>,</span><br><span class="line">                ALLOW_NON_FULL, <span class="string">"checkContentProviderPermissionLocked "</span> + cpi.authority, <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">if</span> (userId != tmpTargetUserId) &#123;</span><br><span class="line">            <span class="comment">// When we actually went to determine the final targer user ID, this ended</span></span><br><span class="line">            <span class="comment">// up different than our initial check for the authority.  This is because</span></span><br><span class="line">            <span class="comment">// they had asked for USER_CURRENT_OR_SELF and we ended up switching to</span></span><br><span class="line">            <span class="comment">// SELF.  So we need to re-check the grants again.</span></span><br><span class="line">            checkedGrants = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【*2.12】检查访问进程是否具有读权限！</span></span><br><span class="line">    <span class="keyword">if</span> (checkComponentPermission(cpi.readPermission, callingPid, callingUid,</span><br><span class="line">            cpi.applicationInfo.uid, cpi.exported)</span><br><span class="line">            == PackageManager.PERMISSION_GRANTED) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【*2.12】检查访问进程是否具有写权限！</span></span><br><span class="line">    <span class="keyword">if</span> (checkComponentPermission(cpi.writePermission, callingPid, callingUid,</span><br><span class="line">            cpi.applicationInfo.uid, cpi.exported)</span><br><span class="line">            == PackageManager.PERMISSION_GRANTED) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【3】检查访问进程是否具有 pathPermissions，每个 path 都可以指定 read 和 write 权限！</span></span><br><span class="line">    PathPermission[] pps = cpi.pathPermissions;</span><br><span class="line">    <span class="keyword">if</span> (pps != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> i = pps.length;</span><br><span class="line">        <span class="keyword">while</span> (i &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            i--;</span><br><span class="line">            PathPermission pp = pps[i];</span><br><span class="line">            <span class="comment">//【*2.12】检查访问进程是否具有 path 读权限！</span></span><br><span class="line">            String pprperm = pp.getReadPermission();</span><br><span class="line">            <span class="keyword">if</span> (pprperm != <span class="keyword">null</span> &amp;&amp; checkComponentPermission(pprperm, callingPid, callingUid,</span><br><span class="line">                    cpi.applicationInfo.uid, cpi.exported)</span><br><span class="line">                    == PackageManager.PERMISSION_GRANTED) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【*2.12】检查访问进程是否具有 path 写权限！</span></span><br><span class="line">            String ppwperm = pp.getWritePermission();</span><br><span class="line">            <span class="keyword">if</span> (ppwperm != <span class="keyword">null</span> &amp;&amp; checkComponentPermission(ppwperm, callingPid, callingUid,</span><br><span class="line">                    cpi.applicationInfo.uid, cpi.exported)</span><br><span class="line">                    == PackageManager.PERMISSION_GRANTED) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!checkedGrants &amp;&amp; checkAuthorityGrants(callingUid, cpi, userId, checkUser)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String msg;</span><br><span class="line">    <span class="comment">//【4】最后校验该 ContentProvider 是否是 exported 的！</span></span><br><span class="line">    <span class="keyword">if</span> (!cpi.exported) &#123;</span><br><span class="line">        msg = <span class="string">"Permission Denial: opening provider "</span> + cpi.name</span><br><span class="line">                + <span class="string">" from "</span> + (r != <span class="keyword">null</span> ? r : <span class="string">"(null)"</span>) + <span class="string">" (pid="</span> + callingPid</span><br><span class="line">                + <span class="string">", uid="</span> + callingUid + <span class="string">") that is not exported from uid "</span></span><br><span class="line">                + cpi.applicationInfo.uid;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        msg = <span class="string">"Permission Denial: opening provider "</span> + cpi.name</span><br><span class="line">                + <span class="string">" from "</span> + (r != <span class="keyword">null</span> ? r : <span class="string">"(null)"</span>) + <span class="string">" (pid="</span> + callingPid</span><br><span class="line">                + <span class="string">", uid="</span> + callingUid + <span class="string">") requires "</span></span><br><span class="line">                + cpi.readPermission + <span class="string">" or "</span> + cpi.writePermission;</span><br><span class="line">    &#125;</span><br><span class="line">    Slog.w(TAG, msg);</span><br><span class="line">    <span class="keyword">return</span> msg;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们看到了这里调用了 checkComponentPermission 方法，判断访问者对该 ContentProvider 是否具有读或写的权限！</p>
<h3 id="2-3-1-调用时机"><a href="#2-3-1-调用时机" class="headerlink" title="2.3.1 调用时机"></a>2.3.1 调用时机</h3><h4 id="2-3-1-1-ActivityManagerService-getContentProviderImpl"><a href="#2-3-1-1-ActivityManagerService-getContentProviderImpl" class="headerlink" title="2.3.1.1 ActivityManagerService.getContentProviderImpl"></a>2.3.1.1 ActivityManagerService.getContentProviderImpl</h4><p>该方法主要是在访问 provider 的时候做权限校验的，调用的方法在 getContentProviderImpl 方法;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> ContentProviderHolder <span class="title">getContentProviderImpl</span><span class="params">(IApplicationThread caller,</span></span></span><br><span class="line"><span class="function"><span class="params">        String name, IBinder token, <span class="keyword">boolean</span> stable, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    ContentProviderRecord cpr;</span><br><span class="line">    ContentProviderConnection conn = <span class="keyword">null</span>;</span><br><span class="line">    ProviderInfo cpi = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">        ... ... ...</span><br><span class="line">        <span class="keyword">boolean</span> providerRunning = cpr != <span class="keyword">null</span> &amp;&amp; cpr.proc != <span class="keyword">null</span> &amp;&amp; !cpr.proc.killed;</span><br><span class="line">        <span class="keyword">if</span> (providerRunning) &#123;</span><br><span class="line">            cpi = cpr.info;</span><br><span class="line">            String msg;</span><br><span class="line">            checkTime(startTime, <span class="string">"getContentProviderImpl: before checkContentProviderPermission"</span>);</span><br><span class="line">            <span class="comment">//【*2.3】校验是否有访问 provider 的权限；</span></span><br><span class="line">            <span class="keyword">if</span> ((msg = checkContentProviderPermissionLocked(cpi, r, userId, checkCrossUser))</span><br><span class="line">                    != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(msg);</span><br><span class="line">            &#125;</span><br><span class="line">            checkTime(startTime, <span class="string">"getContentProviderImpl: after checkContentProviderPermission"</span>);</span><br><span class="line">            ... ... ... ...</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!providerRunning) &#123;</span><br><span class="line">            ... ... ... ...</span><br><span class="line">            String msg;</span><br><span class="line">            checkTime(startTime, <span class="string">"getContentProviderImpl: before checkContentProviderPermission"</span>);</span><br><span class="line">            <span class="comment">//【*2.3】同上；</span></span><br><span class="line">            <span class="keyword">if</span> ((msg = checkContentProviderPermissionLocked(cpi, r, userId, !singleton))</span><br><span class="line">                    != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(msg);</span><br><span class="line">            &#125;</span><br><span class="line">            checkTime(startTime, <span class="string">"getContentProviderImpl: after checkContentProviderPermission"</span>);</span><br><span class="line">            ... ... ... ...</span><br><span class="line">        &#125;</span><br><span class="line">        checkTime(startTime, <span class="string">"getContentProviderImpl: done!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ... ... ... ...</span><br><span class="line">    <span class="keyword">return</span> cpr != <span class="keyword">null</span> ? cpr.newHolder(conn) : <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>getContentProviderImpl 方法我就不多说了，之前分析总结过！</p>
<h2 id="2-4-checkGrantUriPermission"><a href="#2-4-checkGrantUriPermission" class="headerlink" title="2.4 checkGrantUriPermission"></a>2.4 checkGrantUriPermission</h2><p>判断 callingUid 是否能够授予 targetPkg 访问 uri 的权限，modeFlags 指定了访问模式！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">checkGrantUriPermission</span><span class="params">(<span class="keyword">int</span> callingUid, String targetPkg, Uri uri,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> <span class="keyword">int</span> modeFlags, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    enforceNotIsolatedCaller(<span class="string">"checkGrantUriPermission"</span>);</span><br><span class="line">    <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="comment">//【*2.6】这里调用了 checkGrantUriPermissionLocked 方法！</span></span><br><span class="line">        <span class="keyword">return</span> checkGrantUriPermissionLocked(callingUid, targetPkg,</span><br><span class="line">                <span class="keyword">new</span> GrantUri(userId, uri, <span class="keyword">false</span>), modeFlags, -<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该方法会对参数做一个简单的封装，然后调用 checkGrantUriPermissionLocked 继续处理！</p>
<h3 id="2-4-1-调用时机"><a href="#2-4-1-调用时机" class="headerlink" title="2.4.1 调用时机"></a>2.4.1 调用时机</h3><h4 id="2-4-1-1-Clipboard-setPrimaryClip"><a href="#2-4-1-1-Clipboard-setPrimaryClip" class="headerlink" title="2.4.1.1 Clipboard.setPrimaryClip"></a>2.4.1.1 Clipboard.setPrimaryClip</h4><p>这里我们通过一个简单的例子来看下这个方法的使用，Android 系统有一个 Clipboard，当我们机型拷贝的时候会调用其 setPrimaryClip 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPrimaryClip</span><span class="params">(ClipData clip, String callingPackage)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (clip != <span class="keyword">null</span> &amp;&amp; clip.getItemCount() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"No items"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> callingUid = Binder.getCallingUid();</span><br><span class="line">        <span class="comment">//【1】当然这边是对调用者是否有 write clipboard 的 op 操作进行检查和记录！</span></span><br><span class="line">        <span class="keyword">if</span> (mAppOps.noteOp(AppOpsManager.OP_WRITE_CLIPBOARD, callingUid,</span><br><span class="line">                callingPackage) != AppOpsManager.MODE_ALLOWED) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【2】检查调用者是否是 data 的所有者！</span></span><br><span class="line">        checkDataOwnerLocked(clip, callingUid);</span><br><span class="line">        ... ... ...</span><br></pre></td></tr></table></figure>
<p>调用了 checkDataOwnerLocked 方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">checkDataOwnerLocked</span><span class="params">(ClipData data, <span class="keyword">int</span> uid)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> N = data.getItemCount();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">        <span class="comment">//【1】对所有的 data 进行检查！ </span></span><br><span class="line">        checkItemOwnerLocked(data.getItemAt(i), uid);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>调用了 checkItemOwnerLocked 方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">checkUriOwnerLocked</span><span class="params">(Uri uri, <span class="keyword">int</span> uid)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】如果 uri 的 scheme 不是 content 的话，不会检查；</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="string">"content"</span>.equals(uri.getScheme())) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">long</span> ident = Binder.clearCallingIdentity();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【2】校验下 uid 是否有权限访问 uri！</span></span><br><span class="line">        mAm.checkGrantUriPermission(uid, <span class="keyword">null</span>, ContentProvider.getUriWithoutUserId(uri),</span><br><span class="line">                Intent.FLAG_GRANT_READ_URI_PERMISSION,</span><br><span class="line">                ContentProvider.getUserIdFromUri(uri, UserHandle.getUserId(uid)));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Binder.restoreCallingIdentity(ident);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个调用流程很清晰！</p>
<h4 id="2-4-1-2-VoiceInteractionSessionConnection-deliverSessionDataLocked"><a href="#2-4-1-2-VoiceInteractionSessionConnection-deliverSessionDataLocked" class="headerlink" title="2.4.1.2 VoiceInteractionSessionConnection.deliverSessionDataLocked"></a>2.4.1.2 VoiceInteractionSessionConnection.deliverSessionDataLocked</h4><p>还有一个是语音识别服务，需要传递数据的时候：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">deliverSessionDataLocked</span><span class="params">(AssistDataForActivity assistDataForActivity)</span> </span>&#123;</span><br><span class="line">    Bundle assistData = assistDataForActivity.data.getBundle(</span><br><span class="line">            VoiceInteractionSession.KEY_DATA);</span><br><span class="line">    AssistStructure structure = assistDataForActivity.data.getParcelable(</span><br><span class="line">            VoiceInteractionSession.KEY_STRUCTURE);</span><br><span class="line">    AssistContent content = assistDataForActivity.data.getParcelable(</span><br><span class="line">            VoiceInteractionSession.KEY_CONTENT);</span><br><span class="line">    <span class="comment">//【1】获得目标 uid！</span></span><br><span class="line">    <span class="keyword">int</span> uid = assistDataForActivity.data.getInt(Intent.EXTRA_ASSIST_UID, -<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (uid &gt;= <span class="number">0</span> &amp;&amp; content != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//【1.1】获得要传递的 intent，遍历处理内部的 ClipData 数据！</span></span><br><span class="line">        Intent intent = content.getIntent();</span><br><span class="line">        <span class="keyword">if</span> (intent != <span class="keyword">null</span>) &#123;</span><br><span class="line">            ClipData data = intent.getClipData();</span><br><span class="line">            <span class="keyword">if</span> (data != <span class="keyword">null</span> &amp;&amp; Intent.isAccessUriMode(intent.getFlags())) &#123;</span><br><span class="line">                <span class="comment">//【1.1.1】由于目标 uid 需要访问数据，所以这里会尝试授予 uid 对应的 uri 权限！</span></span><br><span class="line">                grantClipDataPermissions(data, intent.getFlags(), uid,</span><br><span class="line">                        mCallingUid, mSessionComponentName.getPackageName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【1.2】同理！</span></span><br><span class="line">        ClipData data = content.getClipData();</span><br><span class="line">        <span class="keyword">if</span> (data != <span class="keyword">null</span>) &#123;</span><br><span class="line">            grantClipDataPermissions(data,</span><br><span class="line">                    Intent.FLAG_GRANT_READ_URI_PERMISSION,</span><br><span class="line">                    uid, mCallingUid, mSessionComponentName.getPackageName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【2】处理语音相关事务！</span></span><br><span class="line">        mSession.handleAssist(assistData, structure, content,</span><br><span class="line">                assistDataForActivity.activityIndex, assistDataForActivity.activityCount);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用 grantClipDataPermissions 方法，这里的 srcUid 是 EXTRA_ASSIST_UID 对应的 uid！！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">grantClipDataPermissions</span><span class="params">(ClipData data, <span class="keyword">int</span> mode, <span class="keyword">int</span> srcUid, <span class="keyword">int</span> destUid,</span></span></span><br><span class="line"><span class="function"><span class="params">        String destPkg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> N = data.getItemCount();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">        <span class="comment">//【1】继续调用：</span></span><br><span class="line">        grantClipDataItemPermission(data.getItemAt(i), mode, srcUid, destUid, destPkg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>再调用 grantClipDataItemPermission 方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">grantClipDataItemPermission</span><span class="params">(ClipData.Item item, <span class="keyword">int</span> mode, <span class="keyword">int</span> srcUid, <span class="keyword">int</span> destUid,</span></span></span><br><span class="line"><span class="function"><span class="params">        String destPkg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (item.getUri() != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//【1】继续调用，授予 uid 对应的 uri 权限！</span></span><br><span class="line">        grantUriPermission(item.getUri(), mode, srcUid, destUid, destPkg);</span><br><span class="line">    &#125;</span><br><span class="line">    Intent intent = item.getIntent();</span><br><span class="line">    <span class="keyword">if</span> (intent != <span class="keyword">null</span> &amp;&amp; intent.getData() != <span class="keyword">null</span>) &#123;</span><br><span class="line">        grantUriPermission(intent.getData(), mode, srcUid, destUid, destPkg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>继续调用 grantUriPermission 方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">grantUriPermission</span><span class="params">(Uri uri, <span class="keyword">int</span> mode, <span class="keyword">int</span> srcUid, <span class="keyword">int</span> destUid, String destPkg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="string">"content"</span>.equals(uri.getScheme())) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">long</span> ident = Binder.clearCallingIdentity();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【1】做一次检查，如果有异常，那么终止操作！</span></span><br><span class="line">        mAm.checkGrantUriPermission(srcUid, <span class="keyword">null</span>, ContentProvider.getUriWithoutUserId(uri),</span><br><span class="line">                mode, ContentProvider.getUserIdFromUri(uri, UserHandle.getUserId(srcUid)));</span><br><span class="line">        <span class="comment">// No security exception, do the grant.</span></span><br><span class="line">        <span class="keyword">int</span> sourceUserId = ContentProvider.getUserIdFromUri(uri, mUser);</span><br><span class="line">        uri = ContentProvider.getUriWithoutUserId(uri);</span><br><span class="line">        <span class="comment">//【2】授予 srcUid 访问 uri 的权限！</span></span><br><span class="line">        mAm.grantUriPermissionFromOwner(mPermissionOwner, srcUid, destPkg,</span><br><span class="line">                uri, Intent.FLAG_GRANT_READ_URI_PERMISSION, sourceUserId, mUser);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SecurityException e) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Can't propagate permission"</span>, e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Binder.restoreCallingIdentity(ident);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>不多说了！！</p>
<h3 id="2-4-2-跨进程调用"><a href="#2-4-2-跨进程调用" class="headerlink" title="2.4.2 跨进程调用"></a>2.4.2 跨进程调用</h3><p>调用方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    ActivityManagerNative.getDefault().checkGrantUriPermission(...);</span><br><span class="line">&#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>具体流程：</p>
<ul>
<li><strong>ActivityManagerProxy</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">checkGrantUriPermission</span><span class="params">(<span class="keyword">int</span> callingUid, String targetPkg,</span></span></span><br><span class="line"><span class="function"><span class="params">        Uri uri, <span class="keyword">int</span> modeFlags, <span class="keyword">int</span> userId)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    Parcel data = Parcel.obtain();</span><br><span class="line">    Parcel reply = Parcel.obtain();</span><br><span class="line">    data.writeInterfaceToken(IActivityManager.descriptor);</span><br><span class="line">    data.writeInt(callingUid);</span><br><span class="line">    data.writeString(targetPkg);</span><br><span class="line">    uri.writeToParcel(data, <span class="number">0</span>);</span><br><span class="line">    data.writeInt(modeFlags);</span><br><span class="line">    data.writeInt(userId);</span><br><span class="line">    mRemote.transact(CHECK_GRANT_URI_PERMISSION_TRANSACTION, data, reply, <span class="number">0</span>);</span><br><span class="line">    reply.readException();</span><br><span class="line">    <span class="keyword">int</span> res = reply.readInt();</span><br><span class="line">    data.recycle();</span><br><span class="line">    reply.recycle();</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>ActivityManagerNative</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> CHECK_GRANT_URI_PERMISSION_TRANSACTION: &#123;</span><br><span class="line">    data.enforceInterface(IActivityManager.descriptor);</span><br><span class="line">    <span class="keyword">int</span> callingUid = data.readInt();</span><br><span class="line">    String targetPkg = data.readString();</span><br><span class="line">    Uri uri = Uri.CREATOR.createFromParcel(data);</span><br><span class="line">    <span class="keyword">int</span> modeFlags = data.readInt();</span><br><span class="line">    <span class="keyword">int</span> userId = data.readInt();</span><br><span class="line">    <span class="keyword">int</span> res = checkGrantUriPermission(callingUid, targetPkg, uri, modeFlags, userId);</span><br><span class="line">    reply.writeNoException();</span><br><span class="line">    reply.writeInt(res);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-5-checkGrantUriPermissionFromIntentLocked"><a href="#2-5-checkGrantUriPermissionFromIntentLocked" class="headerlink" title="2.5 checkGrantUriPermissionFromIntentLocked"></a>2.5 checkGrantUriPermissionFromIntentLocked</h2><p>该方法用于判断是否能够授予 targetPkg 访问 uri 的权限，uri 来自接收到的 intent；</p>
<p>和 2.6 的 checkGrantUriPermissionLocked 很类似，区别是 checkGrantUriPermissionLocked 直接操作的是 Uri；而该方法直接作用于 Intent！</p>
<p>返回 null 表示不需要授予权限！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">NeededUriGrants <span class="title">checkGrantUriPermissionFromIntentLocked</span><span class="params">(<span class="keyword">int</span> callingUid,</span></span></span><br><span class="line"><span class="function"><span class="params">        String targetPkg, Intent intent, <span class="keyword">int</span> mode, NeededUriGrants needed, <span class="keyword">int</span> targetUserId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_URI_PERMISSION) Slog.v(TAG_URI_PERMISSION,</span><br><span class="line">            <span class="string">"Checking URI perm to data="</span> + (intent != <span class="keyword">null</span> ? intent.getData() : <span class="keyword">null</span>)</span><br><span class="line">            + <span class="string">" clip="</span> + (intent != <span class="keyword">null</span> ? intent.getClipData() : <span class="keyword">null</span>)</span><br><span class="line">            + <span class="string">" from "</span> + intent + <span class="string">"; flags=0x"</span></span><br><span class="line">            + Integer.toHexString(intent != <span class="keyword">null</span> ? intent.getFlags() : <span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】如果 targetPkg / intent 为 null，则抛出异常！</span></span><br><span class="line">    <span class="keyword">if</span> (targetPkg == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"targetPkg"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (intent == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】获得 intent 中的 Uri 和 ClipData 数据，如果都为 null，抛出异常！</span></span><br><span class="line">    Uri data = intent.getData();</span><br><span class="line">    ClipData clip = intent.getClipData();</span><br><span class="line">    <span class="keyword">if</span> (data == <span class="keyword">null</span> &amp;&amp; clip == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】获得 uri 所在的 userId，如果 contentUserHint 等于 UserHandle.USER_CURRENT，</span></span><br><span class="line">    <span class="comment">// 说明该 intent 没有离开当前 userId！</span></span><br><span class="line">    <span class="keyword">int</span> contentUserHint = intent.getContentUserHint();</span><br><span class="line">    <span class="keyword">if</span> (contentUserHint == UserHandle.USER_CURRENT) &#123;</span><br><span class="line">        contentUserHint = UserHandle.getUserId(callingUid);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【4】计算目标 uid，如果已经知道需要什么权限，即 NeededUriGrants 不为 null，那么通过 NeededUriGrants.targetUid</span></span><br><span class="line">    <span class="comment">// 获得目标 uid，否则，通过 targetPkg 计算 targetUid！</span></span><br><span class="line">    <span class="keyword">final</span> IPackageManager pm = AppGlobals.getPackageManager();</span><br><span class="line">    <span class="keyword">int</span> targetUid;</span><br><span class="line">    <span class="keyword">if</span> (needed != <span class="keyword">null</span>) &#123;</span><br><span class="line">        targetUid = needed.targetUid;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            targetUid = pm.getPackageUid(targetPkg, MATCH_DEBUG_TRIAGED_MISSING,</span><br><span class="line">                    targetUserId);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (targetUid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_URI_PERMISSION) Slog.v(TAG_URI_PERMISSION,</span><br><span class="line">                    <span class="string">"Can't grant URI permission no uid for: "</span> + targetPkg</span><br><span class="line">                    + <span class="string">" on user "</span> + targetUserId);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【5】首先处理 data 数据，获得传递的 uri，调用 checkGrantUriPermissionLocked 判断是否需要授予 uri 权限！</span></span><br><span class="line">    <span class="keyword">if</span> (data != <span class="keyword">null</span>) &#123;</span><br><span class="line">        GrantUri grantUri = GrantUri.resolve(contentUserHint, data);</span><br><span class="line">        <span class="comment">//【*2.6】首先判断是否有访问 data 指定的数据！</span></span><br><span class="line">        targetUid = checkGrantUriPermissionLocked(callingUid, targetPkg, grantUri, mode,</span><br><span class="line">                targetUid);</span><br><span class="line">        <span class="comment">//【5.1】如果返回值大于 0，说明需要授予权限，创建 NeededUriGrants 对象，记录下！</span></span><br><span class="line">        <span class="keyword">if</span> (targetUid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (needed == <span class="keyword">null</span>) &#123;</span><br><span class="line">                needed = <span class="keyword">new</span> NeededUriGrants(targetPkg, targetUid, mode);</span><br><span class="line">            &#125;</span><br><span class="line">            needed.add(grantUri);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【6】接着处理 ClipData 数据，遍历 ClipData 中的所有 item，处理其 uri 和 intent 数据！</span></span><br><span class="line">    <span class="keyword">if</span> (clip != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;clip.getItemCount(); i++) &#123;</span><br><span class="line">            Uri uri = clip.getItemAt(i).getUri();</span><br><span class="line">            <span class="keyword">if</span> (uri != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">//【*2.6】如果其 uri 不为 null，检查是否有权限访问该 url，同样是 checkGrantUriPermissionLocked</span></span><br><span class="line">                <span class="comment">// 方法！</span></span><br><span class="line">                GrantUri grantUri = GrantUri.resolve(contentUserHint, uri);</span><br><span class="line">                targetUid = checkGrantUriPermissionLocked(callingUid, targetPkg, grantUri, mode,</span><br><span class="line">                        targetUid);</span><br><span class="line">                <span class="keyword">if</span> (targetUid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (needed == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        needed = <span class="keyword">new</span> NeededUriGrants(targetPkg, targetUid, mode);</span><br><span class="line">                    &#125;</span><br><span class="line">                    needed.add(grantUri);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//【6.1】如果其 clipIntent 不为 null，递归检查该 intent!</span></span><br><span class="line">                Intent clipIntent = clip.getItemAt(i).getIntent();</span><br><span class="line">                <span class="keyword">if</span> (clipIntent != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">//【*2.6】递归检查！ </span></span><br><span class="line">                    NeededUriGrants newNeeded = checkGrantUriPermissionFromIntentLocked(</span><br><span class="line">                            callingUid, targetPkg, clipIntent, mode, needed, targetUserId);</span><br><span class="line">                    <span class="keyword">if</span> (newNeeded != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        needed = newNeeded;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【7】返回 NeededUriGrants 对象，该对象保存了需要授权访问的所有 url！！</span></span><br><span class="line">    <span class="keyword">return</span> needed;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该方法会返回一个 NeededUriGrants 对象，用于保存该 intent 携带的所有需要授权访问了 GrantUri 对象，包括其 ClipData 中的 intent 携带的 uri：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">NeededUriGrants</span> <span class="keyword">extends</span> <span class="title">ArrayList</span>&lt;<span class="title">GrantUri</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> String targetPkg;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> targetUid;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> flags;</span><br><span class="line"></span><br><span class="line">    NeededUriGrants(String targetPkg, <span class="keyword">int</span> targetUid, <span class="keyword">int</span> flags) &#123;</span><br><span class="line">        <span class="keyword">this</span>.targetPkg = targetPkg;</span><br><span class="line">        <span class="keyword">this</span>.targetUid = targetUid;</span><br><span class="line">        <span class="keyword">this</span>.flags = flags;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的 mode 可以设置下面的两个标志位！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FLAG_GRANT_READ_URI_PERMISSION = <span class="number">0x00000001</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FLAG_GRANT_WRITE_URI_PERMISSION = <span class="number">0x00000002</span>;</span><br></pre></td></tr></table></figure>
<p>如果设置该标记，Intent 的接受者将会被赋予读/写 Intent 中 uri 数据和 Intent.ClipData 中的 uri 的权限。</p>
<p>当应用到 Intent 的 ClipData 时，其携带的所有 uri 都会被 intent 接收者读/写，同时其会递归处理其携带的所有 intent！</p>
<p>其实，mode 的值是为了标志授予的权限类型是读还是写的，都设置的话，那就是可读可写！</p>
<h3 id="2-5-1-调用时机"><a href="#2-5-1-调用时机" class="headerlink" title="2.5.1 调用时机"></a>2.5.1 调用时机</h3><p>该方法的调用实际比较少，ActiveServices 和 ActivityManagerService 中：</p>
<h4 id="2-5-1-1-ActiveServices-startServiceLocked"><a href="#2-5-1-1-ActiveServices-startServiceLocked" class="headerlink" title="2.5.1.1 ActiveServices.startServiceLocked"></a>2.5.1.1 ActiveServices.startServiceLocked</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">ComponentName <span class="title">startServiceLocked</span><span class="params">(IApplicationThread caller, Intent service, String resolvedType,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> callingPid, <span class="keyword">int</span> callingUid, String callingPackage, <span class="keyword">final</span> <span class="keyword">int</span> userId)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> TransactionTooLargeException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_DELAYED_STARTS) Slog.v(TAG_SERVICE, <span class="string">"startService: "</span> + service</span><br><span class="line">            + <span class="string">" type="</span> + resolvedType + <span class="string">" args="</span> + service.getExtras());</span><br><span class="line">    ... ... ... ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!r.startRequested) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> token = Binder.clearCallingIdentity();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Before going further -- if this app is not allowed to run in the</span></span><br><span class="line">            <span class="comment">// background, then at this point we aren't going to let it period.</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> allowed = mAm.checkAllowBackgroundLocked(</span><br><span class="line">                    r.appInfo.uid, r.packageName, callingPid, <span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">if</span> (allowed != ActivityManager.APP_START_MODE_NORMAL) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Background start not allowed: service "</span></span><br><span class="line">                        + service + <span class="string">" to "</span> + r.name.flattenToShortString()</span><br><span class="line">                        + <span class="string">" from pid="</span> + callingPid + <span class="string">" uid="</span> + callingUid</span><br><span class="line">                        + <span class="string">" pkg="</span> + callingPackage);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;f</span><br><span class="line">            Binder.restoreCallingIdentity(token);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【1】校验了下是否需要授予 uri 权限！</span></span><br><span class="line">    NeededUriGrants neededGrants = mAm.checkGrantUriPermissionFromIntentLocked(</span><br><span class="line">            callingUid, r.packageName, service, service.getFlags(), <span class="keyword">null</span>, r.userId);</span><br><span class="line"></span><br><span class="line">    ... ... ... ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> startServiceInnerLocked(smap, service, r, callerFg, addToStarting);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里就不多说了！</p>
<h2 id="2-6-checkGrantUriPermissionLocked"><a href="#2-6-checkGrantUriPermissionLocked" class="headerlink" title="2.6 checkGrantUriPermissionLocked"></a>2.6 checkGrantUriPermissionLocked</h2><p>判断是否需要授予 targetPkg 访问 uri 的权限，modeFlags 指定了访问模式， callingUid 是调用者 uid！</p>
<p>如果 callingUid 不被允许，会抛出 SecurityException 异常！ 如果方法返回了 targetPkg 的 uid，说明需要授予权限；如果返回 -1，表示不需要或者无法授予（比如目标包已经有权限访问 uri）！</p>
<p>lastTargetUid 表示 targetPkg 的 uid，如果已经知道了 targetPkg.uid，那么就设置 lastTargetUid 为 targetPkg.uid 即可；如果不知道，那么设置为 -1，方法内部会计算出对应的 uid！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">checkGrantUriPermissionLocked</span><span class="params">(<span class="keyword">int</span> callingUid, String targetPkg, GrantUri grantUri,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> <span class="keyword">int</span> modeFlags, <span class="keyword">int</span> lastTargetUid)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】判断 modeFlags 是否至少设置了 Intent.FLAG_GRANT_WRITE_URI_PERMISSION 或者</span></span><br><span class="line">    <span class="comment">// Intent.FLAG_GRANT_READ_URI_PERMISSION，如果都没有，返回 -1!</span></span><br><span class="line">    <span class="keyword">if</span> (!Intent.isAccessUriMode(modeFlags)) &#123;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (targetPkg != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_URI_PERMISSION) Slog.v(TAG_URI_PERMISSION,</span><br><span class="line">                <span class="string">"Checking grant "</span> + targetPkg + <span class="string">" permission to "</span> + grantUri);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> IPackageManager pm = AppGlobals.getPackageManager();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】如果 uri 不是和 content 相关的，异常，返回 -1；</span></span><br><span class="line">    <span class="keyword">if</span> (!ContentResolver.SCHEME_CONTENT.equals(grantUri.uri.getScheme())) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_URI_PERMISSION) Slog.v(TAG_URI_PERMISSION,</span><br><span class="line">                <span class="string">"Can't grant URI permission for non-content URI: "</span> + grantUri);</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】无法通过 uri 找到一个 ContentProvider，异常，返回 -1；</span></span><br><span class="line">    <span class="keyword">final</span> String authority = grantUri.uri.getAuthority();</span><br><span class="line">    <span class="keyword">final</span> ProviderInfo pi = getProviderInfoLocked(authority, grantUri.sourceUserId,</span><br><span class="line">            MATCH_DEBUG_TRIAGED_MISSING);</span><br><span class="line">    <span class="keyword">if</span> (pi == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"No content provider found for permission check: "</span> +</span><br><span class="line">                grantUri.uri.toSafeString());</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【4】计算 targetPkg 的 uid！</span></span><br><span class="line">    <span class="keyword">int</span> targetUid = lastTargetUid;</span><br><span class="line">    <span class="keyword">if</span> (targetUid &lt; <span class="number">0</span> &amp;&amp; targetPkg != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            targetUid = pm.getPackageUid(targetPkg, MATCH_DEBUG_TRIAGED_MISSING,</span><br><span class="line">                    UserHandle.getUserId(callingUid));</span><br><span class="line">            <span class="keyword">if</span> (targetUid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_URI_PERMISSION) Slog.v(TAG_URI_PERMISSION,</span><br><span class="line">                        <span class="string">"Can't grant URI permission no uid for: "</span> + targetPkg);</span><br><span class="line">                <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (targetUid &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 一般情况 targetUid &gt;= 0，说明 targetPkg 是存在的，那么就判断下 targetPkg 是否已经持有该权限！</span></span><br><span class="line">        <span class="comment">//【*2.7】这里调用了 checkHoldingPermissionsLocked 判断是否已经有权限，如果已经持有，返回 -1；</span></span><br><span class="line">        <span class="keyword">if</span> (checkHoldingPermissionsLocked(pm, pi, grantUri, targetUid, modeFlags)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_URI_PERMISSION) Slog.v(TAG_URI_PERMISSION,</span><br><span class="line">                    <span class="string">"Target "</span> + targetPkg + <span class="string">" already has full permission to "</span> + grantUri);</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//【5】如果 targetUid &lt; 0，说明没有 targetPkg，</span></span><br><span class="line">        <span class="comment">// 此时如果 ContentProvider 指定了读写权限，那就要进一步判断是否要授予权限；如果没有指定读写权限</span></span><br><span class="line">        <span class="comment">// 就要看 provider 是否是暴露的，如果是 export 的，那么可以直接访问，无需授权，返回 -1；</span></span><br><span class="line">        <span class="comment">// 否则，需要继续判断；</span></span><br><span class="line">        <span class="keyword">boolean</span> allowed = pi.exported;</span><br><span class="line">        <span class="keyword">if</span> ((modeFlags &amp; Intent.FLAG_GRANT_READ_URI_PERMISSION) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (pi.readPermission != <span class="keyword">null</span>) &#123;</span><br><span class="line">                allowed = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((modeFlags &amp; Intent.FLAG_GRANT_WRITE_URI_PERMISSION) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (pi.writePermission != <span class="keyword">null</span>) &#123;</span><br><span class="line">                allowed = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (allowed) &#123;</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【6】这里来处理一种跨用户访问的特殊情况：</span></span><br><span class="line">    <span class="comment">// 如果 targetUid 和 uri 不再同一个 userId 下，并且当前 userId 下的应用不需要任何权限就可以访问该 uri，</span></span><br><span class="line">    <span class="comment">// 那么我们也会授予 targetPkg 访问 uri 的权限，</span></span><br><span class="line">    <span class="comment">// 即使 provider 没有授予该权限，这种情况 specialCrossUserGrant 为 true！</span></span><br><span class="line">    <span class="comment">//【*2.8】这里调用了 checkHoldingPermissionsInternalLocked 方法！</span></span><br><span class="line">    <span class="keyword">boolean</span> specialCrossUserGrant = UserHandle.getUserId(targetUid) != grantUri.sourceUserId</span><br><span class="line">            &amp;&amp; checkHoldingPermissionsInternalLocked(pm, pi, grantUri, callingUid,</span><br><span class="line">            modeFlags, <span class="keyword">false</span> <span class="comment">/*without considering the uid permissions*/</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【7】一般情况下，我们的访问是不会是跨用户的，继续判断 provider 是否允许授予 uri 权限！</span></span><br><span class="line">    <span class="keyword">if</span> (!specialCrossUserGrant) &#123;</span><br><span class="line">        <span class="comment">//【7.1】provider 不允许授予 uri 权限，抛出异常！</span></span><br><span class="line">        <span class="keyword">if</span> (!pi.grantUriPermissions) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"Provider "</span> + pi.packageName</span><br><span class="line">                    + <span class="string">"/"</span> + pi.name</span><br><span class="line">                    + <span class="string">" does not allow granting of Uri permissions (uri "</span></span><br><span class="line">                    + grantUri + <span class="string">")"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【7.2】provider 允许授予 uri 权限，如果其指定了 uriPermissionPatterns，判断下要访问呢的 url</span></span><br><span class="line">        <span class="comment">// 是不是能够匹配 uriPermissionPatterns，如果不行，那就说明不允许访问，抛出异常！</span></span><br><span class="line">        <span class="keyword">if</span> (pi.uriPermissionPatterns != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> N = pi.uriPermissionPatterns.length;</span><br><span class="line">            <span class="keyword">boolean</span> allowed = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (pi.uriPermissionPatterns[i] != <span class="keyword">null</span></span><br><span class="line">                        &amp;&amp; pi.uriPermissionPatterns[i].match(grantUri.uri.getPath())) &#123;</span><br><span class="line">                    allowed = <span class="keyword">true</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!allowed) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"Provider "</span> + pi.packageName</span><br><span class="line">                        + <span class="string">"/"</span> + pi.name</span><br><span class="line">                        + <span class="string">" does not allow granting of permission to path of Uri "</span></span><br><span class="line">                        + grantUri);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【8】这里判断了下调用者自身 callingUid 是否有权限访问该 Uri，如果 callingUid 不是 system uid 的话</span></span><br><span class="line">    <span class="comment">// 就会进行检查！</span></span><br><span class="line">    <span class="keyword">if</span> (UserHandle.getAppId(callingUid) != Process.SYSTEM_UID) &#123;</span><br><span class="line">        <span class="comment">//【*2.7】同样的，这里调用了 checkHoldingPermissionsLocked 方法判断是否已经有权限！</span></span><br><span class="line">        <span class="keyword">if</span> (!checkHoldingPermissionsLocked(pm, pi, grantUri, callingUid, modeFlags)) &#123;</span><br><span class="line">            <span class="comment">//【*2.10】调用了 checkUriPermissionLocked 判断是否有 uri 权限！</span></span><br><span class="line">            <span class="keyword">if</span> (!checkUriPermissionLocked(grantUri, callingUid, modeFlags)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"Uid "</span> + callingUid</span><br><span class="line">                        + <span class="string">" does not have permission to uri "</span> + grantUri);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【9】最后返回 targetUid，如果大于 0，说明需要授予权限！！</span></span><br><span class="line">    <span class="keyword">return</span> targetUid;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们看到这里会有几种情况出现异常：</p>
<ul>
<li>uri 所属的 provider 的 grantUriPermissions 为 false，说明 provider 禁止 uri 访问，会抛出异常；</li>
<li>如果 provider 的 grantUriPermissions 为 true，但是 provider 的 uriPermissionPatterns 中的 uri 没有和要访问的 uri 相匹配的，抛出异常；</li>
<li>如果调用者接口的程序，不具有对该 uri 的访问权限，那么就会抛出异常；</li>
</ul>
<p>这里也用到了那 2 个 flags，不在多说了！</p>
<h3 id="2-6-1-调用时机"><a href="#2-6-1-调用时机" class="headerlink" title="2.6.1 调用时机"></a>2.6.1 调用时机</h3><p>该方法的调用比较少，在 ActivityManagerService 中：</p>
<ul>
<li>一个是 2.4 checkGrantUriPermission 方法；</li>
<li>一个是 2.5 checkGrantUriPermissionFromIntentLocked 方法；</li>
<li>一个是在 grantUriPermissionLocked 方法，关于 grant 后面单独分析；</li>
</ul>
<h2 id="2-7-checkHoldingPermissionsLocked"><a href="#2-7-checkHoldingPermissionsLocked" class="headerlink" title="2.7 checkHoldingPermissionsLocked"></a>2.7 checkHoldingPermissionsLocked</h2><p>判断 uid 是否已经有访问 uri 的权限！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">checkHoldingPermissionsLocked</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        IPackageManager pm, ProviderInfo pi, GrantUri grantUri, <span class="keyword">int</span> uid, <span class="keyword">final</span> <span class="keyword">int</span> modeFlags)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_URI_PERMISSION) Slog.v(TAG_URI_PERMISSION,</span><br><span class="line">            <span class="string">"checkHoldingPermissionsLocked: uri="</span> + grantUri + <span class="string">" uid="</span> + uid);</span><br><span class="line">    <span class="comment">//【1】首先，如果 uid 和 uri 的 userId 不相等的话，需要检查 uid 是否具有跨用户的权限！</span></span><br><span class="line">    <span class="keyword">if</span> (UserHandle.getUserId(uid) != grantUri.sourceUserId) &#123;</span><br><span class="line">        <span class="comment">//【*2.12】这里调用了 checkComponentPermission 方法，如果没有跨用户的权限，那肯定是不会有</span></span><br><span class="line">        <span class="comment">// 访问 url 的权限的！！</span></span><br><span class="line">        <span class="keyword">if</span> (ActivityManager.checkComponentPermission(INTERACT_ACROSS_USERS, uid, -<span class="number">1</span>, <span class="keyword">true</span>)</span><br><span class="line">                != PERMISSION_GRANTED) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【*2.8】如果是同一用户下的，调用 checkHoldingPermissionsInternalLocked 方法进一步处理，</span></span><br><span class="line">    <span class="comment">// 这里 considerUidPermissions 为 true！表示需要校验 uid 权限！</span></span><br><span class="line">    <span class="keyword">return</span> checkHoldingPermissionsInternalLocked(pm, pi, grantUri, uid, modeFlags, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="2-7-1-调用时机"><a href="#2-7-1-调用时机" class="headerlink" title="2.7.1 调用时机"></a>2.7.1 调用时机</h3><p>该方法的调用比较少，在 ActivityManagerService 中：</p>
<ul>
<li>一个是 2.6 checkGrantUriPermissionLocked 方法；</li>
<li>一个是在 revokeUriPermissionLocked 方法，关于 revoke 后面单独分析；</li>
</ul>
<h2 id="2-8-checkHoldingPermissionsInternalLocked"><a href="#2-8-checkHoldingPermissionsInternalLocked" class="headerlink" title="2.8 checkHoldingPermissionsInternalLocked"></a>2.8 checkHoldingPermissionsInternalLocked</h2><p>判断 uid 是否已经具有访问 uri 的权限，该接口并不检查是否是跨用户的调用！</p>
<p>considerUidPermissions 参数表示是否检查 uid 权限，一般我们是会传入 true 的！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">checkHoldingPermissionsInternalLocked</span><span class="params">(IPackageManager pm, ProviderInfo pi,</span></span></span><br><span class="line"><span class="function"><span class="params">        GrantUri grantUri, <span class="keyword">int</span> uid, <span class="keyword">final</span> <span class="keyword">int</span> modeFlags, <span class="keyword">boolean</span> considerUidPermissions)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】如果 provider 的 uid 和访问者 uid 一样，同一应用，那是有权限访问的，返回 true；</span></span><br><span class="line">    <span class="comment">// 如果 provider.exported 为 false，那么，其没有权限访问，返回 false；</span></span><br><span class="line">    <span class="keyword">if</span> (pi.applicationInfo.uid == uid) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!pi.exported) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】解析 modeFlags 中的 read 和 write 标志位，如果设置了该标志位，则为 false</span></span><br><span class="line">    <span class="comment">// 那么，下面会进行权限检查！</span></span><br><span class="line">    <span class="keyword">boolean</span> readMet = (modeFlags &amp; Intent.FLAG_GRANT_READ_URI_PERMISSION) == <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">boolean</span> writeMet = (modeFlags &amp; Intent.FLAG_GRANT_WRITE_URI_PERMISSION) == <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【2.1】首先判断 uid 是否持有 read 和 write 的 top-level 的权限，该权限是在 &lt;provider&gt; 标签中设定的！</span></span><br><span class="line">        <span class="comment">// 当然判断的前提是 considerUidPermissions 为 true！</span></span><br><span class="line">        <span class="keyword">if</span> (!readMet &amp;&amp; pi.readPermission != <span class="keyword">null</span> &amp;&amp; considerUidPermissions</span><br><span class="line">                &amp;&amp; (pm.checkUidPermission(pi.readPermission, uid) == PERMISSION_GRANTED)) &#123;</span><br><span class="line">            readMet = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!writeMet &amp;&amp; pi.writePermission != <span class="keyword">null</span> &amp;&amp; considerUidPermissions</span><br><span class="line">                &amp;&amp; (pm.checkUidPermission(pi.writePermission, uid) == PERMISSION_GRANTED)) &#123;</span><br><span class="line">            writeMet = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2.2】如果 provider 没有设置 top-level 的权限的话，allowDefaultRead 和 allowDefaultWrite 为 true！</span></span><br><span class="line">        <span class="comment">// 否则，为 false！</span></span><br><span class="line">        <span class="keyword">boolean</span> allowDefaultRead = pi.readPermission == <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">boolean</span> allowDefaultWrite = pi.writePermission == <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2.3】下面是非 top-level 的权限检查！</span></span><br><span class="line">        <span class="comment">// 如果 provider 设置了 path permission，那还要判断 uid 其是否持有对应的 path permission！</span></span><br><span class="line">        <span class="comment">// 当然判断的前提是 considerUidPermissions 为 true！</span></span><br><span class="line">        <span class="keyword">final</span> PathPermission[] pps = pi.pathPermissions;</span><br><span class="line">        <span class="keyword">if</span> (pps != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> String path = grantUri.uri.getPath();</span><br><span class="line">            <span class="keyword">int</span> i = pps.length;</span><br><span class="line">            <span class="comment">//【2.3.1】只有 readMet/writeMet 为 false 时，才会做 path permission 校验！</span></span><br><span class="line">            <span class="comment">// 因为如果 readMet | writeMet 为 true 的话，说明 uid 持有 top-level 的权限！</span></span><br><span class="line">            <span class="keyword">while</span> (i &gt; <span class="number">0</span> &amp;&amp; (!readMet || !writeMet)) &#123;</span><br><span class="line">                i--;</span><br><span class="line">                PathPermission pp = pps[i];</span><br><span class="line">                <span class="keyword">if</span> (pp.match(path)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!readMet) &#123;</span><br><span class="line">                        <span class="keyword">final</span> String pprperm = pp.getReadPermission();</span><br><span class="line">                        <span class="keyword">if</span> (DEBUG_URI_PERMISSION) Slog.v(TAG_URI_PERMISSION,</span><br><span class="line">                                <span class="string">"Checking read perm for "</span> + pprperm + <span class="string">" for "</span> + pp.getPath()</span><br><span class="line">                                + <span class="string">": match="</span> + pp.match(path)</span><br><span class="line">                                + <span class="string">" check="</span> + pm.checkUidPermission(pprperm, uid));</span><br><span class="line">                        <span class="keyword">if</span> (pprperm != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="comment">//【2.3.1】当 considerUidPermissions 为 true，并且 uid 有权限，那么 readMet 为 true</span></span><br><span class="line">                            <span class="comment">// 表示可读，否则 readMet == allowDefaultRead == false；</span></span><br><span class="line">                            <span class="comment">//【*3.1】调用了 pms 的 checkUidPermission 接口！</span></span><br><span class="line">                            <span class="keyword">if</span> (considerUidPermissions &amp;&amp; pm.checkUidPermission(pprperm, uid)</span><br><span class="line">                                    == PERMISSION_GRANTED) &#123;</span><br><span class="line">                                readMet = <span class="keyword">true</span>;</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                allowDefaultRead = <span class="keyword">false</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (!writeMet) &#123;</span><br><span class="line">                        <span class="keyword">final</span> String ppwperm = pp.getWritePermission();</span><br><span class="line">                        <span class="keyword">if</span> (DEBUG_URI_PERMISSION) Slog.v(TAG_URI_PERMISSION,</span><br><span class="line">                                <span class="string">"Checking write perm "</span> + ppwperm + <span class="string">" for "</span> + pp.getPath()</span><br><span class="line">                                + <span class="string">": match="</span> + pp.match(path)</span><br><span class="line">                                + <span class="string">" check="</span> + pm.checkUidPermission(ppwperm, uid));</span><br><span class="line">                        <span class="keyword">if</span> (ppwperm != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="comment">//【2.3.2】当 considerUidPermissions 为 true，并且 uid 有权限，那么 writeMet 为 true</span></span><br><span class="line">                            <span class="comment">// 表示可写；否则 writeMet == allowDefaultWrite == false；</span></span><br><span class="line">                            <span class="comment">//【*3.1】调用了 pms 的 checkUidPermission 接口！</span></span><br><span class="line">                            <span class="keyword">if</span> (considerUidPermissions &amp;&amp; pm.checkUidPermission(ppwperm, uid)</span><br><span class="line">                                    == PERMISSION_GRANTED) &#123;</span><br><span class="line">                                writeMet = <span class="keyword">true</span>;</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                allowDefaultWrite = <span class="keyword">false</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【3】如果 allowDefaultRead/allowDefaultWrite 为 true 了，设置 readMet/writeMet 为 true！</span></span><br><span class="line">        <span class="keyword">if</span> (allowDefaultRead) readMet = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (allowDefaultWrite) writeMet = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 最后返回 readMet &amp;&amp; writeMet，如果为 true，表示其具有访问 uri的权限！</span></span><br><span class="line">    <span class="keyword">return</span> readMet &amp;&amp; writeMet;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过逻辑可以知道：</p>
<ul>
<li><p>如果 considerUidPermissions 为 true，那么会调用 checkUidPermission 进行 uid 权限的校验!</p>
</li>
<li><p>如果 considerUidPermissions 为 false 的话，如果 uid 想要对 provider 持有访问权限的话，只能是</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pi.readPermission == <span class="keyword">null</span>;</span><br><span class="line">pi.writePermission == <span class="keyword">null</span>;</span><br><span class="line">pi.pathPermissions == <span class="keyword">null</span>;</span><br><span class="line">pi.exported == <span class="keyword">true</span></span><br></pre></td></tr></table></figure>
<p>也就是说，provider 不设置任何权限，同时是暴露的！！</p>
<h3 id="2-8-1-调用时机"><a href="#2-8-1-调用时机" class="headerlink" title="2.8.1 调用时机"></a>2.8.1 调用时机</h3><p>该方法的调用比较少，在 ActivityManagerService 中：</p>
<ul>
<li>一个是 2.7 checkHoldingPermissionsLocked 方法中；</li>
<li>一个是在 revokeUriPermissionLocked 方法，关于 revoke 后面单独分析；</li>
</ul>
<h2 id="2-9-checkUriPermission"><a href="#2-9-checkUriPermission" class="headerlink" title="2.9 checkUriPermission"></a>2.9 checkUriPermission</h2><p>用于检查 uid 是否持有 uri permissions：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">checkUriPermission</span><span class="params">(Uri uri, <span class="keyword">int</span> pid, <span class="keyword">int</span> uid,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> <span class="keyword">int</span> modeFlags, <span class="keyword">int</span> userId, IBinder callerToken)</span> </span>&#123;</span><br><span class="line">    enforceNotIsolatedCaller(<span class="string">"checkUriPermission"</span>);</span><br><span class="line">    <span class="comment">//【1】通过 IBinder 对象获得调用者进程的 pid 和 uid！</span></span><br><span class="line">    Identity tlsIdentity = sCallerIdentity.get();</span><br><span class="line">    <span class="keyword">if</span> (tlsIdentity != <span class="keyword">null</span> &amp;&amp; tlsIdentity.token == callerToken) &#123;</span><br><span class="line">        uid = tlsIdentity.uid;</span><br><span class="line">        pid = tlsIdentity.pid;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】如果 pid 是系统进程自身，默认授予！</span></span><br><span class="line">    <span class="keyword">if</span> (pid == MY_PID) &#123;</span><br><span class="line">        <span class="keyword">return</span> PackageManager.PERMISSION_GRANTED;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="comment">//【*2.10】调用 checkUriPermissionLocked 继续检查是否具有 uri 权限！</span></span><br><span class="line">        <span class="keyword">return</span> checkUriPermissionLocked(<span class="keyword">new</span> GrantUri(userId, uri, <span class="keyword">false</span>), uid, modeFlags)</span><br><span class="line">                ? PackageManager.PERMISSION_GRANTED</span><br><span class="line">                : PackageManager.PERMISSION_DENIED;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的 sCallerIdentity 是一个线程本地变量：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Identity&gt; sCallerIdentity = <span class="keyword">new</span> ThreadLocal&lt;Identity&gt;();</span><br></pre></td></tr></table></figure></p>
<p>我们通过传入的 IBinder 对象和 Identity.token 进行匹配，然后就可以获得调用者的进程 pid 和 uid！</p>
<h3 id="2-9-1-调用时机-跨进程"><a href="#2-9-1-调用时机-跨进程" class="headerlink" title="2.9.1 调用时机 - 跨进程"></a>2.9.1 调用时机 - 跨进程</h3><p>该方法主要是从 Context 的 checkUriPermission 调用过来的！</p>
<p>调用方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    ActivityManagerNative.getDefault().checkUriPermission(...);</span><br><span class="line">&#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>具体流程：</p>
<ul>
<li><strong>ActivityManagerProxy</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">checkUriPermission</span><span class="params">(Uri uri, <span class="keyword">int</span> pid, <span class="keyword">int</span> uid, <span class="keyword">int</span> mode, <span class="keyword">int</span> userId,</span></span></span><br><span class="line"><span class="function"><span class="params">        IBinder callerToken)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    Parcel data = Parcel.obtain();</span><br><span class="line">    Parcel reply = Parcel.obtain();</span><br><span class="line">    data.writeInterfaceToken(IActivityManager.descriptor);</span><br><span class="line">    uri.writeToParcel(data, <span class="number">0</span>);</span><br><span class="line">    data.writeInt(pid);</span><br><span class="line">    data.writeInt(uid);</span><br><span class="line">    data.writeInt(mode);</span><br><span class="line">    data.writeInt(userId);</span><br><span class="line">    data.writeStrongBinder(callerToken);</span><br><span class="line">    mRemote.transact(CHECK_URI_PERMISSION_TRANSACTION, data, reply, <span class="number">0</span>);</span><br><span class="line">    reply.readException();</span><br><span class="line">    <span class="keyword">int</span> res = reply.readInt();</span><br><span class="line">    data.recycle();</span><br><span class="line">    reply.recycle();</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>ActivityManagerNative</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> CHECK_URI_PERMISSION_TRANSACTION: &#123;</span><br><span class="line">    data.enforceInterface(IActivityManager.descriptor);</span><br><span class="line">    Uri uri = Uri.CREATOR.createFromParcel(data);</span><br><span class="line">    <span class="keyword">int</span> pid = data.readInt();</span><br><span class="line">    <span class="keyword">int</span> uid = data.readInt();</span><br><span class="line">    <span class="keyword">int</span> mode = data.readInt();</span><br><span class="line">    <span class="keyword">int</span> userId = data.readInt();</span><br><span class="line">    IBinder callerToken = data.readStrongBinder();</span><br><span class="line">    <span class="comment">//【*1.9】继续调用；</span></span><br><span class="line">    <span class="keyword">int</span> res = checkUriPermission(uri, pid, uid, mode, userId, callerToken);</span><br><span class="line">    reply.writeNoException();</span><br><span class="line">    reply.writeInt(res);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-10-checkUriPermissionLocked"><a href="#2-10-checkUriPermissionLocked" class="headerlink" title="2.10 checkUriPermissionLocked"></a>2.10 checkUriPermissionLocked</h2><p>用于检查 uid 是否已经被授予uri permissions！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">checkUriPermissionLocked</span><span class="params">(GrantUri grantUri, <span class="keyword">int</span> uid,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> <span class="keyword">int</span> modeFlags)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> persistable = (modeFlags &amp; Intent.FLAG_GRANT_PERSISTABLE_URI_PERMISSION) != <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> minStrength = persistable ? UriPermission.STRENGTH_PERSISTABLE</span><br><span class="line">            : UriPermission.STRENGTH_OWNED;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】如果 uid 是 0，为 root 用户，默认是授予，返回 true！</span></span><br><span class="line">    <span class="keyword">if</span> (uid == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】获得 uid 已经被授予的 UriPermission，如果没有，返回 false，表示没有授予权限！！</span></span><br><span class="line">    <span class="keyword">final</span> ArrayMap&lt;GrantUri, UriPermission&gt; perms = mGrantedUriPermissions.get(uid);</span><br><span class="line">    <span class="keyword">if</span> (perms == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】精确匹配 uri！</span></span><br><span class="line">    <span class="keyword">final</span> UriPermission exactPerm = perms.get(grantUri);</span><br><span class="line">    <span class="keyword">if</span> (exactPerm != <span class="keyword">null</span> &amp;&amp; exactPerm.getStrength(modeFlags) &gt;= minStrength) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【4】前缀匹配 uri！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> N = perms.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">        <span class="keyword">final</span> UriPermission perm = perms.valueAt(i);</span><br><span class="line">        <span class="keyword">if</span> (perm.uri.prefix &amp;&amp; grantUri.uri.isPathPrefixMatch(perm.uri.uri)</span><br><span class="line">                &amp;&amp; perm.getStrength(modeFlags) &gt;= minStrength) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于 modeFlags，除了能设置上面的 2 个标志之外，还可以设置下面的标志位：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Intent.FLAG_GRANT_PERSISTABLE_URI_PERMISSION</span><br></pre></td></tr></table></figure>
<p>FLAG_GRANT_READ_URI_PERMISSION 跟 FLAG_GRANT_WRITE_URI_PERMISSION 是用于授予临时权限，如果和 FLAG_GRANT_PERSISTABLE_URI_PERMISSION 结合使用，URI 权限会持久存在，重启也无法撤消，直到明确的用 revokeUriPermission(Uri, int) 撤销。 </p>
<p>这个 flag 只提供可能持久授权。但是接收的应用必须调用 ContentResolver.takePersistableUriPermission(Uri, int) 方法实现 。</p>
<h3 id="2-10-1-调用时机"><a href="#2-10-1-调用时机" class="headerlink" title="2.10.1 调用时机"></a>2.10.1 调用时机</h3><p>该方法的调用比较少，在 ActivityManagerService 中：</p>
<ul>
<li>一个是 2.9 checkUriPermission 方法中；</li>
<li>一个是 2.10 checkUriPermissionLocked 方法中；</li>
</ul>
<h2 id="2-11-checkPermissionWithToken"><a href="#2-11-checkPermissionWithToken" class="headerlink" title="2.11 checkPermissionWithToken"></a>2.11 checkPermissionWithToken</h2><p>检查 IBinder 对象对应的进程是否具有指定权限！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">checkPermissionWithToken</span><span class="params">(String permission, <span class="keyword">int</span> pid, <span class="keyword">int</span> uid, IBinder callerToken)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (permission == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> PackageManager.PERMISSION_DENIED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】计算 IBinder 对象对应的进程的 pid 和 uid！</span></span><br><span class="line">    Identity tlsIdentity = sCallerIdentity.get();</span><br><span class="line">    <span class="keyword">if</span> (tlsIdentity != <span class="keyword">null</span> &amp;&amp; tlsIdentity.token == callerToken) &#123;</span><br><span class="line">        Slog.d(TAG, <span class="string">"checkComponentPermission() adjusting &#123;pid,uid&#125; to &#123;"</span></span><br><span class="line">                + tlsIdentity.pid + <span class="string">","</span> + tlsIdentity.uid + <span class="string">"&#125;"</span>);</span><br><span class="line">        uid = tlsIdentity.uid;</span><br><span class="line">        pid = tlsIdentity.pid;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【*2.12】调用 checkComponentPermission 方法，继续检查：</span></span><br><span class="line">    <span class="keyword">return</span> checkComponentPermission(permission, pid, uid, -<span class="number">1</span>, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-11-1-跨进程调用"><a href="#2-11-1-跨进程调用" class="headerlink" title="2.11.1 跨进程调用"></a>2.11.1 跨进程调用</h3><p>调用方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    ActivityManagerNative.getDefault().checkPermissionWithToken(...);</span><br><span class="line">&#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>具体流程：</p>
<ul>
<li><strong>ActivityManagerProxy</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">checkPermissionWithToken</span><span class="params">(String permission, <span class="keyword">int</span> pid, <span class="keyword">int</span> uid, IBinder callerToken)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    Parcel data = Parcel.obtain();</span><br><span class="line">    Parcel reply = Parcel.obtain();</span><br><span class="line">    data.writeInterfaceToken(IActivityManager.descriptor);</span><br><span class="line">    data.writeString(permission);</span><br><span class="line">    data.writeInt(pid);</span><br><span class="line">    data.writeInt(uid);</span><br><span class="line">    data.writeStrongBinder(callerToken);</span><br><span class="line">    mRemote.transact(CHECK_PERMISSION_WITH_TOKEN_TRANSACTION, data, reply, <span class="number">0</span>);</span><br><span class="line">    reply.readException();</span><br><span class="line">    <span class="keyword">int</span> res = reply.readInt();</span><br><span class="line">    data.recycle();</span><br><span class="line">    reply.recycle();</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>ActivityManagerNative</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> CHECK_PERMISSION_WITH_TOKEN_TRANSACTION: &#123;</span><br><span class="line">    data.enforceInterface(IActivityManager.descriptor);</span><br><span class="line">    String perm = data.readString();</span><br><span class="line">    <span class="keyword">int</span> pid = data.readInt();</span><br><span class="line">    <span class="keyword">int</span> uid = data.readInt();</span><br><span class="line">    IBinder token = data.readStrongBinder();</span><br><span class="line">    <span class="comment">//【*2.11】继续调用；</span></span><br><span class="line">    <span class="keyword">int</span> res = checkPermissionWithToken(perm, pid, uid, token);</span><br><span class="line">    reply.writeNoException();</span><br><span class="line">    reply.writeInt(res);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-12-checkComponentPermission"><a href="#2-12-checkComponentPermission" class="headerlink" title="2.12 checkComponentPermission"></a>2.12 checkComponentPermission</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">checkComponentPermission</span><span class="params">(String permission, <span class="keyword">int</span> pid, <span class="keyword">int</span> uid,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> owningUid, <span class="keyword">boolean</span> exported)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (pid == MY_PID) &#123; <span class="comment">// 如果是进程自身，是持有权限的！</span></span><br><span class="line">        <span class="keyword">return</span> PackageManager.PERMISSION_GRANTED;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【*2.12.1】调用 ActivityManager 的 checkComponentPermission 方法！</span></span><br><span class="line">    <span class="keyword">return</span> ActivityManager.checkComponentPermission(permission, uid,</span><br><span class="line">            owningUid, exported);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-12-1-ActivityM-checkComponentPermission"><a href="#2-12-1-ActivityM-checkComponentPermission" class="headerlink" title="2.12.1 ActivityM.checkComponentPermission"></a>2.12.1 ActivityM.checkComponentPermission</h3><p>这个方法是一个 hide 方法，只能由系统调用！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">checkComponentPermission</span><span class="params">(String permission, <span class="keyword">int</span> uid,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> owningUid, <span class="keyword">boolean</span> exported)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】如果是 root 用户或者 system 用户，</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> appId = UserHandle.getAppId(uid);</span><br><span class="line">    <span class="keyword">if</span> (appId == Process.ROOT_UID || appId == Process.SYSTEM_UID) &#123;</span><br><span class="line">        <span class="keyword">return</span> PackageManager.PERMISSION_GRANTED;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】隔离进程无权限！</span></span><br><span class="line">    <span class="keyword">if</span> (UserHandle.isIsolated(uid)) &#123;</span><br><span class="line">        <span class="keyword">return</span> PackageManager.PERMISSION_DENIED;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【3】如果是相同 uid，有权限！</span></span><br><span class="line">    <span class="keyword">if</span> (owningUid &gt;= <span class="number">0</span> &amp;&amp; UserHandle.isSameApp(uid, owningUid)) &#123;</span><br><span class="line">        <span class="keyword">return</span> PackageManager.PERMISSION_GRANTED;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【4】如果组件不是暴露的，那就无权限！</span></span><br><span class="line">    <span class="keyword">if</span> (!exported) &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        RuntimeException here = new RuntimeException("here");</span></span><br><span class="line"><span class="comment">        here.fillInStackTrace();</span></span><br><span class="line"><span class="comment">        Slog.w(TAG, "Permission denied: checkComponentPermission() owningUid=" + owningUid,</span></span><br><span class="line"><span class="comment">                here);</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="keyword">return</span> PackageManager.PERMISSION_DENIED;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (permission == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> PackageManager.PERMISSION_GRANTED;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【*3.1】调用 pms 的 checkUidPermission 方法继续检查权限！</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> AppGlobals.getPackageManager()</span><br><span class="line">                .checkUidPermission(permission, uid);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-12-2-ActivityM-checkUidPermission"><a href="#2-12-2-ActivityM-checkUidPermission" class="headerlink" title="2.12.2 ActivityM.checkUidPermission"></a>2.12.2 ActivityM.checkUidPermission</h3><p>同时 ActivityManager 也有 checkUidPermission 方法，这方法是一个 hide 方法，只能由系统调用！</p>
<p>该方法会直接访问 pms 的接口！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">checkUidPermission</span><span class="params">(String permission, <span class="keyword">int</span> uid)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【*3.1】调用 pms 的 checkUidPermission 方法继续检查权限！</span></span><br><span class="line">        <span class="keyword">return</span> AppGlobals.getPackageManager()</span><br><span class="line">                .checkUidPermission(permission, uid);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="3-权限检查关键接口-PackageManagerService"><a href="#3-权限检查关键接口-PackageManagerService" class="headerlink" title="3 权限检查关键接口 - PackageManagerService"></a>3 权限检查关键接口 - PackageManagerService</h1><p>通过分析系统中的一些 checkPermissions 接口，我们发现最终都调用了 PackageManagerService.checkUidPermission 方法，下面我们去看下：</p>
<h2 id="3-1-checkUidPermission"><a href="#3-1-checkUidPermission" class="headerlink" title="3.1 checkUidPermission"></a>3.1 checkUidPermission</h2><p>用于检查 uid 是否具有权限 permName！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">checkUidPermission</span><span class="params">(String permName, <span class="keyword">int</span> uid)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> userId = UserHandle.getUserId(uid);</span><br><span class="line">    <span class="comment">//【1】首先是校验 userId 有效性！</span></span><br><span class="line">    <span class="keyword">if</span> (!sUserManager.exists(userId)) &#123;</span><br><span class="line">        <span class="keyword">return</span> PackageManager.PERMISSION_DENIED;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="comment">//【2】尝试根据 uid 获得其 PackageSetting 或者 SharedUserSetting 对象，这取决于 uid 是独立还是共享的！</span></span><br><span class="line">        Object obj = mSettings.getUserIdLPr(UserHandle.getAppId(uid));</span><br><span class="line">        <span class="keyword">if</span> (obj != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> SettingBase ps = (SettingBase) obj;</span><br><span class="line">            <span class="comment">//【2.1】获得权限管理对象 PermissionsState！</span></span><br><span class="line">            <span class="keyword">final</span> PermissionsState permissionsState = ps.getPermissionsState();</span><br><span class="line">            <span class="comment">// 如果该权限确实授予了该 uid，返回 PackageManager.PERMISSION_GRANTED！</span></span><br><span class="line">            <span class="keyword">if</span> (permissionsState.hasPermission(permName, userId)) &#123;</span><br><span class="line">                <span class="keyword">return</span> PackageManager.PERMISSION_GRANTED;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//【2.2】这里是处理一种特殊的权限！</span></span><br><span class="line">            <span class="keyword">if</span> (Manifest.permission.ACCESS_COARSE_LOCATION.equals(permName) &amp;&amp; permissionsState</span><br><span class="line">                    .hasPermission(Manifest.permission.ACCESS_FINE_LOCATION, userId)) &#123;</span><br><span class="line">                <span class="keyword">return</span> PackageManager.PERMISSION_GRANTED;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//【3】mSystemPermissions 中保存的是系统 uid 和其权限的对应关系！</span></span><br><span class="line">            ArraySet&lt;String&gt; perms = mSystemPermissions.get(uid);</span><br><span class="line">            <span class="keyword">if</span> (perms != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (perms.contains(permName)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> PackageManager.PERMISSION_GRANTED;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (Manifest.permission.ACCESS_COARSE_LOCATION.equals(permName) &amp;&amp; perms</span><br><span class="line">                        .contains(Manifest.permission.ACCESS_FINE_LOCATION)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> PackageManager.PERMISSION_GRANTED;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> PackageManager.PERMISSION_DENIED;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们来看下 getUserIdLPr 方法的逻辑：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getUserIdLPr</span><span class="params">(<span class="keyword">int</span> uid)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (uid &gt;= Process.FIRST_APPLICATION_UID) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> N = mUserIds.size();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> index = uid - Process.FIRST_APPLICATION_UID;</span><br><span class="line">        <span class="keyword">return</span> index &lt; N ? mUserIds.get(index) : <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mOtherUserIds.get(uid);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>uid 的取值范围</strong>：</li>
</ul>
<p>从 Process.FIRST_APPLICATION_UID（10000） 开始的 uid 是普通 Android 的应用程序，即使用户安装的应用程序，最大值为 Process.LAST_APPLICATION_UID（19999）！</p>
<p>而 Process.FIRST_APPLICATION_UID 以下的 uid 都是系统应用和系统进程的！</p>
<ul>
<li><strong>PackageSetting 和 SharedUserSetting</strong>：</li>
</ul>
<p>如果应用程序是独立 uid 的话，那么其会有一个 PackageSetting 对象，然后会根据其 uid 的类型，添加到 mUserIds 或者 mOtherUserIds；</p>
<p>如果应用程序是共享 uid 的话，除了会创建 PackageSetting 对象，还会创建一个 SharedUserSetting 对象，用来封装共享 uid 的信息 ，然后会根据其 uid 的类型，将 SharedUserSetting 对象添加到 mUserIds 或者 mOtherUserIds；</p>
<ul>
<li><strong>权限的处理</strong>：</li>
</ul>
<p>如果应用是独立 uid 的话，那么 getUserIdLPr 返回是 PackageSetting 对象！</p>
<p>如果应用是共享 uid 的话，那么 getUserIdLPr 返回的是 SharedUserSetting 对象，这是因为共享同一个 uid 的应用持有相同的权限！</p>
<p>PackageSetting 和 SharedUserSetting 都有一个 PermissionsState 对象，用于封装 package 在不同 userId 下的权限授予情况！</p>
<h2 id="3-2-checkPermission"><a href="#3-2-checkPermission" class="headerlink" title="3.2 checkPermission"></a>3.2 checkPermission</h2><p>PMS 还有另外一个用于检查权限的方法，判断包名对应的应用程序是否有权限！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">checkPermission</span><span class="params">(String permName, String pkgName, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!sUserManager.exists(userId)) &#123;</span><br><span class="line">        <span class="keyword">return</span> PackageManager.PERMISSION_DENIED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="comment">//【1】获得该 pkg 对应的 Package 实例！</span></span><br><span class="line">        <span class="keyword">final</span> PackageParser.Package p = mPackages.get(pkgName);</span><br><span class="line">        <span class="keyword">if</span> (p != <span class="keyword">null</span> &amp;&amp; p.mExtras != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> PackageSetting ps = (PackageSetting) p.mExtras;</span><br><span class="line">            <span class="keyword">final</span> PermissionsState permissionsState = ps.getPermissionsState();</span><br><span class="line">            <span class="comment">//【1.1】判断 permissionsState 中该权限状态是否是 true！</span></span><br><span class="line">            <span class="keyword">if</span> (permissionsState.hasPermission(permName, userId)) &#123;</span><br><span class="line">                <span class="keyword">return</span> PackageManager.PERMISSION_GRANTED;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【1.2】对于 ACCESS_COARSE_LOCATION 比较特殊，如果应用已经有了 ACCESS_FINE_LOCATION</span></span><br><span class="line">            <span class="comment">// 那么应用也会有 ACCESS_COARSE_LOCATION 权限！</span></span><br><span class="line">            <span class="keyword">if</span> (Manifest.permission.ACCESS_COARSE_LOCATION.equals(permName) &amp;&amp; permissionsState</span><br><span class="line">                    .hasPermission(Manifest.permission.ACCESS_FINE_LOCATION, userId)) &#123;</span><br><span class="line">                <span class="keyword">return</span> PackageManager.PERMISSION_GRANTED;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> PackageManager.PERMISSION_DENIED;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该方法用于判断 pkgName 在 userId 下，是否有权限 permName！</p>
<h3 id="3-2-1-调用时机"><a href="#3-2-1-调用时机" class="headerlink" title="3.2.1 调用时机"></a>3.2.1 调用时机</h3><p>PMS 的接口可以被其他 check 接口调用，同时我们也可以直接调用其进行权限检查：</p>
<h4 id="3-2-1-1-BroadcastQueue-processNextBroadcast"><a href="#3-2-1-1-BroadcastQueue-processNextBroadcast" class="headerlink" title="3.2.1.1 BroadcastQueue.processNextBroadcast"></a>3.2.1.1 BroadcastQueue.processNextBroadcast</h4><p>在我们发送广播的时候，如果广播指定了接收者的权限，那么我们会校验</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">processNextBroadcast</span><span class="params">(<span class="keyword">boolean</span> fromMsg)</span> </span>&#123;</span><br><span class="line">    ... ... ...</span><br><span class="line">       <span class="keyword">if</span> (!skip &amp;&amp; info.activityInfo.applicationInfo.uid != Process.SYSTEM_UID &amp;&amp;</span><br><span class="line">            r.requiredPermissions != <span class="keyword">null</span> &amp;&amp; r.requiredPermissions.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; r.requiredPermissions.length; i++) &#123;</span><br><span class="line">                String requiredPermission = r.requiredPermissions[i];</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    perm = AppGlobals.getPackageManager().</span><br><span class="line">                            checkPermission(requiredPermission,</span><br><span class="line">                                    info.activityInfo.applicationInfo.packageName,</span><br><span class="line">                                    UserHandle</span><br><span class="line">                                            .getUserId(info.activityInfo.applicationInfo.uid));</span><br><span class="line">                &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                    perm = PackageManager.PERMISSION_DENIED;</span><br><span class="line">                &#125;</span><br><span class="line">                ... ... ...</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2017/05/23/AlarmManager第 1 篇 - AlarmManagerService启动/">AlarmManager第 1 篇 - AlarmManagerService启动</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2017-05-23</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/AndroidFramework源码分析/">AndroidFramework源码分析</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/AndroidFramework源码分析/AlarmManager闹钟管理/">AlarmManager闹钟管理</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/AlarmManager闹钟管理/">AlarmManager闹钟管理</a></span><div class="content"><p>基于 Android7.1.1 源码，分析 AlarmManagerService 的启动流程，这里我们重点关注和分析 java 层的逻辑实现！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startOtherServices</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ... ... ...</span><br><span class="line">    traceBeginAndSlog(<span class="string">"StartAlarmManagerService"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】启动 AlarmManagerService</span></span><br><span class="line">    mSystemServiceManager.startService(AlarmManagerService.class);</span><br><span class="line">    Trace.traceEnd(Trace.TRACE_TAG_SYSTEM_SERVER);</span><br><span class="line">    ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先会创建 AlarmManagerService 实例对象，然后会调用其 onStart 方法！</p>
<h1 id="1-Constructor"><a href="#1-Constructor" class="headerlink" title="1 Constructor"></a>1 Constructor</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">AlarmManagerService</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(context);</span><br><span class="line">    <span class="comment">// 创建了常量实例，用于存储其所需的一些常量！</span></span><br><span class="line">    mConstants = <span class="keyword">new</span> Constants(mHandler);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>AlarmManagerService 的构造器很简单，只是创建了一个 Constants 实例对象！</p>
<h2 id="1-1-new-Constants"><a href="#1-1-new-Constants" class="headerlink" title="1.1 new Constants"></a>1.1 new Constants</h2><p>Constants 用来保存 alarm manger 需要的一些常量数据，其内部有一些和属性值！</p>
<p>该类中所有的时间单位都是毫秒，这些常量的值和系统全局设置 Settings.Global 中的值保持同步，任何访问该类或该类中的字段都要持有 AlarmManagerService.mLock 锁！</p>
<p>首先，是一些  Settings.Global 中的 key 值，用于将数据保存到 Settings 中！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String KEY_MIN_FUTURITY = <span class="string">"min_futurity"</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String KEY_MIN_INTERVAL = <span class="string">"min_interval"</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String KEY_ALLOW_WHILE_IDLE_SHORT_TIME = <span class="string">"allow_while_idle_short_time"</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String KEY_ALLOW_WHILE_IDLE_LONG_TIME = <span class="string">"allow_while_idle_long_time"</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String KEY_ALLOW_WHILE_IDLE_WHITELIST_DURATION</span><br><span class="line">        = <span class="string">"allow_while_idle_whitelist_duration"</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String KEY_LISTENER_TIMEOUT = <span class="string">"listener_timeout"</span>;</span><br></pre></td></tr></table></figure></p>
<p>接着是一些 default 值，用于初始化成员变量！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> DEFAULT_MIN_FUTURITY = <span class="number">5</span> * <span class="number">1000</span>; <span class="comment">// 默认的最小触发时间： 5s</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> DEFAULT_MIN_INTERVAL = <span class="number">60</span> * <span class="number">1000</span>; <span class="comment">// 默认最小时间间隔； 60s!</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> DEFAULT_ALLOW_WHILE_IDLE_SHORT_TIME = DEFAULT_MIN_FUTURITY;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> DEFAULT_ALLOW_WHILE_IDLE_LONG_TIME = <span class="number">9</span>*<span class="number">60</span>*<span class="number">1000</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> DEFAULT_ALLOW_WHILE_IDLE_WHITELIST_DURATION = <span class="number">10</span>*<span class="number">1000</span>;</span><br><span class="line">    </span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> DEFAULT_LISTENER_TIMEOUT = <span class="number">5</span> * <span class="number">1000</span>; <span class="comment">// 默认的监听超时时间：5s</span></span><br></pre></td></tr></table></figure></p>
<p>最后是一些 alarm manager 会用到的一些成员变量：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Minimum futurity of a new alarm</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">long</span> MIN_FUTURITY = DEFAULT_MIN_FUTURITY;</span><br><span class="line"></span><br><span class="line"><span class="comment">// alarm 重复执行的最小时间间隔！</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">long</span> MIN_INTERVAL = DEFAULT_MIN_INTERVAL;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Minimum time between ALLOW_WHILE_IDLE alarms when system is not idle.</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">long</span> ALLOW_WHILE_IDLE_SHORT_TIME = DEFAULT_ALLOW_WHILE_IDLE_SHORT_TIME;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Minimum time between ALLOW_WHILE_IDLE alarms when system is idling.</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">long</span> ALLOW_WHILE_IDLE_LONG_TIME = DEFAULT_ALLOW_WHILE_IDLE_LONG_TIME;</span><br><span class="line"></span><br><span class="line"><span class="comment">// BroadcastOptions.setTemporaryAppWhitelistDuration() to use for FLAG_ALLOW_WHILE_IDLE.</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">long</span> ALLOW_WHILE_IDLE_WHITELIST_DURATION</span><br><span class="line">        = DEFAULT_ALLOW_WHILE_IDLE_WHITELIST_DURATION;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Direct alarm listener callback timeout</span></span><br><span class="line"><span class="comment">// 闹钟监听回调超时时间，初始化为 5s;</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">long</span> LISTENER_TIMEOUT = DEFAULT_LISTENER_TIMEOUT;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> ContentResolver mResolver; <span class="comment">// 用于访问设置的全局数据库！</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> KeyValueListParser mParser = <span class="keyword">new</span> KeyValueListParser(<span class="string">','</span>);</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">long</span> mLastAllowWhileIdleWhitelistDuration = -<span class="number">1</span>;</span><br></pre></td></tr></table></figure></p>
<p>接着，去看看 Constants 的构造器！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Constants</span><span class="params">(Handler handler)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(handler);</span><br><span class="line">    <span class="comment">// 更新 idle 相关的时间值</span></span><br><span class="line">    updateAllowWhileIdleMinTimeLocked();</span><br><span class="line">    updateAllowWhileIdleWhitelistDurationLocked();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="1-2-Constructor-updateAllowWhileIdleMinTimeLocked"><a href="#1-2-Constructor-updateAllowWhileIdleMinTimeLocked" class="headerlink" title="1.2 Constructor.updateAllowWhileIdleMinTimeLocked"></a>1.2 Constructor.updateAllowWhileIdleMinTimeLocked</h2><p>这里调用了两个方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateAllowWhileIdleMinTimeLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】更新 allow while idle 类型的 alarm 的最小触发时间点！</span></span><br><span class="line">    mAllowWhileIdleMinTime = mPendingIdleUntil != <span class="keyword">null</span></span><br><span class="line">            ? ALLOW_WHILE_IDLE_LONG_TIME : ALLOW_WHILE_IDLE_SHORT_TIME;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果此时已经进入了 idle 状态，那么触发的最小时间间隔为：ALLOW_WHILE_IDLE_LONG_TIME，否则为 ALLOW_WHILE_IDLE_SHORT_TIME！</p>
<h2 id="1-3-Constructor-updateAllowWhileIdleWhitelistDurationLocked"><a href="#1-3-Constructor-updateAllowWhileIdleWhitelistDurationLocked" class="headerlink" title="1.3 Constructor.updateAllowWhileIdleWhitelistDurationLocked"></a>1.3 Constructor.updateAllowWhileIdleWhitelistDurationLocked</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateAllowWhileIdleWhitelistDurationLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【2】更新 mLastAllowWhileIdleWhitelistDuration 变量！</span></span><br><span class="line">    <span class="keyword">if</span> (mLastAllowWhileIdleWhitelistDuration != ALLOW_WHILE_IDLE_WHITELIST_DURATION) &#123;</span><br><span class="line">        mLastAllowWhileIdleWhitelistDuration = ALLOW_WHILE_IDLE_WHITELIST_DURATION;</span><br><span class="line">        BroadcastOptions opts = BroadcastOptions.makeBasic();</span><br><span class="line">        opts.setTemporaryAppWhitelistDuration(ALLOW_WHILE_IDLE_WHITELIST_DURATION);</span><br><span class="line">        mIdleOptions = opts.toBundle();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>继续来看，该方法用于设置 system 更新 idle whilde list 的时间间隔，目前是 10 × 1000 毫秒！</p>
<h1 id="2-onStart"><a href="#2-onStart" class="headerlink" title="2 onStart"></a>2 onStart</h1><p>接着是重点 onStart 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【2.1】native 层的初始化操作，打开 alarm 驱动，并返回驱动文件句柄！</span></span><br><span class="line">    mNativeData = init();</span><br><span class="line">    mNextWakeup = mNextNonWakeup = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2.2】设置时区给 kernel，因为 kernel 重启后不会保存时区信息！</span></span><br><span class="line">    setTimeZoneImpl(SystemProperties.get(TIMEZONE_PROPERTY));</span><br><span class="line"></span><br><span class="line">    PowerManager pm = (PowerManager) getContext().getSystemService(Context.POWER_SERVICE);</span><br><span class="line">    mWakeLock = pm.newWakeLock(PowerManager.PARTIAL_WAKE_LOCK, <span class="string">"*alarm*"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建时间发生改变的广播！</span></span><br><span class="line">    mTimeTickSender = PendingIntent.getBroadcastAsUser(getContext(), <span class="number">0</span>,</span><br><span class="line">            <span class="keyword">new</span> Intent(Intent.ACTION_TIME_TICK).addFlags(</span><br><span class="line">                    Intent.FLAG_RECEIVER_REGISTERED_ONLY</span><br><span class="line">                    | Intent.FLAG_RECEIVER_FOREGROUND), <span class="number">0</span>,</span><br><span class="line">                    UserHandle.ALL);</span><br><span class="line">                    </span><br><span class="line">    <span class="comment">// 创建日期发生改变的广播！</span></span><br><span class="line">    Intent intent = <span class="keyword">new</span> Intent(Intent.ACTION_DATE_CHANGED);</span><br><span class="line">    intent.addFlags(Intent.FLAG_RECEIVER_REPLACE_PENDING);</span><br><span class="line">    mDateChangeSender = PendingIntent.getBroadcastAsUser(getContext(), <span class="number">0</span>, intent,</span><br><span class="line">            Intent.FLAG_RECEIVER_REGISTERED_ONLY_BEFORE_BOOT, UserHandle.ALL);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【2.2】创建一个 ClockReceiver 广播接收者，用于接收 Intent.ACTION_DATE_CHANGED 和 Intent.ACTION_TIME_TICK 广播！</span></span><br><span class="line">    mClockReceiver = <span class="keyword">new</span> ClockReceiver();</span><br><span class="line">    <span class="comment">// 设置时间改变和日期改变的 Alarm！</span></span><br><span class="line">    mClockReceiver.scheduleTimeTickEvent();</span><br><span class="line">    mClockReceiver.scheduleDateChangedEvent();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【2.3】创建监听熄屏亮屏广播的接收者！</span></span><br><span class="line">    mInteractiveStateReceiver = <span class="keyword">new</span> InteractiveStateReceiver();</span><br><span class="line">    mUninstallReceiver = <span class="keyword">new</span> UninstallReceiver();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【2.4】如果成功打开了驱动文件句柄，那就创建一个 AlarmThread，监控驱动文件！</span></span><br><span class="line">    <span class="comment">// 如果无法打开 Alarm 驱动，那就是用 AlarmHandler 对象！</span></span><br><span class="line">    <span class="keyword">if</span> (mNativeData != <span class="number">0</span>) &#123;</span><br><span class="line">        AlarmThread waitThread = <span class="keyword">new</span> AlarmThread();</span><br><span class="line">        waitThread.start();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Failed to open alarm driver. Falling back to a handler."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 注册 uid 观察者！</span></span><br><span class="line">        ActivityManagerNative.getDefault().registerUidObserver(<span class="keyword">new</span> UidObserver(),</span><br><span class="line">                ActivityManager.UID_OBSERVER_IDLE);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="comment">// ignored; both services live in system_server</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将 AlarmManagerService 注册到 SystemService 中！</span></span><br><span class="line">    publishBinderService(Context.ALARM_SERVICE, mService);</span><br><span class="line">    publishLocalService(LocalService.class, <span class="keyword">new</span> LocalService());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面我们来具体分析下：</p>
<h2 id="2-1-init-gt-android-server-AlarmManagerService-init"><a href="#2-1-init-gt-android-server-AlarmManagerService-init" class="headerlink" title="2.1 init -&gt; android_server_AlarmManagerService_init"></a>2.1 init -&gt; android_server_AlarmManagerService_init</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">long</span> <span class="title">init</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>
<p>可以看到，这是一个 native 方法，方法的定义在：android/frameworks/base/services/core/jni/com_android_server_AlarmManagerService.cpp 中！</p>
<p>最终会通过 systemCall 进入 native 层，调用 android_server_AlarmManagerService_init 方法！</p>
<p>我们来看看 init 最终做了什么：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> jlong <span class="title">android_server_AlarmManagerService_init</span><span class="params">(JNIEnv*, jobject)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//【2.1.1】初始化 alarm 驱动！</span></span><br><span class="line">    jlong ret = init_alarm_driver();</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【2.1.2】初始化定时器 fd！</span></span><br><span class="line">    <span class="keyword">return</span> init_timerfd();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里我们不过多关注！</p>
<h2 id="2-2-setTimeZoneImpl"><a href="#2-2-setTimeZoneImpl" class="headerlink" title="2.2 setTimeZoneImpl"></a>2.2 setTimeZoneImpl</h2><p>更新时区信息，把当前时区保存到内核中！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setTimeZoneImpl</span><span class="params">(String tz)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (TextUtils.isEmpty(tz)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取最新的时区信息！ </span></span><br><span class="line">    TimeZone zone = TimeZone.getTimeZone(tz);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 防止重复写入</span></span><br><span class="line">    <span class="keyword">boolean</span> timeZoneWasChanged = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="comment">// 通过系统属性获得已经保存的时区信息；</span></span><br><span class="line">        String current = SystemProperties.get(TIMEZONE_PROPERTY);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 如果 current 不等于 zone.getID()。说明时区信息发生了变化！</span></span><br><span class="line">        <span class="keyword">if</span> (current == <span class="keyword">null</span> || !current.equals(zone.getID())) &#123;</span><br><span class="line">            <span class="keyword">if</span> (localLOGV) &#123;</span><br><span class="line">                Slog.v(TAG, <span class="string">"timezone changed: "</span> + current + <span class="string">", new="</span> + zone.getID());</span><br><span class="line">            &#125;</span><br><span class="line">            timeZoneWasChanged = <span class="keyword">true</span>;</span><br><span class="line">            <span class="comment">// 更新系统属性，应用程序会读取该属性！</span></span><br><span class="line">            SystemProperties.set(TIMEZONE_PROPERTY, zone.getID());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 更新内核时区信息  </span></span><br><span class="line">         <span class="comment">// 内核跟踪时间偏移为GMT以西的分钟数 </span></span><br><span class="line">        <span class="keyword">int</span> gmtOffset = zone.getOffset(System.currentTimeMillis());</span><br><span class="line">        setKernelTimezone(mNativeData, -(gmtOffset / <span class="number">60000</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    TimeZone.setDefault(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果时区发生了变化，那就发送 Intent.ACTION_TIMEZONE_CHANGED 的广播！</span></span><br><span class="line">    <span class="keyword">if</span> (timeZoneWasChanged) &#123;</span><br><span class="line">        Intent intent = <span class="keyword">new</span> Intent(Intent.ACTION_TIMEZONE_CHANGED);</span><br><span class="line">        intent.addFlags(Intent.FLAG_RECEIVER_REPLACE_PENDING);</span><br><span class="line">        intent.putExtra(<span class="string">"time-zone"</span>, zone.getID());</span><br><span class="line">        getContext().sendBroadcastAsUser(intent, UserHandle.ALL);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里的 setKernelTimezone 是一个 native 方法，这里我们先不看！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">int</span> <span class="title">setKernelTimezone</span><span class="params">(<span class="keyword">long</span> nativeData, <span class="keyword">int</span> minuteswest)</span></span>;</span><br></pre></td></tr></table></figure>
<p>更新 kernel 时区的信息的原因是，kernel 在重启后，并不会保存时区信息！</p>
<h2 id="2-3-ClockReceiver"><a href="#2-3-ClockReceiver" class="headerlink" title="2.3 ClockReceiver"></a>2.3 ClockReceiver</h2><p>我们来看看 ClockReceiver，是一个动态注册的 BroadcastReceiver，用于接收 Intent.ACTION_TIME_TICK 时间改变和 Intent.ACTION_DATE_CHANGED 日期改变的广播！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ClockReceiver</span> <span class="keyword">extends</span> <span class="title">BroadcastReceiver</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ClockReceiver</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 监听 Intent.ACTION_TIME_TICK 和 Intent.ACTION_DATE_CHANGED 的广播！</span></span><br><span class="line">        IntentFilter filter = <span class="keyword">new</span> IntentFilter();</span><br><span class="line">        filter.addAction(Intent.ACTION_TIME_TICK);</span><br><span class="line">        filter.addAction(Intent.ACTION_DATE_CHANGED);</span><br><span class="line">        getContext().registerReceiver(<span class="keyword">this</span>, filter);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(Context context, Intent intent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (intent.getAction().equals(Intent.ACTION_TIME_TICK)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_BATCH) &#123;</span><br><span class="line">                Slog.v(TAG, <span class="string">"Received TIME_TICK alarm; rescheduling"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 接收到 Intent.ACTION_TIME_TICK 广播后，执行 scheduleTimeTickEvent！</span></span><br><span class="line">            scheduleTimeTickEvent();</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (intent.getAction().equals(Intent.ACTION_DATE_CHANGED)) &#123;</span><br><span class="line">            <span class="comment">// 因为 kernel 无法对 DST 进行监控，基于当前时区的 gmt 偏移 + 用户空间跟踪保存的信息来重置时区信息！</span></span><br><span class="line">            TimeZone zone = TimeZone.getTimeZone(SystemProperties.get(TIMEZONE_PROPERTY));</span><br><span class="line">            <span class="keyword">int</span> gmtOffset = zone.getOffset(System.currentTimeMillis());</span><br><span class="line">            setKernelTimezone(mNativeData, -(gmtOffset / <span class="number">60000</span>));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 接收到 Intent.ACTION_DATE_CHANGED 广播后，执行 scheduleDateChangedEvent！</span></span><br><span class="line">            scheduleDateChangedEvent();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ... ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到：</p>
<ul>
<li>当收到 Intent.ACTION_TIME_TICK 后，触发 scheduleTimeTickEvent 方法；</li>
<li>当收到 Intent.ACTION_DATE_CHANGED，触发 scheduleDateChangedEvent 方法：</li>
</ul>
<h3 id="2-3-1-ClockReceiver-scheduleTimeTickEvent"><a href="#2-3-1-ClockReceiver-scheduleTimeTickEvent" class="headerlink" title="2.3.1 ClockReceiver.scheduleTimeTickEvent"></a>2.3.1 ClockReceiver.scheduleTimeTickEvent</h3><p>我们来看下 scheduleTimeTickEvent，该方法每一分钟，就会给所有接收 ACTION_TIME_TICK 广播的接收者发送广播，注意这里也包括自身！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scheduleTimeTickEvent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】获得当前时间对应的毫秒值！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> currentTime = System.currentTimeMillis();</span><br><span class="line">    <span class="comment">//【2】计算当前时间过 1 分钟后的毫秒值！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> nextTime = <span class="number">60000</span> * ((currentTime / <span class="number">60000</span>) + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Schedule this event for the amount of time that it would take to get to</span></span><br><span class="line">    <span class="comment">// the top of the next minute.</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> tickEventDelay = nextTime - currentTime;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> WorkSource workSource = <span class="keyword">null</span>; <span class="comment">// Let system take blame for time tick events.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】设置 alarm！</span></span><br><span class="line">    setImpl(ELAPSED_REALTIME, SystemClock.elapsedRealtime() + tickEventDelay, <span class="number">0</span>,</span><br><span class="line">            <span class="number">0</span>, mTimeTickSender, <span class="keyword">null</span>, <span class="keyword">null</span>, AlarmManager.FLAG_STANDALONE, workSource,</span><br><span class="line">            <span class="keyword">null</span>, Process.myUid(), <span class="string">"android"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看出 scheduleTimeTickEvent 方法会设置一个 alarm，距离当前时间的下一秒，这个 alarm 会发送 Intent.ACTION_TIME_TICK 广播！</p>
<p>然后 ClockReceiver 会接收到这个广播，然后继续设置下一秒的，发送 Intent.ACTION_TIME_TICK 广播的 alarm，如此循环下去！</p>
<h3 id="2-3-2-ClockReceiver-scheduleDateChangedEvent"><a href="#2-3-2-ClockReceiver-scheduleDateChangedEvent" class="headerlink" title="2.3.2 ClockReceiver.scheduleDateChangedEvent"></a>2.3.2 ClockReceiver.scheduleDateChangedEvent</h3><p>我们来看下 scheduleDateChangedEvent：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scheduleDateChangedEvent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】计算下一天的 0 点整所对应的 alarm！</span></span><br><span class="line">    Calendar calendar = Calendar.getInstance();</span><br><span class="line">    calendar.setTimeInMillis(System.currentTimeMillis());</span><br><span class="line">    calendar.set(Calendar.HOUR_OF_DAY, <span class="number">0</span>);</span><br><span class="line">    calendar.set(Calendar.MINUTE, <span class="number">0</span>);</span><br><span class="line">    calendar.set(Calendar.SECOND, <span class="number">0</span>);</span><br><span class="line">    calendar.set(Calendar.MILLISECOND, <span class="number">0</span>);</span><br><span class="line">    calendar.add(Calendar.DAY_OF_MONTH, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> WorkSource workSource = <span class="keyword">null</span>; <span class="comment">// Let system take blame for date change events.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】设置 alarm！</span></span><br><span class="line">    setImpl(RTC, calendar.getTimeInMillis(), <span class="number">0</span>, <span class="number">0</span>, mDateChangeSender, <span class="keyword">null</span>, <span class="keyword">null</span>,</span><br><span class="line">            AlarmManager.FLAG_STANDALONE, workSource, <span class="keyword">null</span>,</span><br><span class="line">            Process.myUid(), <span class="string">"android"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看出 scheduleDateChangedEvent 方法会设置一个 alarm，触发事件是下一天的 0 点整，这个 alarm 会发送 Intent.ACTION_DATE_CHANGED 广播！</p>
<p>然后 ClockReceiver 会接收到这个广播，然后继续设置下一天 0 点整的，发送 Intent.Intent.ACTION_DATE_CHANGED 广播的 alarm，如此循环下去！</p>
<p>我们可以看到这里涉及到了一个方法 <strong>setImpl</strong>，这个方法我们后续会分析，这里先简单认为其设置了一个 alarm！</p>
<h2 id="2-4-InteractiveStateReceiver"><a href="#2-4-InteractiveStateReceiver" class="headerlink" title="2.4 InteractiveStateReceiver"></a>2.4 InteractiveStateReceiver</h2><p>InteractiveStateReceiver 用于监控熄屏亮屏的广播！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">InteractiveStateReceiver</span> <span class="keyword">extends</span> <span class="title">BroadcastReceiver</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">InteractiveStateReceiver</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        IntentFilter filter = <span class="keyword">new</span> IntentFilter();</span><br><span class="line">        filter.addAction(Intent.ACTION_SCREEN_OFF);</span><br><span class="line">        filter.addAction(Intent.ACTION_SCREEN_ON);</span><br><span class="line">        filter.setPriority(IntentFilter.SYSTEM_HIGH_PRIORITY);</span><br><span class="line">        getContext().registerReceiver(<span class="keyword">this</span>, filter);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(Context context, Intent intent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">            <span class="comment">//【2.2.1】处理熄屏亮屏广播！</span></span><br><span class="line">            interactiveStateChangedLocked(Intent.ACTION_SCREEN_ON.equals(intent.getAction()));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>监听的 Alarm：</p>
<ul>
<li>Intent.ACTION_SCREEN_OFF</li>
<li>Intent.ACTION_SCREEN_ON</li>
</ul>
<p>继续来看：</p>
<h3 id="2-4-1-interactiveStateChangedLocked"><a href="#2-4-1-interactiveStateChangedLocked" class="headerlink" title="2.4.1 interactiveStateChangedLocked"></a>2.4.1 interactiveStateChangedLocked</h3><p>这里说下参数 interactive，表示接收到的是否亮屏广播：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Intent.ACTION_SCREEN_ON.equals(intent.getAction())</span><br></pre></td></tr></table></figure>
<p>成员变量 mInteractive 用来保存上一次的熄屏亮屏状态！</p>
<p>接下来，我们来看看 interactiveStateChangedLocked 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">interactiveStateChangedLocked</span><span class="params">(<span class="keyword">boolean</span> interactive)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mInteractive != interactive) &#123; <span class="comment">// 不相等，说明熄屏亮屏状态发生了变化！</span></span><br><span class="line">        mInteractive = interactive; <span class="comment">// 更新 mInteractive</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 获得自开机后，经过的时间，包括深度睡眠的时间！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> nowELAPSED = SystemClock.elapsedRealtime();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (interactive) &#123; </span><br><span class="line">        <span class="comment">// 如果从 screen off 变为了 screen on，说明此时是亮屏状态！</span></span><br><span class="line">            <span class="keyword">if</span> (mPendingNonWakeupAlarms.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">long</span> thisDelayTime = nowELAPSED - mStartCurrentDelayTime;</span><br><span class="line">                mTotalDelayTime += thisDelayTime;</span><br><span class="line">                <span class="keyword">if</span> (mMaxDelayTime &lt; thisDelayTime) &#123;</span><br><span class="line">                    mMaxDelayTime = thisDelayTime;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 立刻分发那些等待中的 no wake up 类型的 alarm！</span></span><br><span class="line">                deliverAlarmsLocked(mPendingNonWakeupAlarms, nowELAPSED);</span><br><span class="line">                mPendingNonWakeupAlarms.clear();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 如果 mNonInteractiveStartTime 大于 0，那么就计算上次处于熄屏的时间间隔，保存到 mNonInteractiveTime！</span></span><br><span class="line">            <span class="keyword">if</span> (mNonInteractiveStartTime &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">long</span> dur = nowELAPSED - mNonInteractiveStartTime;</span><br><span class="line">                <span class="keyword">if</span> (dur &gt; mNonInteractiveTime) &#123;</span><br><span class="line">                    mNonInteractiveTime = dur;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 如果从 screen on 变为了 screen off，说明此时是熄屏状态，记录熄屏开始时间！</span></span><br><span class="line">            mNonInteractiveStartTime = nowELAPSED;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="3-onBootPhase"><a href="#3-onBootPhase" class="headerlink" title="3 onBootPhase"></a>3 onBootPhase</h1><p>在启动的最后阶段，system ready 的时候，会调用 AlarmManagerService 的 onBootPhase 方法！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onBootPhase</span><span class="params">(<span class="keyword">int</span> phase)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (phase == PHASE_SYSTEM_SERVICES_READY) &#123;</span><br><span class="line">        <span class="comment">//【3.1】调用 Constants 的 start 方法！</span></span><br><span class="line">        mConstants.start(getContext().getContentResolver());</span><br><span class="line">        <span class="comment">// 获得 AppOps 管理对象!</span></span><br><span class="line">        mAppOps = (AppOpsManager) getContext().getSystemService(Context.APP_OPS_SERVICE);</span><br><span class="line">        <span class="comment">// 获得 DeviceIdleController 对象！</span></span><br><span class="line">        mLocalDeviceIdleController</span><br><span class="line">                = LocalServices.getService(DeviceIdleController.LocalService.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们来去看看 Constants.start 方法：</p>
<h2 id="3-1-Constants-start"><a href="#3-1-Constants-start" class="headerlink" title="3.1 Constants.start"></a>3.1 Constants.start</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(ContentResolver resolver)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】获得系统数据库的 ContentResolver！</span></span><br><span class="line">    mResolver = resolver;</span><br><span class="line">    <span class="comment">//【2】监听 alarm_manager_constants 数据库的变化！</span></span><br><span class="line">    mResolver.registerContentObserver(Settings.Global.getUriFor(</span><br><span class="line">            Settings.Global.ALARM_MANAGER_CONSTANTS), <span class="keyword">false</span>, <span class="keyword">this</span>);</span><br><span class="line">    <span class="comment">//【3】启动时，默认更新一次 Constants；</span></span><br><span class="line">    updateConstants();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当 Settings.Global.ALARM_MANAGER_CONSTANTS 的数据发生变化后，会触发 Constants 的回调：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onChange</span><span class="params">(<span class="keyword">boolean</span> selfChange, Uri uri)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【3.2】调用 updateConstants 更新</span></span><br><span class="line">    updateConstants();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="3-2-Constants-updateConstants"><a href="#3-2-Constants-updateConstants" class="headerlink" title="3.2 Constants.updateConstants"></a>3.2 Constants.updateConstants</h2><p>更新 Constants 中的属性值！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateConstants</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="comment">//【1】读取 Settings 的 Global 数据库中的 alarm_manager_constants 项数据！</span></span><br><span class="line">        <span class="comment">// 更新 Constants 内部变量！</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mParser.setString(Settings.Global.getString(mResolver,</span><br><span class="line">                    Settings.Global.ALARM_MANAGER_CONSTANTS));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">            <span class="comment">// Failed to parse the settings string, log this and move on</span></span><br><span class="line">            <span class="comment">// with defaults.</span></span><br><span class="line">            Slog.e(TAG, <span class="string">"Bad device idle settings"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        MIN_FUTURITY = mParser.getLong(KEY_MIN_FUTURITY, DEFAULT_MIN_FUTURITY);</span><br><span class="line">        MIN_INTERVAL = mParser.getLong(KEY_MIN_INTERVAL, DEFAULT_MIN_INTERVAL);</span><br><span class="line">        ALLOW_WHILE_IDLE_SHORT_TIME = mParser.getLong(KEY_ALLOW_WHILE_IDLE_SHORT_TIME,</span><br><span class="line">                DEFAULT_ALLOW_WHILE_IDLE_SHORT_TIME);</span><br><span class="line">        ALLOW_WHILE_IDLE_LONG_TIME = mParser.getLong(KEY_ALLOW_WHILE_IDLE_LONG_TIME,</span><br><span class="line">                DEFAULT_ALLOW_WHILE_IDLE_LONG_TIME);</span><br><span class="line">        ALLOW_WHILE_IDLE_WHITELIST_DURATION = mParser.getLong(</span><br><span class="line">                KEY_ALLOW_WHILE_IDLE_WHITELIST_DURATION,</span><br><span class="line">                DEFAULT_ALLOW_WHILE_IDLE_WHITELIST_DURATION);</span><br><span class="line">        LISTENER_TIMEOUT = mParser.getLong(KEY_LISTENER_TIMEOUT,</span><br><span class="line">                DEFAULT_LISTENER_TIMEOUT);</span><br><span class="line"></span><br><span class="line">        updateAllowWhileIdleMinTimeLocked();</span><br><span class="line">        updateAllowWhileIdleWhitelistDurationLocked();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Alarm 是 AlarmManagerService 的一个内部类 Alarm，所有应用在设置 Alarm 的时候，都会在 setImplLocked 函数中将 Alarm 格式化为内部类 Alarm 的格式，定义截选如下：</p>
<pre><code>private static class Alarm {

public int type;

public int count;

public long when;

public long repeatInterval;

public PendingIntent operation;

public int uid;

public int pid;
</code></pre><p>其中记录了逻辑闹钟的一些关键信息。 </p>
<p>type域：记录着逻辑闹钟的闹钟类型，比如RTC_WAKEUP、ELAPSED_REALTIME_WAKEUP等；</p>
<p>count域：是个辅助域，它和repeatInterval域一起工作。当repeatInterval大于0时，这个域可被用于计算下一次重复激发alarm的时间。</p>
<p>when域：记录闹钟的激发时间。这个域和type域相关，详细情况见后文；</p>
<p>repeatInterval域：表示重复激发闹钟的时间间隔，如果闹钟只需激发一次，则此域为0，如果闹钟需要重复激发，此域为以毫秒为单位的时间间隔；</p>
<p>operation域：记录闹钟激发时应该执行的动作，详细情况见后文；</p>
<p>uid域：记录设置闹钟的进程的uid；</p>
<p>pid域：记录设置闹钟的进程的pid。</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2017/05/13/Permission第 2 篇 - PackageManager 对权限的初始化流程/">Permission第 2 篇 - PackageManager 对权限的初始化流程</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2017-05-13</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/AndroidFramework源码分析/">AndroidFramework源码分析</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/AndroidFramework源码分析/Permission权限管理/">Permission权限管理</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/Permission权限管理/">Permission权限管理</a></span><div class="content"><p>[toc]</p>
<p>基于  Android7.1.1 源码，分析权限管理机制</p>
<h1 id="0-综述"><a href="#0-综述" class="headerlink" title="0 综述"></a>0 综述</h1><p>在分析 PackageManagerService 的时候，我们详细的分析了 PackageManagerService 的启动流程，包括安装信息解析，应用程序包的解析等等！</p>
<p>其中，涉及到了对系统中权限的解析和配置，但是由于 PackageManagerService 的启动流程过于负责，所以在 PackageManagerService 相关文章中，并没有对其进行启动的总结！</p>
<p>本系列文章我们详细的总结下权限相关的内容！</p>
<h1 id="1-添加共享-uid"><a href="#1-添加共享-uid" class="headerlink" title="1 添加共享 uid"></a>1 添加共享 uid</h1><p>在 PMS 启动的开始，创建了 Settings 对象，同时添加了一些系统定义的共享 uid！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mSettings = <span class="keyword">new</span> Settings(mPackages);</span><br><span class="line">mSettings.addSharedUserLPw(<span class="string">"android.uid.system"</span>, Process.SYSTEM_UID,</span><br><span class="line">        ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line">mSettings.addSharedUserLPw(<span class="string">"android.uid.phone"</span>, RADIO_UID,</span><br><span class="line">        ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line">mSettings.addSharedUserLPw(<span class="string">"android.uid.log"</span>, LOG_UID,</span><br><span class="line">        ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line">mSettings.addSharedUserLPw(<span class="string">"android.uid.nfc"</span>, NFC_UID,</span><br><span class="line">        ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line">mSettings.addSharedUserLPw(<span class="string">"android.uid.bluetooth"</span>, BLUETOOTH_UID,</span><br><span class="line">        ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br><span class="line">mSettings.addSharedUserLPw(<span class="string">"android.uid.shell"</span>, SHELL_UID,</span><br><span class="line">        ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);</span><br></pre></td></tr></table></figure>
<p>addSharedUserLPw 方法会创建 SharedUserSetting 对象，保存到 Settings.mSharedUsers 中！</p>
<p>同时也会根据 uid 的取值添加到 Settings.mUserIds 或者 Settings.mOtherUserIds 中，取值判断的依据是：uid &gt;= Process.FIRST_APPLICATION_UID ()！</p>
<ul>
<li>如果是应用程序的 uid，会被添加到 mUserIds 中！</li>
<li>如果是系统服务/进程的 uid，会被添加到 mOtherUserIds 中！</li>
</ul>
<p>因为，这里添加的 5 种共享 uid 都是系统定义的，所以会添加到 Settings.mOtherUserIds 中！</p>
<h1 id="2-解析系统配置信息"><a href="#2-解析系统配置信息" class="headerlink" title="2 解析系统配置信息"></a>2 解析系统配置信息</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SystemConfig systemConfig = SystemConfig.getInstance();</span><br><span class="line">mGlobalGids = systemConfig.getGlobalGids();</span><br><span class="line">mSystemPermissions = systemConfig.getSystemPermissions();</span><br><span class="line">mAvailableFeatures = systemConfig.getAvailableFeatures();</span><br></pre></td></tr></table></figure>
<p>这个过程会解析以下目录中的文件：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/etc/sysconfig：ALLOW_ALL</span><br><span class="line">/etc/permissions：ALLOW_ALL</span><br><span class="line">/odm/etc/sysconfig：ALLOW_LIBS | ALLOW_FEATURES | ALLOW_APP_CONFIGS</span><br><span class="line">/odm/etc/permissions：ALLOW_LIBS | ALLOW_FEATURES | ALLOW_APP_CONFIGS</span><br><span class="line">/oem/etc/sysconfig：ALLOW_FEATURES</span><br><span class="line">/oem/etc/permissions：ALLOW_FEATURES</span><br></pre></td></tr></table></figure>
<p>可以看到，和权限相关的目录是：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/etc/sysconfig：ALLOW_ALL</span><br><span class="line">/etc/permissions：ALLOW_ALL</span><br></pre></td></tr></table></figure>
<p>在解析过程中 etc/permissions/platform.xml 文件是被放到了最后处理！</p>
<p>在这个过程中会解析以下和权限相关的属性，我们来看下 platform.xml 文件中和权限相关的内容！</p>
<h2 id="2-1-解析-“group”"><a href="#2-1-解析-“group”" class="headerlink" title="2.1 解析 “group”"></a>2.1 解析 “group”</h2><p>获得系统中的一些特定的 gid，这些 gid 会和系统权限相互映射：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;permission name=<span class="string">"android.permission.BLUETOOTH_STACK"</span> &gt;</span><br><span class="line">    &lt;group gid=<span class="string">"bluetooth"</span> /&gt;</span><br><span class="line">    &lt;group gid=<span class="string">"wakelock"</span> /&gt;</span><br><span class="line">    &lt;group gid=<span class="string">"uhid"</span> /&gt;</span><br><span class="line">&lt;/permission&gt;</span><br></pre></td></tr></table></figure>
<p>group 标签不能单独使用，要和 permission 配合使用！</p>
<p>SystemConfig  会通过 android.os.Process.getGidForName 方法获得字符串 group 对应的 int 值！</p>
<p>getGidForName 是一个 native 方法，它的实际定义是 frameworks/base/core/jni/android_util_Process.cpp 中</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">jint <span class="title">android_os_Process_getGidForName</span><span class="params">(JNIEnv* env, jobject clazz, jstring name)</span> </span>&#123;</span><br><span class="line">    ......    </span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">size_t</span> N = name8.size();</span><br><span class="line">    <span class="keyword">if</span> (N &gt; <span class="number">0</span>) &#123; </span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span>* str = name8.<span class="built_in">string</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">size_t</span> i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (str[i] &lt; <span class="string">'0'</span> || str[i] &gt; <span class="string">'9'</span>) &#123;</span><br><span class="line">                <span class="class"><span class="keyword">struct</span> <span class="title">group</span>* <span class="title">grp</span> = <span class="title">getgrnam</span>(<span class="title">str</span>);</span></span><br><span class="line">                <span class="keyword">if</span> (grp == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">                &#125;    </span><br><span class="line">                <span class="keyword">return</span> grp-&gt;gr_gid;</span><br><span class="line">            &#125;    </span><br><span class="line">        &#125;    </span><br><span class="line">        <span class="keyword">return</span> atoi(str);</span><br><span class="line">    &#125;    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里根据 groupName 调用 getgrnam 获取组信息。我们知道，getgrnam 是一个 C 库函数，在 Linux 中标准定义是根据读取 /etc/group 文件获取组信息，但在 Android 中并没有这个文件，那么这个函数是怎么实现的呢？</p>
<p>该函数是定义在 bionic/libc/bionic/stubs.cpp 文件中，这里我们只关注主要的代码：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"private/android_filesystem_config.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> group* <span class="title">android_iinfo_to_group</span><span class="params">(group* gr, <span class="keyword">const</span> android_id_info* iinfo)</span> </span>&#123;</span><br><span class="line">  gr-&gt;gr_name   = (<span class="keyword">char</span>*) iinfo-&gt;name;</span><br><span class="line">  gr-&gt;gr_gid    = iinfo-&gt;aid;</span><br><span class="line">  gr-&gt;gr_mem[<span class="number">0</span>] = gr-&gt;gr_name;</span><br><span class="line">  gr-&gt;gr_mem[<span class="number">1</span>] = <span class="literal">NULL</span>;</span><br><span class="line">  <span class="keyword">return</span> gr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> group* <span class="title">android_name_to_group</span><span class="params">(group* gr, <span class="keyword">const</span> <span class="keyword">char</span>* name)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">size_t</span> n = <span class="number">0</span>; n &lt; android_id_count; ++n) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(android_ids[n].name, name)) &#123;</span><br><span class="line">      <span class="keyword">return</span> android_iinfo_to_group(gr, android_ids + n);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">group* <span class="title">getgrnam</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* name)</span> </span>&#123; <span class="comment">// NOLINT: implementing bad function.</span></span><br><span class="line">  <span class="keyword">stubs_state_t</span>* state = __stubs_state();</span><br><span class="line">  <span class="keyword">if</span> (state == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (android_name_to_group(&amp;state-&gt;group_, name) != <span class="number">0</span>) &#123;                         </span><br><span class="line">    <span class="keyword">return</span> &amp;state-&gt;group_;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> app_id_to_group(app_id_from_name(name), state);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>显而易见，它是遍历 android_ids 数组，查找是否有对应的组。那么 android_ids 定义在那里呢？</p>
<p>在 system\core\include\private\android_filesystem_config.h 文件中：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">android_id_info</span> <span class="title">android_ids</span>[] = &#123;</span></span><br><span class="line">    &#123; <span class="string">"root"</span>,          AID_ROOT, &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; <span class="string">"system"</span>,        AID_SYSTEM, &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; <span class="string">"radio"</span>,         AID_RADIO, &#125;,</span><br><span class="line">    &#123; <span class="string">"bluetooth"</span>,     AID_BLUETOOTH, &#125;,</span><br><span class="line">    &#123; <span class="string">"graphics"</span>,      AID_GRAPHICS, &#125;,</span><br><span class="line">    &#123; <span class="string">"input"</span>,         AID_INPUT, &#125;,</span><br><span class="line">    &#123; <span class="string">"audio"</span>,         AID_AUDIO, &#125;,</span><br><span class="line">    ... ... ...</span><br><span class="line">    &#123; <span class="string">"everybody"</span>,     AID_EVERYBODY, &#125;,</span><br><span class="line">    &#123; <span class="string">"misc"</span>,          AID_MISC, &#125;,</span><br><span class="line">    &#123; <span class="string">"nobody"</span>,        AID_NOBODY, &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>可以看到 android_ids 定义了 uid 的字符串名称和对应的 int 值的映射，AID_XXXX 用于指定其对应的 uid/gid：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#define AID_ROOT             0  /* traditional unix root user */</span><br><span class="line"></span><br><span class="line">#define AID_SYSTEM        1000  /* system server */</span><br><span class="line"></span><br><span class="line">#define AID_RADIO         1001  /* telephony subsystem, RIL */</span><br><span class="line">#define AID_BLUETOOTH     1002  /* bluetooth subsystem */</span><br><span class="line">#define AID_GRAPHICS      1003  /* graphics devices */</span><br><span class="line">#define AID_INPUT         1004  /* input devices */</span><br><span class="line">#define AID_AUDIO         1005  /* audio devices */</span><br><span class="line">... ... .. ...</span><br></pre></td></tr></table></figure>
<p>关于 android_filesystem_config.h 中的相关内容，我们后面再分析！</p>
<p>SystemConfig  会将解析到的这些全局特定的 gid 保存到 SystemConfig.mGlobalGids 中！</p>
<h2 id="2-2-解析-“permission”"><a href="#2-2-解析-“permission”" class="headerlink" title="2.2 解析 “permission”"></a>2.2 解析 “permission”</h2><p>获得系统权限和所属的 gid：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">permissions</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--解析 permission 标签--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">permission</span> <span class="attr">name</span>=<span class="string">"android.permission.BLUETOOTH_ADMIN"</span> &gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">group</span> <span class="attr">gid</span>=<span class="string">"net_bt_admin"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">permission</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">permissions</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>下面是解析过程：</p>
<ul>
<li>创建一个 PermissionEntry 对象，用于封装解析到的权限信息！</li>
<li>解析 perUser 属性；</li>
<li>解析获得该权限映射的 gid，依然是调用了 Process.getGidForName 方法，保存到 PermissionEntry.gids 中！</li>
</ul>
<p>最后，将解析的数据会被保存到 Settings.mPermissions 中！</p>
<h2 id="2-3-解析-“assign-permission”"><a href="#2-3-解析-“assign-permission”" class="headerlink" title="2.3 解析 “assign-permission”"></a>2.3 解析 “assign-permission”</h2><p>给特定的 uid 分配指定的权限！ </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">assign-permission</span> <span class="attr">name</span>=<span class="string">"android.permission.MODIFY_AUDIO_SETTINGS"</span> <span class="attr">uid</span>=<span class="string">"media"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">assign-permission</span> <span class="attr">name</span>=<span class="string">"android.permission.ACCESS_SURFACE_FLINGER"</span> <span class="attr">uid</span>=<span class="string">"media"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">assign-permission</span> <span class="attr">name</span>=<span class="string">"android.permission.WAKE_LOCK"</span> <span class="attr">uid</span>=<span class="string">"media"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>assign-permission 标签用于给那些运行在特定的 uid 下的，没有对于 package 文件的系统进程赋予更高层次的权限，比如 MediaSever 守护进程！</p>
<p>下面是解析过程：</p>
<ul>
<li>调用 Process.getUidForName 获得字符串 uid 对应的 int 值，Process.getUidForName 方法最终还是调用的前面的 getgrnam 方法！</li>
</ul>
<p>最后，将解析的数据会被保存到 Settings.mSystemPermissions 中！</p>
<h2 id="2-4-数据同步"><a href="#2-4-数据同步" class="headerlink" title="2.4 数据同步"></a>2.4 数据同步</h2><p>SystemConfig  在解析完成后，会将 Settings.mSystemPermissions 和 SystemConfig.mGlobalGids 的数据同步保存到 PMS 的集合中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mGlobalGids = systemConfig.getGlobalGids();</span><br><span class="line">mSystemPermissions = systemConfig.getSystemPermissions();</span><br></pre></td></tr></table></figure>
<h1 id="3-添加配置信息中的系统权限"><a href="#3-添加配置信息中的系统权限" class="headerlink" title="3 添加配置信息中的系统权限"></a>3 添加配置信息中的系统权限</h1><p>SystemConfig 在解析完了系统配置的权限和 gid 映射关系，同时我们也得到了一些系统的权限，这里会将这些权限添加到 mSettings.mPermissions 中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">ArrayMap&lt;String, SystemConfig.PermissionEntry&gt; permConfig</span><br><span class="line">        = systemConfig.getPermissions();</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i&lt; permConfig.size(); i++) &#123;</span><br><span class="line">    SystemConfig.PermissionEntry perm = permConfig.valueAt(i);</span><br><span class="line">    BasePermission bp = mSettings.mPermissions.get(perm.name);</span><br><span class="line">    <span class="keyword">if</span> (bp == <span class="keyword">null</span>) &#123;</span><br><span class="line">        bp = <span class="keyword">new</span> BasePermission(perm.name, <span class="string">"android"</span>, BasePermission.TYPE_BUILTIN);</span><br><span class="line">        <span class="comment">// 将这些系统权限添加到 Settings.mPermissions 中！</span></span><br><span class="line">        mSettings.mPermissions.put(perm.name, bp);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (perm.gids != <span class="keyword">null</span>) &#123;</span><br><span class="line">        bp.setGids(perm.gids, perm.perUser);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里会创建 BasePermission 实例，指定权限定义者包名为 android，权限类型为 BasePermission.TYPE_BUILTIN！</p>
<p>如果该系统权限有映射特定的 gid，将其添加到 BasePermission.gids 中！</p>
<h1 id="4-读取上一次的安装信息"><a href="#4-读取上一次的安装信息" class="headerlink" title="4 读取上一次的安装信息"></a>4 读取上一次的安装信息</h1><p>接下来，Settings 会从 Packages.xml 中读取上一次安装的信息！</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">packages</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span> <span class="attr">sdkVersion</span>=<span class="string">"27"</span> <span class="attr">databaseVersion</span>=<span class="string">"3"</span> <span class="attr">fingerprint</span>=<span class="string">"../release-keys"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span> <span class="attr">volumeUuid</span>=<span class="string">"primary_physical"</span> <span class="attr">sdkVersion</span>=<span class="string">"27"</span> <span class="attr">databaseVersion</span>=<span class="string">"27"</span></span></span><br><span class="line"><span class="tag">             <span class="attr">fingerprint</span>=<span class="string">".../release-keys"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">permission-trees</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">permissions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.REAL_GET_TASKS"</span> <span class="attr">package</span>=<span class="string">"android"</span> <span class="attr">protection</span>=<span class="string">"18"</span> /&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- ... ... ...--&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">permissions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">"com.android.providers.calendar"</span> <span class="attr">codePath</span>=<span class="string">"/system/priv-app/CalendarProvider"</span> </span></span><br><span class="line"><span class="tag">                    <span class="attr">nativeLibraryPath</span>=<span class="string">"/system/priv-app/CalendarProvider/lib"</span> </span></span><br><span class="line"><span class="tag">					<span class="attr">primaryCpuAbi</span>=<span class="string">"armeabi-v7a"</span> <span class="attr">publicFlags</span>=<span class="string">"940064325"</span> <span class="attr">privateFlags</span>=<span class="string">"8"</span> </span></span><br><span class="line"><span class="tag">					<span class="attr">ft</span>=<span class="string">"1624a4dcee0"</span> <span class="attr">it</span>=<span class="string">"1624a4dcee0"</span> <span class="attr">ut</span>=<span class="string">"1624a4dcee0"</span></span></span><br><span class="line"><span class="tag">					<span class="attr">version</span>=<span class="string">"0"</span> <span class="attr">sharedUserId</span>=<span class="string">"10006"</span> <span class="attr">isOrphaned</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">sigs</span> <span class="attr">count</span>=<span class="string">"1"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">cert</span> <span class="attr">index</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">sigs</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">perms</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.WRITE_SETTINGS"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">			<span class="comment">&lt;!-- ... ... ...--&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">perms</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">proper-signing-keyset</span> <span class="attr">identifier</span>=<span class="string">"1"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">package</span>&gt;</span></span><br><span class="line">    ... ... ... ..</span><br><span class="line">    <span class="tag">&lt;<span class="name">shared-user</span> <span class="attr">name</span>=<span class="string">"android.uid.bluetooth"</span> <span class="attr">userId</span>=<span class="string">"1002"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">sigs</span> <span class="attr">count</span>=<span class="string">"1"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">cert</span> <span class="attr">index</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">sigs</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">perms</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.REAL_GET_TASKS"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">			<span class="comment">&lt;!-- ... ... --&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">perms</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">shared-user</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;/<span class="name">packages</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>上面这个 xml 文件显示了 packages.xml 中的文件结构，可以看到，他们会有一个解析的顺序！</p>
<p>这个过程会会解析获得很多数据，这里我们只关注和权限相关的数据！</p>
<h2 id="4-1-解析-“permissions”-和-“permission-trees”"><a href="#4-1-解析-“permissions”-和-“permission-trees”" class="headerlink" title="4.1 解析 “permissions” 和 “permission-trees”"></a>4.1 解析 “permissions” 和 “permission-trees”</h2><p>首先会解析 permission-trees 的内容，然后在解析 permissions 的内容，其保存了上一次安装时的系统和应用定义的所有的权限信息：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">permissions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.REAL_GET_TASKS"</span> <span class="attr">package</span>=<span class="string">"android"</span> <span class="attr">protection</span>=<span class="string">"18"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.SEND_RECEIVE_STK_INTENT"</span> <span class="attr">package</span>=<span class="string">"com.android.stk"</span> <span class="attr">protection</span>=<span class="string">"2"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.ACCESS_CACHE_FILESYSTEM"</span> <span class="attr">package</span>=<span class="string">"android"</span> <span class="attr">protection</span>=<span class="string">"18"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.REMOTE_AUDIO_PLAYBACK"</span> <span class="attr">package</span>=<span class="string">"android"</span> <span class="attr">protection</span>=<span class="string">"2"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.DOWNLOAD_WITHOUT_NOTIFICATION"</span> <span class="attr">package</span>=<span class="string">"com.android.providers.downloads"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.REGISTER_WINDOW_MANAGER_LISTENERS"</span> <span class="attr">package</span>=<span class="string">"android"</span> <span class="attr">protection</span>=<span class="string">"2"</span> /&gt;</span></span><br><span class="line">    ... ... ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">permissions</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>permissions 标签中保存的是非动态权限信息，permission-trees 中保存的是动态权限信息。</p>
<p>对于非动态权限和动态权限树，会有不同的处理：</p>
<ul>
<li><p>非动态权限信息最终都会被解析保存到 Setting.mPermissions 中了！！</p>
</li>
<li><p>动态权限信息会被保存在 Setting.mPermissionTrees 中了！！</p>
</li>
</ul>
<p><br></p>
<p>整个解析过程如下：</p>
<ul>
<li>解析获得权限名 name，权限的定义包名 package，权限类型 type，以及权限的保护级别 protection 并对其修正；<ul>
<li>修正就是为了保证附加标志位只能和基本权限类型 signiture 一起使用；  </li>
</ul>
</li>
</ul>
<p><br></p>
<ul>
<li>尝试从 Setttings 的权限集合中获得对应的权限对象 BasePermission <ul>
<li>如果为 null 就会创建新的 BasePermission 对象；</li>
<li>如果已有对应的 BasePermission 对象，但是其 type 不是 BasePermission.TYPE_BUILTIN，也会创建新的 BasePermission 对象 ！</li>
</ul>
</li>
</ul>
<p><br></p>
<ul>
<li>判断权限是不是动态权限：<ul>
<li>权限类型 type 是否是 dynamic，如果是，权限类型为 BasePermission.TYPE_DYNAMIC，不是就是 BasePermission.TYPE_NORMAL；</li>
<li>如果是非动态权限，就直接添加到 Setting.mPermissions 中；</li>
<li>如果是动态权限，会在创建一个 PermissionInfo 对象，封装所属权限树的信息，再添加到 Setting.mPermissionTrees 中；</li>
</ul>
</li>
</ul>
<h2 id="4-2-解析-“package”"><a href="#4-2-解析-“package”" class="headerlink" title="4.2 解析 “package”"></a>4.2 解析 “package”</h2><p>接着是解析 package 信息，主要是调用 readPackageLPw 方法！</p>
<h3 id="4-2-1-Settings-readPackageLPw"><a href="#4-2-1-Settings-readPackageLPw" class="headerlink" title="4.2.1 Settings.readPackageLPw"></a>4.2.1 Settings.readPackageLPw</h3><p>对于 readPackageLPw 方法，我们在 PMS 的启动流程中有详细分析，这里我们只关注和权限相关的代码！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readPackageLPw</span><span class="params">(XmlPullParser parser)</span> <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</span><br><span class="line">    ... ... ... ...</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【1】获得应用的 name！</span></span><br><span class="line">        name = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_NAME);</span><br><span class="line">        realName = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"realName"</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【2】获得 userId 和 sharedId 的名称, userId 和 sharedIdStr 不能同时存在！</span></span><br><span class="line">        idStr = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"userId"</span>);</span><br><span class="line">        uidError = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"uidError"</span>);</span><br><span class="line">        sharedIdStr = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"sharedUserId"</span>);</span><br><span class="line">        </span><br><span class="line">        ... ... ...</span><br><span class="line">                    </span><br><span class="line">        <span class="comment">//【3】获得 userId 的 int 值，如果 AndroidManifest.xml 有设置 android:sharedUserId 属性，</span></span><br><span class="line">        <span class="comment">// 那么应用的 userId 就为 0！！</span></span><br><span class="line">        <span class="keyword">int</span> userId = idStr != <span class="keyword">null</span> ? Integer.parseInt(idStr) : <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (resourcePathStr == <span class="keyword">null</span>) &#123;</span><br><span class="line">            resourcePathStr = codePathStr;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (realName != <span class="keyword">null</span>) &#123;</span><br><span class="line">            realName = realName.intern();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (name == <span class="keyword">null</span>) &#123;</span><br><span class="line">            PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                    <span class="string">"Error in package manager settings: &lt;package&gt; has no name at "</span></span><br><span class="line">                            + parser.getPositionDescription());</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (codePathStr == <span class="keyword">null</span>) &#123;</span><br><span class="line">            PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                    <span class="string">"Error in package manager settings: &lt;package&gt; has no codePath at "</span></span><br><span class="line">                            + parser.getPositionDescription());</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (userId &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//【3.1】如果 userId 大于0，说明 package 是独立用户 id</span></span><br><span class="line">            <span class="comment">// 调用 addPackageLPw 方法保存这个有独立的 Linux 用户 ID 的 Package!</span></span><br><span class="line">            packageSetting = addPackageLPw(name.intern(), realName, <span class="keyword">new</span> File(codePathStr),</span><br><span class="line">                    <span class="keyword">new</span> File(resourcePathStr), legacyNativeLibraryPathStr, primaryCpuAbiString,</span><br><span class="line">                    secondaryCpuAbiString, cpuAbiOverrideString, userId, versionCode, pkgFlags,</span><br><span class="line">                    pkgPrivateFlags, parentPackageName, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (PackageManagerService.DEBUG_SETTINGS)</span><br><span class="line">                Log.i(PackageManagerService.TAG, <span class="string">"Reading package "</span> + name + <span class="string">": userId="</span></span><br><span class="line">                        + userId + <span class="string">" pkg="</span> + packageSetting);</span><br><span class="line">            <span class="keyword">if</span> (packageSetting == <span class="keyword">null</span>) &#123;</span><br><span class="line">                PackageManagerService.reportSettingsProblem(Log.ERROR, <span class="string">"Failure adding uid "</span></span><br><span class="line">                        + userId + <span class="string">" while parsing settings at "</span></span><br><span class="line">                        + parser.getPositionDescription());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 设置时间戳，第一次安装时间，最近更新时间</span></span><br><span class="line">                packageSetting.setTimeStamp(timeStamp);</span><br><span class="line">                packageSetting.firstInstallTime = firstInstallTime;</span><br><span class="line">                packageSetting.lastUpdateTime = lastUpdateTime;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sharedIdStr != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//【3.2】sharedIdStr 不为 null，说明 package 设置了共享用户 id！</span></span><br><span class="line">            userId = sharedIdStr != <span class="keyword">null</span> ? Integer.parseInt(sharedIdStr) : <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> (userId &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// 对于共享用户 ID 这种情况，还需要验证其有效性!</span></span><br><span class="line">                <span class="comment">// 创建一个 PendingPackage 对象，来封装这个有共享用户 ID 的 package 的信息!</span></span><br><span class="line">                packageSetting = <span class="keyword">new</span> PendingPackage(name.intern(), realName, <span class="keyword">new</span> File(</span><br><span class="line">                        codePathStr), <span class="keyword">new</span> File(resourcePathStr), legacyNativeLibraryPathStr,</span><br><span class="line">                        primaryCpuAbiString, secondaryCpuAbiString, cpuAbiOverrideString,</span><br><span class="line">                        userId, versionCode, pkgFlags, pkgPrivateFlags, parentPackageName,</span><br><span class="line">                        <span class="keyword">null</span>);</span><br><span class="line">                   </span><br><span class="line">                <span class="comment">// 设置时间戳，第一次安装时间，最近更新时间！     </span></span><br><span class="line">                packageSetting.setTimeStamp(timeStamp);</span><br><span class="line">                packageSetting.firstInstallTime = firstInstallTime;</span><br><span class="line">                packageSetting.lastUpdateTime = lastUpdateTime;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">//【3.2.1】添加到 mPendingPackages 中，因为后续需要确定 shareUserId 的有效性！</span></span><br><span class="line">                mPendingPackages.add((PendingPackage) packageSetting);</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (PackageManagerService.DEBUG_SETTINGS)</span><br><span class="line">                    Log.i(PackageManagerService.TAG, <span class="string">"Reading package "</span> + name</span><br><span class="line">                            + <span class="string">": sharedUserId="</span> + userId + <span class="string">" pkg="</span> + packageSetting);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                        <span class="string">"Error in package manager settings: package "</span> + name</span><br><span class="line">                                + <span class="string">" has bad sharedId "</span> + sharedIdStr + <span class="string">" at "</span></span><br><span class="line">                                + parser.getPositionDescription());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                    <span class="string">"Error in package manager settings: package "</span> + name + <span class="string">" has bad userId "</span></span><br><span class="line">                            + idStr + <span class="string">" at "</span> + parser.getPositionDescription());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">        PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                <span class="string">"Error in package manager settings: package "</span> + name + <span class="string">" has bad userId "</span></span><br><span class="line">                        + idStr + <span class="string">" at "</span> + parser.getPositionDescription());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【4】接下解析和设置其他属性。</span></span><br><span class="line">    <span class="keyword">if</span> (packageSetting != <span class="keyword">null</span>) &#123;</span><br><span class="line">        ... ... ...</span><br><span class="line">        <span class="keyword">int</span> outerDepth = parser.getDepth();</span><br><span class="line">        <span class="keyword">int</span> type;</span><br><span class="line">        <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">                &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            String tagName = parser.getName();</span><br><span class="line">            <span class="comment">// Legacy</span></span><br><span class="line">            <span class="keyword">if</span> (tagName.equals(TAG_DISABLED_COMPONENTS)) &#123;</span><br><span class="line">                readDisabledComponentsLPw(packageSetting, parser, <span class="number">0</span>);</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_ENABLED_COMPONENTS)) &#123;</span><br><span class="line">                readEnabledComponentsLPw(packageSetting, parser, <span class="number">0</span>);</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"sigs"</span>)) &#123; <span class="comment">// 解析 "sigs"</span></span><br><span class="line">                packageSetting.signatures.readXml(parser, mPastSignatures);</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_PERMISSIONS)) &#123; </span><br><span class="line">                <span class="comment">//【4.2】解析 "perms" </span></span><br><span class="line">                readInstallPermissionsLPr(parser, packageSetting.getPermissionsState());</span><br><span class="line">                packageSetting.installPermissionsFixed = <span class="keyword">true</span>;</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"proper-signing-keyset"</span>)) &#123;</span><br><span class="line">            ... ... ...</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        XmlUtils.skipCurrentTag(parser);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>流程总结：</p>
<ul>
<li>对于分配了独立的 uid 的 package，创建 PackageSetting 对象，添加到 mPackage 中，并且将自身和 uid 的引用关心保存到 mUsersId 或者 mOthersId 中；</li>
<li>对于分配了共享的 uid 的 package，创建 PendingPackage 对象，添加到 mPendingPackages 中，后续会对其共享 uid 的有效性进行校验！</li>
</ul>
<p>在解析过程中，会判断 package 是否是共享 uid 的！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">idStr = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"userId"</span>);</span><br><span class="line">uidError = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"uidError"</span>);</span><br><span class="line">sharedIdStr = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"sharedUserId"</span>);</span><br></pre></td></tr></table></figure>
<p>userId 和 sharedUserId 只能存在一个，如果 package 有 sharedUserId，那么 userId 会被设置为 0；</p>
<ul>
<li>如果 package 是独立 userId ，那么会立刻创建对应的 PackageSettings 对象！然后会调用 addPackageLPw 方法，将其添加到 Settings.mPackages 中！<ul>
<li>同时也会调用 addUserIdLPw 方法，将该 PackageSettings 添加到 Settings.mUserIds/Settings.mOtherUserIds 中，取决于 uid 的范围！</li>
</ul>
</li>
</ul>
<p><br></p>
<ul>
<li>如果 package 是共享 userId，这里会临时创建一个 PendingPackage 对象，添加到 Settings.mPendingPackages 中，因为共享 userId 的有效性没有确定！</li>
</ul>
<h3 id="4-2-1-解析-“perms”-子标签-安装时权限"><a href="#4-2-1-解析-“perms”-子标签-安装时权限" class="headerlink" title="4.2.1 解析 “perms” 子标签 - 安装时权限"></a>4.2.1 解析 “perms” 子标签 - 安装时权限</h3><p>对于上一次安装信息，package 的 perms 子标签保存了该 package 申请的安装时权限，注意是<strong>安装时权限</strong>！</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">perms</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.REAL_GET_TASKS"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.RECEIVE_BOOT_COMPLETED"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.INTERNET"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.ACCESS_NETWORK_STATE"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">perms</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>运行时权限在另外的地方保存，我们后面再看！</p>
<p>接着是解析 package 的安装时权限信息，主要是调用 readInstallPermissionsLPr 方法！</p>
<h4 id="4-2-1-1-Settings-readInstallPermissionsLPr"><a href="#4-2-1-1-Settings-readInstallPermissionsLPr" class="headerlink" title="4.2.1.1 Settings.readInstallPermissionsLPr"></a>4.2.1.1 Settings.readInstallPermissionsLPr</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">readInstallPermissionsLPr</span><span class="params">(XmlPullParser parser, PermissionsState permissionsState)</span> </span></span><br><span class="line"><span class="function">                                                    <span class="keyword">throws</span> IOException, XmlPullParserException </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> outerDepth = parser.getDepth();</span><br><span class="line">    <span class="keyword">int</span> type;</span><br><span class="line">    <span class="keyword">while</span> ((type=parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">            &amp;&amp; (type != XmlPullParser.END_TAG</span><br><span class="line">            || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == XmlPullParser.END_TAG</span><br><span class="line">                || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        String tagName = parser.getName();</span><br><span class="line">        <span class="keyword">if</span> (tagName.equals(TAG_ITEM)) &#123; <span class="comment">// 解析 "item"</span></span><br><span class="line">            String name = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_NAME); <span class="comment">// 接续 "name"，权限名称！</span></span><br><span class="line">            <span class="comment">//【1】从之前解析的 Settings.mPermissions 获得对应的权限，如果没有，就跳过；</span></span><br><span class="line">            BasePermission bp = mPermissions.get(name);</span><br><span class="line">            <span class="keyword">if</span> (bp == <span class="keyword">null</span>) &#123;</span><br><span class="line">                Slog.w(PackageManagerService.TAG, <span class="string">"Unknown permission: "</span> + name);</span><br><span class="line">                XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【2】解析 "granted" 标签，获得授予情况！</span></span><br><span class="line">            String grantedStr = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_GRANTED);</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> granted = grantedStr == <span class="keyword">null</span></span><br><span class="line">                    || Boolean.parseBoolean(grantedStr);</span><br><span class="line">            <span class="comment">// 解析 "flags"标签</span></span><br><span class="line">            String flagsStr = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_FLAGS);</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> flags = (flagsStr != <span class="keyword">null</span>)</span><br><span class="line">                    ? Integer.parseInt(flagsStr, <span class="number">16</span>) : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【3】处理权限授予的操作！</span></span><br><span class="line">            <span class="keyword">if</span> (granted) &#123; </span><br><span class="line">                <span class="comment">//【9.1】处理默认授予的情况！</span></span><br><span class="line">                <span class="keyword">if</span> (permissionsState.grantInstallPermission(bp) ==</span><br><span class="line">                        PermissionsState.PERMISSION_OPERATION_FAILURE) &#123;</span><br><span class="line">                    Slog.w(PackageManagerService.TAG, <span class="string">"Permission already added: "</span> + name);</span><br><span class="line">                    XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    permissionsState.updatePermissionFlags(bp, UserHandle.USER_ALL,</span><br><span class="line">                            PackageManager.MASK_PERMISSION_FLAGS, flags);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">                <span class="comment">//【9.2】处理默认不授予的情况！</span></span><br><span class="line">                <span class="keyword">if</span> (permissionsState.revokeInstallPermission(bp) ==</span><br><span class="line">                        PermissionsState.PERMISSION_OPERATION_FAILURE) &#123;</span><br><span class="line">                    Slog.w(PackageManagerService.TAG, <span class="string">"Permission already added: "</span> + name);</span><br><span class="line">                    XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//【9.3】更新应用权限信息！</span></span><br><span class="line">                    permissionsState.updatePermissionFlags(bp, UserHandle.USER_ALL,</span><br><span class="line">                            PackageManager.MASK_PERMISSION_FLAGS, flags);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Slog.w(PackageManagerService.TAG, <span class="string">"Unknown element under &lt;permissions&gt;: "</span></span><br><span class="line">                    + parser.getName());</span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里解析到的权限授予信息会保存到 PermissionsState 对象中！</p>
<ul>
<li>首先会判断 Settings.mPermissions 中是否有对应的权限，如果没有，就会忽略掉该安装时权限的授予！</li>
<li>解析授予状态 granted，值为 true，因为是安装时权限，解析权限的授予标志位信息 flags；</li>
<li>接着处理安装时权限的授予情况！</li>
</ul>
<p></p>
<p>PermissionsState permissionsState 用于保存该 package 的权限状态信息，通过 packageSetting.getPermissionsState() 方法获得，如果应用是独立的 uid，那么该方法返回的是自身的 PermissionsState，如果是共享 uid，返回的是 ShareUserId 的 PermissionsState！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> PermissionsState <span class="title">getPermissionsState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (sharedUser != <span class="keyword">null</span>)</span><br><span class="line">            ? sharedUser.getPermissionsState()</span><br><span class="line">            : <span class="keyword">super</span>.getPermissionsState();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>PermissionsState 内部有一个 mPermissions 哈希表，key 为权限 name，value 为 PermissionData，PermissionData 用于保存权限的授予情况；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> ArrayMap&lt;String, PermissionData&gt; mPermissions;</span><br></pre></td></tr></table></figure>
<p>接着是处理安装时权限的授予情况：</p>
<h5 id="4-2-1-1-1-PermissionsS-grantInstallPermission"><a href="#4-2-1-1-1-PermissionsS-grantInstallPermission" class="headerlink" title="4.2.1.1.1 PermissionsS.grantInstallPermission"></a>4.2.1.1.1 PermissionsS.grantInstallPermission</h5><p>permissionsState.grantInstallPermission 方法用于授予安装时权限：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">grantPermission</span><span class="params">(BasePermission permission, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//【9.1.1】如果之前有权限，本次授予失败！</span></span><br><span class="line">        <span class="keyword">if</span> (hasPermission(permission.name, userId)) &#123;</span><br><span class="line">            <span class="keyword">return</span> PERMISSION_OPERATION_FAILURE;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【9.1.2】判断权限 BasePermission 在 userId 下是否有映射 gid，如果有，那 hasGids 为 true！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> hasGids = !ArrayUtils.isEmpty(permission.computeGids(userId));</span><br><span class="line">        <span class="comment">//【9.1.3】如果权限 BasePermission 有映射的 gid，那就计算下该 package 的所属的 Gid 组！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span>[] oldGids = hasGids ? computeGids(userId) : NO_GIDS;</span><br><span class="line">        <span class="comment">//【9.1.4】创建权限的 permissionData 对象，并添加到 PermissionState.mPermissions 中！</span></span><br><span class="line">        PermissionData permissionData = ensurePermissionData(permission);</span><br><span class="line">        <span class="comment">//【9.1.5】授予权限！</span></span><br><span class="line">        <span class="keyword">if</span> (!permissionData.grant(userId)) &#123; <span class="comment">// 授权失败，就返回 PERMISSION_OPERATION_FAILURE！</span></span><br><span class="line">            <span class="keyword">return</span> PERMISSION_OPERATION_FAILURE;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【2】如果权限有映射的 gid，在授予权限后，再次计算该 package 的所有映射的 gid！</span></span><br><span class="line">        <span class="comment">// 比较授权前后，gid 组是否发生了变化，如果有，返回 PERMISSION_OPERATION_SUCCESS_GIDS_CHANGED！</span></span><br><span class="line">        <span class="keyword">if</span> (hasGids) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span>[] newGids = computeGids(userId);</span><br><span class="line">            <span class="keyword">if</span> (oldGids.length != newGids.length) &#123;</span><br><span class="line">                <span class="keyword">return</span> PERMISSION_OPERATION_SUCCESS_GIDS_CHANGED;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> PERMISSION_OPERATION_SUCCESS; <span class="comment">// 返回 PERMISSION_OPERATION_SUCCESS！</span></span><br><span class="line">    &#125;</span><br><span class="line">``` </span><br><span class="line">因为是安装时权限，所以传入的 userId 为 UserHandle.USER_ALL！</span><br><span class="line"></span><br><span class="line">hasPermission 方法用于判断该权限是否已经授予权限，如果已经授予，那就返回 **PERMISSION_OPERATION_FAILURE**！</span><br><span class="line"></span><br><span class="line">hasGids 用于判断当前要处理的安装时权限是否有映射的 gid，如果有那个 hasGids 为 <span class="keyword">true</span>！</span><br><span class="line"></span><br><span class="line">如果 hasGids 为 <span class="keyword">true</span>，那就要计算下该 <span class="keyword">package</span> 当前所持有的所有权限的映射的 gid 组！</span><br><span class="line"></span><br><span class="line">接着，创建权限的 permissionData 对象，并添加到 PermissionState.mPermissions 中，key 为权限名！</span><br><span class="line"></span><br><span class="line">permissionData.grant 方法用于设置权限为授予状态：</span><br><span class="line"></span><br><span class="line">PermissionData 内部有一个 SparseArray，保存了该权限在不用 userId 下的授予状态，可以知道，对于安装时权限，由于 userid 为 UserHandle.USER_ALL，所以 mUserStates 只有一条数据：</span><br><span class="line"></span><br><span class="line">```java</span><br><span class="line"><span class="keyword">private</span> SparseArray&lt;PermissionState&gt; mUserStates = <span class="keyword">new</span> SparseArray&lt;&gt;();</span><br></pre></td></tr></table></figure>
<p>如果授予失败，比如该权限已经授予等等，那么会返回 <strong>PERMISSION_OPERATION_FAILURE</strong>！！</p>
<p>如果 hasGids 为 true，那么在授予后，再次计算该 package 当前持有的权限映射的所有 gid，如果 gid 发生了变化，那么返回 <strong>PERMISSION_OPERATION_SUCCESS_GIDS_CHANGED</strong>！</p>
<p>如果 gid 没有发生变化，那么返回 <strong>PERMISSION_OPERATION_SUCCESS</strong>，那么会有发生变化的情况吗？是有的，比如应用程序定义的权限是没有映射 gid 的！</p>
<p>如果返回的是 PERMISSION_OPERATION_SUCCESS 或者 PERMISSION_OPERATION_SUCCESS_GIDS_CHANGED ，那么接下来就会保存标志位信息！</p>
<h5 id="4-2-1-1-2-PermissionsS-revokeInstallPermission"><a href="#4-2-1-1-2-PermissionsS-revokeInstallPermission" class="headerlink" title="4.2.1.1.2 PermissionsS.revokeInstallPermission"></a>4.2.1.1.2 PermissionsS.revokeInstallPermission</h5><p>permissionsState.revokeInstallPermission 方法用于安装时撤销权限！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">revokePermission</span><span class="params">(BasePermission permission, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】如果没有授予该权限，那就返回 PERMISSION_OPERATION_FAILURE！</span></span><br><span class="line">    <span class="keyword">if</span> (!hasPermission(permission.name, userId)) &#123;</span><br><span class="line">        <span class="keyword">return</span> PERMISSION_OPERATION_FAILURE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】同样，计算该权限是否有映射 gid，如果有 gid，计算当前 package 持有的权限映射的所有 gid！</span></span><br><span class="line">    <span class="comment">// 保存到 oldGids 中！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> hasGids = !ArrayUtils.isEmpty(permission.computeGids(userId));</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span>[] oldGids = hasGids ? computeGids(userId) : NO_GIDS;</span><br><span class="line"></span><br><span class="line">    PermissionData permissionData = mPermissions.get(permission.name);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【9.2.1】取消权限的授予！</span></span><br><span class="line">    <span class="keyword">if</span> (!permissionData.revoke(userId)) &#123;</span><br><span class="line">        <span class="keyword">return</span> PERMISSION_OPERATION_FAILURE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【9.2.2】如果该权限在所有设备用户下均没有授予该 package，即 mUserStates.size() &lt;= 0；</span></span><br><span class="line">    <span class="comment">// 那么我们要移除该权限！</span></span><br><span class="line">    <span class="keyword">if</span> (permissionData.isDefault()) &#123;</span><br><span class="line">        ensureNoPermissionData(permission.name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】这里是比较，在撤销安装时权限后，该 package 所持有的权限映射的 gid 是否发生变化！</span></span><br><span class="line">    <span class="comment">// 如果有，返回 PERMISSION_OPERATION_SUCCESS_GIDS_CHANGED！</span></span><br><span class="line">    <span class="keyword">if</span> (hasGids) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span>[] newGids = computeGids(userId);</span><br><span class="line">        <span class="keyword">if</span> (oldGids.length != newGids.length) &#123;</span><br><span class="line">            <span class="keyword">return</span> PERMISSION_OPERATION_SUCCESS_GIDS_CHANGED;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> PERMISSION_OPERATION_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>整个过程和授予很类似，这里不多说！</p>
<h5 id="4-2-1-1-3-PermissionsS-updatePermissionFlags"><a href="#4-2-1-1-3-PermissionsS-updatePermissionFlags" class="headerlink" title="4.2.1.1.3 PermissionsS.updatePermissionFlags"></a>4.2.1.1.3 PermissionsS.updatePermissionFlags</h5><p>如果返回的是 PERMISSION_OPERATION_SUCCESS 或者 PERMISSION_OPERATION_SUCCESS_GIDS_CHANGED ，那么接下来就会保存标志位信息！</p>
<p>参数传递：</p>
<ul>
<li>userId 传入的是 UserHandle.USER_ALL；</li>
<li>flagMask 传入的是 PackageManager.MASK_PERMISSION_FLAGS，取值为 0xFF，转为二进制就是 11111</li>
<li>flagValues 则是解析上次安装信息时，解析该 package 的 perms 标签时，每一个权限的 flags！</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">updatePermissionFlags</span><span class="params">(BasePermission permission, <span class="keyword">int</span> userId,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> flagMask, <span class="keyword">int</span> flagValues)</span> </span>&#123;</span><br><span class="line">    enforceValidUserId(userId);</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> mayChangeFlags = flagValues != <span class="number">0</span> || flagMask != <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】如果 mPermissions 为 null，且需要更新 flags，那么会初始化 mPermissions，将 permission 添加进入！</span></span><br><span class="line">    <span class="keyword">if</span> (mPermissions == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mayChangeFlags) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ensurePermissionData(permission);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】如果该权限 permission 没有对应的 PermissionData，且需要更新 flags，那么我们会创建 PermissionData 添加！</span></span><br><span class="line">    PermissionData permissionData = mPermissions.get(permission.name);</span><br><span class="line">    <span class="keyword">if</span> (permissionData == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mayChangeFlags) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        permissionData = ensurePermissionData(permission);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】获得该权限的旧的 flags，用于对比！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> oldFlags = permissionData.getFlags(userId);</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//【9.3.1】更新权限标志位！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> updated = permissionData.updateFlags(userId, flagMask, flagValues);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【4】如果权限的状态发生了变化，那就判断是否需要重新申请！</span></span><br><span class="line">    <span class="keyword">if</span> (updated) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> newFlags = permissionData.getFlags(userId);</span><br><span class="line">        <span class="keyword">if</span> ((oldFlags &amp; PackageManager.FLAG_PERMISSION_REVIEW_REQUIRED) == <span class="number">0</span></span><br><span class="line">                &amp;&amp; (newFlags &amp; PackageManager.FLAG_PERMISSION_REVIEW_REQUIRED) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mPermissionReviewRequired == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mPermissionReviewRequired = <span class="keyword">new</span> SparseBooleanArray();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【4.1】如果在该 userId 下需要重新申请，那么就将其添加到 mPermissionReviewRequired 中！</span></span><br><span class="line">            mPermissionReviewRequired.put(userId, <span class="keyword">true</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((oldFlags &amp; PackageManager.FLAG_PERMISSION_REVIEW_REQUIRED) != <span class="number">0</span></span><br><span class="line">                &amp;&amp; (newFlags &amp; PackageManager.FLAG_PERMISSION_REVIEW_REQUIRED) == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//【4.2】如果在该 userId 下不需要重新申请，那么就将其从 mPermissionReviewRequired 中移除！</span></span><br><span class="line">            <span class="keyword">if</span> (mPermissionReviewRequired != <span class="keyword">null</span>) &#123;</span><br><span class="line">                mPermissionReviewRequired.delete(userId);</span><br><span class="line">                <span class="keyword">if</span> (mPermissionReviewRequired.size() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    mPermissionReviewRequired = <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> updated;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于 mayChangeFlags，由于我们 flagMask 传入的是 PackageManager.MASK_PERMISSION_FLAGS，那就意味了需要更新 flags！</p>
<p>可以看到，如果 mayChangeFlags 为 true 的话，即使没有权限对应的 PermissionData 也会创建，因为这次会更新 flags！</p>
<p>PermissionData.getFlags 方法会获得权限旧的 flags！</p>
<p>重点的操作在 PermissionData.updateFlag 方法中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">updateFlags</span><span class="params">(<span class="keyword">int</span> userId, <span class="keyword">int</span> flagMask, <span class="keyword">int</span> flagValues)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (isInstallPermission()) &#123;</span><br><span class="line">        <span class="comment">// 如果是安装时权限，那么 userId 为 UserHandle.USER_ALL;</span></span><br><span class="line">        userId = UserHandle.USER_ALL;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!isCompatibleUserId(userId)) &#123;</span><br><span class="line">        <span class="comment">// 如果 userId 不兼容，那么会直接返回！</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【1】这里进行 &amp; 操作，保留了 flagValues 和 flagMask 相同的位！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> newFlags = flagValues &amp; flagMask;</span><br><span class="line">    <span class="comment">//【2】获得该 userId 下的权限状态值！</span></span><br><span class="line">    PermissionState userState = mUserStates.get(userId);</span><br><span class="line">    <span class="keyword">if</span> (userState != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> oldFlags = userState.mFlags;</span><br><span class="line">        <span class="comment">//【2.1】取消旧的 flags，设置新的 flags！</span></span><br><span class="line">        userState.mFlags = (userState.mFlags &amp; ~flagMask) | newFlags;</span><br><span class="line">        <span class="keyword">if</span> (userState.isDefault()) &#123;</span><br><span class="line">            mUserStates.remove(userId);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【2.2】判断 flags 是否发生变化，如果发生了变化，那就返回 true！</span></span><br><span class="line">        <span class="keyword">return</span> userState.mFlags != oldFlags;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (newFlags != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//【2.3】如果该权限在该 userId 下没有状态信息，那就创建状态信息，直接设置新的 flags，返回 true！</span></span><br><span class="line">        userState = <span class="keyword">new</span> PermissionState(mPerm.name);</span><br><span class="line">        userState.mFlags = newFlags;</span><br><span class="line">        mUserStates.put(userId, userState);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里有一个操作：</p>
<ul>
<li>首先，进行 &amp; 操作，保留了 flagValues 和 flagMask 相同的位，为 newFlags；</li>
<li>接着，userState.mFlags 表示旧的 flags，这里在 userState.mFlags 和 ~flagMask 中做了 &amp; 操作，等价于取了 userState.mFlags 和 flagMask 不同的位，然后加上 newFlags，作为新的 flags！</li>
</ul>
<p>结合前面的参数：</p>
<p>flagMask 传入的是 PackageManager.MASK_PERMISSION_FLAGS 每一个位都是 1，userState.mFlags &amp; ~flagMask 操作清空了旧的 flags；flagValues &amp; flagMask 计算得到的标志位 newFlags 就是 flagValues！</p>
<p>其实本质上就是设置标志位为 xml 中解析的值！</p>
<h2 id="4-3-解析-“shared-user”"><a href="#4-3-解析-“shared-user”" class="headerlink" title="4.3 解析 “shared-user”"></a>4.3 解析 “shared-user”</h2><p>共享用户相关数据如下：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">shared-user</span> <span class="attr">name</span>=<span class="string">"android.media"</span> <span class="attr">userId</span>=<span class="string">"10014"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sigs</span> <span class="attr">count</span>=<span class="string">"1"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">cert</span> <span class="attr">index</span>=<span class="string">"3"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">sigs</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">perms</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.WRITE_SETTINGS"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.RECEIVE_BOOT_COMPLETED"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.WRITE_MEDIA_STORAGE"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"0"</span> /&gt;</span></span><br><span class="line">        ... ... </span><br><span class="line">    <span class="tag">&lt;/<span class="name">perms</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">shared-user</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>接下来是解析共享 uid，以及共享 uid 被授予的安装时权限！</p>
<h3 id="4-3-1-Settings-readSharedUserLPw"><a href="#4-3-1-Settings-readSharedUserLPw" class="headerlink" title="4.3.1 Settings.readSharedUserLPw"></a>4.3.1 Settings.readSharedUserLPw</h3><p>解析系统定义的共享用户 id：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readSharedUserLPw</span><span class="params">(XmlPullParser parser)</span> <span class="keyword">throws</span> XmlPullParserException,IOException </span>&#123;</span><br><span class="line">    String name = <span class="keyword">null</span>;</span><br><span class="line">    String idStr = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">int</span> pkgFlags = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> pkgPrivateFlags = <span class="number">0</span>;</span><br><span class="line">    SharedUserSetting su = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        name = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_NAME); <span class="comment">// 获得共享用户的名称</span></span><br><span class="line">        idStr = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"userId"</span>); <span class="comment">// 获得共享用户的id</span></span><br><span class="line">        <span class="keyword">int</span> userId = idStr != <span class="keyword">null</span> ? Integer.parseInt(idStr) : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"true"</span>.equals(parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"system"</span>))) &#123; <span class="comment">// 是否是系统的用户 id！</span></span><br><span class="line">            pkgFlags |= ApplicationInfo.FLAG_SYSTEM;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (name == <span class="keyword">null</span>) &#123;</span><br><span class="line">            ... ... ...</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (userId == <span class="number">0</span>) &#123;</span><br><span class="line">            ... ... ...</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//【4.3.2】调用 addSharedUserLPw 方法，将这个共享用户和对应的 uid 保存下来！</span></span><br><span class="line">            <span class="keyword">if</span> ((su = addSharedUserLPw(name.intern(), userId, pkgFlags, pkgPrivateFlags))</span><br><span class="line">                    == <span class="keyword">null</span>) &#123;</span><br><span class="line">                PackageManagerService</span><br><span class="line">                        .reportSettingsProblem(Log.ERROR, <span class="string">"Occurred while parsing settings at "</span></span><br><span class="line">                                + parser.getPositionDescription());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">        PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                <span class="string">"Error in package manager settings: package "</span> + name + <span class="string">" has bad userId "</span></span><br><span class="line">                        + idStr + <span class="string">" at "</span> + parser.getPositionDescription());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (su != <span class="keyword">null</span>) &#123; <span class="comment">// 解析子标签！</span></span><br><span class="line">        <span class="keyword">int</span> outerDepth = parser.getDepth();</span><br><span class="line">        <span class="keyword">int</span> type;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">                &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            String tagName = parser.getName();</span><br><span class="line">            <span class="keyword">if</span> (tagName.equals(<span class="string">"sigs"</span>)) &#123;</span><br><span class="line">                su.signatures.readXml(parser, mPastSignatures);</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"perms"</span>)) &#123; <span class="comment">// 解析 "perms" 标签</span></span><br><span class="line">                <span class="comment">//【4.3.3】解析共享用户的权限信息！</span></span><br><span class="line">                readInstallPermissionsLPr(parser, su.getPermissionsState());</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                        <span class="string">"Unknown element under &lt;shared-user&gt;: "</span> + parser.getName());</span><br><span class="line">                XmlUtils.skipCurrentTag(parser);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        XmlUtils.skipCurrentTag(parser);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到，整个过程和解析 package 类似！</p>
<p>addSharedUserLPw 会创建对应的 SharedUserSetting 对象，在解析共享 uid 的安装时权限时，会通过 SharedUserSetting.getPermissionsState() 获得权限管理状态对象！</p>
<h3 id="4-3-2-Settings-addSharedUserLPw"><a href="#4-3-2-Settings-addSharedUserLPw" class="headerlink" title="4.3.2 Settings.addSharedUserLPw"></a>4.3.2 Settings.addSharedUserLPw</h3><p>addSharedUserLPw 会创建对应的 SharedUserSetting 对象！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">SharedUserSetting <span class="title">addSharedUserLPw</span><span class="params">(String name, <span class="keyword">int</span> uid, <span class="keyword">int</span> pkgFlags, <span class="keyword">int</span> pkgPrivateFlags)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】创建共享用户对应的 SharedUserSetting 对象！</span></span><br><span class="line">    SharedUserSetting s = mSharedUsers.get(name);</span><br><span class="line">    <span class="keyword">if</span> (s != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (s.userId == uid) &#123;</span><br><span class="line">            <span class="keyword">return</span> s;</span><br><span class="line">        &#125;</span><br><span class="line">        PackageManagerService.reportSettingsProblem(Log.ERROR,</span><br><span class="line">                <span class="string">"Adding duplicate shared user, keeping first: "</span> + name);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    s = <span class="keyword">new</span> SharedUserSetting(name, pkgFlags, pkgPrivateFlags);</span><br><span class="line">    s.userId = uid;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【8.1.1.2.1】根据 uid 的范围，保存到 mUsersId 和 mOthersId 中！</span></span><br><span class="line">    <span class="keyword">if</span> (addUserIdLPw(uid, s, name)) &#123;</span><br><span class="line">        <span class="comment">// 将其添加到 mSharedUsers 集合中！</span></span><br><span class="line">        mSharedUsers.put(name, s);</span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>流程总结：</p>
<ul>
<li>解析 “shared-user” ，将其分装成 SharedUserSetting 对象，保存到 Settings.mSharedUsers，并根据 uid 的取值将其保存到 mUserIds 或者 mOtherIds 中！</li>
<li>解析 “shared-user” 子标签 “perm” 等等，解析共享用户的权限，每个权限对应一个 PermissionData 对象，保存进入 PermisssionState 中，用于管理共享用户的权限！</li>
</ul>
<h1 id="5-确定共享-uid-有效性"><a href="#5-确定共享-uid-有效性" class="headerlink" title="5 确定共享 uid 有效性"></a>5 确定共享 uid 有效性</h1><p>主要逻辑如下，我们知道 mPendingPackages 中包含了 uid 为共享 uid 的 PackageSettings<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//【1】对 mPendingPackages 集合中的需要验证共享用户 id 有效性的 package，进行共享用户 id 有效性的验证!</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">int</span> N = mPendingPackages.size();</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">    <span class="keyword">final</span> PendingPackage pp = mPendingPackages.get(i);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【8.2.1】看 sharedId 是否能对应找到一个 ShardUserSetting 对象!</span></span><br><span class="line">    Object idObj = getUserIdLPr(pp.sharedId);</span><br><span class="line">    <span class="keyword">if</span> (idObj != <span class="keyword">null</span> &amp;&amp; idObj <span class="keyword">instanceof</span> SharedUserSetting) &#123; <span class="comment">// 能找到，说明共享用户 ID 是有效的!</span></span><br><span class="line">    </span><br><span class="line">        <span class="comment">//【8.2.2】创建 PackageSetting！</span></span><br><span class="line">        PackageSetting p = getPackageLPw(pp.name, <span class="keyword">null</span>, pp.realName,</span><br><span class="line">                (SharedUserSetting) idObj, pp.codePath, pp.resourcePath,</span><br><span class="line">                pp.legacyNativeLibraryPathString, pp.primaryCpuAbiString,</span><br><span class="line">                pp.secondaryCpuAbiString, pp.versionCode, pp.pkgFlags, pp.pkgPrivateFlags,</span><br><span class="line">                <span class="keyword">null</span>, <span class="keyword">true</span> <span class="comment">/* add */</span>, <span class="keyword">false</span> <span class="comment">/* allowInstall */</span>, pp.parentPackageName,</span><br><span class="line">                pp.childPackageNames);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (p == <span class="keyword">null</span>) &#123;</span><br><span class="line">            PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                    <span class="string">"Unable to create application package for "</span> + pp.name);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 将 PendingPackage 的其他数据拷贝到 PackageSetting 中！</span></span><br><span class="line">        p.copyFrom(pp); </span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (idObj != <span class="keyword">null</span>) &#123;</span><br><span class="line">        String msg = <span class="string">"Bad package setting: package "</span> + pp.name + <span class="string">" has shared uid "</span></span><br><span class="line">                + pp.sharedId + <span class="string">" that is not a shared uid\n"</span>;</span><br><span class="line">        mReadMessages.append(msg);</span><br><span class="line">        PackageManagerService.reportSettingsProblem(Log.ERROR, msg);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        String msg = <span class="string">"Bad package setting: package "</span> + pp.name + <span class="string">" has shared uid "</span></span><br><span class="line">                + pp.sharedId + <span class="string">" that is not defined\n"</span>;</span><br><span class="line">        mReadMessages.append(msg);</span><br><span class="line">        PackageManagerService.reportSettingsProblem(Log.ERROR, msg);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">mPendingPackages.clear(); <span class="comment">// 清空 mPendingPackages</span></span><br></pre></td></tr></table></figure></p>
<p>过程很简单，就是从前面解析得到的 Settings.mSharedUsers 中尝试获得 package 的共享 uid 对应的 SharedUserSetting 对象，如果存在，那么就说明共享 uid 是有效的！</p>
<p>getPackageLPw 方法会为那些在 mPendingPackages 中的 PendingPackage 创建对应的 PackageSetting，同时设置他们的共享 uid 为 SharedUserSetting，然后会将其添加到 Settings.mPackages 中！</p>
<p>这里调用 getUserIdLPr 来从 mUserIds 或 mOtherUserIds 中获得一个共享用户对象 SharedUserSetting！</p>
<h1 id="6-读取上一次运行时权限信息"><a href="#6-读取上一次运行时权限信息" class="headerlink" title="6 读取上一次运行时权限信息"></a>6 读取上一次运行时权限信息</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//【8.4】读取每个 user 下的运行时权限信息！</span></span><br><span class="line"><span class="keyword">for</span> (UserInfo user : users) &#123;</span><br><span class="line">    mRuntimePermissionsPersistence.readStateForUserSyncLPr(user.id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来是读取运行时权限的信息！</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version='1.0' encoding='UTF-8' standalone='yes' ?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">runtime-permissions</span> <span class="attr">fingerprint</span>=<span class="string">"OPPO/R11s/R11s:8.1.0/OPM1.171019.011/1519198279:user/release-keys"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">pkg</span> <span class="attr">name</span>=<span class="string">"com.sohu.inputmethod.sogouoem"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.ACCESS_FINE_LOCATION"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"20"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.READ_EXTERNAL_STORAGE"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"20"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.ACCESS_COARSE_LOCATION"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"20"</span> /&gt;</span></span><br><span class="line">    ... ... ...</span><br><span class="line">  <span class="tag">&lt;/<span class="name">pkg</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">shared-user</span> <span class="attr">name</span>=<span class="string">"android.uid.calendar"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.READ_CALENDAR"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"20"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.ACCESS_FINE_LOCATION"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"20"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android.permission.READ_EXTERNAL_STORAGE"</span> <span class="attr">granted</span>=<span class="string">"true"</span> <span class="attr">flags</span>=<span class="string">"20"</span> /&gt;</span></span><br><span class="line">    ... ... ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">runtime-permissions</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="6-1-RuntimePermissionsPersistence-readStateForUserSyncLPr"><a href="#6-1-RuntimePermissionsPersistence-readStateForUserSyncLPr" class="headerlink" title="6.1 RuntimePermissionsPersistence.readStateForUserSyncLPr"></a>6.1 RuntimePermissionsPersistence.readStateForUserSyncLPr</h2><p>该方法会读取指定的 userId 下的运行时权限信息，因为运行时权限每个设备用户下都不一样！</p>
<p>运行时权限记录在 /data/system/users/0/runtime-permissions.xml 文件中！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">readStateForUserSyncLPr</span><span class="params">(<span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】获得运行时权限文件对象 runtime-permissions.xml！</span></span><br><span class="line">    File permissionsFile = getUserRuntimePermissionsFile(userId);</span><br><span class="line">    <span class="keyword">if</span> (!permissionsFile.exists()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    FileInputStream in;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        in = <span class="keyword">new</span> AtomicFile(permissionsFile).openRead();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (FileNotFoundException fnfe) &#123;</span><br><span class="line">        Slog.i(PackageManagerService.TAG, <span class="string">"No permissions state"</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        XmlPullParser parser = Xml.newPullParser();</span><br><span class="line">        parser.setInput(in, <span class="keyword">null</span>);</span><br><span class="line">        <span class="comment">//【6.2】解析运行时权限数据！</span></span><br><span class="line">        parseRuntimePermissionsLPr(parser, userId);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (XmlPullParserException | IOException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Failed parsing permissions file: "</span></span><br><span class="line">                + permissionsFile , e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        IoUtils.closeQuietly(in);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>解析过程在 parseRuntimePermissionsLPr 方法中！</p>
<h2 id="6-2-RuntimePermissionsPersistence-parseRuntimePermissionsLPr"><a href="#6-2-RuntimePermissionsPersistence-parseRuntimePermissionsLPr" class="headerlink" title="6.2 RuntimePermissionsPersistence.parseRuntimePermissionsLPr"></a>6.2 RuntimePermissionsPersistence.parseRuntimePermissionsLPr</h2><p>用于解析运行时权限文件，获得上一次安装时的运行时权限相关的信息！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseRuntimePermissionsLPr</span><span class="params">(XmlPullParser parser, <span class="keyword">int</span> userId)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IOException, XmlPullParserException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> outerDepth = parser.getDepth();</span><br><span class="line">    <span class="keyword">int</span> type;</span><br><span class="line">    <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">            &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (parser.getName()) &#123;</span><br><span class="line">            <span class="keyword">case</span> TAG_RUNTIME_PERMISSIONS: &#123; <span class="comment">//【1】解析 runtime-permissions 标签</span></span><br><span class="line">                <span class="comment">// 解析 fingerprint 属性，保存到 mFingerprints 中！</span></span><br><span class="line">                String fingerprint = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_FINGERPRINT); </span><br><span class="line">                mFingerprints.put(userId, fingerprint); </span><br><span class="line"></span><br><span class="line">                <span class="comment">// 然用用本次启动系统的 fingerprint 判断系统是否有升级，如果没有升级 defaultsGranted 为 true！</span></span><br><span class="line">                <span class="comment">// 后面默认授予运行时权限会用到！</span></span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">boolean</span> defaultsGranted = Build.FINGERPRINT.equals(fingerprint);</span><br><span class="line">                mDefaultPermissionsGranted.put(userId, defaultsGranted);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> TAG_PACKAGE: &#123;  <span class="comment">//【2】解析 pkg 标签</span></span><br><span class="line">                String name = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_NAME);</span><br><span class="line">                PackageSetting ps = mPackages.get(name);</span><br><span class="line">                <span class="keyword">if</span> (ps == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Slog.w(PackageManagerService.TAG, <span class="string">"Unknown package:"</span> + name);</span><br><span class="line">                    XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//【6.2.1】解析并处理 package 的运行时权限授予情况！</span></span><br><span class="line">                parsePermissionsLPr(parser, ps.getPermissionsState(), userId);</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> TAG_SHARED_USER: &#123;  <span class="comment">//【3】解析 shared-user 标签</span></span><br><span class="line">                String name = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_NAME);</span><br><span class="line">                SharedUserSetting sus = mSharedUsers.get(name);</span><br><span class="line">                <span class="keyword">if</span> (sus == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Slog.w(PackageManagerService.TAG, <span class="string">"Unknown shared user:"</span> + name);</span><br><span class="line">                    XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//【6.2.1】解析并处理 shared-user 的运行时权限授予情况！</span></span><br><span class="line">                parsePermissionsLPr(parser, sus.getPermissionsState(), userId);</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> TAG_RESTORED_RUNTIME_PERMISSIONS: &#123; <span class="comment">// restored-perms 标签</span></span><br><span class="line">                <span class="keyword">final</span> String pkgName = parser.getAttributeValue(<span class="keyword">null</span>, ATTR_PACKAGE_NAME);</span><br><span class="line">                parseRestoredRuntimePermissionsLPr(parser, pkgName, userId);</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里的 mDefaultPermissionsGranted 用于判断是否进行默认运行时权限授予的！</p>
<h1 id="7-应用文件扫描"><a href="#7-应用文件扫描" class="headerlink" title="7 应用文件扫描"></a>7 应用文件扫描</h1><p>PMS 会按照顺序扫描以下目录：</p>
<ul>
<li><strong>/vendor/overlay</strong></li>
<li><strong>/system/framework</strong></li>
<li><strong>/system/priv-app</strong></li>
<li><strong>/system/app</strong></li>
<li><strong>/vendor/app</strong></li>
<li><strong>/oem/app</strong></li>
</ul>
<p>调用 PMS.scanDirTracedLI 进行扫描，需要注意的是被扫描目录的顺序，这个顺序意味着：先被扫描到的文件，就是最终被用到的文件。</p>
<h2 id="7-1-系统权限的定义"><a href="#7-1-系统权限的定义" class="headerlink" title="7.1 系统权限的定义"></a>7.1 系统权限的定义</h2><p>系统的权限定义在 \android\frameworks\base\core\res\AndroidManifest.xml 文件中！但实际上最终会通过编译生成 framework-res.apk！</p>
<p>我们来看看具体的权限定义：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;permission-group android:name=<span class="string">"android.permission-group.CONTACTS"</span></span><br><span class="line">     android:icon=<span class="string">"@drawable/perm_group_contacts"</span></span><br><span class="line">     android:label=<span class="string">"@string/permgrouplab_contacts"</span></span><br><span class="line">     android:description=<span class="string">"@string/permgroupdesc_contacts"</span></span><br><span class="line">     android:priority=<span class="string">"100"</span> /&gt;</span><br><span class="line"></span><br><span class="line"> &lt;!-- Allows an application to read the user<span class="string">'s contacts data.</span></span><br><span class="line"><span class="string">     &lt;p&gt;Protection level: dangerous</span></span><br><span class="line"><span class="string"> --&gt;</span></span><br><span class="line"><span class="string"> &lt;permission android:name="android.permission.READ_CONTACTS"</span></span><br><span class="line"><span class="string">     android:permissionGroup="android.permission-group.CONTACTS"</span></span><br><span class="line"><span class="string">     android:label="@string/permlab_readContacts"</span></span><br><span class="line"><span class="string">     android:description="@string/permdesc_readContacts"</span></span><br><span class="line"><span class="string">     android:protectionLevel="dangerous" /&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="7-2-系统和应用权限信息的解析"><a href="#7-2-系统和应用权限信息的解析" class="headerlink" title="7.2 系统和应用权限信息的解析"></a>7.2 系统和应用权限信息的解析</h2><p>解析系统权限的过程，其实就是解析 framework-res.apk 的过程！</p>
<p>对于这一部分，可以看【应用程序的权限配置和解析】这边博文！</p>
<p>在解析完 Apk 的 AndroidManifest.xml 中定义和申请的权限信息后，会进入扫描的最后阶段 PMS.scanPackageDirtyLI</p>
<h2 id="7-3-PMS-scanPackageDirtyLI"><a href="#7-3-PMS-scanPackageDirtyLI" class="headerlink" title="7.3 PMS.scanPackageDirtyLI"></a>7.3 PMS.scanPackageDirtyLI</h2><p>无论是系统应用，还是三方应用，最终都会调用 scanPackageDirtyLI 方法处理扫描得到的数据：</p>
<p>这里我们重点看和权限相关的代码段：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> PackageParser.<span class="function">Package <span class="title">scanPackageDirtyLI</span><span class="params">(PackageParser.Package pkg,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> <span class="keyword">int</span> policyFlags, <span class="keyword">final</span> <span class="keyword">int</span> scanFlags, <span class="keyword">long</span> currentTime, UserHandle user)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> PackageManagerException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> File scanFile = <span class="keyword">new</span> File(pkg.codePath);</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【×】处理包名为 "android" 的 apk，也就是 framework-res.apk，属于系统平台包！</span></span><br><span class="line">    <span class="keyword">if</span> (pkg.packageName.equals(<span class="string">"android"</span>)) &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mAndroidApplication != <span class="keyword">null</span>) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"*************************************************"</span>);</span><br><span class="line">                Slog.w(TAG, <span class="string">"Core android package being redefined.  Skipping."</span>);</span><br><span class="line">                Slog.w(TAG, <span class="string">" file="</span> + scanFile);</span><br><span class="line">                Slog.w(TAG, <span class="string">"*************************************************"</span>);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(INSTALL_FAILED_DUPLICATE_PACKAGE,</span><br><span class="line">                        <span class="string">"Core android package being redefined.  Skipping."</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((scanFlags &amp; SCAN_CHECK_ONLY) == <span class="number">0</span>) &#123; <span class="comment">// 进入该分支，设置系统平台包相关的属性！</span></span><br><span class="line">                <span class="comment">// Set up information for our fall-back user intent resolution activity.</span></span><br><span class="line">                mPlatformPackage = pkg;</span><br><span class="line">                pkg.mVersionCode = mSdkVersion;</span><br><span class="line">                mAndroidApplication = pkg.applicationInfo;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!mResolverReplaced) &#123; <span class="comment">// 建立 ResolverActivity 的内存对象。</span></span><br><span class="line">                    mResolveActivity.applicationInfo = mAndroidApplication;</span><br><span class="line">                    mResolveActivity.name = ResolverActivity.class.getName();</span><br><span class="line">                    mResolveActivity.packageName = mAndroidApplication.packageName;</span><br><span class="line">                    mResolveActivity.processName = <span class="string">"system:ui"</span>;</span><br><span class="line">                    mResolveActivity.launchMode = ActivityInfo.LAUNCH_MULTIPLE;</span><br><span class="line">                    mResolveActivity.documentLaunchMode = ActivityInfo.DOCUMENT_LAUNCH_NEVER;</span><br><span class="line">                    mResolveActivity.flags = ActivityInfo.FLAG_EXCLUDE_FROM_RECENTS;</span><br><span class="line">                    mResolveActivity.theme = R.style.Theme_Material_Dialog_Alert;</span><br><span class="line">                    mResolveActivity.exported = <span class="keyword">true</span>;</span><br><span class="line">                    mResolveActivity.enabled = <span class="keyword">true</span>;</span><br><span class="line">                    mResolveActivity.resizeMode = ActivityInfo.RESIZE_MODE_RESIZEABLE;</span><br><span class="line">                    mResolveActivity.configChanges = ActivityInfo.CONFIG_SCREEN_SIZE</span><br><span class="line">                            | ActivityInfo.CONFIG_SMALLEST_SCREEN_SIZE</span><br><span class="line">                            | ActivityInfo.CONFIG_SCREEN_LAYOUT</span><br><span class="line">                            | ActivityInfo.CONFIG_ORIENTATION</span><br><span class="line">                            | ActivityInfo.CONFIG_KEYBOARD</span><br><span class="line">                            | ActivityInfo.CONFIG_KEYBOARD_HIDDEN;</span><br><span class="line">                    mResolveInfo.activityInfo = mResolveActivity;</span><br><span class="line">                    mResolveInfo.priority = <span class="number">0</span>;</span><br><span class="line">                    mResolveInfo.preferredOrder = <span class="number">0</span>;</span><br><span class="line">                    mResolveInfo.match = <span class="number">0</span>;</span><br><span class="line">                    mResolveComponentName = <span class="keyword">new</span> ComponentName(</span><br><span class="line">                            mAndroidApplication.packageName, mResolveActivity.name);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((policyFlags &amp; PackageParser.PARSE_CHATTY) != <span class="number">0</span>)</span><br><span class="line">            Log.d(TAG, <span class="string">"Scanning package "</span> + pkg.packageName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="comment">//【1】如果 PMS.mPackages 已经包含当前的 Package，说明这个包已经被扫描过了，抛异常，不继续处理！</span></span><br><span class="line">        <span class="keyword">if</span> (mPackages.containsKey(pkg.packageName)</span><br><span class="line">                || mSharedLibraries.containsKey(pkg.packageName)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(INSTALL_FAILED_DUPLICATE_PACKAGE,</span><br><span class="line">                    <span class="string">"Application package "</span> + pkg.packageName</span><br><span class="line">                            + <span class="string">" already installed.  Skipping duplicate."</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 系统 apk 不进入这个分支，SCAN_REQUIRE_KNOWN 只有在扫描 data 分区是才会被设置！！</span></span><br><span class="line">        <span class="keyword">if</span> ((scanFlags &amp; SCAN_REQUIRE_KNOWN) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mExpectingBetter.containsKey(pkg.packageName)) &#123;</span><br><span class="line">                logCriticalInfo(Log.WARN,</span><br><span class="line">                        <span class="string">"Relax SCAN_REQUIRE_KNOWN requirement for package "</span> + pkg.packageName);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                PackageSetting known = mSettings.peekPackageLPr(pkg.packageName);</span><br><span class="line">                <span class="keyword">if</span> (known != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) &#123;</span><br><span class="line">                        Log.d(TAG, <span class="string">"Examining "</span> + pkg.codePath</span><br><span class="line">                                + <span class="string">" and requiring known paths "</span> + known.codePathString</span><br><span class="line">                                + <span class="string">" &amp; "</span> + known.resourcePathString);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (!pkg.applicationInfo.getCodePath().equals(known.codePathString)</span><br><span class="line">                            || !pkg.applicationInfo.getResourcePath().equals(</span><br><span class="line">                            known.resourcePathString)) &#123;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(INSTALL_FAILED_PACKAGE_CHANGED,</span><br><span class="line">                                <span class="string">"Application package "</span> + pkg.packageName</span><br><span class="line">                                        + <span class="string">" found at "</span> + pkg.applicationInfo.getCodePath()</span><br><span class="line">                                        + <span class="string">" but expected at "</span> + known.codePathString</span><br><span class="line">                                        + <span class="string">"; ignoring."</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【×】获得扫描到的 apk 和资源的路径，下面会用到！</span></span><br><span class="line">    File destCodeFile = <span class="keyword">new</span> File(pkg.applicationInfo.getCodePath());</span><br><span class="line">    File destResourceFile = <span class="keyword">new</span> File(pkg.applicationInfo.getResourcePath());</span><br><span class="line"></span><br><span class="line">    SharedUserSetting suid = <span class="keyword">null</span>;</span><br><span class="line">    PackageSetting pkgSetting = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【×】系统 apk 才能有 mOriginalPackages，mRealPackage 和 mAdoptPermissions！</span></span><br><span class="line">    <span class="keyword">if</span> (!isSystemApp(pkg)) &#123;</span><br><span class="line">        pkg.mOriginalPackages = <span class="keyword">null</span>;</span><br><span class="line">        pkg.mRealPackage = <span class="keyword">null</span>;</span><br><span class="line">        pkg.mAdoptPermissions = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Getting the package setting may have a side-effect, so if we</span></span><br><span class="line">    <span class="comment">// are only checking if scan would succeed, stash a copy of the</span></span><br><span class="line">    <span class="comment">// old setting to restore at the end.</span></span><br><span class="line">    PackageSetting nonMutatedPs = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="comment">//【×】当前的系统 package 是共享 uid 的，要判断其对应的共享 uid 是否存在！</span></span><br><span class="line">        <span class="keyword">if</span> (pkg.mSharedUserId != <span class="keyword">null</span>) &#123;</span><br><span class="line">            suid = mSettings.getSharedUserLPw(pkg.mSharedUserId, <span class="number">0</span>, <span class="number">0</span>, <span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">if</span> (suid == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(INSTALL_FAILED_INSUFFICIENT_STORAGE,</span><br><span class="line">                        <span class="string">"Creating application package "</span> + pkg.packageName</span><br><span class="line">                        + <span class="string">" for shared user failed"</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((policyFlags &amp; PackageParser.PARSE_CHATTY) != <span class="number">0</span>)</span><br><span class="line">                    Log.d(TAG, <span class="string">"Shared UserID "</span> + pkg.mSharedUserId + <span class="string">" (uid="</span> + suid.userId</span><br><span class="line">                            + <span class="string">"): packages="</span> + suid.packages);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ... ... ...</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【3.2.1.7.2】获得当前扫描的这个 package 对应的 packageSetting 对象，如果已经存在就直接返回，不存在就创建！</span></span><br><span class="line">        <span class="comment">// 如果 origPackage 不为 null，创建新的需要重命名为源包的名字！</span></span><br><span class="line">        pkgSetting = mSettings.getPackageLPw(pkg, origPackage, realName, suid, destCodeFile,</span><br><span class="line">                destResourceFile, pkg.applicationInfo.nativeLibraryRootDir,</span><br><span class="line">                pkg.applicationInfo.primaryCpuAbi,</span><br><span class="line">                pkg.applicationInfo.secondaryCpuAbi,</span><br><span class="line">                pkg.applicationInfo.flags, pkg.applicationInfo.privateFlags,</span><br><span class="line">                user, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (pkgSetting == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(INSTALL_FAILED_INSUFFICIENT_STORAGE,</span><br><span class="line">                    <span class="string">"Creating application package "</span> + pkg.packageName + <span class="string">" failed"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【×】对于系统 package，如果 origPackage 不为 null，改名为源包的名字！</span></span><br><span class="line">        <span class="keyword">if</span> (pkgSetting.origPackage != <span class="keyword">null</span>) &#123;</span><br><span class="line">            pkg.setPackageName(origPackage.name);</span><br><span class="line"></span><br><span class="line">            String msg = <span class="string">"New package "</span> + pkgSetting.realName</span><br><span class="line">                    + <span class="string">" renamed to replace old package "</span> + pkgSetting.name;</span><br><span class="line">            reportSettingsProblem(Log.WARN, msg);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((scanFlags &amp; SCAN_CHECK_ONLY) == <span class="number">0</span>) &#123; <span class="comment">// 如果没有设置 SCAN_CHECK_ONLY，记录本次改名！</span></span><br><span class="line">                mTransferedPackages.add(origPackage.name);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 清空 originPackage 属性！</span></span><br><span class="line">            pkgSetting.origPackage = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((scanFlags &amp; SCAN_CHECK_ONLY) == <span class="number">0</span> &amp;&amp; realName != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mTransferedPackages.add(pkg.packageName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【×】如果当前的系统 apk 被覆盖更新过，就添加 ApplicationInfo.FLAG_UPDATED_SYSTEM_APP 标签！</span></span><br><span class="line">        <span class="keyword">if</span> (mSettings.isDisabledSystemPackageLPr(pkg.packageName)) &#123; </span><br><span class="line">            pkg.applicationInfo.flags |= ApplicationInfo.FLAG_UPDATED_SYSTEM_APP;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((policyFlags&amp;PackageParser.PARSE_IS_SYSTEM_DIR) == <span class="number">0</span>) &#123;</span><br><span class="line">            updateSharedLibrariesLPw(pkg, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mFoundPolicyFile) &#123;</span><br><span class="line">            <span class="comment">// 给当前的 Package 分配一个标签，用于 seLinux！</span></span><br><span class="line">            SELinuxMMAC.assignSeinfoValue(pkg);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        pkg.applicationInfo.uid = pkgSetting.appId;</span><br><span class="line">        pkg.mExtras = pkgSetting;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【×】处理 keySet 更新和签名校验！</span></span><br><span class="line">        <span class="keyword">if</span> (shouldCheckUpgradeKeySetLP(pkgSetting, scanFlags)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (checkUpgradeKeySetLP(pkgSetting, pkg)) &#123;</span><br><span class="line">                <span class="comment">// 签名正确，更新本地的签名信息！</span></span><br><span class="line">                pkgSetting.signatures.mSignatures = pkg.mSignatures;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 签名异常处理</span></span><br><span class="line">                <span class="keyword">if</span> ((policyFlags &amp; PackageParser.PARSE_IS_SYSTEM_DIR) == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(INSTALL_FAILED_UPDATE_INCOMPATIBLE,</span><br><span class="line">                            <span class="string">"Package "</span> + pkg.packageName + <span class="string">" upgrade keys do not match the "</span></span><br><span class="line">                            + <span class="string">"previously installed version"</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    pkgSetting.signatures.mSignatures = pkg.mSignatures;</span><br><span class="line">                    String msg = <span class="string">"System package "</span> + pkg.packageName</span><br><span class="line">                        + <span class="string">" signature changed; retaining data."</span>;</span><br><span class="line">                    reportSettingsProblem(Log.WARN, msg);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 如果不检查 KetSet 更新的话，就直接校验签名！</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                verifySignaturesLP(pkgSetting, pkg);</span><br><span class="line">                pkgSetting.signatures.mSignatures = pkg.mSignatures;</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">catch</span> (PackageManagerException e) &#123;</span><br><span class="line">                <span class="keyword">if</span> ((policyFlags &amp; PackageParser.PARSE_IS_SYSTEM_DIR) == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> e;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 如果签名校验出现问题，这里会先恢复成本次解析的签名！</span></span><br><span class="line">                pkgSetting.signatures.mSignatures = pkg.mSignatures;</span><br><span class="line">                <span class="comment">// 但是如果是 sharedUser 的情况，就会报错！</span></span><br><span class="line">                <span class="keyword">if</span> (pkgSetting.sharedUser != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (compareSignatures(pkgSetting.sharedUser.signatures.mSignatures,</span><br><span class="line">                                          pkg.mSignatures) != PackageManager.SIGNATURE_MATCH) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(</span><br><span class="line">                                INSTALL_PARSE_FAILED_INCONSISTENT_CERTIFICATES,</span><br><span class="line">                                        <span class="string">"Signature mismatch for shared user: "</span></span><br><span class="line">                                        + pkgSetting.sharedUser);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                String msg = <span class="string">"System package "</span> + pkg.packageName</span><br><span class="line">                    + <span class="string">" signature changed; retaining data."</span>;</span><br><span class="line">                reportSettingsProblem(Log.WARN, msg);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">        ... ... ... ...</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 同样的，只有系统 apk 才能进入该分支，用于权限继承！</span></span><br><span class="line">        <span class="keyword">if</span> ((scanFlags &amp; SCAN_CHECK_ONLY) == <span class="number">0</span> &amp;&amp; pkg.mAdoptPermissions != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = pkg.mAdoptPermissions.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">                <span class="keyword">final</span> String origName = pkg.mAdoptPermissions.get(i);</span><br><span class="line">                <span class="keyword">final</span> PackageSetting orig = mSettings.peekPackageLPr(origName);</span><br><span class="line">                <span class="keyword">if</span> (orig != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (verifyPackageUpdateLPr(orig, pkg)) &#123;</span><br><span class="line">                        Slog.i(TAG, <span class="string">"Adopting permissions from "</span> + origName + <span class="string">" to "</span></span><br><span class="line">                                + pkg.packageName);</span><br><span class="line">                        mSettings.transferPermissionsLPw(origName, pkg.packageName);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ... ... ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果是系统 package，设置 isOrphaned 的属性为 true！</span></span><br><span class="line">    <span class="keyword">if</span> (isSystemApp(pkg)) &#123;</span><br><span class="line">        pkgSetting.isOrphaned = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ... ... ...</span><br><span class="line"></span><br><span class="line">    Trace.traceBegin(TRACE_TAG_PACKAGE_MANAGER, <span class="string">"updateSettings"</span>); <span class="comment">// 记录 trace 事件！</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> createIdmapFailed = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">        <span class="keyword">if</span> (pkgSetting.pkg != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// Note that |user| might be null during the initial boot scan. If a codePath</span></span><br><span class="line">            <span class="comment">// for an app has changed during a boot scan, it's due to an app update that's</span></span><br><span class="line">            <span class="comment">// part of the system partition and marker changes must be applied to all users.</span></span><br><span class="line">            maybeRenameForeignDexMarkers(pkgSetting.pkg, pkg,</span><br><span class="line">                (user != <span class="keyword">null</span>) ? user : UserHandle.ALL);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【important】将新创建或者更新后的 PackageSetting 重新添加到 mSettings 中！</span></span><br><span class="line">        mSettings.insertPackageSettingLPw(pkgSetting, pkg);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【important】将本次扫描的 Package 添加到 PMS.mPackages 中去！</span></span><br><span class="line">        mPackages.put(pkg.applicationInfo.packageName, pkg);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 将当前的 package 从 mSettings.mPackagesToBeCleaned 中移除，防止数据清除！</span></span><br><span class="line">        <span class="keyword">final</span> Iterator&lt;PackageCleanItem&gt; iter = mSettings.mPackagesToBeCleaned.iterator();</span><br><span class="line">        <span class="keyword">while</span> (iter.hasNext()) &#123;</span><br><span class="line">            PackageCleanItem item = iter.next();</span><br><span class="line">            <span class="keyword">if</span> (pkgName.equals(item.packageName)) &#123;</span><br><span class="line">                iter.remove();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 处理 package 的第一次安装时间和最近更新时间！</span></span><br><span class="line">        <span class="keyword">if</span> (currentTime != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (pkgSetting.firstInstallTime == <span class="number">0</span>) &#123;</span><br><span class="line">                pkgSetting.firstInstallTime = pkgSetting.lastUpdateTime = currentTime;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((scanFlags&amp;SCAN_UPDATE_TIME) != <span class="number">0</span>) &#123;</span><br><span class="line">                pkgSetting.lastUpdateTime = currentTime;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pkgSetting.firstInstallTime == <span class="number">0</span>) &#123;</span><br><span class="line">            pkgSetting.firstInstallTime = pkgSetting.lastUpdateTime = scanFileTime;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((policyFlags&amp;PackageParser.PARSE_IS_SYSTEM_DIR) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (scanFileTime != pkgSetting.timeStamp) &#123;</span><br><span class="line">                pkgSetting.lastUpdateTime = scanFileTime;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ksms.addScannedPackageLPw(pkg); <span class="comment">// 将 package 的 KeySets 添加到 KeySetManagerService 中！</span></span><br><span class="line">       </span><br><span class="line">        <span class="comment">// 处理四大组件！ </span></span><br><span class="line">        <span class="comment">//【1】处理该 Package 中 的 Provider 信息，添加到 PMS.mProviders 中！</span></span><br><span class="line">        <span class="keyword">int</span> N = pkg.providers.size();</span><br><span class="line">        StringBuilder r = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">int</span> i;</span><br><span class="line">        <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">            PackageParser.Provider p = pkg.providers.get(i);</span><br><span class="line">            p.info.processName = fixProcessName(pkg.applicationInfo.processName,</span><br><span class="line">                    p.info.processName, pkg.applicationInfo.uid);</span><br><span class="line">            mProviders.addProvider(p); <span class="comment">// 添加到 PMS.mProviders 中！</span></span><br><span class="line">            p.syncable = p.info.isSyncable;</span><br><span class="line">            <span class="keyword">if</span> (p.info.authority != <span class="keyword">null</span>) &#123;</span><br><span class="line">               ... ... ... ...</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ((policyFlags&amp;PackageParser.PARSE_CHATTY) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    r = <span class="keyword">new</span> StringBuilder(<span class="number">256</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    r.append(<span class="string">' '</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                r.append(p.info.name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) Log.d(TAG, <span class="string">"  Providers: "</span> + r);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2】处理该 Package 中的 Service 信息，添加到 PMS.mService 中！</span></span><br><span class="line">        N = pkg.services.size();</span><br><span class="line">        r = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">            PackageParser.Service s = pkg.services.get(i);</span><br><span class="line">            s.info.processName = fixProcessName(pkg.applicationInfo.processName,</span><br><span class="line">                    s.info.processName, pkg.applicationInfo.uid);</span><br><span class="line">            mServices.addService(s); <span class="comment">// 添加到 PMS.mServices 中！</span></span><br><span class="line">            <span class="keyword">if</span> ((policyFlags&amp;PackageParser.PARSE_CHATTY) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    r = <span class="keyword">new</span> StringBuilder(<span class="number">256</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    r.append(<span class="string">' '</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                r.append(s.info.name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) Log.d(TAG, <span class="string">"  Services: "</span> + r);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【3】处理该 Package 中的 BroadcastReceiver 信息,添加到 PMS.mReceivers 中。</span></span><br><span class="line">        N = pkg.receivers.size();</span><br><span class="line">        r = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">            PackageParser.Activity a = pkg.receivers.get(i);</span><br><span class="line">            a.info.processName = fixProcessName(pkg.applicationInfo.processName,</span><br><span class="line">                    a.info.processName, pkg.applicationInfo.uid);</span><br><span class="line">            mReceivers.addActivity(a, <span class="string">"receiver"</span>); <span class="comment">// 添加到 PMS.mReceivers 中！</span></span><br><span class="line">            <span class="keyword">if</span> ((policyFlags&amp;PackageParser.PARSE_CHATTY) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    r = <span class="keyword">new</span> StringBuilder(<span class="number">256</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    r.append(<span class="string">' '</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                r.append(a.info.name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) Log.d(TAG, <span class="string">"  Receivers: "</span> + r);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【4】处理该 Package 中的 activity 信息，添加到 PMS.mActivities 中！</span></span><br><span class="line">        N = pkg.activities.size();</span><br><span class="line">        r = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">            PackageParser.Activity a = pkg.activities.get(i);</span><br><span class="line">            a.info.processName = fixProcessName(pkg.applicationInfo.processName,</span><br><span class="line">                    a.info.processName, pkg.applicationInfo.uid);</span><br><span class="line">            mActivities.addActivity(a, <span class="string">"activity"</span>); <span class="comment">// 添加到 PMS.mActivities 中！</span></span><br><span class="line">            <span class="keyword">if</span> ((policyFlags&amp;PackageParser.PARSE_CHATTY) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    r = <span class="keyword">new</span> StringBuilder(<span class="number">256</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    r.append(<span class="string">' '</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                r.append(a.info.name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) Log.d(TAG, <span class="string">"  Activities: "</span> + r);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【5】处理该 Package 中的 PermissionGroups 信息，添加到 PMS.mPermissionGroups 中！</span></span><br><span class="line">        N = pkg.permissionGroups.size();</span><br><span class="line">        r = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">            PackageParser.PermissionGroup pg = pkg.permissionGroups.get(i);</span><br><span class="line">            PackageParser.PermissionGroup cur = mPermissionGroups.get(pg.info.name);</span><br><span class="line">            <span class="keyword">final</span> String curPackageName = cur == <span class="keyword">null</span> ? <span class="keyword">null</span> : cur.info.packageName;</span><br><span class="line">            <span class="comment">//【5.1】如果 isPackageUpdate 为 true，说明要更新权限组的信息！</span></span><br><span class="line">            <span class="comment">// 如果 cur 为 null，说明是新添加的权限组信息！</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> isPackageUpdate = pg.info.packageName.equals(curPackageName);</span><br><span class="line">            <span class="keyword">if</span> (cur == <span class="keyword">null</span> || isPackageUpdate) &#123;</span><br><span class="line">                mPermissionGroups.put(pg.info.name, pg); <span class="comment">// 添加到 PMS.mPermissionGroups 中！</span></span><br><span class="line">                <span class="keyword">if</span> ((policyFlags&amp;PackageParser.PARSE_CHATTY) != <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        r = <span class="keyword">new</span> StringBuilder(<span class="number">256</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        r.append(<span class="string">' '</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (isPackageUpdate) &#123;</span><br><span class="line">                        r.append(<span class="string">"UPD:"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    r.append(pg.info.name);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Permission group "</span> + pg.info.name + <span class="string">" from package "</span></span><br><span class="line">                        + pg.info.packageName + <span class="string">" ignored: original from "</span></span><br><span class="line">                        + cur.info.packageName);</span><br><span class="line">                <span class="keyword">if</span> ((policyFlags&amp;PackageParser.PARSE_CHATTY) != <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        r = <span class="keyword">new</span> StringBuilder(<span class="number">256</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        r.append(<span class="string">' '</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    r.append(<span class="string">"DUP:"</span>);</span><br><span class="line">                    r.append(pg.info.name);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) Log.d(TAG, <span class="string">"  Permission Groups: "</span> + r);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【6】处理该 Package 中的定义 Permission 和 Permission-tree 信息！</span></span><br><span class="line">        N = pkg.permissions.size();</span><br><span class="line">        r = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">            PackageParser.Permission p = pkg.permissions.get(i);</span><br><span class="line">            <span class="comment">// 默认取消掉 PermissionInfo.FLAG_INSTALLED 标志位！</span></span><br><span class="line">            p.info.flags &amp;= ~PermissionInfo.FLAG_INSTALLED;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【6.1】设置权限所属的 group，前提是只有 Android5.1 以后才支持 Permission Groups！</span></span><br><span class="line">            <span class="keyword">if</span> (pkg.applicationInfo.targetSdkVersion &gt; Build.VERSION_CODES.LOLLIPOP_MR1) &#123;</span><br><span class="line">                p.group = mPermissionGroups.get(p.info.group);</span><br><span class="line">                <span class="keyword">if</span> (p.info.group != <span class="keyword">null</span> &amp;&amp; p.group == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"Permission "</span> + p.info.name + <span class="string">" from package "</span></span><br><span class="line">                            + p.info.packageName + <span class="string">" in an unknown group "</span> + p.info.group);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【6.2】从 Settings 中获得权限管理集合，如果该权限是一个 Permission-tree，</span></span><br><span class="line">            <span class="comment">// 那就返回 mSettings.mPermissionTrees；否则，返回 mSettings.mPermissions！</span></span><br><span class="line">            ArrayMap&lt;String, BasePermission&gt; permissionMap =</span><br><span class="line">                    p.tree ? mSettings.mPermissionTrees</span><br><span class="line">                            : mSettings.mPermissions;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【6.3】尝试获得上次安装时该权限对应的 BasePermission 对象！</span></span><br><span class="line">            BasePermission bp = permissionMap.get(p.info.name);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【6.4】允许系统应用来重新定义非系统权限！</span></span><br><span class="line">            <span class="comment">// 如果上次安装时的 BasePermission 不为 null，但是当前解析的 package 不是上次安装时该权限的定义者！</span></span><br><span class="line">            <span class="keyword">if</span> (bp != <span class="keyword">null</span> &amp;&amp; !Objects.equals(bp.sourcePackage, p.info.packageName)) &#123;</span><br><span class="line">                <span class="comment">//【6.4.1】判断上一次安装时，定义该权限的 package 是否是系统应用！</span></span><br><span class="line">                <span class="comment">// 如果是 currentOwnerIsSystem 为 true！</span></span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">boolean</span> currentOwnerIsSystem = (bp.perm != <span class="keyword">null</span></span><br><span class="line">                        &amp;&amp; isSystemApp(bp.perm.owner));</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 如果当前解析的定义了该权限的 package 是系统 app，那么进入这里！     </span></span><br><span class="line">                <span class="keyword">if</span> (isSystemApp(p.owner)) &#123;</span><br><span class="line">                    <span class="comment">// 如果上次安装时，该权限是一个 BasePermission.TYPE_BUILTIN 系统权限，且 bp.perm 为 null，</span></span><br><span class="line">                    <span class="comment">// 即：拥有者未知，那么这里我们将这个 system package 分配给这个权限！</span></span><br><span class="line">                    <span class="keyword">if</span> (bp.type == BasePermission.TYPE_BUILTIN &amp;&amp; bp.perm == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        bp.packageSetting = pkgSetting;</span><br><span class="line">                        bp.perm = p;</span><br><span class="line">                        bp.uid = pkg.applicationInfo.uid;</span><br><span class="line">                        bp.sourcePackage = p.info.packageName;</span><br><span class="line">                        p.info.flags |= PermissionInfo.FLAG_INSTALLED;</span><br><span class="line"></span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!currentOwnerIsSystem) &#123;</span><br><span class="line">                    <span class="comment">// 如果上一次安装时，定义该权限的 package 不是系统应用，而定义相同权限的</span></span><br><span class="line">                    <span class="comment">// 本次解析的 package 是系统应用，那么该权限会被系统应用重新定义！</span></span><br><span class="line">                        String msg = <span class="string">"New decl "</span> + p.owner + <span class="string">" of permission  "</span></span><br><span class="line">                                + p.info.name + <span class="string">" is system; overriding "</span> + bp.sourcePackage;</span><br><span class="line">                        reportSettingsProblem(Log.WARN, msg);</span><br><span class="line">                        <span class="comment">// 设置 bp 为 null！</span></span><br><span class="line">                        bp = <span class="keyword">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 因为 bp 为 null，所谓我们会使用系统应用重新定义权限，如果是 permission-tree，会被添加到 </span></span><br><span class="line">            <span class="comment">// mSettings.mPermissionTrees 中！</span></span><br><span class="line">            <span class="keyword">if</span> (bp == <span class="keyword">null</span>) &#123;</span><br><span class="line">                bp = <span class="keyword">new</span> BasePermission(p.info.name, p.info.packageName,</span><br><span class="line">                        BasePermission.TYPE_NORMAL);</span><br><span class="line">                permissionMap.put(p.info.name, bp);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 重新分配拥有者为该系统应用！</span></span><br><span class="line">            <span class="keyword">if</span> (bp.perm == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (bp.sourcePackage == <span class="keyword">null</span></span><br><span class="line">                        || bp.sourcePackage.equals(p.info.packageName)) &#123;</span><br><span class="line">                    BasePermission tree = findPermissionTreeLP(p.info.name);</span><br><span class="line">                    <span class="keyword">if</span> (tree == <span class="keyword">null</span></span><br><span class="line">                            || tree.sourcePackage.equals(p.info.packageName)) &#123;</span><br><span class="line">                        bp.packageSetting = pkgSetting;</span><br><span class="line">                        bp.perm = p;</span><br><span class="line">                        bp.uid = pkg.applicationInfo.uid;</span><br><span class="line">                        bp.sourcePackage = p.info.packageName;</span><br><span class="line">                        p.info.flags |= PermissionInfo.FLAG_INSTALLED;</span><br><span class="line">                        <span class="keyword">if</span> ((policyFlags&amp;PackageParser.PARSE_CHATTY) != <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">                                r = <span class="keyword">new</span> StringBuilder(<span class="number">256</span>);</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                r.append(<span class="string">' '</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                            r.append(p.info.name);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        Slog.w(TAG, <span class="string">"Permission "</span> + p.info.name + <span class="string">" from package "</span></span><br><span class="line">                                + p.info.packageName + <span class="string">" ignored: base tree "</span></span><br><span class="line">                                + tree.name + <span class="string">" is from package "</span></span><br><span class="line">                                + tree.sourcePackage);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"Permission "</span> + p.info.name + <span class="string">" from package "</span></span><br><span class="line">                            + p.info.packageName + <span class="string">" ignored: original from "</span></span><br><span class="line">                            + bp.sourcePackage);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((policyFlags&amp;PackageParser.PARSE_CHATTY) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    r = <span class="keyword">new</span> StringBuilder(<span class="number">256</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    r.append(<span class="string">' '</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                r.append(<span class="string">"DUP:"</span>);</span><br><span class="line">                r.append(p.info.name);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 设置 protectionLevel！</span></span><br><span class="line">            <span class="keyword">if</span> (bp.perm == p) &#123;</span><br><span class="line">                bp.protectionLevel = p.info.protectionLevel;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) Log.d(TAG, <span class="string">"  Permissions: "</span> + r);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        N = pkg.instrumentation.size();</span><br><span class="line">        r = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">            ... ... ... ...<span class="comment">// 这里省略掉，暂时不看！</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_PACKAGE_SCANNING) Log.d(TAG, <span class="string">"  Instrumentation: "</span> + r);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 处理该 Package 中的 protectedBroadcasts 信息！</span></span><br><span class="line">        <span class="keyword">if</span> (pkg.protectedBroadcasts != <span class="keyword">null</span>) &#123;</span><br><span class="line">            N = pkg.protectedBroadcasts.size();</span><br><span class="line">            <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">                mProtectedBroadcasts.add(pkg.protectedBroadcasts.get(i));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        pkgSetting.setTimeStamp(scanFileTime);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Create idmap files for pairs of (packages, overlay packages).</span></span><br><span class="line">        <span class="comment">// Note: "android", ie framework-res.apk, is handled by native layers.</span></span><br><span class="line">        <span class="keyword">if</span> (pkg.mOverlayTarget != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// This is an overlay package.</span></span><br><span class="line">            <span class="keyword">if</span> (pkg.mOverlayTarget != <span class="keyword">null</span> &amp;&amp; !pkg.mOverlayTarget.equals(<span class="string">"android"</span>)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!mOverlays.containsKey(pkg.mOverlayTarget)) &#123;</span><br><span class="line">                    mOverlays.put(pkg.mOverlayTarget,</span><br><span class="line">                            <span class="keyword">new</span> ArrayMap&lt;String, PackageParser.Package&gt;());</span><br><span class="line">                &#125;</span><br><span class="line">                ArrayMap&lt;String, PackageParser.Package&gt; map = mOverlays.get(pkg.mOverlayTarget);</span><br><span class="line">                map.put(pkg.packageName, pkg);</span><br><span class="line">                PackageParser.Package orig = mPackages.get(pkg.mOverlayTarget);</span><br><span class="line">                <span class="keyword">if</span> (orig != <span class="keyword">null</span> &amp;&amp; !createIdmapForPackagePairLI(orig, pkg)) &#123;</span><br><span class="line">                    createIdmapFailed = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mOverlays.containsKey(pkg.packageName) &amp;&amp;</span><br><span class="line">                !pkg.packageName.equals(<span class="string">"android"</span>)) &#123;</span><br><span class="line">            <span class="comment">// This is a regular package, with one or more known overlay packages.</span></span><br><span class="line">            createIdmapsForPackageLI(pkg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Trace.traceEnd(TRACE_TAG_PACKAGE_MANAGER);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (createIdmapFailed) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(INSTALL_FAILED_UPDATE_INCOMPATIBLE,</span><br><span class="line">                <span class="string">"scanPackageLI failed to createIdmap"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> pkg;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里会将解析到的 Packages 和 PackageSetting 添加到对应的集合中！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//【important】将新创建或者更新后的 PackageSetting 重新添加到 mSettings 中！</span></span><br><span class="line">mSettings.insertPackageSettingLPw(pkgSetting, pkg);</span><br><span class="line"><span class="comment">//【important】将本次扫描的 Package 添加到 PMS.mPackages 中去！</span></span><br><span class="line">mPackages.put(pkg.applicationInfo.packageName, pkg);</span><br></pre></td></tr></table></figure>
<h1 id="8-更新权限信息"><a href="#8-更新权限信息" class="headerlink" title="8 更新权限信息"></a>8 更新权限信息</h1><p>在 PMS 的扫描最后阶段 PMS_SCAN_END，会更新权限信息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 如果从我们上次启动，SDK 平台被改变了，我们需要重新授予应用程序权限。</span></span><br><span class="line"><span class="comment">// 这里会有一些安全问题，就是可能会有应用通过这种方式获取那些用户没有显式允许的权限</span></span><br><span class="line"><span class="comment">// 这里可能后续 google 会改善！</span></span><br><span class="line"><span class="keyword">int</span> updateFlags = UPDATE_PERMISSIONS_ALL;</span><br><span class="line"><span class="keyword">if</span> (ver.sdkVersion != mSdkVersion) &#123;</span><br><span class="line">    Slog.i(TAG, <span class="string">"Platform changed from "</span> + ver.sdkVersion + <span class="string">" to "</span></span><br><span class="line">            + mSdkVersion + <span class="string">"; regranting permissions for internal storage"</span>);</span><br><span class="line">    updateFlags |= UPDATE_PERMISSIONS_REPLACE_PKG | UPDATE_PERMISSIONS_REPLACE_ALL;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//【1】更新系统中的权限和权限树，移除无效的权限和权限树，同时更新应用的权限授予情况！</span></span><br><span class="line">updatePermissionsLPw(<span class="keyword">null</span>, <span class="keyword">null</span>, StorageManager.UUID_PRIVATE_INTERNAL, updateFlags);</span><br></pre></td></tr></table></figure>
<p>这里的最重要的方法是 updatePermissionsLPw 方法：</p>
<h2 id="8-1-PMS-updatePermissionsLPw"><a href="#8-1-PMS-updatePermissionsLPw" class="headerlink" title="8.1 PMS.updatePermissionsLPw"></a>8.1 PMS.updatePermissionsLPw</h2><p>String changingPkg 表示指定的权限发生变化的 package name，可以为 null; PackageParser.Package pkgInfo 表示该 package 的解析信息！</p>
<p>这里的 replaceVolumeUuid 传入的是 StorageManager.UUID_PRIVATE_INTERNAL！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updatePermissionsLPw</span><span class="params">(String changingPkg,</span></span></span><br><span class="line"><span class="function"><span class="params">        PackageParser.Package pkgInfo, String replaceVolumeUuid, <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】确保系统中没有失效的权限树；</span></span><br><span class="line">    Iterator&lt;BasePermission&gt; it = mSettings.mPermissionTrees.values().iterator();</span><br><span class="line">    <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">        <span class="keyword">final</span> BasePermission bp = it.next();</span><br><span class="line">        <span class="keyword">if</span> (bp.packageSetting == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 如果 packageSetting 为 null，尝试查找定义的 package！</span></span><br><span class="line">            bp.packageSetting = mSettings.mPackages.get(bp.sourcePackage);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【1.1】如果找不到定义该权限树的 package，那就移除该 permission-tree！</span></span><br><span class="line">        <span class="keyword">if</span> (bp.packageSetting == <span class="keyword">null</span>) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Removing dangling permission tree: "</span> + bp.name</span><br><span class="line">                    + <span class="string">" from package "</span> + bp.sourcePackage);</span><br><span class="line">            it.remove();</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (changingPkg != <span class="keyword">null</span> &amp;&amp; changingPkg.equals(bp.sourcePackage)) &#123;</span><br><span class="line">            <span class="comment">// 根据参数，不进入这里，但是我们来分析下这部分代码的意思</span></span><br><span class="line">            <span class="comment">// 如果权限的定义者不在定义这个权限了，那就移除该权限的上一次信息！</span></span><br><span class="line">            <span class="keyword">if</span> (pkgInfo == <span class="keyword">null</span> || !hasPermission(pkgInfo, bp.name)) &#123;</span><br><span class="line">                Slog.i(TAG, <span class="string">"Removing old permission tree: "</span> + bp.name</span><br><span class="line">                        + <span class="string">" from package "</span> + bp.sourcePackage);</span><br><span class="line">                flags |= UPDATE_PERMISSIONS_ALL;</span><br><span class="line">                it.remove();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】确保系统中所有的动态权限都已经分配给对应的 package，同时系统中也没有失效的权限!</span></span><br><span class="line">    it = mSettings.mPermissions.values().iterator();</span><br><span class="line">    <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">        <span class="keyword">final</span> BasePermission bp = it.next();</span><br><span class="line">        <span class="comment">//【2.1】如果是动态权限，尝试找到其所属的 permission-tree，并绑定到定义了 tree 的 package 上！</span></span><br><span class="line">        <span class="keyword">if</span> (bp.type == BasePermission.TYPE_DYNAMIC) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_SETTINGS) Log.v(TAG, <span class="string">"Dynamic permission: name="</span></span><br><span class="line">                    + bp.name + <span class="string">" pkg="</span> + bp.sourcePackage</span><br><span class="line">                    + <span class="string">" info="</span> + bp.pendingInfo);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (bp.packageSetting == <span class="keyword">null</span> &amp;&amp; bp.pendingInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">final</span> BasePermission tree = findPermissionTreeLP(bp.name);</span><br><span class="line">                <span class="keyword">if</span> (tree != <span class="keyword">null</span> &amp;&amp; tree.perm != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    bp.packageSetting = tree.packageSetting;</span><br><span class="line">                    bp.perm = <span class="keyword">new</span> PackageParser.Permission(tree.perm.owner,</span><br><span class="line">                            <span class="keyword">new</span> PermissionInfo(bp.pendingInfo));</span><br><span class="line">                    bp.perm.info.packageName = tree.perm.info.packageName;</span><br><span class="line">                    bp.perm.info.name = bp.name;</span><br><span class="line">                    bp.uid = tree.uid;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2.2】如果权限的定义者为 null，尝试在系统中找到定义者！</span></span><br><span class="line">        <span class="keyword">if</span> (bp.packageSetting == <span class="keyword">null</span>) &#123;</span><br><span class="line">            bp.packageSetting = mSettings.mPackages.get(bp.sourcePackage);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【2.3】如果依然找不到定义该权限的 package，那就移除该 permission ！</span></span><br><span class="line">        <span class="keyword">if</span> (bp.packageSetting == <span class="keyword">null</span>) &#123; <span class="comment">// 该权限无效，移除它！</span></span><br><span class="line">            Slog.w(TAG, <span class="string">"Removing dangling permission: "</span> + bp.name</span><br><span class="line">                    + <span class="string">" from package "</span> + bp.sourcePackage);</span><br><span class="line">            it.remove();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (changingPkg != <span class="keyword">null</span> &amp;&amp; changingPkg.equals(bp.sourcePackage)) &#123; </span><br><span class="line">            <span class="comment">// 根据参数，不进入这里，但是我们来分析下这部分代码的意思</span></span><br><span class="line">            <span class="comment">// 如果权限的定义者不在定义这个权限了，那就移除该权限的上一次信息！</span></span><br><span class="line">            <span class="keyword">if</span> (pkgInfo == <span class="keyword">null</span> || !hasPermission(pkgInfo, bp.name)) &#123;</span><br><span class="line">                Slog.i(TAG, <span class="string">"Removing old permission: "</span> + bp.name</span><br><span class="line">                        + <span class="string">" from package "</span> + bp.sourcePackage);</span><br><span class="line">                flags |= UPDATE_PERMISSIONS_ALL;</span><br><span class="line">                it.remove();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】如果 flags 设置了 UPDATE_PERMISSIONS_ALL 标志位，那么就更新除了 changingPkg 以外的其他</span></span><br><span class="line">    <span class="comment">// 所有的 package 的权限授予信息 ，特别是替换系统包的授予权限！</span></span><br><span class="line">    <span class="keyword">if</span> ((flags &amp; UPDATE_PERMISSIONS_ALL) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (PackageParser.Package pkg : mPackages.values()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (pkg != pkgInfo) &#123;</span><br><span class="line">                <span class="keyword">final</span> String volumeUuid = getVolumeUuidForPackage(pkg);</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">boolean</span> replace = ((flags &amp; UPDATE_PERMISSIONS_REPLACE_ALL) != <span class="number">0</span>)</span><br><span class="line">                        &amp;&amp; Objects.equals(replaceVolumeUuid, volumeUuid);</span><br><span class="line">                <span class="comment">//【3.1】重新授予权限！</span></span><br><span class="line">                grantPermissionsLPw(pkg, replace, changingPkg);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【4】因为这里 pkgInfo 为 null，所以不进入这里！</span></span><br><span class="line">    <span class="comment">// 这里的逻辑是，如果 changingPkg 不为 null，最后也会更新其权限的授予信息！</span></span><br><span class="line">    <span class="keyword">if</span> (pkgInfo != <span class="keyword">null</span>) &#123; </span><br><span class="line">        <span class="comment">// Only replace for packages on requested volume</span></span><br><span class="line">        <span class="keyword">final</span> String volumeUuid = getVolumeUuidForPackage(pkgInfo);</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> replace = ((flags &amp; UPDATE_PERMISSIONS_REPLACE_PKG) != <span class="number">0</span>)</span><br><span class="line">                &amp;&amp; Objects.equals(replaceVolumeUuid, volumeUuid);</span><br><span class="line">        grantPermissionsLPw(pkgInfo, replace, changingPkg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里就分析到这里！</p>
<h1 id="9-持久化权限相关信息"><a href="#9-持久化权限相关信息" class="headerlink" title="9 持久化权限相关信息"></a>9 持久化权限相关信息</h1><p>核心方法是在 Settings.writeLPr 中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Settings.writeLPr</span><br></pre></td></tr></table></figure>
<p>下面我们来看下：</p>
<h2 id="9-1-Settings-writeLPr"><a href="#9-1-Settings-writeLPr" class="headerlink" title="9.1 Settings.writeLPr"></a>9.1 Settings.writeLPr</h2><p>将解析到的安装数据写回到 packages.xml 等文件中！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">writeLPr</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Debug.startMethodTracing(<span class="string">"/data/system/packageprof"</span>, <span class="number">8</span> * <span class="number">1024</span> * <span class="number">1024</span>);</span><br><span class="line">    <span class="comment">//【1】下面会先将最新的数据写入到 packages-backup.xml 文件中！</span></span><br><span class="line">    <span class="keyword">if</span> (mSettingsFilename.exists()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mBackupSettingsFilename.exists()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mSettingsFilename.renameTo(mBackupSettingsFilename)) &#123;</span><br><span class="line">                Slog.wtf(PackageManagerService.TAG,</span><br><span class="line">                        <span class="string">"Unable to backup package manager settings, "</span></span><br><span class="line">                        + <span class="string">" current changes will be lost at reboot"</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mSettingsFilename.delete();</span><br><span class="line">            Slog.w(PackageManagerService.TAG, <span class="string">"Preserving older settings backup"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mPastSignatures.clear();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        FileOutputStream fstr = <span class="keyword">new</span> FileOutputStream(mSettingsFilename);</span><br><span class="line">        BufferedOutputStream str = <span class="keyword">new</span> BufferedOutputStream(fstr);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//XmlSerializer serializer = XmlUtils.serializerInstance();</span></span><br><span class="line">        XmlSerializer serializer = <span class="keyword">new</span> FastXmlSerializer();</span><br><span class="line">        serializer.setOutput(str, StandardCharsets.UTF_8.name());</span><br><span class="line">        serializer.startDocument(<span class="keyword">null</span>, <span class="keyword">true</span>);</span><br><span class="line">        serializer.setFeature(<span class="string">"http://xmlpull.org/v1/doc/features.html#indent-output"</span>, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        serializer.startTag(<span class="keyword">null</span>, <span class="string">"packages"</span>); <span class="comment">//【2】写入 "packages"！</span></span><br><span class="line"></span><br><span class="line">        ... ... ... ...</span><br><span class="line"></span><br><span class="line">        serializer.startTag(<span class="keyword">null</span>, <span class="string">"permission-trees"</span>); <span class="comment">//【3】写入 "permission-trees"</span></span><br><span class="line">        <span class="keyword">for</span> (BasePermission bp : mPermissionTrees.values()) &#123;</span><br><span class="line">            writePermissionLPr(serializer, bp);</span><br><span class="line">        &#125;</span><br><span class="line">        serializer.endTag(<span class="keyword">null</span>, <span class="string">"permission-trees"</span>);</span><br><span class="line"></span><br><span class="line">        serializer.startTag(<span class="keyword">null</span>, <span class="string">"permissions"</span>); <span class="comment">//【4】写入 "permissions"</span></span><br><span class="line">        <span class="keyword">for</span> (BasePermission bp : mPermissions.values()) &#123;</span><br><span class="line">            writePermissionLPr(serializer, bp);</span><br><span class="line">        &#125;</span><br><span class="line">        serializer.endTag(<span class="keyword">null</span>, <span class="string">"permissions"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> PackageSetting pkg : mPackages.values()) &#123; <span class="comment">//【5】写入 "package"</span></span><br><span class="line">            writePackageLPr(serializer, pkg);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> PackageSetting pkg : mDisabledSysPackages.values()) &#123; <span class="comment">//【6】写入 "updated-package"</span></span><br><span class="line">            writeDisabledSysPackageLPr(serializer, pkg);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> SharedUserSetting usr : mSharedUsers.values()) &#123; <span class="comment">//【7】写入 "shared-user"</span></span><br><span class="line">            serializer.startTag(<span class="keyword">null</span>, <span class="string">"shared-user"</span>);</span><br><span class="line">            serializer.attribute(<span class="keyword">null</span>, ATTR_NAME, usr.name);</span><br><span class="line">            serializer.attribute(<span class="keyword">null</span>, <span class="string">"userId"</span>,</span><br><span class="line">                    Integer.toString(usr.userId));</span><br><span class="line">            usr.signatures.writeXml(serializer, <span class="string">"sigs"</span>, mPastSignatures);</span><br><span class="line">            <span class="comment">// 写入 shared-user 的安装时权限！</span></span><br><span class="line">            writePermissionsLPr(serializer, usr.getPermissionsState()</span><br><span class="line">                    .getInstallPermissionStates());</span><br><span class="line">            serializer.endTag(<span class="keyword">null</span>, <span class="string">"shared-user"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ... ... ...</span><br><span class="line"></span><br><span class="line">        serializer.endTag(<span class="keyword">null</span>, <span class="string">"packages"</span>); <span class="comment">// 结束 packages-backup.xml 文件的写入！</span></span><br><span class="line"></span><br><span class="line">        ... ... ... ...</span><br><span class="line"></span><br><span class="line">        writePackageListLPr(); <span class="comment">// 写入 packageslist 文件！</span></span><br><span class="line">        writeAllUsersPackageRestrictionsLPr(); <span class="comment">// 写入偏好设置信息；</span></span><br><span class="line">        writeAllRuntimePermissionsLPr(); <span class="comment">//【8】写入运行时权限授予信息！</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span>(XmlPullParserException e) &#123;</span><br><span class="line">        Slog.wtf(PackageManagerService.TAG, <span class="string">"Unable to write package manager settings, "</span></span><br><span class="line">                + <span class="string">"current changes will be lost at reboot"</span>, e);</span><br><span class="line">    &#125; <span class="keyword">catch</span>(java.io.IOException e) &#123;</span><br><span class="line">        Slog.wtf(PackageManagerService.TAG, <span class="string">"Unable to write package manager settings, "</span></span><br><span class="line">                + <span class="string">"current changes will be lost at reboot"</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Clean up partially written files</span></span><br><span class="line">    <span class="keyword">if</span> (mSettingsFilename.exists()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mSettingsFilename.delete()) &#123;</span><br><span class="line">            Slog.wtf(PackageManagerService.TAG, <span class="string">"Failed to clean up mangled file: "</span></span><br><span class="line">                    + mSettingsFilename);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里我们可以看到，整个的写入顺序！</p>
<h1 id="10-默认运行时权限授予"><a href="#10-默认运行时权限授予" class="headerlink" title="10 默认运行时权限授予"></a>10 默认运行时权限授予</h1><p>在开机的最后阶段，PMS 会通过 DefaultPermissionGrantPolicy.grantDefaultPermissions 方法来默认授予一些系统应用运行所必须的系统权限</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> userId : grantPermissionsUserIds) &#123;</span><br><span class="line">    mDefaultPermissionPolicy.grantDefaultPermissions(userId);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 如果没有默认授予运行时权限给指定的 userId，那么我们会直接读取 default-permissions 目录中的文件</span></span><br><span class="line"><span class="comment">// 初始化 mGrantExceptions，和上面的过程类似，不关注！</span></span><br><span class="line"><span class="keyword">if</span> (grantPermissionsUserIds == EMPTY_INT_ARRAY) &#123;</span><br><span class="line">    mDefaultPermissionPolicy.scheduleReadDefaultPermissionExceptions();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2017/05/09/Permission第 1 篇 - Permission 配置和解析/">Permission第 1 篇 - Permission 配置和解析</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2017-05-09</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/AndroidFramework源码分析/">AndroidFramework源码分析</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/AndroidFramework源码分析/Permission权限管理/">Permission权限管理</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/Permission权限管理/">Permission权限管理</a></span><div class="content"><p>[toc]</p>
<h1 id="0-综述"><a href="#0-综述" class="headerlink" title="0 综述"></a>0 综述</h1><p>基于 Android 7.1.1，分析权限管理相关知识，下面关于 xml 配置的内容来自于 Android developer 文档，在加上我自身的理解！</p>
<h1 id="1-Application-的权限配置和解析"><a href="#1-Application-的权限配置和解析" class="headerlink" title="1 Application 的权限配置和解析"></a>1 Application 的权限配置和解析</h1><h2 id="1-1-权限配置"><a href="#1-1-权限配置" class="headerlink" title="1.1 权限配置"></a>1.1 权限配置</h2><h3 id="1-1-1-manifest-配置"><a href="#1-1-1-manifest-配置" class="headerlink" title="1.1.1 manifest 配置"></a>1.1.1 manifest 配置</h3><p>和 Application 权限相关配置相关的内容主要有 2 部分：</p>
<ul>
<li>一个是在 <code>&lt;manifest&gt;&lt;/manifest&gt;</code> 中定义的和权限相关的配置；</li>
<li>一个是在 <code>&lt;application&gt;&lt;/application&gt;</code> 中定义的和权限相关的配置；</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">"string"</span></span></span><br><span class="line"><span class="tag">                 <span class="attr">android:maxSdkVersion</span>=<span class="string">"integer"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">permission</span> <span class="attr">android:description</span>=<span class="string">"string resource"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:icon</span>=<span class="string">"drawable resource"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:label</span>=<span class="string">"string resource"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:name</span>=<span class="string">"string"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:permissionFlags</span>=<span class="string">"[costsMoney | removed | installed ]"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:permissionGroup</span>=<span class="string">"string"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:protectionLevel</span>=<span class="string">"[normal | dangerous | signature | ...]"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">permission-tree</span> <span class="attr">android:icon</span>=<span class="string">"drawable resource"</span></span></span><br><span class="line"><span class="tag">                 <span class="attr">android:label</span>=<span class="string">"string resource"</span></span></span><br><span class="line"><span class="tag">                 <span class="attr">android:name</span>=<span class="string">"string"</span> /&gt;</span></span><br><span class="line">                 </span><br><span class="line"><span class="tag">&lt;<span class="name">permission-group</span> <span class="attr">android:description</span>=<span class="string">"string resource"</span></span></span><br><span class="line"><span class="tag">                  <span class="attr">android:icon</span>=<span class="string">"drawable resource"</span></span></span><br><span class="line"><span class="tag">                  <span class="attr">android:label</span>=<span class="string">"string resource"</span></span></span><br><span class="line"><span class="tag">                  <span class="attr">android:name</span>=<span class="string">"string"</span> </span></span><br><span class="line"><span class="tag">                  <span class="attr">android:parsePermissionGroup</span>=<span class="string">"string"</span></span></span><br><span class="line"><span class="tag">                  <span class="attr">android:priority</span>=<span class="string">"string"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>下面我们来解释一下，每个标签的意思：</p>
<ul>
<li><strong>uses-permission</strong></li>
</ul>
<p>用来申请应用要使用的权限，包括安装时权限和运行时权限！</p>
<table>
<thead>
<tr>
<th>属性名</th>
<th style="text-align:left">解释</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>android:name</strong></td>
<td style="text-align:left">表示申请的权限名，可以是应用自身通过 <code>&lt;permission&gt;</code> 元素定义的权限、另一个应用定义的权限，或者一个标准系统权限！</td>
</tr>
<tr>
<td><strong>android:maxSdkVersion</strong></td>
<td style="text-align:left">不常用，表示应用需要申请该权限的最高 API 级别，高于这个值就无需申请权限！</td>
</tr>
</tbody>
</table>
<ul>
<li><strong>permission</strong></li>
</ul>
<p>声明一个权限，可用于限制对此应用程序或其他应用程序的特定组件或功能的访问。</p>
<table>
<thead>
<tr>
<th>属性名</th>
<th style="text-align:left">解释</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>android:description</strong></td>
<td style="text-align:left">用于显示给用户的权限描述，解释权限</td>
</tr>
<tr>
<td><strong>android:icon</strong></td>
<td style="text-align:left">表示权限的图标</td>
</tr>
<tr>
<td><strong>android:label</strong></td>
<td style="text-align:left">权限的可视化名称，用于显示给用户</td>
</tr>
<tr>
<td><strong>android:name</strong></td>
<td style="text-align:left">权限的名称，用于在代码中引用该权限，例如， <code>&lt;uses-permission&gt;</code> 元素，应用组件的 <code>android:permission</code> 属性</td>
</tr>
<tr>
<td><strong>android:permissionFlags</strong></td>
<td style="text-align:left">权限的额外标志位</td>
</tr>
<tr>
<td><strong>android:permissionGroup</strong></td>
<td style="text-align:left">权限所属权限组的名称，必须是此应用程序或其他应用程序中的 <code>&lt;permission-group&gt;</code> 元素声明的组名 。如果未设置此属性，则权限不属于组</td>
</tr>
<tr>
<td><strong>android:protectionLevel</strong></td>
<td style="text-align:left">权限保护级别，每个保护级别由基本权限类型和零个或多个标志组成。例如，”dangerous”保护级别没有标志。相反，保护级别 “signature\</td>
<td>privileged” 是”signature”基本权限类型和 “privileged”标志的组合。</td>
</tr>
</tbody>
</table>
<p>以上就是和 permission 相关的配置！</p>
<ul>
<li><strong>permission-group</strong></li>
</ul>
<p>为相关权限的逻辑分组声明一个名称。权限通过其 android:permissionGroup 属性加入权限组。权限组的所有权限会在用户界面中一起呈现。</p>
<p>其本身并未声明权限，只是申明了一个可以放置权限的类别。</p>
<table>
<thead>
<tr>
<th>属性名</th>
<th style="text-align:left">解释</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>android:description</strong></td>
<td style="text-align:left">用于显示给用户的组描述</td>
</tr>
<tr>
<td><strong>android:icon</strong></td>
<td style="text-align:left">表示权限组的图标</td>
</tr>
<tr>
<td><strong>android:label</strong></td>
<td style="text-align:left">权限组的可视化名称，用于显示给用户</td>
</tr>
<tr>
<td><strong>android:name</strong></td>
<td style="text-align:left">组的名称，用于在代码中引用该权限组，例如， <code>&lt;permission&gt;</code> 的 <code>android:android:permissionGroup</code> 属性</td>
</tr>
</tbody>
</table>
<p>继续来看：</p>
<ul>
<li><strong>permission-tree</strong></li>
</ul>
<p>权限树和权限组很类似，该标签用于声明权限树的基本名称，定义了权限树的应用程序拥有权限树名称的所有权，可以调用 PackageManager.addPermission() 向树中动态添加权限！</p>
<p>此元素本身并未声明权限，只是定义了可以动态放置权限的名称空间。</p>
<table>
<thead>
<tr>
<th>属性名</th>
<th style="text-align:left">解释</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>android:icon</strong></td>
<td style="text-align:left">表示树中所有权限的图标；</td>
</tr>
<tr>
<td><strong>android:label</strong></td>
<td style="text-align:left">用户可读的组名称；</td>
</tr>
<tr>
<td><strong>android:name</strong></td>
<td style="text-align:left">权限树的名称，为树中所有权限名称的前缀，用于在代码中引用该权限组，该名称的路径中必须包含至少两个以句点分隔的段</td>
</tr>
</tbody>
</table>
<h3 id="1-1-2-application-配置"><a href="#1-1-2-application-配置" class="headerlink" title="1.1.2 application 配置"></a>1.1.2 application 配置</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">application</span></span></span><br><span class="line"><span class="tag">       <span class="attr">android:permission</span>=<span class="string">""</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li><strong>android:permission</strong></li>
</ul>
<p>permission 属性表示访问该 application 应该具有的权限！</p>
<h2 id="1-2-权限解析"><a href="#1-2-权限解析" class="headerlink" title="1.2 权限解析"></a>1.2 权限解析</h2><p>下面，我们深入到 PMS 中，看下 Application 权限信息是如何解析的，这部分从两方面来看：</p>
<ul>
<li>manifest 的属性配置解析；</li>
<li>application 的属性配置解析；</li>
</ul>
<h3 id="1-2-1-PackageParser-parseBaseApkCommon"><a href="#1-2-1-PackageParser-parseBaseApkCommon" class="headerlink" title="1.2.1 PackageParser.parseBaseApkCommon"></a>1.2.1 PackageParser.parseBaseApkCommon</h3><p>我们先来看看 manifest 的属性配置解析！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Package <span class="title">parseBaseApkCommon</span><span class="params">(Package pkg, Set&lt;String&gt; acceptedTags, Resources res,</span></span></span><br><span class="line"><span class="function"><span class="params">        XmlResourceParser parser, <span class="keyword">int</span> flags, String[] outError)</span> <span class="keyword">throws</span> XmlPullParserException,</span></span><br><span class="line"><span class="function">        IOException </span>&#123;</span><br><span class="line">    ... ... ... ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> outerDepth = parser.getDepth();</span><br><span class="line">    <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">            &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String tagName = parser.getName();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (acceptedTags != <span class="keyword">null</span> &amp;&amp; !acceptedTags.contains(tagName)) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Skipping unsupported element under &lt;manifest&gt;: "</span></span><br><span class="line">                    + tagName + <span class="string">" at "</span> + mArchiveSourcePath + <span class="string">" "</span></span><br><span class="line">                    + parser.getPositionDescription());</span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (tagName.equals(TAG_APPLICATION)) &#123; <span class="comment">//【1】解析 application 标签属性！</span></span><br><span class="line">            <span class="keyword">if</span> (foundApp) &#123;</span><br><span class="line">                <span class="keyword">if</span> (RIGID_PARSER) &#123;</span><br><span class="line">                    outError[<span class="number">0</span>] = <span class="string">"&lt;manifest&gt; has more than one &lt;application&gt;"</span>;</span><br><span class="line">                    mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"&lt;manifest&gt; has more than one &lt;application&gt;"</span>);</span><br><span class="line">                    XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            foundApp = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【*1.2.2】调用 parseBaseApplication 解析 application 属性！</span></span><br><span class="line">            <span class="keyword">if</span> (!parseBaseApplication(pkg, res, parser, flags, outError)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">        </span><br><span class="line">            ... ... ...</span><br><span class="line">        </span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_PERMISSION_GROUP)) &#123;</span><br><span class="line">            <span class="comment">//【*1.2.1.1】解析 permission-group 标签属性</span></span><br><span class="line">            <span class="keyword">if</span> (parsePermissionGroup(pkg, flags, res, parser, outError) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_PERMISSION)) &#123;</span><br><span class="line">            <span class="comment">//【*1.2.1.2】解析 permission 标签属性</span></span><br><span class="line">            <span class="keyword">if</span> (parsePermission(pkg, res, parser, outError) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_PERMISSION_TREE)) &#123; </span><br><span class="line">            <span class="comment">//【*1.2.1.3】解析 permission-tree 标签属性</span></span><br><span class="line">            <span class="keyword">if</span> (parsePermissionTree(pkg, res, parser, outError) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_USES_PERMISSION)) &#123;</span><br><span class="line">            <span class="comment">//【*1.2.1.4】解析 uses-permission 标签属性</span></span><br><span class="line">            <span class="keyword">if</span> (!parseUsesPermission(pkg, res, parser)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_USES_PERMISSION_SDK_M)</span><br><span class="line">                || tagName.equals(TAG_USES_PERMISSION_SDK_23)) &#123; </span><br><span class="line">            <span class="comment">//【*1.2.1.4】解析 uses-permission-sdk-m/23 标签属性</span></span><br><span class="line">            <span class="keyword">if</span> (!parseUsesPermission(pkg, res, parser)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">        </span><br><span class="line">            ... ... ... ...</span><br><span class="line">        </span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(TAG_ADOPT_PERMISSIONS)) &#123;</span><br><span class="line">            <span class="comment">//【2】解析 adopt-permissions 标签</span></span><br><span class="line">            sa = res.obtainAttributes(parser, <span class="comment">// 解析源包属性</span></span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestOriginalPackage);</span><br><span class="line"></span><br><span class="line">            String name = sa.getNonConfigurationString( <span class="comment">// 解析权限名属性</span></span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestOriginalPackage_name, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            sa.recycle();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (name != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">//【2.1】加入到 Package.mAdoptPermissions 集合中！</span></span><br><span class="line">                <span class="keyword">if</span> (pkg.mAdoptPermissions == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    pkg.mAdoptPermissions = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">                &#125;</span><br><span class="line">                pkg.mAdoptPermissions.add(name);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">        </span><br><span class="line">            ... ... ... ...</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ... ... ... ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】处理一些新添加的权限，如果当前应用的 targetSdkVersion 小于这些权限的 sdkVersion！</span></span><br><span class="line">    <span class="comment">// 我们会默认将其添加到 Package.requestedPermissions 中！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> NP = PackageParser.NEW_PERMISSIONS.length;</span><br><span class="line">    StringBuilder implicitPerms = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> ip = <span class="number">0</span>; ip &lt; NP; ip++) &#123;</span><br><span class="line">        <span class="keyword">final</span> PackageParser.NewPermissionInfo npi</span><br><span class="line">                = PackageParser.NEW_PERMISSIONS[ip];</span><br><span class="line">        <span class="comment">//【3.1】如果应用的 target SDK Version 高于权限的该权限的 version，不做处理</span></span><br><span class="line">        <span class="keyword">if</span> (pkg.applicationInfo.targetSdkVersion &gt;= npi.sdkVersion) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!pkg.requestedPermissions.contains(npi.name)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (implicitPerms == <span class="keyword">null</span>) &#123;</span><br><span class="line">                implicitPerms = <span class="keyword">new</span> StringBuilder(<span class="number">128</span>);</span><br><span class="line">                implicitPerms.append(pkg.packageName);</span><br><span class="line">                implicitPerms.append(<span class="string">": compat added "</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                implicitPerms.append(<span class="string">' '</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            implicitPerms.append(npi.name);</span><br><span class="line">            pkg.requestedPermissions.add(npi.name);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (implicitPerms != <span class="keyword">null</span>) &#123;</span><br><span class="line">        Slog.i(TAG, implicitPerms.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【4】处理一些相互依赖的权限，这里除了有 sdkVersion 限制之外，</span></span><br><span class="line">    <span class="comment">// 还有一个判断 rootPerm 是否在 requestedPermissions 列表中的判断 ！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> NS = PackageParser.SPLIT_PERMISSIONS.length;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> is = <span class="number">0</span>; is &lt; NS; is++) &#123;</span><br><span class="line">        <span class="keyword">final</span> PackageParser.SplitPermissionInfo spi</span><br><span class="line">                = PackageParser.SPLIT_PERMISSIONS[is];</span><br><span class="line">        <span class="comment">//【4.1】如果应用的 target SDK Version 高于权限的该权限的 version，不做处理，</span></span><br><span class="line">        <span class="comment">// 或者应用没有请求这个根权限，不用处理！</span></span><br><span class="line">        <span class="keyword">if</span> (pkg.applicationInfo.targetSdkVersion &gt;= spi.targetSdk</span><br><span class="line">                || !pkg.requestedPermissions.contains(spi.rootPerm)) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> in=<span class="number">0</span>; in &lt; spi.newPerms.length; in++) &#123;</span><br><span class="line">            <span class="keyword">final</span> String perm = spi.newPerms[in];</span><br><span class="line">            <span class="keyword">if</span> (!pkg.requestedPermissions.contains(perm)) &#123;</span><br><span class="line">                pkg.requestedPermissions.add(perm);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ... ... ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> pkg;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后，处理了下在指定版本中出现的新权限的添加！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> PackageParser.NewPermissionInfo NEW_PERMISSIONS[] =</span><br><span class="line">    <span class="keyword">new</span> PackageParser.NewPermissionInfo[] &#123;</span><br><span class="line">        <span class="keyword">new</span> PackageParser.NewPermissionInfo(android.Manifest.permission.WRITE_EXTERNAL_STORAGE,</span><br><span class="line">                android.os.Build.VERSION_CODES.DONUT, <span class="number">0</span>),</span><br><span class="line">        <span class="keyword">new</span> PackageParser.NewPermissionInfo(android.Manifest.permission.READ_PHONE_STATE,</span><br><span class="line">                android.os.Build.VERSION_CODES.DONUT, <span class="number">0</span>)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>Build.VERSION_CODES.DONUT 的值为 4，表示 Android 1.6，意思是如果是 Android 1.6 之前话，应用如果没有申请 NEW_PERMISSIONS 的权限，那么我们会默认给他申请，因为我们关注的是 Android 7.1.1 那么这里我们不会进入！</p>
<p>对于 SPLIT_PERMISSIONS 列表中的权限，保存了 root 权限和相互依赖的权限，以及首次出现的平台！</p>
<p>举个例子，如果应用只是申请了 WRITE_EXTERNAL_STORAGE，即使其在 Manifest 中没有申明 READ_EXTERNAL_STORAGE 权限，我们也会将其主动加入到 Package.requestedPermissions！！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> PackageParser.SplitPermissionInfo SPLIT_PERMISSIONS[] =</span><br><span class="line">    <span class="keyword">new</span> PackageParser.SplitPermissionInfo[] &#123;</span><br><span class="line">        <span class="keyword">new</span> PackageParser.SplitPermissionInfo(android.Manifest.permission.WRITE_EXTERNAL_STORAGE,</span><br><span class="line">                <span class="keyword">new</span> String[] &#123; android.Manifest.permission.READ_EXTERNAL_STORAGE &#125;,</span><br><span class="line">                android.os.Build.VERSION_CODES.CUR_DEVELOPMENT+<span class="number">1</span>),</span><br><span class="line">        <span class="keyword">new</span> PackageParser.SplitPermissionInfo(android.Manifest.permission.READ_CONTACTS,</span><br><span class="line">                <span class="keyword">new</span> String[] &#123; android.Manifest.permission.READ_CALL_LOG &#125;,</span><br><span class="line">                android.os.Build.VERSION_CODES.JELLY_BEAN),</span><br><span class="line">        <span class="keyword">new</span> PackageParser.SplitPermissionInfo(android.Manifest.permission.WRITE_CONTACTS,</span><br><span class="line">                <span class="keyword">new</span> String[] &#123; android.Manifest.permission.WRITE_CALL_LOG &#125;,</span><br><span class="line">                android.os.Build.VERSION_CODES.JELLY_BEAN)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>Build.VERSION_CODES.JELLY_BEAN 的值为 16，表示 Android 4.1；</p>
<p>Build.VERSION_CODES.CUR_DEVELOPMENT 值为 10000，表示开发者版本！</p>
<p>这段代码的意思是：如果是 Android 4.1 之前，且应用申请了 SPLIT_PERMISSIONS 中指定的根权限，那么我们也会将其对应的子权限添加到其申请列表中，因为我们关注的是 Android 7.1.1 那么这里我们不会进入！</p>
<h4 id="1-2-1-1-PackageP-parsePermissionGroup"><a href="#1-2-1-1-PackageP-parsePermissionGroup" class="headerlink" title="1.2.1.1 PackageP.parsePermissionGroup"></a>1.2.1.1 PackageP.parsePermissionGroup</h4><p>parsePermissionGroup 用于处理 permission-group 的解析：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> PermissionGroup <span class="title">parsePermissionGroup</span><span class="params">(Package owner, <span class="keyword">int</span> flags, Resources res,</span></span></span><br><span class="line"><span class="function"><span class="params">        XmlResourceParser parser, String[] outError)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</span><br><span class="line">    <span class="comment">//【1】创建 PermissionGroup 对象！</span></span><br><span class="line">    PermissionGroup perm = <span class="keyword">new</span> PermissionGroup(owner);</span><br><span class="line">    TypedArray sa = res.obtainAttributes(parser,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermissionGroup);</span><br><span class="line">    <span class="keyword">if</span> (!parsePackageItemInfo(owner, perm.info, outError,</span><br><span class="line">            <span class="string">"&lt;permission-group&gt;"</span>, sa, <span class="keyword">true</span> <span class="comment">/*nameRequired*/</span>,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermissionGroup_name,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermissionGroup_label,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermissionGroup_icon,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermissionGroup_roundIcon,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermissionGroup_logo,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermissionGroup_banner)) &#123;</span><br><span class="line">        sa.recycle();</span><br><span class="line">        mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    perm.info.descriptionRes = sa.getResourceId(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermissionGroup_description, <span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">     <span class="comment">//【2】解析 permissionGroupFlags 属性；</span></span><br><span class="line">    perm.info.flags = sa.getInt(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermissionGroup_permissionGroupFlags, <span class="number">0</span>);</span><br><span class="line">     <span class="comment">//【3】解析 priority 属性；</span></span><br><span class="line">    perm.info.priority = sa.getInt(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermissionGroup_priority, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【4】只有系统应用才能设置权限组的优先级</span></span><br><span class="line">    <span class="keyword">if</span> (perm.info.priority &gt; <span class="number">0</span> &amp;&amp; (flags &amp; PARSE_IS_SYSTEM) == <span class="number">0</span>) &#123;</span><br><span class="line">        perm.info.priority = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sa.recycle();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!parseAllMetaData(res, parser, <span class="string">"&lt;permission-group&gt;"</span>, perm,</span><br><span class="line">            outError)) &#123;</span><br><span class="line">        mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    owner.permissionGroups.add(perm);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> perm;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>只有系统应用才能设置权限组的优先级！</p>
<p>创建了 PermissionGroup 对象！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">PermissionGroup</span> <span class="keyword">extends</span> <span class="title">Component</span>&lt;<span class="title">IntentInfo</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> PermissionGroupInfo info;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PermissionGroup</span><span class="params">(Package _owner)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(_owner);</span><br><span class="line">        info = <span class="keyword">new</span> PermissionGroupInfo();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PermissionGroup</span><span class="params">(Package _owner, PermissionGroupInfo _info)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(_owner);</span><br><span class="line">        info = _info;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPackageName</span><span class="params">(String packageName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.setPackageName(packageName);</span><br><span class="line">        info.packageName = packageName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"PermissionGroup&#123;"</span></span><br><span class="line">            + Integer.toHexString(System.identityHashCode(<span class="keyword">this</span>))</span><br><span class="line">            + <span class="string">" "</span> + info.name + <span class="string">"&#125;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>最终的解析结果会保存到 Package.permissionGroups 中！</p>
<h4 id="1-2-1-2-PackageP-parsePermission"><a href="#1-2-1-2-PackageP-parsePermission" class="headerlink" title="1.2.1.2 PackageP.parsePermission"></a>1.2.1.2 PackageP.parsePermission</h4><p>parsePermission 用于处理 permission 的解析：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Permission <span class="title">parsePermission</span><span class="params">(Package owner, Resources res,</span></span></span><br><span class="line"><span class="function"><span class="params">        XmlResourceParser parser, String[] outError)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</span><br><span class="line">    <span class="comment">//【1】创建一个 Permission 对象，封装 permission-tree </span></span><br><span class="line">    Permission perm = <span class="keyword">new</span> Permission(owner);</span><br><span class="line"></span><br><span class="line">    TypedArray sa = res.obtainAttributes(parser,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermission);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!parsePackageItemInfo(owner, perm.info, outError,</span><br><span class="line">            <span class="string">"&lt;permission&gt;"</span>, sa, <span class="keyword">true</span> <span class="comment">/*nameRequired*/</span>,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermission_name,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermission_label,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermission_icon,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermission_roundIcon,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermission_logo,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermission_banner)) &#123;</span><br><span class="line">        sa.recycle();</span><br><span class="line">        mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】解析权限所属的组信息！</span></span><br><span class="line">    perm.info.group = sa.getNonResourceString(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermission_permissionGroup);</span><br><span class="line">    <span class="keyword">if</span> (perm.info.group != <span class="keyword">null</span>) &#123;</span><br><span class="line">        perm.info.group = perm.info.group.intern();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    perm.info.descriptionRes = sa.getResourceId(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermission_description,</span><br><span class="line">            <span class="number">0</span>);</span><br><span class="line">    <span class="comment">//【3】解析权限的保护级别，默认为 normal！</span></span><br><span class="line">    perm.info.protectionLevel = sa.getInt(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermission_protectionLevel,</span><br><span class="line">            PermissionInfo.PROTECTION_NORMAL);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【4】解析权限的 flags，默认为 0！</span></span><br><span class="line">    perm.info.flags = sa.getInt(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermission_permissionFlags, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    sa.recycle();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (perm.info.protectionLevel == -<span class="number">1</span>) &#123;</span><br><span class="line">        outError[<span class="number">0</span>] = <span class="string">"&lt;permission&gt; does not specify protectionLevel"</span>;</span><br><span class="line">        mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【5】将 signatureOrSystem 转为 signature|privileged</span></span><br><span class="line">    perm.info.protectionLevel = PermissionInfo.fixProtectionLevel(perm.info.protectionLevel);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【6】这里是检查保护级别的有效性！</span></span><br><span class="line">    <span class="comment">// 如果 protectionLevel 设置了额外的标志位，那么其基本权限类型必须是 signature！！</span></span><br><span class="line">    <span class="keyword">if</span> ((perm.info.protectionLevel &amp; PermissionInfo.PROTECTION_MASK_FLAGS) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((perm.info.protectionLevel &amp; PermissionInfo.PROTECTION_MASK_BASE) !=</span><br><span class="line">                PermissionInfo.PROTECTION_SIGNATURE) &#123;</span><br><span class="line">            outError[<span class="number">0</span>] = <span class="string">"&lt;permission&gt;  protectionLevel specifies a flag but is "</span></span><br><span class="line">                    + <span class="string">"not based on signature type"</span>;</span><br><span class="line">            mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!parseAllMetaData(res, parser, <span class="string">"&lt;permission&gt;"</span>, perm, outError)) &#123; <span class="comment">// 解析 meta-data 属性！</span></span><br><span class="line">        mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    owner.permissions.add(perm);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> perm;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里会涉及到 2 个标志位：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 用于获取基本权限类型</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PROTECTION_MASK_BASE = <span class="number">0xf</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用于获取额外的标志位</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PROTECTION_MASK_FLAGS = <span class="number">0xff0</span>;</span><br></pre></td></tr></table></figure></p>
<p>我们可以通过如下方式获得基本权限类型和附加标志位：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">protectionLevel &amp; PermissionInfo.PROTECTION_MASK_BASE <span class="comment">// 获取基本权限类型；</span></span><br><span class="line">protectionLevel &amp; PermissionInfo.PROTECTION_MASK_FLAGS <span class="comment">// 获取额外的标志位；</span></span><br></pre></td></tr></table></figure></p>
<p>fixProtectionLevel 的意义就是将 signatureOrSystem 转为 signature|privileged 而已！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">fixProtectionLevel</span><span class="params">(<span class="keyword">int</span> level)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (level == PROTECTION_SIGNATURE_OR_SYSTEM) &#123;</span><br><span class="line">        level = PROTECTION_SIGNATURE | PROTECTION_FLAG_PRIVILEGED;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> level;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果 protectionLevel 设置了额外的标志位，那么其基本权限类型必须是 signature！！</p>
<p>解析的结果会封装到一个 Permission 对象中！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Permission</span> <span class="keyword">extends</span> <span class="title">Component</span>&lt;<span class="title">IntentInfo</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> PermissionInfo info; <span class="comment">// 用于保存该权限的信息！</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">boolean</span> tree; <span class="comment">// 是否是权限树，是权限则为 false；</span></span><br><span class="line">    <span class="keyword">public</span> PermissionGroup group;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Permission</span><span class="params">(Package _owner)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(_owner);</span><br><span class="line">        info = <span class="keyword">new</span> PermissionInfo();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Permission</span><span class="params">(Package _owner, PermissionInfo _info)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(_owner);</span><br><span class="line">        info = _info;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPackageName</span><span class="params">(String packageName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.setPackageName(packageName);</span><br><span class="line">        info.packageName = packageName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Permission&#123;"</span></span><br><span class="line">            + Integer.toHexString(System.identityHashCode(<span class="keyword">this</span>))</span><br><span class="line">            + <span class="string">" "</span> + info.name + <span class="string">"&#125;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>最终的解析结果会保存到 Package.permissions 中！</p>
<h4 id="1-2-1-3-PackageP-parsePermissionTree"><a href="#1-2-1-3-PackageP-parsePermissionTree" class="headerlink" title="1.2.1.3 PackageP.parsePermissionTree"></a>1.2.1.3 PackageP.parsePermissionTree</h4><p>parsePermissionTree 用于处理 permission-tree 的解析：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Permission <span class="title">parsePermissionTree</span><span class="params">(Package owner, Resources res,</span></span></span><br><span class="line"><span class="function"><span class="params">        XmlResourceParser parser, String[] outError)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</span><br><span class="line">    <span class="comment">//【1】创建一个 Permission 对象，封装 permission-tree </span></span><br><span class="line">    Permission perm = <span class="keyword">new</span> Permission(owner);</span><br><span class="line"></span><br><span class="line">    TypedArray sa = res.obtainAttributes(parser,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermissionTree);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!parsePackageItemInfo(owner, perm.info, outError,</span><br><span class="line">            <span class="string">"&lt;permission-tree&gt;"</span>, sa, <span class="keyword">true</span> <span class="comment">/*nameRequired*/</span>,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermissionTree_name,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermissionTree_label,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermissionTree_icon,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermissionTree_roundIcon,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermissionTree_logo,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestPermissionTree_banner)) &#123;</span><br><span class="line">        sa.recycle();</span><br><span class="line">        mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sa.recycle();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】校验权限树的名称合法性，必须是至少由两个 “.” 分割开的段！</span></span><br><span class="line">    <span class="keyword">int</span> index = perm.info.name.indexOf(<span class="string">'.'</span>);</span><br><span class="line">    <span class="keyword">if</span> (index &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        index = perm.info.name.indexOf(<span class="string">'.'</span>, index+<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (index &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        outError[<span class="number">0</span>] = <span class="string">"&lt;permission-tree&gt; name has less than three segments: "</span></span><br><span class="line">            + perm.info.name;</span><br><span class="line">        mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    perm.info.descriptionRes = <span class="number">0</span>;</span><br><span class="line">    perm.info.protectionLevel = PermissionInfo.PROTECTION_NORMAL; <span class="comment">// 默认为 nomal</span></span><br><span class="line">    perm.tree = <span class="keyword">true</span>; <span class="comment">// 设置 perm.tree，表示其为权限树！</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!parseAllMetaData(res, parser, <span class="string">"&lt;permission-tree&gt;"</span>, perm,</span><br><span class="line">            outError)) &#123;</span><br><span class="line">        mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    owner.permissions.add(perm);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> perm;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们看到，对于权限树，也是会创建一个 Permission 对象！</p>
<p>最终的解析结果会保存到 Package.permissions 中！</p>
<h4 id="1-2-1-4-PackageP-parseUsesPermission"><a href="#1-2-1-4-PackageP-parseUsesPermission" class="headerlink" title="1.2.1.4 PackageP.parseUsesPermission"></a>1.2.1.4 PackageP.parseUsesPermission</h4><p>parseUsesPermission 用于处理 uses-permission 的解析：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">parseUsesPermission</span><span class="params">(Package pkg, Resources res, XmlResourceParser parser)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</span><br><span class="line">    TypedArray sa = res.obtainAttributes(parser,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestUsesPermission);</span><br><span class="line"></span><br><span class="line">    String name = sa.getNonResourceString( <span class="comment">// 解析 name 属性；</span></span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestUsesPermission_name);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> maxSdkVersion = <span class="number">0</span>;</span><br><span class="line">    TypedValue val = sa.peekValue( <span class="comment">// 解析 maxSdkVersion 属性；</span></span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestUsesPermission_maxSdkVersion);</span><br><span class="line">    <span class="keyword">if</span> (val != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (val.type &gt;= TypedValue.TYPE_FIRST_INT &amp;&amp; val.type &lt;= TypedValue.TYPE_LAST_INT) &#123;</span><br><span class="line">            maxSdkVersion = val.data;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sa.recycle();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((maxSdkVersion == <span class="number">0</span>) || (maxSdkVersion &gt;= Build.VERSION.RESOURCES_SDK_INT)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (name != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> index = pkg.requestedPermissions.indexOf(name);</span><br><span class="line">            <span class="keyword">if</span> (index == -<span class="number">1</span>) &#123;</span><br><span class="line">                <span class="comment">// 将该 package </span></span><br><span class="line">                pkg.requestedPermissions.add(name.intern());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Ignoring duplicate uses-permissions/uses-permissions-sdk-m: "</span></span><br><span class="line">                        + name + <span class="string">" in package: "</span> + pkg.packageName + <span class="string">" at: "</span></span><br><span class="line">                        + parser.getPositionDescription());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    XmlUtils.skipCurrentTag(parser);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最终的解析结果会保存到 Package.requestedPermissions 中！</p>
<h3 id="1-2-2-PackageParser-parseBaseApplication"><a href="#1-2-2-PackageParser-parseBaseApplication" class="headerlink" title="1.2.2 PackageParser.parseBaseApplication"></a>1.2.2 PackageParser.parseBaseApplication</h3><p>我们先来看看 application 的属性配置解析！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">parseBaseApplication</span><span class="params">(Package owner, Resources res,</span></span></span><br><span class="line"><span class="function"><span class="params">        XmlResourceParser parser, <span class="keyword">int</span> flags, String[] outError)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</span><br><span class="line">    <span class="comment">//【1.1】获得 package 的 ApplicationInfo 成员变量，封装 Application 标签的信息</span></span><br><span class="line">    <span class="keyword">final</span> ApplicationInfo ai = owner.applicationInfo;</span><br><span class="line">    <span class="keyword">final</span> String pkgName = owner.applicationInfo.packageName;</span><br><span class="line"></span><br><span class="line">    ... ... ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1.2】解析 android:permission 属性</span></span><br><span class="line">    String str;</span><br><span class="line">    str = sa.getNonConfigurationString(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_permission, <span class="number">0</span>);</span><br><span class="line">    ai.permission = (str != <span class="keyword">null</span> &amp;&amp; str.length() &gt; <span class="number">0</span>) ? str.intern() : <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    ... ... ...</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">            &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; innerDepth)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String tagName = parser.getName();</span><br><span class="line">        <span class="keyword">if</span> (tagName.equals(<span class="string">"activity"</span>)) &#123; <span class="comment">//【2】解析 activity 属性</span></span><br><span class="line">            Activity a = parseActivity(owner, res, parser, flags, outError, <span class="keyword">false</span>,</span><br><span class="line">                    owner.baseHardwareAccelerated);</span><br><span class="line">            <span class="keyword">if</span> (a == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            owner.activities.add(a);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"receiver"</span>)) &#123; <span class="comment">//【3】解析 receiver 属性</span></span><br><span class="line">            Activity a = parseActivity(owner, res, parser, flags, outError, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (a == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            owner.receivers.add(a);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"service"</span>)) &#123; <span class="comment">//【4】解析 service 属性</span></span><br><span class="line">            Service s = parseService(owner, res, parser, flags, outError);</span><br><span class="line">            <span class="keyword">if</span> (s == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            owner.services.add(s);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"provider"</span>)) &#123; <span class="comment">//【5】解析 provider 属性</span></span><br><span class="line">            Provider p = parseProvider(owner, res, parser, flags, outError);</span><br><span class="line">            <span class="keyword">if</span> (p == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            owner.providers.add(p);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">        </span><br><span class="line">            ... ... ...</span><br><span class="line">        </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifySharedLibrariesForBackwardCompatibility(owner);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hasDomainURLs(owner)) &#123;</span><br><span class="line">        owner.applicationInfo.privateFlags |= ApplicationInfo.PRIVATE_FLAG_HAS_DOMAIN_URLS;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        owner.applicationInfo.privateFlags &amp;= ~ApplicationInfo.PRIVATE_FLAG_HAS_DOMAIN_URLS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后，解析的 android:permission 属性会保存到 Provider.ApplicationInfo.permission 中去！</p>
<h1 id="2-Activity-的权限配置和解析"><a href="#2-Activity-的权限配置和解析" class="headerlink" title="2 Activity 的权限配置和解析"></a>2 Activity 的权限配置和解析</h1><h2 id="2-1-权限配置"><a href="#2-1-权限配置" class="headerlink" title="2.1 权限配置"></a>2.1 权限配置</h2><p>在 Activity 中有如下的权限相关配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">android:exported=[&quot;true&quot; | &quot;false&quot;]</span><br><span class="line">android:permission=&quot;string&quot;</span><br></pre></td></tr></table></figure>
<ul>
<li>exported 属性</li>
</ul>
<p>exported 属性决定了该 activity 是否暴露给其他应用！</p>
<ul>
<li>permission 属性</li>
</ul>
<p>permission 属性表示启动该 activity 应该具有的权限</p>
<h2 id="2-2-权限解析"><a href="#2-2-权限解析" class="headerlink" title="2.2 权限解析"></a>2.2 权限解析</h2><h3 id="2-2-1-PackageParser-parseActivity"><a href="#2-2-1-PackageParser-parseActivity" class="headerlink" title="2.2.1 PackageParser.parseActivity"></a>2.2.1 PackageParser.parseActivity</h3><p>Activity 使用是 parseActivity 方法解析，对于 Activity，boolean receiver 取值为 false：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Activity <span class="title">parseActivity</span><span class="params">(Package owner, Resources res,</span></span></span><br><span class="line"><span class="function"><span class="params">        XmlResourceParser parser, <span class="keyword">int</span> flags, String[] outError,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> receiver, <span class="keyword">boolean</span> hardwareAccelerated)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</span><br><span class="line">    ... ... ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】创建了一个 Activity 对象，表示 Receiver  组件，创建了 ActivityInfo 对象，封装 Receiver 信息！</span></span><br><span class="line">    Activity a = <span class="keyword">new</span> Activity(mParseActivityArgs, <span class="keyword">new</span> ActivityInfo());</span><br><span class="line">    <span class="keyword">if</span> (outError[<span class="number">0</span>] != <span class="keyword">null</span>) &#123;</span><br><span class="line">        sa.recycle();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【2】解析 android:exported 属性！</span></span><br><span class="line">    <span class="keyword">boolean</span> setExported = sa.hasValue(R.styleable.AndroidManifestActivity_exported);</span><br><span class="line">    <span class="keyword">if</span> (setExported) &#123;</span><br><span class="line">        a.info.exported = sa.getBoolean(R.styleable.AndroidManifestActivity_exported, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ... ... ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】解析 android:permission 属性！</span></span><br><span class="line">    String str;</span><br><span class="line">    str = sa.getNonConfigurationString(R.styleable.AndroidManifestActivity_permission, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (str == <span class="keyword">null</span>) &#123;</span><br><span class="line">        a.info.permission = owner.applicationInfo.permission;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        a.info.permission = str.length() &gt; <span class="number">0</span> ? str.toString().intern() : <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ... ... ...</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!setExported) &#123; </span><br><span class="line">        <span class="comment">//【4】如果没有显式设置 android:exported，取决于是否设置了意图过滤器；</span></span><br><span class="line">        s.info.exported = s.intents.size() &gt; <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> a;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>属性解析</strong>：</p>
<ul>
<li>android:exported 属性的值会保存到 Activity.ActivityInfo.exported 中；</li>
<li>android:permission 会保存到 Activity.ActivityInfo.permission 中；</li>
</ul>
<p>android:permission 使用的权限必须在 permission 标签中定义才可以使用！</p>
<h1 id="3-Service-的权限配置和解析"><a href="#3-Service-的权限配置和解析" class="headerlink" title="3 Service 的权限配置和解析"></a>3 Service 的权限配置和解析</h1><h2 id="3-1-权限配置"><a href="#3-1-权限配置" class="headerlink" title="3.1 权限配置"></a>3.1 权限配置</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">service</span></span></span><br><span class="line"><span class="tag">         <span class="attr">android:exported</span>=<span class="string">[</span>"<span class="attr">true</span>" | "<span class="attr">false</span>"]</span></span><br><span class="line"><span class="tag">         <span class="attr">android:permission</span>=<span class="string">"string"</span> &gt;</span></span><br><span class="line">    . . .</span><br><span class="line"><span class="tag">&lt;/<span class="name">service</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li><strong>android:exported</strong></li>
</ul>
<p>其他应用程序的组件是否可以调用服务或与其进行交互，为 true 表示可以，为 false 表示不可以。</p>
<p>当值为 false 时，只有具有相同 uid 的应用程序或该应用程序的组件才能启动服务或绑定到该服务。</p>
<p>默认值取决于服务是否包含意图过滤器，如果包含，则为 true；否则为 false；</p>
<ul>
<li><strong>android:permission</strong></li>
</ul>
<p>启动服务或绑定服务所必须具有的权限；</p>
<p>如果未设置此属性，则由该 application 元素 permission 属性设置的权限将 应用于该服务。如果两个属性均未设置，则该服务不受权限保护。</p>
<h2 id="3-2-权限解析"><a href="#3-2-权限解析" class="headerlink" title="3.2 权限解析"></a>3.2 权限解析</h2><h3 id="3-2-1-PackageParser-parseService"><a href="#3-2-1-PackageParser-parseService" class="headerlink" title="3.2.1 PackageParser.parseService"></a>3.2.1 PackageParser.parseService</h3><p>Service 使用是 parseService 方法解析:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Service <span class="title">parseService</span><span class="params">(Package owner, Resources res,</span></span></span><br><span class="line"><span class="function"><span class="params">        XmlResourceParser parser, <span class="keyword">int</span> flags, String[] outError)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</span><br><span class="line">    TypedArray sa = res.obtainAttributes(parser,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestService);</span><br><span class="line"></span><br><span class="line">    ... ... ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】创建 Service 对象，代表 Service 组件，创建 ServiceInfo 对象，封装 Service 的信息！</span></span><br><span class="line">    Service s = <span class="keyword">new</span> Service(mParseServiceArgs, <span class="keyword">new</span> ServiceInfo());</span><br><span class="line">    <span class="keyword">if</span> (outError[<span class="number">0</span>] != <span class="keyword">null</span>) &#123;</span><br><span class="line">        sa.recycle();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】解析 android:exported 属性；</span></span><br><span class="line">    <span class="keyword">boolean</span> setExported = sa.hasValue(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestService_exported);</span><br><span class="line">    <span class="keyword">if</span> (setExported) &#123;</span><br><span class="line">        s.info.exported = sa.getBoolean(</span><br><span class="line">                com.android.internal.R.styleable.AndroidManifestService_exported, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【3】解析 android:permission 属性；</span></span><br><span class="line">    String str = sa.getNonConfigurationString(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestService_permission, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (str == <span class="keyword">null</span>) &#123;</span><br><span class="line">        s.info.permission = owner.applicationInfo.permission;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        s.info.permission = str.length() &gt; <span class="number">0</span> ? str.toString().intern() : <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ... ... ... ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!setExported) &#123; </span><br><span class="line">        <span class="comment">//【4】如果没有显式设置 android:exported，取决于是否设置了意图过滤器；</span></span><br><span class="line">        s.info.exported = s.intents.size() &gt; <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="4-Receiver-的权限配置和解析"><a href="#4-Receiver-的权限配置和解析" class="headerlink" title="4 Receiver 的权限配置和解析"></a>4 Receiver 的权限配置和解析</h1><h2 id="4-1-权限配置"><a href="#4-1-权限配置" class="headerlink" title="4.1 权限配置"></a>4.1 权限配置</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">receiver</span> </span></span><br><span class="line"><span class="tag">          <span class="attr">android:exported</span>=<span class="string">[</span>"<span class="attr">true</span>" | "<span class="attr">false</span>"]</span></span><br><span class="line"><span class="tag">          <span class="attr">android:permission</span>=<span class="string">"string"</span> &gt;</span></span><br><span class="line">    . . .</span><br><span class="line"><span class="tag">&lt;/<span class="name">receiver</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li><strong>android:exported</strong></li>
</ul>
<p>广播接收器是否可以接收来自其应用程序之外的消息的消息 ，为 true 表示可以，为 false 表示不可以。</p>
<p>当值为 false 时，则广播接收器可以接收的唯一消息是由具有相同 uid 的应用程序或该应用程序自身的组件发送的消息。</p>
<p>默认值取决于广播接收者是否包含意图过滤器，如果包含，则为 true；否则为 false；</p>
<ul>
<li><strong>android:permission</strong></li>
</ul>
<p>向该广播接收者发送消息必须具有的权限；</p>
<p>如果未设置此属性，则该 application 元素 permission 属性设置的权限将 应用于广播接收器。如果两个属性均未设置，则接收方不受权限保护。</p>
<h2 id="4-2-权限解析"><a href="#4-2-权限解析" class="headerlink" title="4.2 权限解析"></a>4.2 权限解析</h2><p>我们回到 PMS 中去，看下应用程序的 Receiver 组件是如何被解析的，我们重点关注和权限相关的：</p>
<h3 id="4-2-1-PackageParser-parseActivity"><a href="#4-2-1-PackageParser-parseActivity" class="headerlink" title="4.2.1 PackageParser.parseActivity"></a>4.2.1 PackageParser.parseActivity</h3><p>Receiver 和 Activity 使用是同一个方法，对于 Receiver，boolean receiver 取值为 true；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Activity <span class="title">parseActivity</span><span class="params">(Package owner, Resources res,</span></span></span><br><span class="line"><span class="function"><span class="params">        XmlResourceParser parser, <span class="keyword">int</span> flags, String[] outError,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> receiver, <span class="keyword">boolean</span> hardwareAccelerated)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</span><br><span class="line">    ... ... ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】创建了一个 Activity 对象，表示 Receiver  组件，创建了 ActivityInfo 对象，封装 Receiver 信息！</span></span><br><span class="line">    Activity a = <span class="keyword">new</span> Activity(mParseActivityArgs, <span class="keyword">new</span> ActivityInfo());</span><br><span class="line">    <span class="keyword">if</span> (outError[<span class="number">0</span>] != <span class="keyword">null</span>) &#123;</span><br><span class="line">        sa.recycle();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【2】解析 android:exported 属性！</span></span><br><span class="line">    <span class="keyword">boolean</span> setExported = sa.hasValue(R.styleable.AndroidManifestActivity_exported);</span><br><span class="line">    <span class="keyword">if</span> (setExported) &#123;</span><br><span class="line">        a.info.exported = sa.getBoolean(R.styleable.AndroidManifestActivity_exported, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ... ... ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】解析 android:permission 属性！</span></span><br><span class="line">    String str;</span><br><span class="line">    str = sa.getNonConfigurationString(R.styleable.AndroidManifestActivity_permission, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (str == <span class="keyword">null</span>) &#123;</span><br><span class="line">        a.info.permission = owner.applicationInfo.permission;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        a.info.permission = str.length() &gt; <span class="number">0</span> ? str.toString().intern() : <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ... ... ...</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!setExported) &#123; </span><br><span class="line">        <span class="comment">//【4】如果没有显式设置 android:exported，取决于是否设置了意图过滤器；</span></span><br><span class="line">        s.info.exported = s.intents.size() &gt; <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> a;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>属性解析</strong>：</p>
<ul>
<li>android:exported 属性的值会保存到 Activity.ActivityInfo.exported 中；</li>
<li>android:permission 会保存到 Activity.ActivityInfo.permission 中；</li>
</ul>
<h1 id="5-Provider-的权限配置和解析"><a href="#5-Provider-的权限配置和解析" class="headerlink" title="5 Provider 的权限配置和解析"></a>5 Provider 的权限配置和解析</h1><h2 id="5-1-权限配置"><a href="#5-1-权限配置" class="headerlink" title="5.1 权限配置"></a>5.1 权限配置</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">provider</span> <span class="attr">android:exported</span>=<span class="string">[</span>"<span class="attr">true</span>" | "<span class="attr">false</span>"]</span></span><br><span class="line"><span class="tag">          <span class="attr">android:grantUriPermissions</span>=<span class="string">[</span>"<span class="attr">true</span>" | "<span class="attr">false</span>"]</span></span><br><span class="line"><span class="tag">          <span class="attr">android:permission</span>=<span class="string">"string"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">android:readPermission</span>=<span class="string">"string"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">android:writePermission</span>=<span class="string">"string"</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">provider</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>和 provider 相关的权限配置比较多，我们来分别看下：</p>
<h3 id="5-1-1-android-exported"><a href="#5-1-1-android-exported" class="headerlink" title="5.1.1 android:exported"></a>5.1.1 <strong>android:exported</strong></h3><p>provider 是否被其他应用程序使用：</p>
<ul>
<li>如果为 true， provider 可被其他应用程序使用。任何应用程序都可以使用提供程序的内容 URI 来访问它，但必须持有 provider 指定的权限。</li>
<li>如果为 false，provider 不能被其他应用程序使用，只有具有与提供者相同的 uid 的应用程序或者自身才有权访问它。</li>
</ul>
<p>因为此属性是在 API 级别 17 中引入的，在 API 17 及以后，默认为 false！</p>
<h3 id="5-1-2-android-permission"><a href="#5-1-2-android-permission" class="headerlink" title="5.1.2 android:permission"></a>5.1.2 <strong>android:permission</strong></h3><p>应用程序读取或者写入 provider 必须要有的权限，readPermission和 writePermission 设置的权限优先级更高！</p>
<p>如果 readPermission 属性也被设置，则它控制查询权限。如果 writePermission 属性被设置，它将控制访问权限。</p>
<h3 id="5-1-3-android-readPermission"><a href="#5-1-3-android-readPermission" class="headerlink" title="5.1.3 android:readPermission"></a>5.1.3 <strong>android:readPermission</strong></h3><p>应用程序读取 provider 数据必须要有的权限。</p>
<h3 id="5-1-4-android-writePermission"><a href="#5-1-4-android-writePermission" class="headerlink" title="5.1.4 android:writePermission"></a>5.1.4 <strong>android:writePermission</strong></h3><p>应用程序向 provider 写入数据必须要有的权限。</p>
<h3 id="5-1-5-android-grantUriPermissions"><a href="#5-1-5-android-grantUriPermissions" class="headerlink" title="5.1.5 android:grantUriPermissions"></a>5.1.5 <strong>android:grantUriPermissions</strong></h3><p>用于临时授予应用程序访问该 provider 的全部 uri 的权限！</p>
<p>该属性默认为 false，通过该属性，那些没有被授予 permission/readPermission/writePermission 指定的权限的应用可以临时访问 provider！</p>
<ul>
<li><p>如果为 true，那么应用有权限临时访问该 provider 的所有数据；</p>
</li>
<li><p>如果为 false，那么应用将不会被授予临时权限，除非 provider 还设置 grant-uri-permission，那应用程序将有权限访问 grant-uri-permission 指定的特定数据子集！</p>
</li>
</ul>
<p>通过这种方式，可以让应用程序组件能够一次性地临时访问受权限保护的数据！ </p>
<p><strong>eg：</strong>当电子邮件包含附件时，邮件应用程序可能会调用适当的查看器来打开它，即使查看器没有一般的权限来查看所有内容提供者的数据。</p>
<p>可以通过设置 Intent.FLAG_GRANT_READ_URI_PERMISSION 和 Intent.FLAG_GRANT_WRITE_URI_PERMISSION 标志来授予对指定 Uri 的一次性的访问权限 。</p>
<p><strong>eg：</strong>邮件应用程序会将 FLAG_GRANT_READ_URI_PERMISSION 标志位传递给 Context.startActivity() 的 Intent，被启动的 actitivity 会获得上面的标志位和 Uri，从而具有对 uri 的读权限！</p>
<h3 id="5-1-6-provider-子标签"><a href="#5-1-6-provider-子标签" class="headerlink" title="5.1.6 provider 子标签"></a>5.1.6 provider 子标签</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">path-permission</span> <span class="attr">android:path</span>=<span class="string">"string"</span></span></span><br><span class="line"><span class="tag">             <span class="attr">android:pathPrefix</span>=<span class="string">"string"</span></span></span><br><span class="line"><span class="tag">             <span class="attr">android:pathPattern</span>=<span class="string">"string"</span></span></span><br><span class="line"><span class="tag">             <span class="attr">android:permission</span>=<span class="string">"string"</span></span></span><br><span class="line"><span class="tag">             <span class="attr">android:readPermission</span>=<span class="string">"string"</span></span></span><br><span class="line"><span class="tag">             <span class="attr">android:writePermission</span>=<span class="string">"string"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">grant-uri-permission</span> <span class="attr">android:path</span>=<span class="string">"string"</span></span></span><br><span class="line"><span class="tag">                  <span class="attr">android:pathPrefix</span>=<span class="string">"string"</span> </span></span><br><span class="line"><span class="tag">                  <span class="attr">android:pathPattern</span>=<span class="string">"string"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>grant-uri-permission 和 path-permission 均为 provider 的子标签！</p>
<h4 id="5-1-6-1-grant-uri-permission"><a href="#5-1-6-1-grant-uri-permission" class="headerlink" title="5.1.6.1 grant-uri-permission"></a>5.1.6.1 <strong>grant-uri-permission</strong></h4><p>用于临时授予应用程序访问 provider 中指定 uri 的权限！</p>
<p>如果 provider 的 android:grantUriPermissions 属性为 true，那么应用程序可以临时访问该 provider 的所有 Uri 数据；</p>
<p>如果 android:grantUriPermissions 属性为 false，那么应用程序只能临时访问通过 grant-uri-permission 标签指定的特定 uri 子集！</p>
<p>一个 provider 可以定义多个 grant-uri-permission，每一个 grant-uri-permission 申明一个特定 uri 数据子集！</p>
<table>
<thead>
<tr>
<th>属性名</th>
<th style="text-align:left">解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>android:path</td>
<td style="text-align:left">provider 的数据子集的完整 uri 路径</td>
</tr>
<tr>
<td>android:pathPrefix</td>
<td style="text-align:left">provider 数据子集的 uri 路径的初始部分</td>
</tr>
<tr>
<td>android:pathPattern</td>
<td style="text-align:left">provider 数据子集的完整 uri 路径，但可以使用通配符</td>
</tr>
</tbody>
</table>
<p>如果设置了 android:path，临时访问权限只能被授予给 path 指定的数据子集；</p>
<p>如果设置了 android:pathPrefix，临时访问权限将会被授予给具有 pathPrefix 初始部分的所有数据子集；</p>
<h4 id="5-1-6-2-path-permission"><a href="#5-1-6-2-path-permission" class="headerlink" title="5.1.6.2 path-permission"></a>5.1.6.2 <strong>path-permission</strong></h4><p>定义 provider 中特定数据子集的路径和所需权限，用于开放部分 Uri 数据的读写权限！</p>
<p>一个 provider 可以定义多个 path-permission，每一个 path-permission 申明一个特定 uri 数据子集！</p>
<table>
<thead>
<tr>
<th>属性名</th>
<th style="text-align:left">解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>android:path</td>
<td style="text-align:left">provider 数据子集的完整 uri 路径</td>
</tr>
<tr>
<td>android:pathPrefix</td>
<td style="text-align:left">provider 数据子集的 uri 路径的初始部分</td>
</tr>
<tr>
<td>android:pathPattern</td>
<td style="text-align:left">provider 数据子集的完整 uri 路径，但可以使用通配符</td>
</tr>
<tr>
<td>android:permission</td>
<td style="text-align:left">读写权限，readPermission 和 writePermission 优先级</td>
</tr>
<tr>
<td>android:readPermission</td>
<td style="text-align:left">读数据的权限</td>
</tr>
<tr>
<td>android:writePermission</td>
<td style="text-align:left">写数据的权限</td>
</tr>
</tbody>
</table>
<p>如果设置了 android:path，临时访问权限只能被授予给 path 指定的数据子集；</p>
<p>如果设置了 android:pathPrefix，临时访问权限将会被授予给具有 pathPrefix 初始部分的所有数据子集；</p>
<h2 id="5-2-权限解析"><a href="#5-2-权限解析" class="headerlink" title="5.2 权限解析"></a>5.2 权限解析</h2><p>我们回到 PMS 中去，看下应用程序的 Provider 组件是如何被解析的，我们重点关注和权限相关的：</p>
<h3 id="5-2-1-PackageParser-parseProvider"><a href="#5-2-1-PackageParser-parseProvider" class="headerlink" title="5.2.1 PackageParser.parseProvider"></a>5.2.1 PackageParser.parseProvider</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Provider <span class="title">parseProvider</span><span class="params">(Package owner, Resources res,</span></span></span><br><span class="line"><span class="function"><span class="params">        XmlResourceParser parser, <span class="keyword">int</span> flags, String[] outError)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</span><br><span class="line">    TypedArray sa = res.obtainAttributes(parser,</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestProvider);</span><br><span class="line">    ... ... ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】创建一个 Provider 对象和 ProviderInfo 对象！</span></span><br><span class="line">    Provider p = <span class="keyword">new</span> Provider(mParseProviderArgs, <span class="keyword">new</span> ProviderInfo());</span><br><span class="line">    <span class="keyword">if</span> (outError[<span class="number">0</span>] != <span class="keyword">null</span>) &#123;</span><br><span class="line">        sa.recycle();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> providerExportedDefault = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (owner.applicationInfo.targetSdkVersion &lt; Build.VERSION_CODES.JELLY_BEAN_MR1) &#123;</span><br><span class="line">        providerExportedDefault = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】解析 android:exported 属性！</span></span><br><span class="line">    p.info.exported = sa.getBoolean(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestProvider_exported,</span><br><span class="line">            providerExportedDefault);</span><br><span class="line">            </span><br><span class="line">    ... ... ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】解析 android:permission 属性！</span></span><br><span class="line">    String permission = sa.getNonConfigurationString(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestProvider_permission, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">//【4】解析 android:readPermission 属性！</span></span><br><span class="line">    String str = sa.getNonConfigurationString(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestProvider_readPermission, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (str == <span class="keyword">null</span>) &#123;</span><br><span class="line">        str = permission;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (str == <span class="keyword">null</span>) &#123;</span><br><span class="line">        p.info.readPermission = owner.applicationInfo.permission;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        p.info.readPermission =</span><br><span class="line">            str.length() &gt; <span class="number">0</span> ? str.toString().intern() : <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【5】解析 android:writePermission 属性！</span></span><br><span class="line">    str = sa.getNonConfigurationString(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestProvider_writePermission, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (str == <span class="keyword">null</span>) &#123;</span><br><span class="line">        str = permission;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (str == <span class="keyword">null</span>) &#123;</span><br><span class="line">        p.info.writePermission = owner.applicationInfo.permission;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        p.info.writePermission =</span><br><span class="line">            str.length() &gt; <span class="number">0</span> ? str.toString().intern() : <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【6】解析 android:grantUriPermissions 属性！</span></span><br><span class="line">    p.info.grantUriPermissions = sa.getBoolean(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestProvider_grantUriPermissions,</span><br><span class="line">            <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">    ... ... ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【*5.2.2】调用 parseProviderTags 来解析子标签！</span></span><br><span class="line">    <span class="keyword">if</span> (!parseProviderTags(res, parser, p, outError)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里我们看到：</p>
<ul>
<li>在 API 17 以前，exported 默认是 true，因为这个属性是在 API 17 才引入的！</li>
<li>readPermission 和 writePermission 的优先级高于 permission，如果没有定义</li>
</ul>
<p>属性的处理：</p>
<ul>
<li>android:grantUriPermissions 属性的值会保存到 Provider.ProviderInfo.grantUriPermissions 中；</li>
<li>android:exported 属性的值会保存到 Provider.ProviderInfo.exported 中；</li>
<li>android:permission 属性和 android:readPermission 属性会保存到 Provider.ProviderInfo.readPermission 中；</li>
<li>android:permission 属性和 android:writePermission 属性会保存到 Provider.ProviderInfo.writePermission 中；</li>
</ul>
<h3 id="5-2-2-PackageParser-parseProviderTags"><a href="#5-2-2-PackageParser-parseProviderTags" class="headerlink" title="5.2.2 PackageParser.parseProviderTags"></a>5.2.2 PackageParser.parseProviderTags</h3><p>在 parseProviderTags 中会对 grant-uri-permission 和 path-permission 进行解析！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">parseProviderTags</span><span class="params">(Resources res,</span></span></span><br><span class="line"><span class="function"><span class="params">        XmlResourceParser parser, Provider outInfo, String[] outError)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> outerDepth = parser.getDepth();</span><br><span class="line">    <span class="keyword">int</span> type;</span><br><span class="line">    <span class="keyword">while</span> ((type=parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">           &amp;&amp; (type != XmlPullParser.END_TAG</span><br><span class="line">                   || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (parser.getName().equals(<span class="string">"intent-filter"</span>)) &#123;</span><br><span class="line">            ProviderIntentInfo intent = <span class="keyword">new</span> ProviderIntentInfo(outInfo);</span><br><span class="line">            <span class="keyword">if</span> (!parseIntent(res, parser, <span class="keyword">true</span>, <span class="keyword">false</span>, intent, outError)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            outInfo.intents.add(intent);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (parser.getName().equals(<span class="string">"meta-data"</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((outInfo.metaData=parseMetaData(res, parser,</span><br><span class="line">                    outInfo.metaData, outError)) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        <span class="comment">//【1】解析 grant-uri-permission</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (parser.getName().equals(<span class="string">"grant-uri-permission"</span>)) &#123;</span><br><span class="line">            <span class="comment">// 获得其所有属性！</span></span><br><span class="line">            TypedArray sa = res.obtainAttributes(parser,</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestGrantUriPermission);</span><br><span class="line">            <span class="comment">//【1.1】这里创建了一个 PatternMatcher 对象，用于封装 grant-uri-permission 的解析内容；</span></span><br><span class="line">            PatternMatcher pa = <span class="keyword">null</span>;</span><br><span class="line">            <span class="comment">//【1.2】pathPattern 优先级最高，接下来是 pathPrefix，最后是 pathPattern，优先级高会覆盖优先级低：</span></span><br><span class="line">            String str = sa.getNonConfigurationString(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestGrantUriPermission_path, <span class="number">0</span>); <span class="comment">// path 属性</span></span><br><span class="line">            <span class="keyword">if</span> (str != <span class="keyword">null</span>) &#123;</span><br><span class="line">                pa = <span class="keyword">new</span> PatternMatcher(str, PatternMatcher.PATTERN_LITERAL);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            str = sa.getNonConfigurationString( <span class="comment">// pathPrefix 属性</span></span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestGrantUriPermission_pathPrefix, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (str != <span class="keyword">null</span>) &#123;</span><br><span class="line">                pa = <span class="keyword">new</span> PatternMatcher(str, PatternMatcher.PATTERN_PREFIX);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            str = sa.getNonConfigurationString(  <span class="comment">// pathPattern 属性</span></span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestGrantUriPermission_pathPattern, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (str != <span class="keyword">null</span>) &#123;</span><br><span class="line">                pa = <span class="keyword">new</span> PatternMatcher(str, PatternMatcher.PATTERN_SIMPLE_GLOB);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            sa.recycle();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (pa != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">//【1.3】如果 provider 设置了以上三个属性（至少是一个），</span></span><br><span class="line">                <span class="comment">// 这里可以看出 provider 是支持多个 grant-uri-permission 的！</span></span><br><span class="line">                <span class="keyword">if</span> (outInfo.info.uriPermissionPatterns == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    outInfo.info.uriPermissionPatterns = <span class="keyword">new</span> PatternMatcher[<span class="number">1</span>];</span><br><span class="line">                    outInfo.info.uriPermissionPatterns[<span class="number">0</span>] = pa;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">int</span> N = outInfo.info.uriPermissionPatterns.length;</span><br><span class="line">                    PatternMatcher[] newp = <span class="keyword">new</span> PatternMatcher[N+<span class="number">1</span>];</span><br><span class="line">                    System.arraycopy(outInfo.info.uriPermissionPatterns, <span class="number">0</span>, newp, <span class="number">0</span>, N);</span><br><span class="line">                    newp[N] = pa;</span><br><span class="line">                    outInfo.info.uriPermissionPatterns = newp;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//【1.4】由于 provider 设置了 grant-uri-permission，也将 info.grantUriPermissions 置为 true；</span></span><br><span class="line">                outInfo.info.grantUriPermissions = <span class="keyword">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!RIGID_PARSER) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"Unknown element under &lt;path-permission&gt;: "</span></span><br><span class="line">                            + parser.getName() + <span class="string">" at "</span> + mArchiveSourcePath + <span class="string">" "</span></span><br><span class="line">                            + parser.getPositionDescription());</span><br><span class="line">                    XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    outError[<span class="number">0</span>] = <span class="string">"No path, pathPrefix, or pathPattern for &lt;path-permission&gt;"</span>;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2】解析 path-permission</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (parser.getName().equals(<span class="string">"path-permission"</span>)) &#123;</span><br><span class="line">            <span class="comment">//【2.1】获得其所有属性！</span></span><br><span class="line">            TypedArray sa = res.obtainAttributes(parser,</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestPathPermission);</span><br><span class="line">            <span class="comment">//【2.2】这里创建了一个 PathPermission 对象，用于封装 path-permission 的解析内容；</span></span><br><span class="line">            PathPermission pa = <span class="keyword">null</span>;</span><br><span class="line">            <span class="comment">//【2.3】解析 readPermission 和 writePermission！</span></span><br><span class="line">            String permission = sa.getNonConfigurationString(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestPathPermission_permission, <span class="number">0</span>);</span><br><span class="line">            String readPermission = sa.getNonConfigurationString(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestPathPermission_readPermission, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (readPermission == <span class="keyword">null</span>) &#123;</span><br><span class="line">                readPermission = permission;</span><br><span class="line">            &#125;</span><br><span class="line">            String writePermission = sa.getNonConfigurationString(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestPathPermission_writePermission, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (writePermission == <span class="keyword">null</span>) &#123;</span><br><span class="line">                writePermission = permission;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">boolean</span> havePerm = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (readPermission != <span class="keyword">null</span>) &#123;</span><br><span class="line">                readPermission = readPermission.intern();</span><br><span class="line">                havePerm = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (writePermission != <span class="keyword">null</span>) &#123;</span><br><span class="line">                writePermission = writePermission.intern();</span><br><span class="line">                havePerm = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!havePerm) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!RIGID_PARSER) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"No readPermission or writePermssion for &lt;path-permission&gt;: "</span></span><br><span class="line">                            + parser.getName() + <span class="string">" at "</span> + mArchiveSourcePath + <span class="string">" "</span></span><br><span class="line">                            + parser.getPositionDescription());</span><br><span class="line">                    XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    outError[<span class="number">0</span>] = <span class="string">"No readPermission or writePermssion for &lt;path-permission&gt;"</span>;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【2.4】pathPattern 优先级最高，接下来是 pathPrefix，最后是 pathPattern，优先级高覆盖优先级低！</span></span><br><span class="line">            String path = sa.getNonConfigurationString(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestPathPermission_path, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (path != <span class="keyword">null</span>) &#123;</span><br><span class="line">                pa = <span class="keyword">new</span> PathPermission(path,</span><br><span class="line">                        PatternMatcher.PATTERN_LITERAL, readPermission, writePermission);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            path = sa.getNonConfigurationString(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestPathPermission_pathPrefix, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (path != <span class="keyword">null</span>) &#123;</span><br><span class="line">                pa = <span class="keyword">new</span> PathPermission(path,</span><br><span class="line">                        PatternMatcher.PATTERN_PREFIX, readPermission, writePermission);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            path = sa.getNonConfigurationString(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestPathPermission_pathPattern, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (path != <span class="keyword">null</span>) &#123;</span><br><span class="line">                pa = <span class="keyword">new</span> PathPermission(path,</span><br><span class="line">                        PatternMatcher.PATTERN_SIMPLE_GLOB, readPermission, writePermission);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            sa.recycle();</span><br><span class="line">    </span><br><span class="line">            <span class="keyword">if</span> (pa != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">//【2.5】如果 provider 设置了以上三个属性（至少是一个），</span></span><br><span class="line">                <span class="comment">// 这里可以看出 provider 是支持多个 path-permission 的！</span></span><br><span class="line">                <span class="keyword">if</span> (outInfo.info.pathPermissions == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    outInfo.info.pathPermissions = <span class="keyword">new</span> PathPermission[<span class="number">1</span>];</span><br><span class="line">                    outInfo.info.pathPermissions[<span class="number">0</span>] = pa;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">int</span> N = outInfo.info.pathPermissions.length;</span><br><span class="line">                    PathPermission[] newp = <span class="keyword">new</span> PathPermission[N+<span class="number">1</span>];</span><br><span class="line">                    System.arraycopy(outInfo.info.pathPermissions, <span class="number">0</span>, newp, <span class="number">0</span>, N);</span><br><span class="line">                    newp[N] = pa;</span><br><span class="line">                    outInfo.info.pathPermissions = newp;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!RIGID_PARSER) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"No path, pathPrefix, or pathPattern for &lt;path-permission&gt;: "</span></span><br><span class="line">                            + parser.getName() + <span class="string">" at "</span> + mArchiveSourcePath + <span class="string">" "</span></span><br><span class="line">                            + parser.getPositionDescription());</span><br><span class="line">                    XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                outError[<span class="number">0</span>] = <span class="string">"No path, pathPrefix, or pathPattern for &lt;path-permission&gt;"</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!RIGID_PARSER) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Unknown element under &lt;provider&gt;: "</span></span><br><span class="line">                        + parser.getName() + <span class="string">" at "</span> + mArchiveSourcePath + <span class="string">" "</span></span><br><span class="line">                        + parser.getPositionDescription());</span><br><span class="line">                XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                outError[<span class="number">0</span>] = <span class="string">"Bad element under &lt;provider&gt;: "</span> + parser.getName();</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5-2-2-1-解析-grant-uri-permission"><a href="#5-2-2-1-解析-grant-uri-permission" class="headerlink" title="5.2.2.1 解析 grant-uri-permission"></a>5.2.2.1 解析 grant-uri-permission</h4><p>我们可以看到，三个属性中 pathPattern 优先级最高，接下来是 pathPrefix，最后是 pathPattern，优先级高的会覆盖优先级低的属性：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//【1】path 属性；</span></span><br><span class="line">String str = sa.getNonConfigurationString(</span><br><span class="line">        com.android.internal.R.styleable.AndroidManifestGrantUriPermission_path, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (str != <span class="keyword">null</span>) &#123;</span><br><span class="line">    pa = <span class="keyword">new</span> PatternMatcher(str, PatternMatcher.PATTERN_LITERAL);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//【2】pathPrefix 属性；</span></span><br><span class="line">str = sa.getNonConfigurationString(</span><br><span class="line">        com.android.internal.R.styleable.AndroidManifestGrantUriPermission_pathPrefix, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (str != <span class="keyword">null</span>) &#123;</span><br><span class="line">    pa = <span class="keyword">new</span> PatternMatcher(str, PatternMatcher.PATTERN_PREFIX);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//【3】pathPattern 属性；</span></span><br><span class="line">str = sa.getNonConfigurationString(</span><br><span class="line">        com.android.internal.R.styleable.AndroidManifestGrantUriPermission_pathPattern, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (str != <span class="keyword">null</span>) &#123;</span><br><span class="line">    pa = <span class="keyword">new</span> PatternMatcher(str, PatternMatcher.PATTERN_SIMPLE_GLOB);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后会创建一个 PatternMatcher 对象！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">PatternMatcher</span><span class="params">(String pattern, <span class="keyword">int</span> type)</span> </span>&#123;</span><br><span class="line">    mPattern = pattern;</span><br><span class="line">    mType = type;</span><br><span class="line">    <span class="keyword">if</span> (mType == PATTERN_ADVANCED_GLOB) &#123;</span><br><span class="line">        mParsedPattern = parseAndVerifyAdvancedPattern(pattern);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mParsedPattern = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果 provider 设置了 grant-uri-permission，也会将前面的 p.info.grantUriPermissions 置为 true，即使应用没有显式设置 android:grantUriPermissions 的值；</p>
<p>解析得到的 PatternMatcher 会保存到 Provider.ProviderInfo.uriPermissionPatterns 数组中；</p>
<h4 id="5-2-2-2-解析-patch-permission"><a href="#5-2-2-2-解析-patch-permission" class="headerlink" title="5.2.2.2 解析 patch-permission"></a>5.2.2.2 解析 patch-permission</h4><p>同样的，三个属性中 pathPattern 优先级最高，接下来是 pathPrefix，最后是 pathPattern，优先级高的会覆盖优先级低的属性！</p>
<p>最后会创建一个 PathPermission 对象，PathPermission 是 PatternMatcher 的子类！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PathPermission</span> <span class="keyword">extends</span> <span class="title">PatternMatcher</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PathPermission</span><span class="params">(String pattern, <span class="keyword">int</span> type, String readPermission,</span></span></span><br><span class="line"><span class="function"><span class="params">            String writePermission)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(pattern, type);</span><br><span class="line">        mReadPermission = readPermission;</span><br><span class="line">        mWritePermission = writePermission;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>所以，大家应该明白 String pattern, int type 是如何处理的了！</p>
<p>解析得到的 PathPermission 会保存到 Provider.ProviderInfo.pathPermissions 数组中；</p>
<h1 id="6-权限知识点总结"><a href="#6-权限知识点总结" class="headerlink" title="6 权限知识点总结"></a>6 权限知识点总结</h1><p>我们知道，权限的 protectionLevel 分为基本权限类型和附加的标志位：</p>
<h2 id="6-1-基本权限类型"><a href="#6-1-基本权限类型" class="headerlink" title="6.1 基本权限类型"></a>6.1 基本权限类型</h2><p>下表显示了所有基本权限类型：</p>
<table>
<thead>
<tr>
<th>基本权限类型</th>
<th style="text-align:center">取值</th>
<th style="text-align:left">解释</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>normal</strong></td>
<td style="text-align:center">0</td>
<td style="text-align:left">默认值，这种权限是风险较低的权限，安装时，系统会自动授予这种类型的权限给请求应用程序。</td>
</tr>
<tr>
<td><strong>dangerous</strong></td>
<td style="text-align:center">1</td>
<td style="text-align:left">这种权限是风险较高的权限，因此系统可能不会自动将其授予请求的应用程序，而是需要应用显式的申请。</td>
</tr>
<tr>
<td><strong>signature</strong></td>
<td style="text-align:center">2</td>
<td style="text-align:left">仅当请求权限的应用程序使用与声明权限的应用程序相同的证书签名时，系统才会授予该权限。如果签名匹配，系统会自动授予权限，而不需要通知用户或要求用户明确批准；如果签名不匹配，一些 signature 权限需要用户显式申请。</td>
</tr>
<tr>
<td><strong>signatureOrSystem</strong></td>
<td style="text-align:center">3</td>
<td style="text-align:left">该权限只会授予和声明权限的应用程序相同的证书签名的应用或者系统分区应用，避免使用此选项，因为 signature 保护级别应该足以满足大多数需求，并且可以工作，而不管应用程序的安装位置。<strong>在 API 级别 23 中已弃用</strong>，现在用 “signature\</td>
<td>privileged” 替代； “ signatureOrSystem” 许可用于某些特定情况，其中多个供应商将应用程序内置到系统映像中，并且需要明确地共享特定功能，因为它们正在构建在一起。</td>
</tr>
</tbody>
</table>
<p>小小的思考：</p>
<ul>
<li>normal 类型的权限，无论是系统应用还是三方应用都会默认授予；</li>
<li>dangerous 类型的权限，无论是系统应用还是三方应用都需要显式申请，但是系统会有一个类会给某些系统应用默认授予这些权限；</li>
<li>那么 signature 类型的权限的意义就很显然了，对于系统定义的 signature 权限，系统应用会默认授予；而对于三方应用，一些  signature 权限其无法申请，而另外一些  signature 权限，三方应用可以通过一定的方式申请，这些权限是一些特殊的权限！</li>
</ul>
<h2 id="6-2-附加标志位"><a href="#6-2-附加标志位" class="headerlink" title="6.2 附加标志位"></a>6.2 附加标志位</h2><p>对于 signature 类型的权限，可以配合下面的特殊的附加标志位：</p>
<table>
<thead>
<tr>
<th>附加标志位</th>
<th style="text-align:center">取值</th>
<th style="text-align:left">解释</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>appop</strong></td>
<td style="text-align:center">40</td>
<td style="text-align:left">该权限与用于控制访问的 app op 密切相关，也就是我们说的 AppOpsManager。</td>
</tr>
<tr>
<td><strong>development</strong></td>
<td style="text-align:center">20</td>
<td style="text-align:left">此权限也<strong>可以授予</strong>（可选）给开发应用程序。</td>
</tr>
<tr>
<td><strong>installer</strong></td>
<td style="text-align:center">100</td>
<td style="text-align:left">此权限可以<strong>自动授予</strong>安装软件包的系统应用程序，就是我们的 PackageInstaller</td>
</tr>
<tr>
<td><strong>instant</strong></td>
<td style="text-align:center">1000</td>
<td style="text-align:left">此权限<strong>可被授予</strong>给即时应用程序（instant app）</td>
</tr>
<tr>
<td><strong>oem</strong></td>
<td style="text-align:center">4000</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td><strong>pre23</strong></td>
<td style="text-align:center">80</td>
<td style="text-align:left">此权限会自动授予低于 M（在引入运行时权限之前）的 API 级别的应用程序。</td>
</tr>
<tr>
<td><strong>preinstalled</strong></td>
<td style="text-align:center">400</td>
<td style="text-align:left">此权限可以<strong>自动授予</strong> system 分区预先安装的任何应用程序（不仅仅是特权应用程序）。</td>
</tr>
<tr>
<td><strong>privileged</strong></td>
<td style="text-align:center">10</td>
<td style="text-align:left">此权限也<strong>可以授予</strong>安装在 system 分区的特权应用。请避免使用此标志位，因为 signature 保护级别已足以满足大多数需求，并且无论应用程序的安装位置如何，都能正常工作。 此权限标志用于某些特殊情况，其中多个供应商将应用程序内置到系统映像中，需要明确地共享特定功能。</td>
</tr>
<tr>
<td><strong>runtime</strong></td>
<td style="text-align:center">2000</td>
<td style="text-align:left">此权限<strong>只能被授予</strong>适用于运行时权限（M 及以上）的应用程序</td>
</tr>
<tr>
<td><strong>setup</strong></td>
<td style="text-align:center">800</td>
<td style="text-align:left">此权限可以被<strong>自动授予</strong>给开机向导应用程序（setup wizard app）</td>
</tr>
<tr>
<td><strong>system</strong></td>
<td style="text-align:center">10</td>
<td style="text-align:left">在 API 级别 23 中已弃用，用 privileged 替代</td>
</tr>
<tr>
<td><strong>textClassifier</strong></td>
<td style="text-align:center">10000</td>
<td style="text-align:left">此权限可以被<strong>自动授予</strong>给系统默认的文本解析器</td>
</tr>
<tr>
<td><strong>vendorPrivileged</strong></td>
<td style="text-align:center">8000</td>
<td style="text-align:left">此权限可以被授予给供应商（vendor）分区中的特权应用程序。</td>
</tr>
<tr>
<td><strong>verifier</strong></td>
<td style="text-align:center">200</td>
<td style="text-align:left">此权限可以被<strong>自动授予</strong>给验证软件包的系统应用程序。</td>
</tr>
</tbody>
</table>
<p>注：如果保护级别设置了额外的标志位，那么其基本权限类型必须是 signature！</p>
<h2 id="6-3-权限组"><a href="#6-3-权限组" class="headerlink" title="6.3 权限组"></a>6.3 权限组</h2><p>任何权限都可以属于某个权限组，所有的 dangerous 权限都有所属的组，但是，权限组只有在申请的权限是 dangerous 权限是才会对用户体验有影响！</p>
<p>在 Android 6.0 （API level 23）以及以上，如果应用的 targetSdkVersion &gt;= 23 ，系统是这样处理运行时权限的申请的：</p>
<ul>
<li>如果应用程序没有被授予权限组中的任何运行时权限，在申请权限时，系统会向用户显示描述应用程序要访问的权限组的权限请求对话框。 但是该对话框不会描述该组中的特定权限的信息。如果用户同意授予权限，该权限将被授予。</li>
<li>如果应用程序已经被授予同一权限组中的某个权限，则对于其他权限，系统会立即授予权限，而不与用户进行任何交互。 例如：如果应用程序先前已请求并已获得READ_CONTACTS权限，然后它请求WRITE_CONTACTS，则系统会立即授予该权限，而不向用户显示权限对话框。</li>
</ul>
<p>在 Android 5.1 （API level 22）以及以下，或者应用的 targetSdkVersion &lt;= 22：</p>
<ul>
<li>系统会在应用安装的时候授予所有的运行时权限；同时，也是只会告诉用户应用程序需要哪些权限组，而不是单个权限。</li>
</ul>
<h2 id="6-4-特殊权限"><a href="#6-4-特殊权限" class="headerlink" title="6.4 特殊权限"></a>6.4 特殊权限</h2><h3 id="6-4-1-signature-with-appop"><a href="#6-4-1-signature-with-appop" class="headerlink" title="6.4.1 signature with appop"></a>6.4.1 signature with appop</h3><p>signature 权限中有几个权限特殊，signature 权限本身是安装时权限，但是当其设置了 appop 标志位的时候，其可以通过 appOps 动态管理。</p>
<p>Android7.1.1 提供了如下 signature appop 权限：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.WRITE_SETTINGS"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:label</span>=<span class="string">"@string/permlab_writeSettings"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:description</span>=<span class="string">"@string/permdesc_writeSettings"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:protectionLevel</span>=<span class="string">"signature|preinstalled|appop|pre23"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.SYSTEM_ALERT_WINDOW"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:label</span>=<span class="string">"@string/permlab_systemAlertWindow"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:description</span>=<span class="string">"@string/permdesc_systemAlertWindow"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:protectionLevel</span>=<span class="string">"signature|preinstalled|appop|pre23|development"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.PACKAGE_USAGE_STATS"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:protectionLevel</span>=<span class="string">"signature|privileged|development|appop"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>这三个权限，可以通过 AppOps 的方式来授予那些签名不匹配的应用！</p>
<h3 id="6-4-1-signature-with-bind-service"><a href="#6-4-1-signature-with-bind-service" class="headerlink" title="6.4.1 signature with bind service"></a>6.4.1 signature with bind service</h3><p>signature 内部还有一些权限的使用方式也很特殊，应用需要配置这个权限，但是应用自身并不是权限的申请方：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">BIND_ACCESSIBILITY_SERVICE</span><br><span class="line">BIND_AUTOFILL_SERVICE</span><br><span class="line">BIND_CARRIER_SERVICES</span><br><span class="line">BIND_CHOOSER_TARGET_SERVICE</span><br><span class="line">BIND_CONDITION_PROVIDER_SERVICE</span><br><span class="line">BIND_DEVICE_ADMIN</span><br><span class="line">BIND_DREAM_SERVICE</span><br><span class="line">BIND_INCALL_SERVICE</span><br><span class="line">BIND_INPUT_METHOD</span><br><span class="line">BIND_MIDI_DEVICE_SERVICE</span><br><span class="line">BIND_NFC_SERVICE</span><br><span class="line">BIND_NOTIFICATION_LISTENER_SERVICE</span><br><span class="line">BIND_PRINT_SERVICE</span><br><span class="line">BIND_SCREENING_SERVICE</span><br><span class="line">BIND_TELECOM_CONNECTION_SERVICE</span><br><span class="line">BIND_TEXT_SERVICE</span><br><span class="line">BIND_TV_INPUT</span><br><span class="line">BIND_VISUAL_VOICEMAIL_SERVICE</span><br><span class="line">BIND_VOICE_INTERACTION</span><br><span class="line">BIND_VPN_SERVICE</span><br><span class="line">BIND_VR_LISTENER_SERVICE</span><br><span class="line">BIND_WALLPAPER</span><br></pre></td></tr></table></figure></p>
<p>这些权限的使用后面会单独写一篇博文记录下！</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2017/05/03/UsageStats 第 3 篇 - UserUsageStatsService 逻辑分析/">UsageStats 第 3 篇 - UserUsageStatsService 逻辑分析</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2017-05-03</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/AndroidFramework源码分析/">AndroidFramework源码分析</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/AndroidFramework源码分析/UsageStats使用状态管理/">UsageStats使用状态管理</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/UsageStats使用状态管理/">UsageStats使用状态管理</a></span><div class="content"><p>[toc]</p>
<p>基于 Android7.1.1 源码分析 UsageStatsService 的架构和原理！</p>
<h1 id="0-综述"><a href="#0-综述" class="headerlink" title="0 综述"></a>0 综述</h1><p>UserUsageStatsService 用于保存每个设备用户下的数据信息！每一个 UserUsageStatsService 内部都会有一个 UsageStatsDatabase 对象用于访问本地持久化文件！</p>
<p>本文主要分析 UserUsageStatsService 相关的接口，为 UsageStatsService 的分析提供帮助！</p>
<h1 id="1-new-UserUsageStatsService-创建"><a href="#1-new-UserUsageStatsService-创建" class="headerlink" title="1 new UserUsageStatsService - 创建"></a>1 new UserUsageStatsService - 创建</h1><p>参数 File usageStatsDir 传入的是 new File(mUsageStatsDir, Integer.toString(userId))。</p>
<p>mUsageStatsDir 就是 /data/system/usagestats，这里我们不考虑多用户，在默认用户下 usageStatsDir 为 /data/system/usagestats/0</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">UserUsageStatsService(Context context, <span class="keyword">int</span> userId, File usageStatsDir,</span><br><span class="line">        StatsUpdatedListener listener) &#123;</span><br><span class="line">    mContext = context;</span><br><span class="line">    <span class="comment">//【1.1】用于日期的计算；</span></span><br><span class="line">    mDailyExpiryDate = <span class="keyword">new</span> UnixCalendar(<span class="number">0</span>);</span><br><span class="line">    <span class="comment">//【1.2】数据库对象，用于加载和更新持久化文件；</span></span><br><span class="line">    mDatabase = <span class="keyword">new</span> UsageStatsDatabase(usageStatsDir);</span><br><span class="line">    <span class="comment">//【1.3】创建一个 IntervalStats 数组，大小为 4，用于加载每个时间类别的最新数据到内存中！        </span></span><br><span class="line">    mCurrentStats = <span class="keyword">new</span> IntervalStats[UsageStatsManager.INTERVAL_COUNT];</span><br><span class="line">    mListener  = listener;</span><br><span class="line">    mLogPrefix = <span class="string">"User["</span> + Integer.toString(userId) + <span class="string">"] "</span>;</span><br><span class="line">    mUserId = userId; <span class="comment">// 对应的 userId</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的 mListener 就是 UsageStatsService，前面我们知道 UsageStatsService 实现了 UserUsageStatsService.StatsUpdatedListener：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> StatsUpdatedListener mListener;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">StatsUpdatedListener</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onStatsUpdated</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onStatsReloaded</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onNewUpdate</span><span class="params">(<span class="keyword">int</span> mUserId)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样，当 UserUsageStatsService 中的数据发生更新后，会通过 StatsUpdatedListener 的接口通知 UsageStatsService！</p>
<ul>
<li><strong>onStatsUpdated</strong>：当使用信息被更新后，触发该回调；</li>
<li><strong>onStatsReloaded</strong>：当使用信息重新加载后，触发该回调；</li>
<li><strong>onNewUpdate</strong>：当系统发生了升级后，触发该回调；</li>
</ul>
<h2 id="1-1-new-UnixCalendar"><a href="#1-1-new-UnixCalendar" class="headerlink" title="1.1 new UnixCalendar"></a>1.1 new UnixCalendar</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UnixCalendar</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> DAY_IN_MILLIS = <span class="number">24</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">1000</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> WEEK_IN_MILLIS = <span class="number">7</span> * DAY_IN_MILLIS;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> MONTH_IN_MILLIS = <span class="number">30</span> * DAY_IN_MILLIS;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> YEAR_IN_MILLIS = <span class="number">365</span> * DAY_IN_MILLIS;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> mTime;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UnixCalendar</span><span class="params">(<span class="keyword">long</span> time)</span> </span>&#123;</span><br><span class="line">        mTime = time;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addDays</span><span class="params">(<span class="keyword">int</span> val)</span> </span>&#123;</span><br><span class="line">        mTime += val * DAY_IN_MILLIS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addWeeks</span><span class="params">(<span class="keyword">int</span> val)</span> </span>&#123;</span><br><span class="line">        mTime += val * WEEK_IN_MILLIS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addMonths</span><span class="params">(<span class="keyword">int</span> val)</span> </span>&#123;</span><br><span class="line">        mTime += val * MONTH_IN_MILLIS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addYears</span><span class="params">(<span class="keyword">int</span> val)</span> </span>&#123;</span><br><span class="line">        mTime += val * YEAR_IN_MILLIS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTimeInMillis</span><span class="params">(<span class="keyword">long</span> time)</span> </span>&#123;</span><br><span class="line">        mTime = time;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getTimeInMillis</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mTime;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>UnixCalendar 用于计算日期的变化，代码很简单，不多说了！</p>
<h2 id="1-2-new-UsageStatsDatabase"><a href="#1-2-new-UsageStatsDatabase" class="headerlink" title="1.2 new UsageStatsDatabase"></a>1.2 new UsageStatsDatabase</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">UsageStatsDatabase</span><span class="params">(File dir)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】创建了一个文件夹数组，对应了本地的四个不同的目录；</span></span><br><span class="line">    mIntervalDirs = <span class="keyword">new</span> File[] &#123;</span><br><span class="line">            <span class="keyword">new</span> File(dir, <span class="string">"daily"</span>),</span><br><span class="line">            <span class="keyword">new</span> File(dir, <span class="string">"weekly"</span>),</span><br><span class="line">            <span class="keyword">new</span> File(dir, <span class="string">"monthly"</span>),</span><br><span class="line">            <span class="keyword">new</span> File(dir, <span class="string">"yearly"</span>),</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">//【2】创建版本信息文件！</span></span><br><span class="line">    mVersionFile = <span class="keyword">new</span> File(dir, <span class="string">"version"</span>);</span><br><span class="line">    <span class="comment">//【3】创建一个 TimeSparseArray，长度为 4，用于对不同目录下的文件根据时间排序！</span></span><br><span class="line">    mSortedStatFiles = <span class="keyword">new</span> TimeSparseArray[mIntervalDirs.length];</span><br><span class="line">    mCal = <span class="keyword">new</span> UnixCalendar(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在默认用户下，这里的 dir 对应的目录是 /data/system/usagestats/0。</p>
<p>同时创建了一个文件夹数组，其实这里可以知道，数据是按 daily，monthly，weekly，yearly 四个文件夹存储的，而每个文件夹中又包含若干个以一个时间戳为名称的文件！</p>
<ul>
<li>/data/system/usagestats/0/daily；</li>
<li>/data/system/usagestats/0/weekly；</li>
<li>/data/system/usagestats/0/monthly；</li>
<li>/data/system/usagestats/0/yearly；</li>
</ul>
<p>同时，又创建了数据库对应的 version 文件：</p>
<ul>
<li>/data/system/usagestats/0/version；</li>
</ul>
<p>我们来看看 daily，monthly，weekly，yearly 四个文件夹中存储的是什么文件：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/data/system/usagestats/<span class="number">0</span>/daily  ls</span><br><span class="line"><span class="number">1526928050937</span>  <span class="number">1527014648681</span>  <span class="number">1527101544569</span>  <span class="number">1527188059056</span>  <span class="number">1527277127932</span>  <span class="number">1527364251915</span>  <span class="number">1527450652825</span></span><br></pre></td></tr></table></figure>
<p>可以看到，每一个文件的名字都是一个时间戳，这个时间戳的表示的是该文件开始记录的时间节点！</p>
<p>我们来看下，这些文件内部的数据结构：<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">'1.0'</span> encoding=<span class="string">'utf-8'</span> standalone=<span class="string">'yes'</span> ?&gt;</span><br><span class="line">&lt;usagestats version=<span class="string">"1"</span> endTime=<span class="string">"62979335"</span>&gt;</span><br><span class="line">    &lt;packages&gt;</span><br><span class="line">        &lt;<span class="keyword">package</span> lastTimeActive=<span class="string">"1104580"</span> <span class="keyword">package</span>=<span class="string">"com.github.shadowsocks"</span> timeActive=<span class="string">"119959"</span> lastEvent=<span class="string">"2"</span> /&gt;</span><br><span class="line">    &lt;/packages&gt;</span><br><span class="line">    &lt;configurations&gt;</span><br><span class="line">        &lt;config lastTimeActive=<span class="string">"60709298"</span> timeActive=<span class="string">"60690625"</span> count=<span class="string">"3"</span> active=<span class="string">"true"</span> fs=<span class="string">"1065353216"</span> mcc=<span class="string">"460"</span> </span><br><span class="line">                mnc=<span class="string">"65535"</span> locales=<span class="string">"zh-CN"</span> touch=<span class="string">"3"</span> key=<span class="string">"1"</span> keyHid=<span class="string">"1"</span> hardKeyHid=<span class="string">"2"</span> nav=<span class="string">"1"</span> navHid=<span class="string">"2"</span> </span><br><span class="line">                ori=<span class="string">"1"</span> scrLay=<span class="string">"268435810"</span> clrMod=<span class="string">"5"</span> ui=<span class="string">"17"</span> width=<span class="string">"360"</span> height=<span class="string">"685"</span> sw=<span class="string">"360"</span> </span><br><span class="line">                density=<span class="string">"480"</span> app_bounds=<span class="string">"0 0 1080 2136"</span> /&gt;</span><br><span class="line">    &lt;/configurations&gt;</span><br><span class="line">    &lt;event-log&gt;</span><br><span class="line">        &lt;event time=<span class="string">"1104580"</span> <span class="keyword">package</span>=<span class="string">"com.github.shadowsocks"</span> </span><br><span class="line">               <span class="class"><span class="keyword">class</span></span>=<span class="string">"com.github.shadowsocks.MainActivity"</span> flags=<span class="string">"0"</span> type=<span class="string">"2"</span> /&gt;</span><br><span class="line">    &lt;/event-log&gt;</span><br><span class="line">&lt;/usagestats&gt;</span><br></pre></td></tr></table></figure></p>
<p>可以看到，一个文件主要包含三方面的内容：</p>
<ul>
<li><strong>packages</strong>：应用的使用信息；</li>
<li><strong>configurations</strong>：配置的使用信息；</li>
<li><strong>event-log</strong>：时间上报的历史记录；</li>
</ul>
<p>下面，会分析到解析过程！</p>
<h2 id="1-3-new-IntervalStats"><a href="#1-3-new-IntervalStats" class="headerlink" title="1.3 new IntervalStats"></a>1.3 new IntervalStats</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IntervalStats</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">long</span> beginTime; <span class="comment">// 开始记录的时间</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">long</span> endTime; <span class="comment">// 当前记录的最大时间</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">long</span> lastTimeSaved; <span class="comment">// 最后一次将数据保存到持久化文件的时间！</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 内存中的 UsageStats 数据！</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> ArrayMap&lt;String, UsageStats&gt; packageStats = <span class="keyword">new</span> ArrayMap&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 内存中的 ConfigurationStats 数据！</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> ArrayMap&lt;Configuration, ConfigurationStats&gt; configurations = <span class="keyword">new</span> ArrayMap&lt;&gt;();</span><br><span class="line">    <span class="keyword">public</span> Configuration activeConfiguration;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 内存中的 Event 数据！</span></span><br><span class="line">    <span class="keyword">public</span> TimeSparseArray&lt;UsageEvents.Event&gt; events;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ArraySet&lt;String&gt; mStringCache = <span class="keyword">new</span> ArraySet&lt;&gt;(); <span class="comment">// 用于缓存包名！</span></span><br><span class="line">    ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>IntervalStats 用于将持久化数据缓存到内存中，加快访问效率！</p>
<ul>
<li>应用的数据以 UsageStats 的形式保存在 packageStats 中；</li>
<li>配置的数据以 ConfigurationStats 的形式保存在 configurations 中；</li>
</ul>
<p>IntervalStats 内部也提供了一些 get，udpate 等等的方法，我们后面分析的时候再说！</p>
<p>IntervalStats 数组的长度为 4 ，和 UsageStatsDatabase 中的四个文件一一对应，分别用于保存对应文件的缓存数据！</p>
<p><strong>每一个 IntervalStats 都对应着一个名字为时间戳的文件</strong>！</p>
<h1 id="2-UserUsageStatsService-init-初始化操作"><a href="#2-UserUsageStatsService-init-初始化操作" class="headerlink" title="2 UserUsageStatsService.init - 初始化操作"></a>2 UserUsageStatsService.init - 初始化操作</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> currentTimeMillis)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【×2.1】初始化 UsageStatsDatabase 实例！</span></span><br><span class="line">    mDatabase.init(currentTimeMillis);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】加载本地持久化文件，初始化缓存数据：mCurrentStats！</span></span><br><span class="line">    <span class="keyword">int</span> nullCount = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mCurrentStats.length; i++) &#123;</span><br><span class="line">        <span class="comment">//【×2.2】将持久化文件的数据加载到内存中！</span></span><br><span class="line">        mCurrentStats[i] = mDatabase.getLatestUsageStats(i);</span><br><span class="line">        <span class="keyword">if</span> (mCurrentStats[i] == <span class="keyword">null</span>) &#123;</span><br><span class="line">            nullCount++; <span class="comment">// 统计没有对应数据的类别！</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (nullCount &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果 nullCount 大于 0，说明 daily，monthly，weekly，yearly 这四个数据类型，至少有一个没有对应的数据！</span></span><br><span class="line">        <span class="keyword">if</span> (nullCount != mCurrentStats.length) &#123;</span><br><span class="line">            <span class="comment">// 说明某个类别没有数据！</span></span><br><span class="line">            Slog.w(TAG, mLogPrefix + <span class="string">"Some stats have no latest available"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 第一次启动的情况！</span></span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">//【×2.3】加载最新的使用信息！</span></span><br><span class="line">        loadActiveStats(currentTimeMillis);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//【×2.4】设置回滚日期！</span></span><br><span class="line">        updateRolloverDeadline();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Now close off any events that were open at the time this was saved.</span></span><br><span class="line">    <span class="comment">//【2】初始化到这里，mCurrentStats 已经保存了每个时间类别下，对应的最新的使用信息！</span></span><br><span class="line">    <span class="comment">// 接着，对 package 的 UsageStats.mLastEvent 取值做一个特殊处理！</span></span><br><span class="line">    <span class="keyword">for</span> (IntervalStats stat : mCurrentStats) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> pkgCount = stat.packageStats.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pkgCount; i++) &#123;</span><br><span class="line">            UsageStats pkgStats = stat.packageStats.valueAt(i);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//【2.1】如果该 package 的最后一个 event 是 MOVE_TO_FOREGROUND 或者 CONTINUE_PREVIOUS_DAY</span></span><br><span class="line">            <span class="comment">// 更新其为 END_OF_DAY！</span></span><br><span class="line">            <span class="keyword">if</span> (pkgStats.mLastEvent == UsageEvents.Event.MOVE_TO_FOREGROUND ||</span><br><span class="line">                    pkgStats.mLastEvent == UsageEvents.Event.CONTINUE_PREVIOUS_DAY) &#123;</span><br><span class="line">                    </span><br><span class="line">                <span class="comment">//【×2.5】更新所属 IntervalStats 的属性！</span></span><br><span class="line">                stat.update(pkgStats.mPackageName, stat.lastTimeSaved,</span><br><span class="line">                        UsageEvents.Event.END_OF_DAY);</span><br><span class="line">                        </span><br><span class="line">                <span class="comment">//【×2.6】延迟 20mins 通知 UsageStatsService 使用信息发生变化！</span></span><br><span class="line">                <span class="comment">// 通知一次！</span></span><br><span class="line">                notifyStatsChanged();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【×2.7】更新配置信息！</span></span><br><span class="line">        stat.updateConfigurationStats(<span class="keyword">null</span>, stat.lastTimeSaved);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【×2.8】如果发生了系统升级，isNewUpdate 返回 true！</span></span><br><span class="line">    <span class="keyword">if</span> (mDatabase.isNewUpdate()) &#123;</span><br><span class="line">        notifyNewUpdate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-1-UsageStatsDatabase-init"><a href="#2-1-UsageStatsDatabase-init" class="headerlink" title="2.1 UsageStatsDatabase.init"></a>2.1 UsageStatsDatabase.init</h2><p>init 方法用于初始化 database，我们来看看具体的流程：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(<span class="keyword">long</span> currentTimeMillis)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="comment">//【1】创建 daily，monthly，weekly，yearly 四个文件夹！</span></span><br><span class="line">        <span class="keyword">for</span> (File f : mIntervalDirs) &#123;</span><br><span class="line">            f.mkdirs();</span><br><span class="line">            <span class="keyword">if</span> (!f.exists()) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Failed to create directory "</span></span><br><span class="line">                        + f.getAbsolutePath());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【2.1.1】检查 version 变化！</span></span><br><span class="line">        checkVersionAndBuildLocked();</span><br><span class="line">        <span class="comment">//【2.1.2】加载每个时间类别文件夹中的文件到 mSortedStatFiles 中！</span></span><br><span class="line">        indexFilesLocked();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【3】删除那些日期在当前时间以后的文件！</span></span><br><span class="line">        <span class="keyword">for</span> (TimeSparseArray&lt;AtomicFile&gt; files : mSortedStatFiles) &#123;</span><br><span class="line">            <span class="comment">//【3.1】根据当前时间确定删除文件的参考点！</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> startIndex = files.closestIndexOnOrAfter(currentTimeMillis);</span><br><span class="line">            <span class="keyword">if</span> (startIndex &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【3.2】移除那些日期在当前时间之后的文件！</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> fileCount = files.size();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = startIndex; i &lt; fileCount; i++) &#123;</span><br><span class="line">                files.valueAt(i).delete();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = startIndex; i &lt; fileCount; i++) &#123;</span><br><span class="line">                files.removeAt(i);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>方法很简单，不多说了！</p>
<h3 id="2-1-1-UsageStatsDatabase-checkVersionAndBuildLocked"><a href="#2-1-1-UsageStatsDatabase-checkVersionAndBuildLocked" class="headerlink" title="2.1.1 UsageStatsDatabase.checkVersionAndBuildLocked"></a>2.1.1 UsageStatsDatabase.checkVersionAndBuildLocked</h3><p>checkVersionAndBuildLocked 用于检查版本变化！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkVersionAndBuildLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> version;</span><br><span class="line">    String buildFingerprint;</span><br><span class="line">    <span class="comment">// 获得当前系统的 Fingerprint！</span></span><br><span class="line">    String currentFingerprint = getBuildFingerprint();</span><br><span class="line">    mFirstUpdate = <span class="keyword">true</span>;</span><br><span class="line">    mNewUpdate = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">try</span> (BufferedReader reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> FileReader(mVersionFile))) &#123;</span><br><span class="line">        version = Integer.parseInt(reader.readLine());</span><br><span class="line">        <span class="comment">//【1】从 /data/system/usagestats/0version 中读取数据库中记录的Fingerprint！</span></span><br><span class="line">        <span class="comment">// 如果可以读取掉，说明不是第一次更新，那么 mFirstUpdate 为 false；</span></span><br><span class="line">        <span class="comment">// 如果当前系统的 Fingerprint 和数据库中的 Fingerprint 一样，说没有发生系统更新，mNewUpdate 为 false；</span></span><br><span class="line">        buildFingerprint = reader.readLine();</span><br><span class="line">        <span class="keyword">if</span> (buildFingerprint != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mFirstUpdate = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (currentFingerprint.equals(buildFingerprint)) &#123;</span><br><span class="line">            mNewUpdate = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NumberFormatException | IOException e) &#123;</span><br><span class="line">        version = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】如果 version 不等于 3，说明存在数据库升级！</span></span><br><span class="line">    <span class="keyword">if</span> (version != CURRENT_VERSION) &#123;</span><br><span class="line">        Slog.i(TAG, <span class="string">"Upgrading from version "</span> + version + <span class="string">" to "</span> + CURRENT_VERSION);</span><br><span class="line">        <span class="comment">//【2.1.1.1】升级数据库，删除旧文件！</span></span><br><span class="line">        doUpgradeLocked(version);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】当 如果 version 不等于 3 或者发生了系统更新，那就需要更新本地文件中的 Fingerprint！</span></span><br><span class="line">    <span class="keyword">if</span> (version != CURRENT_VERSION || mNewUpdate) &#123;</span><br><span class="line">        <span class="keyword">try</span> (BufferedWriter writer = <span class="keyword">new</span> BufferedWriter(<span class="keyword">new</span> FileWriter(mVersionFile))) &#123;</span><br><span class="line">            writer.write(Integer.toString(CURRENT_VERSION));</span><br><span class="line">            writer.write(<span class="string">"\n"</span>);</span><br><span class="line">            writer.write(currentFingerprint);</span><br><span class="line">            writer.write(<span class="string">"\n"</span>);</span><br><span class="line">            writer.flush();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            Slog.e(TAG, <span class="string">"Failed to write new version"</span>);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里我们不过多关注！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CURRENT_VERSION = <span class="number">3</span>;</span><br></pre></td></tr></table></figure>
<p>我们可以看到 UsageStatsDatabase 中定义了 CURRENT_VERSION 值为 3，表示当前版本号！</p>
<h4 id="2-1-1-1-UsageStatsDatabase-doUpgradeLocked"><a href="#2-1-1-1-UsageStatsDatabase-doUpgradeLocked" class="headerlink" title="2.1.1.1 UsageStatsDatabase.doUpgradeLocked"></a>2.1.1.1 UsageStatsDatabase.doUpgradeLocked</h4><p>处理数据库升级！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doUpgradeLocked</span><span class="params">(<span class="keyword">int</span> thisVersion)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (thisVersion &lt; <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="comment">// 删除掉 version 小于 2 的数据库！</span></span><br><span class="line">        Slog.i(TAG, <span class="string">"Deleting all usage stats files"</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mIntervalDirs.length; i++) &#123;</span><br><span class="line">            File[] files = mIntervalDirs[i].listFiles();</span><br><span class="line">            <span class="keyword">if</span> (files != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (File f : files) &#123;</span><br><span class="line">                    f.delete();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>其实就是删除本地持久化文件！</p>
<h3 id="2-1-2-UsageStatsDatabase-indexFilesLocked"><a href="#2-1-2-UsageStatsDatabase-indexFilesLocked" class="headerlink" title="2.1.2 UsageStatsDatabase.indexFilesLocked"></a>2.1.2 UsageStatsDatabase.indexFilesLocked</h3><p>indexFilesLocked 方法用于列出时间类别文件夹中的所有文件，并按照时间升序排序！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">indexFilesLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】创建一个文件过滤器，过滤掉那些文件后缀是 .bak 的备份文件！</span></span><br><span class="line">    <span class="keyword">final</span> FilenameFilter backupFileFilter = <span class="keyword">new</span> FilenameFilter() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">accept</span><span class="params">(File dir, String name)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> !name.endsWith(BAK_SUFFIX);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】遍历四个时间类别的文件夹，获得那个类别文件夹下，除去后缀为 .bak 的所有文件，</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mSortedStatFiles.length; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mSortedStatFiles[i] == <span class="keyword">null</span>) &#123;</span><br><span class="line">            mSortedStatFiles[i] = <span class="keyword">new</span> TimeSparseArray&lt;&gt;();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mSortedStatFiles[i].clear();</span><br><span class="line">        &#125;</span><br><span class="line">        File[] files = mIntervalDirs[i].listFiles(backupFileFilter);</span><br><span class="line">        <span class="keyword">if</span> (files != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                Slog.d(TAG, <span class="string">"Found "</span> + files.length + <span class="string">" stat files for interval "</span> + i);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (File f : files) &#123;</span><br><span class="line">                <span class="keyword">final</span> AtomicFile af = <span class="keyword">new</span> AtomicFile(f);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">//【2.1.2.1】调用 UsageStatsXml.parseBeginTime 计算文件的创建时间，然后</span></span><br><span class="line">                    <span class="comment">// 通过 time —&gt; AtomicFile 映射关系，保存到对应类别的 mSortedStatFiles[i] 中去！</span></span><br><span class="line">                    mSortedStatFiles[i].put(UsageStatsXml.parseBeginTime(af), af);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    Slog.e(TAG, <span class="string">"failed to index file: "</span> + f, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里设置到了一个文件后缀：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String BAK_SUFFIX = <span class="string">".bak"</span>;</span><br></pre></td></tr></table></figure></p>
<p>UsageStatsDatabase 会自动过滤掉 .bak 结尾的文件，因为 .bak 是备份文件！！</p>
<h4 id="2-1-2-1-UsageStatsXml-parseBeginTime"><a href="#2-1-2-1-UsageStatsXml-parseBeginTime" class="headerlink" title="2.1.2.1 UsageStatsXml.parseBeginTime"></a>2.1.2.1 UsageStatsXml.parseBeginTime</h4><p>这里用到了 UsageStatsXml，他是用来专门解析 usage 文件的：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">parseBeginTime</span><span class="params">(AtomicFile file)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> parseBeginTime(file.getBaseFile());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>继续调用：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">parseBeginTime</span><span class="params">(File file)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    String name = file.getName();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】如果文件名以 -c 结尾，返回去掉 -c 剩余的内容：</span></span><br><span class="line">    <span class="keyword">while</span> (name.endsWith(CHECKED_IN_SUFFIX)) &#123; </span><br><span class="line">        name = name.substring(<span class="number">0</span>, name.length() - CHECKED_IN_SUFFIX.length());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Long.parseLong(name);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IOException(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里我们可以看到，其实每一个时间类别的文件夹中的所有文件都是以其创建日期来命名的！</p>
<h2 id="2-2-UsageStatsDatabase-getLatestUsageStats-获得最新的使用信息"><a href="#2-2-UsageStatsDatabase-getLatestUsageStats-获得最新的使用信息" class="headerlink" title="2.2 UsageStatsDatabase.getLatestUsageStats - 获得最新的使用信息"></a>2.2 UsageStatsDatabase.getLatestUsageStats - 获得最新的使用信息</h2><p>返回指定时间类别 intervalType 的最新的使用状态信息！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IntervalStats <span class="title">getLatestUsageStats</span><span class="params">(<span class="keyword">int</span> intervalType)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="comment">//【1】校验 intervalType 的取值范围！</span></span><br><span class="line">        <span class="keyword">if</span> (intervalType &lt; <span class="number">0</span> || intervalType &gt;= mIntervalDirs.length) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Bad interval type "</span> + intervalType);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> fileCount = mSortedStatFiles[intervalType].size();</span><br><span class="line">        <span class="keyword">if</span> (fileCount == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//【2】因为 mSortedStatFiles[intervalType] 是按照时间顺序排序的，所以最新的状态信息文件</span></span><br><span class="line">            <span class="comment">// 一定是 fileCount - 1 对应的 AtomicFile!</span></span><br><span class="line">            <span class="keyword">final</span> AtomicFile f = mSortedStatFiles[intervalType].valueAt(fileCount - <span class="number">1</span>);</span><br><span class="line">            IntervalStats stats = <span class="keyword">new</span> IntervalStats();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//【2.2.1.1】调用 UsageStatsXml.read 从本地文件中读取信息，初始化 IntervalStats 对象！</span></span><br><span class="line">            UsageStatsXml.read(f, stats);</span><br><span class="line">            <span class="keyword">return</span> stats;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            Slog.e(TAG, <span class="string">"Failed to read usage stats file"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="2-2-1-UsageStatsXml-read"><a href="#2-2-1-UsageStatsXml-read" class="headerlink" title="2.2.1 UsageStatsXml.read"></a>2.2.1 UsageStatsXml.read</h3><p>read 读取文件！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">(AtomicFile file, IntervalStats statsOut)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        FileInputStream in = file.openRead();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//【2.1.2.1】调用 parseBeginTime 方法，初始化 statsOut.beginTime，可以看到</span></span><br><span class="line">            <span class="comment">// 文件名的时间戳，就是 statsOut.beginTime 的值！</span></span><br><span class="line">            statsOut.beginTime = parseBeginTime(file);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【2.2.2】调用自身的 read 方法，继续解析；</span></span><br><span class="line">            read(in, statsOut);</span><br><span class="line">            <span class="comment">// 获得文件上一次被更新的时间 statsOut.lastTimeSaved</span></span><br><span class="line">            statsOut.lastTimeSaved = file.getLastModifiedTime();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                in.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                <span class="comment">// Empty</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">        Slog.e(TAG, <span class="string">"UsageStats Xml"</span>, e);</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>通过这个阶段，我们获得了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">statsOut.beginTime; <span class="comment">// 文件开始记录的时间</span></span><br><span class="line">statsOut.lastTimeSaved; <span class="comment">// 文件最新修改的时间</span></span><br></pre></td></tr></table></figure>
<p>以上两个属性！</p>
<h3 id="2-2-2-UsageStatsXml-read"><a href="#2-2-2-UsageStatsXml-read" class="headerlink" title="2.2.2 UsageStatsXml.read"></a>2.2.2 UsageStatsXml.read</h3><p>继续解析：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">(InputStream in, IntervalStats statsOut)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    XmlPullParser parser = Xml.newPullParser();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        parser.setInput(in, <span class="string">"utf-8"</span>);</span><br><span class="line">        XmlUtils.beginDocument(parser, USAGESTATS_TAG); <span class="comment">// 解析 usagestats 标签</span></span><br><span class="line">        String versionStr = parser.getAttributeValue(<span class="keyword">null</span>, VERSION_ATTR); <span class="comment">// 解析 version 属性</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">switch</span> (Integer.parseInt(versionStr)) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                    <span class="comment">//【2.2.3】调用 UsageStatsXmlV1.read 继续解析</span></span><br><span class="line">                    <span class="comment">// 只有 version 置为 1 时才会继续解析；</span></span><br><span class="line">                    UsageStatsXmlV1.read(parser, statsOut);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    Slog.e(TAG, <span class="string">"Unrecognized version "</span> + versionStr);</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Unrecognized version "</span> + versionStr);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">            Slog.e(TAG, <span class="string">"Bad version"</span>);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IOException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (XmlPullParserException e) &#123;</span><br><span class="line">        Slog.e(TAG, <span class="string">"Failed to parse Xml"</span>, e);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IOException(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>第二个 read 方法更像是 version 校验！</p>
<p>这里对应的数据是：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">usagestats</span> <span class="attr">version</span>=<span class="string">"1"</span> <span class="attr">endTime</span>=<span class="string">"62979335"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">usagestats</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="2-2-3-UsageStatsXmlV1-read"><a href="#2-2-3-UsageStatsXmlV1-read" class="headerlink" title="2.2.3 UsageStatsXmlV1.read"></a>2.2.3 UsageStatsXmlV1.read</h3><p>最后，调用了 UsageStatsXmlV1 的 read 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">(XmlPullParser parser, IntervalStats statsOut)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</span><br><span class="line">    <span class="comment">//【1】清空 IntervalStats 的内部的集合！</span></span><br><span class="line">    statsOut.packageStats.clear();</span><br><span class="line">    statsOut.configurations.clear();</span><br><span class="line">    statsOut.activeConfiguration = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (statsOut.events != <span class="keyword">null</span>) &#123;</span><br><span class="line">        statsOut.events.clear();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2】计算 statsOut.endTime，等于 statsOut.beginTime 加上 endTime 的值！</span></span><br><span class="line">    statsOut.endTime = statsOut.beginTime + XmlUtils.readLongAttribute(parser, END_TIME_ATTR);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> eventCode;</span><br><span class="line">    <span class="keyword">int</span> outerDepth = parser.getDepth();</span><br><span class="line">    <span class="comment">//【3】接下来，根据使用信息的类别，进行不同的处理！</span></span><br><span class="line">    <span class="keyword">while</span> ((eventCode = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">            &amp;&amp; (eventCode != XmlPullParser.END_TAG || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (eventCode != XmlPullParser.START_TAG) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> String tag = parser.getName();</span><br><span class="line">        <span class="keyword">switch</span> (tag) &#123;</span><br><span class="line">            <span class="keyword">case</span> PACKAGE_TAG: <span class="comment">// package 标签</span></span><br><span class="line">                <span class="comment">//【2.2.3.1】如果该使用信息是 package 的，调用 loadUsageStats 解析！</span></span><br><span class="line">                loadUsageStats(parser, statsOut);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> CONFIG_TAG: <span class="comment">// config 标签</span></span><br><span class="line">                <span class="comment">//【2.2.3.2】如果该使用信息是 config 的，调用 loadConfigStats 解析！</span></span><br><span class="line">                loadConfigStats(parser, statsOut);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> EVENT_TAG: <span class="comment">// event 标签</span></span><br><span class="line">                <span class="comment">//【2.2.3.3】如果该使用信息是 event 的，调用 loadEvent 解析！</span></span><br><span class="line">                loadEvent(parser, statsOut);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该阶段，我们得到了如下的属性：</p>
<ul>
<li>statsOut.endTime，表示该使用信息文件记录的截至时间点，取值为 statsOut.beginTime + XmlUtils.readLongAttribute(parser, END_TIME_ATTR)；</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">usagestats</span> <span class="attr">version</span>=<span class="string">"1"</span> <span class="attr">endTime</span>=<span class="string">"62979335"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">usagestats</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>END_TIME_ATTR 对应着属性：endTime 属性，endTime 其实是一个时间间隔，距离 statsOut.beginTime 的时间间隔，statsOut.beginTime 和 statsOut.endTime 的时间段就是该文件能够记录的数据范围！</p>
<p>接着，解析 package，config 和 event 相关的使用信息！</p>
<h4 id="2-2-3-1-UsageStatsXmlV1-loadUsageStats-读取-UsageStats"><a href="#2-2-3-1-UsageStatsXmlV1-loadUsageStats-读取-UsageStats" class="headerlink" title="2.2.3.1 UsageStatsXmlV1.loadUsageStats - 读取 UsageStats"></a>2.2.3.1 UsageStatsXmlV1.loadUsageStats - 读取 UsageStats</h4><p>我们来看 package 标签和其属性：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">packages</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">package</span> <span class="attr">lastTimeActive</span>=<span class="string">"1104580"</span> <span class="attr">package</span>=<span class="string">"com.github.shadowsocks"</span> <span class="attr">timeActive</span>=<span class="string">"119959"</span> <span class="attr">lastEvent</span>=<span class="string">"2"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">packages</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>下面看看 解析 package 的使用信息！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">loadUsageStats</span><span class="params">(XmlPullParser parser, IntervalStats statsOut)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> String pkg = parser.getAttributeValue(<span class="keyword">null</span>, PACKAGE_ATTR);</span><br><span class="line">    <span class="keyword">if</span> (pkg == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ProtocolException(<span class="string">"no "</span> + PACKAGE_ATTR + <span class="string">" attribute present"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2.2.3.1.1】根据给定的 package，创建对应的 UsageStats！</span></span><br><span class="line">    <span class="keyword">final</span> UsageStats stats = statsOut.getOrCreateUsageStats(pkg);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】解析 lastTimeActive 属性，表示的是距离 beginTime 的时间间隔，</span></span><br><span class="line">    <span class="comment">// 初始化 stats.mLastTimeUsed，表示该 package 最后是使用的时间；</span></span><br><span class="line">    stats.mLastTimeUsed = statsOut.beginTime + XmlUtils.readLongAttribute(</span><br><span class="line">            parser, LAST_TIME_ACTIVE_ATTR);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】解析 timeActive 属性，获得 package 在前台的总时间，初始化 stats.mTotalTimeInForeground！</span></span><br><span class="line">    stats.mTotalTimeInForeground = XmlUtils.readLongAttribute(parser, TOTAL_TIME_ACTIVE_ATTR);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】解析 lastEvent 属性，获得 package 在最后一次触发的 event，保存到 stats.mLastEvent 中！</span></span><br><span class="line">    stats.mLastEvent = XmlUtils.readIntAttribute(parser, LAST_EVENT_ATTR);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先获得 pkg 对应的 UsageStats 对象，然后解析相关属性！</p>
<ul>
<li>lastTimeActive 属性用于计算最后一次处于 activie 的时间，它是一个距离 statsOut.beginTime 的时间间隔！</li>
</ul>
<p>通过 lastTimeActive + statsOut.beginTime，就能够计算出上一次使用的时间 stats.mLastTimeUsed！</p>
<ul>
<li><p>timeActive 属性表示其在处于 active 总时间，用于计算 stats.mTotalTimeInForeground；</p>
</li>
<li><p>lastEvent 属性表示上一次该 package 上报的时间类型，用于初始化 stats.mLastEvent；</p>
</li>
</ul>
<h5 id="2-2-3-1-1-IntervalStats-getOrCreateUsageStats"><a href="#2-2-3-1-1-IntervalStats-getOrCreateUsageStats" class="headerlink" title="2.2.3.1.1 IntervalStats.getOrCreateUsageStats"></a>2.2.3.1.1 IntervalStats.getOrCreateUsageStats</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">UsageStats <span class="title">getOrCreateUsageStats</span><span class="params">(String packageName)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】先从 packageStats 中获取 package 对应的 UsageStats！</span></span><br><span class="line">    UsageStats usageStats = packageStats.get(packageName);</span><br><span class="line">    <span class="keyword">if</span> (usageStats == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//【2】创建一个 UsageStats 对象！</span></span><br><span class="line">        usageStats = <span class="keyword">new</span> UsageStats();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 获得包名</span></span><br><span class="line">        usageStats.mPackageName = getCachedStringRef(packageName);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【3】很显然，该 package 的 usageStats.mBeginTimeStamp 和 usageStats.mEndTimeStamp </span></span><br><span class="line">        <span class="comment">// 和其所属的 IntervalStats 是一样的！</span></span><br><span class="line">        usageStats.mBeginTimeStamp = beginTime;</span><br><span class="line">        usageStats.mEndTimeStamp = endTime;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【4】将其添加到 packageStats 中去！</span></span><br><span class="line">        packageStats.put(usageStats.mPackageName, usageStats);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 返回</span></span><br><span class="line">    <span class="keyword">return</span> usageStats;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们知道 IntervalStats.packageStats 中保存的是应用的使用信息！</p>
<p>getCachedStringRef 优先从 IntervalStats.mStringCache 内部缓存中获取！</p>
<ul>
<li><p>创建了一个 UsageStats 对象，封装该 package 的使用信息！</p>
</li>
<li><p>计算 usageStats.mBeginTimeStamp 和 usageStats.mEndTimeStamp，等于所属 IntervalStats.beginTime 和 IntervalStats.beginTime！</p>
</li>
<li><p>将新创建的 UsageStats 添加到 packageStats 中！</p>
</li>
</ul>
<h4 id="2-2-3-2-UsageStatsXmlV1-loadConfigStats-读取-ConfigStats"><a href="#2-2-3-2-UsageStatsXmlV1-loadConfigStats-读取-ConfigStats" class="headerlink" title="2.2.3.2 UsageStatsXmlV1.loadConfigStats - 读取 ConfigStats"></a>2.2.3.2 UsageStatsXmlV1.loadConfigStats - 读取 ConfigStats</h4><p>我们来看看 config 的使用信息：<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;configurations&gt;</span><br><span class="line">    &lt;config lastTimeActive=<span class="string">"60709298"</span> timeActive=<span class="string">"60690625"</span> count=<span class="string">"3"</span> active=<span class="string">"true"</span></span><br><span class="line">            fs=<span class="string">"1065353216"</span> mcc=<span class="string">"460"</span> mnc=<span class="string">"65535"</span> </span><br><span class="line">locales=<span class="string">"zh-CN"</span> touch=<span class="string">"3"</span> key=<span class="string">"1"</span> keyHid=<span class="string">"1"</span></span><br><span class="line">hardKeyHid=<span class="string">"2"</span> nav=<span class="string">"1"</span> navHid=<span class="string">"2"</span> ori=<span class="string">"1"</span> scrLay=<span class="string">"268435810"</span> </span><br><span class="line">clrMod=<span class="string">"5"</span> ui=<span class="string">"17"</span> width=<span class="string">"360"</span> height=<span class="string">"685"</span> sw=<span class="string">"360"</span></span><br><span class="line">density=<span class="string">"480"</span> app_bounds=<span class="string">"0 0 1080 2136"</span> /&gt;</span><br><span class="line">&lt;/configurations&gt;</span><br></pre></td></tr></table></figure></p>
<p>下面我们来出解析 Configuration 的使用信息！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">loadConfigStats</span><span class="params">(XmlPullParser parser, IntervalStats statsOut)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</span><br><span class="line">    <span class="comment">//【1】创建了一个 Configuration 对象，并 readXmlAttrs 解析和配置文件相关的信息！</span></span><br><span class="line">    <span class="keyword">final</span> Configuration config = <span class="keyword">new</span> Configuration();</span><br><span class="line">    Configuration.readXmlAttrs(parser, config);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2.2.3.1.1】根据给定的 Configuration，创建对应的 ConfigurationStats！</span></span><br><span class="line">    <span class="keyword">final</span> ConfigurationStats configStats = statsOut.getOrCreateConfigurationStats(config);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】解析 lastTimeActive 属性，表示的是距离 beginTime 的时间间隔，</span></span><br><span class="line">    <span class="comment">// 初始化 stats.mLastTimeUsed，表示该 package 最后是使用的时间；</span></span><br><span class="line">    configStats.mLastTimeActive = statsOut.beginTime + XmlUtils.readLongAttribute(</span><br><span class="line">            parser, LAST_TIME_ACTIVE_ATTR);</span><br><span class="line">            </span><br><span class="line">    <span class="comment">//【2】解析 timeActive 属性，获得 Configuration 活跃的总时间，初始化 stats.mTotalTimeActive！</span></span><br><span class="line">    configStats.mTotalTimeActive = XmlUtils.readLongAttribute(parser, TOTAL_TIME_ACTIVE_ATTR);</span><br><span class="line">    <span class="comment">//【3】解析 count 属性，获得 Configuration 活跃的次数，初始化 stats.mActivationCount！</span></span><br><span class="line">    configStats.mActivationCount = XmlUtils.readIntAttribute(parser, COUNT_ATTR);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【4】解析 active 属性，判断该 Configuration 是否是活跃状态！</span></span><br><span class="line">    <span class="comment">// 初始化 statsOut.activeConfiguration！</span></span><br><span class="line">    <span class="keyword">if</span> (XmlUtils.readBooleanAttribute(parser, ACTIVE_ATTR)) &#123;</span><br><span class="line">        statsOut.activeConfiguration = configStats.mConfiguration;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>对于 Configuration，由于其属性配置很多，所以这里我们只关注和 UsageStats 相关的属性！</p>
<p>创建了一个 Configuration 对象，表示该配置信息对象，用于保存配置相关的属性！</p>
<p>创建该 config 对象的 ConfigurationStats 对象！</p>
<h5 id="2-2-3-2-1-IntervalStats-getOrCreateConfigurationStats"><a href="#2-2-3-2-1-IntervalStats-getOrCreateConfigurationStats" class="headerlink" title="2.2.3.2.1 IntervalStats.getOrCreateConfigurationStats"></a>2.2.3.2.1 IntervalStats.getOrCreateConfigurationStats</h5><p>获取或者创建 Configuration 对应的 ConfigurationStats 对象！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">ConfigurationStats <span class="title">getOrCreateConfigurationStats</span><span class="params">(Configuration config)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】先从 configurations 中获取 package 对应的 ConfigurationStats！</span></span><br><span class="line">    ConfigurationStats configStats = configurations.get(config);</span><br><span class="line">    <span class="keyword">if</span> (configStats == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//【2】如果没有，就创建一个 ConfigurationStats 对象！</span></span><br><span class="line">        configStats = <span class="keyword">new</span> ConfigurationStats();</span><br><span class="line">        <span class="comment">//【3】很显然，该 package 的 usageStats.mBeginTimeStamp 和 usageStats.mEndTimeStamp </span></span><br><span class="line">        <span class="comment">// 和其所属的 IntervalStats 是一样的！</span></span><br><span class="line">        configStats.mBeginTimeStamp = beginTime;</span><br><span class="line">        configStats.mEndTimeStamp = endTime;</span><br><span class="line">        <span class="comment">//【4】设置 configStats.mConfiguration；</span></span><br><span class="line">        configStats.mConfiguration = config;</span><br><span class="line">        <span class="comment">//【5】将其添加到 configurations 中！</span></span><br><span class="line">        configurations.put(config, configStats);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 返回</span></span><br><span class="line">    <span class="keyword">return</span> configStats;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="2-2-3-3-UsageStatsXmlV1-loadEvent-读取-Event"><a href="#2-2-3-3-UsageStatsXmlV1-loadEvent-读取-Event" class="headerlink" title="2.2.3.3 UsageStatsXmlV1.loadEvent - 读取 Event"></a>2.2.3.3 UsageStatsXmlV1.loadEvent - 读取 Event</h4><p>我们来看看 event 相关的数据</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;event-log&gt;</span><br><span class="line">    &lt;event time=<span class="string">"5852614"</span> <span class="keyword">package</span>=<span class="string">"com.tencent.mobileqq"</span></span><br><span class="line">           <span class="class"><span class="keyword">class</span></span>=<span class="string">"com.tencent.mobileqq.activity.QQLSActivity"</span> flags=<span class="string">"0"</span> type=<span class="string">"1"</span> /&gt;</span><br><span class="line">    &lt;event time=<span class="string">"5852617"</span> <span class="keyword">package</span>=<span class="string">"com.tencent.mobileqq"</span> </span><br><span class="line">           <span class="class"><span class="keyword">class</span></span>=<span class="string">"com.tencent.mobileqq.activity.QQLSActivity"</span> flags=<span class="string">"0"</span> type=<span class="string">"2"</span> /&gt;</span><br><span class="line">&lt;/event-log&gt;</span><br></pre></td></tr></table></figure>
<p>注意：只有 daily 类别的文件才有 event！</p>
<p>解析 UsageEvents 的使用信息！<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">private static void loadEvent(XmlPullParser parser, IntervalStats statsOut)</span><br><span class="line">        throws XmlPullParserException, IOException &#123;</span><br><span class="line">    //【1】解析 package 属性，获得该 event 所属的 pacakge！</span><br><span class="line">    final String packageName = XmlUtils.readStringAttribute(parser, PACKAGE_ATTR);</span><br><span class="line">    if (packageName == null) &#123;</span><br><span class="line">        throw new ProtocolException(&quot;no &quot; + PACKAGE_ATTR + &quot; attribute present&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    //【2】解析 class 属性，获得该 event 所属的 pacakge</span><br><span class="line">    final String className = XmlUtils.readStringAttribute(parser, CLASS_ATTR);</span><br><span class="line"></span><br><span class="line">    //【2.2.3.3.1】根据给定的 packageName 和 className，创建对应的 Event！</span><br><span class="line">    final UsageEvents.Event event = statsOut.buildEvent(packageName, className);</span><br><span class="line"></span><br><span class="line">    //【3】解析 lastTimeActive 属性，表示的是距离 statsOut.beginTime 的时间间隔，</span><br><span class="line">    // 初始化 event.mTimeStamp，表示该 event 的上报时间；</span><br><span class="line">    event.mTimeStamp = statsOut.beginTime + XmlUtils.readLongAttribute(parser, TIME_ATTR);</span><br><span class="line">    </span><br><span class="line">    //【4】解析 type 属性，初始化 event.mEventType，表示该 event 的类型；</span><br><span class="line">    event.mEventType = XmlUtils.readIntAttribute(parser, TYPE_ATTR);</span><br><span class="line">    </span><br><span class="line">    //【5】如果 event type 类型为 CONFIGURATION_CHANGE 或者 SHORTCUT_INVOCATION</span><br><span class="line">    // 还要解析其对应的 Configuration 和 shortcutId 属性！</span><br><span class="line">    switch (event.mEventType) &#123;</span><br><span class="line">        case UsageEvents.Event.CONFIGURATION_CHANGE:</span><br><span class="line">            event.mConfiguration = new Configuration();</span><br><span class="line">            Configuration.readXmlAttrs(parser, event.mConfiguration);</span><br><span class="line">            break;</span><br><span class="line"></span><br><span class="line">        case UsageEvents.Event.SHORTCUT_INVOCATION:</span><br><span class="line">            final String id = XmlUtils.readStringAttribute(parser, SHORTCUT_ID_ATTR);</span><br><span class="line">            event.mShortcutId = (id != null) ? id.intern() : null;</span><br><span class="line">            break;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (statsOut.events == null) &#123; // 如果 IntervalStats.events 为 null，初始化！</span><br><span class="line">        statsOut.events = new TimeSparseArray&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    //【6】将该 UsageEvents.Event 添加到 IntervalStats.events 中！</span><br><span class="line">    statsOut.events.put(event.mTimeStamp, event);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h5 id="2-2-3-3-1-IntervalStats-buildEvent"><a href="#2-2-3-3-1-IntervalStats-buildEvent" class="headerlink" title="2.2.3.3.1 IntervalStats.buildEvent"></a>2.2.3.3.1 IntervalStats.buildEvent</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">UsageEvents.<span class="function">Event <span class="title">buildEvent</span><span class="params">(String packageName, String className)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】创建一个 UsageEvents.Event 对象！</span></span><br><span class="line">    UsageEvents.Event event = <span class="keyword">new</span> UsageEvents.Event();</span><br><span class="line">    <span class="comment">//【2】初始化 event.mPackage 和 event.mClass 属性！</span></span><br><span class="line">    event.mPackage = getCachedStringRef(packageName);</span><br><span class="line">    <span class="keyword">if</span> (className != <span class="keyword">null</span>) &#123;</span><br><span class="line">        event.mClass = getCachedStringRef(className);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> event;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该方法只是创建 UsageEvents.Event 对象，但是其并没有将其添加到对应的集合中！</p>
<h2 id="2-3-UserUsageStatsService-loadActiveStats"><a href="#2-3-UserUsageStatsService-loadActiveStats" class="headerlink" title="2.3 UserUsageStatsService.loadActiveStats"></a>2.3 UserUsageStatsService.loadActiveStats</h2><p>loadActiveStats 用于给没有最新使用信息的时间类别创建新的 IntervalStats！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadActiveStats</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> currentTimeMillis)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】mCurrentStats 用于保存每个时间类别对应的最新的使用信息，这里开始遍历时间类别！</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> intervalType = <span class="number">0</span>; intervalType &lt; mCurrentStats.length; intervalType++) &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">//【2.2】通过 getLatestUsageStats 方法获得时间类别的最新使用信息！</span></span><br><span class="line">        <span class="keyword">final</span> IntervalStats stats = mDatabase.getLatestUsageStats(intervalType);</span><br><span class="line">        <span class="keyword">if</span> (stats != <span class="keyword">null</span> &amp;&amp; currentTimeMillis - <span class="number">500</span> &gt;= stats.endTime &amp;&amp;</span><br><span class="line">                currentTimeMillis &lt; stats.beginTime + INTERVAL_LENGTH[intervalType]) &#123;</span><br><span class="line">            <span class="comment">//【2】判断下当前时间是否在时间范围之内，如果是，该 IntervalStats 依然可以记录使用信息！</span></span><br><span class="line">            <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                Slog.d(TAG, mLogPrefix + <span class="string">"Loading existing stats @ "</span> +</span><br><span class="line">                        sDateFormat.format(stats.beginTime) + <span class="string">"("</span> + stats.beginTime +</span><br><span class="line">                        <span class="string">") for interval "</span> + intervalType);</span><br><span class="line">            &#125;</span><br><span class="line">            mCurrentStats[intervalType] = stats;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//【3】当前时间已经超过最新的 IntervalStats 能够记录的时间范围！</span></span><br><span class="line">            <span class="comment">// 或者某个时间类别没有对应的使用信息！</span></span><br><span class="line">            <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                Slog.d(TAG, <span class="string">"Creating new stats @ "</span> +</span><br><span class="line">                        sDateFormat.format(currentTimeMillis) + <span class="string">"("</span> +</span><br><span class="line">                        currentTimeMillis + <span class="string">") for interval "</span> + intervalType);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 创建一个新的 IntervalStats 对象，初始化 beginTime 为当前时间，endTime 为当前时间 + 1</span></span><br><span class="line">            mCurrentStats[intervalType] = <span class="keyword">new</span> IntervalStats();</span><br><span class="line">            mCurrentStats[intervalType].beginTime = currentTimeMillis;</span><br><span class="line">            mCurrentStats[intervalType].endTime = currentTimeMillis + <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【2.3】将 mStatsChanged 置为 false；</span></span><br><span class="line">    mStatsChanged = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2.4】更新回滚时间！</span></span><br><span class="line">    updateRolloverDeadline();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【×2.3.1】通知 UsageStatsService 该 userId 的最新使用信息重新加载了！</span></span><br><span class="line">    mListener.onStatsReloaded();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>UserUsageStatsService 内部有一个数组，用于表示每个时间类别对应的时间间隔长度：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span>[] INTERVAL_LENGTH = <span class="keyword">new</span> <span class="keyword">long</span>[] &#123;</span><br><span class="line">        UnixCalendar.DAY_IN_MILLIS, UnixCalendar.WEEK_IN_MILLIS,</span><br><span class="line">        UnixCalendar.MONTH_IN_MILLIS, UnixCalendar.YEAR_IN_MILLIS</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>UnixCalendar 我们在 1.1 有分析过，这里就不在多说了！</p>
<p>举个简单的例子，比如我们指定的时间类别是 daily，那么该 daily 类别下的最新数据要满足要求，当前时间必满足以下条件：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">currentTimeMillis &gt;= stats.endTime + <span class="number">500</span></span><br><span class="line"></span><br><span class="line">currentTimeMillis &lt; stats.beginTime + <span class="number">24</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">1000</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>stats.beginTime 表示的是该 IntervalStats 的创建时间，那么其最多能记录的信息是：stats.beginTime + 24 <em> 60 </em> 60 * 1000 之前的信息！</p>
</li>
<li><p>stats.endTime 表示的是该 IntervalStats 的目前已经记录的时间，那么如果该使用信息能够继续被更新，则有 currentTimeMillis - 500 &gt;= stats.endTime！</p>
</li>
</ul>
<p>其他类别的信息是同样的道理，所以 [stats.endTime + 500, stats.beginTime + 24 <em> 60 </em> 60 * 1000) 就是该 IntervalStats 还可以记录的时间范围！</p>
<h3 id="2-3-1-UsageStatsService-onStatsReloaded-回调"><a href="#2-3-1-UsageStatsService-onStatsReloaded-回调" class="headerlink" title="2.3.1 UsageStatsService.onStatsReloaded - 回调"></a>2.3.1 UsageStatsService.onStatsReloaded - 回调</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStatsReloaded</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    postOneTimeCheckIdleStates();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>loadActiveStats 方法根据当前时间，重新加载最新的数据，然后触发 UsageStatsService.onStatsReloaded 回调！</p>
<p>该方法会调用 postOneTimeCheckIdleStates 检查一次 idle 状态！</p>
<h2 id="2-4-UserUsageStatsService-updateRolloverDeadline"><a href="#2-4-UserUsageStatsService-updateRolloverDeadline" class="headerlink" title="2.4 UserUsageStatsService.updateRolloverDeadline"></a>2.4 UserUsageStatsService.updateRolloverDeadline</h2><p>更新回滚时间！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateRolloverDeadline</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】首先设置 mDailyExpiryDate 为 daily 时间类别下的最新日期的使用信息的开始记录时间点</span></span><br><span class="line">    mDailyExpiryDate.setTimeInMillis(</span><br><span class="line">            mCurrentStats[UsageStatsManager.INTERVAL_DAILY].beginTime);</span><br><span class="line">    <span class="comment">//【2】然后再加一天时间！</span></span><br><span class="line">    mDailyExpiryDate.addDays(<span class="number">1</span>);</span><br><span class="line">    Slog.i(TAG, mLogPrefix + <span class="string">"Rollover scheduled @ "</span> +</span><br><span class="line">            sDateFormat.format(mDailyExpiryDate.getTimeInMillis()) + <span class="string">"("</span> +</span><br><span class="line">            mDailyExpiryDate.getTimeInMillis() + <span class="string">")"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>updateRolloverDeadline 方法中，将 mDailyExpiryDate 先设置为了 mCurrentStats[UsageStatsManager.INTERVAL_DAILY].beginTime，然后再加了一天！</p>
<p>所以 updateRolloverDeadline 计算的是下一天使用信息的开始记录时间！mDailyExpiryDate 可以看作是否超过一天的临界时间点！</p>
<h2 id="2-5-IntervalStats-update"><a href="#2-5-IntervalStats-update" class="headerlink" title="2.5 IntervalStats.update"></a>2.5 IntervalStats.update</h2><p>我们看到，在 init 方法中：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (pkgStats.mLastEvent == UsageEvents.Event.MOVE_TO_FOREGROUND ||</span><br><span class="line">        pkgStats.mLastEvent == UsageEvents.Event.CONTINUE_PREVIOUS_DAY) &#123;</span><br><span class="line">    ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>只有满足以上条件，才会进入 IntervalStats.update 方法中！</p>
<p>update 用于跟更新 packageName 对应的 UsageStats 相关属性！</p>
<ul>
<li><strong>long timeStamp 传入的是 IntervalStats.lastTimeSaved，表示 IntervalStats 最后被修改/更新的时间点</strong>；</li>
<li>int eventType 传入的是 UsageEvents.Event.END_OF_DAY，表示本次要设置的 eventType；</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">update</span><span class="params">(String packageName, <span class="keyword">long</span> timeStamp, <span class="keyword">int</span> eventType)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【2.2.3.1.1】获得该 packageName 对应的 UsageStats 实例！</span></span><br><span class="line">    UsageStats usageStats = getOrCreateUsageStats(packageName);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】如果本次的 eventType 为  MOVE_TO_BACKGROUND 或者 END_OF_DAY，进入这个 if 条件！</span></span><br><span class="line">    <span class="keyword">if</span> (eventType == UsageEvents.Event.MOVE_TO_BACKGROUND ||</span><br><span class="line">            eventType == UsageEvents.Event.END_OF_DAY) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【1.1】并且 UsageStats.mLastEvent 的取值为 MOVE_TO_FOREGROUND 或者 CONTINUE_PREVIOUS_DAY</span></span><br><span class="line">        <span class="comment">// 的话，才修改 package 的 mTotalTimeInForeground！</span></span><br><span class="line">        <span class="keyword">if</span> (usageStats.mLastEvent == UsageEvents.Event.MOVE_TO_FOREGROUND ||</span><br><span class="line">                usageStats.mLastEvent == UsageEvents.Event.CONTINUE_PREVIOUS_DAY) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【1.1.1】更新 package 在前台的总时间 mTotalTimeInForeground 为：</span></span><br><span class="line">            <span class="comment">// 在已有基础上再加上 timeStamp  - usageStats.mLastTimeUsed</span></span><br><span class="line">            usageStats.mTotalTimeInForeground += timeStamp - usageStats.mLastTimeUsed;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2.5.1】如果 eventType 属于 Stateful Event</span></span><br><span class="line">    <span class="comment">// 那就更新该 pacakge 的 usageStats.mLastEvent（上一次事件）为 eventType；</span></span><br><span class="line">    <span class="keyword">if</span> (isStatefulEvent(eventType)) &#123;</span><br><span class="line">        usageStats.mLastEvent = eventType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】如果 eventType 不是 UsageEvents.Event.SYSTEM_INTERACTION，更新上次使用时间 </span></span><br><span class="line">    <span class="comment">// usageStats.mLastTimeUsed 为 timeStamp！</span></span><br><span class="line">    <span class="comment">// 因为 SYSTEM_INTERACTION 本质上是系统对 package 的操作，不会统计进去！</span></span><br><span class="line">    <span class="keyword">if</span> (eventType != UsageEvents.Event.SYSTEM_INTERACTION) &#123;</span><br><span class="line">        usageStats.mLastTimeUsed = timeStamp;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【4】更新该 package 的 usageStats.mEndTimeStamp 为 timeStamp；</span></span><br><span class="line">    usageStats.mEndTimeStamp = timeStamp;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【5】如果 eventType 为 MOVE_TO_FOREGROUND，该 package 的 usageStats.mLaunchCount（启动次数）加一；</span></span><br><span class="line">    <span class="keyword">if</span> (eventType == UsageEvents.Event.MOVE_TO_FOREGROUND) &#123;</span><br><span class="line">        usageStats.mLaunchCount += <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【6】同时修改 IntervalStats.endTime 也为 timeStamp；</span></span><br><span class="line">    endTime = timeStamp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>整个过程如下：</p>
<ul>
<li>获得该 package 的 UsageStats 对象！</li>
</ul>
<p><br></p>
<ul>
<li>如果本次要更新的 eventType 为  <strong>MOVE_TO_BACKGROUND</strong> / <strong>END_OF_DAY</strong>，并且该 package 的 LastEvent 为 <strong>MOVE_TO_FOREGROUND</strong> / <strong>CONTINUE_PREVIOUS_DAY</strong><ul>
<li>这种情况是 package 从前台退到了后台，</li>
<li>这是我们会更新 package 的在前台的总时间 mTotalTimeInForeground = mTotalTimeInForeground + timeStamp - mLastTimeUsed；</li>
</ul>
</li>
</ul>
<p><br></p>
<ul>
<li>如果本次要更新的 eventType 为 Stateful Event，我们也会更新 package 的 mLastEvent 为 eventType；</li>
</ul>
<p><br></p>
<ul>
<li>如果本次要更新的 eventType 不是 SYSTEM_INTERACTION，那么我们会更新 package 的 mLastTimeUsed 为 timeStamp；</li>
</ul>
<p><br></p>
<ul>
<li>更新 package 的 mEndTimeStamp 为 timeStamp；同时更新对应的 IntervalStats 的 endTime 也为 timeStamp；</li>
</ul>
<p><br></p>
<ul>
<li>如果本次要更新的 eventType 不是 SYSTEM_INTERACTION，那么我们会更新 package 的 mLastTimeUsed 为 timeStamp；同时更新对应的 IntervalStats 的 endTime 也为 timeStamp；</li>
</ul>
<h3 id="2-5-1-IntervalStats-isStatefulEvent"><a href="#2-5-1-IntervalStats-isStatefulEvent" class="headerlink" title="2.5.1 IntervalStats.isStatefulEvent"></a>2.5.1 IntervalStats.isStatefulEvent</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isStatefulEvent</span><span class="params">(<span class="keyword">int</span> eventType)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (eventType) &#123;</span><br><span class="line">        <span class="keyword">case</span> UsageEvents.Event.MOVE_TO_FOREGROUND:</span><br><span class="line">        <span class="keyword">case</span> UsageEvents.Event.MOVE_TO_BACKGROUND:</span><br><span class="line">        <span class="keyword">case</span> UsageEvents.Event.END_OF_DAY:</span><br><span class="line">        <span class="keyword">case</span> UsageEvents.Event.CONTINUE_PREVIOUS_DAY:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>判断 eventType 是否是 stateful event！</p>
<h2 id="2-6-UserUsageStatsService-notifyStatsChanged"><a href="#2-6-UserUsageStatsService-notifyStatsChanged" class="headerlink" title="2.6 UserUsageStatsService.notifyStatsChanged"></a>2.6 UserUsageStatsService.notifyStatsChanged</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">notifyStatsChanged</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】只有 mStatsChanged 为 false 时，才通知 UsageStatsService！</span></span><br><span class="line">    <span class="keyword">if</span> (!mStatsChanged) &#123;</span><br><span class="line">        <span class="comment">//【1.1】设置 mStatsChanged 为 true；</span></span><br><span class="line">        mStatsChanged = <span class="keyword">true</span>;</span><br><span class="line">        <span class="comment">//【1.2】通知 UsageStatsService，IntervalStats 数据发生了变化！</span></span><br><span class="line">        mListener.onStatsUpdated();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>mStatsChanged 表示的是使用信息是否发生变化！</p>
<p>当 IntervalStats 的数据发生变化后，会触发 notifyStatsChanged 方法！</p>
<h3 id="2-6-1-UsageStatsService-onStatsUpdated-回调"><a href="#2-6-1-UsageStatsService-onStatsUpdated-回调" class="headerlink" title="2.6.1 UsageStatsService.onStatsUpdated - 回调"></a>2.6.1 UsageStatsService.onStatsUpdated - 回调</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStatsUpdated</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mHandler.sendEmptyMessageDelayed(MSG_FLUSH_TO_DISK, FLUSH_INTERVAL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>UsageStatsService 的 onStatsUpdated 方法触发后，会延迟 20mins 后发送 MSG_FLUSH_TO_DISK 给 H！</p>
<p>这样也保证了不会频繁的通知和保存！！</p>
<h2 id="2-7-IntervalStats-updateConfigurationStats"><a href="#2-7-IntervalStats-updateConfigurationStats" class="headerlink" title="2.7 IntervalStats.updateConfigurationStats"></a>2.7 IntervalStats.updateConfigurationStats</h2><p>更新指定配置的信息！</p>
<ul>
<li>Configuration confi： 是要成为 active config 的配置对象，这里传入的是 null；</li>
<li>long timeStamp：传入的是 stat.lastTimeSaved（IntervalStats 自身上一次被更新的时间）；</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">updateConfigurationStats</span><span class="params">(Configuration config, <span class="keyword">long</span> timeStamp)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】如果 activeConfiguration 不为 null，说明已经有配置信息处于 active 状态！</span></span><br><span class="line">    <span class="comment">// 那就更新其时间信息！</span></span><br><span class="line">    <span class="keyword">if</span> (activeConfiguration != <span class="keyword">null</span>) &#123;</span><br><span class="line">        ConfigurationStats activeStats = configurations.get(activeConfiguration);</span><br><span class="line">        <span class="comment">//【1.1】更新 active config 总的活跃时间 mTotalTimeActive 为：在其基础上加上</span></span><br><span class="line">        <span class="comment">// timeStamp 减去上一次活跃时间（mLastTimeActive）</span></span><br><span class="line">        activeStats.mTotalTimeActive += timeStamp - activeStats.mLastTimeActive;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【1.2】更新上次活跃时间 mLastTimeActive 为上次被更新的时间（timeStamp）减去 1；</span></span><br><span class="line">        activeStats.mLastTimeActive = timeStamp - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】更新 config 指定的配置的信息。因为我们这里传入的是 null，所以不会进入；</span></span><br><span class="line">    <span class="keyword">if</span> (config != <span class="keyword">null</span>) &#123;</span><br><span class="line">        ConfigurationStats configStats = getOrCreateConfigurationStats(config);</span><br><span class="line">        <span class="comment">//【2.1】更新 config 上次活跃时间 mLastTimeActive 为 timeStamp</span></span><br><span class="line">        configStats.mLastTimeActive = timeStamp;</span><br><span class="line">        <span class="comment">//【2.2】更新 config 的活跃次数；</span></span><br><span class="line">        configStats.mActivationCount += <span class="number">1</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【2.3】更新 IntervalStats.activeConfiguration 为指定的 config！</span></span><br><span class="line">        activeConfiguration = configStats.mConfiguration;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【3】更新 IntervalStats.endTime 为上一次被更新的时间 ！timeStamp</span></span><br><span class="line">    endTime = timeStamp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为这里我们传入的是 Configuration config 为 null，所以只会尝试更新 activeConfiguration 的时间信息！</p>
<h2 id="2-8-UserUsageStatsService-notifyNewUpdate"><a href="#2-8-UserUsageStatsService-notifyNewUpdate" class="headerlink" title="2.8 UserUsageStatsService.notifyNewUpdate"></a>2.8 UserUsageStatsService.notifyNewUpdate</h2><p>当系统发生了升级后，UserUsageStatsService 会调用 notifyNewUpdate 通知 UsageStatsService!<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">notifyNewUpdate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【*2.8.1】这里的 mListener 就是 UsageStatsService！</span></span><br><span class="line">    mListener.onNewUpdate(mUserId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里就不多说了！</p>
<h3 id="2-8-1-UsageStatsService-onNewUpdate-回调"><a href="#2-8-1-UsageStatsService-onNewUpdate-回调" class="headerlink" title="2.8.1 UsageStatsService.onNewUpdate - 回调"></a>2.8.1 UsageStatsService.onNewUpdate - 回调</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNewUpdate</span><span class="params">(<span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    initializeDefaultsForSystemApps(userId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果出现了系统升级的情况，那么 UsageStatsService 的 onNewUpdate 方法会调用，然后执行 initializeDefaultsForSystemApps 方法，对系统 App 的信息做初始化！</p>
<h2 id="2-9-流程总结"><a href="#2-9-流程总结" class="headerlink" title="2.9 流程总结"></a>2.9 流程总结</h2><h1 id="3-UserUsageStatsService-onTimeChanged-处理时间变化"><a href="#3-UserUsageStatsService-onTimeChanged-处理时间变化" class="headerlink" title="3 UserUsageStatsService.onTimeChanged - 处理时间变化"></a>3 UserUsageStatsService.onTimeChanged - 处理时间变化</h1><p>处理时间改变的情况！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">onTimeChanged</span><span class="params">(<span class="keyword">long</span> oldTime, <span class="keyword">long</span> newTime)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【×3.1】持久化处于内存中的最新数据！</span></span><br><span class="line">    persistActiveStats();</span><br><span class="line">    <span class="comment">//【×3.2】通知数据库时间发生了变化！</span></span><br><span class="line">    mDatabase.onTimeChanged(newTime - oldTime);</span><br><span class="line">    <span class="comment">//【×2.3】再次加载最新日期的数据！</span></span><br><span class="line">    loadActiveStats(newTime);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>整个方法的逻辑如下：</p>
<ul>
<li>先将内存中的数据持久化到本地文件中；</li>
<li>然后处理下时间变化；</li>
<li>再次加载本地数据到内存中；</li>
</ul>
<p>对于 loadActiveStats 方法，我们在前面是有分析过的，该过程的主要逻辑如下：</p>
<ul>
<li>先将最新日期的内存数据写回本地持久化文件；</li>
<li>处理时间变化后，持久化文件的名称修改，然后对改名后的文件重新排序，加载到内存中；</li>
<li>重新加载最新日期的使用数据！</li>
</ul>
<h2 id="3-0-调用时机"><a href="#3-0-调用时机" class="headerlink" title="3.0 调用时机"></a>3.0 调用时机</h2><p>在 UsageStatsService 的 checkAndGetTimeLocked 会计算当前的实际时间，判断是否有调时发生！</p>
<p>如果有的话，会触发 UserUsageStatsService.onTimeChanged 方法！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">long</span> <span class="title">checkAndGetTimeLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> actualSystemTime = System.currentTimeMillis();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> actualRealtime = SystemClock.elapsedRealtime();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> expectedSystemTime = (actualRealtime - mRealTimeSnapshot) + mSystemTimeSnapshot;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> diffSystemTime = actualSystemTime - expectedSystemTime;</span><br><span class="line">    <span class="keyword">if</span> (Math.abs(diffSystemTime) &gt; TIME_CHANGE_THRESHOLD_MILLIS) &#123;</span><br><span class="line">        <span class="comment">// The time has changed.</span></span><br><span class="line">        Slog.i(TAG, <span class="string">"Time changed in UsageStats by "</span> + (diffSystemTime / <span class="number">1000</span>) + <span class="string">" seconds"</span>);</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> userCount = mUserState.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; userCount; i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> UserUsageStatsService service = mUserState.valueAt(i);</span><br><span class="line">            <span class="comment">//【×3】会触发 onTimeChanged 方法！</span></span><br><span class="line">            service.onTimeChanged(expectedSystemTime, actualSystemTime);</span><br><span class="line">        &#125;</span><br><span class="line">        mRealTimeSnapshot = actualRealtime;</span><br><span class="line">        mSystemTimeSnapshot = actualSystemTime;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> actualSystemTime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于 checkAndGetTimeLocked 的逻辑，这里不再多说！</p>
<h2 id="3-1-UserUsageStatsService-persistActiveStats"><a href="#3-1-UserUsageStatsService-persistActiveStats" class="headerlink" title="3.1 UserUsageStatsService.persistActiveStats"></a>3.1 UserUsageStatsService.persistActiveStats</h2><p>persistActiveStats 将最新的缓存数据保存到本地文件中！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">persistActiveStats</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】只有当 mStatsChanged 为 true 是才会更新本地文件！</span></span><br><span class="line">    <span class="keyword">if</span> (mStatsChanged) &#123;</span><br><span class="line">        Slog.i(TAG, mLogPrefix + <span class="string">"Flushing usage stats to disk"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//【×3.1.1】更新数据到本地文件！</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mCurrentStats.length; i++) &#123;</span><br><span class="line">                mDatabase.putUsageStats(i, mCurrentStats[i]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【2】更新完成后会将 mStatsChanged 置为 false！</span></span><br><span class="line">            mStatsChanged = <span class="keyword">false</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            Slog.e(TAG, mLogPrefix + <span class="string">"Failed to persist active stats"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行 persistActiveStats 前，会先做一次判断，如果时间发生了变化，并且内存中的使用信息有更新过，即 mStatsChanged 为 true，才会触发回写本地文件的操作！</p>
<p>mCurrentStats 数组中保存的是当前最新的数据！</p>
<h3 id="3-1-1-UsageStatsDatabase-putUsageStats"><a href="#3-1-1-UsageStatsDatabase-putUsageStats" class="headerlink" title="3.1.1 UsageStatsDatabase.putUsageStats"></a>3.1.1 UsageStatsDatabase.putUsageStats</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">putUsageStats</span><span class="params">(<span class="keyword">int</span> intervalType, IntervalStats stats)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (stats == <span class="keyword">null</span>) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="comment">//【1】校验 intervalType 的取值范围！</span></span><br><span class="line">        <span class="keyword">if</span> (intervalType &lt; <span class="number">0</span> || intervalType &gt;= mIntervalDirs.length) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Bad interval type "</span> + intervalType);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【2】获得 IntervalStats 对应的本地文件 AtomicFile 对象！</span></span><br><span class="line">        <span class="comment">// 如果没有找到，就创建一个新的 AtomicFile，并添加到 mSortedStatFiles 中！</span></span><br><span class="line">        AtomicFile f = mSortedStatFiles[intervalType].get(stats.beginTime);</span><br><span class="line">        <span class="keyword">if</span> (f == <span class="keyword">null</span>) &#123;</span><br><span class="line">            f = <span class="keyword">new</span> AtomicFile(<span class="keyword">new</span> File(mIntervalDirs[intervalType],</span><br><span class="line">                    Long.toString(stats.beginTime)));</span><br><span class="line">            mSortedStatFiles[intervalType].put(stats.beginTime, f);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//【3.1.2】调用 UsageStatsXml 的 write 方法将数据写到本地文件中！</span></span><br><span class="line">        UsageStatsXml.write(f, stats);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【4】更新 stats.lastTimeSaved</span></span><br><span class="line">        stats.lastTimeSaved = f.getLastModifiedTime();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-1-2-UsageStatsXml-write"><a href="#3-1-2-UsageStatsXml-write" class="headerlink" title="3.1.2 UsageStatsXml.write"></a>3.1.2 UsageStatsXml.write</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(AtomicFile file, IntervalStats stats)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    FileOutputStream fos = file.startWrite();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 调用另外一个 write 方法！</span></span><br><span class="line">        write(fos, stats);</span><br><span class="line">        file.finishWrite(fos);</span><br><span class="line">        fos = <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// When fos is null (successful write), this will no-op</span></span><br><span class="line">        file.failWrite(fos);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用了另外一个 write 方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(OutputStream out, IntervalStats stats)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    FastXmlSerializer xml = <span class="keyword">new</span> FastXmlSerializer();</span><br><span class="line">    xml.setOutput(out, <span class="string">"utf-8"</span>);</span><br><span class="line">    xml.startDocument(<span class="string">"utf-8"</span>, <span class="keyword">true</span>);</span><br><span class="line">    xml.setFeature(<span class="string">"http://xmlpull.org/v1/doc/features.html#indent-output"</span>, <span class="keyword">true</span>);</span><br><span class="line">    xml.startTag(<span class="keyword">null</span>, USAGESTATS_TAG); <span class="comment">// 处理 usagestats 标签</span></span><br><span class="line">    xml.attribute(<span class="keyword">null</span>, VERSION_ATTR, Integer.toString(CURRENT_VERSION)); <span class="comment">// 处理 version 属性，值为 1；</span></span><br><span class="line">    <span class="comment">// 继续调用 UsageStatsXmlV1.write 方法写入！</span></span><br><span class="line">    UsageStatsXmlV1.write(xml, stats);</span><br><span class="line"></span><br><span class="line">    xml.endTag(<span class="keyword">null</span>, USAGESTATS_TAG);</span><br><span class="line">    xml.endDocument();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="3-1-3-UsageStatsXmlV1-write"><a href="#3-1-3-UsageStatsXmlV1-write" class="headerlink" title="3.1.3 UsageStatsXmlV1.write"></a>3.1.3 UsageStatsXmlV1.write</h3><p>该方法最终写入本地文件！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(XmlSerializer xml, IntervalStats stats)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    XmlUtils.writeLongAttribute(xml, END_TIME_ATTR, stats.endTime - stats.beginTime);</span><br><span class="line"></span><br><span class="line">    xml.startTag(<span class="keyword">null</span>, PACKAGES_TAG); <span class="comment">// 写入 packages 标签</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> statsCount = stats.packageStats.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; statsCount; i++) &#123;</span><br><span class="line">        <span class="comment">//【3.1.3.1】写入 package 的使用信息；</span></span><br><span class="line">        writeUsageStats(xml, stats, stats.packageStats.valueAt(i));</span><br><span class="line">    &#125;</span><br><span class="line">    xml.endTag(<span class="keyword">null</span>, PACKAGES_TAG);</span><br><span class="line"></span><br><span class="line">    xml.startTag(<span class="keyword">null</span>, CONFIGURATIONS_TAG); <span class="comment">// 写入 configurations 标签</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> configCount = stats.configurations.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; configCount; i++) &#123;</span><br><span class="line">        <span class="comment">//【3.1.3.2】写入 Configuration 的使用信息；</span></span><br><span class="line">        <span class="keyword">boolean</span> active = stats.activeConfiguration.equals(stats.configurations.keyAt(i));</span><br><span class="line">        writeConfigStats(xml, stats, stats.configurations.valueAt(i), active);</span><br><span class="line">    &#125;</span><br><span class="line">    xml.endTag(<span class="keyword">null</span>, CONFIGURATIONS_TAG);</span><br><span class="line"></span><br><span class="line">    xml.startTag(<span class="keyword">null</span>, EVENT_LOG_TAG); <span class="comment">// 写入 event-log 标签</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> eventCount = stats.events != <span class="keyword">null</span> ? stats.events.size() : <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; eventCount; i++) &#123;</span><br><span class="line">         <span class="comment">//【3.1.3.3】写入 Event 的上报信息；</span></span><br><span class="line">        writeEvent(xml, stats, stats.events.valueAt(i));</span><br><span class="line">    &#125;</span><br><span class="line">    xml.endTag(<span class="keyword">null</span>, EVENT_LOG_TAG);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该过程主要是写入 package，Configuration，Event 的相关信息！</p>
<h4 id="3-1-3-1-UsageStatsXmlV1-writeUsageStats"><a href="#3-1-3-1-UsageStatsXmlV1-writeUsageStats" class="headerlink" title="3.1.3.1 UsageStatsXmlV1.writeUsageStats"></a>3.1.3.1 UsageStatsXmlV1.writeUsageStats</h4><p>IntervalStats stats 是使用信息记录文件的缓存对象；UsageStats usageStats 是该 package 的缓存对象！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">writeUsageStats</span><span class="params">(XmlSerializer xml, <span class="keyword">final</span> IntervalStats stats,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> UsageStats usageStats)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    xml.startTag(<span class="keyword">null</span>, PACKAGE_TAG); <span class="comment">// 写入 package 标签；</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 写入 lastTimeActive 属性，取值为 usageStats.mLastTimeUsed - stats.beginTime；</span></span><br><span class="line">    XmlUtils.writeLongAttribute(xml, LAST_TIME_ACTIVE_ATTR,</span><br><span class="line">            usageStats.mLastTimeUsed - stats.beginTime);</span><br><span class="line">    <span class="comment">// 写入 package 属性，取值为 usageStats.mPackageName；</span></span><br><span class="line">    XmlUtils.writeStringAttribute(xml, PACKAGE_ATTR, usageStats.mPackageName);</span><br><span class="line">    <span class="comment">// 写入 timeActive 属性，取值为 usageStats.mTotalTimeInForeground；</span></span><br><span class="line">    XmlUtils.writeLongAttribute(xml, TOTAL_TIME_ACTIVE_ATTR, usageStats.mTotalTimeInForeground);</span><br><span class="line">    <span class="comment">// 写入 lastEvent 属性，取值为 usageStats.mLastEvent；</span></span><br><span class="line">    XmlUtils.writeIntAttribute(xml, LAST_EVENT_ATTR, usageStats.mLastEvent);</span><br><span class="line"></span><br><span class="line">    xml.endTag(<span class="keyword">null</span>, PACKAGE_TAG);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>写入 package 的使用信息：</p>
<ul>
<li>写入 lastTimeActive 属性，取值为 usageStats.mLastTimeUsed - stats.beginTime；</li>
<li>写入 package 属性，取值为 usageStats.mPackageName；</li>
<li>写入 timeActive 属性，取值为 usageStats.mTotalTimeInForeground；</li>
<li>写入 lastEvent 属性，取值为 usageStats.mLastEvent；</li>
</ul>
<h4 id="3-1-3-2-UsageStatsXmlV1-writeConfigStats"><a href="#3-1-3-2-UsageStatsXmlV1-writeConfigStats" class="headerlink" title="3.1.3.2 UsageStatsXmlV1.writeConfigStats"></a>3.1.3.2 UsageStatsXmlV1.writeConfigStats</h4><p>IntervalStats stats 是使用信息记录文件的缓存对象；ConfigurationStats configStats 是该 config 的缓存对象，boolean isActive 表示该 config 是否是处于活跃状态！！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">writeConfigStats</span><span class="params">(XmlSerializer xml, <span class="keyword">final</span> IntervalStats stats,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> ConfigurationStats configStats, <span class="keyword">boolean</span> isActive)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    xml.startTag(<span class="keyword">null</span>, CONFIG_TAG); <span class="comment">// 写入 configurations 标签</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 写入 lastTimeActive 属性，取值为 usageStats.mLastTimeUsed - stats.beginTime；</span></span><br><span class="line">    XmlUtils.writeLongAttribute(xml, LAST_TIME_ACTIVE_ATTR,</span><br><span class="line">            configStats.mLastTimeActive - stats.beginTime);</span><br><span class="line">    <span class="comment">// 写入 timeActive 属性，取值为 configStats.mTotalTimeActive；</span></span><br><span class="line">    XmlUtils.writeLongAttribute(xml, TOTAL_TIME_ACTIVE_ATTR, configStats.mTotalTimeActive);</span><br><span class="line">    <span class="comment">// 写入 count 属性，取值为 configStats.mActivationCount；</span></span><br><span class="line">    XmlUtils.writeIntAttribute(xml, COUNT_ATTR, configStats.mActivationCount);</span><br><span class="line">    <span class="comment">// 如果该 config 是当前处于 active 状态，写入 active 属性，true；</span></span><br><span class="line">    <span class="keyword">if</span> (isActive) &#123;</span><br><span class="line">        XmlUtils.writeBooleanAttribute(xml, ACTIVE_ATTR, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 接着就是写入 Configuration 的配置信息了！</span></span><br><span class="line">    Configuration.writeXmlAttrs(xml, configStats.mConfiguration);</span><br><span class="line"></span><br><span class="line">    xml.endTag(<span class="keyword">null</span>, CONFIG_TAG);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>写入 Config 的使用信息：</p>
<ul>
<li>写入 lastTimeActive 属性，取值为 usageStats.mLastTimeUsed - stats.beginTime；</li>
<li>写入 timeActive 属性，取值为 configStats.mTotalTimeActive；</li>
<li>写入 count 属性，取值为 configStats.mActivationCount；</li>
<li>如果该 config 是当前处于 active 状态，写入 active 属性，true；</li>
<li>接着就是写入 Configuration 的配置信息了！</li>
</ul>
<h4 id="3-1-3-3-UsageStatsXmlV1-writeEvent"><a href="#3-1-3-3-UsageStatsXmlV1-writeEvent" class="headerlink" title="3.1.3.3 UsageStatsXmlV1.writeEvent"></a>3.1.3.3 UsageStatsXmlV1.writeEvent</h4><p>IntervalStats stats 是使用信息记录文件的缓存对象；UsageEvents.Event event 是该 event 的缓存对象！！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">writeEvent</span><span class="params">(XmlSerializer xml, <span class="keyword">final</span> IntervalStats stats,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">final</span> UsageEvents.Event event)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    xml.startTag(<span class="keyword">null</span>, EVENT_TAG); <span class="comment">// 写入 event 标签</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 写入 time 属性，取值为 event.mTimeStamp - stats.beginTime；</span></span><br><span class="line">    XmlUtils.writeLongAttribute(xml, TIME_ATTR, event.mTimeStamp - stats.beginTime);</span><br><span class="line">    <span class="comment">// 写入 package 属性和 class 属性，取值为 event.mPackage 和 event.mClass！</span></span><br><span class="line">    XmlUtils.writeStringAttribute(xml, PACKAGE_ATTR, event.mPackage);</span><br><span class="line">    <span class="keyword">if</span> (event.mClass != <span class="keyword">null</span>) &#123;</span><br><span class="line">        XmlUtils.writeStringAttribute(xml, CLASS_ATTR, event.mClass);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 写入 type 属性，取值为 event.mEventType！</span></span><br><span class="line">    XmlUtils.writeIntAttribute(xml, TYPE_ATTR, event.mEventType);</span><br><span class="line">    <span class="comment">// 根据 EventType，写入额外的信息！</span></span><br><span class="line">    <span class="keyword">switch</span> (event.mEventType) &#123;</span><br><span class="line">        <span class="keyword">case</span> UsageEvents.Event.CONFIGURATION_CHANGE:</span><br><span class="line">            <span class="keyword">if</span> (event.mConfiguration != <span class="keyword">null</span>) &#123;</span><br><span class="line">                Configuration.writeXmlAttrs(xml, event.mConfiguration);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> UsageEvents.Event.SHORTCUT_INVOCATION:</span><br><span class="line">            <span class="keyword">if</span> (event.mShortcutId != <span class="keyword">null</span>) &#123;</span><br><span class="line">                XmlUtils.writeStringAttribute(xml, SHORTCUT_ID_ATTR, event.mShortcutId);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    xml.endTag(<span class="keyword">null</span>, EVENT_TAG);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>写入 Event 的使用信息：</p>
<ul>
<li>写入 time 属性，取值为 event.mTimeStamp - stats.beginTime；</li>
<li>写入 package 属性和 class 属性，取值为 event.mPackage 和 event.mClass！</li>
<li>写入 type 属性，取值为 event.mEventType！</li>
<li>根据 EventType，写入额外的信息！<ul>
<li>Configuration 或者 SHORTCUT！</li>
</ul>
</li>
</ul>
<h2 id="3-2-UsageStatsDatabase-onTimeChanged"><a href="#3-2-UsageStatsDatabase-onTimeChanged" class="headerlink" title="3.2 UsageStatsDatabase.onTimeChanged"></a>3.2 UsageStatsDatabase.onTimeChanged</h2><p>long timeDiffMillis 表示时间调整后的差值，因为时间调整了，所以我们同步修改文件的名称，同时删除那些无效的文件！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTimeChanged</span><span class="params">(<span class="keyword">long</span> timeDiffMillis)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        StringBuilder logBuilder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        logBuilder.append(<span class="string">"Time changed by "</span>);</span><br><span class="line">        TimeUtils.formatDuration(timeDiffMillis, logBuilder);</span><br><span class="line">        logBuilder.append(<span class="string">"."</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> filesDeleted = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> filesMoved = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【1】处理 mSortedStatFiles 中所有的 AtomicFile 对象！</span></span><br><span class="line">        <span class="keyword">for</span> (TimeSparseArray&lt;AtomicFile&gt; files : mSortedStatFiles) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> fileCount = files.size();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; fileCount; i++) &#123;</span><br><span class="line">                <span class="comment">//【1.1】通过 valueAt 获得要处理的 AtomicFile 文件，通过 keyAt 可以获得该文件的开始记录时间！</span></span><br><span class="line">                <span class="keyword">final</span> AtomicFile file = files.valueAt(i);</span><br><span class="line">                <span class="comment">//【1.2】计算时间改变后的新时间！</span></span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">long</span> newTime = files.keyAt(i) + timeDiffMillis;</span><br><span class="line">                <span class="keyword">if</span> (newTime &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">//【1.2.1】如果 newTime 小于 0，那么该文件无效，删除该文件！</span></span><br><span class="line">                    filesDeleted++;</span><br><span class="line">                    file.delete();</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//【1.2.2】这种情况，我们要修改文件的名字，因为文件的名字就是其开始记录时间，</span></span><br><span class="line">                    <span class="comment">// 我们会将文件名改为：newTime + "-c" 的形式！</span></span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        file.openRead().close();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                        <span class="comment">// Ignore, this is just to make sure there are no backups.</span></span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    String newName = Long.toString(newTime);</span><br><span class="line">                    <span class="keyword">if</span> (file.getBaseFile().getName().endsWith(CHECKED_IN_SUFFIX)) &#123;</span><br><span class="line">                        newName = newName + CHECKED_IN_SUFFIX;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">final</span> File newFile = <span class="keyword">new</span> File(file.getBaseFile().getParentFile(), newName);</span><br><span class="line">                    filesMoved++;</span><br><span class="line">                    file.getBaseFile().renameTo(newFile);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            files.clear();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        logBuilder.append(<span class="string">" files deleted: "</span>).append(filesDeleted);</span><br><span class="line">        logBuilder.append(<span class="string">" files moved: "</span>).append(filesMoved);</span><br><span class="line">        Slog.i(TAG, logBuilder.toString());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【×2.1.2】然后再次调用 indexFilesLocked，对改名后的文件进行重新排序，再次添加到 mSortedStatFiles 中！</span></span><br><span class="line">        indexFilesLocked();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>indexFilesLocked 方法我们有讲过，这里就不多说了！</p>
<h2 id="3-3-流程总结"><a href="#3-3-流程总结" class="headerlink" title="3.3 流程总结"></a>3.3 流程总结</h2><h1 id="4-UserUsageStatsService-rolloverStats-数据回滚"><a href="#4-UserUsageStatsService-rolloverStats-数据回滚" class="headerlink" title="4 UserUsageStatsService.rolloverStats - 数据回滚"></a>4 UserUsageStatsService.rolloverStats - 数据回滚</h1><p>当我们在 report event 的时候，会判断此时记录的时间点是否已经超过了 mDailyExpiryDate 指定的日期，mDailyExpiryDate 前面我们有说过，其作为是否超过一天的临界点！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (event.mTimeStamp &gt;= mDailyExpiryDate.getTimeInMillis()) &#123;</span><br><span class="line">    <span class="comment">// Need to rollover</span></span><br><span class="line">    rolloverStats(event.mTimeStamp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果超过了 1 天，那么我们要关闭当前最新的使用信息文件，这次的记录时间会做为今天的最后一个记录时间，然后下次 report event 时，会创建一个新的文件记录下一天的使用信息！</p>
<p>当我们发现本次记录的时间超过了 mDailyExpiryDate，那么我们要关闭当前最新日期的使用信息文件了，rolloverStats 就发生在此时 ！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">rolloverStats</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> currentTimeMillis)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> startTime = SystemClock.elapsedRealtime();</span><br><span class="line">    Slog.i(TAG, mLogPrefix + <span class="string">"Rolling over usage stats"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【1】获得 dailay 时间类别使用信息中处于 active 状态的 config！ </span></span><br><span class="line">    <span class="keyword">final</span> Configuration previousConfig =</span><br><span class="line">            mCurrentStats[UsageStatsManager.INTERVAL_DAILY].activeConfiguration;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【2】continuePreviousDay 用于记录那些需要将设置为 CONTINUE_PREVIOUS_DAY 的 package</span></span><br><span class="line">    ArraySet&lt;String&gt; continuePreviousDay = <span class="keyword">new</span> ArraySet&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】遍历当前每个时间类别下最新日期的使用信息！</span></span><br><span class="line">    <span class="keyword">for</span> (IntervalStats stat : mCurrentStats) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> pkgCount = stat.packageStats.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pkgCount; i++) &#123;</span><br><span class="line">            UsageStats pkgStats = stat.packageStats.valueAt(i);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【3.1】如果 package 的 mLastEvent 是 MOVE_TO_FOREGROUND 或者 CONTINUE_PREVIOUS_DAY！</span></span><br><span class="line">            <span class="comment">// 将其 event 改为 END_OF_DAY 表示一天的记录结束了！</span></span><br><span class="line">            <span class="keyword">if</span> (pkgStats.mLastEvent == UsageEvents.Event.MOVE_TO_FOREGROUND ||</span><br><span class="line">                    pkgStats.mLastEvent == UsageEvents.Event.CONTINUE_PREVIOUS_DAY) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//【3.1.1】那么将该 package 添加到 continuePreviousDay 中！</span></span><br><span class="line">                continuePreviousDay.add(pkgStats.mPackageName);</span><br><span class="line">                <span class="comment">//【×4.1】同时更新 pacakge 对应的 UsageStats 的信息！</span></span><br><span class="line">                stat.update(pkgStats.mPackageName, mDailyExpiryDate.getTimeInMillis() - <span class="number">1</span>,</span><br><span class="line">                        UsageEvents.Event.END_OF_DAY);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//【×2.6】延迟 20mins 通知 UsageStatsService 刷新本地数据，</span></span><br><span class="line">                <span class="comment">// mStatsChanged 会被设置为 true，只通知一次！</span></span><br><span class="line">                notifyStatsChanged();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【×4.2】更新 Configuration 的状态信息！</span></span><br><span class="line">        stat.updateConfigurationStats(<span class="keyword">null</span>, mDailyExpiryDate.getTimeInMillis() - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【×3.1】将内存中的最新数据写回持久化文件！</span></span><br><span class="line">    <span class="comment">//【×2.6】会将 mStatsChanged 设置为 false；</span></span><br><span class="line">    persistActiveStats();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【×4.2】移除那些日期太旧的本地文件，然后重新加载文件到内存中！</span></span><br><span class="line">    mDatabase.prune(currentTimeMillis);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【×2.3】加载最新使用信息到内存中！</span></span><br><span class="line">    <span class="comment">// 对于 daily 时间类别，会创建一个新的 IntervalStats 对象！</span></span><br><span class="line">    <span class="comment">// 对于其他类别，可能会创建一个新的 IntervalStats 对象！</span></span><br><span class="line">    <span class="comment">// 这里也会将 mStatsChanged 设置为 false；</span></span><br><span class="line">    loadActiveStats(currentTimeMillis);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【4】处理之前收集到的 package，将其设置为 CONTINUE_PREVIOUS_DAY！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> continueCount = continuePreviousDay.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; continueCount; i++) &#123;</span><br><span class="line">        String name = continuePreviousDay.valueAt(i);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【4.1】这里的 beginTime 是 daily 时间类别的新创建的 IntervalStats 的 beginTime 时间；</span></span><br><span class="line">        <span class="comment">// 同时也是其他类别的更新时间点！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> beginTime = mCurrentStats[UsageStatsManager.INTERVAL_DAILY].beginTime;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【4.2】遍历每个时间类别下的最新使用数据 IntervalStats！</span></span><br><span class="line">        <span class="comment">// 对于 daily 时间类别的数据，这里是将该 package 的使用信息更新到新创建的 IntervalStats！</span></span><br><span class="line">        <span class="comment">// 对于其他类别的数据，可能是更新到了新创建的 IntervalStats 中，也可能是修改已有的最新 IntervalStats！</span></span><br><span class="line">        <span class="keyword">for</span> (IntervalStats stat : mCurrentStats) &#123;</span><br><span class="line">        </span><br><span class="line">            <span class="comment">//【4.2.1】这里再次调用了 update/updateConfigurationStats 方法更新 IntervalStats！</span></span><br><span class="line">            <span class="comment">// 设置其 event 为 CONTINUE_PREVIOUS_DAY，表示继续前一天的记录！</span></span><br><span class="line">            stat.update(name, beginTime, UsageEvents.Event.CONTINUE_PREVIOUS_DAY);</span><br><span class="line">            stat.updateConfigurationStats(previousConfig, beginTime);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//【×2.6】延迟 20mins 通知 UsageStatsService 刷新本地数据，</span></span><br><span class="line">            <span class="comment">// mStatsChanged 会被设置为 true，只通知一次！</span></span><br><span class="line">            notifyStatsChanged();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【×3.1】将内存中的最新数据写回持久化文件！</span></span><br><span class="line">    persistActiveStats();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> totalTime = SystemClock.elapsedRealtime() - startTime;</span><br><span class="line">    Slog.i(TAG, mLogPrefix + <span class="string">"Rolling over usage stats complete. Took "</span> + totalTime</span><br><span class="line">            + <span class="string">" milliseconds"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们来分析下整个方法的逻辑：</p>
<p>我们来分析下一些细节处理：</p>
<p>这里要注意下 loadActiveStats：</p>
<ul>
<li>加载最新使用信息到内存中，在加载最新数据时，会判断当前的时间是否在最新文件可以记录的范围内，如果在的话，就直接加载最新文件的数据，如果不在的话，那就会创建一个新的 IntervalStats，记录下一个时间段的使用信息；</li>
</ul>
<p><br></p>
<ul>
<li>因为我们当前的时间已经超过了 mDailyExpiryDate，而 mDailyExpiryDate 是以一天为临界点的，所以对于 daily 类别的最新文件来说，已经超过了其能够记录的范围，那么会创建一个新的 IntervalStats 对象！</li>
</ul>
<p><br></p>
<ul>
<li>而对于 weekly，monthly，yearly 不一定超过了其最新文件能够记录的时间返回，所以可能返回的依然是当前最新文件的 IntervalStats 对象！</li>
</ul>
<p><br></p>
<ul>
<li>loadActiveStats 方法在加载完成数据后，会调用 updateRolloverDeadline 再次将 mDailyExpiryDate 设置到下一天！</li>
</ul>
<h2 id="4-1-IntervalStats-update"><a href="#4-1-IntervalStats-update" class="headerlink" title="4.1 IntervalStats.update"></a>4.1 IntervalStats.update</h2><p>这里再次调用了 IntervalStats.update 方法，更新 package 的信息！</p>
<p>同样的，必须满足一下条件才能进入：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (pkgStats.mLastEvent == UsageEvents.Event.MOVE_TO_FOREGROUND ||</span><br><span class="line">        pkgStats.mLastEvent == UsageEvents.Event.CONTINUE_PREVIOUS_DAY) &#123;</span><br><span class="line">    ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>和 init 中传入的 timeStamp 不同，这里传入的是：</p>
<ul>
<li><strong>long timeStamp</strong>：  本次更新时间 mDailyExpiryDate.getTimeInMillis() - 1；            </li>
<li><strong>int eventType</strong>：   本次更新的事件 UsageEvents.Event.END_OF_DAY</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">update</span><span class="params">(String packageName, <span class="keyword">long</span> timeStamp, <span class="keyword">int</span> eventType)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【2.2.3.1.1】获得该 packageName 对应的 UsageStats 实例！</span></span><br><span class="line">    UsageStats usageStats = getOrCreateUsageStats(packageName);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】如果 eventType 为  MOVE_TO_BACKGROUND 或者 END_OF_DAY，进入这个 if 条件！</span></span><br><span class="line">    <span class="keyword">if</span> (eventType == UsageEvents.Event.MOVE_TO_BACKGROUND ||</span><br><span class="line">            eventType == UsageEvents.Event.END_OF_DAY) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【1.1】这时判断如果 UsageStats.mLastEvent 的取值为 MOVE_TO_FOREGROUND 或者 CONTINUE_PREVIOUS_DAY</span></span><br><span class="line">        <span class="keyword">if</span> (usageStats.mLastEvent == UsageEvents.Event.MOVE_TO_FOREGROUND ||</span><br><span class="line">                usageStats.mLastEvent == UsageEvents.Event.CONTINUE_PREVIOUS_DAY) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【1.2】更新 package 在前台的总时间 mTotalTimeInForeground 为：</span></span><br><span class="line">            <span class="comment">// 在已有基础上再加上 timeStamp - usageStats.mLastTimeUsed</span></span><br><span class="line">            usageStats.mTotalTimeInForeground += timeStamp - usageStats.mLastTimeUsed;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2.5.1】如果 eventType 属于 Stateful Event</span></span><br><span class="line">    <span class="comment">// 那就更新该 pacakge 的 usageStats.mLastEvent（上一次事件）为 eventType；</span></span><br><span class="line">    <span class="keyword">if</span> (isStatefulEvent(eventType)) &#123;</span><br><span class="line">        usageStats.mLastEvent = eventType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】如果 eventType 不是 UsageEvents.Event.SYSTEM_INTERACTION，更新 usageStats.mLastTimeUsed</span></span><br><span class="line">    <span class="comment">// 上次使用时间为 timeStamp！</span></span><br><span class="line">    <span class="keyword">if</span> (eventType != UsageEvents.Event.SYSTEM_INTERACTION) &#123;</span><br><span class="line">        usageStats.mLastTimeUsed = timeStamp;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【4】更新该 package 的 usageStats.mEndTimeStamp 为 timeStamp </span></span><br><span class="line">    usageStats.mEndTimeStamp = timeStamp;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【5】如果 eventType 为 MOVE_TO_FOREGROUND，该 package 的 usageStats.mLaunchCount（启动次数）加一；</span></span><br><span class="line">    <span class="keyword">if</span> (eventType == UsageEvents.Event.MOVE_TO_FOREGROUND) &#123;</span><br><span class="line">        usageStats.mLaunchCount += <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【6】同时修改 IntervalStats.endTime 也为 timeStamp</span></span><br><span class="line">    endTime = timeStamp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>函数流程就不在分析了，我们直接看结论：</p>
<ul>
<li>usageStats.mTotalTimeInForeground += (mDailyExpiryDate.getTimeInMillis() - 1) - usageStats.mLastTimeUsed</li>
<li>usageStats.mLastEvent = UsageEvents.Event.END_OF_DAY</li>
<li>usageStats.mLastTimeUsed = (mDailyExpiryDate.getTimeInMillis() - 1)</li>
<li><p>usageStats.mEndTimeStamp = (mDailyExpiryDate.getTimeInMillis() - 1)</p>
</li>
<li><p>IntervalStats.endTime = (mDailyExpiryDate.getTimeInMillis() - 1)</p>
</li>
</ul>
<h2 id="4-2-IntervalStats-updateConfigurationStats"><a href="#4-2-IntervalStats-updateConfigurationStats" class="headerlink" title="4.2 IntervalStats.updateConfigurationStats"></a>4.2 IntervalStats.updateConfigurationStats</h2><p>再次调用 updateConfigurationStats 更新指定配置的信息！</p>
<ul>
<li><strong>Configuration config</strong>： 是要成为 active config 的配置对象，这里传入的是 null；</li>
<li><strong>long timeStamp</strong>：传入的是 mDailyExpiryDate.getTimeInMillis() - 1；</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">updateConfigurationStats</span><span class="params">(Configuration config, <span class="keyword">long</span> timeStamp)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】如果 activeConfiguration 不为 null，说明已经有配置信息处于 active 状态！</span></span><br><span class="line">    <span class="comment">// 那就更新其时间信息！</span></span><br><span class="line">    <span class="keyword">if</span> (activeConfiguration != <span class="keyword">null</span>) &#123;</span><br><span class="line">        ConfigurationStats activeStats = configurations.get(activeConfiguration);</span><br><span class="line">        <span class="comment">//【1.1】更新 active config 总的活跃时间 mTotalTimeActive 为：在其基础上加上</span></span><br><span class="line">        <span class="comment">// timeStamp 减去上一次活跃时间 mLastTimeActive！</span></span><br><span class="line">        activeStats.mTotalTimeActive += timeStamp - activeStats.mLastTimeActive;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【1.2】更新上次活跃时间 mLastTimeActive 为 timeStamp 减去 1；</span></span><br><span class="line">        activeStats.mLastTimeActive = timeStamp - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】更新 config 指定的配置的信息。因为我们这里传入的是 null，所以不会进入；</span></span><br><span class="line">    <span class="keyword">if</span> (config != <span class="keyword">null</span>) &#123;</span><br><span class="line">        ConfigurationStats configStats = getOrCreateConfigurationStats(config);</span><br><span class="line">        <span class="comment">//【2.1】更新 config 最新活跃时间 mLastTimeActive 为 timeStamp</span></span><br><span class="line">        configStats.mLastTimeActive = timeStamp;</span><br><span class="line">        <span class="comment">//【2.2】更新 config 的活跃次数；</span></span><br><span class="line">        configStats.mActivationCount += <span class="number">1</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【2.3】更新 IntervalStats.activeConfiguration 为指定的 config！</span></span><br><span class="line">        activeConfiguration = configStats.mConfiguration;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【3】更新 IntervalStats.endTime 为上一次被更新的时间 ！timeStamp</span></span><br><span class="line">    endTime = timeStamp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为这里我们传入的是 Configuration config 为 null，所以只会尝试更新 activeConfiguration 的时间信息！</p>
<h2 id="4-3-UsageStatsDatabase-prune"><a href="#4-3-UsageStatsDatabase-prune" class="headerlink" title="4.3 UsageStatsDatabase.prune"></a>4.3 UsageStatsDatabase.prune</h2><p>prune 方法会移除那些日期太旧的本地文件！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">prune</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> currentTimeMillis)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="comment">//【1】删除 3 年以前的使用信息文件！</span></span><br><span class="line">        mCal.setTimeInMillis(currentTimeMillis);</span><br><span class="line">        mCal.addYears(-<span class="number">3</span>);</span><br><span class="line">        pruneFilesOlderThan(mIntervalDirs[UsageStatsManager.INTERVAL_YEARLY],</span><br><span class="line">                mCal.getTimeInMillis());</span><br><span class="line">        <span class="comment">//【2】删除 6 个月以前的使用信息文件！</span></span><br><span class="line">        mCal.setTimeInMillis(currentTimeMillis);</span><br><span class="line">        mCal.addMonths(-<span class="number">6</span>);</span><br><span class="line">        pruneFilesOlderThan(mIntervalDirs[UsageStatsManager.INTERVAL_MONTHLY],</span><br><span class="line">                mCal.getTimeInMillis());</span><br><span class="line">        <span class="comment">//【3】删除 4 周以前的使用信息文件！</span></span><br><span class="line">        mCal.setTimeInMillis(currentTimeMillis);</span><br><span class="line">        mCal.addWeeks(-<span class="number">4</span>);</span><br><span class="line">        pruneFilesOlderThan(mIntervalDirs[UsageStatsManager.INTERVAL_WEEKLY],</span><br><span class="line">                mCal.getTimeInMillis());</span><br><span class="line">        <span class="comment">//【4】删除 7 天以前的使用信息文件！</span></span><br><span class="line">        mCal.setTimeInMillis(currentTimeMillis);</span><br><span class="line">        mCal.addDays(-<span class="number">7</span>);</span><br><span class="line">        pruneFilesOlderThan(mIntervalDirs[UsageStatsManager.INTERVAL_DAILY],</span><br><span class="line">                mCal.getTimeInMillis());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【2.1.2】然后重新加载文件到内存中！</span></span><br><span class="line">        indexFilesLocked();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ul>
<li>删除 3 年以前的使用信息文件！ </li>
<li>删除 6 个月以前的使用信息文件！ </li>
<li>删除 4 周以前的使用信息文件！ </li>
<li>删除 7 天以前的使用信息文件！</li>
<li>最后要重新加载最新文件到内存中，防止读取到已经被删除的文件！</li>
</ul>
<h3 id="4-3-1-UsageStatsDatabase-pruneFilesOlderThan"><a href="#4-3-1-UsageStatsDatabase-pruneFilesOlderThan" class="headerlink" title="4.3.1 UsageStatsDatabase.pruneFilesOlderThan"></a>4.3.1 UsageStatsDatabase.pruneFilesOlderThan</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">pruneFilesOlderThan</span><span class="params">(File dir, <span class="keyword">long</span> expiryTime)</span> </span>&#123;</span><br><span class="line">    File[] files = dir.listFiles();</span><br><span class="line">    <span class="keyword">if</span> (files != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (File f : files) &#123;</span><br><span class="line">            String path = f.getPath();</span><br><span class="line">            <span class="comment">//【1】如果文件名中有 .bak 那么属于备份文件，去掉 .bak 得到非备份文件！</span></span><br><span class="line">            <span class="keyword">if</span> (path.endsWith(BAK_SUFFIX)) &#123;</span><br><span class="line">                f = <span class="keyword">new</span> File(path.substring(<span class="number">0</span>, path.length() - BAK_SUFFIX.length()));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">long</span> beginTime;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//【2.1.2.1】调用 UsageStatsXml.parseBeginTime 获得文件的</span></span><br><span class="line">                beginTime = UsageStatsXml.parseBeginTime(f);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                beginTime = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【2】当文件的开始记录时间早于 expiryTime，该文件过期了，删除！</span></span><br><span class="line">            <span class="keyword">if</span> (beginTime &lt; expiryTime) &#123;</span><br><span class="line">                <span class="keyword">new</span> AtomicFile(f).delete();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>方法流程简单，不多说了！</p>
<h2 id="4-4-流程总结"><a href="#4-4-流程总结" class="headerlink" title="4.4 流程总结"></a>4.4 流程总结</h2><h1 id="5-UserUsageStatsService-reportEvent-上报事件"><a href="#5-UserUsageStatsService-reportEvent-上报事件" class="headerlink" title="5 UserUsageStatsService.reportEvent - 上报事件"></a>5 UserUsageStatsService.reportEvent - 上报事件</h1><p>这里我们来看看上报时间的处理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">reportEvent</span><span class="params">(UsageEvents.Event event)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">        Slog.d(TAG, mLogPrefix + <span class="string">"Got usage event for "</span> + event.mPackage</span><br><span class="line">                + <span class="string">"["</span> + event.mTimeStamp + <span class="string">"]: "</span></span><br><span class="line">                + eventToString(event.mEventType));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】当前记录超过了 mDailyExpiryDate，那么我们要判断下当前的时间点是否超过了每个时间类别下最新文件能够记录的</span></span><br><span class="line">    <span class="comment">// 时间范围，如果超过了，要创建新的 IntervalStats，用下一个阶段的记录！</span></span><br><span class="line">    <span class="keyword">if</span> (event.mTimeStamp &gt;= mDailyExpiryDate.getTimeInMillis()) &#123;</span><br><span class="line">        <span class="comment">//【×4】对于数据的处理，在 rolloverStats 中！</span></span><br><span class="line">        rolloverStats(event.mTimeStamp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】获得 daily 类别下的最新 IntervalStats，我们要将本次的数据写入到最新的 IntervalStats！！</span></span><br><span class="line">    <span class="keyword">final</span> IntervalStats currentDailyStats = mCurrentStats[UsageStatsManager.INTERVAL_DAILY];</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【3】如果本次的 event 的类型为 CONFIGURATION_CHANGE，并且 currentDailyStats.activeConfiguration 不为 null</span></span><br><span class="line">    <span class="comment">// 那么调整该 event.mConfiguration！</span></span><br><span class="line">    <span class="keyword">final</span> Configuration newFullConfig = event.mConfiguration;</span><br><span class="line">    <span class="keyword">if</span> (event.mEventType == UsageEvents.Event.CONFIGURATION_CHANGE &amp;&amp;</span><br><span class="line">            currentDailyStats.activeConfiguration != <span class="keyword">null</span>) &#123;</span><br><span class="line">        event.mConfiguration = Configuration.generateDelta(</span><br><span class="line">                currentDailyStats.activeConfiguration, newFullConfig);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【4】将本次 event 添加到 daily 的最新 IntervalStats 中！</span></span><br><span class="line">    <span class="comment">// 如果 eventType 是 SYSTEM_INTERACTION，则不添加！</span></span><br><span class="line">    <span class="keyword">if</span> (currentDailyStats.events == <span class="keyword">null</span>) &#123;</span><br><span class="line">        currentDailyStats.events = <span class="keyword">new</span> TimeSparseArray&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (event.mEventType != UsageEvents.Event.SYSTEM_INTERACTION) &#123;</span><br><span class="line">        currentDailyStats.events.put(event.mTimeStamp, event);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【5】遍历所有时间类别下的最新使用信息 IntervalStats！</span></span><br><span class="line">    <span class="comment">// 如果 event 类型为 CONFIGURATION_CHANGE，那就只更新 config</span></span><br><span class="line">    <span class="comment">// 如果是其他类型，只更新 UsageStats！</span></span><br><span class="line">    <span class="keyword">for</span> (IntervalStats stats : mCurrentStats) &#123;</span><br><span class="line">        <span class="keyword">if</span> (event.mEventType == UsageEvents.Event.CONFIGURATION_CHANGE) &#123;</span><br><span class="line">            stats.updateConfigurationStats(newFullConfig, event.mTimeStamp);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            stats.update(event.mPackage, event.mTimeStamp, event.mEventType);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【×2.6】通知 UsageStatsService，使用信息发生了变化！</span></span><br><span class="line">    notifyStatsChanged();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其实可以看到：event 相关的 log 只会记录到 daily 类别的文件中！</p>
<p>notifyStatsChanged 会将 mStatsChanged 置为 true，然后触发 mListener.onStatsUpdated 方法，UsageStatsService.onStatsUpdated 会回调 persistActiveStats 方法，将最新的使用信息保存到本地文件中，最后设置 mStatsChanged 为 false；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">notifyStatsChanged</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!mStatsChanged) &#123;</span><br><span class="line">        mStatsChanged = <span class="keyword">true</span>;</span><br><span class="line">        mListener.onStatsUpdated();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>整个过程很简单，不多说了！</p>
<h1 id="6-UserUsageStatsService-query-查询"><a href="#6-UserUsageStatsService-query-查询" class="headerlink" title="6 UserUsageStatsService.query - 查询"></a>6 UserUsageStatsService.query - 查询</h1><p>UserUsageStatsService 提供了三个查询接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">UserUsageStatsService.queryEvents</span><br><span class="line">UserUsageStatsService.queryUsageStats</span><br><span class="line">UserUsageStatsService.queryStats</span><br></pre></td></tr></table></figure>
<p>下面我们来分析下具体的查询过程！</p>
<h2 id="6-1-UserUsageStatsService-queryEvents"><a href="#6-1-UserUsageStatsService-queryEvents" class="headerlink" title="6.1 UserUsageStatsService.queryEvents"></a>6.1 UserUsageStatsService.queryEvents</h2><h2 id="6-2-UserUsageStatsService-queryUsageStats"><a href="#6-2-UserUsageStatsService-queryUsageStats" class="headerlink" title="6.2 UserUsageStatsService.queryUsageStats"></a>6.2 UserUsageStatsService.queryUsageStats</h2><h2 id="6-3-UserUsageStatsService-queryStats"><a href="#6-3-UserUsageStatsService-queryStats" class="headerlink" title="6.3 UserUsageStatsService.queryStats"></a>6.3 UserUsageStatsService.queryStats</h2></div><hr></div><nav id="pagination"><div class="pagination"><a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-chevron-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2019 By Coolqi.Li</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv"><i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span><span></span></span><span class="footer-separator">|</span><span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.5.6"></script><script src="/js/fancybox.js?version=1.5.6"></script><script src="/js/sidebar.js?version=1.5.6"></script><script src="/js/copy.js?version=1.5.6"></script><script src="/js/fireworks.js?version=1.5.6"></script><script src="/js/transition.js?version=1.5.6"></script><script src="/js/scroll.js?version=1.5.6"></script><script src="/js/head.js?version=1.5.6"></script><script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"live2d-widget-model-hijiki"},"display":{"position":"right","width":110,"height":220},"mobile":{"show":false},"log":false});</script></body></html>
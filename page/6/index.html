<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="“你好，我是李帅奇，Android 系统工程师，MineCraft 忠实玩家，设计和绘画爱好者，缺妹纸晚期患者，熬夜星人。”"><meta name="keywords" content=""><meta name="author" content="Coolqi.Li,undefined"><meta name="copyright" content="Coolqi.Li"><title>Every day is always sleepy. | Coolqi`s Blog</title><link rel="shortcut icon" href="/my-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.5.6"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.5.6"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="author-info"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">Coolqi.Li</div><div class="author-info__description text-center">“你好，我是李帅奇，Android 系统工程师，MineCraft 忠实玩家，设计和绘画爱好者，缺妹纸晚期患者，熬夜星人。”</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">64</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">14</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">15</span></a></div></div></div><nav class="no-bg" id="nav"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Coolqi`s Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span></div><div id="site-info"><div id="site-title">Coolqi`s Blog</div><div id="site-sub-title">Every day is always sleepy.</div></div></nav><div id="sidebar"><div class="author-info"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">Coolqi.Li</div><div class="author-info__description text-center">“你好，我是李帅奇，Android 系统工程师，MineCraft 忠实玩家，设计和绘画爱好者，缺妹纸晚期患者，熬夜星人。”</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">64</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">14</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">15</span></a></div></div></div><div id="content-outer"><div class="layout" id="content-inner"><div class="recent-post-item article-container"><a class="article-title" href="/2016/05/01/BroadcastReceiver篇 2 - registerReceiver 动态注册流程分析/">BroadcastReceiver篇 2 - registerReceiver 动态注册流程分析</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-05-01</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/AndroidFramework源码分析/">AndroidFramework源码分析</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/AndroidFramework源码分析/BroadcastReceiver广播接收者/">BroadcastReceiver广播接收者</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/BroadcastReceiver广播接收者/">BroadcastReceiver广播接收者</a></span><div class="content"><p>[toc]</p>
<p>基于 Android 7.1.1 源码，分析 BroadcastReceiver <strong>动态注册</strong> 的过程，转载请说明出处！</p>
<h1 id="0-综述"><a href="#0-综述" class="headerlink" title="0 综述"></a>0 综述</h1><p>BroadcastReceiver 动态注册，就是应用程序在运行过程中，调用 registerReceiver 方法注册：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Intent <span class="title">registerReceiver</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    BroadcastReceiver receiver, IntentFilter filter)</span>；</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Intent <span class="title">registerReceiver</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    BroadcastReceiver receiver, IntentFilter filter,</span></span></span><br><span class="line"><span class="function"><span class="params">    String broadcastPermission, Handler scheduler)</span>；</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Intent <span class="title">registerReceiverAsUser</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    BroadcastReceiver receiver, UserHandle user, IntentFilter filter,</span></span></span><br><span class="line"><span class="function"><span class="params">    String broadcastPermission, Handler scheduler)</span>；</span></span><br></pre></td></tr></table></figure></p>
<p>可以看到，动态注册广播接收者者时，我们需要创建一个 IntentFilter 过滤器对象，我们还可以指定广播发送者的权限，除此之外，我们还可以通过传入 Handler 来指定 onReceive 方法执行的线程（默认是主线程）。</p>
<p>当应用不再需要这个广播接收者后，需要动态取消注册：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unregisterReceiver</span><span class="params">(BroadcastReceiver receiver)</span></span>;</span><br></pre></td></tr></table></figure>
<p>下面，我们来进入源码，分析动态注册的流程！</p>
<h1 id="1-应用进程"><a href="#1-应用进程" class="headerlink" title="1 应用进程"></a>1 应用进程</h1><h2 id="1-1-ContextWapper-registerReceiver"><a href="#1-1-ContextWapper-registerReceiver" class="headerlink" title="1.1 ContextWapper.registerReceiver"></a>1.1 ContextWapper.registerReceiver</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Intent <span class="title">registerReceiver</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    BroadcastReceiver receiver, IntentFilter filter)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mBase.registerReceiver(receiver, filter);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// broadcastPermission 用来指定发送者需要的权限！</span></span><br><span class="line"><span class="comment">// scheduler 用来指定 onReceive 方法执行的线程！</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Intent <span class="title">registerReceiver</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    BroadcastReceiver receiver, IntentFilter filter,</span></span></span><br><span class="line"><span class="function"><span class="params">    String broadcastPermission, Handler scheduler)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mBase.registerReceiver(receiver, filter, broadcastPermission,</span><br><span class="line">            scheduler);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Intent <span class="title">registerReceiverAsUser</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    BroadcastReceiver receiver, UserHandle user, IntentFilter filter,</span></span></span><br><span class="line"><span class="function"><span class="params">    String broadcastPermission, Handler scheduler)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mBase.registerReceiverAsUser(receiver, user, filter, broadcastPermission,</span><br><span class="line">            scheduler);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的 mBase 是 ContextImpl 对象！</p>
<h2 id="1-2-ContextImpl-registerReceiver"><a href="#1-2-ContextImpl-registerReceiver" class="headerlink" title="1.2 ContextImpl.registerReceiver"></a>1.2 ContextImpl.registerReceiver</h2><p>进入 ContextImpl 继续看：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Intent <span class="title">registerReceiver</span><span class="params">(BroadcastReceiver receiver, IntentFilter filter)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> registerReceiver(receiver, filter, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Intent <span class="title">registerReceiver</span><span class="params">(BroadcastReceiver receiver, IntentFilter filter,</span></span></span><br><span class="line"><span class="function"><span class="params">        String broadcastPermission, Handler scheduler)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> registerReceiverInternal(receiver, getUserId(),</span><br><span class="line">            filter, broadcastPermission, scheduler, getOuterContext());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Intent <span class="title">registerReceiverAsUser</span><span class="params">(BroadcastReceiver receiver, UserHandle user,</span></span></span><br><span class="line"><span class="function"><span class="params">        IntentFilter filter, String broadcastPermission, Handler scheduler)</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">return</span> registerReceiverInternal(receiver, user.getIdentifier(),</span><br><span class="line">            filter, broadcastPermission, scheduler, getOuterContext());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们可以看到，虽然是不同的注册方法，最后都调用了 registerReceiverInternal 方法！getOuterContext() 方法用于获得注册时的上下文运行环境！也就是代表注册时所属的组件！！</p>
<h2 id="1-3-ContextImpl-registerReceiverInternal-核心入口"><a href="#1-3-ContextImpl-registerReceiverInternal-核心入口" class="headerlink" title="1.3 ContextImpl.registerReceiverInternal - 核心入口"></a>1.3 ContextImpl.registerReceiverInternal - 核心入口</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Intent <span class="title">registerReceiverInternal</span><span class="params">(BroadcastReceiver receiver, <span class="keyword">int</span> userId,</span></span></span><br><span class="line"><span class="function"><span class="params">        IntentFilter filter, String broadcastPermission,</span></span></span><br><span class="line"><span class="function"><span class="params">        Handler scheduler, Context context)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    IIntentReceiver rd = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (receiver != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//【1】mPackageInfo 是 LoadedApk 对象，每个进程都有一个！</span></span><br><span class="line">        <span class="keyword">if</span> (mPackageInfo != <span class="keyword">null</span> &amp;&amp; context != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (scheduler == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 如果传入的 Handler 为 null，就设置 scheduler 为所在进程的主线程 Handler!</span></span><br><span class="line">                scheduler = mMainThread.getHandler();</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//【*1.3.1】获得 BroadcastReceiver 对应的 IIntentReceiver 对象！</span></span><br><span class="line">            rd = mPackageInfo.getReceiverDispatcher(</span><br><span class="line">                receiver, context, scheduler,</span><br><span class="line">                mMainThread.getInstrumentation(), <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (scheduler == <span class="keyword">null</span>) &#123;</span><br><span class="line">                scheduler = mMainThread.getHandler();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//【*1.3.2】创建一个 ReceiverDispatcher 对象！</span></span><br><span class="line">            rd = <span class="keyword">new</span> LoadedApk.ReceiverDispatcher(</span><br><span class="line">                    receiver, context, scheduler, <span class="keyword">null</span>, <span class="keyword">true</span>).getIIntentReceiver();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【*1.4】进入系统进程，继续注册！</span></span><br><span class="line">        <span class="keyword">final</span> Intent intent = ActivityManagerNative.getDefault().registerReceiver(</span><br><span class="line">                mMainThread.getApplicationThread(), mBasePackageName,</span><br><span class="line">                rd, filter, broadcastPermission, userId);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (intent != <span class="keyword">null</span>) &#123;</span><br><span class="line">            intent.setExtrasClassLoader(getClassLoader());</span><br><span class="line">            intent.prepareToEnterProcess();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> intent;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>IIntentReceiver 类实例 rd 用来在应用进程和系统进程中进行 Binder 通信！</p>
<p>Handler 类对象 scheduler 用来设置接受到广播后 onReceive 执行的线程，如果传入 null，默认就在主线程！</p>
<p>这里涉及到一个 mPackageInfo，他是 LoadedApk 类的实例。每一个进程在创建时，都会有一个 LoadedApk 对象。用来分装一个应用程序的信息！</p>
<p>我们去 LoadedApk 目录去看看：</p>
<h3 id="1-3-1-LoadedApk-getReceiverDispatcher"><a href="#1-3-1-LoadedApk-getReceiverDispatcher" class="headerlink" title="1.3.1 LoadedApk.getReceiverDispatcher"></a>1.3.1 LoadedApk.getReceiverDispatcher</h3><p>这里的 boolean registered 为 true：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">getReceiverDispatcher</span><span class="params">(BroadcastReceiver r,</span></span></span><br><span class="line"><span class="function"><span class="params">        Context context, Handler handler,</span></span></span><br><span class="line"><span class="function"><span class="params">        Instrumentation instrumentation, <span class="keyword">boolean</span> registered)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mReceivers) &#123;</span><br><span class="line">        <span class="comment">//【1】尝试获得对应的 ReceiverDispatcher，如果没有就重新创建！</span></span><br><span class="line">        LoadedApk.ReceiverDispatcher rd = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        ArrayMap&lt;BroadcastReceiver, LoadedApk.ReceiverDispatcher&gt; map = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (registered) &#123;</span><br><span class="line">            map = mReceivers.get(context);</span><br><span class="line">            <span class="keyword">if</span> (map != <span class="keyword">null</span>) &#123;</span><br><span class="line">                rd = map.get(r);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【*1.3.2】第一次注册，创建全新的 ReceiverDispatcher 对象！</span></span><br><span class="line">        <span class="keyword">if</span> (rd == <span class="keyword">null</span>) &#123;</span><br><span class="line">            rd = <span class="keyword">new</span> ReceiverDispatcher(r, context, handler,</span><br><span class="line">                    instrumentation, registered);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (registered) &#123;</span><br><span class="line">                <span class="keyword">if</span> (map == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    map = <span class="keyword">new</span> ArrayMap&lt;BroadcastReceiver, LoadedApk.ReceiverDispatcher&gt;();</span><br><span class="line">                    mReceivers.put(context, map);</span><br><span class="line">                &#125;</span><br><span class="line">                map.put(r, rd);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//【2】校验一下 context 和 handler 是否和之前注册的一样，不一样会抛出异常！</span></span><br><span class="line">            rd.validate(context, handler);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        rd.mForgotten = <span class="keyword">false</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【3】返回内部的 InnerReceiver 对象！</span></span><br><span class="line">        <span class="keyword">return</span> rd.getIIntentReceiver();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>LoadedApk 有一个 ArrayMap 集合 mReceivers：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ArrayMap&lt;Context, ArrayMap&lt;BroadcastReceiver, ReceiverDispatcher&gt;&gt; mReceivers</span><br><span class="line">    = <span class="keyword">new</span> ArrayMap&lt;Context, ArrayMap&lt;BroadcastReceiver, LoadedApk.ReceiverDispatcher&gt;&gt;();</span><br></pre></td></tr></table></figure></p>
<p>用来保存当前进程下，每个上下文运行环境 Context 中，对应的 BroadcastReceiver 和 ReceiverDispatcher 的映射关系！</p>
<h3 id="1-3-2-new-LoadedApk-ReceiverDispatcher"><a href="#1-3-2-new-LoadedApk-ReceiverDispatcher" class="headerlink" title="1.3.2 new LoadedApk.ReceiverDispatcher"></a>1.3.2 new LoadedApk.ReceiverDispatcher</h3><p>我们再去看看 ReceiverDispatcher 对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">ReceiverDispatcher(BroadcastReceiver receiver, Context context,</span><br><span class="line">        Handler activityThread, Instrumentation instrumentation,</span><br><span class="line">        <span class="keyword">boolean</span> registered) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (activityThread == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"Handler must not be null"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【*1.3.2.1】创建了一个 InnerReceiver 对象，用于 Binder 通信！</span></span><br><span class="line">    mIIntentReceiver = <span class="keyword">new</span> InnerReceiver(<span class="keyword">this</span>, !registered);</span><br><span class="line">    mReceiver = receiver;</span><br><span class="line">    mContext = context;</span><br><span class="line"></span><br><span class="line">    mActivityThread = activityThread;</span><br><span class="line">    mInstrumentation = instrumentation;</span><br><span class="line">    mRegistered = registered;</span><br><span class="line">    mLocation = <span class="keyword">new</span> IntentReceiverLeaked(<span class="keyword">null</span>);</span><br><span class="line">    mLocation.fillInStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的 IntentReceiverLeaked，我们不过多分析，很简单！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">IntentReceiverLeaked</span> <span class="keyword">extends</span> <span class="title">AndroidRuntimeException</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">IntentReceiverLeaked</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ReceiverDispatcher 用于保存 BroadcastReceiver 和 InnerReceiver 映射关系，我们继续看：</p>
<h4 id="1-3-2-1-new-ReceiverDispatcher-InnerReceiver"><a href="#1-3-2-1-new-ReceiverDispatcher-InnerReceiver" class="headerlink" title="1.3.2.1 new ReceiverDispatcher.InnerReceiver"></a>1.3.2.1 new ReceiverDispatcher.InnerReceiver</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">InnerReceiver</span> <span class="keyword">extends</span> <span class="title">IIntentReceiver</span>.<span class="title">Stub</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> WeakReference&lt;LoadedApk.ReceiverDispatcher&gt; mDispatcher;</span><br><span class="line">    <span class="keyword">final</span> LoadedApk.ReceiverDispatcher mStrongRef;</span><br><span class="line"></span><br><span class="line">    InnerReceiver(LoadedApk.ReceiverDispatcher rd, <span class="keyword">boolean</span> strong) &#123;</span><br><span class="line">        <span class="comment">//【1】创建了一个 ReceiverDispatcher 的弱引用！</span></span><br><span class="line">        mDispatcher = <span class="keyword">new</span> WeakReference&lt;LoadedApk.ReceiverDispatcher&gt;(rd);</span><br><span class="line">        <span class="comment">//【2】这里 strong 为 false，所以 mStrongRef 为 null；</span></span><br><span class="line">        mStrongRef = strong ? rd : <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">performReceive</span><span class="params">(Intent intent, <span class="keyword">int</span> resultCode, String data,</span></span></span><br><span class="line"><span class="function"><span class="params">            Bundle extras, <span class="keyword">boolean</span> ordered, <span class="keyword">boolean</span> sticky, <span class="keyword">int</span> sendingUser)</span> </span>&#123;</span><br><span class="line">        ... ... ... ... <span class="comment">// 用于处理广播的接收！</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以看到 InnerReceiver 继承了 IIntentReceiver.Stub，他是作为 Binder 通信的服务端，其实，这种架构，我们在 Service 的创建和启动中，也同样看到过！！ </p>
<h2 id="1-4-ActivityManagerP-registerReceiver"><a href="#1-4-ActivityManagerP-registerReceiver" class="headerlink" title="1.4 ActivityManagerP.registerReceiver"></a>1.4 ActivityManagerP.registerReceiver</h2><p>接着调用 AMP 代理对象的 registerReceiver 方法，进入系统进程，注册 BroadcastReceiver！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Intent <span class="title">registerReceiver</span><span class="params">(IApplicationThread caller, String packageName,</span></span></span><br><span class="line"><span class="function"><span class="params">        IIntentReceiver receiver,</span></span></span><br><span class="line"><span class="function"><span class="params">        IntentFilter filter, String perm, <span class="keyword">int</span> userId)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    Parcel data = Parcel.obtain();</span><br><span class="line">    Parcel reply = Parcel.obtain();</span><br><span class="line">    data.writeInterfaceToken(IActivityManager.descriptor);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】处理 ApplicationThread 对象！</span></span><br><span class="line">    data.writeStrongBinder(caller != <span class="keyword">null</span> ? caller.asBinder() : <span class="keyword">null</span>);</span><br><span class="line">    data.writeString(packageName);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】处理 IIntentReceiver 对象！</span></span><br><span class="line">    data.writeStrongBinder(receiver != <span class="keyword">null</span> ? receiver.asBinder() : <span class="keyword">null</span>);</span><br><span class="line">    filter.writeToParcel(data, <span class="number">0</span>);</span><br><span class="line">    data.writeString(perm);</span><br><span class="line">    data.writeInt(userId);</span><br><span class="line"></span><br><span class="line">    mRemote.transact(REGISTER_RECEIVER_TRANSACTION, data, reply, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    reply.readException();</span><br><span class="line">    Intent intent = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">int</span> haveIntent = reply.readInt();</span><br><span class="line">    <span class="keyword">if</span> (haveIntent != <span class="number">0</span>) &#123;</span><br><span class="line">        intent = Intent.CREATOR.createFromParcel(reply);</span><br><span class="line">    &#125;</span><br><span class="line">    reply.recycle();</span><br><span class="line">    data.recycle();</span><br><span class="line">    <span class="keyword">return</span> intent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>下面，进入系统进程！</p>
<h1 id="2-系统进程"><a href="#2-系统进程" class="headerlink" title="2 系统进程"></a>2 系统进程</h1><p>首先，进入 ActivityManagerN.onTransact 方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTransact</span><span class="params">(<span class="keyword">int</span> code, Parcel data, Parcel reply, <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    ... ... ...</span><br><span class="line">    <span class="keyword">case</span> REGISTER_RECEIVER_TRANSACTION:</span><br><span class="line">    &#123;</span><br><span class="line">        data.enforceInterface(IActivityManager.descriptor);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【1】获得 ApplicationThreadProxy 对象！</span></span><br><span class="line">        IBinder b = data.readStrongBinder();</span><br><span class="line">        IApplicationThread app =</span><br><span class="line">            b != <span class="keyword">null</span> ? ApplicationThreadNative.asInterface(b) : <span class="keyword">null</span>;</span><br><span class="line">            </span><br><span class="line">        String packageName = data.readString();</span><br><span class="line">        b = data.readStrongBinder();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【2】获得 IIntentReceiver.proxy 对象！</span></span><br><span class="line">        IIntentReceiver rec</span><br><span class="line">            = b != <span class="keyword">null</span> ? IIntentReceiver.Stub.asInterface(b) : <span class="keyword">null</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="comment">//【3】获得 IntentFilter 对象！</span></span><br><span class="line">        IntentFilter filter = IntentFilter.CREATOR.createFromParcel(data);</span><br><span class="line">        String perm = data.readString();</span><br><span class="line">        <span class="keyword">int</span> userId = data.readInt();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【*2.1】继续调用 AMS.registerReceiver 方法，注册广播接收者！</span></span><br><span class="line">        Intent intent = registerReceiver(app, packageName, rec, filter, perm, userId);</span><br><span class="line"></span><br><span class="line">        reply.writeNoException();</span><br><span class="line">        <span class="keyword">if</span> (intent != <span class="keyword">null</span>) &#123;</span><br><span class="line">            reply.writeInt(<span class="number">1</span>);</span><br><span class="line">            intent.writeToParcel(reply, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            reply.writeInt(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;    </span><br><span class="line">    ... ... ...    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="2-1-ActivityManagerS-registerReceiver"><a href="#2-1-ActivityManagerS-registerReceiver" class="headerlink" title="2.1 ActivityManagerS.registerReceiver"></a>2.1 ActivityManagerS.registerReceiver</h2><p>参数分析：</p>
<ul>
<li><strong>IApplicationThread caller</strong>：注册操作所属的应用进程的 ApplicationThreadProxy 对象</li>
<li><strong>String callerPackage</strong>：注册者所属的应用程序包名；</li>
<li><strong>IIntentReceiver receiver</strong>：IIntentReceiver.Proxy 对象，映射注册者进程中的 InnerReceiver 对象；</li>
<li><strong>IntentFilter filter</strong>：Intent 过滤器；</li>
<li><strong>String permission</strong>：需要的权限！</li>
<li><strong>int userId</strong>：当前设备用户 id</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Intent <span class="title">registerReceiver</span><span class="params">(IApplicationThread caller, String callerPackage,</span></span></span><br><span class="line"><span class="function"><span class="params">        IIntentReceiver receiver, IntentFilter filter, String permission, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    enforceNotIsolatedCaller(<span class="string">"registerReceiver"</span>);</span><br><span class="line">    <span class="comment">//【1】用来保存能够处理的粘性广播列表！</span></span><br><span class="line">    ArrayList&lt;Intent&gt; stickyIntents = <span class="keyword">null</span>;</span><br><span class="line">    ProcessRecord callerApp = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">int</span> callingUid;</span><br><span class="line">    <span class="keyword">int</span> callingPid;</span><br><span class="line">    <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (caller != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//【*2.1.1】获得注册者进程对应的 ProcessRecord 对象！</span></span><br><span class="line">            <span class="comment">// 如果注册者进程为 null，抛出异常！</span></span><br><span class="line">            callerApp = getRecordForAppLocked(caller);</span><br><span class="line">            <span class="keyword">if</span> (callerApp == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(</span><br><span class="line">                        <span class="string">"Unable to find app for caller "</span> + caller</span><br><span class="line">                        + <span class="string">" (pid="</span> + Binder.getCallingPid()</span><br><span class="line">                        + <span class="string">") when registering receiver "</span> + receiver);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//【2】如果注册者进程的 uid 不是系统 uid，并且注册者包名不在注册者进程的列表中</span></span><br><span class="line">            <span class="comment">// 且注册者包名不是 “android” 抛出异常！</span></span><br><span class="line">            <span class="keyword">if</span> (callerApp.info.uid != Process.SYSTEM_UID &amp;&amp;</span><br><span class="line">                    !callerApp.pkgList.containsKey(callerPackage) &amp;&amp;</span><br><span class="line">                    !<span class="string">"android"</span>.equals(callerPackage)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"Given caller package "</span> + callerPackage</span><br><span class="line">                        + <span class="string">" is not running in process "</span> + callerApp);</span><br><span class="line">            &#125;</span><br><span class="line">            callingUid = callerApp.info.uid;</span><br><span class="line">            callingPid = callerApp.pid;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            callerPackage = <span class="keyword">null</span>;</span><br><span class="line">            callingUid = Binder.getCallingUid();</span><br><span class="line">            callingPid = Binder.getCallingPid();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        userId = mUserController.handleIncomingUser(callingPid, callingUid, userId, <span class="keyword">true</span>,</span><br><span class="line">                ALLOW_FULL_ONLY, <span class="string">"registerReceiver"</span>, callerPackage);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【2】通过解析 IntentFilter 获得 BroadcastReceiver 设置的 action 列表！</span></span><br><span class="line">        Iterator&lt;String&gt; actions = filter.actionsIterator();</span><br><span class="line">        <span class="keyword">if</span> (actions == <span class="keyword">null</span>) &#123;</span><br><span class="line">            ArrayList&lt;String&gt; noAction = <span class="keyword">new</span> ArrayList&lt;String&gt;(<span class="number">1</span>);</span><br><span class="line">            noAction.add(<span class="keyword">null</span>);</span><br><span class="line">            actions = noAction.iterator();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 收集所有设备用户；</span></span><br><span class="line">        <span class="keyword">int</span>[] userIds = &#123; UserHandle.USER_ALL, UserHandle.getUserId(callingUid) &#125;;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【3】遍历广播接收者的 actions 列表，找到能够和 action 匹配的粘性广播，添加到 stickyIntents 集合中！</span></span><br><span class="line">        <span class="keyword">while</span> (actions.hasNext()) &#123;</span><br><span class="line">            String action = actions.next();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> id : userIds) &#123;</span><br><span class="line">                <span class="comment">//【3.1】获得每个设备用户下的“粘性”广播！</span></span><br><span class="line">                ArrayMap&lt;String, ArrayList&lt;Intent&gt;&gt; stickies = mStickyBroadcasts.get(id);</span><br><span class="line">                <span class="keyword">if</span> (stickies != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    ArrayList&lt;Intent&gt; intents = stickies.get(action);</span><br><span class="line">                    <span class="keyword">if</span> (intents != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (stickyIntents == <span class="keyword">null</span>) &#123;</span><br><span class="line">                            stickyIntents = <span class="keyword">new</span> ArrayList&lt;Intent&gt;();</span><br><span class="line">                        &#125;</span><br><span class="line">                        stickyIntents.addAll(intents);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【4】因为 Intent 出了设置 action 这个属性之外，还会设置其他的一些属性！</span></span><br><span class="line">    <span class="comment">// 这里是查找完全匹配的“粘性”广播，添加到 allSticky 集合中！</span></span><br><span class="line">    ArrayList&lt;Intent&gt; allSticky = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (stickyIntents != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> ContentResolver resolver = mContext.getContentResolver();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, N = stickyIntents.size(); i &lt; N; i++) &#123;</span><br><span class="line">            Intent intent = stickyIntents.get(i);</span><br><span class="line">            <span class="keyword">if</span> (filter.match(resolver, intent, <span class="keyword">true</span>, TAG) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (allSticky == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    allSticky = <span class="keyword">new</span> ArrayList&lt;Intent&gt;();</span><br><span class="line">                &#125;</span><br><span class="line">                allSticky.add(intent);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【5】我们会将第一个完全匹配的粘性广播发给接收者，如果动态注册的接收者为 null 的话，立刻返回！</span></span><br><span class="line">    Intent sticky = allSticky != <span class="keyword">null</span> ? allSticky.get(<span class="number">0</span>) : <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_BROADCAST) Slog.v(TAG_BROADCAST, <span class="string">"Register receiver "</span> + filter + <span class="string">": "</span> + sticky);</span><br><span class="line">    <span class="keyword">if</span> (receiver == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> sticky;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (callerApp != <span class="keyword">null</span> &amp;&amp; (callerApp.thread == <span class="keyword">null</span></span><br><span class="line">                || callerApp.thread.asBinder() != caller.asBinder())) &#123;</span><br><span class="line">            <span class="comment">//【6】如果注册者进程死亡了，就退出！</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【7】尝试获得广播接收者在系统进程中的 ReceiverList 对象，如果为 null，说明没有注册！ </span></span><br><span class="line">        ReceiverList rl = mRegisteredReceivers.get(receiver.asBinder());</span><br><span class="line">        <span class="keyword">if</span> (rl == <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【*3.1.4】创建一个全新的 ReceiverList 对象，封装该动态注册的广播接收者！</span></span><br><span class="line">            rl = <span class="keyword">new</span> ReceiverList(<span class="keyword">this</span>, callerApp, callingPid, callingUid,</span><br><span class="line">                    userId, receiver);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//【*5.2】如果 rl.app 不为 null，说明注册者进程已经启动，就将  ReceiverList 对象添加</span></span><br><span class="line">            <span class="comment">// 到注册者的进程的 receivers 集合中，对于动态注册，显然进入这个分支！</span></span><br><span class="line">            <span class="keyword">if</span> (rl.app != <span class="keyword">null</span>) &#123;</span><br><span class="line">                rl.app.receivers.add(rl);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 如果 rl.app 为 bull，这可能是一种异常状态！！直接 linkToDeath 进行 Binder 监听！</span></span><br><span class="line">                    receiver.asBinder().linkToDeath(rl, <span class="number">0</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                    <span class="keyword">return</span> sticky;</span><br><span class="line">                &#125;</span><br><span class="line">                rl.linkedToDeath = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//【6】将 InnerReceiver.proxy 和 ReceiverList 的映射关系保存到 mRegisteredReceivers 中！</span></span><br><span class="line">            <span class="comment">// 表示该广播接收者已经被注册！</span></span><br><span class="line">            mRegisteredReceivers.put(receiver.asBinder(), rl);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rl.uid != callingUid) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">                    <span class="string">"Receiver requested to register for uid "</span> + callingUid</span><br><span class="line">                    + <span class="string">" was previously registered for uid "</span> + rl.uid);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rl.pid != callingPid) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">                    <span class="string">"Receiver requested to register for pid "</span> + callingPid</span><br><span class="line">                    + <span class="string">" was previously registered for pid "</span> + rl.pid);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rl.userId != userId) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">                    <span class="string">"Receiver requested to register for user "</span> + userId</span><br><span class="line">                    + <span class="string">" was previously registered for user "</span> + rl.userId);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【7】创建 BroadcastFilter 对象 bf，用来封装广播接收者的 IntentFilter 对象！</span></span><br><span class="line">        BroadcastFilter bf = <span class="keyword">new</span> BroadcastFilter(filter, rl, callerPackage,</span><br><span class="line">                permission, callingUid, userId);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将 BroadcastFilter 对象添加到 ReceiverList 列表中！</span></span><br><span class="line">        rl.add(bf);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!bf.debugCheck()) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"==&gt; For Dynamic broadcast"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【8】将创建的广播过滤器 BroadcastFilter 保存到 mReceiverResolver 中，用于查询使用！</span></span><br><span class="line">        mReceiverResolver.addFilter(bf);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【9】如果 allSticky 不为 null，说明有能匹配该广播过滤器的 “粘性广播”！</span></span><br><span class="line">        <span class="comment">// 接着就是要处理粘性广播的分发了！</span></span><br><span class="line">        <span class="keyword">if</span> (allSticky != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//【9.1】将该动态注册的广播接收者添加到 ArrayList 中！</span></span><br><span class="line">            <span class="comment">// 准备将该粘性广播发送给接收者！</span></span><br><span class="line">            ArrayList receivers = <span class="keyword">new</span> ArrayList();</span><br><span class="line">            receivers.add(bf);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> stickyCount = allSticky.size();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; stickyCount; i++) &#123;</span><br><span class="line">                Intent intent = allSticky.get(i);</span><br><span class="line">                <span class="comment">//【9.2】根据 Intent 是否设置 Intent.FLAG_RECEIVER_FOREGROUND 标志位，</span></span><br><span class="line">                <span class="comment">// 选择前台或者后台广播队列！</span></span><br><span class="line">                BroadcastQueue queue = broadcastQueueForIntent(intent);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">//【9.3】创建 BroadcastRecord 对象！！</span></span><br><span class="line">                BroadcastRecord r = <span class="keyword">new</span> BroadcastRecord(queue, intent, <span class="keyword">null</span>,</span><br><span class="line">                        <span class="keyword">null</span>, -<span class="number">1</span>, -<span class="number">1</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, AppOpsManager.OP_NONE, <span class="keyword">null</span>, receivers,</span><br><span class="line">                        <span class="keyword">null</span>, <span class="number">0</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">true</span>, <span class="keyword">true</span>, -<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//【9.4】将粘性广播加入到广播队列的并发广播集合中！！</span></span><br><span class="line">                queue.enqueueParallelBroadcastLocked(r);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">//【2.3】处理广播队列中的已有的广播！！</span></span><br><span class="line">                queue.scheduleBroadcastsLocked();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> sticky;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面我们来分析下这个方法中的一些重要步骤：</p>
<h3 id="2-1-1-ActivityManagerS-getRecordForAppLocked"><a href="#2-1-1-ActivityManagerS-getRecordForAppLocked" class="headerlink" title="2.1.1 ActivityManagerS.getRecordForAppLocked"></a>2.1.1 ActivityManagerS.getRecordForAppLocked</h3><p>获得注册者进程的 ProcessRecord 对象，传入参数：</p>
<ul>
<li><strong>IApplicationThread thread</strong>：注册者进程在系统进程中的 ApplicationThreadProxy 对象！</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> ProcessRecord <span class="title">getRecordForAppLocked</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        IApplicationThread thread)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (thread == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获得进程 ProcessRecord 在 mLruProcesses 中的下标！</span></span><br><span class="line">    <span class="keyword">int</span> appIndex = getLRURecordIndexForAppLocked(thread);</span><br><span class="line">    <span class="keyword">return</span> appIndex &gt;= <span class="number">0</span> ? mLruProcesses.get(appIndex) : <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里调用了 getLRURecordIndexForAppLocked 方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">getLRURecordIndexForAppLocked</span><span class="params">(IApplicationThread thread)</span> </span>&#123;</span><br><span class="line">    IBinder threadBinder = thread.asBinder();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Find the application record.</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=mLruProcesses.size()-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</span><br><span class="line">        ProcessRecord rec = mLruProcesses.get(i);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 找到正在运行，并且 IApplicationThread 对象可以匹配的进程！</span></span><br><span class="line">        <span class="keyword">if</span> (rec.thread != <span class="keyword">null</span> &amp;&amp; rec.thread.asBinder() == threadBinder) &#123;</span><br><span class="line">            <span class="keyword">return</span> i;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>mLruProcesses 是一个 ArrayList 集合，用来保存正在运行中的应用程序进程，这里我们先不看！</p>
<h3 id="2-1-2-IntentFilter-match"><a href="#2-1-2-IntentFilter-match" class="headerlink" title="2.1.2 IntentFilter.match"></a>2.1.2 IntentFilter.match</h3><p>主要代码段：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (filter.match(resolver, intent, <span class="keyword">true</span>, TAG) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (allSticky == <span class="keyword">null</span>) &#123;</span><br><span class="line">        allSticky = <span class="keyword">new</span> ArrayList&lt;Intent&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    allSticky.add(intent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>当前要注册的广播接收者只能接收到能够和 IntentFilter 匹配的广播，所以对于“粘性广播”，我们还需要再进行一次匹配操作，找到能够匹配 IntentFilter 的粘性广播，保存到 allSticky 列表中，我们来看看匹配过程：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">match</span><span class="params">(ContentResolver resolver, Intent intent,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> resolve, String logTag)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    String type = resolve ? intent.resolveType(resolver) : intent.getType();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> match(intent.getAction(), type, intent.getScheme(),</span><br><span class="line">                 intent.getData(), intent.getCategories(), logTag);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-1-3-ActivityManagerS-broadcastQueueForIntent"><a href="#2-1-3-ActivityManagerS-broadcastQueueForIntent" class="headerlink" title="2.1.3 ActivityManagerS.broadcastQueueForIntent"></a>2.1.3 ActivityManagerS.broadcastQueueForIntent</h3><p>该方法的作用是为广播选择合适的队列：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BroadcastQueue <span class="title">broadcastQueueForIntent</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> isFg = (intent.getFlags() &amp; Intent.FLAG_RECEIVER_FOREGROUND) != <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG_BROADCAST_BACKGROUND) Slog.i(TAG_BROADCAST,</span><br><span class="line">            <span class="string">"Broadcast intent "</span> + intent + <span class="string">" on "</span></span><br><span class="line">            + (isFg ? <span class="string">"foreground"</span> : <span class="string">"background"</span>) + <span class="string">" queue"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (isFg) ? mFgBroadcastQueue : mBgBroadcastQueue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果 Intent 设置了 Intent.FLAG_RECEIVER_FOREGROUND 标志位，那该广播就是一个前台广播，应该被加入 mFgBroadcastQueue 队列；否则，这是一个后台广播，就应该被添加到 mBgBroadcastQueue 队列中；</p>
<h3 id="2-1-4-new-BroadcastRecord"><a href="#2-1-4-new-BroadcastRecord" class="headerlink" title="2.1.4 new BroadcastRecord"></a>2.1.4 new BroadcastRecord</h3><p>创建广播管理对象 BroadcastRecord，参数传递：</p>
<ul>
<li><strong>BroadcastQueue _queue</strong>：表示广播所在的队列，传入 queue</li>
<li><strong>Intent _intent</strong>：传入 intent</li>
<li><strong>ProcessRecord _callerApp</strong>：传入 null</li>
<li><strong>String _callerPackage</strong>：传入 null</li>
<li><strong>int _callingPid</strong>：传入 -1</li>
<li><strong>int _callingUid</strong>：传入 -1</li>
<li><strong>String _resolvedType</strong>：传入 null</li>
<li><strong>String[] _requiredPermissions</strong>：传入 null</li>
<li><strong>int _appOp</strong>：传入 AppOpsManager.OP_NONE</li>
<li><strong>BroadcastOptions _options</strong>：传入 null</li>
<li><strong>List _receivers</strong>：传入 receivers，这里是</li>
<li><strong>IIntentReceiver _resultTo</strong>：传入 null</li>
<li><strong>int _resultCode</strong>：传入 0</li>
<li><strong>String _resultData</strong>：传入 null</li>
<li><strong>Bundle _resultExtras</strong>：传入 null</li>
<li><strong>boolean _serialized</strong>：传入 false</li>
<li><strong>boolean _sticky</strong>：传入 true</li>
<li><strong>boolean _initialSticky</strong>：传入 true</li>
<li><strong>int _userId</strong>：传入 -1</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">BroadcastRecord(BroadcastQueue _queue,</span><br><span class="line">        Intent _intent, ProcessRecord _callerApp, String _callerPackage,</span><br><span class="line">        <span class="keyword">int</span> _callingPid, <span class="keyword">int</span> _callingUid, String _resolvedType, String[] _requiredPermissions,</span><br><span class="line">        <span class="keyword">int</span> _appOp, BroadcastOptions _options, List _receivers, IIntentReceiver _resultTo,</span><br><span class="line">        <span class="keyword">int</span> _resultCode, String _resultData, Bundle _resultExtras, <span class="keyword">boolean</span> _serialized,</span><br><span class="line">        <span class="keyword">boolean</span> _sticky, <span class="keyword">boolean</span> _initialSticky,</span><br><span class="line">        <span class="keyword">int</span> _userId) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果广播对应的 Intent 为 null，抛出异常</span></span><br><span class="line">    <span class="keyword">if</span> (_intent == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"Can't construct with a null intent"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    queue = _queue;  <span class="comment">// 广播所属的广播队列，有前台和后台之分；</span></span><br><span class="line">    intent = _intent; <span class="comment">// 广播 Intent</span></span><br><span class="line">    targetComp = _intent.getComponent(); <span class="comment">// 广播的目标组件，也就是目标 BroadcastReceiver</span></span><br><span class="line"></span><br><span class="line">    callerApp = _callerApp; <span class="comment">// 发送者所在的进程</span></span><br><span class="line">    callerPackage = _callerPackage; <span class="comment">// 发送者所属的包名</span></span><br><span class="line">    callingPid = _callingPid; <span class="comment">// 发送者的进程 pid</span></span><br><span class="line">    callingUid = _callingUid; <span class="comment">// 发送者进程的 uid</span></span><br><span class="line"></span><br><span class="line">    resolvedType = _resolvedType;</span><br><span class="line">    requiredPermissions = _requiredPermissions; <span class="comment">// 发送该广播需要的权限</span></span><br><span class="line">    appOp = _appOp;</span><br><span class="line">    options = _options;</span><br><span class="line"></span><br><span class="line">    receivers = _receivers; <span class="comment">//</span></span><br><span class="line">    delivery = <span class="keyword">new</span> <span class="keyword">int</span>[_receivers != <span class="keyword">null</span> ? _receivers.size() : <span class="number">0</span>]; <span class="comment">// 该广播分发给每个接收者的次数</span></span><br><span class="line"></span><br><span class="line">    resultTo = _resultTo;</span><br><span class="line">    resultCode = _resultCode;</span><br><span class="line">    resultData = _resultData;</span><br><span class="line">    resultExtras = _resultExtras;</span><br><span class="line">    ordered = _serialized;</span><br><span class="line">    sticky = _sticky;</span><br><span class="line">    initialSticky = _initialSticky;</span><br><span class="line">    userId = _userId;</span><br><span class="line">    nextReceiver = <span class="number">0</span>;</span><br><span class="line">    state = IDLE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里是对“粘性”广播创建对应的 BroadcastRecord 管理对象！</p>
<h3 id="2-1-5-BroadcastQueue-enqueueParallelBroadcastLocked"><a href="#2-1-5-BroadcastQueue-enqueueParallelBroadcastLocked" class="headerlink" title="2.1.5 BroadcastQueue.enqueueParallelBroadcastLocked"></a>2.1.5 BroadcastQueue.enqueueParallelBroadcastLocked</h3><p>将“粘性”广播 BroadcastRecord 添加到 BroadcastQueue 对象内部的 mParallelBroadcasts 列表中，并初始化 r.enqueueClockTime 为当前系统时间，表示广播进入队列的时间；<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enqueueParallelBroadcastLocked</span><span class="params">(BroadcastRecord r)</span> </span>&#123;</span><br><span class="line">    mParallelBroadcasts.add(r);</span><br><span class="line">    r.enqueueClockTime = System.currentTimeMillis();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看出，粘性广播属于并发的广播！</p>
<h3 id="2-1-6-BroadcastQueue-scheduleBroadcastsLocked"><a href="#2-1-6-BroadcastQueue-scheduleBroadcastsLocked" class="headerlink" title="2.1.6 BroadcastQueue.scheduleBroadcastsLocked"></a>2.1.6 BroadcastQueue.scheduleBroadcastsLocked</h3><p>开始处理广播，mBroadcastsScheduled 表示是否开始广播处理任务！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scheduleBroadcastsLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_BROADCAST) Slog.v(TAG_BROADCAST, <span class="string">"Schedule broadcasts ["</span></span><br><span class="line">            + mQueueName + <span class="string">"]: current="</span></span><br><span class="line">            + mBroadcastsScheduled);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mBroadcastsScheduled) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【1】发送 BROADCAST_INTENT_MSG 消息！</span></span><br><span class="line">    mHandler.sendMessage(mHandler.obtainMessage(BROADCAST_INTENT_MSG, <span class="keyword">this</span>));</span><br><span class="line">    mBroadcastsScheduled = <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>收集了粘性广播，把粘性广播添加到了指定的广播队列中，然后就是要处理广播了！mHandler 是 BroadcastHandler 对象，这里是向 BroadcastHandler 发送 BROADCAST_INTENT_MSG 消息，开始分发广播！！</p>
<h2 id="2-2-BroadcastQueue-scheduleBroadcastsLocked"><a href="#2-2-BroadcastQueue-scheduleBroadcastsLocked" class="headerlink" title="2.2 BroadcastQueue.scheduleBroadcastsLocked"></a>2.2 BroadcastQueue.scheduleBroadcastsLocked</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">scheduleBroadcastsLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_BROADCAST) Slog.v(TAG_BROADCAST, <span class="string">"Schedule broadcasts ["</span></span><br><span class="line">            + mQueueName + <span class="string">"]: current="</span></span><br><span class="line">            + mBroadcastsScheduled);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mBroadcastsScheduled) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//【1】触发广播的分发！</span></span><br><span class="line">    mHandler.sendMessage(mHandler.obtainMessage(BROADCAST_INTENT_MSG, <span class="keyword">this</span>));</span><br><span class="line">    mBroadcastsScheduled = <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-3-BroadcastQueue-BroadcastHandler"><a href="#2-3-BroadcastQueue-BroadcastHandler" class="headerlink" title="2.3 BroadcastQueue.BroadcastHandler"></a>2.3 BroadcastQueue.BroadcastHandler</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">BroadcastHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BroadcastHandler</span><span class="params">(Looper looper)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(looper, <span class="keyword">null</span>, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">case</span> BROADCAST_INTENT_MSG: &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_BROADCAST) Slog.v(</span><br><span class="line">                        TAG_BROADCAST, <span class="string">"Received BROADCAST_INTENT_MSG"</span>);</span><br><span class="line">                <span class="comment">//【1】接收到 BROADCAST_INTENT_MSG 消息，开始分发广播！</span></span><br><span class="line">                processNextBroadcast(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">case</span> BROADCAST_TIMEOUT_MSG: &#123;</span><br><span class="line">                <span class="comment">//【2】广播处理超时</span></span><br><span class="line">                <span class="keyword">synchronized</span> (mService) &#123;</span><br><span class="line">                    broadcastTimeoutLocked(<span class="keyword">true</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">case</span> SCHEDULE_TEMP_WHITELIST_MSG: &#123;</span><br><span class="line">                <span class="comment">//【3】添加 doze 模式白名单，这个在 doze 模式篇中会讲解！！</span></span><br><span class="line">                DeviceIdleController.LocalService dic = mService.mLocalDeviceIdleController;</span><br><span class="line">                <span class="keyword">if</span> (dic != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    dic.addPowerSaveTempWhitelistAppDirect(UserHandle.getAppId(msg.arg1),</span><br><span class="line">                            msg.arg2, <span class="keyword">true</span>, (String)msg.obj);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接着，调用 processNextBroadcast 方法，分发队列中的广播，分发的具体流程，我们会在 sendBroadcast 流程分析那篇博文中详细解析，这里先不看！</p>
<h1 id="3-总结"><a href="#3-总结" class="headerlink" title="3 总结"></a>3 总结</h1><h2 id="3-1-数据结构分析"><a href="#3-1-数据结构分析" class="headerlink" title="3.1 数据结构分析"></a>3.1 数据结构分析</h2><p>以上过程涉及到了一些重要的数据结构！</p>
<h3 id="3-1-1-BroadcastRecevier"><a href="#3-1-1-BroadcastRecevier" class="headerlink" title="3.1.1 BroadcastRecevier"></a>3.1.1 <strong>BroadcastRecevier</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BroadcastReceiver</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> PendingResult mPendingResult;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(Context context, Intent intent)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>BroadcastReceiver 是一个抽象类，我们在开发时，需要继承 BroadcastReceiver 来实现自己的广播接收者！</p>
<h3 id="3-1-2-mStickyBroadcasts"><a href="#3-1-2-mStickyBroadcasts" class="headerlink" title="3.1.2 mStickyBroadcasts"></a>3.1.2 <strong>mStickyBroadcasts</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> SparseArray&lt;ArrayMap&lt;String, ArrayList&lt;Intent&gt;&gt;&gt; mStickyBroadcasts =</span><br><span class="line">        <span class="keyword">new</span> SparseArray&lt;ArrayMap&lt;String, ArrayList&lt;Intent&gt;&gt;&gt;();</span><br></pre></td></tr></table></figure>
<p>mStickyBroadcasts 用来保存每个设备用户下活跃的粘性广播！</p>
<p>这里来解释下粘性广播，粘性广播是可以发送给以后注册的接受者的广播，意思是<strong>系统会将前面的粘性广播保存在 AMS 中，一旦注册了能够接受对应粘性广播的 BroadcastReceiver，在注册结束后，BroadcastReceiver 会立即收到粘性广播</strong>！</p>
<p>mStickyBroadcasts 是一个稀疏数组，数组下标为设备用户ID：userId，对应的数组元素是设备用户 ID 下所有活跃的粘性广播：<code>ArrayMap&lt;String, ArrayList&lt;Intent&gt;&gt;</code>；</p>
<p><code>ArrayMap&lt;String, ArrayList&lt;Intent&gt;&gt;</code>  的 key 是粘性广播 Intent 的 action，value 是一个 ArrayList：是所有设置了同一个 action 的粘性广播 Intent；</p>
<h3 id="3-1-3-mRegisteredReceivers"><a href="#3-1-3-mRegisteredReceivers" class="headerlink" title="3.1.3 mRegisteredReceivers"></a>3.1.3 <strong>mRegisteredReceivers</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> HashMap&lt;IBinder, ReceiverList&gt; mRegisteredReceivers = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br></pre></td></tr></table></figure>
<p>用来保存动态注册的广播接收者，是一个 HashMap，key 是广播接收者的 IInnerReceiver 对象，value 是 ReceiverList 对象，是一个 ArrayList 集合，用来封装该广播接收者的信息！</p>
<h3 id="3-1-4-ReceiverList"><a href="#3-1-4-ReceiverList" class="headerlink" title="3.1.4 ReceiverList"></a>3.1.4 <strong>ReceiverList</strong></h3><p>ReceiverList 用于封装每一个动态创建</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ReceiverList</span> <span class="keyword">extends</span> <span class="title">ArrayList</span>&lt;<span class="title">BroadcastFilter</span>&gt;</span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">IBinder</span>.<span class="title">DeathRecipient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> ActivityManagerService owner; <span class="comment">// AMS 对象</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> IIntentReceiver receiver; <span class="comment">// 广播接收者的 InnerReceiver.Proxy 对象</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> ProcessRecord app; <span class="comment">// 注册者所在的进程</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> pid; <span class="comment">// 注册者的进程 pid</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> uid; <span class="comment">// 注册者的进程 uid</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> userId; <span class="comment">// 注册者所在的设备用户 id</span></span><br><span class="line"></span><br><span class="line">    BroadcastRecord curBroadcast = <span class="keyword">null</span>; <span class="comment">// 接收者当前正在处理的广播</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> linkedToDeath = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    String stringName;</span><br><span class="line">    </span><br><span class="line">    ReceiverList(ActivityManagerService _owner, ProcessRecord _app,</span><br><span class="line">            <span class="keyword">int</span> _pid, <span class="keyword">int</span> _uid, <span class="keyword">int</span> _userId, IIntentReceiver _receiver) &#123;</span><br><span class="line">        owner = _owner;</span><br><span class="line">        receiver = _receiver;</span><br><span class="line">        app = _app;</span><br><span class="line">        pid = _pid;</span><br><span class="line">        uid = _uid;</span><br><span class="line">        userId = _userId;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ReceiverList 继承了 ArrayList<broadcastfilter>，所以它本质上就是一个 ArrayList 集合！</broadcastfilter></p>
<h3 id="3-1-5-BroadcastFilter"><a href="#3-1-5-BroadcastFilter" class="headerlink" title="3.1.5 BroadcastFilter"></a>3.1.5 <strong>BroadcastFilter</strong></h3><p>BroadcastFilter 表示的动态设定的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">BroadcastFilter</span> <span class="keyword">extends</span> <span class="title">IntentFilter</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Back-pointer to the list this filter is in.</span></span><br><span class="line">    <span class="keyword">final</span> ReceiverList receiverList; <span class="comment">// BroadcastFilter 所属的 receiverList 列表；</span></span><br><span class="line">    <span class="keyword">final</span> String packageName; <span class="comment">// 注册者的包名；</span></span><br><span class="line">    <span class="keyword">final</span> String requiredPermission; <span class="comment">// 广播需要的权限</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> owningUid; <span class="comment">// 注册者的 uid</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> owningUserId; <span class="comment">// 注册者所属的 UserId</span></span><br><span class="line"></span><br><span class="line">    BroadcastFilter(IntentFilter _filter, ReceiverList _receiverList,</span><br><span class="line">            String _packageName, String _requiredPermission, <span class="keyword">int</span> _owningUid, <span class="keyword">int</span> _userId) &#123;</span><br><span class="line">        <span class="keyword">super</span>(_filter);</span><br><span class="line">        receiverList = _receiverList;</span><br><span class="line">        packageName = _packageName;</span><br><span class="line">        requiredPermission = _requiredPermission;</span><br><span class="line">        owningUid = _owningUid;</span><br><span class="line">        owningUserId = _userId;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>BroadcastFilter 继承了 IntentFilter，其本身是一个 IntentFilter 扩展类，出了有 IntentFilter 的属性和方法之外，他还封装了一些其他的属性，我们可以把 BroadcastFilter 理解为注册广播是传入的 IntentFilter！</p>
<h3 id="3-1-6-mReceiverResolver"><a href="#3-1-6-mReceiverResolver" class="headerlink" title="3.1.6 mReceiverResolver"></a>3.1.6 <strong>mReceiverResolver</strong></h3><p>mReceiverResolver 是模板类 IntentResolver 的子类，用于解析 Intent 对象！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> IntentResolver&lt;BroadcastFilter, BroadcastFilter&gt; mReceiverResolver</span><br><span class="line">        = <span class="keyword">new</span> IntentResolver&lt;BroadcastFilter, BroadcastFilter&gt;() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">allowFilterResult</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            BroadcastFilter filter, List&lt;BroadcastFilter&gt; dest)</span> </span>&#123;</span><br><span class="line">        IBinder target = filter.receiverList.receiver.asBinder();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = dest.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">            <span class="keyword">if</span> (dest.get(i).receiverList.receiver.asBinder() == target) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> BroadcastFilter <span class="title">newResult</span><span class="params">(BroadcastFilter filter, <span class="keyword">int</span> match, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (userId == UserHandle.USER_ALL || filter.owningUserId == UserHandle.USER_ALL</span><br><span class="line">                || userId == filter.owningUserId) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.newResult(filter, match, userId);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> BroadcastFilter[] newArray(<span class="keyword">int</span> size) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BroadcastFilter[size];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isPackageForFilter</span><span class="params">(String packageName, BroadcastFilter filter)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> packageName.equals(filter.packageName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>mReceiverResolver 持有所有动态注册的广播接受者的 BroadcastFilter 对象，也就是 IntentFilter，当广播没有设置组件信息时，会通过 mReceiverResolver 查询接收者的信息！</p>
<h3 id="3-1-7-BroadcastQueue"><a href="#3-1-7-BroadcastQueue" class="headerlink" title="3.1.7 BroadcastQueue"></a>3.1.7 <strong>BroadcastQueue</strong></h3><p>BroadcastQueue 表示的是广播队列，任何一个广播都需要被添加到这个队列才能被分发！Android 系统提供了两个队列：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">BroadcastQueue mFgBroadcastQueue;</span><br><span class="line">BroadcastQueue mBgBroadcastQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> BroadcastQueue[] mBroadcastQueues = <span class="keyword">new</span> BroadcastQueue[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 广播接收者运行超时时间</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BROADCAST_FG_TIMEOUT = <span class="number">10</span>*<span class="number">1000</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BROADCAST_BG_TIMEOUT = <span class="number">60</span>*<span class="number">1000</span>;</span><br></pre></td></tr></table></figure></p>
<p>他们是在 AMS 的启动时候初始化的：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mFgBroadcastQueue = <span class="keyword">new</span> BroadcastQueue(<span class="keyword">this</span>, mHandler,</span><br><span class="line">        <span class="string">"foreground"</span>, BROADCAST_FG_TIMEOUT, <span class="keyword">false</span>);</span><br><span class="line">mBgBroadcastQueue = <span class="keyword">new</span> BroadcastQueue(<span class="keyword">this</span>, mHandler,</span><br><span class="line">        <span class="string">"background"</span>, BROADCAST_BG_TIMEOUT, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">mBroadcastQueues[<span class="number">0</span>] = mFgBroadcastQueue;</span><br><span class="line">mBroadcastQueues[<span class="number">1</span>] = mBgBroadcastQueue;</span><br></pre></td></tr></table></figure></p>
<p>一个是前台队列，一个是后台队列！一个广播会根据是否设置了 Intent.FLAG_RECEIVER_FOREGROUND 标志位，会被放到 mFgBroadcastQueue 或者 mBgBroadcastQueue 队列中进行分发，我们去看看 BroadcastQueue 类的一些重要的成员变量：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">BroadcastQueue</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_BROADCAST_HISTORY = ActivityManager.isLowRamDeviceStatic() ? <span class="number">10</span> : <span class="number">50</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_BROADCAST_SUMMARY_HISTORY</span><br><span class="line">            = ActivityManager.isLowRamDeviceStatic() ? <span class="number">25</span> : <span class="number">300</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> ActivityManagerService mService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> String mQueueName; <span class="comment">// 队列的名称</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> mTimeoutPeriod;  <span class="comment">// 广播接收者运行超时时间</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> mDelayBehindServices; <span class="comment">// 是否延迟发送广播，后台队列才会为 true！</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">final</span> ArrayList&lt;BroadcastRecord&gt; mParallelBroadcasts = <span class="keyword">new</span> ArrayList&lt;&gt;(); <span class="comment">// 并行广播列表</span></span><br><span class="line">    <span class="keyword">final</span> ArrayList&lt;BroadcastRecord&gt; mOrderedBroadcasts = <span class="keyword">new</span> ArrayList&lt;&gt;(); <span class="comment">// 有序广播列表</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 队列中广播的历史记录，用于 debugging！</span></span><br><span class="line">    <span class="keyword">final</span> BroadcastRecord[] mBroadcastHistory = <span class="keyword">new</span> BroadcastRecord[MAX_BROADCAST_HISTORY];</span><br><span class="line">    <span class="keyword">int</span> mHistoryNext = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Intent[] mBroadcastSummaryHistory = <span class="keyword">new</span> Intent[MAX_BROADCAST_SUMMARY_HISTORY];</span><br><span class="line">    <span class="keyword">int</span> mSummaryHistoryNext = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 用于记录所有广播的操作时间！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span>[] mSummaryHistoryEnqueueTime = <span class="keyword">new</span>  <span class="keyword">long</span>[MAX_BROADCAST_SUMMARY_HISTORY];</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span>[] mSummaryHistoryDispatchTime = <span class="keyword">new</span>  <span class="keyword">long</span>[MAX_BROADCAST_SUMMARY_HISTORY];</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span>[] mSummaryHistoryFinishTime = <span class="keyword">new</span>  <span class="keyword">long</span>[MAX_BROADCAST_SUMMARY_HISTORY];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> mBroadcastsScheduled = <span class="keyword">false</span>; <span class="comment">// 分发广播时（BROADCAST_INTENT_MSG），该变量会被置为 true！</span></span><br><span class="line">    <span class="keyword">boolean</span> mPendingBroadcastTimeoutMessage; <span class="comment">// 广播处理超时（BROADCAST_TIMEOUT_MSG），该变量会被置为 true！</span></span><br><span class="line"></span><br><span class="line">    BroadcastRecord mPendingBroadcast = <span class="keyword">null</span>; <span class="comment">// 等待目标进程启动的挂起广播</span></span><br><span class="line">    <span class="keyword">int</span> mPendingBroadcastRecvIndex; <span class="comment">// 等待目标进程启动的挂起广播的目标接收者的下标</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> BroadcastHandler mHandler; <span class="comment">// 用于在系统进程中处理发送广播和广播超时的操作！</span></span><br><span class="line"></span><br><span class="line">    BroadcastQueue(ActivityManagerService service, Handler handler,</span><br><span class="line">            String name, <span class="keyword">long</span> timeoutPeriod, <span class="keyword">boolean</span> allowDelayBehindServices) &#123;</span><br><span class="line">        mService = service;</span><br><span class="line">        mHandler = <span class="keyword">new</span> BroadcastHandler(handler.getLooper());</span><br><span class="line">        mQueueName = name;</span><br><span class="line">        mTimeoutPeriod = timeoutPeriod;</span><br><span class="line">        mDelayBehindServices = allowDelayBehindServices;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ... ... ... ...</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>BroadcastQueue 里面还有很多的方法，用于处理广播的分发，超时等等，这个我们后面再看！！</p>
<h3 id="3-1-8-BroadcastRecord"><a href="#3-1-8-BroadcastRecord" class="headerlink" title="3.1.8 BroadcastRecord"></a>3.1.8 <strong>BroadcastRecord</strong></h3><p>在应用端，广播的表现形式是一个个 Intent 对象，但是在系统进程中，AMS 会将 Intent 封装成 BroadcastRecord 对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">BroadcastRecord</span> <span class="keyword">extends</span> <span class="title">Binder</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Intent intent;    <span class="comment">// 广播对应的 Intent</span></span><br><span class="line">    <span class="keyword">final</span> ComponentName targetComp; <span class="comment">// Intent 设置的组件</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">final</span> ProcessRecord callerApp; <span class="comment">// 发送该广播的进程</span></span><br><span class="line">    <span class="keyword">final</span> String callerPackage; <span class="comment">// 发送该广播的 package</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> callingPid;   <span class="comment">// 发送该广播的进程 pid</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> callingUid;   <span class="comment">// 发送该广播的进程 uid</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> ordered;  <span class="comment">// 该广播是否是有序广播</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> sticky;   <span class="comment">// 该广播是否是粘性广播</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> initialSticky; <span class="comment">// initial broadcast from register to sticky?</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> userId;       <span class="comment">// 广播所属的设备用户 id</span></span><br><span class="line">    <span class="keyword">final</span> String resolvedType; <span class="comment">// the resolved data type</span></span><br><span class="line">    <span class="keyword">final</span> String[] requiredPermissions; <span class="comment">// 发送改变广播需要的权限</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> appOp;        <span class="comment">// 和该广播相关联的应用操作</span></span><br><span class="line">    <span class="keyword">final</span> BroadcastOptions options; <span class="comment">// 发送者提供广播参数</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">final</span> List receivers;   <span class="comment">// 该广播的目标接收者列表，动态接收者为 BroadcastFilter，静态接收者为 ResolveInfo；</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span>[] delivery;   <span class="comment">// 该广播对于每个广播接收者的分发状态</span></span><br><span class="line">    IIntentReceiver resultTo; <span class="comment">// 用来接收发送广播的结果</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">long</span> enqueueClockTime;  <span class="comment">// 该广播加入队列的时间！</span></span><br><span class="line">    <span class="keyword">long</span> dispatchTime;      <span class="comment">// 该广播开始分发的时间（uptimeMillis）</span></span><br><span class="line">    <span class="keyword">long</span> dispatchClockTime; <span class="comment">// 该广播开始分发的时间（currentTimeMillis）</span></span><br><span class="line">    <span class="keyword">long</span> receiverTime;      <span class="comment">// 接收者接收该广播的时间，用于计算超时</span></span><br><span class="line">    <span class="keyword">long</span> finishTime;        <span class="comment">// 该广播完成分发的时间（uptimeMillis）</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> resultCode;         <span class="comment">// current result code value.</span></span><br><span class="line">    String resultData;      <span class="comment">// current result data value.</span></span><br><span class="line">    Bundle resultExtras;    <span class="comment">// current result extra data values.</span></span><br><span class="line">    <span class="keyword">boolean</span> resultAbort;    <span class="comment">// current result abortBroadcast value.</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> nextReceiver;       <span class="comment">// 下一个广播的序号</span></span><br><span class="line">    IBinder receiver;       <span class="comment">// 当前接收者的 Binder 实体，用于跨进程通信</span></span><br><span class="line">    <span class="keyword">int</span> state;              <span class="comment">// 广播的状态！</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> anrCount;           <span class="comment">// ANR 的次数；</span></span><br><span class="line">    <span class="keyword">int</span> manifestCount;      <span class="comment">// 目标静态接收者的个数；</span></span><br><span class="line">    <span class="keyword">int</span> manifestSkipCount;  <span class="comment">// 跳过的静态接收者个数；</span></span><br><span class="line">    BroadcastQueue queue;   <span class="comment">// 该广播所属的队列；</span></span><br><span class="line"></span><br><span class="line">    BroadcastFilter curFilter; <span class="comment">// 目标动态接收者！</span></span><br><span class="line"></span><br><span class="line">    ProcessRecord curApp;       <span class="comment">// 接受该广播的广播接收者所在进程！</span></span><br><span class="line">    ComponentName curComponent; <span class="comment">// 接受该广播的广播接收者的组件名！</span></span><br><span class="line">    ActivityInfo curReceiver;   <span class="comment">// 接受该广播的静态广播接收者的信息对象！</span></span><br><span class="line">    </span><br><span class="line">    ... ... ... ...</span><br><span class="line">       </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="3-2-结构关系图"><a href="#3-2-结构关系图" class="headerlink" title="3.2 结构关系图"></a>3.2 结构关系图</h2><p>结构关系图我们从 2 个方面来说明！</p>
<h3 id="3-2-1-注册者进程关系图"><a href="#3-2-1-注册者进程关系图" class="headerlink" title="3.2.1 注册者进程关系图"></a>3.2.1 注册者进程关系图</h3><p>处理广播的类是 BroadcastReceiver，InnerReceiver 用于实现注册者进程和系统进程的跨进程通信，ReceiverDispatcher 实现了二者的低耦合，用于管理二者的映射关系！</p>
<p>系统进程通过 InnerReceiver.Proxy 代理对象，通过 Binder 通信将广播传递给注册者进程的 BroadcastReceiver！performReceive 方法最终会创建一个 Args 对象，用于拉起 BroadcastReceiver 的 onReceive 方法！</p>
<h3 id="3-2-2-系统进程关系图"><a href="#3-2-2-系统进程关系图" class="headerlink" title="3.2.2 系统进程关系图"></a>3.2.2 系统进程关系图</h3><p><img src="http://static.zybuluo.com/Coolqi/4u0xiwyi1qg1dx6c55776vyb/%E5%B9%BF%E6%92%AD%E6%8E%A5%E6%94%B6%E8%80%85%E5%8A%A8%E6%80%81%E6%B3%A8%E5%86%8C%E7%B3%BB%E7%BB%9F%E8%BF%9B%E7%A8%8B%E5%85%B3%E7%B3%BB%E5%9B%BE.png" alt="广播接收者动态注册系统进程关系图.png-318.2kB"></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2016/04/29/JobScheduler第 8 篇 - JobInfo JobStatus 和 JobParameters/">JobScheduler第 8 篇 - JobInfo JobStatus 和 JobParameters</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-04-29</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/AndroidFramework源码分析/">AndroidFramework源码分析</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/AndroidFramework源码分析/JobScheduler任务调度/">JobScheduler任务调度</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/JobScheduler任务调度/">JobScheduler任务调度</a></span><div class="content"><p>基于 Android 7.1.1 源码分析，本文为原创，转载请说明出处，谢谢！</p>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>这一篇我们来分析一下 JSS 中的一些对象，看看我们能对 job 做哪些属性的设置：</p>
<ul>
<li>JobInfo </li>
<li>JobStatus</li>
<li>JobParameters</li>
</ul>
<h1 id="1-JobInfo"><a href="#1-JobInfo" class="headerlink" title="1 JobInfo"></a>1 JobInfo</h1><p>我们先来看看 JobInfo 的简化结构：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JobInfo</span> <span class="keyword">implements</span> <span class="title">Parcelable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Builder</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">        <span class="function"><span class="keyword">public</span> JobInfo <span class="title">build</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> job;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里使用了设计模式中的建造者模式，通过 build 方法，返回最终的 JobInfo！</p>
<h2 id="1-1-builder"><a href="#1-1-builder" class="headerlink" title="1.1 builder"></a>1.1 builder</h2><p>我们先来看看 buidler 中的方法和参数，我们用一张表格来说明一下：</p>
<table>
<thead>
<tr>
<th style="text-align:left">属性</th>
<th style="text-align:left">属性默认值</th>
<th style="text-align:left">属性解释</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">int mJobId</td>
<td style="text-align:left"></td>
<td style="text-align:left">Job 的 Id</td>
</tr>
<tr>
<td style="text-align:left">ComponentName mJobService</td>
<td style="text-align:left">-</td>
<td style="text-align:left">Job 对应的 JobService 组件</td>
</tr>
<tr>
<td style="text-align:left">PersistableBundle mExtras</td>
<td style="text-align:left">PersistableBundle.EMPTY</td>
<td style="text-align:left">job 重启保留需要恢复的数据</td>
</tr>
<tr>
<td style="text-align:left">int mPriority</td>
<td style="text-align:left">PRIORITY_DEFAULT</td>
<td style="text-align:left">job 优先级</td>
</tr>
<tr>
<td style="text-align:left">int mFlags</td>
<td style="text-align:left">-</td>
<td style="text-align:left">-</td>
</tr>
<tr>
<td style="text-align:left">boolean mRequiresCharging</td>
<td style="text-align:left">-</td>
<td style="text-align:left">约束条件：充电</td>
</tr>
<tr>
<td style="text-align:left">boolean mRequiresDeviceIdle</td>
<td style="text-align:left">-</td>
<td style="text-align:left">约束条件：doze 模式</td>
</tr>
<tr>
<td style="text-align:left">int mNetworkType</td>
<td style="text-align:left">-</td>
<td style="text-align:left">约束条件：网络类型</td>
</tr>
<tr>
<td style="text-align:left">ArrayList<triggercontenturi> mTriggerContentUris</triggercontenturi></td>
<td style="text-align:left">-</td>
<td style="text-align:left">约束条件：数据库 Uri</td>
</tr>
<tr>
<td style="text-align:left">long mTriggerContentUpdateDelay</td>
<td style="text-align:left">-1</td>
<td style="text-align:left">数据库改变后，job 的延迟执行时间</td>
</tr>
<tr>
<td style="text-align:left">long mTriggerContentMaxDelay</td>
<td style="text-align:left">-1</td>
<td style="text-align:left">数据库改变后，job 的最大延迟执行时间</td>
</tr>
<tr>
<td style="text-align:left">boolean mIsPersisted</td>
<td style="text-align:left"></td>
<td style="text-align:left">job 是否重启保留，需要RECEIVE_BOOT_COMPLETED 权限</td>
</tr>
<tr>
<td style="text-align:left">long mMinLatencyMillis</td>
<td style="text-align:left">-</td>
<td style="text-align:left">job 延迟执行时间</td>
</tr>
<tr>
<td style="text-align:left">long mMaxExecutionDelayMillis</td>
<td style="text-align:left">-</td>
<td style="text-align:left">job 最大延迟执行时间，一旦达到该时间，无论条件是否满足，任务都会执行</td>
</tr>
<tr>
<td style="text-align:left">boolean mIsPeriodic</td>
<td style="text-align:left">-</td>
<td style="text-align:left">job 是否是周期性的</td>
</tr>
<tr>
<td style="text-align:left"><strong>boolean mHasEarlyConstraint</strong></td>
<td style="text-align:left">-</td>
<td style="text-align:left">job 是否设置了延迟执行时间（周期和非周期都有）</td>
</tr>
<tr>
<td style="text-align:left"><strong>boolean mHasLateConstraint</strong></td>
<td style="text-align:left">-</td>
<td style="text-align:left">job 是否设置了最大延迟执行时间（周期和非周期都有）</td>
</tr>
<tr>
<td style="text-align:left">long mIntervalMillis</td>
<td style="text-align:left">-</td>
<td style="text-align:left">job 执行的周期时间间隔</td>
</tr>
<tr>
<td style="text-align:left">long mFlexMillis</td>
<td style="text-align:left">-</td>
<td style="text-align:left">job 执行周期末的一个时间窗，任何任务在这个时间窗中都可能被执行</td>
</tr>
<tr>
<td style="text-align:left">long mInitialBackoffMillis</td>
<td style="text-align:left">DEFAULT_INITIAL_BACKOFF_MILLIS</td>
<td style="text-align:left">job 第一次尝试重试的等待间隔，单位为毫秒</td>
</tr>
<tr>
<td style="text-align:left">int mBackoffPolicy</td>
<td style="text-align:left">DEFAULT_BACKOFF_POLICY</td>
<td style="text-align:left">job 对应的退避策略</td>
</tr>
<tr>
<td style="text-align:left">boolean mBackoffPolicySet</td>
<td style="text-align:left">False</td>
<td style="text-align:left">job 是否设置了设置退避 / 重试策略，类似网络原理中的冲突退避，当一个任务的调度失败时需要重试，所采取的策略。</td>
</tr>
</tbody>
</table>
<p>接着来看属性和其对应的方法：</p>
<table>
<thead>
<tr>
<th style="text-align:left">属性</th>
<th style="text-align:left">设置方法</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">int mJobId</td>
<td style="text-align:left">Builder 构造器</td>
</tr>
<tr>
<td style="text-align:left">ComponentName mJobService</td>
<td style="text-align:left">Builder 构造器</td>
</tr>
<tr>
<td style="text-align:left">PersistableBundle mExtras</td>
<td style="text-align:left">setExtras</td>
</tr>
<tr>
<td style="text-align:left">int mPriority</td>
<td style="text-align:left">setPriority</td>
</tr>
<tr>
<td style="text-align:left">int mFlags</td>
<td style="text-align:left">setFlags</td>
</tr>
<tr>
<td style="text-align:left">boolean mRequiresCharging</td>
<td style="text-align:left">setRequiresCharging</td>
</tr>
<tr>
<td style="text-align:left">boolean mRequiresDeviceIdle</td>
<td style="text-align:left">setRequiresDeviceIdle</td>
</tr>
<tr>
<td style="text-align:left">int mNetworkType</td>
<td style="text-align:left">setRequiredNetworkType</td>
</tr>
<tr>
<td style="text-align:left">ArrayList<triggercontenturi> mTriggerContentUris</triggercontenturi></td>
<td style="text-align:left">addTriggerContentUri</td>
</tr>
<tr>
<td style="text-align:left">long mTriggerContentUpdateDelay</td>
<td style="text-align:left">setTriggerContentUpdateDelay</td>
</tr>
<tr>
<td style="text-align:left">long mTriggerContentMaxDelay</td>
<td style="text-align:left">setTriggerContentMaxDelay</td>
</tr>
<tr>
<td style="text-align:left">boolean mIsPersisted</td>
<td style="text-align:left">setPersisted</td>
</tr>
<tr>
<td style="text-align:left">long mMinLatencyMillis</td>
<td style="text-align:left">setMinimumLatency</td>
</tr>
<tr>
<td style="text-align:left">long mMaxExecutionDelayMillis</td>
<td style="text-align:left">setOverrideDeadline</td>
</tr>
<tr>
<td style="text-align:left">boolean mIsPeriodic</td>
<td style="text-align:left">setPeriodic</td>
</tr>
<tr>
<td style="text-align:left">boolean mHasEarlyConstraint</td>
<td style="text-align:left">setMinimumLatency、setPeriodic</td>
</tr>
<tr>
<td style="text-align:left">boolean mHasLateConstraint</td>
<td style="text-align:left">setOverrideDeadline、setPeriodic</td>
</tr>
<tr>
<td style="text-align:left">long mIntervalMillis</td>
<td style="text-align:left">setPeriodic</td>
</tr>
<tr>
<td style="text-align:left">long mFlexMillis</td>
<td style="text-align:left">setPeriodic</td>
</tr>
<tr>
<td style="text-align:left">long mInitialBackoffMillis</td>
<td style="text-align:left">setBackoffCriteria</td>
</tr>
<tr>
<td style="text-align:left">int mBackoffPolicy</td>
<td style="text-align:left">setBackoffCriteria</td>
</tr>
<tr>
<td style="text-align:left">boolean mBackoffPolicySet</td>
<td style="text-align:left">setBackoffCriteria</td>
</tr>
</tbody>
</table>
<p>接下来我们分析一下细节：</p>
<blockquote>
<p>网络类型的取值：</p>
</blockquote>
<ul>
<li>NETWORK_TYPE_NONE：默认值。表示与网络状态无关</li>
<li>NETWORK_TYPE_ANY：必须连接网络</li>
<li>NETWORK_TYPE_NOT_ROAMING：必须连接非漫游的网络</li>
<li>NETWORK_TYPE_UNMETERED：必须连接非计费的网络</li>
</ul>
<blockquote>
<p>退避 | 重试策略：</p>
</blockquote>
<ul>
<li>long mInitialBackoffMillis：第一次尝试重试的等待间隔，单位为毫秒，预设的取值有下面 2 种：<ul>
<li>DEFAULT_INITIAL_BACKOFF_MILLIS：30 秒</li>
<li>MAX_BACKOFF_DELAY_MILLIS：5 小时</li>
</ul>
</li>
<li>int mBackoffPolicy：退避策略<ul>
<li>BACKOFF_POLICY_LINEAR：0<ul>
<li>对应的重试时间计算公式是:</li>
<li><strong>current_time + initial_backoff_millis * num_failures, num_failures &gt;= 1</strong></li>
</ul>
</li>
<li>BACKOFF_POLICY_EXPONENTIAL：1<ul>
<li>对应的重试时间计算公式是： </li>
<li><strong>current_time + initial_backoff_millis * 2 ^ (num_failures - 1), num_failures &gt;= 1</strong></li>
</ul>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>优先级的取值：</p>
</blockquote>
<ul>
<li>PRIORITY_DEFAULT：0</li>
<li>PRIORITY_SYNC_EXPEDITED：10</li>
<li>PRIORITY_SYNC_INITIALIZATION：20</li>
<li>PRIORITY_FOREGROUND_APP：30</li>
<li>PRIORITY_TOP_APP：40</li>
<li>PRIORITY_ADJ_OFTEN_RUNNING：-40</li>
<li>PRIORITY_ADJ_ALWAYS_RUNNING：-80</li>
</ul>
<blockquote>
<p>周期时间的取值：</p>
</blockquote>
<ul>
<li>MIN_PERIOD_MILLIS：15 <em> 60 </em> 1000L，最小的执行周期时间，15 分钟</li>
<li>MIN_FLEX_MILLIS：5 <em> 60 </em> 1000L，最小的时间窗，5分钟</li>
</ul>
<p>接下来，我们来分析下 build 方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> JobInfo <span class="title">build</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 至少要设置一个约束条件！</span></span><br><span class="line">    <span class="keyword">if</span> (!mHasEarlyConstraint &amp;&amp; !mHasLateConstraint &amp;&amp; !mRequiresCharging &amp;&amp;</span><br><span class="line">            !mRequiresDeviceIdle &amp;&amp; mNetworkType == NETWORK_TYPE_NONE &amp;&amp;</span><br><span class="line">            mTriggerContentUris == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"You're trying to build a job with no "</span> +</span><br><span class="line">                <span class="string">"constraints, this is not allowed."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mExtras = <span class="keyword">new</span> PersistableBundle(mExtras);  <span class="comment">// Make our own copy.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 周期性的 job 不能设置延迟执行时间和最大延迟执行时间，也不能设置数据库变化的约束条件！</span></span><br><span class="line">    <span class="comment">// 重启保留的 job 不能设置数据库变化的约束条件！</span></span><br><span class="line">    <span class="comment">// 设置了退避 | 重试策略的 job 不能设置 DOZE 约束条件！</span></span><br><span class="line">    <span class="keyword">if</span> (mIsPeriodic &amp;&amp; (mMaxExecutionDelayMillis != <span class="number">0L</span>)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Can't call setOverrideDeadline() on a "</span> +</span><br><span class="line">                <span class="string">"periodic job."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mIsPeriodic &amp;&amp; (mMinLatencyMillis != <span class="number">0L</span>)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Can't call setMinimumLatency() on a "</span> +</span><br><span class="line">                <span class="string">"periodic job"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mIsPeriodic &amp;&amp; (mTriggerContentUris != <span class="keyword">null</span>)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Can't call addTriggerContentUri() on a "</span> +</span><br><span class="line">                <span class="string">"periodic job"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mIsPersisted &amp;&amp; (mTriggerContentUris != <span class="keyword">null</span>)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Can't call addTriggerContentUri() on a "</span> +</span><br><span class="line">                <span class="string">"persisted job"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mBackoffPolicySet &amp;&amp; mRequiresDeviceIdle) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"An idle mode job will not respect any"</span> +</span><br><span class="line">                <span class="string">" back-off policy, so calling setBackoffCriteria with"</span> +</span><br><span class="line">                <span class="string">" setRequiresDeviceIdle is an error."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建 JobInfo 对象！</span></span><br><span class="line">    JobInfo job = <span class="keyword">new</span> JobInfo(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (job.isPeriodic()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (job.intervalMillis != job.getIntervalMillis()) &#123;</span><br><span class="line">            StringBuilder builder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">            builder.append(<span class="string">"Specified interval for "</span>)</span><br><span class="line">                    .append(String.valueOf(mJobId))</span><br><span class="line">                    .append(<span class="string">" is "</span>);</span><br><span class="line">            formatDuration(mIntervalMillis, builder);</span><br><span class="line">            builder.append(<span class="string">". Clamped to "</span>);</span><br><span class="line">            formatDuration(job.getIntervalMillis(), builder);</span><br><span class="line">            Log.w(TAG, builder.toString());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (job.flexMillis != job.getFlexMillis()) &#123;</span><br><span class="line">            StringBuilder builder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">            builder.append(<span class="string">"Specified flex for "</span>)</span><br><span class="line">                    .append(String.valueOf(mJobId))</span><br><span class="line">                    .append(<span class="string">" is "</span>);</span><br><span class="line">            formatDuration(mFlexMillis, builder);</span><br><span class="line">            builder.append(<span class="string">". Clamped to "</span>);</span><br><span class="line">            formatDuration(job.getFlexMillis(), builder);</span><br><span class="line">            Log.w(TAG, builder.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> job;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里我们来总结一下：</p>
<ul>
<li>至少要设置一个约束条件！</li>
<li>周期性的 job 不能设置延迟执行时间和最大延迟执行时间，也不能设置数据库变化的约束条件！</li>
<li>重启保留的 job 不能设置数据库变化的约束条件！</li>
<li>设置了退避 | 重试策略的 job 不能设置 DOZE 约束条件！</li>
</ul>
<h2 id="1-2-JobInfo"><a href="#1-2-JobInfo" class="headerlink" title="1.2 JobInfo"></a>1.2 JobInfo</h2><p>我们来看看构造器：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">JobInfo</span><span class="params">(JobInfo.Builder b)</span> </span>&#123;</span><br><span class="line">    jobId = b.mJobId;</span><br><span class="line">    extras = b.mExtras;</span><br><span class="line">    service = b.mJobService;</span><br><span class="line">    requireCharging = b.mRequiresCharging;</span><br><span class="line">    requireDeviceIdle = b.mRequiresDeviceIdle;</span><br><span class="line">    triggerContentUris = b.mTriggerContentUris != <span class="keyword">null</span></span><br><span class="line">            ? b.mTriggerContentUris.toArray(<span class="keyword">new</span> TriggerContentUri[b.mTriggerContentUris.size()])</span><br><span class="line">            : <span class="keyword">null</span>;</span><br><span class="line">    triggerContentUpdateDelay = b.mTriggerContentUpdateDelay;</span><br><span class="line">    triggerContentMaxDelay = b.mTriggerContentMaxDelay;</span><br><span class="line">    networkType = b.mNetworkType;</span><br><span class="line">    minLatencyMillis = b.mMinLatencyMillis;</span><br><span class="line">    maxExecutionDelayMillis = b.mMaxExecutionDelayMillis;</span><br><span class="line">    isPeriodic = b.mIsPeriodic;</span><br><span class="line">    isPersisted = b.mIsPersisted;</span><br><span class="line">    intervalMillis = b.mIntervalMillis;</span><br><span class="line">    flexMillis = b.mFlexMillis;</span><br><span class="line">    initialBackoffMillis = b.mInitialBackoffMillis;</span><br><span class="line">    backoffPolicy = b.mBackoffPolicy;</span><br><span class="line">    hasEarlyConstraint = b.mHasEarlyConstraint;</span><br><span class="line">    hasLateConstraint = b.mHasLateConstraint;</span><br><span class="line">    priority = b.mPriority;</span><br><span class="line">    flags = b.mFlags;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看出，参数的意义和 builder 是一样的，我们来看看：</p>
<table>
<thead>
<tr>
<th style="text-align:left">属性</th>
<th style="text-align:left">获取方法</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">int jobId</td>
<td style="text-align:left">getId</td>
</tr>
<tr>
<td style="text-align:left">ComponentName service</td>
<td style="text-align:left">getService</td>
</tr>
<tr>
<td style="text-align:left">PersistableBundle extras</td>
<td style="text-align:left">getExtras</td>
</tr>
<tr>
<td style="text-align:left">int priority</td>
<td style="text-align:left">getPriority</td>
</tr>
<tr>
<td style="text-align:left">int flags</td>
<td style="text-align:left">getFlags</td>
</tr>
<tr>
<td style="text-align:left">boolean requiresCharging</td>
<td style="text-align:left">isRequireCharging</td>
</tr>
<tr>
<td style="text-align:left">boolean requiresDeviceIdle</td>
<td style="text-align:left">isRequireDeviceIdle</td>
</tr>
<tr>
<td style="text-align:left">int networkType</td>
<td style="text-align:left">getNetworkType</td>
</tr>
<tr>
<td style="text-align:left">ArrayList<triggercontenturi> triggerContentUris</triggercontenturi></td>
<td style="text-align:left">getTriggerContentUris</td>
</tr>
<tr>
<td style="text-align:left">long triggerContentUpdateDelay</td>
<td style="text-align:left">getTriggerContentUpdateDelay</td>
</tr>
<tr>
<td style="text-align:left">long triggerContentMaxDelay</td>
<td style="text-align:left">getTriggerContentMaxDelay</td>
</tr>
<tr>
<td style="text-align:left">boolean isPersisted</td>
<td style="text-align:left">isPersisted</td>
</tr>
<tr>
<td style="text-align:left">long minLatencyMillis</td>
<td style="text-align:left">getMinLatencyMillis</td>
</tr>
<tr>
<td style="text-align:left">long maxExecutionDelayMillis</td>
<td style="text-align:left">getMaxExecutionDelayMillis</td>
</tr>
<tr>
<td style="text-align:left">boolean isPeriodic</td>
<td style="text-align:left">isPeriodic</td>
</tr>
<tr>
<td style="text-align:left">boolean hasEarlyConstraint</td>
<td style="text-align:left">hasEarlyConstraint</td>
</tr>
<tr>
<td style="text-align:left">boolean hasLateConstraint</td>
<td style="text-align:left">hasLateConstraint</td>
</tr>
<tr>
<td style="text-align:left">long intervalMillis</td>
<td style="text-align:left">getIntervalMillis</td>
</tr>
<tr>
<td style="text-align:left">long flexMillis</td>
<td style="text-align:left">getFlexMillis</td>
</tr>
<tr>
<td style="text-align:left">long initialBackoffMillis</td>
<td style="text-align:left">getInitialBackoffMillis</td>
</tr>
<tr>
<td style="text-align:left">int backoffPolicy</td>
<td style="text-align:left">getBackoffPolicy</td>
</tr>
</tbody>
</table>
<p>我们接着看：</p>
<h1 id="2-JobStatus"><a href="#2-JobStatus" class="headerlink" title="2 JobStatus"></a>2 JobStatus</h1><p>我们 schedule 一个 jobInfo 后，JSS 会创建对应的 JobStatus，我们先来看看他的构造器：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 通过一个 JobStatus 创建！</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">JobStatus</span><span class="params">(JobStatus jobStatus)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>(jobStatus.getJob(), jobStatus.getUid(),</span><br><span class="line">            jobStatus.getSourcePackageName(), jobStatus.getSourceUserId(),</span><br><span class="line">            jobStatus.getSourceTag(), jobStatus.getNumFailures(),</span><br><span class="line">            jobStatus.getEarliestRunTime(), jobStatus.getLatestRunTimeElapsed());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从本地文件 Jobs.xml 中读取数据，创建 JobStatus</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">JobStatus</span><span class="params">(JobInfo job, <span class="keyword">int</span> callingUid, String sourcePackageName, <span class="keyword">int</span> sourceUserId,</span></span></span><br><span class="line"><span class="function"><span class="params">        String sourceTag, <span class="keyword">long</span> earliestRunTimeElapsedMillis, <span class="keyword">long</span> latestRunTimeElapsedMillis)</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">this</span>(job, callingUid, sourcePackageName, sourceUserId, sourceTag, <span class="number">0</span>,</span><br><span class="line">            earliestRunTimeElapsedMillis, latestRunTimeElapsedMillis);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据参数创建一个 JobStatus</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">JobStatus</span><span class="params">(JobStatus rescheduling, <span class="keyword">long</span> newEarliestRuntimeElapsedMillis,</span></span></span><br><span class="line"><span class="function"><span class="params">                  <span class="keyword">long</span> newLatestRuntimeElapsedMillis, <span class="keyword">int</span> backoffAttempt)</span> </span>&#123;</span><br><span class="line">                  </span><br><span class="line">    <span class="keyword">this</span>(rescheduling.job, rescheduling.getUid(),</span><br><span class="line">            rescheduling.getSourcePackageName(), rescheduling.getSourceUserId(),</span><br><span class="line">            rescheduling.getSourceTag(), backoffAttempt, newEarliestRuntimeElapsedMillis,</span><br><span class="line">            newLatestRuntimeElapsedMillis);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>最终都会调用这个构造器方法，参数传递：</p>
<ul>
<li>JobInfo job：jobInfo 对象</li>
<li>int callingUid：job 所属进程的 uid</li>
<li>String sourcePackageName：job 所属应用的包名</li>
<li>int sourceUserId：job所属的设备用户</li>
<li>String tag：</li>
<li>int numFailures：失败次数</li>
<li>long earliestRunTimeElapsedMillis： 最早执行时间</li>
<li>long latestRunTimeElapsedMillis：最晚执行时间</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">JobStatus</span><span class="params">(JobInfo job, <span class="keyword">int</span> callingUid, String sourcePackageName,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> sourceUserId, String tag, <span class="keyword">int</span> numFailures, <span class="keyword">long</span> earliestRunTimeElapsedMillis,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">long</span> latestRunTimeElapsedMillis)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.job = job;</span><br><span class="line">    <span class="keyword">this</span>.callingUid = callingUid;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> tempSourceUid = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (sourceUserId != -<span class="number">1</span> &amp;&amp; sourcePackageName != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            tempSourceUid = AppGlobals.getPackageManager().getPackageUid(sourcePackageName, <span class="number">0</span>,</span><br><span class="line">                    sourceUserId);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">            <span class="comment">// Can't happen, PackageManager runs in the same process.</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (tempSourceUid == -<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.sourceUid = callingUid;</span><br><span class="line">        <span class="keyword">this</span>.sourceUserId = UserHandle.getUserId(callingUid);</span><br><span class="line">        <span class="keyword">this</span>.sourcePackageName = job.getService().getPackageName();</span><br><span class="line">        <span class="keyword">this</span>.sourceTag = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.sourceUid = tempSourceUid;</span><br><span class="line">        <span class="keyword">this</span>.sourceUserId = sourceUserId;</span><br><span class="line">        <span class="keyword">this</span>.sourcePackageName = sourcePackageName;</span><br><span class="line">        <span class="keyword">this</span>.sourceTag = tag;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.batteryName = <span class="keyword">this</span>.sourceTag != <span class="keyword">null</span></span><br><span class="line">            ? <span class="keyword">this</span>.sourceTag + <span class="string">":"</span> + job.getService().getPackageName()</span><br><span class="line">            : job.getService().flattenToShortString();</span><br><span class="line">    <span class="keyword">this</span>.tag = <span class="string">"*job*/"</span> + <span class="keyword">this</span>.batteryName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.earliestRunTimeElapsedMillis = earliestRunTimeElapsedMillis;</span><br><span class="line">    <span class="keyword">this</span>.latestRunTimeElapsedMillis = latestRunTimeElapsedMillis;</span><br><span class="line">    <span class="keyword">this</span>.numFailures = numFailures;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// requiredConstraints 使用二进制位记录 job 所依赖的约束条件，依赖某个条件，对应的二进制位置为 1！</span></span><br><span class="line">    <span class="keyword">int</span> requiredConstraints = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (job.getNetworkType() == JobInfo.NETWORK_TYPE_ANY) &#123;</span><br><span class="line">        requiredConstraints |= CONSTRAINT_CONNECTIVITY;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (job.getNetworkType() == JobInfo.NETWORK_TYPE_UNMETERED) &#123;</span><br><span class="line">        requiredConstraints |= CONSTRAINT_UNMETERED;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (job.getNetworkType() == JobInfo.NETWORK_TYPE_NOT_ROAMING) &#123;</span><br><span class="line">        requiredConstraints |= CONSTRAINT_NOT_ROAMING;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (job.isRequireCharging()) &#123;</span><br><span class="line">        requiredConstraints |= CONSTRAINT_CHARGING;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (earliestRunTimeElapsedMillis != NO_EARLIEST_RUNTIME) &#123;</span><br><span class="line">        requiredConstraints |= CONSTRAINT_TIMING_DELAY;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (latestRunTimeElapsedMillis != NO_LATEST_RUNTIME) &#123;</span><br><span class="line">        requiredConstraints |= CONSTRAINT_DEADLINE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (job.isRequireDeviceIdle()) &#123;</span><br><span class="line">        requiredConstraints |= CONSTRAINT_IDLE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (job.getTriggerContentUris() != <span class="keyword">null</span>) &#123;</span><br><span class="line">        requiredConstraints |= CONSTRAINT_CONTENT_TRIGGER;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.requiredConstraints = requiredConstraints;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以看到，构造函数很简单，没有多么复杂的，我们来总结一下，JobStatus 中的参数：</p>
<table>
<thead>
<tr>
<th style="text-align:left">参数</th>
<th style="text-align:left">参数解释</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">JobInfo job</td>
<td style="text-align:left">JobInfo 对象</td>
</tr>
<tr>
<td style="text-align:left">int callingUid</td>
<td style="text-align:left">调用者进程 uid</td>
</tr>
<tr>
<td style="text-align:left">String batteryName</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">String sourcePackageName</td>
<td style="text-align:left">job 所属应用的包名</td>
</tr>
<tr>
<td style="text-align:left">int sourceUserId</td>
<td style="text-align:left">job 所属设备用户</td>
</tr>
<tr>
<td style="text-align:left">int sourceUid</td>
<td style="text-align:left">job 所属应用的 uid</td>
</tr>
<tr>
<td style="text-align:left">String sourceTag</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">String tag</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">long earliestRunTimeElapsedMillis</td>
<td style="text-align:left">job 最早执行的时间</td>
</tr>
<tr>
<td style="text-align:left">long latestRunTimeElapsedMillis</td>
<td style="text-align:left">job 最晚执行的时间</td>
</tr>
<tr>
<td style="text-align:left">int numFailures</td>
<td style="text-align:left">job 执行失败的次数</td>
</tr>
<tr>
<td style="text-align:left">int requiredConstraints</td>
<td style="text-align:left">每个二进制位表示 job 所依赖的约束条件</td>
</tr>
<tr>
<td style="text-align:left">int satisfiedConstraints = 0</td>
<td style="text-align:left">每个二进制位表示 job 对应的约束条件是否满足</td>
</tr>
<tr>
<td style="text-align:left">boolean dozeWhitelisted</td>
<td style="text-align:left">job 是否在 doze 白名单中</td>
</tr>
<tr>
<td style="text-align:left">ArraySet<uri> changedUris</uri></td>
<td style="text-align:left">job 依赖的数据库的 Uri</td>
</tr>
<tr>
<td style="text-align:left">ArraySet<string> changedAuthorities</string></td>
<td style="text-align:left">job 依赖的数据库的 Uri</td>
</tr>
<tr>
<td style="text-align:left">int lastEvaluatedPriority</td>
<td style="text-align:left">job 的优先级</td>
</tr>
<tr>
<td style="text-align:left">int overrideState = 0</td>
<td style="text-align:left">shell 命令用到</td>
</tr>
</tbody>
</table>
<p>我们继续来看：</p>
<blockquote>
<p>约束条件的表示</p>
</blockquote>
<ul>
<li><p>用户可以设置的约束条件：</p>
<ul>
<li>CONSTRAINT_CHARGING：1&lt;&lt;0，充电</li>
<li>CONSTRAINT_TIMING_DELAY：1&lt;&lt;1，延迟处理</li>
<li>CONSTRAINT_DEADLINE：1&lt;&lt;2，超时处理</li>
<li>CONSTRAINT_IDLE：1&lt;&lt;3，doze 模式</li>
<li>CONSTRAINT_UNMETERED：1&lt;&lt;4，必须连接非漫游的网络</li>
<li>CONSTRAINT_CONNECTIVITY：1&lt;&lt;5，必须连接网络</li>
<li>CONSTRAINT_APP_NOT_IDLE：1&lt;&lt;6，app 处于非空闲状态</li>
<li>CONSTRAINT_CONTENT_TRIGGER：1&lt;&lt;7，数据库变化</li>
<li>CONSTRAINT_NOT_ROAMING：1&lt;&lt;9，必须连接非计费的网络</li>
</ul>
</li>
<li><p>用户无法设置的约束条件：</p>
<ul>
<li>CONSTRAINT_DEVICE_NOT_DOZING：1&lt;&lt;8，不受 doze 模式限制，这个是由 DeviceIdleJobsController 获得 doze 模式白名单的更新，动态的对 uid 在白名单中的 job 进行设置的！</li>
</ul>
</li>
</ul>
<blockquote>
<p>最早执行时间和最晚执行时间（）</p>
</blockquote>
<ul>
<li>对于周期性 job<ul>
<li>最早执行时间： </li>
<li><strong>earliestRunTimeElapsedMillis = latestRunTimeElapsedMillis - job.getFlexMillis()</strong></li>
<li>最晚执行时间： </li>
<li><strong>latestRunTimeElapsedMillis = elapsedNow + job.getIntervalMillis()</strong></li>
</ul>
</li>
<li>对于非周期性 job<ul>
<li>最早执行时间：<ul>
<li>设置了延迟执行时间：</li>
<li><strong>earliestRunTimeElapsedMillis = elapsedNow + job.getMinLatencyMillis()</strong></li>
<li>未设置延迟执行时间： </li>
<li><strong>earliestRunTimeElapsedMillis = NO_EARLIEST_RUNTIME = 0L</strong></li>
</ul>
</li>
<li>最晚执行时间：<ul>
<li>设置了最大延迟执行时间：</li>
<li><strong>latestRunTimeElapsedMillis = elapsedNow + job.getMaxExecutionDelayMillis()</strong></li>
<li>未设置最大延迟执行时间： </li>
<li><strong>latestRunTimeElapsedMillis = NO_LATEST_RUNTIME = Long.MAX_VALUE</strong></li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="3-JobParameters"><a href="#3-JobParameters" class="headerlink" title="3 JobParameters"></a>3 JobParameters</h1><p>JobParameters 是 job 执行时的参数，我们来看看他的参数：</p>
<ul>
<li>int jobId：job 的 id！</li>
<li>PersistableBundle extras：重启恢复的数据！</li>
<li>IBinder callback：JobSchedulerContext 的 binder 代理对象！</li>
<li>boolean overrideDeadlineExpired：job 是否已经超时！</li>
<li>Uri[] mTriggeredContentUris：监控的数据库的 Uri！</li>
<li>String[] mTriggeredContentAuthorities：监控的数据库的 Authorities！</li>
<li>int stopReason：job 停止的原因！<ul>
<li>int REASON_CANCELED = 0，默认为 cancel</li>
<li>int REASON_CONSTRAINTS_NOT_SATISFIED = 1</li>
<li>int REASON_PREEMPT = 2</li>
<li>int REASON_TIMEOUT = 3</li>
<li>int REASON_DEVICE_IDLE = 4 </li>
</ul>
</li>
</ul>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2016/04/27/JobScheduler第 7 篇 - JobSchedulerService - package and uid change/">JobScheduler第 7 篇 - JobSchedulerService - package and uid change</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-04-27</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/AndroidFramework源码分析/">AndroidFramework源码分析</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/AndroidFramework源码分析/JobScheduler任务调度/">JobScheduler任务调度</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/JobScheduler任务调度/">JobScheduler任务调度</a></span><div class="content"><p>基于 Android 7.1.1 源码分析：</p>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>我们想象这样的场景，如果有一个应用，它 schedule 了一些 job， 这些 job 可能正在运行，可能在 pending！这个时候，用户卸载了这个应用，那这个应用对应的 job 该何去何从？这里就要涉及到 package change 对 job 的影响了！</p>
<p>同时，进程优先级的变化，其实也会影响进程内的 job 的优先级！</p>
<p>我们回到 JSS 的启动和初始化：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onBootPhase</span><span class="params">(<span class="keyword">int</span> phase)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (PHASE_SYSTEM_SERVICES_READY == phase) &#123;</span><br><span class="line">        mConstants.start(getContext().getContentResolver());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 注册广播，监听应用程序包的操作！</span></span><br><span class="line">        <span class="keyword">final</span> IntentFilter filter = <span class="keyword">new</span> IntentFilter();</span><br><span class="line">        filter.addAction(Intent.ACTION_PACKAGE_REMOVED);</span><br><span class="line">        filter.addAction(Intent.ACTION_PACKAGE_CHANGED);</span><br><span class="line">        filter.addAction(Intent.ACTION_PACKAGE_RESTARTED);</span><br><span class="line">        filter.addAction(Intent.ACTION_QUERY_PACKAGE_RESTART);</span><br><span class="line">        filter.addDataScheme(<span class="string">"package"</span>);</span><br><span class="line">        getContext().registerReceiverAsUser(</span><br><span class="line">                mBroadcastReceiver, UserHandle.ALL, filter, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 注册广播，监听设备用户的操作！</span></span><br><span class="line">        <span class="keyword">final</span> IntentFilter userFilter = <span class="keyword">new</span> IntentFilter(Intent.ACTION_USER_REMOVED);</span><br><span class="line">        getContext().registerReceiverAsUser(</span><br><span class="line">                mBroadcastReceiver, UserHandle.ALL, userFilter, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        mPowerManager = (PowerManager)getContext().getSystemService(Context.POWER_SERVICE);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">        </span><br><span class="line">            <span class="comment">// 注册 uid 监控者</span></span><br><span class="line">            ActivityManagerNative.getDefault().registerUidObserver(mUidObserver,</span><br><span class="line">                    ActivityManager.UID_OBSERVER_PROCSTATE | ActivityManager.UID_OBSERVER_GONE</span><br><span class="line">                    | ActivityManager.UID_OBSERVER_IDLE);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            <span class="comment">// ignored; both services live in system_server</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (phase == PHASE_THIRD_PARTY_APPS_CAN_START) &#123;</span><br><span class="line">        ... ... ... ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到，这段代码，注册了两个广播监听者，下面我们一一来看！</p>
<p>这里有个小细节，如果想监听程序的安装和删除的广播，需要静态或者动态配置以下属性：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">data</span> <span class="attr">android:scheme</span>=<span class="string">"package"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">data</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>或者：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">filter.addDataScheme(<span class="string">"package"</span>);</span><br></pre></td></tr></table></figure></p>
<h1 id="1-Package-Change"><a href="#1-Package-Change" class="headerlink" title="1 Package Change"></a>1 Package Change</h1><p>我们回到 JobSchedulerService 服务中去，在 JSS 中，有一个广播接收者，代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Cleans up outstanding jobs when a package is removed. Even if it's being replaced later we</span></span><br><span class="line"><span class="comment"> * still clean up. On reinstall the package will have a new uid.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> BroadcastReceiver mBroadcastReceiver = <span class="keyword">new</span> BroadcastReceiver() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(Context context, Intent intent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> String action = intent.getAction();</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">            Slog.d(TAG, <span class="string">"Receieved: "</span> + action);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (Intent.ACTION_PACKAGE_CHANGED.equals(action)) &#123; <span class="comment">// 应用程序包改变的广播！</span></span><br><span class="line">            <span class="comment">// Purge the app's jobs if the whole package was just disabled.  When this is</span></span><br><span class="line">            <span class="comment">// the case the component name will be a bare package name.</span></span><br><span class="line">            <span class="keyword">final</span> String pkgName = getPackageName(intent);</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> pkgUid = intent.getIntExtra(Intent.EXTRA_UID, -<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (pkgName != <span class="keyword">null</span> &amp;&amp; pkgUid != -<span class="number">1</span>) &#123;</span><br><span class="line">                <span class="comment">// 获得改变的应用程序组件。</span></span><br><span class="line">                <span class="keyword">final</span> String[] changedComponents = intent.getStringArrayExtra(</span><br><span class="line">                        Intent.EXTRA_CHANGED_COMPONENT_NAME_LIST);</span><br><span class="line">                        </span><br><span class="line">                <span class="keyword">if</span> (changedComponents != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">for</span> (String component : changedComponents) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (component.equals(pkgName)) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                                Slog.d(TAG, <span class="string">"Package state change: "</span> + pkgName);</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                <span class="keyword">final</span> <span class="keyword">int</span> userId = UserHandle.getUserId(pkgUid);</span><br><span class="line">                                IPackageManager pm = AppGlobals.getPackageManager();</span><br><span class="line"></span><br><span class="line">                                <span class="comment">// 获得这个 package 的状态！</span></span><br><span class="line">                                <span class="keyword">final</span> <span class="keyword">int</span> state = pm.getApplicationEnabledSetting(pkgName, userId);</span><br><span class="line">                                <span class="keyword">if</span> (state == COMPONENT_ENABLED_STATE_DISABLED</span><br><span class="line">                                        || state ==  COMPONENT_ENABLED_STATE_DISABLED_USER) &#123;</span><br><span class="line">                                    <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                                        Slog.d(TAG, <span class="string">"Removing jobs for package "</span> + pkgName</span><br><span class="line">                                                + <span class="string">" in user "</span> + userId);</span><br><span class="line">                                    &#125;</span><br><span class="line"></span><br><span class="line">                                    <span class="comment">// 第二个参数表示，强制取消！</span></span><br><span class="line">                                    cancelJobsForUid(pkgUid, <span class="keyword">true</span>);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125; <span class="keyword">catch</span> (RemoteException|IllegalArgumentException e) &#123;</span><br><span class="line">                                ... ... ... ... ...</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"PACKAGE_CHANGED for "</span> + pkgName + <span class="string">" / uid "</span> + pkgUid);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Intent.ACTION_PACKAGE_REMOVED.equals(action)) &#123; <span class="comment">// 应用程序被移除的广播！</span></span><br><span class="line">            <span class="comment">// If this is an outright uninstall rather than the first half of an</span></span><br><span class="line">            <span class="comment">// app update sequence, cancel the jobs associated with the app.</span></span><br><span class="line">            <span class="keyword">if</span> (!intent.getBooleanExtra(Intent.EXTRA_REPLACING, <span class="keyword">false</span>)) &#123;</span><br><span class="line">                <span class="keyword">int</span> uidRemoved = intent.getIntExtra(Intent.EXTRA_UID, -<span class="number">1</span>);</span><br><span class="line">                <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                    Slog.d(TAG, <span class="string">"Removing jobs for uid: "</span> + uidRemoved);</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                cancelJobsForUid(uidRemoved, <span class="keyword">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Intent.ACTION_USER_REMOVED.equals(action)) &#123; <span class="comment">// 设备用户被移除的广播！</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> userId = intent.getIntExtra(Intent.EXTRA_USER_HANDLE, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                Slog.d(TAG, <span class="string">"Removing jobs for user: "</span> + userId);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            cancelJobsForUser(userId);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Intent.ACTION_QUERY_PACKAGE_RESTART.equals(action)) &#123; <span class="comment">// package 被启用的广播！</span></span><br><span class="line">            <span class="comment">// Has this package scheduled any jobs, such that we will take action</span></span><br><span class="line">            <span class="comment">// if it were to be force-stopped?</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> pkgUid = intent.getIntExtra(Intent.EXTRA_UID, -<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">final</span> String pkgName = intent.getData().getSchemeSpecificPart();</span><br><span class="line">            <span class="keyword">if</span> (pkgUid != -<span class="number">1</span>) &#123;</span><br><span class="line">                List&lt;JobStatus&gt; jobsForUid;</span><br><span class="line">                <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">                    jobsForUid = mJobs.getJobsByUid(pkgUid);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = jobsForUid.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (jobsForUid.get(i).getSourcePackageName().equals(pkgName)) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                            Slog.d(TAG, <span class="string">"Restart query: package "</span> + pkgName + <span class="string">" at uid "</span></span><br><span class="line">                                    + pkgUid + <span class="string">" has jobs"</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        setResultCode(Activity.RESULT_OK);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Intent.ACTION_PACKAGE_RESTARTED.equals(action)) &#123; <span class="comment">// package 被重启 的广播！</span></span><br><span class="line">            <span class="comment">// possible force-stop</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> pkgUid = intent.getIntExtra(Intent.EXTRA_UID, -<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">final</span> String pkgName = intent.getData().getSchemeSpecificPart();</span><br><span class="line">            <span class="keyword">if</span> (pkgUid != -<span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                    Slog.d(TAG, <span class="string">"Removing jobs for pkg "</span> + pkgName + <span class="string">" at uid "</span> + pkgUid);</span><br><span class="line">                &#125;</span><br><span class="line">                cancelJobsForPackageAndUid(pkgName, pkgUid);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>我们来总结一下：</p>
<p>监听的广播有下面的这些：</p>
<ul>
<li><p>package 相关</p>
<ul>
<li>Intent.ACTION_PACKAGE_CHANGED：应用程序包发生改变的广播！</li>
<li>Intent.ACTION_PACKAGE_REMOVED：删除应用程序包的广播！</li>
<li>Intent.ACTION_QUERY_PACKAGE_RESTART：</li>
<li>Intent.ACTION_PACKAGE_RESTARTED：</li>
</ul>
</li>
<li><p>user 相关</p>
<ul>
<li>Intent.ACTION_USER_REMOVED：设备用户被移除的广播！</li>
</ul>
</li>
</ul>
<p>但不管怎样，最后都会到了 cancel 相关的代码了！</p>
<h1 id="2-Uid-Change"><a href="#2-Uid-Change" class="headerlink" title="2 Uid Change"></a>2 Uid Change</h1><p>接着来，是监听进程 uid 的变化，依赖于 JSS 内部的一个观察者：mUidObserver：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">private</span> IUidObserver mUidObserver = <span class="keyword">new</span> IUidObserver.Stub() &#123;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// 传入的参数是 uid 和 uid 所属进程的状态 !</span></span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onUidStateChanged</span><span class="params">(<span class="keyword">int</span> uid, <span class="keyword">int</span> procState)</span> <span class="keyword">throws</span> RemoteException </span>&#123; <span class="comment">// 进程状态变化！</span></span><br><span class="line">        updateUidState(uid, procState);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onUidGone</span><span class="params">(<span class="keyword">int</span> uid)</span> <span class="keyword">throws</span> RemoteException </span>&#123; <span class="comment">// 进程被杀了！</span></span><br><span class="line">        updateUidState(uid, ActivityManager.PROCESS_STATE_CACHED_EMPTY);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onUidActive</span><span class="params">(<span class="keyword">int</span> uid)</span> <span class="keyword">throws</span> RemoteException </span>&#123; <span class="comment">// 进程活跃！</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onUidIdle</span><span class="params">(<span class="keyword">int</span> uid)</span> <span class="keyword">throws</span> RemoteException </span>&#123; <span class="comment">// 进程空闲！</span></span><br><span class="line">        cancelJobsForUid(uid, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>这里面调用了一个 方法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">void updateUidState(int uid, int procState) &#123;</span><br><span class="line"></span><br><span class="line">    synchronized (mLock) &#123;</span><br><span class="line">        if (procState == ActivityManager.PROCESS_STATE_TOP) &#123;</span><br><span class="line">            // Only use this if we are exactly the top app.  All others can live</span><br><span class="line">            // with just the foreground priority.  This means that persistent processes</span><br><span class="line">            // can never be the top app priority...  that is fine.</span><br><span class="line">            mUidPriorityOverride.put(uid, JobInfo.PRIORITY_TOP_APP);</span><br><span class="line"></span><br><span class="line">        &#125; else if (procState &lt;= ActivityManager.PROCESS_STATE_FOREGROUND_SERVICE) &#123;</span><br><span class="line">            mUidPriorityOverride.put(uid, JobInfo.PRIORITY_FOREGROUND_APP);</span><br><span class="line"></span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            mUidPriorityOverride.delete(uid);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到，这里当应用的进程的状态发生变化时，需要对其进程的状态和uid进行记录：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Which uids are currently in the foreground.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">final</span> SparseIntArray mUidPriorityOverride = <span class="keyword">new</span> SparseIntArray();</span><br></pre></td></tr></table></figure></p>
<p>这个稀疏数组用来保存进程的 uid 和进程的状态的，当某个应用的进程变为前台进程，每次变化就会被保存到这个集合中！</p>
<p>还记得在 schedule 篇中，我们讲到，对于同一个  uid 和 jobId 的 job，如果优先级不同，会发生优先级高的替换优先级低的 job 的情况，这里会用到如下的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">adjustJobPriority</span><span class="params">(<span class="keyword">int</span> curPriority, JobStatus job)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (curPriority &lt; JobInfo.PRIORITY_TOP_APP) &#123;</span><br><span class="line">        <span class="keyword">float</span> factor = mJobPackageTracker.getLoadFactor(job);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (factor &gt;= mConstants.HEAVY_USE_FACTOR) &#123;</span><br><span class="line">            curPriority += JobInfo.PRIORITY_ADJ_ALWAYS_RUNNING;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (factor &gt;= mConstants.MODERATE_USE_FACTOR) &#123;</span><br><span class="line">            curPriority += JobInfo.PRIORITY_ADJ_OFTEN_RUNNING;</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> curPriority;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">evaluateJobPriorityLocked</span><span class="params">(JobStatus job)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 获得 job 的优先级，默认为：PRIORITY_DEFAULT(0)</span></span><br><span class="line">    <span class="keyword">int</span> priority = job.getPriority();</span><br><span class="line">    <span class="keyword">if</span> (priority &gt;= JobInfo.PRIORITY_FOREGROUND_APP) &#123;</span><br><span class="line">        <span class="keyword">return</span> adjustJobPriority(priority, job);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 这里是判断当前 job 的 uid 所属进程是否是前台进程。</span></span><br><span class="line">    <span class="keyword">int</span> override = mUidPriorityOverride.get(job.getSourceUid(), <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (override != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> adjustJobPriority(override, job);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> adjustJobPriority(priority, job);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个方式是为了给 job 计算合适的优先级！</p>
<p>这里就不细说哦，可以去看 schedule 篇！</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2016/04/25/JobScheduler第 6 篇 - JobSchedulerService - job controll/">JobScheduler第 6 篇 - JobSchedulerService - job controll</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-04-25</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/AndroidFramework源码分析/">AndroidFramework源码分析</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/AndroidFramework源码分析/JobScheduler任务调度/">JobScheduler任务调度</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/JobScheduler任务调度/">JobScheduler任务调度</a></span><div class="content"><p>基于 Android 7.1.1 源码分析，分析 job controller 的实现机制！</p>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>我们知道，当我们把 job schedule 进入 JobSchedulerService 中后，JobSchdulerService 会拉起它，之前我们分析了用户主动 cancel 和 jobFinished job 时，具体的函数调用，而对于 job 除了受的到用户的主动操作之外，还有 controller 的控制，接下来，我们来看看那这部分代码！</p>
<p>Job 的 controll 都是在 controller 中，controller 的初始化是在 JobSchedulerService 中：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">JobSchedulerService</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(context);</span><br><span class="line">    mHandler = <span class="keyword">new</span> JobHandler(context.getMainLooper());</span><br><span class="line">    mConstants = <span class="keyword">new</span> Constants(mHandler);</span><br><span class="line">    mJobSchedulerStub = <span class="keyword">new</span> JobSchedulerStub();</span><br><span class="line">    mJobs = JobStore.initAndGet(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create the controllers.</span></span><br><span class="line">    mControllers = <span class="keyword">new</span> ArrayList&lt;StateController&gt;();</span><br><span class="line">    mControllers.add(ConnectivityController.get(<span class="keyword">this</span>));</span><br><span class="line">    mControllers.add(TimeController.get(<span class="keyword">this</span>));</span><br><span class="line">    mControllers.add(IdleController.get(<span class="keyword">this</span>));</span><br><span class="line">    mControllers.add(BatteryController.get(<span class="keyword">this</span>));</span><br><span class="line">    mControllers.add(AppIdleController.get(<span class="keyword">this</span>));</span><br><span class="line">    mControllers.add(ContentObserverController.get(<span class="keyword">this</span>));</span><br><span class="line">    mControllers.add(DeviceIdleJobsController.get(<span class="keyword">this</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>每一个 Controller 都采用了单例模式，保证了有且仅有一个 Controller，每个 Controller 内部都有一个集合用来管理其所控制的左右 job！</p>
<p>接下来，我们一个一个看：</p>
<h1 id="1-ConnectivityController"><a href="#1-ConnectivityController" class="headerlink" title="1 ConnectivityController"></a>1 ConnectivityController</h1><p>ConnectivityController 主要是用来根据网络条件来控制 job！<br>我们先来看构造器：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">ConnectivityController</span><span class="params">(StateChangedListener stateChangedListener, Context context,</span></span></span><br><span class="line"><span class="function"><span class="params">        Object lock)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(stateChangedListener, context, lock);</span><br><span class="line"></span><br><span class="line">    mConnManager = mContext.getSystemService(ConnectivityManager.class);</span><br><span class="line">    mNetPolicyManager = mContext.getSystemService(NetworkPolicyManager.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这里很简单，注册了一个广播接收者，监听 ConnectivityManager.CONNECTIVITY_ACTION 广播!</span></span><br><span class="line">    <span class="keyword">final</span> IntentFilter intentFilter = <span class="keyword">new</span> IntentFilter(ConnectivityManager.CONNECTIVITY_ACTION);</span><br><span class="line">    mContext.registerReceiverAsUser(</span><br><span class="line">            mConnectivityReceiver, UserHandle.SYSTEM, intentFilter, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 向网络策略管理服务注册监听器！</span></span><br><span class="line">    mNetPolicyManager.registerListener(mNetPolicyListener);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ConnectivityController 对 job 的控制主要依靠这两个监听器：</p>
<h2 id="1-1-CC-ConnectivityReceiver"><a href="#1-1-CC-ConnectivityReceiver" class="headerlink" title="1.1 CC.ConnectivityReceiver"></a>1.1 CC.ConnectivityReceiver</h2><p>我们先来看看第一个：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> BroadcastReceiver mConnectivityReceiver = <span class="keyword">new</span> BroadcastReceiver() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(Context context, Intent intent)</span> </span>&#123;</span><br><span class="line">        updateTrackedJobs(-<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>这个很简单，当网络断开或连接，会调用 updateTrackedJobs 方法！ </p>
<h2 id="1-2-CC-NetPolicyListener"><a href="#1-2-CC-NetPolicyListener" class="headerlink" title="1.2 CC.NetPolicyListener"></a>1.2 CC.NetPolicyListener</h2><p>接着看看网络策略监听器，当网络策略发生变化后，会回调接口：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> INetworkPolicyListener mNetPolicyListener = <span class="keyword">new</span> INetworkPolicyListener.Stub() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onUidRulesChanged</span><span class="params">(<span class="keyword">int</span> uid, <span class="keyword">int</span> uidRules)</span> </span>&#123;</span><br><span class="line">        updateTrackedJobs(uid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMeteredIfacesChanged</span><span class="params">(String[] meteredIfaces)</span> </span>&#123;</span><br><span class="line">        updateTrackedJobs(-<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRestrictBackgroundChanged</span><span class="params">(<span class="keyword">boolean</span> restrictBackground)</span> </span>&#123;</span><br><span class="line">        updateTrackedJobs(-<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRestrictBackgroundWhitelistChanged</span><span class="params">(<span class="keyword">int</span> uid, <span class="keyword">boolean</span> whitelisted)</span> </span>&#123;</span><br><span class="line">        updateTrackedJobs(uid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRestrictBackgroundBlacklistChanged</span><span class="params">(<span class="keyword">int</span> uid, <span class="keyword">boolean</span> blacklisted)</span> </span>&#123;</span><br><span class="line">        updateTrackedJobs(uid);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>可以发现，最终都调用了 updateTrackedJobs 方法：</p>
<h2 id="1-3-CC-updateTrackedJobs"><a href="#1-3-CC-updateTrackedJobs" class="headerlink" title="1.3 CC.updateTrackedJobs"></a>1.3 CC.updateTrackedJobs</h2><p>通过传入的 uid 的值，来更新具体的 job 状态！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateTrackedJobs</span><span class="params">(<span class="keyword">int</span> uid)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="keyword">boolean</span> changed = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mTrackedJobs.size(); i++) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 遍历 job 监控列表</span></span><br><span class="line">            <span class="keyword">final</span> JobStatus js = mTrackedJobs.get(i);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 关键点！</span></span><br><span class="line">            <span class="keyword">if</span> (uid == -<span class="number">1</span> || uid == js.getSourceUid()) &#123;</span><br><span class="line">                changed |= updateConstraintsSatisfied(js);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (changed) &#123; <span class="comment">// changed 为 ture 表示约束条件改变！</span></span><br><span class="line">            mStateChangedListener.onControllerStateChanged();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>更新策略分析：</p>
<ul>
<li>如果 uid 的值为 -1，那就更新这个控制器监视的所有 job；</li>
<li>如果 uid 的值为指定的 uid，那就更新属于这个 uid 的所有 job；</li>
</ul>
<p>这里调用了 updateConstraintsSatisfied 方法判断是否有 job 需要更新：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">updateConstraintsSatisfied</span><span class="params">(JobStatus jobStatus)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> ignoreBlocked = (jobStatus.getFlags() &amp; JobInfo.FLAG_WILL_BE_FOREGROUND) != <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获得这个 job 所属 uid （应用程序）的网络信息对象：NetworkInfo！</span></span><br><span class="line">    <span class="keyword">final</span> NetworkInfo info = mConnManager.getActiveNetworkInfoForUid(jobStatus.getSourceUid(),</span><br><span class="line">            ignoreBlocked);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> connected = (info != <span class="keyword">null</span>) &amp;&amp; info.isConnected();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> unmetered = connected &amp;&amp; !info.isMetered();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> notRoaming = connected &amp;&amp; !info.isRoaming();</span><br><span class="line">    <span class="keyword">boolean</span> changed = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据网络信息来更新 job 的状态，动态更新 satisfiedConstraints 的对应二进制位！</span></span><br><span class="line">    changed |= jobStatus.setConnectivityConstraintSatisfied(connected);</span><br><span class="line">    changed |= jobStatus.setUnmeteredConstraintSatisfied(unmetered);</span><br><span class="line">    changed |= jobStatus.setNotRoamingConstraintSatisfied(notRoaming);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> changed;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个方法获得这个 job 所属 uid （应用程序）的网络信息对象， 根据网络信息来更新 job！利用 |= 方法，只要有一个约束条件发生了变化，即发生了变化！<br>最后，调用 mStateChangedListener 的 onControllerStateChanged 方法来通知有 job 变化了！</p>
<p>ConnectivityController 的 startTrack 和 stopTrack 也很简单：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">maybeStartTrackingJobLocked</span><span class="params">(JobStatus jobStatus, JobStatus lastJob)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (jobStatus.hasConnectivityConstraint() || jobStatus.hasUnmeteredConstraint()</span><br><span class="line">            || jobStatus.hasNotRoamingConstraint()) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 在监控 job 之前，检查一下约束条件，并更新 job 的状态！</span></span><br><span class="line">        updateConstraintsSatisfied(jobStatus); </span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 添加到监控列表！</span></span><br><span class="line">        mTrackedJobs.add(jobStatus);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">maybeStopTrackingJobLocked</span><span class="params">(JobStatus jobStatus, JobStatus incomingJob,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> forUpdate)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (jobStatus.hasConnectivityConstraint() || jobStatus.hasUnmeteredConstraint()</span><br><span class="line">            || jobStatus.hasNotRoamingConstraint()) &#123;</span><br><span class="line">       </span><br><span class="line">        <span class="comment">// 从监控列表中移除！</span></span><br><span class="line">        mTrackedJobs.remove(jobStatus);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>先到这里，不多说了！</p>
<h1 id="2-TimeController"><a href="#2-TimeController" class="headerlink" title="2 TimeController"></a>2 TimeController</h1><p>接下来，看看时间控制器，一个 job 的超时和延迟处理，都是由这个控制器处理的：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">TimeController</span><span class="params">(StateChangedListener stateChangedListener, Context context, Object lock)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(stateChangedListener, context, lock);</span><br><span class="line">    <span class="comment">// 初始化为无限大！</span></span><br><span class="line">    mNextJobExpiredElapsedMillis = Long.MAX_VALUE;</span><br><span class="line">    mNextDelayExpiredElapsedMillis = Long.MAX_VALUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到，构造器中的代码很简单，重点不在这里啦！</p>
<h2 id="2-1-maybeStartTrackingJobLocked"><a href="#2-1-maybeStartTrackingJobLocked" class="headerlink" title="2.1 maybeStartTrackingJobLocked"></a>2.1 maybeStartTrackingJobLocked</h2><p>在  maybeStartTrackingJobLocked，参数传递：</p>
<ul>
<li>JobStatus job：这次要执行的 job</li>
<li>JobStatus lastJob：被取代的 job，可以为 null！<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">maybeStartTrackingJobLocked</span><span class="params">(JobStatus job, JobStatus lastJob)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断 job 是否设置了延迟时间和超时时间！</span></span><br><span class="line">    <span class="keyword">if</span> (job.hasTimingDelayConstraint() || job.hasDeadlineConstraint()) &#123;</span><br><span class="line">        maybeStopTrackingJobLocked(job, <span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> isInsert = <span class="keyword">false</span>;</span><br><span class="line">        ListIterator&lt;JobStatus&gt; it = mTrackedJobs.listIterator(mTrackedJobs.size());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 遍历 track 集合，根据超时处理的时间升序排列，插入新的 job！</span></span><br><span class="line">        <span class="keyword">while</span> (it.hasPrevious()) &#123;</span><br><span class="line">            JobStatus ts = it.previous();</span><br><span class="line">            <span class="keyword">if</span> (ts.getLatestRunTimeElapsed() &lt; job.getLatestRunTimeElapsed()) &#123;</span><br><span class="line">                <span class="comment">// Insert</span></span><br><span class="line">                isInsert = <span class="keyword">true</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isInsert) &#123;</span><br><span class="line">            it.next();</span><br><span class="line">        &#125;</span><br><span class="line">        it.add(job);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置延时处理和超时处理的 alarm！</span></span><br><span class="line">        maybeUpdateAlarmsLocked(</span><br><span class="line">                job.hasTimingDelayConstraint() ? job.getEarliestRunTime() : Long.MAX_VALUE,</span><br><span class="line">                job.hasDeadlineConstraint() ? job.getLatestRunTimeElapsed() : Long.MAX_VALUE,</span><br><span class="line">                job.getSourceUid());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>可以看到：</p>
<ul>
<li>如果 job 设置了延时触发条件，那么需要传入一个延迟时间值，这个时间值在这里通过 job.getEarliestRunTime() 获取！</li>
<li>如果 job 设置了超时处理触发条件，那么需要传入一个超时时间值，这个时间值在这里通过 job.getLatestRunTimeElapsed() 获取！</li>
<li>如果没有设置，默认为 Long.MAX_VALUE！</li>
</ul>
<p>注意：TimeController 的监控集合是以每个 job 的超时时间点排序的！</p>
<h2 id="2-2-maybeUpdateAlarmsLocked"><a href="#2-2-maybeUpdateAlarmsLocked" class="headerlink" title="2.2 maybeUpdateAlarmsLocked"></a>2.2 maybeUpdateAlarmsLocked</h2><p>接着进入 maybeUpdateAlarmsLocked 方法中，参数传递：</p>
<ul>
<li>long delayExpiredElapsed：延迟触发时间！</li>
<li>long deadlineExpiredElapsed：超时处理时间！</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">maybeUpdateAlarmsLocked</span><span class="params">(<span class="keyword">long</span> delayExpiredElapsed, <span class="keyword">long</span> deadlineExpiredElapsed,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> uid)</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// mNextDelayExpiredElapsedMillis 的值为 Long.MAX_VALUE</span></span><br><span class="line">    <span class="keyword">if</span> (delayExpiredElapsed &lt; mNextDelayExpiredElapsedMillis) &#123;</span><br><span class="line">        setDelayExpiredAlarmLocked(delayExpiredElapsed, uid);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// mNextJobExpiredElapsedMillis 的值为 Long.MAX_VALUE</span></span><br><span class="line">    <span class="keyword">if</span> (deadlineExpiredElapsed &lt; mNextJobExpiredElapsedMillis) &#123;</span><br><span class="line">        setDeadlineExpiredAlarmLocked(deadlineExpiredElapsed, uid);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里调用了两个方法，来设定 alarm：</p>
<h2 id="2-3-setXXXXExpiredAlarmLocked"><a href="#2-3-setXXXXExpiredAlarmLocked" class="headerlink" title="2.3 setXXXXExpiredAlarmLocked"></a>2.3 setXXXXExpiredAlarmLocked</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 延时处理闹钟设置！</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setDelayExpiredAlarmLocked</span><span class="params">(<span class="keyword">long</span> alarmTimeElapsedMillis, <span class="keyword">int</span> uid)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 校验时间，最小等于从开机到现在的时间！</span></span><br><span class="line">    alarmTimeElapsedMillis = maybeAdjustAlarmTime(alarmTimeElapsedMillis);</span><br><span class="line"></span><br><span class="line">    mNextDelayExpiredElapsedMillis = alarmTimeElapsedMillis;</span><br><span class="line">    updateAlarmWithListenerLocked(DELAY_TAG, mNextDelayExpiredListener,</span><br><span class="line">            mNextDelayExpiredElapsedMillis, uid);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 超时处理闹钟设置！</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setDeadlineExpiredAlarmLocked</span><span class="params">(<span class="keyword">long</span> alarmTimeElapsedMillis, <span class="keyword">int</span> uid)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 校验时间，最小等于从开机到现在的时间！</span></span><br><span class="line">    alarmTimeElapsedMillis = maybeAdjustAlarmTime(alarmTimeElapsedMillis);</span><br><span class="line">    mNextJobExpiredElapsedMillis = alarmTimeElapsedMillis;</span><br><span class="line"></span><br><span class="line">    updateAlarmWithListenerLocked(DEADLINE_TAG, mDeadlineExpiredListener,</span><br><span class="line">            mNextJobExpiredElapsedMillis, uid);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的代码很有意思：<br>首先返回一个正确的延迟或者超时处理时间点，然后根据这个时间点设置一个 alarm，时间点到了，会触发这个 alarm，linster  的回调会被执行！<br>我们继续看：</p>
<h3 id="2-3-1-maybeAdjustAlarmTime"><a href="#2-3-1-maybeAdjustAlarmTime" class="headerlink" title="2.3.1 maybeAdjustAlarmTime"></a>2.3.1 maybeAdjustAlarmTime</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">long</span> <span class="title">maybeAdjustAlarmTime</span><span class="params">(<span class="keyword">long</span> proposedAlarmTimeElapsedMillis)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// 获得从开机到现在的时间！</span></span><br><span class="line">     <span class="keyword">final</span> <span class="keyword">long</span> earliestWakeupTimeElapsed = SystemClock.elapsedRealtime();</span><br><span class="line">     </span><br><span class="line">     <span class="comment">// 取 job 的时间和开机时间的最大值！ </span></span><br><span class="line">     <span class="keyword">if</span> (proposedAlarmTimeElapsedMillis &lt; earliestWakeupTimeElapsed) &#123;</span><br><span class="line">         <span class="keyword">return</span> earliestWakeupTimeElapsed;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">return</span> proposedAlarmTimeElapsedMillis;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>这个方法是用来和开机时间比较的，返回一个最大值，确保时间正确性！</p>
<h3 id="2-3-2-updateAlarmWithListenerLocked"><a href="#2-3-2-updateAlarmWithListenerLocked" class="headerlink" title="2.3.2 updateAlarmWithListenerLocked"></a>2.3.2 updateAlarmWithListenerLocked</h3><p>这里是设置一个 alarm，在指定时间触发 alarm，执行 job，参数传递：</p>
<ul>
<li>String tag：表示 alarm 的 tag，可取值为 DELAY_TAG 或者 DEADLINE_TAG；</li>
<li>OnAlarmListener listener：OnAlarmListener 对象！</li>
<li>long alarmTimeElapsed：触发时间！</li>
<li>int uid： job 的 uid </li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateAlarmWithListenerLocked</span><span class="params">(String tag, OnAlarmListener listener,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">long</span> alarmTimeElapsed, <span class="keyword">int</span> uid)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获得 alarmService 代理对象！    </span></span><br><span class="line">    ensureAlarmServiceLocked();</span><br><span class="line">    <span class="keyword">if</span> (alarmTimeElapsed == Long.MAX_VALUE) &#123;</span><br><span class="line">        mAlarmService.cancel(listener);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">            Slog.d(TAG, <span class="string">"Setting "</span> + tag + <span class="string">" for: "</span> + alarmTimeElapsed);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// important point！</span></span><br><span class="line">        mAlarmService.set(AlarmManager.ELAPSED_REALTIME_WAKEUP, alarmTimeElapsed,</span><br><span class="line">                AlarmManager.WINDOW_HEURISTIC, <span class="number">0</span>, tag, listener, <span class="keyword">null</span>, <span class="keyword">new</span> WorkSource(uid));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里会在时间点 alarmTimeElapsed 到达时，触发 alarm，执行监听器 OnAlarmListener listener 的 onAlarm 方法：</p>
<h4 id="2-3-2-1-mNextDelayExpiredListener"><a href="#2-3-2-1-mNextDelayExpiredListener" class="headerlink" title="2.3.2.1 mNextDelayExpiredListener"></a>2.3.2.1 mNextDelayExpiredListener</h4><p>我们先来看看延迟处理的 Listener：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> OnAlarmListener mNextDelayExpiredListener = <span class="keyword">new</span> OnAlarmListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAlarm</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">            Slog.d(TAG, <span class="string">"Delay-expired alarm fired"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 时间点到后会触发 checkExpiredDelaysAndResetAlarm 方法！</span></span><br><span class="line">        checkExpiredDelaysAndResetAlarm();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<h5 id="2-3-2-1-1-checkExpiredDelaysAndResetAlarm"><a href="#2-3-2-1-1-checkExpiredDelaysAndResetAlarm" class="headerlink" title="2.3.2.1.1 checkExpiredDelaysAndResetAlarm"></a>2.3.2.1.1 checkExpiredDelaysAndResetAlarm</h5><p>这里调用了 checkExpiredDelaysAndResetAlarm 方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkExpiredDelaysAndResetAlarm</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 获得从开机到现在的时间</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> nowElapsedMillis = SystemClock.elapsedRealtime();</span><br><span class="line">        <span class="keyword">long</span> nextDelayTime = Long.MAX_VALUE;</span><br><span class="line">        <span class="keyword">int</span> nextDelayUid = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">boolean</span> ready = <span class="keyword">false</span>; <span class="comment">// 默认为 false，表示是否有 job 准备执行！</span></span><br><span class="line"></span><br><span class="line">        Iterator&lt;JobStatus&gt; it = mTrackedJobs.iterator(); <span class="comment">// 遍历 track 集合！</span></span><br><span class="line">        <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">            <span class="keyword">final</span> JobStatus job = it.next();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!job.hasTimingDelayConstraint()) &#123; </span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 获得每个 job 的延迟处理时间；</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> jobDelayTime = job.getEarliestRunTime();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (jobDelayTime &lt;= nowElapsedMillis) &#123; <span class="comment">// 说明延时触发时间点到了！</span></span><br><span class="line">               </span><br><span class="line">                <span class="comment">// 设置该 job 的对应 TimingDelay 二进制位为 1，表示满足条件！</span></span><br><span class="line">                job.setTimingDelayConstraintSatisfied(<span class="keyword">true</span>); </span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (canStopTrackingJobLocked(job)) &#123;</span><br><span class="line">                    it.remove();</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (job.isReady()) &#123; <span class="comment">// 如果 job 准备好了，就准备执行 job！</span></span><br><span class="line">                    ready = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!job.isConstraintSatisfied(JobStatus.CONSTRAINT_TIMING_DELAY)) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 这里是为了在剩余的，本次未触发的 job 里，找到延时触发时间最短的 job，并以它的延迟触发时间，</span></span><br><span class="line">                <span class="comment">// 作为下次 alarm 的触发时间点！</span></span><br><span class="line">                <span class="keyword">if</span> (nextDelayTime &gt; jobDelayTime) &#123;</span><br><span class="line">                    nextDelayTime = jobDelayTime;</span><br><span class="line">                    nextDelayUid = job.getSourceUid();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ready) &#123; <span class="comment">// 如果是 true，通知 jobScheduler！</span></span><br><span class="line">            mStateChangedListener.onControllerStateChanged();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 设置下一轮的 alarm!</span></span><br><span class="line">        setDelayExpiredAlarmLocked(nextDelayTime, nextDelayUid);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>当 lisener 的回调被执行时，这个时候，job 的延时处理时间会小于等于系统从开机到现在的时间，所以会进入第一个 if 分支！</p>
<p>对于本次没有触发，且没有被取消的 job，找到延时处理时间最短的 job，并以它的延迟触发时间，作为下次 alarm 的触发时间点！</p>
<p>这里调用了 <code>job.isReady()</code>，判断一个 job 是否准备好：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public boolean isReady() &#123;</span><br><span class="line"></span><br><span class="line">    // 判断 job 的 deadline 条件是否满足，只对非周期 job 才会有；</span><br><span class="line">    final boolean deadlineSatisfied = (!job.isPeriodic() &amp;&amp; hasDeadlineConstraint()</span><br><span class="line">            &amp;&amp; (satisfiedConstraints &amp; CONSTRAINT_DEADLINE) != 0);</span><br><span class="line">    </span><br><span class="line">    // 判断应用处于非空闲状态的条件是否满足！</span><br><span class="line">    final boolean notIdle = (satisfiedConstraints &amp; CONSTRAINT_APP_NOT_IDLE) != 0;</span><br><span class="line">    </span><br><span class="line">    // 判断处于非 dozing 模式的是否满足！</span><br><span class="line">    final boolean notDozing = (satisfiedConstraints &amp; CONSTRAINT_DEVICE_NOT_DOZING) != 0</span><br><span class="line">            || (job.getFlags() &amp; JobInfo.FLAG_WILL_BE_FOREGROUND) != 0;</span><br><span class="line">            </span><br><span class="line">    // 最后判断这个 job 是否 ready！</span><br><span class="line">    return (isConstraintsSatisfied() || deadlineSatisfied) &amp;&amp; notIdle &amp;&amp; notDozing;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到，一个 job 处于 ready 状态，需要同时满足如下的几个条件：</p>
<ul>
<li>job 的所有约束条件都满足，或者对于非周期 job，deadline 已经满足了！</li>
<li>job 设置的应用处于非空闲状态的条件满足；</li>
<li>job 设置的设备处于非doze的条件满足；</li>
</ul>
<h4 id="2-3-2-2-mDeadlineExpiredListener"><a href="#2-3-2-2-mDeadlineExpiredListener" class="headerlink" title="2.3.2.2 mDeadlineExpiredListener"></a>2.3.2.2 mDeadlineExpiredListener</h4><p>我们先来看看超时处理的 Listener：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> OnAlarmListener mDeadlineExpiredListener = <span class="keyword">new</span> OnAlarmListener() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAlarm</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">            Slog.d(TAG, <span class="string">"Deadline-expired alarm fired"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 时间点到后会触发 checkExpiredDeadlinesAndResetAlarm 方法！</span></span><br><span class="line">        checkExpiredDeadlinesAndResetAlarm();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>这里调用了 checkExpiredDeadlinesAndResetAlarm：</p>
<h5 id="2-3-2-2-1-checkExpiredDeadlinesAndResetAlarm"><a href="#2-3-2-2-1-checkExpiredDeadlinesAndResetAlarm" class="headerlink" title="2.3.2.2.1 checkExpiredDeadlinesAndResetAlarm"></a>2.3.2.2.1 checkExpiredDeadlinesAndResetAlarm</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkExpiredDeadlinesAndResetAlarm</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="keyword">long</span> nextExpiryTime = Long.MAX_VALUE;</span><br><span class="line">        <span class="keyword">int</span> nextExpiryUid = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> nowElapsedMillis = SystemClock.elapsedRealtime();</span><br><span class="line">        Iterator&lt;JobStatus&gt; it = mTrackedJobs.iterator();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (it.hasNext()) &#123; <span class="comment">// 遍历集合</span></span><br><span class="line">            JobStatus job = it.next();</span><br><span class="line">            <span class="keyword">if</span> (!job.hasDeadlineConstraint()) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> jobDeadline = job.getLatestRunTimeElapsed(); <span class="comment">// 获得每个 job 的超时触发时间点！</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (jobDeadline &lt;= nowElapsedMillis) &#123; <span class="comment">// 超时时间触发点到了！</span></span><br><span class="line">                <span class="keyword">if</span> (job.hasTimingDelayConstraint()) &#123; <span class="comment">// 如果 job 还有设置了延迟时间触发条件，将相应的 TimingDelay 二进制位为 1！</span></span><br><span class="line">                    job.setTimingDelayConstraintSatisfied(<span class="keyword">true</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                job.setDeadlineConstraintSatisfied(<span class="keyword">true</span>); <span class="comment">// 设置相应的 Deadline 二进制位为 1！</span></span><br><span class="line">                </span><br><span class="line">                mStateChangedListener.onRunJobNow(job); <span class="comment">// 立刻执行 Job！</span></span><br><span class="line">                </span><br><span class="line">                it.remove(); <span class="comment">// 移除，不再监控！</span></span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">                <span class="comment">// 找到下一个没有满足的 job ，以它的超时处理时间点作为下次 alarm 的触发点，退出循环！</span></span><br><span class="line">                nextExpiryTime = jobDeadline;</span><br><span class="line">                nextExpiryUid = job.getSourceUid();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置下一次的 alarm！</span></span><br><span class="line">        setDeadlineExpiredAlarmLocked(nextExpiryTime, nextExpiryUid);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后，调用了 JSS 的 onRunJobNow 方法，这里我们后面再看！</p>
<h1 id="3-IdleController"><a href="#3-IdleController" class="headerlink" title="3 IdleController"></a>3 IdleController</h1><p>我们来看看 IdleController 这个空闲状态控制器的构造器：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">IdleController</span><span class="params">(StateChangedListener stateChangedListener, Context context,</span></span></span><br><span class="line"><span class="function"><span class="params">            Object lock)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(stateChangedListener, context, lock);</span><br><span class="line">    initIdleStateTracking();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>调用了这个方法，initIdleStateTracking：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Idle state tracking, and messaging with the task manager when</span></span><br><span class="line"><span class="comment"> * significant state changes occur</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initIdleStateTracking</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 设备真正进入空闲的时间间隔：4260000 毫秒</span></span><br><span class="line">    mInactivityIdleThreshold = mContext.getResources().getInteger(</span><br><span class="line">            com.android.internal.R.integer.config_jobSchedulerInactivityIdleThreshold);</span><br><span class="line">    mIdleWindowSlop = mContext.getResources().getInteger(</span><br><span class="line">            com.android.internal.R.integer.config_jobSchedulerIdleWindowSlop);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建了一个设备空闲监控器，并启动监控！        </span></span><br><span class="line">    mIdleTracker = <span class="keyword">new</span> IdlenessTracker();</span><br><span class="line">    mIdleTracker.startTracking();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里创建了一个 IdlenessTracker。</p>
<h2 id="3-1-IdlenessTracker"><a href="#3-1-IdlenessTracker" class="headerlink" title="3.1 IdlenessTracker"></a>3.1 IdlenessTracker</h2><p>这个 Tracker 是一个广播接收者！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IdlenessTracker</span> <span class="keyword">extends</span> <span class="title">BroadcastReceiver</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> AlarmManager mAlarm;</span><br><span class="line">    <span class="keyword">private</span> PendingIntent mIdleTriggerIntent;</span><br><span class="line">    <span class="keyword">boolean</span> mIdle;</span><br><span class="line">    <span class="keyword">boolean</span> mScreenOn;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">IdlenessTracker</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 设置一个 alarm，用来发送 ActivityManagerService.ACTION_TRIGGER_IDLE 广播！</span></span><br><span class="line">        mAlarm = (AlarmManager) mContext.getSystemService(Context.ALARM_SERVICE);</span><br><span class="line"></span><br><span class="line">        Intent intent = <span class="keyword">new</span> Intent(ActivityManagerService.ACTION_TRIGGER_IDLE)</span><br><span class="line">                .setPackage(<span class="string">"android"</span>)</span><br><span class="line">                .setFlags(Intent.FLAG_RECEIVER_REGISTERED_ONLY);</span><br><span class="line">                </span><br><span class="line">        mIdleTriggerIntent = PendingIntent.getBroadcast(mContext, <span class="number">0</span>, intent, <span class="number">0</span>);</span><br><span class="line">        <span class="comment">// At boot we presume that the user has just "interacted" with the</span></span><br><span class="line">        <span class="comment">// device in some meaningful way.</span></span><br><span class="line">        mIdle = <span class="keyword">false</span>;</span><br><span class="line">        mScreenOn = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设备是否处于空闲的标志！</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isIdle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mIdle;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startTracking</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        IntentFilter filter = <span class="keyword">new</span> IntentFilter();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 监听屏幕的亮暗状态！</span></span><br><span class="line">        filter.addAction(Intent.ACTION_SCREEN_ON);</span><br><span class="line">        filter.addAction(Intent.ACTION_SCREEN_OFF);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 监听设备的睡眠状态</span></span><br><span class="line">        filter.addAction(Intent.ACTION_DREAMING_STARTED);</span><br><span class="line">        filter.addAction(Intent.ACTION_DREAMING_STOPPED);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 监听设备进入空闲状态</span></span><br><span class="line">        filter.addAction(ActivityManagerService.ACTION_TRIGGER_IDLE);</span><br><span class="line">        mContext.registerReceiver(<span class="keyword">this</span>, filter);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(Context context, Intent intent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> String action = intent.getAction();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 监听亮屏广播 或者 退出休眠的广播。</span></span><br><span class="line">        <span class="keyword">if</span> (action.equals(Intent.ACTION_SCREEN_ON) </span><br><span class="line">                || action.equals(Intent.ACTION_DREAMING_STOPPED)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                Slog.v(TAG,<span class="string">"exiting idle : "</span> + action);</span><br><span class="line">            &#125;</span><br><span class="line">            mScreenOn = <span class="keyword">true</span>; <span class="comment">// 表示亮屏</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">//cancel the alarm</span></span><br><span class="line">            mAlarm.cancel(mIdleTriggerIntent); <span class="comment">// 取消闹钟！</span></span><br><span class="line">            <span class="keyword">if</span> (mIdle) &#123;</span><br><span class="line">                mIdle = <span class="keyword">false</span>; <span class="comment">// 表示设备进入了非空闲！</span></span><br><span class="line">                reportNewIdleState(mIdle);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (action.equals(Intent.ACTION_SCREEN_OFF) <span class="comment">// 熄屏广播 和 进入休眠的广播。</span></span><br><span class="line">                || action.equals(Intent.ACTION_DREAMING_STARTED)) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 因为接到广播和设备真正处于空闲是有一定时间间隔的，所以这里设置了一个闹钟，</span></span><br><span class="line">            <span class="comment">// 用于在指定时间后发送广播：ActivityManagerService.ACTION_TRIGGER_IDLE</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> nowElapsed = SystemClock.elapsedRealtime();</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> when = nowElapsed + mInactivityIdleThreshold;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                Slog.v(TAG, <span class="string">"Scheduling idle : "</span> + action + <span class="string">" now:"</span> + nowElapsed + <span class="string">" when="</span></span><br><span class="line">                        + when);</span><br><span class="line">            &#125;</span><br><span class="line">            mScreenOn = <span class="keyword">false</span>; <span class="comment">// 表示灭屏！</span></span><br><span class="line">            mAlarm.setWindow(AlarmManager.ELAPSED_REALTIME_WAKEUP,</span><br><span class="line">                    when, mIdleWindowSlop, mIdleTriggerIntent);</span><br><span class="line"></span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (action.equals(ActivityManagerService.ACTION_TRIGGER_IDLE)) &#123; <span class="comment">// 表示设备真正进入了空闲！</span></span><br><span class="line">            <span class="comment">// idle time starts now. Do not set mIdle if screen is on.</span></span><br><span class="line">            <span class="keyword">if</span> (!mIdle &amp;&amp; !mScreenOn) &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                    Slog.v(TAG, <span class="string">"Idle trigger fired @ "</span> + SystemClock.elapsedRealtime());</span><br><span class="line">                &#125;</span><br><span class="line">                mIdle = <span class="keyword">true</span>; <span class="comment">// 表示设备进入了空闲状态</span></span><br><span class="line">                reportNewIdleState(mIdle);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>总结下：<br>收到亮屏广播或者退出休眠的广播，设备处于非空闲，取消 alarm，如果设备之前是空闲的，那就通知 jobScheduler！<br>收到熄屏广播或者进入出休眠的广播，设备可能进入空闲状态，设置 alarm，在一定时间后发送广播；接受这个广播，如果设备之前是非空闲的，那就通知 jobScheduler！</p>
<p>接下来，进入 reportNewIdleState 方法中来看看：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">reportNewIdleState</span><span class="params">(<span class="keyword">boolean</span> isIdle)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="keyword">for</span> (JobStatus task : mTrackedTasks) &#123;</span><br><span class="line">            <span class="comment">// 设置 job 的设备空闲状态条件！</span></span><br><span class="line">            task.setIdleConstraintSatisfied(isIdle);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 通知 JSS，设备的空闲状态发生了变化！</span></span><br><span class="line">    mStateChangedListener.onControllerStateChanged();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个方法很简单，修改自己所监控的 Job 的 JobStatus 的 Idle 二进制位，并通知 JobSchedulerService ，JobSchdulerService 会根据这个状态来动态控制 jobServcie！</p>
<p>IdleController 的 StartTrackingJob 和 StopTrackingJob 都很简单，请看下面：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * StateController interface</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">maybeStartTrackingJobLocked</span><span class="params">(JobStatus taskStatus, JobStatus lastJob)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (taskStatus.hasIdleConstraint()) &#123; <span class="comment">// 判断 job 是否设置空闲约束！</span></span><br><span class="line">        mTrackedTasks.add(taskStatus);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 监控之前，进行 job 的设备状态初始化！</span></span><br><span class="line">        taskStatus.setIdleConstraintSatisfied(mIdleTracker.isIdle()); </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">maybeStopTrackingJobLocked</span><span class="params">(JobStatus taskStatus, JobStatus incomingJob, <span class="keyword">boolean</span> forUpdate)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    mTrackedTasks.remove(taskStatus);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>不多说了！</p>
<h1 id="4-BatteryController"><a href="#4-BatteryController" class="headerlink" title="4 BatteryController"></a>4 BatteryController</h1><p>我们来看看电量控制器：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">BatteryController</span><span class="params">(StateChangedListener stateChangedListener, Context context,</span></span></span><br><span class="line"><span class="function"><span class="params">        Object lock)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(stateChangedListener, context, lock);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这里创建了一个充电监视器</span></span><br><span class="line">    mChargeTracker = <span class="keyword">new</span> ChargingTracker();</span><br><span class="line">    mChargeTracker.startTracking();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="4-1-ChargingTracker"><a href="#4-1-ChargingTracker" class="headerlink" title="4.1 ChargingTracker"></a>4.1 ChargingTracker</h2><p>我们去看看：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChargingTracker</span> <span class="keyword">extends</span> <span class="title">BroadcastReceiver</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Track whether we're "charging", where charging means that we're ready to commit to</span></span><br><span class="line"><span class="comment">     * doing work.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mCharging;</span><br><span class="line">    <span class="comment">/** Keep track of whether the battery is charged enough that we want to do work. */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mBatteryHealthy;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ChargingTracker</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startTracking</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        IntentFilter filter = <span class="keyword">new</span> IntentFilter();</span><br><span class="line">        <span class="comment">// Battery health.</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 监听电量</span></span><br><span class="line">        filter.addAction(Intent.ACTION_BATTERY_LOW);</span><br><span class="line">        filter.addAction(Intent.ACTION_BATTERY_OKAY);</span><br><span class="line">        <span class="comment">// Charging/not charging.</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 监听充电的广播</span></span><br><span class="line">        filter.addAction(BatteryManager.ACTION_CHARGING);</span><br><span class="line">        filter.addAction(BatteryManager.ACTION_DISCHARGING);</span><br><span class="line">        mContext.registerReceiver(<span class="keyword">this</span>, filter);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Initialise tracker state.</span></span><br><span class="line">        BatteryManagerInternal batteryManagerInternal =</span><br><span class="line">                LocalServices.getService(BatteryManagerInternal.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 初始化电量的状态</span></span><br><span class="line">        mBatteryHealthy = !batteryManagerInternal.getBatteryLevelLow();</span><br><span class="line">        mCharging = batteryManagerInternal.isPowered(BatteryManager.BATTERY_PLUGGED_ANY);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断当前的电池环境是否稳定</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isOnStablePower</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mCharging &amp;&amp; mBatteryHealthy;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(Context context, Intent intent)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 处理广播！</span></span><br><span class="line">        onReceiveInternal(intent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@VisibleForTesting</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceiveInternal</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> String action = intent.getAction();</span><br><span class="line">        <span class="keyword">if</span> (Intent.ACTION_BATTERY_LOW.equals(action)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                Slog.d(TAG, <span class="string">"Battery life too low to do work. @ "</span></span><br><span class="line">                        + SystemClock.elapsedRealtime());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// If we get this action, the battery is discharging =&gt; it isn't plugged in so</span></span><br><span class="line">            <span class="comment">// there's no work to cancel. We track this variable for the case where it is</span></span><br><span class="line">            <span class="comment">// charging, but hasn't been for long enough to be healthy.</span></span><br><span class="line">            <span class="comment">// 电量太低，mBatteryHealthy 置为 false！</span></span><br><span class="line">            mBatteryHealthy = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Intent.ACTION_BATTERY_OKAY.equals(action)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                Slog.d(TAG, <span class="string">"Battery life healthy enough to do work. @ "</span></span><br><span class="line">                        + SystemClock.elapsedRealtime());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 电量充足，mBatteryHealthy 置为 true，通知 job 状态需要改变！</span></span><br><span class="line">            mBatteryHealthy = <span class="keyword">true</span>;</span><br><span class="line">            maybeReportNewChargingState();</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (BatteryManager.ACTION_CHARGING.equals(action)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                Slog.d(TAG, <span class="string">"Received charging intent, fired @ "</span></span><br><span class="line">                        + SystemClock.elapsedRealtime());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 正在充电，mCharging 置为 true，通知 job 状态需要改变！</span></span><br><span class="line">            mCharging = <span class="keyword">true</span>;</span><br><span class="line">            maybeReportNewChargingState();</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (BatteryManager.ACTION_DISCHARGING.equals(action)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                Slog.d(TAG, <span class="string">"Disconnected from power."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 充电断开，mCharging 置为 false，通知 job 状态需要改变！</span></span><br><span class="line">            mCharging = <span class="keyword">false</span>;</span><br><span class="line">            maybeReportNewChargingState();</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="4-1-1-maybeReportNewChargingState"><a href="#4-1-1-maybeReportNewChargingState" class="headerlink" title="4.1.1 maybeReportNewChargingState"></a>4.1.1 maybeReportNewChargingState</h3><p>最后调用了 maybeReportNewChargingState 方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">maybeReportNewChargingState</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获得本次电池的状态</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> stablePower = mChargeTracker.isOnStablePower();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">        Slog.d(TAG, <span class="string">"maybeReportNewChargingState: "</span> + stablePower);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> reportChange = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="keyword">for</span> (JobStatus ts : mTrackedTasks) &#123;</span><br><span class="line">            <span class="comment">// 对于这个 controller 监视的所有 JobStatus，判断这次是否满足约束条件！</span></span><br><span class="line">            <span class="keyword">boolean</span> previous = ts.setChargingConstraintSatisfied(stablePower);</span><br><span class="line">            <span class="keyword">if</span> (previous != stablePower) &#123;</span><br><span class="line">                <span class="comment">// 这里一次和上一次不一样，需要通知 JobSchedulerService，发生变化</span></span><br><span class="line">                reportChange = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Let the scheduler know that state has changed. This may or may not result in an</span></span><br><span class="line">    <span class="comment">// execution.</span></span><br><span class="line">    <span class="keyword">if</span> (reportChange) &#123; <span class="comment">// 通知 jobScheduler，发生变化</span></span><br><span class="line">        mStateChangedListener.onControllerStateChanged();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Also tell the scheduler that any ready jobs should be flushed.</span></span><br><span class="line">    <span class="keyword">if</span> (stablePower) &#123; <span class="comment">// 通知 jobScheduler，如果电池状态满足，执行任务</span></span><br><span class="line">        mStateChangedListener.onRunJobNow(<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里很简单，就不说了！</p>
<h1 id="5-AppIdleController"><a href="#5-AppIdleController" class="headerlink" title="5 AppIdleController"></a>5 AppIdleController</h1><p>这个控制器的主要作用是，判断 app 是否是闲置的，如果是闲置的，那么他的 job 将会被执行，如何判断闲置呢？没有被启动，或者数小时或者数天之前在启动过！<br>我们先来看看 AppIdleController 的构造器：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">AppIdleController</span><span class="params">(JobSchedulerService service, Context context, Object lock)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(service, context, lock);</span><br><span class="line">    mJobSchedulerService = service;</span><br><span class="line">    mUsageStatsInternal = LocalServices.getService(UsageStatsManagerInternal.class);</span><br><span class="line">    mAppIdleParoleOn = <span class="keyword">true</span>;</span><br><span class="line">    <span class="comment">// 将 AppIdleStateChangeListener 注册进入 UsageStatsManagerInternal 服务中</span></span><br><span class="line">    mUsageStatsInternal.addAppIdleStateChangeListener(<span class="keyword">new</span> AppIdleStateChangeListener());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们继续看：</p>
<h2 id="5-1-AppIdleStateChangeListener"><a href="#5-1-AppIdleStateChangeListener" class="headerlink" title="5.1 AppIdleStateChangeListener"></a>5.1 AppIdleStateChangeListener</h2><p>这里有一个监听器： AppIdleStateChangeListener：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">AppIdleStateChangeListener</span></span></span><br><span class="line"><span class="class">        <span class="keyword">extends</span> <span class="title">UsageStatsManagerInternal</span>.<span class="title">AppIdleStateChangeListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAppIdleStateChanged</span><span class="params">(String packageName, <span class="keyword">int</span> userId, <span class="keyword">boolean</span> idle)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> changed = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mAppIdleParoleOn) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 创建 PackageUpdateFunc，对 userId 下的包名为 pacakgeName 的应用的所有 job，进行状态检查和更新</span></span><br><span class="line">            PackageUpdateFunc update = <span class="keyword">new</span> PackageUpdateFunc(userId, packageName, idle);</span><br><span class="line">            mJobSchedulerService.getJobStore().forEachJob(update);</span><br><span class="line">            <span class="keyword">if</span> (update.mChanged) &#123;</span><br><span class="line">                changed = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (changed) &#123; <span class="comment">// 通知 jobScheduler，发生变化</span></span><br><span class="line">            mStateChangedListener.onControllerStateChanged();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onParoleStateChanged</span><span class="params">(<span class="keyword">boolean</span> isParoleOn)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">            Slog.d(LOG_TAG, <span class="string">"Parole on: "</span> + isParoleOn);</span><br><span class="line">        &#125;</span><br><span class="line">        setAppIdleParoleOn(isParoleOn);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里的监听器本质上只是一个回调接口，具体的 controll 策略是在 UsageStatsManagerInternal 服务中，这里不多讲（因为特么我还没看）</p>
<h3 id="5-1-1-PackageUpdateFunc"><a href="#5-1-1-PackageUpdateFunc" class="headerlink" title="5.1.1 PackageUpdateFunc"></a>5.1.1 PackageUpdateFunc</h3><p>首先来看看这个函数类：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">PackageUpdateFunc</span> <span class="keyword">implements</span> <span class="title">JobStore</span>.<span class="title">JobStatusFunctor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> mUserId;</span><br><span class="line">    <span class="keyword">final</span> String mPackage;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> mIdle;</span><br><span class="line">    <span class="keyword">boolean</span> mChanged; <span class="comment">// 用来保存 app 状态是否发生变化</span></span><br><span class="line">    </span><br><span class="line">    PackageUpdateFunc(<span class="keyword">int</span> userId, String pkg, <span class="keyword">boolean</span> idle) &#123;</span><br><span class="line">        mUserId = userId;</span><br><span class="line">        mPackage = pkg;</span><br><span class="line">        mIdle = idle;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(JobStatus jobStatus)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (jobStatus.getSourcePackageName().equals(mPackage) <span class="comment">// 判断当前的 job 是否属于这个应用程序</span></span><br><span class="line">                &amp;&amp; jobStatus.getSourceUserId() == mUserId) &#123;</span><br><span class="line">            <span class="keyword">if</span> (jobStatus.setAppNotIdleConstraintSatisfied(!mIdle)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                    Slog.d(LOG_TAG, <span class="string">"App Idle state changed, setting idle state of "</span></span><br><span class="line">                            + mPackage + <span class="string">" to "</span> + mIdle);</span><br><span class="line">                &#125;</span><br><span class="line">                mChanged = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>PackageUpdateFunc 会遍历 JobStore，查找指定 app 的 Job，改变 job 的属性值！</p>
<h3 id="5-1-2-setAppIdleParoleOn"><a href="#5-1-2-setAppIdleParoleOn" class="headerlink" title="5.1.2 setAppIdleParoleOn"></a>5.1.2 setAppIdleParoleOn</h3><p>这个方法的作用是（特么我没看懂，这里的解释空下）<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setAppIdleParoleOn</span><span class="params">(<span class="keyword">boolean</span> isAppIdleParoleOn)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Flag if any app's idle state has changed</span></span><br><span class="line">    <span class="keyword">boolean</span> changed = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mAppIdleParoleOn == isAppIdleParoleOn) &#123; <span class="comment">// 如果状态没有变化，不处理！</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        mAppIdleParoleOn = isAppIdleParoleOn;</span><br><span class="line">        <span class="comment">// 创建 GlobalUpdateFunc 来更新 Job 状态！</span></span><br><span class="line">        GlobalUpdateFunc update = <span class="keyword">new</span> GlobalUpdateFunc();</span><br><span class="line">        mJobSchedulerService.getJobStore().forEachJob(update);</span><br><span class="line">        <span class="keyword">if</span> (update.mChanged) &#123;</span><br><span class="line">            changed = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (changed) &#123;</span><br><span class="line">        mStateChangedListener.onControllerStateChanged();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们再去看看  GlobalUpdateFunc：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">GlobalUpdateFunc</span> <span class="keyword">implements</span> <span class="title">JobStore</span>.<span class="title">JobStatusFunctor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> mChanged;</span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(JobStatus jobStatus)</span> </span>&#123;</span><br><span class="line">        String packageName = jobStatus.getSourcePackageName();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> appIdle = !mAppIdleParoleOn &amp;&amp; mUsageStatsInternal.isAppIdle(packageName,</span><br><span class="line">                jobStatus.getSourceUid(), jobStatus.getSourceUserId());</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">            Slog.d(LOG_TAG, <span class="string">"Setting idle state of "</span> + packageName + <span class="string">" to "</span> + appIdle);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 改变 job 状态！如果改变成功了，该方法返回的是 true！</span></span><br><span class="line">        <span class="keyword">if</span> (jobStatus.setAppNotIdleConstraintSatisfied(!appIdle)) &#123; </span><br><span class="line">            mChanged = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>如果，有 job 的状态发生了变化，那么 GlobalUpdateFunc 的 mChanged 的值为 true，然后通知 JobScheduler 即可！</p>
<h1 id="6-ContentObserverController"><a href="#6-ContentObserverController" class="headerlink" title="6 ContentObserverController"></a>6 ContentObserverController</h1><p>通过监听数据库的变化来 controll job：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">private ContentObserverController(StateChangedListener stateChangedListener, Context context,</span><br><span class="line">            Object lock) &#123;</span><br><span class="line">    super(stateChangedListener, context, lock);</span><br><span class="line">    mHandler = new Handler(context.getMainLooper());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到 ，构造器很简单，那真正的 controll 在哪里呢，首先我们来一个内部变量：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">final private List&lt;JobStatus&gt; mTrackedTasks = new ArrayList&lt;JobStatus&gt;();</span><br><span class="line">/**</span><br><span class="line"> * Per-userid &#123;@link JobInfo.TriggerContentUri&#125; keyed ContentObserver cache.</span><br><span class="line"> */</span><br><span class="line">SparseArray&lt;ArrayMap&lt;JobInfo.TriggerContentUri, ObserverInstance&gt;&gt; mObservers = new SparseArray&lt;&gt;();</span><br></pre></td></tr></table></figure></p>
<p>mTrackedTasks：表示这个 controller 监视的所有的 job：<br>mObservers：key 值为 userId，表示的是设备用户，value 值为 ArrayMap&lt;JobInfo.TriggerContentUri, ObserverInstance&gt;，数据库uri和它的观察者！</p>
<p>还记得，在 JobScheduler 中我们开始  track 每一个 job 吗？我们去这个方法里面去看看：</p>
<h2 id="6-1-maybeStartTrackingJobLocked"><a href="#6-1-maybeStartTrackingJobLocked" class="headerlink" title="6.1 maybeStartTrackingJobLocked"></a>6.1 maybeStartTrackingJobLocked</h2><p>参数传递：</p>
<ul>
<li>JobStatus taskStatus：即将要执行的 job</li>
<li>JobStatus lastJob：被取代的旧的 job<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">maybeStartTrackingJobLocked</span><span class="params">(JobStatus taskStatus, JobStatus lastJob)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 判断新的 job  hasContentTriggerConstraint 是否为 true！</span></span><br><span class="line">    <span class="keyword">if</span> (taskStatus.hasContentTriggerConstraint()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (taskStatus.contentObserverJobInstance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 给 jobStatus 创建一个 JobInstance 对象！</span></span><br><span class="line">            taskStatus.contentObserverJobInstance = <span class="keyword">new</span> JobInstance(taskStatus);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">            Slog.i(TAG, <span class="string">"Tracking content-trigger job "</span> + taskStatus);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 添加到追踪列表中！</span></span><br><span class="line">        mTrackedTasks.add(taskStatus);</span><br><span class="line">        <span class="keyword">boolean</span> havePendingUris = <span class="keyword">false</span>;</span><br><span class="line">        <span class="comment">// If there is a previous job associated with the new job, propagate over</span></span><br><span class="line">        <span class="comment">// any pending content URI trigger reports.</span></span><br><span class="line">        <span class="keyword">if</span> (taskStatus.contentObserverJobInstance.mChangedAuthorities != <span class="keyword">null</span>) &#123;</span><br><span class="line">            havePendingUris = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// If we have previously reported changed authorities/uris, then we failed</span></span><br><span class="line">        <span class="comment">// to complete the job with them so will re-record them to report again.</span></span><br><span class="line">        <span class="comment">// 对于有些 job ，我们之前有监视过其依赖的数据库的变化；但是，我们并没有完成这个 job，</span></span><br><span class="line">        <span class="comment">// 如果这个 job 被 reschedule，那么之前的 uris/authorities 仍然要被监控！</span></span><br><span class="line">        <span class="keyword">if</span> (taskStatus.changedAuthorities != <span class="keyword">null</span>) &#123;</span><br><span class="line">            havePendingUris = <span class="keyword">true</span>; <span class="comment">// 用户标记是否有正在处理的 uris</span></span><br><span class="line">            <span class="keyword">if</span> (taskStatus.contentObserverJobInstance.mChangedAuthorities == <span class="keyword">null</span>) &#123;</span><br><span class="line">                taskStatus.contentObserverJobInstance.mChangedAuthorities</span><br><span class="line">                        = <span class="keyword">new</span> ArraySet&lt;&gt;();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (String auth : taskStatus.changedAuthorities) &#123;</span><br><span class="line">                taskStatus.contentObserverJobInstance.mChangedAuthorities.add(auth);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (taskStatus.changedUris != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (taskStatus.contentObserverJobInstance.mChangedUris == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    taskStatus.contentObserverJobInstance.mChangedUris = <span class="keyword">new</span> ArraySet&lt;&gt;();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">for</span> (Uri uri : taskStatus.changedUris) &#123;</span><br><span class="line">                    taskStatus.contentObserverJobInstance.mChangedUris.add(uri);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            taskStatus.changedAuthorities = <span class="keyword">null</span>;</span><br><span class="line">            taskStatus.changedUris = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        taskStatus.changedAuthorities = <span class="keyword">null</span>;</span><br><span class="line">        taskStatus.changedUris = <span class="keyword">null</span>;</span><br><span class="line">        taskStatus.setContentTriggerConstraintSatisfied(havePendingUris);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果当前的这个 job 有相同 jobId 的被取消的上一次 job !</span></span><br><span class="line">    <span class="keyword">if</span> (lastJob != <span class="keyword">null</span> &amp;&amp; lastJob.contentObserverJobInstance != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// And now we can detach the instance state from the last job.</span></span><br><span class="line">        lastJob.contentObserverJobInstance.detachLocked();</span><br><span class="line">        lastJob.contentObserverJobInstance = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>对于有被替代的相同uid和jobId的旧的 job，会调用 jobInstance 的 detachLocked 方法来做一些释放资源的操作，这个我们在后面来看！</p>
<p>可以看到，每一个 JobStatus 都会有一个 ContentObserverController.JobInstance 类型的对象：</p>
<h3 id="6-1-1-JobInstance"><a href="#6-1-1-JobInstance" class="headerlink" title="6.1.1 JobInstance"></a>6.1.1 JobInstance</h3><p>参数传递：</p>
<ul>
<li>JobStatus jobStatus<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">JobInstance</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ArrayList&lt;ObserverInstance&gt; mMyObservers = <span class="keyword">new</span> ArrayList&lt;&gt;(); <span class="comment">// 这个 job 所拥有的观察者实例集合</span></span><br><span class="line">    <span class="keyword">final</span> JobStatus mJobStatus; <span class="comment">// 所属的 jobStatus</span></span><br><span class="line">    <span class="keyword">final</span> Runnable mExecuteRunner;</span><br><span class="line">    <span class="keyword">final</span> Runnable mTimeoutRunner;</span><br><span class="line">    <span class="comment">// 表示哪些数据库发生了变化，最大等于 build 时传入的 uris 个数！</span></span><br><span class="line">    ArraySet&lt;Uri&gt; mChangedUris;</span><br><span class="line">    ArraySet&lt;String&gt; mChangedAuthorities;</span><br><span class="line">    <span class="keyword">boolean</span> mTriggerPending;</span><br><span class="line">    <span class="comment">// This constructor must be called with the master job scheduler lock held.</span></span><br><span class="line">    JobInstance(JobStatus jobStatus) &#123;</span><br><span class="line">        mJobStatus = jobStatus;</span><br><span class="line">        mExecuteRunner = <span class="keyword">new</span> TriggerRunnable(<span class="keyword">this</span>);</span><br><span class="line">        mTimeoutRunner = <span class="keyword">new</span> TriggerRunnable(<span class="keyword">this</span>);</span><br><span class="line">        <span class="comment">// 获得这个 job 所依赖的所有的数据库 uri，在 JobInfo.mTriggerContentUris 中！</span></span><br><span class="line">        <span class="comment">// 以及这个 job 所属的 userId！</span></span><br><span class="line">        <span class="keyword">final</span> JobInfo.TriggerContentUri[] uris = jobStatus.getJob().getTriggerContentUris();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> sourceUserId = jobStatus.getSourceUserId();</span><br><span class="line">         </span><br><span class="line">        <span class="comment">// 创建 useId 下的观察者缓存，用来提高查询效率！</span></span><br><span class="line">        ArrayMap&lt;JobInfo.TriggerContentUri, ObserverInstance&gt; observersOfUser =</span><br><span class="line">                mObservers.get(sourceUserId);</span><br><span class="line">        <span class="keyword">if</span> (observersOfUser == <span class="keyword">null</span>) &#123;</span><br><span class="line">            observersOfUser = <span class="keyword">new</span> ArrayMap&lt;&gt;();</span><br><span class="line">            mObservers.put(sourceUserId, observersOfUser);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (uris != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (JobInfo.TriggerContentUri uri : uris) &#123;</span><br><span class="line">                ObserverInstance obs = observersOfUser.get(uri);</span><br><span class="line">                <span class="keyword">if</span> (obs == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// 为每一个 uri 都创建一个观察者实例！</span></span><br><span class="line">                    obs = <span class="keyword">new</span> ObserverInstance(mHandler, uri, jobStatus.getSourceUserId());</span><br><span class="line">                    <span class="comment">// 添加到 ContentObserverController 的缓存集合里</span></span><br><span class="line">                    observersOfUser.put(uri, obs);</span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">boolean</span> andDescendants = (uri.getFlags() &amp;</span><br><span class="line">                            JobInfo.TriggerContentUri.FLAG_NOTIFY_FOR_DESCENDANTS) != <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                        Slog.v(TAG, <span class="string">"New observer "</span> + obs + <span class="string">" for "</span> + uri.getUri()</span><br><span class="line">                                + <span class="string">" andDescendants="</span> + andDescendants</span><br><span class="line">                                + <span class="string">" sourceUserId="</span> + sourceUserId);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 注册这个内容观察者，当内容发生变化后，会触发回调！</span></span><br><span class="line">                    mContext.getContentResolver().registerContentObserver(</span><br><span class="line">                            uri.getUri(),</span><br><span class="line">                            andDescendants,</span><br><span class="line">                            obs,</span><br><span class="line">                            sourceUserId</span><br><span class="line">                    );</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                        <span class="keyword">final</span> <span class="keyword">boolean</span> andDescendants = (uri.getFlags() &amp;</span><br><span class="line">                                JobInfo.TriggerContentUri.FLAG_NOTIFY_FOR_DESCENDANTS) != <span class="number">0</span>;</span><br><span class="line">                        Slog.v(TAG, <span class="string">"Reusing existing observer "</span> + obs + <span class="string">" for "</span> + uri.getUri()</span><br><span class="line">                                + <span class="string">" andDescendants="</span> + andDescendants);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 将这个 JobInstance 添加到这个 ContextObsercer 中！</span></span><br><span class="line">                obs.mJobs.add(<span class="keyword">this</span>);</span><br><span class="line">                <span class="comment">// 添加到 jobInstance 的 mMyObservers 中！</span></span><br><span class="line">                mMyObservers.add(obs);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ... ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>这里创建了一个 ObserverInstance 对象，用来监听数据库的变动，当 uri 所指向的数据库发生变化后，他会通知所有的和他关联的 job Instance：</p>
<h3 id="6-1-2-ObserverInstance"><a href="#6-1-2-ObserverInstance" class="headerlink" title="6.1.2 ObserverInstance"></a>6.1.2 ObserverInstance</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ObserverInstance</span> <span class="keyword">extends</span> <span class="title">ContentObserver</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> JobInfo.TriggerContentUri mUri;</span><br><span class="line">    <span class="keyword">final</span> <span class="meta">@UserIdInt</span> <span class="keyword">int</span> mUserId;</span><br><span class="line">    <span class="comment">// 表示的是这个数据库关联的所有的 job 实例！</span></span><br><span class="line">    <span class="keyword">final</span> ArraySet&lt;JobInstance&gt; mJobs = <span class="keyword">new</span> ArraySet&lt;&gt;();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ObserverInstance</span><span class="params">(Handler handler, JobInfo.TriggerContentUri uri,</span></span></span><br><span class="line"><span class="function"><span class="params">            @UserIdInt <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(handler);</span><br><span class="line">        mUri = uri;</span><br><span class="line">        mUserId = userId;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onChange</span><span class="params">(<span class="keyword">boolean</span> selfChange, Uri uri)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">            Slog.i(TAG,<span class="string">"onChange(self="</span> + selfChange + <span class="string">") for "</span>  + uri</span><br><span class="line">                    + <span class="string">" when mUri="</span> + mUri + <span class="string">" mUserId="</span> + mUserId);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> N = mJobs.size();</span><br><span class="line">            <span class="comment">// 当 uri 所指向的数据库发生变化后，他会通知所有的和他关联的 job Instance！</span></span><br><span class="line">            <span class="comment">// 将改变的数据库的 uri 和 authority 保存到对应的 JobInstance 中！</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">                JobInstance inst = mJobs.valueAt(i);</span><br><span class="line">                <span class="keyword">if</span> (inst.mChangedUris == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    inst.mChangedUris = <span class="keyword">new</span> ArraySet&lt;&gt;();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (inst.mChangedUris.size() &lt; MAX_URIS_REPORTED) &#123;</span><br><span class="line">                    inst.mChangedUris.add(uri);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (inst.mChangedAuthorities == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    inst.mChangedAuthorities = <span class="keyword">new</span> ArraySet&lt;&gt;();</span><br><span class="line">                &#125;</span><br><span class="line">                inst.mChangedAuthorities.add(uri.getAuthority());</span><br><span class="line">                <span class="comment">// 调用 JobStance 的 scheduleLocked 方法！</span></span><br><span class="line">                inst.scheduleLocked();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来，进入到 JobInstance 中，当观察者发现数据库改变了，他最终会调用相关联的所有的 JobInstance 的 scheduleLocked 方法：</p>
<h4 id="6-1-2-1-JI-scheduleLocked"><a href="#6-1-2-1-JI-scheduleLocked" class="headerlink" title="6.1.2.1 JI.scheduleLocked"></a>6.1.2.1 JI.scheduleLocked</h4><p>开始执行触发任务：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">scheduleLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!mTriggerPending) &#123;</span><br><span class="line">        mTriggerPending = <span class="keyword">true</span>;</span><br><span class="line">        mHandler.postDelayed(mTimeoutRunner, mJobStatus.getTriggerContentMaxDelay());</span><br><span class="line">    &#125;</span><br><span class="line">    mHandler.removeCallbacks(mExecuteRunner);</span><br><span class="line">    <span class="comment">// URIS_URGENT_THRESHOLD 表示一个 job 最大可以依赖的数据库个数！</span></span><br><span class="line">    <span class="keyword">if</span> (mChangedUris.size() &gt;= URIS_URGENT_THRESHOLD) &#123;</span><br><span class="line">        <span class="comment">// If we start getting near the limit, GO NOW!</span></span><br><span class="line">        mHandler.post(mExecuteRunner);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mHandler.postDelayed(mExecuteRunner, mJobStatus.getTriggerContentUpdateDelay());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>mTriggerPending 默认为 fasle。用来标记：Job 触发是否正在进行！<br>可以看出：<br>第一次数据库改变，执行触发时，会延迟处理，延迟时间是：JobStatus.getTriggerContentMaxDelay()；<br>如果在第一次触发还未结束，又进行了多次触发，延时处理，延时时间是：JobStatus.getTriggerContentUpdateDelay()；<br>如果这个 job 依赖的数据库 uri 的个数到达的最大限制，就立刻触发，优先处理资源紧缺的 job 触发！</p>
<p>这里会在主线程执行 mTimeoutRunner 和  mExecuteRunner，mExecuteRunner  是 TriggerRunnable 对象：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TriggerRunnable</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> JobInstance mInstance;</span><br><span class="line">    TriggerRunnable(JobInstance instance) &#123;</span><br><span class="line">        mInstance = instance;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 执行 JobInstance 的 trigger 方法！</span></span><br><span class="line">        mInstance.trigger();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们进入到 trigger 方法中，去看看：</p>
<h4 id="6-1-2-2-JI-trigger"><a href="#6-1-2-2-JI-trigger" class="headerlink" title="6.1.2.2 JI.trigger"></a>6.1.2.2 JI.trigger</h4><p>这个方法就是最终的通知改变的方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">trigger</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> reportChange = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mTriggerPending) &#123;</span><br><span class="line">            <span class="comment">// 判断是否需要改变 job 状态</span></span><br><span class="line">            <span class="keyword">if</span> (mJobStatus.setContentTriggerConstraintSatisfied(<span class="keyword">true</span>)) &#123;</span><br><span class="line">                reportChange = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            unscheduleLocked(); <span class="comment">// 结束本次执行操作！</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Let the scheduler know that state has changed. This may or may not result in an</span></span><br><span class="line">    <span class="comment">// execution.</span></span><br><span class="line">    <span class="keyword">if</span> (reportChange) &#123; <span class="comment">// 当 reportChange 为 true 后，就通知 JobScheduler！</span></span><br><span class="line">        mStateChangedListener.onControllerStateChanged();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>再来看看 unscheduleLocked 方法，本次执行结束，取消任务，标记位置 mTriggerPending 置为 false！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">unscheduleLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mTriggerPending) &#123;</span><br><span class="line">        mHandler.removeCallbacks(mExecuteRunner);</span><br><span class="line">        mHandler.removeCallbacks(mTimeoutRunner);</span><br><span class="line">        mTriggerPending = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里逻辑已经很清楚了，就不多说了！</p>
<h2 id="6-2-maybeStopTrackingJobLocked"><a href="#6-2-maybeStopTrackingJobLocked" class="headerlink" title="6.2 maybeStopTrackingJobLocked"></a>6.2 maybeStopTrackingJobLocked</h2><p>接下来，我们来看看停止监视相关的代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">maybeStopTrackingJobLocked</span><span class="params">(JobStatus taskStatus, JobStatus incomingJob,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> forUpdate)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (taskStatus.hasContentTriggerConstraint()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (taskStatus.contentObserverJobInstance != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 停止相应的 jobInstance 的执行</span></span><br><span class="line">            taskStatus.contentObserverJobInstance.unscheduleLocked();</span><br><span class="line">            <span class="keyword">if</span> (incomingJob != <span class="keyword">null</span>) &#123; <span class="comment">// 如果是有相同 userId 和 jobId 的新 job。即 incomingJob 不为 null！</span></span><br><span class="line">                <span class="keyword">if</span> (taskStatus.contentObserverJobInstance != <span class="keyword">null</span></span><br><span class="line">                        &amp;&amp; taskStatus.contentObserverJobInstance.mChangedAuthorities != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// We are stopping this job, but it is going to be replaced by this given</span></span><br><span class="line">                    <span class="comment">// incoming job.  We want to propagate our state over to it, so we don't</span></span><br><span class="line">                    <span class="comment">// lose any content changes that had happend since the last one started.</span></span><br><span class="line">                    <span class="comment">// If there is a previous job associated with the new job, propagate over</span></span><br><span class="line">                    <span class="comment">// any pending content URI trigger reports.</span></span><br><span class="line">                    <span class="keyword">if</span> (incomingJob.contentObserverJobInstance == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="comment">// 给新 job 创建对应的 jobInstance</span></span><br><span class="line">                        incomingJob.contentObserverJobInstance = <span class="keyword">new</span> JobInstance(incomingJob);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 用旧的 jobInstance 来初始化新的 JobInstance 的 uris/authorities</span></span><br><span class="line">                    incomingJob.contentObserverJobInstance.mChangedAuthorities</span><br><span class="line">                            = taskStatus.contentObserverJobInstance.mChangedAuthorities;</span><br><span class="line">                    incomingJob.contentObserverJobInstance.mChangedUris</span><br><span class="line">                            = taskStatus.contentObserverJobInstance.mChangedUris;</span><br><span class="line">                    <span class="comment">// 清空旧得 jobInstance 的 uris/authorities</span></span><br><span class="line">                    taskStatus.contentObserverJobInstance.mChangedAuthorities = <span class="keyword">null</span>;</span><br><span class="line">                    taskStatus.contentObserverJobInstance.mChangedUris = <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// We won't detach the content observers here, because we want to</span></span><br><span class="line">                <span class="comment">// allow them to continue monitoring so we don't miss anything...  and</span></span><br><span class="line">                <span class="comment">// since we are giving an incomingJob here, we know this will be</span></span><br><span class="line">                <span class="comment">// immediately followed by a start tracking of that job.</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// But here there is no incomingJob, so nothing coming up, so time to detach.</span></span><br><span class="line">                taskStatus.contentObserverJobInstance.detachLocked();</span><br><span class="line">                taskStatus.contentObserverJobInstance = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">            Slog.i(TAG, <span class="string">"No longer tracking job "</span> + taskStatus);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 从监视队列中删除这个 job！</span></span><br><span class="line">        mTrackedTasks.remove(taskStatus);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>这段代码的逻辑很简单：</p>
<ul>
<li>如果 incomingJob 不为 null，说明有新任务会取代旧任务！</li>
<li>如果 incomingJob 为 null，说明是取消当前的这个任务！</li>
</ul>
<p>这里调用了 JobInstance 的 detachLocked 方法：</p>
<h3 id="6-2-1-JI-detachLocked"><a href="#6-2-1-JI-detachLocked" class="headerlink" title="6.2.1 JI.detachLocked"></a>6.2.1 JI.detachLocked</h3><p>遍历 JobInstance 所依赖的所有观察者，解除依赖；取消依赖为 0 的观察者的注册；从 ContentObserverController 的缓存中删除这个观察者！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">detachLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> N = mMyObservers.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">        <span class="comment">// 从这个 jobInstance 相关联的所有 ObserverInstance 移除对自身的关联！</span></span><br><span class="line">        <span class="keyword">final</span> ObserverInstance obs = mMyObservers.get(i);</span><br><span class="line">        obs.mJobs.remove(<span class="keyword">this</span>);</span><br><span class="line">         </span><br><span class="line">        <span class="comment">// 如果这个观察者依赖的 JobInstance 为 0！</span></span><br><span class="line">        <span class="keyword">if</span> (obs.mJobs.size() == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                Slog.i(TAG, <span class="string">"Unregistering observer "</span> + obs + <span class="string">" for "</span> + obs.mUri.getUri());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 取消这个观察者的注册</span></span><br><span class="line">            mContext.getContentResolver().unregisterContentObserver(obs);</span><br><span class="line">            ArrayMap&lt;JobInfo.TriggerContentUri, ObserverInstance&gt; observerOfUser =</span><br><span class="line">                    mObservers.get(obs.mUserId);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (observerOfUser !=  <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 并将这个观测者从 ContentObserverController 的缓存中删除！</span></span><br><span class="line">                observerOfUser.remove(obs.mUri);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>不多说了！</p>
<h2 id="6-3-prepareForExecutionLocked"><a href="#6-3-prepareForExecutionLocked" class="headerlink" title="6.3 prepareForExecutionLocked"></a>6.3 prepareForExecutionLocked</h2><p>这个是执行 job 前的准备操作！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">prepareForExecutionLocked</span><span class="params">(JobStatus taskStatus)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (taskStatus.hasContentTriggerConstraint()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (taskStatus.contentObserverJobInstance != <span class="keyword">null</span>) &#123;</span><br><span class="line">            taskStatus.changedUris = taskStatus.contentObserverJobInstance.mChangedUris;</span><br><span class="line">            taskStatus.changedAuthorities = taskStatus.contentObserverJobInstance.mChangedAuthorities;</span><br><span class="line"></span><br><span class="line">            taskStatus.contentObserverJobInstance.mChangedUris = <span class="keyword">null</span>;</span><br><span class="line">            taskStatus.contentObserverJobInstance.mChangedAuthorities = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个很简单吧，不说了！</p>
<h1 id="7-DeviceIdleJobsController"><a href="#7-DeviceIdleJobsController" class="headerlink" title="7 DeviceIdleJobsController"></a>7 DeviceIdleJobsController</h1><p>这个是 Doze 模式的控制器，我们先来看看构造器：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">DeviceIdleJobsController</span><span class="params">(JobSchedulerService jobSchedulerService, Context context,</span></span></span><br><span class="line"><span class="function"><span class="params">        Object lock)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(jobSchedulerService, context, lock);</span><br><span class="line">    mJobSchedulerService = jobSchedulerService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获得 PowerManagerService 对象！</span></span><br><span class="line">    mPowerManager = (PowerManager) mContext.getSystemService(Context.POWER_SERVICE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获得 DOZE 模式的 DeviceIdleController 服务对象！</span></span><br><span class="line">    mLocalDeviceIdleController =</span><br><span class="line">            LocalServices.getService(DeviceIdleController.LocalService.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这里注册了一个广播接收者！</span></span><br><span class="line">    <span class="keyword">final</span> IntentFilter filter = <span class="keyword">new</span> IntentFilter();</span><br><span class="line">    filter.addAction(PowerManager.ACTION_DEVICE_IDLE_MODE_CHANGED);</span><br><span class="line">    filter.addAction(PowerManager.ACTION_LIGHT_DEVICE_IDLE_MODE_CHANGED);</span><br><span class="line">    filter.addAction(PowerManager.ACTION_POWER_SAVE_WHITELIST_CHANGED);</span><br><span class="line">    mContext.registerReceiverAsUser(</span><br><span class="line">            mBroadcastReceiver, UserHandle.ALL, filter, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>注册了一个广播接收者，来接受这三个广播：</p>
<ul>
<li>PowerManager.ACTION_DEVICE_IDLE_MODE_CHANGED；</li>
<li>PowerManager.ACTION_LIGHT_DEVICE_IDLE_MODE_CHANGED；</li>
<li>PowerManager.ACTION_POWER_SAVE_WHITELIST_CHANGED；</li>
</ul>
<h2 id="7-1-BroadcastReceiver"><a href="#7-1-BroadcastReceiver" class="headerlink" title="7.1 BroadcastReceiver"></a>7.1 BroadcastReceiver</h2><p>我们来看看这里注册的这个广播接收者：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> BroadcastReceiver mBroadcastReceiver = <span class="keyword">new</span> BroadcastReceiver() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(Context context, Intent intent)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> String action = intent.getAction();</span><br><span class="line">        <span class="comment">// 设备 idle 状态改变的广播</span></span><br><span class="line">        <span class="keyword">if</span> (PowerManager.ACTION_LIGHT_DEVICE_IDLE_MODE_CHANGED.equals(action)</span><br><span class="line">                || PowerManager.ACTION_DEVICE_IDLE_MODE_CHANGED.equals(action)) &#123;</span><br><span class="line">                </span><br><span class="line">            updateIdleMode(mPowerManager != <span class="keyword">null</span></span><br><span class="line">                    ? (mPowerManager.isDeviceIdleMode()</span><br><span class="line">                            || mPowerManager.isLightDeviceIdleMode())</span><br><span class="line">                    : <span class="keyword">false</span>);</span><br><span class="line">        <span class="comment">// doze 模式白名单改变的广播</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (PowerManager.ACTION_POWER_SAVE_WHITELIST_CHANGED.equals(action)) &#123;</span><br><span class="line">            updateWhitelist();</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>这里在接收到指定的广播后，会调用指定的方法，我们一个一个看：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 更新 doze 模式的白名单！</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">updateWhitelist</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mLocalDeviceIdleController != <span class="keyword">null</span>) &#123;</span><br><span class="line">        </span><br><span class="line">            <span class="comment">// 将最新的白名单保存到 mDeviceIdleWhitelistAppIds 数组中！</span></span><br><span class="line">            mDeviceIdleWhitelistAppIds =</span><br><span class="line">                    mLocalDeviceIdleController.getPowerSaveWhitelistUserAppIds();</span><br><span class="line">            <span class="keyword">if</span> (LOG_DEBUG) &#123;</span><br><span class="line">                Slog.d(LOG_TAG, <span class="string">"Got whitelist "</span> + Arrays.toString(mDeviceIdleWhitelistAppIds));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个方法很简单，更新 mDeviceIdleWhitelistAppIds 白名单数组！</p>
<p>接着来看 updateIdleMode 方法，当受到设备状态改变的广播后，需要通知 JSS：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">updateIdleMode</span><span class="params">(<span class="keyword">boolean</span> enabled)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> changed = <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">// Need the whitelist to be ready when going into idle</span></span><br><span class="line">    <span class="keyword">if</span> (mDeviceIdleWhitelistAppIds == <span class="keyword">null</span>) &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 如果白名单为 null，就先去更新 doze 白名单！</span></span><br><span class="line">        updateWhitelist();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mDeviceIdleMode != enabled) &#123; <span class="comment">// 如果这次的状态和上一次不一样，那就要触发 job！</span></span><br><span class="line">            changed = <span class="keyword">true</span>; <span class="comment">// changed 置为 true</span></span><br><span class="line">        &#125;</span><br><span class="line">        mDeviceIdleMode = enabled;</span><br><span class="line">        <span class="keyword">if</span> (LOG_DEBUG) Slog.d(LOG_TAG, <span class="string">"mDeviceIdleMode="</span> + mDeviceIdleMode);</span><br><span class="line">        </span><br><span class="line">        mJobSchedulerService.getJobStore().forEachJob(mUpdateFunctor); <span class="comment">//　更新 job 的状态！</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Inform the job scheduler service about idle mode changes</span></span><br><span class="line">    <span class="keyword">if</span> (changed) &#123;</span><br><span class="line">        mStateChangedListener.onDeviceIdleStateChanged(enabled); <span class="comment">// 回调通知 jobScheduler，设备状态改变了！</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里会执行一个 JobStatusFunctor 的操作：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> JobStore.JobStatusFunctor mUpdateFunctor = <span class="keyword">new</span> JobStore.JobStatusFunctor() &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 对 JobStore 中的每个 job 执行 process 操作！</span></span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(JobStatus jobStatus)</span> </span>&#123;</span><br><span class="line">        updateTaskStateLocked(jobStatus);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>接着来看：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateTaskStateLocked</span><span class="params">(JobStatus task)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断这个 job 的 uid 是否在 doze 模式的白名单中！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> whitelisted = isWhitelistedLocked(task);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 是否满足 doze 模式的约束条件</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> enableTask = !mDeviceIdleMode || whitelisted;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 更新 job 的状态！</span></span><br><span class="line">    task.setDeviceNotDozingConstraintSatisfied(enableTask, whitelisted);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里最后会调用：setDeviceNotDozingConstraintSatisfied 方法！</p>
<h1 id="8-附录"><a href="#8-附录" class="headerlink" title="8 附录"></a>8 附录</h1><h2 id="8-1-JobStatus-setConstraintSatisfied"><a href="#8-1-JobStatus-setConstraintSatisfied" class="headerlink" title="8.1 JobStatus.setConstraintSatisfied"></a>8.1 JobStatus.setConstraintSatisfied</h2><p>在 JobStatus 中，有着两个变量：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Constraints.</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">int</span> requiredConstraints;</span><br><span class="line"><span class="keyword">int</span> satisfiedConstraints = <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<p>这里解释一下：</p>
<ul>
<li>requiredConstraints：这是一个 final 类型的变量，是在 JobInfo 创建的时候，设置的所有的约束条件，一旦设置，就不可变了！</li>
<li>satisfiedConstraints：它的每个二进制位是可变的，用来动态记录 job 的约束条件是否发生了变化！</li>
</ul>
<p>在上面，我们看到，每个控制器都有调用这样的方法，这个方法，很有意思，我们看一下，参数传递：</p>
<ul>
<li>int constraint：某一个约束条件！</li>
<li>boolean state：这一次是否满足条件！</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">setConstraintSatisfied</span><span class="params">(<span class="keyword">int</span> constraint, <span class="keyword">boolean</span> state)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 判断上一次是否满足约束条件！</span></span><br><span class="line">    <span class="keyword">boolean</span> old = (satisfiedConstraints&amp;constraint) != <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 如果相等，说明约束条件没有变化，无需改变 job 的状态，返回 false！</span></span><br><span class="line">    <span class="keyword">if</span> (old == state) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果不相等，说明约束条件变化了，那就要返回 true！</span></span><br><span class="line">    <span class="comment">// 并根据 state 的值来修改 satisfiedConstraints 的 constraint 位！</span></span><br><span class="line">    satisfiedConstraints = (satisfiedConstraints&amp;~constraint) | (state ? constraint : <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>返回值说明：</p>
<ul>
<li>返回 false：说明约束条件保持不变，无需修改  satisfiedConstraints 的指定二进制位！</li>
<li>返回 true：说明约束条件发生了变化，可能是从满足变为不满足，也可能是从不满足变为满足，最终的状态动态记录在 satisfiedConstraints 中！</li>
</ul>
<p>注意：<br>satisfiedConstraints&amp;~constraint 的作用是：将 constraint 位置为 0！<br>(satisfiedConstraints&amp;~constraint) | (state ? constraint : 0) 的作用是：根据 state 的值，将 satisfiedConstraints 的二进制位 constraint 置为 1/0；</p>
<h2 id="8-1-JobStatus-isConstraintSatisfied"><a href="#8-1-JobStatus-isConstraintSatisfied" class="headerlink" title="8.1 JobStatus.isConstraintSatisfied"></a>8.1 JobStatus.isConstraintSatisfied</h2><p>这个方法的作用很简单，判断此时 jobStatus 是否满足指定条件：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">isConstraintSatisfied</span><span class="params">(<span class="keyword">int</span> constraint)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (satisfiedConstraints&amp;constraint) != <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="8-3-JobSchedulerService"><a href="#8-3-JobSchedulerService" class="headerlink" title="8.3 JobSchedulerService"></a>8.3 JobSchedulerService</h2><p>前面可以看到，每个控制器，最后都调用了 JSS 的如下方法：</p>
<ul>
<li>ConnectivityController：                  onControllerStateChanged、onRunJobNow</li>
<li>TimeController：                          onControllerStateChanged、onRunJobNow</li>
<li>IdleController：                          onControllerStateChanged</li>
<li>BatteryController：                       onControllerStateChanged、onRunJobNow</li>
<li>AppIdleController：                       onControllerStateChanged</li>
<li>ContentObserverController：               onControllerStateChanged</li>
<li>DeviceIdleJobsController：                onDeviceIdleStateChanged</li>
</ul>
<p>接下来，我们看下这几个方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onControllerStateChanged</span><span class="params">()</span> </span>&#123;<span class="comment">// 控制器状态变化，</span></span><br><span class="line">    mHandler.obtainMessage(MSG_CHECK_JOB).sendToTarget();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRunJobNow</span><span class="params">(JobStatus jobStatus)</span> </span>&#123;</span><br><span class="line">    mHandler.obtainMessage(MSG_JOB_EXPIRED, jobStatus).sendToTarget();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这两个方法很简单，区别在于：</p>
<ul>
<li>MSG_CHECK_JOB：让 JobSchedulerService 去，遍历 JobStore 执行相应的 job！</li>
<li>MSG_JOB_EXPIRED：立刻执行这个 job！</li>
</ul>
<p>接着：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDeviceIdleStateChanged</span><span class="params">(<span class="keyword">boolean</span> deviceIdle)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="keyword">if</span> (deviceIdle) &#123;</span><br><span class="line">            <span class="comment">// When becoming idle, make sure no jobs are actively running,</span></span><br><span class="line">            <span class="comment">// except those using the idle exemption flag.</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;mActiveServices.size(); i++) &#123;</span><br><span class="line">                JobServiceContext jsc = mActiveServices.get(i);</span><br><span class="line">                <span class="keyword">final</span> JobStatus executing = jsc.getRunningJob();</span><br><span class="line">                <span class="keyword">if</span> (executing != <span class="keyword">null</span></span><br><span class="line">                        &amp;&amp; (executing.getFlags() &amp; JobInfo.FLAG_WILL_BE_FOREGROUND) == <span class="number">0</span>) &#123;</span><br><span class="line">                    jsc.cancelExecutingJob(JobParameters.REASON_DEVICE_IDLE); <span class="comment">// 取消执行 job</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// When coming out of idle, allow thing to start back up.</span></span><br><span class="line">            <span class="keyword">if</span> (mReadyToRock) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mLocalDeviceIdleController != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!mReportedActive) &#123;</span><br><span class="line">                        mReportedActive = <span class="keyword">true</span>;</span><br><span class="line">                        mLocalDeviceIdleController.setJobsActive(<span class="keyword">true</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            mHandler.obtainMessage(MSG_CHECK_JOB).sendToTarget();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>先到这里吧！</p>
<h2 id="8-3-Controller-和对应的条件"><a href="#8-3-Controller-和对应的条件" class="headerlink" title="8.3 Controller 和对应的条件"></a>8.3 Controller 和对应的条件</h2><p>我们来总结一下，Controller 和其对应的约束条件：</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2016/04/23/JobScheduler第 5 篇 - JobSchedulerService - jobFinished/">JobScheduler第 5 篇 - JobSchedulerService - jobFinished</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-04-23</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/AndroidFramework源码分析/">AndroidFramework源码分析</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/AndroidFramework源码分析/JobScheduler任务调度/">JobScheduler任务调度</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/JobScheduler任务调度/">JobScheduler任务调度</a></span><div class="content"><p>基于 Android 7.1.1 源码分析</p>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>当任务完成时，应用需要手动调用 jobFinished 方法，这个方法是属于 JobService 的：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">jobFinished</span><span class="params">(JobParameters params, <span class="keyword">boolean</span> needsReschedule)</span> </span>&#123;</span><br><span class="line">    ensureHandler();</span><br><span class="line">    Message m = Message.obtain(mHandler, MSG_JOB_FINISHED, params);</span><br><span class="line">    m.arg2 = needsReschedule ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">    m.sendToTarget();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>其实，参数很简单，这个消息 MSG_JOB_FINISHED 会发送到 JobHandler 中！</p>
<h1 id="1-JS-JobHandler"><a href="#1-JS-JobHandler" class="headerlink" title="1 JS.JobHandler"></a>1 JS.JobHandler</h1><p>进入 JobHandler 中来看看：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JobHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">    JobHandler(Looper looper) &#123;</span><br><span class="line">        <span class="keyword">super</span>(looper);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> JobParameters params = (JobParameters) msg.obj;</span><br><span class="line">        <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line"></span><br><span class="line">            ... ... ... ...</span><br><span class="line">      </span><br><span class="line">            <span class="keyword">case</span> MSG_JOB_FINISHED:</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">boolean</span> needsReschedule = (msg.arg2 == <span class="number">1</span>);</span><br><span class="line">                <span class="comment">// callback 是 JobServiceContext </span></span><br><span class="line">                IJobCallback callback = params.getCallback();</span><br><span class="line">                <span class="keyword">if</span> (callback != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        callback.jobFinished(params.getJobId(), needsReschedule);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                        Log.e(TAG, <span class="string">"Error reporting job finish to system: binder has gone"</span> + <span class="string">" away."</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    Log.e(TAG, <span class="string">"finishJob() called for a nonexistent job id."</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                Log.e(TAG, <span class="string">"Unrecognised message received."</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里调用了 JObServiceContext 的 jobFinished 方法！</p>
<h1 id="2-JSC-jobFinished"><a href="#2-JSC-jobFinished" class="headerlink" title="2 JSC.jobFinished"></a>2 JSC.jobFinished</h1><p>我们来看看 JobServiceContext 的 jobFinished 方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">jobFinished</span><span class="params">(<span class="keyword">int</span> jobId, <span class="keyword">boolean</span> reschedule)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!verifyCallingUid()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mCallbackHandler.obtainMessage(MSG_CALLBACK, jobId, reschedule ? <span class="number">1</span> : <span class="number">0</span>)</span><br><span class="line">            .sendToTarget();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里先调用了 JobServiceContext 的 verifyCallingUid，校验 uid！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">verifyCallingUid</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mRunningJob == <span class="keyword">null</span> || Binder.getCallingUid() != mRunningJob.getUid()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                Slog.d(TAG, <span class="string">"Stale callback received, ignoring."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>接着发送了一个 MSG_CALLBACK 的消息给了 JobServiceHandler！</p>
<h1 id="3-JSC-JobServiceHandler"><a href="#3-JSC-JobServiceHandler" class="headerlink" title="3 JSC.JobServiceHandler"></a>3 JSC.JobServiceHandler</h1><p>接着进入了 JobServiceHandler，来看主要代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> MSG_CALLBACK:</span><br><span class="line">    <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">        Slog.d(TAG, <span class="string">"MSG_CALLBACK of : "</span> + mRunningJob</span><br><span class="line">                + <span class="string">" v:"</span> + VERB_STRINGS[mVerb]);</span><br><span class="line">    &#125;</span><br><span class="line">    removeOpTimeOut();</span><br><span class="line">    <span class="keyword">if</span> (mVerb == VERB_STARTING) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> workOngoing = message.arg2 == <span class="number">1</span>;</span><br><span class="line">        handleStartedH(workOngoing);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mVerb == VERB_EXECUTING || <span class="comment">// 此时 mVerb 的状态为 VERB_EXECUTING</span></span><br><span class="line">            mVerb == VERB_STOPPING) &#123; </span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> reschedule = message.arg2 == <span class="number">1</span>;</span><br><span class="line">        handleFinishedH(reschedule);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">            Slog.d(TAG, <span class="string">"Unrecognised callback: "</span> + mRunningJob);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure></p>
<p>调用了 handleFinishedH：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleFinishedH</span><span class="params">(<span class="keyword">boolean</span> reschedule)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (mVerb) &#123;</span><br><span class="line">        <span class="keyword">case</span> VERB_EXECUTING:</span><br><span class="line">        <span class="keyword">case</span> VERB_STOPPING:</span><br><span class="line">            closeAndCleanupJobH(reschedule);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            Slog.e(TAG, <span class="string">"Got an execution complete message for a job that wasn't being"</span> +</span><br><span class="line">                    <span class="string">"executed. Was "</span> + VERB_STRINGS[mVerb] + <span class="string">"."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里就很简单了，调用了 closeAndCleanupJobH 来解除 bind 和将 JObServiceContext 恢复初始化，为下一次 bind 做准备！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">closeAndCleanupJobH</span><span class="params">(<span class="keyword">boolean</span> reschedule)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> JobStatus completedJob;</span><br><span class="line">        <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mVerb == VERB_FINISHED) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            completedJob = mRunningJob;</span><br><span class="line">            mJobPackageTracker.noteInactive(completedJob);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                mBatteryStats.noteJobFinish(mRunningJob.getBatteryName(),</span><br><span class="line">                        mRunningJob.getSourceUid());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                <span class="comment">// Whatever.</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (mWakeLock != <span class="keyword">null</span>) &#123;</span><br><span class="line">                mWakeLock.release();</span><br><span class="line">            &#125;</span><br><span class="line">            mContext.unbindService(JobServiceContext.<span class="keyword">this</span>);</span><br><span class="line">            mWakeLock = <span class="keyword">null</span>;</span><br><span class="line">            mRunningJob = <span class="keyword">null</span>;</span><br><span class="line">            mParams = <span class="keyword">null</span>;</span><br><span class="line">            mVerb = VERB_FINISHED; <span class="comment">// 状态变为 VERB_FINISHED</span></span><br><span class="line">            mCancelled.set(<span class="keyword">false</span>);</span><br><span class="line">            service = <span class="keyword">null</span>;</span><br><span class="line">            mAvailable = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        removeOpTimeOut();</span><br><span class="line">        removeMessages(MSG_CALLBACK);</span><br><span class="line">        removeMessages(MSG_SERVICE_BOUND);</span><br><span class="line">        removeMessages(MSG_CANCEL);</span><br><span class="line">        removeMessages(MSG_SHUTDOWN_EXECUTION);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 通知 JobSchedulerService，这个 job 已经 finished 了</span></span><br><span class="line">        mCompletedListener.onJobCompleted(completedJob, reschedule);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>接着，进入了 JobSchedulerService 方法中：</p>
<h1 id="4-JSS-onJobCompleted"><a href="#4-JSS-onJobCompleted" class="headerlink" title="4 JSS.onJobCompleted"></a>4 JSS.onJobCompleted</h1><p>调用了 onJobCompleted 方法；<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onJobCompleted</span><span class="params">(JobStatus jobStatus, <span class="keyword">boolean</span> needsReschedule)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">        Slog.d(TAG, <span class="string">"Completed "</span> + jobStatus + <span class="string">", reschedule="</span> + needsReschedule);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 停止 track job，会将 job 从 JobStore 中删除，如果不是周期性的 job，还要更新本地的 jobs.xml 文件！</span></span><br><span class="line">    <span class="keyword">if</span> (!stopTrackingJob(jobStatus, <span class="keyword">null</span>, !jobStatus.getJob().isPeriodic())) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">            Slog.d(TAG, <span class="string">"Could not find job to remove. Was job removed while executing?"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 停止失败，说明 job 之前已经被移除，继续发起下一轮的执行！</span></span><br><span class="line">        mHandler.obtainMessage(MSG_CHECK_JOB_GREEDY).sendToTarget();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 停止成功</span></span><br><span class="line">    <span class="keyword">if</span> (needsReschedule) &#123;<span class="comment">// 需要 reschedule 这个 job，如果需要，就 startTrackingJob</span></span><br><span class="line">        JobStatus rescheduled = getRescheduleJobForFailure(jobStatus);</span><br><span class="line">        startTrackingJob(rescheduled, jobStatus);</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (jobStatus.getJob().isPeriodic()) &#123; <span class="comment">// 如果不需要 reschedule，但是这个 job 是周期性的，也要 startTrackingJob</span></span><br><span class="line">        JobStatus rescheduledPeriodic = getRescheduleJobForPeriodic(jobStatus);</span><br><span class="line">        startTrackingJob(rescheduledPeriodic, jobStatus);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 汇报 JSS 运行状态给 DeviceIdleController！</span></span><br><span class="line">    reportActive();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 继续开始新一轮的 job 执行！</span></span><br><span class="line">    mHandler.obtainMessage(MSG_CHECK_JOB_GREEDY).sendToTarget();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="4-1-JSS-getRescheduleJobForFailure"><a href="#4-1-JSS-getRescheduleJobForFailure" class="headerlink" title="4.1 JSS.getRescheduleJobForFailure"></a>4.1 JSS.getRescheduleJobForFailure</h2><p>这里调用了 getRescheduleJobForPeriodic 的方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> JobStatus <span class="title">getRescheduleJobForFailure</span><span class="params">(JobStatus failureToReschedule)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 获得自开机后，经过的时间，包括深度睡眠的时间;</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> elapsedNowMillis = SystemClock.elapsedRealtime();</span><br><span class="line">    <span class="comment">// 获得这个 jobFinished 的 jobStatus 对应的 JobInfo;</span></span><br><span class="line">    <span class="keyword">final</span> JobInfo job = failureToReschedule.getJob();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> initialBackoffMillis = job.getInitialBackoffMillis();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> backoffAttempts = failureToReschedule.getNumFailures() + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">long</span> delayMillis;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (job.getBackoffPolicy()) &#123;</span><br><span class="line">        <span class="keyword">case</span> JobInfo.BACKOFF_POLICY_LINEAR:</span><br><span class="line">            delayMillis = initialBackoffMillis * backoffAttempts;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> JobInfo.BACKOFF_POLICY_EXPONENTIAL:</span><br><span class="line">            delayMillis =</span><br><span class="line">                    (<span class="keyword">long</span>) Math.scalb(initialBackoffMillis, backoffAttempts - <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                Slog.v(TAG, <span class="string">"Unrecognised back-off policy, defaulting to exponential."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    delayMillis =</span><br><span class="line">            Math.min(delayMillis, JobInfo.MAX_BACKOFF_DELAY_MILLIS);</span><br><span class="line"></span><br><span class="line">    JobStatus newJob = <span class="keyword">new</span> JobStatus(failureToReschedule, elapsedNowMillis + delayMillis,</span><br><span class="line">            JobStatus.NO_LATEST_RUNTIME, backoffAttempts);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> ic=<span class="number">0</span>; ic&lt;mControllers.size(); ic++) &#123;</span><br><span class="line">        StateController controller = mControllers.get(ic);</span><br><span class="line">        controller.rescheduleForFailure(newJob, failureToReschedule);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> newJob;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="4-2-JSS-getRescheduleJobForPeriodic"><a href="#4-2-JSS-getRescheduleJobForPeriodic" class="headerlink" title="4.2 JSS.getRescheduleJobForPeriodic"></a>4.2 JSS.getRescheduleJobForPeriodic</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> JobStatus <span class="title">getRescheduleJobForPeriodic</span><span class="params">(JobStatus periodicToReschedule)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> elapsedNow = SystemClock.elapsedRealtime();</span><br><span class="line">    <span class="comment">// Compute how much of the period is remaining.</span></span><br><span class="line">    <span class="keyword">long</span> runEarly = <span class="number">0L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If this periodic was rescheduled it won't have a deadline.</span></span><br><span class="line">    <span class="keyword">if</span> (periodicToReschedule.hasDeadlineConstraint()) &#123;</span><br><span class="line">        runEarly = Math.max(periodicToReschedule.getLatestRunTimeElapsed() - elapsedNow, <span class="number">0L</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">long</span> flex = periodicToReschedule.getJob().getFlexMillis();</span><br><span class="line">    <span class="keyword">long</span> period = periodicToReschedule.getJob().getIntervalMillis();</span><br><span class="line">    <span class="keyword">long</span> newLatestRuntimeElapsed = elapsedNow + runEarly + period;</span><br><span class="line">    <span class="keyword">long</span> newEarliestRunTimeElapsed = newLatestRuntimeElapsed - flex;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">        Slog.v(TAG, <span class="string">"Rescheduling executed periodic. New execution window ["</span> +</span><br><span class="line">                newEarliestRunTimeElapsed/<span class="number">1000</span> + <span class="string">", "</span> + newLatestRuntimeElapsed/<span class="number">1000</span> + <span class="string">"]s"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> JobStatus(periodicToReschedule, newEarliestRunTimeElapsed,</span><br><span class="line">            newLatestRuntimeElapsed, <span class="number">0</span> <span class="comment">/* backoffAttempt */</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2016/04/21/JobScheduler第 4 篇 - JobSchedulerService - cancel/">JobScheduler第 4 篇 - JobSchedulerService - cancel</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-04-21</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/AndroidFramework源码分析/">AndroidFramework源码分析</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/AndroidFramework源码分析/JobScheduler任务调度/">JobScheduler任务调度</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/JobScheduler任务调度/">JobScheduler任务调度</a></span><div class="content"><p>基于 Android 7.1.1 源码分析</p>
<h1 id="前提"><a href="#前提" class="headerlink" title="前提"></a>前提</h1><p>接下来，我们来看看 JobServiceService 服务中和 cancel 相关的服务：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 取消指定设备用户的所有的 job！</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cancelJobsForUser</span><span class="params">(<span class="keyword">int</span> userHandle)</span> </span>&#123;</span><br><span class="line">    List&lt;JobStatus&gt; jobsForUser;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        jobsForUser = mJobs.getJobsByUser(userHandle);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;jobsForUser.size(); i++) &#123;</span><br><span class="line">        JobStatus toRemove = jobsForUser.get(i);</span><br><span class="line">        cancelJobImpl(toRemove, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 取消指定 package 和指定 uid 的所有的 job！</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cancelJobsForPackageAndUid</span><span class="params">(String pkgName, <span class="keyword">int</span> uid)</span> </span>&#123;</span><br><span class="line">    List&lt;JobStatus&gt; jobsForUid;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        jobsForUid = mJobs.getJobsByUid(uid);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = jobsForUid.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        <span class="keyword">final</span> JobStatus job = jobsForUid.get(i);</span><br><span class="line">        <span class="keyword">if</span> (job.getSourcePackageName().equals(pkgName)) &#123;</span><br><span class="line">            cancelJobImpl(job, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 取消指定 uid 的应用程序的所有的 job！</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancelJobsForUid</span><span class="params">(<span class="keyword">int</span> uid, <span class="keyword">boolean</span> forceAll)</span> </span>&#123;</span><br><span class="line">    List&lt;JobStatus&gt; jobsForUid;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        jobsForUid = mJobs.getJobsByUid(uid);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;jobsForUid.size(); i++) &#123;</span><br><span class="line">        JobStatus toRemove = jobsForUid.get(i);</span><br><span class="line">        <span class="keyword">if</span> (!forceAll) &#123;</span><br><span class="line">            String packageName = toRemove.getServiceComponent().getPackageName();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (ActivityManagerNative.getDefault().getAppStartMode(uid, packageName)</span><br><span class="line">                        != ActivityManager.APP_START_MODE_DISABLED) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        cancelJobImpl(toRemove, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 取消指定 uid 的应用程序的 id 为 jobId 的 job！</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancelJob</span><span class="params">(<span class="keyword">int</span> uid, <span class="keyword">int</span> jobId)</span> </span>&#123;</span><br><span class="line">    JobStatus toCancel;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        toCancel = mJobs.getJobByUidAndJobId(uid, jobId);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (toCancel != <span class="keyword">null</span>) &#123;</span><br><span class="line">        cancelJobImpl(toCancel, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>JobSchedulerService 提供了很多个接口来取消 job，但是他们都疯了似的调用了同一个方法，我们来继续看！</p>
<h1 id="1-JSS-cancelJobImpl"><a href="#1-JSS-cancelJobImpl" class="headerlink" title="1 JSS.cancelJobImpl"></a>1 JSS.cancelJobImpl</h1><p>同一个取消接口：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">cancelJobImpl</span><span class="params">(JobStatus cancelled, JobStatus incomingJob)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG) Slog.d(TAG, <span class="string">"CANCEL: "</span> + cancelled.toShortString());</span><br><span class="line">    <span class="comment">// 停止监视这个 job，writeBack 为 true!</span></span><br><span class="line">    stopTrackingJob(cancelled, incomingJob, <span class="keyword">true</span> <span class="comment">/* writeBack */</span>);</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="comment">// Remove from pending queue.</span></span><br><span class="line">        <span class="comment">// 从 mPendingJobs 中移除！</span></span><br><span class="line">        <span class="keyword">if</span> (mPendingJobs.remove(cancelled)) &#123;</span><br><span class="line">            mJobPackageTracker.noteNonpending(cancelled);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Cancel if running.</span></span><br><span class="line">        <span class="comment">// 如果正在运行，就要停止这个 job</span></span><br><span class="line">        stopJobOnServiceContextLocked(cancelled, JobParameters.REASON_CANCELED);</span><br><span class="line">        reportActive();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里我们一个一个来看：</p>
<h2 id="1-1-JSS-stopTrackingJob"><a href="#1-1-JSS-stopTrackingJob" class="headerlink" title="1.1 JSS.stopTrackingJob"></a>1.1 JSS.stopTrackingJob</h2><p>停止 stopTrackingJob 如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">stopTrackingJob</span><span class="params">(JobStatus jobStatus, JobStatus incomingJob,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> writeBack)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="comment">// Remove from store as well as controllers.</span></span><br><span class="line">        <span class="comment">// 先从 JobStore 中移除这个 job，因为 writeBack 为 true，则需要更新 jobxs.xml 文件！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> removed = mJobs.remove(jobStatus, writeBack);</span><br><span class="line">        <span class="keyword">if</span> (removed &amp;&amp; mReadyToRock) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;mControllers.size(); i++) &#123;</span><br><span class="line">                <span class="comment">// 通知控制器，取消 track！</span></span><br><span class="line">                StateController controller = mControllers.get(i);</span><br><span class="line">                controller.maybeStopTrackingJobLocked(jobStatus, incomingJob, <span class="keyword">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> removed;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>先从 JobStore 中移除这个 job，因为 writeBack 为 true，则需要更新 jobxs.xml 文件，通知控制器，取消 track！</p>
<h2 id="1-2-JSS-stopJobOnServiceContextLocked"><a href="#1-2-JSS-stopJobOnServiceContextLocked" class="headerlink" title="1.2 JSS.stopJobOnServiceContextLocked"></a>1.2 JSS.stopJobOnServiceContextLocked</h2><p>如果这个 job 是在运行中，就要取消它！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">stopJobOnServiceContextLocked</span><span class="params">(JobStatus job, <span class="keyword">int</span> reason)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;mActiveServices.size(); i++) &#123;</span><br><span class="line">        JobServiceContext jsc = mActiveServices.get(i);</span><br><span class="line">        <span class="keyword">final</span> JobStatus executing = jsc.getRunningJob();</span><br><span class="line">        <span class="keyword">if</span> (executing != <span class="keyword">null</span> &amp;&amp; executing.matches(job.getUid(), job.getJobId())) &#123;</span><br><span class="line">            jsc.cancelExecutingJob(reason);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>每一个运行着的 job，都是和一个 JobServiceContext 绑定着的，这里是遍历所有的 JobServiceContext，找到要 cancel 的 job，调用 jobServiceContext 的 cancelExecutingJob 方法：</p>
<h3 id="1-2-1-JSC-cancelExecutingJob"><a href="#1-2-1-JSC-cancelExecutingJob" class="headerlink" title="1.2.1 JSC.cancelExecutingJob"></a>1.2.1 JSC.cancelExecutingJob</h3><p>这个方法很简单，发送了 MSG_CANCEL 消息给 JobServiceHandler，reason 为 JobParameters.REASON_CANCELED<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cancelExecutingJob</span><span class="params">(<span class="keyword">int</span> reason)</span> </span>&#123;</span><br><span class="line">    mCallbackHandler.obtainMessage(MSG_CANCEL, reason, <span class="number">0</span> <span class="comment">/* unused */</span>).sendToTarget();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们继续看，进入 JobServiceHandler：</p>
<h3 id="1-2-2-JSH-MSG-CANCEL"><a href="#1-2-2-JSH-MSG-CANCEL" class="headerlink" title="1.2.2 JSH.MSG_CANCEL"></a>1.2.2 JSH.MSG_CANCEL</h3><p>JobServiceHander 会处理 MSG_CANCEL 消息！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">JobServiceHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">    JobServiceHandler(Looper looper) &#123;</span><br><span class="line">        <span class="keyword">super</span>(looper);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message message)</span> </span>&#123;</span><br><span class="line">            </span><br><span class="line">            ... ... ... ...</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> MSG_CANCEL: <span class="comment">// 接受到了 MSG_CANCEL.</span></span><br><span class="line">                <span class="keyword">if</span> (mVerb == VERB_FINISHED) &#123; </span><br><span class="line">                    <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                        Slog.d(TAG,</span><br><span class="line">                               <span class="string">"Trying to process cancel for torn-down context, ignoring."</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                mParams.setStopReason(message.arg1); <span class="comment">// reason 为 JobParameters.REASON_CANCELED</span></span><br><span class="line">                <span class="keyword">if</span> (message.arg1 == JobParameters.REASON_PREEMPT) &#123; <span class="comment">// 不进入，因为这不是优先级取代！</span></span><br><span class="line">                    mPreferredUid = mRunningJob != <span class="keyword">null</span> ? mRunningJob.getUid() :</span><br><span class="line">                            NO_PREFERRED_UID;</span><br><span class="line">                &#125;</span><br><span class="line">                handleCancelH();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> MSG_TIMEOUT:</span><br><span class="line">                handleOpTimeoutH();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> MSG_SHUTDOWN_EXECUTION:</span><br><span class="line">                closeAndCleanupJobH(<span class="keyword">true</span> <span class="comment">/* needsReschedule */</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                Slog.e(TAG, <span class="string">"Unrecognised message: "</span> + message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ... ... ... ... ...</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>调用 handleCancelH 方法来取消 Job：</p>
<h3 id="1-2-3-JSH-handleCancelH"><a href="#1-2-3-JSH-handleCancelH" class="headerlink" title="1.2.3 JSH.handleCancelH"></a>1.2.3 JSH.handleCancelH</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * A job can be in various states when a cancel request comes in:</span></span><br><span class="line"><span class="comment">  *   VERB_BINDING   -&gt; Cancelled before bind completed. Mark as cancelled and wait for</span></span><br><span class="line"><span class="comment">  *                    &#123;<span class="doctag">@link</span> #onServiceConnected(android.content.ComponentName, android.os.IBinder)&#125;</span></span><br><span class="line"><span class="comment">  *      _STARTING   -&gt; Mark as cancelled and wait for</span></span><br><span class="line"><span class="comment">  *                    &#123;<span class="doctag">@link</span> JobServiceContext#acknowledgeStartMessage(int, boolean)&#125;</span></span><br><span class="line"><span class="comment">  *     _EXECUTING  -&gt; call &#123;<span class="doctag">@link</span> #sendStopMessageH&#125;&#125;, but only if there are no callbacks</span></span><br><span class="line"><span class="comment">  *                      in the message queue.</span></span><br><span class="line"><span class="comment">  *     _ENDING     -&gt; No point in doing anything here, so we ignore.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleCancelH</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     <span class="keyword">if</span> (JobSchedulerService.DEBUG) &#123;</span><br><span class="line">         Slog.d(TAG, <span class="string">"Handling cancel for: "</span> + mRunningJob.getJobId() + <span class="string">" "</span></span><br><span class="line">                 + VERB_STRINGS[mVerb]);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">switch</span> (mVerb) &#123;</span><br><span class="line">         <span class="keyword">case</span> VERB_BINDING:  <span class="comment">// 如果 job 的状态是 VERB_BINDING 或者 VERB_STARTING，直接将 mCancelled 置为 true !</span></span><br><span class="line">         <span class="keyword">case</span> VERB_STARTING:</span><br><span class="line">             mCancelled.set(<span class="keyword">true</span>);</span><br><span class="line">             <span class="keyword">break</span>;</span><br><span class="line">         <span class="keyword">case</span> VERB_EXECUTING: <span class="comment">// 如果 job 的状态是 VERB_EXECUTING，</span></span><br><span class="line">             <span class="keyword">if</span> (hasMessages(MSG_CALLBACK)) &#123; <span class="comment">// 判断客户端是否已经调用过 jobFinished 方法，有直接 return!</span></span><br><span class="line">                 <span class="comment">// If the client has called jobFinished, ignore this cancel.</span></span><br><span class="line">                 <span class="keyword">return</span>;</span><br><span class="line">             &#125;</span><br><span class="line">             sendStopMessageH(); <span class="comment">// </span></span><br><span class="line">             <span class="keyword">break</span>;</span><br><span class="line">         <span class="keyword">case</span> VERB_STOPPING:</span><br><span class="line">             <span class="comment">// Nada.</span></span><br><span class="line">             <span class="keyword">break</span>;</span><br><span class="line">         <span class="keyword">default</span>:</span><br><span class="line">             Slog.e(TAG, <span class="string">"Cancelling a job without a valid verb: "</span> + mVerb);</span><br><span class="line">             <span class="keyword">break</span>;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>我们来看看 sendStopMessageH 方法：</p>
<h3 id="1-2-4-JSH-sendStopMessageH"><a href="#1-2-4-JSH-sendStopMessageH" class="headerlink" title="1.2.4 JSH.sendStopMessageH"></a>1.2.4 JSH.sendStopMessageH</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Already running, need to stop. Will switch &#123;<span class="doctag">@link</span> #mVerb&#125; from VERB_EXECUTING -&gt;</span></span><br><span class="line"><span class="comment"> * VERB_STOPPING.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sendStopMessageH</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    removeOpTimeOut();</span><br><span class="line">    <span class="keyword">if</span> (mVerb != VERB_EXECUTING) &#123; <span class="comment">// 如果 job 的状态已经不是 VERB_EXECUTING，那就清除资源，恢复初始化!</span></span><br><span class="line">        Slog.e(TAG, <span class="string">"Sending onStopJob for a job that isn't started. "</span> + mRunningJob);</span><br><span class="line">        closeAndCleanupJobH(<span class="keyword">false</span> <span class="comment">/* reschedule */</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        mVerb = VERB_STOPPING; <span class="comment">// 否则，job 状态设置为 VERB_STOPPING，</span></span><br><span class="line">        scheduleOpTimeOut(); </span><br><span class="line">        service.stopJob(mParams); <span class="comment">// 调用 jobService 的 stopJob，停止服务!</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        Slog.e(TAG, <span class="string">"Error sending onStopJob to client."</span>, e);</span><br><span class="line">        closeAndCleanupJobH(<span class="keyword">false</span> <span class="comment">/* reschedule */</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里会根据 mVerb 中存储的 job 的动作状态，来做相应的处理：<br>如果 job 的状态已经不是 VERB_EXECUTING，那就清除资源，恢复初始化；<br>否则，job 状态设置为 VERB_STOPPING，调用 jobService 的 stopJob，停止服务!</p>
<h4 id="1-2-4-1-JobService-stopJob"><a href="#1-2-4-1-JobService-stopJob" class="headerlink" title="1.2.4.1 JobService.stopJob"></a>1.2.4.1 JobService.stopJob</h4><p>通过 Binder 机制，停止 job：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">JobService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    ... ... ... ...    </span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"JobService"</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">JobInterface</span> <span class="keyword">extends</span> <span class="title">IJobService</span>.<span class="title">Stub</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> WeakReference&lt;JobService&gt; mService;</span><br><span class="line">        JobInterface(JobService service) &#123;</span><br><span class="line">            mService = <span class="keyword">new</span> WeakReference&lt;&gt;(service);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startJob</span><span class="params">(JobParameters jobParams)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">            JobService service = mService.get();</span><br><span class="line">            <span class="keyword">if</span> (service != <span class="keyword">null</span>) &#123;</span><br><span class="line">                service.ensureHandler();</span><br><span class="line">                Message m = Message.obtain(service.mHandler, MSG_EXECUTE_JOB, jobParams);</span><br><span class="line">                m.sendToTarget();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stopJob</span><span class="params">(JobParameters jobParams)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">            JobService service = mService.get();</span><br><span class="line">            <span class="keyword">if</span> (service != <span class="keyword">null</span>) &#123;</span><br><span class="line">                service.ensureHandler(); <span class="comment">// 确保 Handler 已经创建</span></span><br><span class="line">                Message m = Message.obtain(service.mHandler, MSG_STOP_JOB, jobParams); <span class="comment">// 发送 MSG_STOP_JOB 到 JobHandler！</span></span><br><span class="line">                m.sendToTarget();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ... ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>进入 JobHandler 方法：</p>
<h4 id="1-2-4-2-JobService-JobHandler"><a href="#1-2-4-2-JobService-JobHandler" class="headerlink" title="1.2.4.2 JobService.JobHandler"></a>1.2.4.2 JobService.JobHandler</h4><p>处理前面通过 Binder 发送过来的 MSG_STOP_JOB：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JobHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">    JobHandler(Looper looper) &#123;</span><br><span class="line">        <span class="keyword">super</span>(looper);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> JobParameters params = (JobParameters) msg.obj;</span><br><span class="line">        <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">            ... ... ... ...</span><br><span class="line">            <span class="keyword">case</span> MSG_STOP_JOB:</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 这里是获得 JobService 的 onStopJob 的返回值!</span></span><br><span class="line">                    <span class="keyword">boolean</span> ret = JobService.<span class="keyword">this</span>.onStopJob(params);</span><br><span class="line">                    ackStopMessage(params, ret);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    Log.e(TAG, <span class="string">"Application unable to handle onStopJob."</span>, e);</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">           ... ... ... ...</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                Log.e(TAG, <span class="string">"Unrecognised message received."</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ... ... ... ...    </span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ackStopMessage</span><span class="params">(JobParameters params, <span class="keyword">boolean</span> reschedule)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> IJobCallback callback = params.getCallback();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> jobId = params.getJobId();</span><br><span class="line">        <span class="keyword">if</span> (callback != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 将被停止的 job 的 id 和 onStopJob 的返回值发给 JobServiceContext！</span></span><br><span class="line">                callback.acknowledgeStopMessage(jobId, reschedule);</span><br><span class="line">            &#125; <span class="keyword">catch</span>(RemoteException e) &#123;</span><br><span class="line">                Log.e(TAG, <span class="string">"System unreachable for stopping job."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (Log.isLoggable(TAG, Log.DEBUG)) &#123;</span><br><span class="line">                Log.d(TAG, <span class="string">"Attempting to ack a job that has already been processed."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>JobService 的 onStopJob 的返回值如果为 true，那么，就表示 JobService 需要重新拉起他！前面我们分析的时候，知道，callback 就是 JobServiceContext</p>
<h4 id="1-2-4-3-JSC-acknowledgeStopMessage"><a href="#1-2-4-3-JSC-acknowledgeStopMessage" class="headerlink" title="1.2.4.3 JSC.acknowledgeStopMessage"></a>1.2.4.3 JSC.acknowledgeStopMessage</h4><p>接着发送 MSG_CALLBACK 给 JobServiceHandler：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">acknowledgeStopMessage</span><span class="params">(<span class="keyword">int</span> jobId, <span class="keyword">boolean</span> reschedule)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!verifyCallingUid()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    mCallbackHandler.obtainMessage(MSG_CALLBACK, jobId, reschedule ? <span class="number">1</span> : <span class="number">0</span>)</span><br><span class="line">            .sendToTarget();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们进入 JobServiceHandler 方法里面看看：</p>
<h4 id="1-2-4-4-JSC-JobServiceHandler"><a href="#1-2-4-4-JSC-JobServiceHandler" class="headerlink" title="1.2.4.4 JSC.JobServiceHandler"></a>1.2.4.4 JSC.JobServiceHandler</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">JobServiceHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (message.what) &#123;</span><br><span class="line">            ... ... ... ...</span><br><span class="line">            <span class="keyword">case</span> MSG_CALLBACK:</span><br><span class="line">                <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                    Slog.d(TAG, <span class="string">"MSG_CALLBACK of : "</span> + mRunningJob</span><br><span class="line">                            + <span class="string">" v:"</span> + VERB_STRINGS[mVerb]);</span><br><span class="line">                &#125;</span><br><span class="line">                removeOpTimeOut();</span><br><span class="line">                <span class="keyword">if</span> (mVerb == VERB_STARTING) &#123;</span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">boolean</span> workOngoing = message.arg2 == <span class="number">1</span>;</span><br><span class="line">                    handleStartedH(workOngoing);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mVerb == VERB_EXECUTING ||</span><br><span class="line">                        mVerb == VERB_STOPPING) &#123; <span class="comment">// 进入这里！</span></span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">boolean</span> reschedule = message.arg2 == <span class="number">1</span>;</span><br><span class="line">                    handleFinishedH(reschedule);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                        Slog.d(TAG, <span class="string">"Unrecognised callback: "</span> + mRunningJob);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            ... ... ... ...</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                Slog.e(TAG, <span class="string">"Unrecognised message: "</span> + message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ... ... ... ...</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * VERB_EXECUTING  -&gt; Client called jobFinished(), clean up and notify done.</span></span><br><span class="line"><span class="comment">     *     _STOPPING   -&gt; Successful finish, clean up and notify done.</span></span><br><span class="line"><span class="comment">     *     _STARTING   -&gt; Error</span></span><br><span class="line"><span class="comment">     *     _PENDING    -&gt; Error</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleFinishedH</span><span class="params">(<span class="keyword">boolean</span> reschedule)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (mVerb) &#123;</span><br><span class="line">            <span class="keyword">case</span> VERB_EXECUTING:</span><br><span class="line">            <span class="keyword">case</span> VERB_STOPPING:</span><br><span class="line">                closeAndCleanupJobH(reschedule);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                Slog.e(TAG, <span class="string">"Got an execution complete message for a job that wasn't being"</span> +</span><br><span class="line">                        <span class="string">"executed. Was "</span> + VERB_STRINGS[mVerb] + <span class="string">"."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ... ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，最后会调用 JSH 的 closeAndCleanupJobH 方法：</p>
<h4 id="1-2-4-5-JSH-closeAndCleanupJobH"><a href="#1-2-4-5-JSH-closeAndCleanupJobH" class="headerlink" title="1.2.4.5 JSH.closeAndCleanupJobH"></a>1.2.4.5 JSH.closeAndCleanupJobH</h4><p>如果 job 的状态已经不是 VERB_EXECUTING，那就清除资源，恢复初始化；这个方法很简单，就是将 JobServiceContext 中的属性值恢复初始化，表示没有任何 job 在运行！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">closeAndCleanupJobH</span><span class="params">(<span class="keyword">boolean</span> reschedule)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> JobStatus completedJob;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mVerb == VERB_FINISHED) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        completedJob = mRunningJob;</span><br><span class="line">        mJobPackageTracker.noteInactive(completedJob);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mBatteryStats.noteJobFinish(mRunningJob.getBatteryName(),</span><br><span class="line">                    mRunningJob.getSourceUid());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            <span class="comment">// Whatever.</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mWakeLock != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mWakeLock.release();</span><br><span class="line">        &#125;</span><br><span class="line">        mContext.unbindService(JobServiceContext.<span class="keyword">this</span>); <span class="comment">// 取消绑定 jobSerivce</span></span><br><span class="line">        mWakeLock = <span class="keyword">null</span>;</span><br><span class="line">        mRunningJob = <span class="keyword">null</span>; <span class="comment">// mRunningJob 的值置为 null!</span></span><br><span class="line">        mParams = <span class="keyword">null</span>; <span class="comment">// JobParamters 置为 null</span></span><br><span class="line">        mVerb = VERB_FINISHED; <span class="comment">// mVerb 的状态值为 VERB_FINISHED</span></span><br><span class="line">        mCancelled.set(<span class="keyword">false</span>); <span class="comment">// mCancelled 置为 false</span></span><br><span class="line">        service = <span class="keyword">null</span>; <span class="comment">// 应用的 JobService 代理对象置为 null</span></span><br><span class="line">        mAvailable = <span class="keyword">true</span>; <span class="comment">// mAvailable 置为 true，表示这个 JobService 可以分配给其他 job</span></span><br><span class="line">    &#125;</span><br><span class="line">    removeOpTimeOut();</span><br><span class="line">    removeMessages(MSG_CALLBACK); <span class="comment">// 清除处理过的 MSG</span></span><br><span class="line">    removeMessages(MSG_SERVICE_BOUND);</span><br><span class="line">    removeMessages(MSG_CANCEL);</span><br><span class="line">    removeMessages(MSG_SHUTDOWN_EXECUTION);</span><br><span class="line">    <span class="comment">// 回调 JobSchedulerService 的 onJobCompleted 方法!</span></span><br><span class="line">    mCompletedListener.onJobCompleted(completedJob, reschedule);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>恢复初始化，为下次做准备!</p>
<h5 id="1-2-4-5-1-JSC-onServiceDisconnected"><a href="#1-2-4-5-1-JSC-onServiceDisconnected" class="headerlink" title="1.2.4.5.1 JSC.onServiceDisconnected"></a>1.2.4.5.1 JSC.onServiceDisconnected</h5><p>取消绑定 JobService 会调用 onServiceDisconnected<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** If the client service crashes we reschedule this job and clean up. */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceDisconnected</span><span class="params">(ComponentName name)</span> </span>&#123;</span><br><span class="line">    mCallbackHandler.obtainMessage(MSG_SHUTDOWN_EXECUTION).sendToTarget();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里的会再回到 JobServiceHandler 中：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> MSG_SHUTDOWN_EXECUTION:</span><br><span class="line">    closeAndCleanupJobH(<span class="keyword">true</span> <span class="comment">/* needsReschedule */</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure></p>
<p>做第二次 clean，防止第一次不成功，其实第一次 clean 成功的话，mVerb 的值为 VERB_FINISHED，第二次 clean 会自动退出的！</p>
<h5 id="1-2-4-5-2-JSS-onJobCompleted"><a href="#1-2-4-5-2-JSS-onJobCompleted" class="headerlink" title="1.2.4.5.2 JSS.onJobCompleted"></a>1.2.4.5.2 JSS.onJobCompleted</h5><p>我们进入 JSS 的 onJobCompleted 的方法中：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onJobCompleted</span><span class="params">(JobStatus jobStatus, <span class="keyword">boolean</span> needsReschedule)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">        Slog.d(TAG, <span class="string">"Completed "</span> + jobStatus + <span class="string">", reschedule="</span> + needsReschedule);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Do not write back immediately if this is a periodic job. The job may get lost if system</span></span><br><span class="line">    <span class="comment">// shuts down before it is added back.</span></span><br><span class="line">    <span class="comment">// 再次停止 track 这个 job，这里 stopTrackingJob 的返回值为 false！</span></span><br><span class="line">    <span class="keyword">if</span> (!stopTrackingJob(jobStatus, <span class="keyword">null</span>, !jobStatus.getJob().isPeriodic())) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">            Slog.d(TAG, <span class="string">"Could not find job to remove. Was job removed while executing?"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// We still want to check for jobs to execute, because this job may have</span></span><br><span class="line">        <span class="comment">// scheduled a new job under the same job id, and now we can run it.</span></span><br><span class="line">        <span class="comment">// 发送 MSG_CHECK_JOB_GREEDY，继续执行其他的 job，然后直接 return</span></span><br><span class="line">        mHandler.obtainMessage(MSG_CHECK_JOB_GREEDY).sendToTarget();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Note: there is a small window of time in here where, when rescheduling a job,</span></span><br><span class="line">    <span class="comment">// we will stop monitoring its content providers.  This should be fixed by stopping</span></span><br><span class="line">    <span class="comment">// the old job after scheduling the new one, but since we have no lock held here</span></span><br><span class="line">    <span class="comment">// that may cause ordering problems if the app removes jobStatus while in here.</span></span><br><span class="line">    <span class="keyword">if</span> (needsReschedule) &#123;</span><br><span class="line">        JobStatus rescheduled = getRescheduleJobForFailure(jobStatus);</span><br><span class="line">        startTrackingJob(rescheduled, jobStatus);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (jobStatus.getJob().isPeriodic()) &#123;</span><br><span class="line">        JobStatus rescheduledPeriodic = getRescheduleJobForPeriodic(jobStatus);</span><br><span class="line">        startTrackingJob(rescheduledPeriodic, jobStatus);</span><br><span class="line">    &#125;</span><br><span class="line">    reportActive();</span><br><span class="line">    mHandler.obtainMessage(MSG_CHECK_JOB_GREEDY).sendToTarget();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里首先调用了 stopTrackingJob 将这个 job 从 JobStore 和 controller 中移除，因为之前已经移除过了，所以这个 stopTrackingJob 的返回值为 false<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Called when we want to remove a JobStatus object that we've finished executing. Returns the</span></span><br><span class="line"><span class="comment"> * object removed.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">stopTrackingJob</span><span class="params">(JobStatus jobStatus, JobStatus incomingJob,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> writeBack)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="comment">// Remove from store as well as controllers.</span></span><br><span class="line">        <span class="comment">// 尝试从 JobStore 中移除这个 job，注意，在之前已经移除过了，所以，这里的 removed 为 false！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> removed = mJobs.remove(jobStatus, writeBack);</span><br><span class="line">        <span class="keyword">if</span> (removed &amp;&amp; mReadyToRock) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;mControllers.size(); i++) &#123;</span><br><span class="line">                StateController controller = mControllers.get(i);</span><br><span class="line">                <span class="comment">// 从 Controller 的跟踪队列中移除！</span></span><br><span class="line">                controller.maybeStopTrackingJobLocked(jobStatus, incomingJob, <span class="keyword">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> removed;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看出，对于用户主动 cancel 的任务，无论 onStopJob 的返回值是什么，都不会 reschedule 了！</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2016/04/18/JobScheduler第 3 篇 - JobSchedulerService - schedule/">JobScheduler第 3 篇 - JobSchedulerService - schedule</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-04-18</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/AndroidFramework源码分析/">AndroidFramework源码分析</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/AndroidFramework源码分析/JobScheduler任务调度/">JobScheduler任务调度</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/JobScheduler任务调度/">JobScheduler任务调度</a></span><div class="content"><p>基于 Android 7.1.1 源码分析，本文为作者原创，转载请说明出处，谢谢。</p>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>我们先从基本的方法开始，也就是 schedule 方法，方法参数传递：</p>
<ul>
<li>JobInfo job：需要 schedule 的任务！</li>
<li>int uId：调用方的 uid！</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">schedule</span><span class="params">(JobInfo job, <span class="keyword">int</span> uId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> scheduleAsPackage(job, uId, <span class="keyword">null</span>, -<span class="number">1</span>, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">scheduleAsPackage</span><span class="params">(JobInfo job, <span class="keyword">int</span> uId, String packageName, <span class="keyword">int</span> userId, String tag)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建新的 jobStatus</span></span><br><span class="line">    JobStatus jobStatus = JobStatus.createFromJobInfo(job, uId, packageName, userId, tag);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (ActivityManagerNative.getDefault().getAppStartMode(uId,</span><br><span class="line">                job.getService().getPackageName()) == ActivityManager.APP_START_MODE_DISABLED) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Not scheduling job "</span> + uId + <span class="string">":"</span> + job.toString()</span><br><span class="line">                    + <span class="string">" -- package not allowed to start"</span>);</span><br><span class="line">            <span class="keyword">return</span> JobScheduler.RESULT_FAILURE;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG) Slog.d(TAG, <span class="string">"SCHEDULE: "</span> + jobStatus.toShortString());</span><br><span class="line">    JobStatus toCancel;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="comment">// 判断应用设置的任务数量是否超过上限：100</span></span><br><span class="line">        <span class="keyword">if</span> (ENFORCE_MAX_JOBS &amp;&amp; packageName == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mJobs.countJobsForUid(uId) &gt; MAX_JOBS_PER_APP) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Too many jobs for uid "</span> + uId);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Apps may not schedule more than "</span></span><br><span class="line">                            + MAX_JOBS_PER_APP + <span class="string">" distinct jobs"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果同一个id，之前已经注册了一个任务，取消上一个任务</span></span><br><span class="line">        toCancel = mJobs.getJobByUidAndJobId(uId, job.getId());</span><br><span class="line">        <span class="keyword">if</span> (toCancel != <span class="keyword">null</span>) &#123;</span><br><span class="line">            cancelJobImpl(toCancel, jobStatus);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 开始追踪该任务</span></span><br><span class="line">        startTrackingJob(jobStatus, toCancel);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 向 system_server 进程的主线程发送 message：MSG_CHECK_JOB</span></span><br><span class="line">    mHandler.obtainMessage(MSG_CHECK_JOB).sendToTarget();</span><br><span class="line">    <span class="keyword">return</span> JobScheduler.RESULT_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的 ENFORCE_MAX_JOBS 是一个 boolean 值，表示是否限制每个应用的 job 数！</p>
<blockquote>
<p>   private static final int MAX_JOBS_PER_APP = 100;</p>
</blockquote>
<p>这里 MAX_JOBS_PER_APP 表示每个应用最大的 Job 数！</p>
<p>这里总结一下 schedule 方法的主要流程：</p>
<ul>
<li>根据传入的 JobInfo，创建 JobStatus；</li>
<li>如果已经注册过一个相同 uid，相同 jobId 的 job，就取消之前注册过的；</li>
<li>将新 job 加入到 JobStore 中，并通知 controller 开始监控新 schedule 的 job！</li>
<li>发送 MSG_CHECK_JOB 消息给 JobHandler，执行 job！</li>
</ul>
<p>我们是使用 schedule 方法将我们需要的任务注册到系统中的，传入的参数主要是：</p>
<ul>
<li>JobInfo：封装任务的基本信息！</li>
<li>uId：调用者的 uid！</li>
</ul>
<p>我们接着来看，先调用 JobStatus 的 createFromJobInfo ，创建 JobStatus：</p>
<h1 id="1-JobStatus-createFromJobInfo"><a href="#1-JobStatus-createFromJobInfo" class="headerlink" title="1 JobStatus.createFromJobInfo"></a>1 JobStatus.createFromJobInfo</h1><p>参数传递：job, uId, null, -1, null：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> JobStatus <span class="title">createFromJobInfo</span><span class="params">(JobInfo job, <span class="keyword">int</span> callingUid, String sourcePackageName, <span class="keyword">int</span> sourceUserId, String tag)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 从开机到现在的时间</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> elapsedNow = SystemClock.elapsedRealtime();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> earliestRunTimeElapsedMillis, latestRunTimeElapsedMillis;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断这个任务是否是周期性的</span></span><br><span class="line">    <span class="keyword">if</span> (job.isPeriodic()) &#123;</span><br><span class="line">        latestRunTimeElapsedMillis = elapsedNow + job.getIntervalMillis();</span><br><span class="line">        earliestRunTimeElapsedMillis = latestRunTimeElapsedMillis - job.getFlexMillis();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        earliestRunTimeElapsedMillis = job.hasEarlyConstraint() ?</span><br><span class="line">                elapsedNow + job.getMinLatencyMillis() : NO_EARLIEST_RUNTIME;</span><br><span class="line">        latestRunTimeElapsedMillis = job.hasLateConstraint() ?</span><br><span class="line">                elapsedNow + job.getMaxExecutionDelayMillis() : NO_LATEST_RUNTIME;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建对应的 JobStatus 对象！</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> JobStatus(job, callingUid, sourcePackageName, sourceUserId, tag, <span class="number">0</span>,</span><br><span class="line">            earliestRunTimeElapsedMillis, latestRunTimeElapsedMillis);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里通过 JobInfo 创建了对应的 JobStatus 对象，参数传递：<br>job, uId, null, -1, null，0，earliestRunTimeElapsedMillis，latestRunTimeElapsedMillis。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">JobStatus</span><span class="params">(JobInfo job, <span class="keyword">int</span> callingUid, String sourcePackageName,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> sourceUserId, String tag, <span class="keyword">int</span> numFailures, <span class="keyword">long</span> earliestRunTimeElapsedMillis,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">long</span> latestRunTimeElapsedMillis)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.job = job;</span><br><span class="line">    <span class="keyword">this</span>.callingUid = callingUid;</span><br><span class="line">    <span class="keyword">int</span> tempSourceUid = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (sourceUserId != -<span class="number">1</span> &amp;&amp; sourcePackageName != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            tempSourceUid = AppGlobals.getPackageManager().getPackageUid(sourcePackageName, <span class="number">0</span>,</span><br><span class="line">                    sourceUserId);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">            <span class="comment">// Can't happen, PackageManager runs in the same process.</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (tempSourceUid == -<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.sourceUid = callingUid;</span><br><span class="line">        <span class="keyword">this</span>.sourceUserId = UserHandle.getUserId(callingUid);</span><br><span class="line">        <span class="keyword">this</span>.sourcePackageName = job.getService().getPackageName();</span><br><span class="line">        <span class="keyword">this</span>.sourceTag = <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.sourceUid = tempSourceUid;</span><br><span class="line">        <span class="keyword">this</span>.sourceUserId = sourceUserId;</span><br><span class="line">        <span class="keyword">this</span>.sourcePackageName = sourcePackageName;</span><br><span class="line">        <span class="keyword">this</span>.sourceTag = tag;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.batteryName = <span class="keyword">this</span>.sourceTag != <span class="keyword">null</span></span><br><span class="line">            ? <span class="keyword">this</span>.sourceTag + <span class="string">":"</span> + job.getService().getPackageName()</span><br><span class="line">            : job.getService().flattenToShortString();</span><br><span class="line">    <span class="keyword">this</span>.tag = <span class="string">"*job*/"</span> + <span class="keyword">this</span>.batteryName;</span><br><span class="line">    <span class="keyword">this</span>.earliestRunTimeElapsedMillis = earliestRunTimeElapsedMillis;</span><br><span class="line">    <span class="keyword">this</span>.latestRunTimeElapsedMillis = latestRunTimeElapsedMillis;</span><br><span class="line">    <span class="keyword">this</span>.numFailures = numFailures;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> requiredConstraints = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (job.getNetworkType() == JobInfo.NETWORK_TYPE_ANY) &#123;</span><br><span class="line">        requiredConstraints |= CONSTRAINT_CONNECTIVITY;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (job.getNetworkType() == JobInfo.NETWORK_TYPE_UNMETERED) &#123;</span><br><span class="line">        requiredConstraints |= CONSTRAINT_UNMETERED;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (job.getNetworkType() == JobInfo.NETWORK_TYPE_NOT_ROAMING) &#123;</span><br><span class="line">        requiredConstraints |= CONSTRAINT_NOT_ROAMING;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (job.isRequireCharging()) &#123;</span><br><span class="line">        requiredConstraints |= CONSTRAINT_CHARGING;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (earliestRunTimeElapsedMillis != NO_EARLIEST_RUNTIME) &#123;</span><br><span class="line">        requiredConstraints |= CONSTRAINT_TIMING_DELAY;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (latestRunTimeElapsedMillis != NO_LATEST_RUNTIME) &#123;</span><br><span class="line">        requiredConstraints |= CONSTRAINT_DEADLINE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (job.isRequireDeviceIdle()) &#123;</span><br><span class="line">        requiredConstraints |= CONSTRAINT_IDLE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (job.getTriggerContentUris() != <span class="keyword">null</span>) &#123;</span><br><span class="line">        requiredConstraints |= CONSTRAINT_CONTENT_TRIGGER;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.requiredConstraints = requiredConstraints;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们后面会详细的开一篇，来讲讲这些参数的，这里先不看！</p>
<h1 id="2-JobStore-countJobsForUid"><a href="#2-JobStore-countJobsForUid" class="headerlink" title="2 JobStore.countJobsForUid"></a>2 JobStore.countJobsForUid</h1><p>这里是统计 uid 对用的应用有多少个任务：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">countJobsForUid</span><span class="params">(<span class="keyword">int</span> uid)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mJobSet.countJobsForUid(uid);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>JobStore 有一个集合，用来存放所有的 Job！</p>
<blockquote>
<p>final JobSet mJobSet;</p>
</blockquote>
<p>我们来看看这个 JobSet<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">JobSet</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Key is the getUid() originator of the jobs in each sheaf</span></span><br><span class="line">    <span class="comment">// mJobs 的 key 是应用的 uid！</span></span><br><span class="line">    <span class="keyword">private</span> SparseArray&lt;ArraySet&lt;JobStatus&gt;&gt; mJobs;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JobSet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mJobs = <span class="keyword">new</span> SparseArray&lt;ArraySet&lt;JobStatus&gt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    ... ... ... ...</span><br><span class="line">    <span class="comment">// We only want to count the jobs that this uid has scheduled on its own</span></span><br><span class="line">    <span class="comment">// behalf, not those that the app has scheduled on someone else's behalf.</span></span><br><span class="line">    <span class="comment">// 统计 uid 对应的应用注册的任务数！</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">countJobsForUid</span><span class="params">(<span class="keyword">int</span> uid)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> total = <span class="number">0</span>;</span><br><span class="line">        ArraySet&lt;JobStatus&gt; jobs = mJobs.get(uid);</span><br><span class="line">        <span class="keyword">if</span> (jobs != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = jobs.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">                JobStatus job = jobs.valueAt(i);</span><br><span class="line">                <span class="keyword">if</span> (job.getUid() == job.getSourceUid()) &#123;</span><br><span class="line">                    total++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> total;</span><br><span class="line">    &#125;</span><br><span class="line">    ... ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>JobSet 有很多的其他方法：getJobsByXXX，add，remove，getXXX，等等的方法，这里我们先不看！</p>
<h1 id="3-JobStore-getJobByUidAndJobId"><a href="#3-JobStore-getJobByUidAndJobId" class="headerlink" title="3 JobStore.getJobByUidAndJobId"></a>3 JobStore.getJobByUidAndJobId</h1><p>接着是根据 uid 和 jobId，来获得一个任务，这里的目的是判断是否之前已经注册过了一个相同的任务：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> JobStatus <span class="title">getJobByUidAndJobId</span><span class="params">(<span class="keyword">int</span> uid, <span class="keyword">int</span> jobId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mJobSet.get(uid, jobId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>还是调用的是 JobSet.get 方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> JobStatus <span class="title">get</span><span class="params">(<span class="keyword">int</span> uid, <span class="keyword">int</span> jobId)</span> </span>&#123;</span><br><span class="line">    ArraySet&lt;JobStatus&gt; jobs = mJobs.get(uid);</span><br><span class="line">    <span class="keyword">if</span> (jobs != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = jobs.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">            JobStatus job = jobs.valueAt(i);</span><br><span class="line">            <span class="keyword">if</span> (job.getJobId() == jobId) &#123;</span><br><span class="line">                <span class="keyword">return</span> job;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个很简单，不详细说了！</p>
<h1 id="4-JSS-cancelJobImpl"><a href="#4-JSS-cancelJobImpl" class="headerlink" title="4 JSS.cancelJobImpl"></a>4 JSS.cancelJobImpl</h1><p>如果之前已经注册过一个任务了，需要先取消掉之前的任务！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">cancelJobImpl</span><span class="params">(JobStatus cancelled, JobStatus incomingJob)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG) Slog.d(TAG, <span class="string">"CANCEL: "</span> + cancelled.toShortString());</span><br><span class="line">    <span class="comment">// 停止追踪任务!</span></span><br><span class="line">    stopTrackingJob(cancelled, incomingJob, <span class="keyword">true</span> <span class="comment">/* writeBack */</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 如果这个任务在等待队列中，移除它。</span></span><br><span class="line">        <span class="keyword">if</span> (mPendingJobs.remove(cancelled)) &#123;</span><br><span class="line">            mJobPackageTracker.noteNonpending(cancelled);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 如果正在运行，取消这个任务！</span></span><br><span class="line">        stopJobOnServiceContextLocked(cancelled, JobParameters.REASON_CANCELED);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 更新 jss 的状态！</span></span><br><span class="line">        reportActive();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里主要做的是：停止对这个任务的监视，同时，将这个任务移除等待队列，如果这个任务正在运行，那么就要取消它，我们一个一个来看！</p>
<h2 id="4-1-JSS-stopTrackingJob"><a href="#4-1-JSS-stopTrackingJob" class="headerlink" title="4.1 JSS.stopTrackingJob"></a>4.1 JSS.stopTrackingJob</h2><p>我们先来看第一个方法，参数传递：</p>
<ul>
<li>JobStatus jobStatus：要被取消的任务；</li>
<li>JobStatus incomingJob：本次要注册的任务；</li>
<li>boolean writeBack：true；</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">stopTrackingJob</span><span class="params">(JobStatus jobStatus, JobStatus incomingJob,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> writeBack)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 从 JobStore 和 controller 的监控队列中移除这个 job！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> removed = mJobs.remove(jobStatus, writeBack);</span><br><span class="line">        <span class="keyword">if</span> (removed &amp;&amp; mReadyToRock) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;mControllers.size(); i++) &#123;</span><br><span class="line">                StateController controller = mControllers.get(i);</span><br><span class="line">                <span class="comment">// 停止 job 监控！</span></span><br><span class="line">                controller.maybeStopTrackingJobLocked(jobStatus, incomingJob, <span class="keyword">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> removed;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的 mJobs 是 JobStore 对象！</p>
<h3 id="4-1-1-JobStore-remove"><a href="#4-1-1-JobStore-remove" class="headerlink" title="4.1.1 JobStore.remove"></a>4.1.1 JobStore.remove</h3><p>我们来看看这个移除操作：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">remove</span><span class="params">(JobStatus jobStatus, <span class="keyword">boolean</span> writeBack)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 先从 mJobSet 中移除要删除的 JobStatus！</span></span><br><span class="line">    <span class="keyword">boolean</span> removed = mJobSet.remove(jobStatus);</span><br><span class="line">    <span class="keyword">if</span> (!removed) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">            Slog.d(TAG, <span class="string">"Couldn't remove job: didn't exist: "</span> + jobStatus);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果 writeBack 是 true，并且 jobStatus 是 isPersisted 的，那就要更新 Jobs.xml 文件！</span></span><br><span class="line">    <span class="keyword">if</span> (writeBack &amp;&amp; jobStatus.isPersisted()) &#123;</span><br><span class="line">        maybeWriteStatusToDiskAsync();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> removed;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>从 JobSet 集合中移除 Job，并且，如果需要写入操作，并且这个 Job 是设备重启后仍然需要保留的，那就要调用 remove 方法，将更新后的 JobSet 写入到 system/job/jobs.xml，因为所有 Persisted 为 true 的 Job ，都是会被写入到这个文件中去的，用于重启恢复！！</p>
<p>我们来看 maybeWriteStatusToDiskAsync 方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">maybeWriteStatusToDiskAsync</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mDirtyOperations++;</span><br><span class="line">    <span class="keyword">if</span> (mDirtyOperations &gt;= MAX_OPS_BEFORE_WRITE) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">            Slog.v(TAG, <span class="string">"Writing jobs to disk."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        mIoHandler.post(<span class="keyword">new</span> WriteJobsMapToDiskRunnable());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">... ... ... ... ... ...</span><br><span class="line"> </span><br><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">WriteJobsMapToDiskRunnable</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> startElapsed = SystemClock.elapsedRealtime();</span><br><span class="line">        <span class="keyword">final</span> List&lt;JobStatus&gt; storeCopy = <span class="keyword">new</span> ArrayList&lt;JobStatus&gt;();</span><br><span class="line">        <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">            <span class="comment">// Clone the jobs so we can release the lock before writing.</span></span><br><span class="line">            <span class="comment">// 这里是将 mJobSet 拷贝一份到 storeCopy 中。</span></span><br><span class="line">            mJobSet.forEachJob(<span class="keyword">new</span> JobStatusFunctor() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(JobStatus job)</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">if</span> (job.isPersisted()) &#123;</span><br><span class="line">                        storeCopy.add(<span class="keyword">new</span> JobStatus(job));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 将更新后的拷贝写入 jobs.xml。</span></span><br><span class="line">        writeJobsMapImpl(storeCopy);</span><br><span class="line">        <span class="keyword">if</span> (JobSchedulerService.DEBUG) &#123;</span><br><span class="line">            Slog.v(TAG, <span class="string">"Finished writing, took "</span> + (SystemClock.elapsedRealtime()</span><br><span class="line">                    - startElapsed) + <span class="string">"ms"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ... ... ... ... </span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们接着看！</p>
<h3 id="4-1-2-SC-maybeStopTrackingJobLocked"><a href="#4-1-2-SC-maybeStopTrackingJobLocked" class="headerlink" title="4.1.2 SC.maybeStopTrackingJobLocked"></a>4.1.2 SC.maybeStopTrackingJobLocked</h3><p>接着，就是遍历控制器集合，让控制器停止对该任务的监视，参数传递：</p>
<ul>
<li>JobStatus jobStatus：要被删除的 Job！</li>
<li>JobStatus incomingJob：同一个 uid，同一个 jobId 的要被注册执行的 Job！</li>
<li>boolean forUpdate：false</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Remove task - this will happen if the task is cancelled, completed, etc.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">maybeStopTrackingJobLocked</span><span class="params">(JobStatus jobStatus, JobStatus incomingJob,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> forUpdate)</span></span>;</span><br></pre></td></tr></table></figure>
<p>StateController 是一个抽象类，具体的实现，我们在 JobSchedulerService 的构造器中有看到：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mControllers.add(ConnectivityController.get(<span class="keyword">this</span>));</span><br><span class="line">mControllers.add(TimeController.get(<span class="keyword">this</span>));</span><br><span class="line">mControllers.add(IdleController.get(<span class="keyword">this</span>));</span><br><span class="line">mControllers.add(BatteryController.get(<span class="keyword">this</span>));</span><br><span class="line">mControllers.add(AppIdleController.get(<span class="keyword">this</span>));</span><br><span class="line">mControllers.add(ContentObserverController.get(<span class="keyword">this</span>));</span><br><span class="line">mControllers.add(DeviceIdleJobsController.get(<span class="keyword">this</span>));</span><br></pre></td></tr></table></figure></p>
<p>这里有很多的控制器：</p>
<h4 id="4-1-2-1-ConnectivityController"><a href="#4-1-2-1-ConnectivityController" class="headerlink" title="4.1.2.1 ConnectivityController"></a>4.1.2.1 ConnectivityController</h4><p>我们先来看看 ConnectivityController 类的方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">maybeStopTrackingJobLocked</span><span class="params">(JobStatus jobStatus, JobStatus incomingJob,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> forUpdate)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (jobStatus.hasConnectivityConstraint() || jobStatus.hasUnmeteredConstraint()</span><br><span class="line">            || jobStatus.hasNotRoamingConstraint()) &#123;</span><br><span class="line">        mTrackedJobs.remove(jobStatus);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>其他控制器的方法很类似的哦！</p>
<h2 id="4-2-JobPackageTracker-noteNonpending"><a href="#4-2-JobPackageTracker-noteNonpending" class="headerlink" title="4.2 JobPackageTracker.noteNonpending"></a>4.2 JobPackageTracker.noteNonpending</h2><p>这个就是这样的<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">noteNonpending</span><span class="params">(JobStatus job)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> now = SystemClock.uptimeMillis();</span><br><span class="line">    mCurDataSet.decPending(job.getSourceUid(), job.getSourcePackageName(), now);</span><br><span class="line">    rebatchIfNeeded(now);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里我们先不看！</p>
<h2 id="4-3-JSS-stopJobOnServiceContextLocked"><a href="#4-3-JSS-stopJobOnServiceContextLocked" class="headerlink" title="4.3 JSS.stopJobOnServiceContextLocked"></a>4.3 JSS.stopJobOnServiceContextLocked</h2><p>如果 Job 有在运行，那就停止它，参数传递：cancelled, JobParameters.REASON_CANCELED<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">stopJobOnServiceContextLocked</span><span class="params">(JobStatus job, <span class="keyword">int</span> reason)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 遍历 mActiveServices 集合；</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;mActiveServices.size(); i++) &#123;</span><br><span class="line">        JobServiceContext jsc = mActiveServices.get(i);</span><br><span class="line">        <span class="keyword">final</span> JobStatus executing = jsc.getRunningJob();</span><br><span class="line">        <span class="comment">// 找到匹配的 jobStatus 对象；</span></span><br><span class="line">        <span class="keyword">if</span> (executing != <span class="keyword">null</span> &amp;&amp; executing.matches(job.getUid(), job.getJobId())) &#123;</span><br><span class="line">            jsc.cancelExecutingJob(reason);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里调用了 JobServiceContext 的 cancelExecutingJob 这个方法，取消正在运行中的 job！</p>
<h3 id="4-3-1-JobServiceContext-cancelExecutingJob"><a href="#4-3-1-JobServiceContext-cancelExecutingJob" class="headerlink" title="4.3.1 JobServiceContext.cancelExecutingJob"></a>4.3.1 JobServiceContext.cancelExecutingJob</h3><p>我们进入 JobServiceContext 文件中来看看：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Called externally when a job that was scheduled for execution should be cancelled. */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cancelExecutingJob</span><span class="params">(<span class="keyword">int</span> reason)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发送一个 MSG_CANCEL 消息给 JobServiceHandler！</span></span><br><span class="line">    mCallbackHandler.obtainMessage(MSG_CANCEL, reason, <span class="number">0</span> <span class="comment">/* unused */</span>).sendToTarget();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>其中：mCallbackHandler = new JobServiceHandler(looper)，这里的 looper 是 system_server 的主线程的 looper，这个在第二篇初始化和启动就可以看到！</p>
<p>这里我们向 JobServiceHandler 发送了一个 MSG_CANCEL 的消息，我们去看看：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">JobServiceHandler</span>！ <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message message)</span> </span>&#123;</span><br><span class="line">          <span class="keyword">switch</span> (message.what) &#123;</span><br><span class="line"></span><br><span class="line">              ... ... ... ...</span><br><span class="line"></span><br><span class="line">              <span class="comment">// 收到 MSG_CANCEL 的消息！</span></span><br><span class="line">              <span class="keyword">case</span> MSG_CANCEL:</span><br><span class="line">                  <span class="comment">// 如果这个 Job，已经完成了，就不处理！</span></span><br><span class="line">                  <span class="keyword">if</span> (mVerb == VERB_FINISHED) &#123;</span><br><span class="line">                      <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                          Slog.d(TAG, <span class="string">"Trying to process cancel for torn-down context, ignoring."</span>);</span><br><span class="line">                      &#125;</span><br><span class="line">                      <span class="keyword">return</span>;</span><br><span class="line">                  &#125;</span><br><span class="line"></span><br><span class="line">                  <span class="comment">// 保存停止的原因！</span></span><br><span class="line">                  mParams.setStopReason(message.arg1);</span><br><span class="line">                  <span class="keyword">if</span> (message.arg1 == JobParameters.REASON_PREEMPT) &#123;</span><br><span class="line">                      <span class="comment">// 如果原因是因为优先级取代，就用 mPreferredUid 保存被取代的 job 的 uid！</span></span><br><span class="line">                      mPreferredUid = mRunningJob != <span class="keyword">null</span> ? mRunningJob.getUid() :</span><br><span class="line">                              NO_PREFERRED_UID;</span><br><span class="line">                  &#125;</span><br><span class="line">                  </span><br><span class="line">                  <span class="comment">// 执行取消任务～</span></span><br><span class="line">                  handleCancelH();</span><br><span class="line">                  <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">              <span class="keyword">case</span> MSG_TIMEOUT:</span><br><span class="line">                  handleOpTimeoutH();</span><br><span class="line">                  <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">              <span class="keyword">case</span> MSG_SHUTDOWN_EXECUTION:</span><br><span class="line">                  closeAndCleanupJobH(<span class="keyword">true</span> <span class="comment">/* needsReschedule */</span>);</span><br><span class="line">                  <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">              <span class="keyword">default</span>:</span><br><span class="line">                  Slog.e(TAG, <span class="string">"Unrecognised message: "</span> + message);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">  ... ... ... ...</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们进入到 handleCancelH 方法中来看看：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleCancelH</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (JobSchedulerService.DEBUG) &#123;</span><br><span class="line">        Slog.d(TAG, <span class="string">"Handling cancel for: "</span> + mRunningJob.getJobId() + <span class="string">" "</span></span><br><span class="line">                + VERB_STRINGS[mVerb]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">switch</span> (mVerb) &#123; <span class="comment">// 判断当前的 job 的状态！</span></span><br><span class="line">        <span class="keyword">case</span> VERB_BINDING:</span><br><span class="line">        <span class="keyword">case</span> VERB_STARTING:</span><br><span class="line">            <span class="comment">// 将变量 mCancelled 置为 true；</span></span><br><span class="line">            mCancelled.set(<span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> VERB_EXECUTING:</span><br><span class="line">            <span class="comment">// 如果当前的 job 是正在执行状态，就先判断应用是否调用过 jobFinished 主动结束任务</span></span><br><span class="line">            <span class="comment">// 如果有，就取消这次 cancel！</span></span><br><span class="line">            <span class="keyword">if</span> (hasMessages(MSG_CALLBACK)) &#123;</span><br><span class="line">                <span class="comment">// If the client has called jobFinished, ignore this cancel.</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 发送停止的消息！</span></span><br><span class="line">            sendStopMessageH();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> VERB_STOPPING:</span><br><span class="line">            <span class="comment">// Nada.</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            Slog.e(TAG, <span class="string">"Cancelling a job without a valid verb: "</span> + mVerb);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>mVerb 使用来保存 Job 的状态的，一个 Job 在 JobServiceContext 中会有如下的几种状态：</p>
<pre><code>static final int VERB_BINDING = 0;
static final int VERB_STARTING = 1;
static final int VERB_EXECUTING = 2;
static final int VERB_STOPPING = 3;
static final int VERB_FINISHED = 4;
</code></pre><p>这里我先不看！</p>
<h2 id="4-4-JSS-reportActive"><a href="#4-4-JSS-reportActive" class="headerlink" title="4.4 JSS.reportActive"></a>4.4 JSS.reportActive</h2><p>最后，调用 reportActive 方法，通知 JSS 的状态！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">reportActive</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// active is true if pending queue contains jobs OR some job is running.</span></span><br><span class="line">    <span class="keyword">boolean</span> active = mPendingJobs.size() &gt; <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (mPendingJobs.size() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;mActiveServices.size(); i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> JobServiceContext jsc = mActiveServices.get(i);</span><br><span class="line">            <span class="keyword">final</span> JobStatus job = jsc.getRunningJob();</span><br><span class="line">            <span class="keyword">if</span> (job != <span class="keyword">null</span></span><br><span class="line">                    &amp;&amp; (job.getJob().getFlags() &amp; JobInfo.FLAG_WILL_BE_FOREGROUND) == <span class="number">0</span></span><br><span class="line">                    &amp;&amp; !job.dozeWhitelisted) &#123;</span><br><span class="line">                <span class="comment">// We will report active if we have a job running and it is not an exception</span></span><br><span class="line">                <span class="comment">// due to being in the foreground or whitelisted.</span></span><br><span class="line">                active = <span class="keyword">true</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当状态发生改变时，通知 DeviceIdleController 当前 JSS 的状态！</span></span><br><span class="line">    <span class="keyword">if</span> (mReportedActive != active) &#123;</span><br><span class="line">        mReportedActive = active;</span><br><span class="line">        <span class="keyword">if</span> (mLocalDeviceIdleController != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mLocalDeviceIdleController.setJobsActive(active);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个 reportActive 是将 JSS 的状态通知给 DeviceIdleController，用于 DOZE 模式，这里简单介绍下 DOZE 模式：</p>
<p>当用户在连续的一段时间内没有使用手机，就延缓终端中 APP 后台的CPU和网络活动，以达到减少电量消耗的目的，这时就进入 DOZE 模式，进入 DOZE 模式后的系统有如下约束：</p>
<ul>
<li>暂停网络访问。 </li>
<li>系统忽略所有的 WakeLock。 </li>
<li>标准的 AlarmManager alarms 被延缓到下一个 maintenance window。 <ul>
<li>但使用 AlarmManager 的 setAndAllowWhileIdle、setExactAndAllowWhileIdle 和 setAlarmClock 时，alarms 定义的事件仍会启动，在这些 alarms 启动前，系统会短暂地退出Doze模式。 </li>
</ul>
</li>
<li>系统不再进行 WiFi 扫描。 </li>
<li>系统不允许 sync adapters 运行。 </li>
<li><strong>系统不允许 JobScheduler 运行</strong>。</li>
</ul>
<p>注意到最后一条了吧，这个就是 reportActive 的意义，我们继续看：</p>
<h1 id="5-JSS-startTrackingJob"><a href="#5-JSS-startTrackingJob" class="headerlink" title="5 JSS.startTrackingJob"></a>5 JSS.startTrackingJob</h1><p>接下来，就是开始 track 任务，参数传递：</p>
<ul>
<li>JobStatus jobStatus：本次注册的 job！</li>
<li>JobStatus lastJob：同一个 uid，同一个 jobId，上次注册的已经被取消的任务，可以为 null！</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startTrackingJob</span><span class="params">(JobStatus jobStatus, JobStatus lastJob)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 添加到 JobStore 中!</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> update = mJobs.add(jobStatus);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mReadyToRock) &#123;</span><br><span class="line">            <span class="comment">// 遍历控制器，执行监控操作！</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mControllers.size(); i++) &#123;</span><br><span class="line">                StateController controller = mControllers.get(i);</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span> (update) &#123; <span class="comment">// 发生了相同 uid 和 jobId 的取代操作，先停止对旧的 job 的监控！</span></span><br><span class="line">                    controller.maybeStopTrackingJobLocked(jobStatus, <span class="keyword">null</span>, <span class="keyword">true</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 监控新的 jobStatus！</span></span><br><span class="line">                controller.maybeStartTrackingJobLocked(jobStatus, lastJob);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第一步，可以看到，先将这一次要注册执行的任务，加入到 JobStore 中：</p>
<h2 id="5-1-JobStore-add"><a href="#5-1-JobStore-add" class="headerlink" title="5.1 JobStore.add"></a>5.1 JobStore.add</h2><p>这里是将要好注册执行的 Job 添加到 JobStore 中，这里和上面有些类似：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(JobStatus jobStatus)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 取代之前已经被添加过相同 uid 和 jobId 的 jobStatus！</span></span><br><span class="line">    <span class="keyword">boolean</span> replaced = mJobSet.remove(jobStatus);</span><br><span class="line">    <span class="comment">// 将新的 job 添加到 JobSets 集合中！</span></span><br><span class="line">    mJobSet.add(jobStatus);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (jobStatus.isPersisted()) &#123; <span class="comment">// 如果是 persist 类型的 job，还需要写到 Job.xml 文件中去！</span></span><br><span class="line">        maybeWriteStatusToDiskAsync();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">        Slog.d(TAG, <span class="string">"Added job status to store: "</span> + jobStatus);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> replaced; <span class="comment">// 返回是否有取代发生！</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>返回值表示是否有取代发生，在 add 的过程中，会判断是否有相同 uid 和 jobId 的 jobStatus 存在，如果有，就要取代之前的！</p>
<p>如果这个 Job 是 isPersisted 的，那就需要更新 Jobs.xml 文件！</p>
<h2 id="5-2-SC-maybeStopTrackingJobLocked"><a href="#5-2-SC-maybeStopTrackingJobLocked" class="headerlink" title="5.2 SC.maybeStopTrackingJobLocked"></a>5.2 SC.maybeStopTrackingJobLocked</h2><p>这里先要停止 track 这个任务，参数传递：</p>
<ul>
<li>JobStatus jobStatus：要被注册执行的新的 Job！</li>
<li>JobStatus incomingJob：null</li>
<li>boolean forUpdate：true<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Remove task - this will happen if the task is cancelled, completed, etc.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">maybeStopTrackingJobLocked</span><span class="params">(JobStatus jobStatus, JobStatus incomingJob,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> forUpdate)</span></span>;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>具体的实现代码是在每个 Controller 中实现的，我们来看一个最简单的 Controller：</p>
<h3 id="5-2-1-ConnectivityController"><a href="#5-2-1-ConnectivityController" class="headerlink" title="5.2.1 ConnectivityController"></a>5.2.1 ConnectivityController</h3><p>代码如下，逻辑很简单：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">maybeStopTrackingJobLocked</span><span class="params">(JobStatus jobStatus, JobStatus incomingJob,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> forUpdate)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (jobStatus.hasConnectivityConstraint() || jobStatus.hasUnmeteredConstraint()</span><br><span class="line">            || jobStatus.hasNotRoamingConstraint()) &#123;</span><br><span class="line">        <span class="comment">// 从监控列表中移除这个 job！</span></span><br><span class="line">        mTrackedJobs.remove(jobStatus);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>接着看：</p>
<h2 id="5-3-SC-maybeStartTrackingJobLocked"><a href="#5-3-SC-maybeStartTrackingJobLocked" class="headerlink" title="5.3 SC.maybeStartTrackingJobLocked"></a>5.3 SC.maybeStartTrackingJobLocked</h2><p>接着，调用这个方法，来开始 track 任务，方法参数：</p>
<ul>
<li>JobStatus jobStatus：这次要注册的任务</li>
<li>JobStatus lastJob：同一个 uid，同一个 jobId 已经被取消掉的上一个任务，可以为 null！</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">maybeStartTrackingJobLocked</span><span class="params">(JobStatus jobStatus, JobStatus lastJob)</span></span>;</span><br></pre></td></tr></table></figure>
<p>这里同样是一个抽象接口，具体的实现是子类：</p>
<h3 id="5-3-1-ConnectivityController"><a href="#5-3-1-ConnectivityController" class="headerlink" title="5.3.1 ConnectivityController"></a>5.3.1 ConnectivityController</h3><p>让我们来看看 ConnectivityController 对象的这个方法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void maybeStartTrackingJobLocked(JobStatus jobStatus, JobStatus lastJob) &#123;</span><br><span class="line">    if (jobStatus.hasConnectivityConstraint() || jobStatus.hasUnmeteredConstraint()</span><br><span class="line">            || jobStatus.hasNotRoamingConstraint()) &#123;</span><br><span class="line">        // 判断当前的 job 约束条件是否满足，如果满足，就可以立即执行！</span><br><span class="line">        updateConstraintsSatisfied(jobStatus);</span><br><span class="line">        // 将这个 Job 添加到 ConnectivityController 的跟踪列表中！</span><br><span class="line">        mTrackedJobs.add(jobStatus);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>首先，判断 Job 是否有设置和 Connectivity 网络相关的属性：</p>
<ul>
<li>jobStatus.hasConnectivityConstraint()</li>
<li>jobStatus.hasUnmeteredConstraint()</li>
<li>jobStatus.hasNotRoamingConstraint()</li>
</ul>
<p>调用了 updateConstraintsSatisfied 方法来判断当前的约束条件是否满足，同时更新 JobStatus 的状态！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">updateConstraintsSatisfied</span> <span class="params">(JobStatus jobStatus)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> ignoreBlocked = (jobStatus.getFlags() &amp; JobInfo.FLAG_WILL_BE_FOREGROUND) != <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 获得当前的网络状态信息：NetworkInfo</span></span><br><span class="line">    <span class="keyword">final</span> NetworkInfo info = mConnManager.getActiveNetworkInfoForUid(jobStatus.getSourceUid(),</span><br><span class="line">            ignoreBlocked);</span><br><span class="line">    <span class="comment">// 判断约束条件是否满足；</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> connected = (info != <span class="keyword">null</span>) &amp;&amp; info.isConnected();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> unmetered = connected &amp;&amp; !info.isMetered();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> notRoaming = connected &amp;&amp; !info.isRoaming();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> changed = <span class="keyword">false</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 根据约束条件来更新 JobStatus 的信息！ </span></span><br><span class="line">    changed |= jobStatus.setConnectivityConstraintSatisfied(connected);</span><br><span class="line">    changed |= jobStatus.setUnmeteredConstraintSatisfied(unmetered);</span><br><span class="line">    changed |= jobStatus.setNotRoamingConstraintSatisfied(notRoaming);</span><br><span class="line">    <span class="keyword">return</span> changed;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>返回的 changed 表示：约束条件是否变化！</p>
<p>最后将 jobStatus 加入到指定的 Controller 的监控列表中！</p>
<h1 id="6-JSS-JobHandler-MSG-CHECK-JOB"><a href="#6-JSS-JobHandler-MSG-CHECK-JOB" class="headerlink" title="6 [JSS.JobHandler].MSG_CHECK_JOB"></a>6 [JSS.JobHandler].MSG_CHECK_JOB</h1><p>接着，就是向 JobHandler 发送了 MSG_CHECK_JOB 的消息，我们来看看：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">    private class JobHandler extends Handler &#123;</span><br><span class="line">        public JobHandler(Looper looper) &#123;</span><br><span class="line">            super(looper);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void handleMessage(Message message) &#123;</span><br><span class="line">            synchronized (mLock) &#123;</span><br><span class="line">                if (!mReadyToRock) &#123;</span><br><span class="line">                    return;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            switch (message.what) &#123;</span><br><span class="line">                case MSG_JOB_EXPIRED:</span><br><span class="line">                    ... ... ... ...</span><br><span class="line">                    break;</span><br><span class="line"></span><br><span class="line">                case MSG_CHECK_JOB: // 接收到 MSG_CHECK_JOB 的消息！</span><br><span class="line">                    synchronized (mLock) &#123;</span><br><span class="line">                        if (mReportedActive) &#123; // 为 true，表示 JSS 通知了设备管理器，自己处于活跃状态！</span><br><span class="line">                            // if jobs are currently being run, queue all ready jobs for execution.</span><br><span class="line">                            queueReadyJobsForExecutionLockedH();</span><br><span class="line">                        &#125; else &#123;</span><br><span class="line">                            // Check the list of jobs and run some of them if we feel inclined.</span><br><span class="line">                            maybeQueueReadyJobsForExecutionLockedH();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    break;</span><br><span class="line"></span><br><span class="line">                case MSG_CHECK_JOB_GREEDY:</span><br><span class="line">                    synchronized (mLock) &#123;</span><br><span class="line">                        queueReadyJobsForExecutionLockedH();</span><br><span class="line">                    &#125;</span><br><span class="line">                    break;</span><br><span class="line"></span><br><span class="line">                case MSG_STOP_JOB:</span><br><span class="line">                    cancelJobImpl((JobStatus)message.obj, null);</span><br><span class="line">                    break;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            // 处理 mPendingJobs 中的任务！</span><br><span class="line">            maybeRunPendingJobsH();</span><br><span class="line"></span><br><span class="line">            // Don&apos;t remove JOB_EXPIRED in case one came along while processing the queue.</span><br><span class="line">            removeMessages(MSG_CHECK_JOB); </span><br><span class="line">        &#125;</span><br><span class="line">        ... ... ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>mReportActive 为 true 的情况：<br>有等待中的 job （mPendingJobs.size 大于 0）或者有正在执行中的 job （JobServiceContext.getRunningJob 不为 null）</p>
<p>接着，收到了 MSG_CHECK_JOB 的消息，开始遍历队列，执行准备好的任务！</p>
<h2 id="6-1-queueReadyJobsForExecutionLockedH"><a href="#6-1-queueReadyJobsForExecutionLockedH" class="headerlink" title="6.1 queueReadyJobsForExecutionLockedH"></a>6.1 queueReadyJobsForExecutionLockedH</h2><p>当 mReport 下面是这个方法的代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">queueReadyJobsForExecutionLockedH</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">        Slog.d(TAG, <span class="string">"queuing all ready jobs for execution:"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    noteJobsNonpending(mPendingJobs);</span><br><span class="line">    mPendingJobs.clear();</span><br><span class="line">    mJobs.forEachJob(mReadyQueueFunctor);</span><br><span class="line">    mReadyQueueFunctor.postProcess();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> queuedJobs = mPendingJobs.size();</span><br><span class="line">        <span class="keyword">if</span> (queuedJobs == <span class="number">0</span>) &#123;</span><br><span class="line">            Slog.d(TAG, <span class="string">"No jobs pending."</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Slog.d(TAG, queuedJobs + <span class="string">" jobs queued."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个方法和 maybeQueueReadyJobsForExecutionLockedH 很类似，我们先来看下面的这个方法：</p>
<h2 id="6-2-maybeQueueReadyJobsForExecutionLockedH"><a href="#6-2-maybeQueueReadyJobsForExecutionLockedH" class="headerlink" title="6.2 maybeQueueReadyJobsForExecutionLockedH"></a>6.2 maybeQueueReadyJobsForExecutionLockedH</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">maybeQueueReadyJobsForExecutionLockedH</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG) Slog.d(TAG, <span class="string">"Maybe queuing ready jobs..."</span>);</span><br><span class="line">    noteJobsNonpending(mPendingJobs);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 先清空 mPendingJobs 集合!</span></span><br><span class="line">    mPendingJobs.clear();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将准备好的 Job 加入到 JobHandler 内部的 runnableJobs 集合中。</span></span><br><span class="line">    mJobs.forEachJob(mMaybeQueueFunctor);</span><br><span class="line">    <span class="comment">// 将 runnableJobs 加入到 mPendingJobs 集合中!</span></span><br><span class="line">    mMaybeQueueFunctor.postProcess();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="6-2-1-mPendingJobs-clear"><a href="#6-2-1-mPendingJobs-clear" class="headerlink" title="6.2.1 mPendingJobs.clear"></a>6.2.1 mPendingJobs.clear</h3><p>首先清除了：mPendingJobs 集合，为这次执行做准备：</p>
<blockquote>
<p>mPendingJobs.clear();</p>
</blockquote>
<p>接着，这里传入了 mMaybeQueueFunctor 对象！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">forEachJob</span><span class="params">(JobStatusFunctor functor)</span> </span>&#123;</span><br><span class="line">    mJobSet.forEachJob(functor);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>进入了 JobSet：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">forEachJob</span><span class="params">(JobStatusFunctor functor)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> uidIndex = mJobs.size() - <span class="number">1</span>; uidIndex &gt;= <span class="number">0</span>; uidIndex--) &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 遍历 JobStore 中的所有 job！</span></span><br><span class="line">        ArraySet&lt;JobStatus&gt; jobs = mJobs.valueAt(uidIndex);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = jobs.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        </span><br><span class="line">            <span class="comment">// 对每个 uid 的应用程序的 Job，执行下面操作：</span></span><br><span class="line">            functor.process(jobs.valueAt(i));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看出，这对所有的 Job，都调用了 MaybeReadyJobQueueFunctor 的 process 方法：</p>
<h3 id="6-2-2-MaybeReadyJobQueueFunctor-process"><a href="#6-2-2-MaybeReadyJobQueueFunctor-process" class="headerlink" title="6.2.2 MaybeReadyJobQueueFunctor.process"></a>6.2.2 MaybeReadyJobQueueFunctor.process</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MaybeReadyJobQueueFunctor</span> <span class="keyword">implements</span> <span class="title">JobStatusFunctor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> chargingCount;</span><br><span class="line">    <span class="keyword">int</span> idleCount;</span><br><span class="line">    <span class="keyword">int</span> backoffCount;</span><br><span class="line">    <span class="keyword">int</span> connectivityCount;</span><br><span class="line">    <span class="keyword">int</span> contentCount;</span><br><span class="line">    </span><br><span class="line">    List&lt;JobStatus&gt; runnableJobs; <span class="comment">// 符合条件的即将运行的 Job</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MaybeReadyJobQueueFunctor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        reset();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Functor method invoked for each job via JobStore.forEachJob()</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(JobStatus job)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 判断这个 Job 是否是准备了！</span></span><br><span class="line">        <span class="keyword">if</span> (isReadyToBeExecutedLocked(job)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (ActivityManagerNative.getDefault().getAppStartMode(job.getUid(),</span><br><span class="line">                        job.getJob().getService().getPackageName())</span><br><span class="line">                        == ActivityManager.APP_START_MODE_DISABLED) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"Aborting job "</span> + job.getUid() + <span class="string">":"</span></span><br><span class="line">                            + job.getJob().toString() + <span class="string">" -- package not allowed to start"</span>);</span><br><span class="line">                    mHandler.obtainMessage(MSG_STOP_JOB, job).sendToTarget();</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (job.getNumFailures() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                backoffCount++;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (job.hasIdleConstraint()) &#123;</span><br><span class="line">                idleCount++;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (job.hasConnectivityConstraint() || job.hasUnmeteredConstraint()</span><br><span class="line">                    || job.hasNotRoamingConstraint()) &#123;</span><br><span class="line">                connectivityCount++;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (job.hasChargingConstraint()) &#123;</span><br><span class="line">                chargingCount++;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (job.hasContentTriggerConstraint()) &#123;</span><br><span class="line">                contentCount++;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (runnableJobs == <span class="keyword">null</span>) &#123;</span><br><span class="line">                runnableJobs = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 将满足条件的 Job，先加入到 runnableJobs 集合！</span></span><br><span class="line">            runnableJobs.add(job);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (areJobConstraintsNotSatisfiedLocked(job)) &#123;</span><br><span class="line">            stopJobOnServiceContextLocked(job,</span><br><span class="line">                    JobParameters.REASON_CONSTRAINTS_NOT_SATISFIED);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这里调用了 isReadyToBeExecutedLocked 方法来判断，这个 job 是否已经准备好了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isReadyToBeExecutedLocked</span><span class="params">(JobStatus job)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> jobReady = job.isReady(); <span class="comment">// job 是否准备好了</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> jobPending = mPendingJobs.contains(job); <span class="comment">// job 是否已经在等待队列中</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> jobActive = isCurrentlyActiveLocked(job); <span class="comment">// job 是否已经在 JobSerivceContext 中运行了！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> userId = job.getUserId();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> userStarted = ArrayUtils.contains(mStartedUsers, userId); <span class="comment">// job 所在的设备用户是否运行！</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> componentPresent; <span class="comment">// 表示 job 对应的应用程序的 JobService 组件是否存在！</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        componentPresent = (AppGlobals.getPackageManager().getServiceInfo(</span><br><span class="line">                job.getServiceComponent(), PackageManager.MATCH_DEBUG_TRIAGED_MISSING,</span><br><span class="line">                userId) != <span class="keyword">null</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e.rethrowAsRuntimeException();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">        Slog.v(TAG, <span class="string">"isReadyToBeExecutedLocked: "</span> + job.toShortString()</span><br><span class="line">                + <span class="string">" ready="</span> + jobReady + <span class="string">" pending="</span> + jobPending</span><br><span class="line">                + <span class="string">" active="</span> + jobActive + <span class="string">" userStarted="</span> + userStarted</span><br><span class="line">                + <span class="string">" componentPresent="</span> + componentPresent);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> userStarted &amp;&amp; componentPresent &amp;&amp; jobReady &amp;&amp; !jobPending &amp;&amp; !jobActive;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看出，一个准备好的 Job 要满足这些条件：</p>
<ul>
<li>It’s ready.</li>
<li>It’s not pending.  </li>
<li>It’s not already running on a JSC.</li>
<li>The user that requested the job is running.</li>
<li>The component is enabled and runnable.</li>
</ul>
<p>最后，调用 MaybeQueueFunctor.postProcess 方法：</p>
<h3 id="6-2-3-MaybeReadyJobQueueFunctor-postProcess"><a href="#6-2-3-MaybeReadyJobQueueFunctor-postProcess" class="headerlink" title="6.2.3 MaybeReadyJobQueueFunctor.postProcess"></a>6.2.3 MaybeReadyJobQueueFunctor.postProcess</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcess</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 判断一下条件！</span></span><br><span class="line">    <span class="keyword">if</span> (backoffCount &gt; <span class="number">0</span> ||</span><br><span class="line">            idleCount &gt;= mConstants.MIN_IDLE_COUNT ||</span><br><span class="line">            connectivityCount &gt;= mConstants.MIN_CONNECTIVITY_COUNT ||</span><br><span class="line">            chargingCount &gt;= mConstants.MIN_CHARGING_COUNT ||</span><br><span class="line">            contentCount &gt;= mConstants.MIN_CONTENT_COUNT ||</span><br><span class="line">            (runnableJobs != <span class="keyword">null</span></span><br><span class="line">                    &amp;&amp; runnableJobs.size() &gt;= mConstants.MIN_READY_JOBS_COUNT)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">            Slog.d(TAG, <span class="string">"maybeQueueReadyJobsForExecutionLockedH: Running jobs."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        noteJobsPending(runnableJobs);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将 runnableJobs 加入到 mPendingJobs 集合中!</span></span><br><span class="line">        mPendingJobs.addAll(runnableJobs);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">            Slog.d(TAG, <span class="string">"maybeQueueReadyJobsForExecutionLockedH: Not running anything."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Be ready for next time</span></span><br><span class="line">    reset();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该功能:</p>
<ul>
<li>先将 JobStore 的 JobSet 中满足条件的 job 对应的 JobStatus 加入 runnableJobs 队列；</li>
<li>再将 runnableJobs 中满足触发条件的 JobStatus 加入到 mPendingJobs 队列；</li>
</ul>
<h2 id="6-3-maybeRunPendingJobsH"><a href="#6-3-maybeRunPendingJobsH" class="headerlink" title="6.3 maybeRunPendingJobsH"></a>6.3 maybeRunPendingJobsH</h2><p>接着，就是处理 mPendingJobs 中的 Job：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">maybeRunPendingJobsH</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">            Slog.d(TAG, <span class="string">"pending queue: "</span> + mPendingJobs.size() + <span class="string">" jobs."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 分配 Job 给 JSC!</span></span><br><span class="line">        assignJobsToContextsLocked();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 更新 JSS 的状态！</span></span><br><span class="line">        reportActive();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>结合就是调用 JSS 的 assignJobsToContextLocked 方法：</p>
<h3 id="6-3-1-JSS-assignJobsToContextsLocked"><a href="#6-3-1-JSS-assignJobsToContextsLocked" class="headerlink" title="6.3.1 JSS.assignJobsToContextsLocked"></a>6.3.1 JSS.assignJobsToContextsLocked</h3><p>这个方法其实从名字上就可以看出，就是把 Job 分配给 JobServiceContext 方法，我们去那个方法里面看一下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">assignJobsToContextsLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">        Slog.d(TAG, printPendingQueue());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据当前系统的内存级别，设定最大的活跃 Job 数，保存到 mMaxActiveJobs！</span></span><br><span class="line">    <span class="keyword">int</span> memLevel;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        memLevel = ActivityManagerNative.getDefault().getMemoryTrimLevel();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        memLevel = ProcessStats.ADJ_MEM_FACTOR_NORMAL;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">switch</span> (memLevel) &#123;</span><br><span class="line">        <span class="keyword">case</span> ProcessStats.ADJ_MEM_FACTOR_MODERATE:</span><br><span class="line">            mMaxActiveJobs = mConstants.BG_MODERATE_JOB_COUNT;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> ProcessStats.ADJ_MEM_FACTOR_LOW:</span><br><span class="line">            mMaxActiveJobs = mConstants.BG_LOW_JOB_COUNT;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> ProcessStats.ADJ_MEM_FACTOR_CRITICAL:</span><br><span class="line">            mMaxActiveJobs = mConstants.BG_CRITICAL_JOB_COUNT;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            mMaxActiveJobs = mConstants.BG_NORMAL_JOB_COUNT;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    JobStatus[] contextIdToJobMap = mTmpAssignContextIdToJobMap; <span class="comment">// 大小为 16，和 mActiveServices 相对应！</span></span><br><span class="line">    <span class="keyword">boolean</span>[] act = mTmpAssignAct;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span>[] preferredUidForContext = mTmpAssignPreferredUidForContext; <span class="comment">// 大小为 16，和 mActiveServices 相对应！</span></span><br><span class="line">    <span class="keyword">int</span> numActive = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> numForeground = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; MAX_JOB_CONTEXTS_COUNT; i++) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获得每一个 JobSchedulerContext 和其内部运行着的 JobStatus（可为 null）</span></span><br><span class="line">        <span class="keyword">final</span> JobServiceContext js = mActiveServices.get(i);</span><br><span class="line">        <span class="keyword">final</span> JobStatus status = js.getRunningJob();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 初始化 contextIdToJobMap，里面保存当前运行着的 Job，和空闲的用于增加的 Job 位置!</span></span><br><span class="line">        <span class="comment">// 然后，分别计算活跃 job 和前台 job 的个数！ </span></span><br><span class="line">        <span class="keyword">if</span> ((contextIdToJobMap[i] = status) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            numActive++;</span><br><span class="line">            <span class="keyword">if</span> (status.lastEvaluatedPriority &gt;= JobInfo.PRIORITY_TOP_APP) &#123;</span><br><span class="line">                numForeground++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        act[i] = <span class="keyword">false</span>;</span><br><span class="line">        <span class="comment">// 如果当前的 JSC 之前有发生过 job 优先级取代，将上一次的被取代的 job 的 uid 保存到 </span></span><br><span class="line">        preferredUidForContext[i] = js.getPreferredUid();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">        Slog.d(TAG, printContextIdToJobMap(contextIdToJobMap, <span class="string">"running jobs initial"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 遍历 mPendingJos 任务集合，尽可能为每一个 job 找到合适的 JobSchedulerContext!</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;mPendingJobs.size(); i++) &#123;</span><br><span class="line">        JobStatus nextPending = mPendingJobs.get(i);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 判断当前的 Job 是不是在 contextIdToJobMap 中了，即他是不是已经在运行了!</span></span><br><span class="line">        <span class="keyword">int</span> jobRunningContext = findJobContextIdFromMap(nextPending, contextIdToJobMap);</span><br><span class="line">        <span class="keyword">if</span> (jobRunningContext != -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 计算 Job 的优先级!</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> priority = evaluateJobPriorityLocked(nextPending);</span><br><span class="line">        nextPending.lastEvaluatedPriority = priority;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 遍历 contextIdToJobMap</span></span><br><span class="line">        <span class="comment">// 给这个即将被执行的 Job 找一个合适的 context，至少要满足两个中的一个要求：1、可利用；2、优先级最低！</span></span><br><span class="line">        <span class="keyword">int</span> minPriority = Integer.MAX_VALUE;</span><br><span class="line">        <span class="keyword">int</span> minPriorityContextId = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j=<span class="number">0</span>; j &lt; MAX_JOB_CONTEXTS_COUNT; j++) &#123;</span><br><span class="line">            JobStatus job = contextIdToJobMap[j];</span><br><span class="line">            <span class="keyword">int</span> preferredUid = preferredUidForContext[j];</span><br><span class="line">            <span class="keyword">if</span> (job == <span class="keyword">null</span>) &#123; </span><br><span class="line">                <span class="keyword">if</span> ((numActive &lt; mMaxActiveJobs ||</span><br><span class="line">                        (priority &gt;= JobInfo.PRIORITY_TOP_APP &amp;&amp;</span><br><span class="line">                                numForeground &lt; mConstants.FG_JOB_COUNT)) &amp;&amp;</span><br><span class="line">                        (preferredUid == nextPending.getUid() ||</span><br><span class="line">                                preferredUid == JobServiceContext.NO_PREFERRED_UID)) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 如果 context 原有的 job 为空，并且同时满足以下 2 个条件：</span></span><br><span class="line">                    <span class="comment">// 1、当前活跃 job 数小于最大活跃数，或者 job 优先级不低于 PRIORITY_TOP_APP 且前台 job 数小于 mConstants.FG_JOB_COUNT</span></span><br><span class="line">                    <span class="comment">// 2、JobSchedulerContext 中保存的之前被取代的 job 的 uid 等于当前的 job 的 id 或者等于 NO_PREFERRED_UID</span></span><br><span class="line">                    <span class="comment">// 这个 JobSchedulerContext 是合适的，退出循环，处理下一个 job！</span></span><br><span class="line">                    minPriorityContextId = j;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 如果 context 原有的 job 不为空，且 uid 和即将执行的 job 不一样，那么这个 JobSchedulerContext 不合适!</span></span><br><span class="line">            <span class="keyword">if</span> (job.getUid() != nextPending.getUid()) &#123; </span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 如果 context 原有的 job 不为空，且 uid 相同，已有 job 优先级大于等于即将执行的 job，那么这个 JobSchedulerContext 不合适!</span></span><br><span class="line">            <span class="keyword">if</span> (evaluateJobPriorityLocked(job) &gt;= nextPending.lastEvaluatedPriority) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 如果存在 JobSchedulerContext 原有的 job 不为空，且 uid 相同，已有 job 优先级低于即将执行的 job，那么就选择优先级最低的那个！</span></span><br><span class="line">            <span class="keyword">if</span> (minPriority &gt; nextPending.lastEvaluatedPriority) &#123; </span><br><span class="line">                minPriority = nextPending.lastEvaluatedPriority;</span><br><span class="line">                <span class="comment">// 用来存储优先级最低的 JobSchedulerContext 所在的数组下标！</span></span><br><span class="line">                minPriorityContextId = j;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 找到了合适的 JobSchedulerContext 的下标!</span></span><br><span class="line">        <span class="keyword">if</span> (minPriorityContextId != -<span class="number">1</span>) &#123; </span><br><span class="line"></span><br><span class="line">            <span class="comment">// 先将这个要被执行的 Job 放入 contextIdToJobMap 的 minPriorityContextId 位置！</span></span><br><span class="line">            contextIdToJobMap[minPriorityContextId] = nextPending;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 对应的 act 位置为 true，表示可以运行!</span></span><br><span class="line">            act[minPriorityContextId] = <span class="keyword">true</span>;</span><br><span class="line">            <span class="comment">// 活跃 job 数加 1；</span></span><br><span class="line">            numActive++; </span><br><span class="line">            <span class="keyword">if</span> (priority &gt;= JobInfo.PRIORITY_TOP_APP) &#123;</span><br><span class="line">                <span class="comment">// 如果 job 的权限不低于 PRIORITY_TOP_APP，前台 job 数加 1；</span></span><br><span class="line">                numForeground++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">        Slog.d(TAG, printContextIdToJobMap(contextIdToJobMap, <span class="string">"running jobs final"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    mJobPackageTracker.noteConcurrency(numActive, numForeground);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行所有已经分配了 JobSchedulerContext 的 job !</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i &lt; MAX_JOB_CONTEXTS_COUNT; i++) &#123;</span><br><span class="line">        <span class="keyword">boolean</span> preservePreferredUid = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (act[i]) &#123; <span class="comment">// art 为 true，表示可运行！</span></span><br><span class="line">            JobStatus js = mActiveServices.get(i).getRunningJob();</span><br><span class="line">            <span class="keyword">if</span> (js != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                    Slog.d(TAG, <span class="string">"preempting job: "</span> + mActiveServices.get(i).getRunningJob());</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// preferredUid will be set to uid of currently running job.</span></span><br><span class="line">                <span class="comment">// 如果这个 context 已经在运行了一个优先级低的 job，那就要取消它！</span></span><br><span class="line">                mActiveServices.get(i).preemptExecutingJob();</span><br><span class="line">                preservePreferredUid = <span class="keyword">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 从 contextIdToJobMap 中获得即将执行的 Job!</span></span><br><span class="line">                <span class="keyword">final</span> JobStatus pendingJob = contextIdToJobMap[i];</span><br><span class="line">                <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                    Slog.d(TAG, <span class="string">"About to run job on context "</span></span><br><span class="line">                            + String.valueOf(i) + <span class="string">", job: "</span> + pendingJob);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 通知控制器!</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> ic=<span class="number">0</span>; ic&lt;mControllers.size(); ic++) &#123;</span><br><span class="line">                    mControllers.get(ic).prepareForExecutionLocked(pendingJob);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 使用对应的 JobServiceContext 来执行 Job</span></span><br><span class="line">                <span class="keyword">if</span> (!mActiveServices.get(i).executeRunnableJob(pendingJob)) &#123;</span><br><span class="line">                    Slog.d(TAG, <span class="string">"Error executing "</span> + pendingJob);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Job 已经开始执行了，从 mPendingJobs 中移除这个 Job!</span></span><br><span class="line">                <span class="keyword">if</span> (mPendingJobs.remove(pendingJob)) &#123;</span><br><span class="line">                    mJobPackageTracker.noteNonpending(pendingJob);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果 preservePreferredUid 为 false，说明本次执行，没有发生 job 优先级取代</span></span><br><span class="line">        <span class="comment">// 那就要调用 JobServiceContext 的 clearPreferredUid 清除上一次取代（如果有）保存的 uid！</span></span><br><span class="line">        <span class="keyword">if</span> (!preservePreferredUid) &#123; </span><br><span class="line">            mActiveServices.get(i).clearPreferredUid();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>接着我们继续来看：</p>
<h4 id="6-3-1-1-JSS-findJobContextIdFromMap"><a href="#6-3-1-1-JSS-findJobContextIdFromMap" class="headerlink" title="6.3.1.1 JSS.findJobContextIdFromMap"></a>6.3.1.1 JSS.findJobContextIdFromMap</h4><p>这个方法的作用很简单，就是判断 job 是否已经在 map 集合中了！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">findJobContextIdFromMap</span><span class="params">(JobStatus jobStatus, JobStatus[] map)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;map.length; i++) &#123;</span><br><span class="line">        <span class="comment">// 在 contextIdToJobMap 匹配 JobId 和 uid 相同的一个 job！</span></span><br><span class="line">        <span class="keyword">if</span> (map[i] != <span class="keyword">null</span> &amp;&amp; map[i].matches(jobStatus.getUid(), jobStatus.getJobId())) &#123;</span><br><span class="line">            <span class="keyword">return</span> i;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="6-3-1-2-JSS-evaluateJobPriorityLocked"><a href="#6-3-1-2-JSS-evaluateJobPriorityLocked" class="headerlink" title="6.3.1.2 JSS.evaluateJobPriorityLocked"></a>6.3.1.2 JSS.evaluateJobPriorityLocked</h4><p>这个方法是为 job 计算优先级：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">adjustJobPriority</span><span class="params">(<span class="keyword">int</span> curPriority, JobStatus job)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果 curPriority 小于 PRIORITY_TOP_APP （40）</span></span><br><span class="line">    <span class="keyword">if</span> (curPriority &lt; JobInfo.PRIORITY_TOP_APP) &#123;</span><br><span class="line">        <span class="comment">// 获得计算因子，根据计算因子，计算优先级！</span></span><br><span class="line">        <span class="keyword">float</span> factor = mJobPackageTracker.getLoadFactor(job);</span><br><span class="line">        <span class="keyword">if</span> (factor &gt;= mConstants.HEAVY_USE_FACTOR) &#123;</span><br><span class="line">            curPriority += JobInfo.PRIORITY_ADJ_ALWAYS_RUNNING;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (factor &gt;= mConstants.MODERATE_USE_FACTOR) &#123;</span><br><span class="line">            curPriority += JobInfo.PRIORITY_ADJ_OFTEN_RUNNING;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 返回 curPriority；</span></span><br><span class="line">    <span class="keyword">return</span> curPriority;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">evaluateJobPriorityLocked</span><span class="params">(JobStatus job)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 获得 job 的优先级</span></span><br><span class="line">    <span class="keyword">int</span> priority = job.getPriority();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果 job 的优先级大于等于 PRIORITY_FOREGROUND_APP（30）</span></span><br><span class="line">    <span class="keyword">if</span> (priority &gt;= JobInfo.PRIORITY_FOREGROUND_APP) &#123;</span><br><span class="line">        <span class="comment">// 直接利用 job 的 priority 计算优先级！</span></span><br><span class="line">        <span class="keyword">return</span> adjustJobPriority(priority, job);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果 job 的优先级小于 PRIORITY_FOREGROUND_APP（30）</span></span><br><span class="line">    <span class="comment">// 就先判断当前的 job 的 uid 是否是前台 uid！</span></span><br><span class="line">    <span class="keyword">int</span> override = mUidPriorityOverride.get(job.getSourceUid(), <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (override != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果当前 job 的 uid 是前台 uid，那就以这个 uid 对应的优先级计算当前 job 的优先级！</span></span><br><span class="line">        <span class="keyword">return</span> adjustJobPriority(override, job);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 直接利用 job 的 priority 计算优先级！</span></span><br><span class="line">    <span class="keyword">return</span> adjustJobPriority(priority, job);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里的 mUidPriorityOverride 用来保存当前<strong>所有在前台的 uid，以及 uid 所有的 job 的优先级</strong>，下面是 Jss 中定义的一些优先级：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PRIORITY_ADJ_ALWAYS_RUNNING = -<span class="number">80</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PRIORITY_ADJ_OFTEN_RUNNING = -<span class="number">40</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PRIORITY_DEFAULT = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PRIORITY_SYNC_EXPEDITED = <span class="number">10</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PRIORITY_SYNC_INITIALIZATION = <span class="number">20</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PRIORITY_FOREGROUND_APP = <span class="number">30</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PRIORITY_TOP_APP = <span class="number">40</span>;</span><br></pre></td></tr></table></figure></p>
<p>值越小，则优先级越高！</p>
<p>接着源码继续分析：</p>
<h4 id="6-3-1-3-JSC-preemptExecutingJob"><a href="#6-3-1-3-JSC-preemptExecutingJob" class="headerlink" title="6.3.1.3 JSC.preemptExecutingJob"></a>6.3.1.3 JSC.preemptExecutingJob</h4><p>这里调用了 JobServiceContext 的 preemptExecutingJob 方法来取消相同 uid 但是优先级更低的任务，之前有说过，如果 Context 已经在执行一个优先级 job，并且这个 job 和即将被执行的 job 属于同一个 uid，那么要取消优先级低的！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">preemptExecutingJob</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Message m = mCallbackHandler.obtainMessage(MSG_CANCEL);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 参数为 JobParameters.REASON_PREEMPT，表示要取代！</span></span><br><span class="line">    m.arg1 = JobParameters.REASON_PREEMPT;</span><br><span class="line">    m.sendToTarget();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>发送一个 MSG_CANCEL 消息给 JSC 内部的 JobServiceHandler ，附带一个参数，表示原因：JobParameters.REASON_PREEMPT！</p>
<h5 id="JobServiceHandler-MSG-CANCEL"><a href="#JobServiceHandler-MSG-CANCEL" class="headerlink" title="JobServiceHandler.MSG_CANCEL"></a>JobServiceHandler.MSG_CANCEL</h5><p>我们接着来看：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">JobServiceHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">    JobServiceHandler(Looper looper) &#123;</span><br><span class="line">        <span class="keyword">super</span>(looper);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (message.what) &#123;</span><br><span class="line">            ... ... ... ...</span><br><span class="line">            <span class="keyword">case</span> MSG_CANCEL:</span><br><span class="line">                <span class="keyword">if</span> (mVerb == VERB_FINISHED) &#123; <span class="comment">// 这个 mVerb 表示的是，这个 Context 的 job 的当前状态!</span></span><br><span class="line">                    <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                        Slog.d(TAG,</span><br><span class="line">                               <span class="string">"Trying to process cancel for torn-down context, ignoring."</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                mParams.setStopReason(message.arg1);</span><br><span class="line">                <span class="keyword">if</span> (message.arg1 == JobParameters.REASON_PREEMPT) &#123;</span><br><span class="line">                    <span class="comment">// 如果是取消的原因是优先级取代，就用 mPreferredUid 保存 uid！</span></span><br><span class="line">                    mPreferredUid = mRunningJob != <span class="keyword">null</span> ? mRunningJob.getUid() :</span><br><span class="line">                            NO_PREFERRED_UID;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 执行取消操作!</span></span><br><span class="line">                handleCancelH();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> MSG_TIMEOUT:</span><br><span class="line">                handleOpTimeoutH();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> MSG_SHUTDOWN_EXECUTION:</span><br><span class="line">                closeAndCleanupJobH(<span class="keyword">true</span> <span class="comment">/* needsReschedule */</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                Slog.e(TAG, <span class="string">"Unrecognised message: "</span> + message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    ... ... ... ... ... ...</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleCancelH</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (JobSchedulerService.DEBUG) &#123;</span><br><span class="line">            Slog.d(TAG, <span class="string">"Handling cancel for: "</span> + mRunningJob.getJobId() + <span class="string">" "</span></span><br><span class="line">                    + VERB_STRINGS[mVerb]);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 这里因为是取消的是这个 context 里面正在执行的 job，所以 mVerb 的值为 VERB_EXECUTING!</span></span><br><span class="line">        <span class="keyword">switch</span> (mVerb) &#123; </span><br><span class="line">            <span class="keyword">case</span> VERB_BINDING:</span><br><span class="line">            <span class="keyword">case</span> VERB_STARTING:</span><br><span class="line">                mCancelled.set(<span class="keyword">true</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">case</span> VERB_EXECUTING:</span><br><span class="line">                <span class="comment">// 如果 client 已经调用了 jobFinished 方法结束了 job，那就 return!</span></span><br><span class="line">                <span class="keyword">if</span> (hasMessages(MSG_CALLBACK)) &#123;</span><br><span class="line">                    <span class="comment">// If the client has called jobFinished, ignore this cancel.</span></span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                sendStopMessageH(); <span class="comment">// 否则，就发送停止的消息!</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">case</span> VERB_STOPPING:</span><br><span class="line">                <span class="comment">// Nada.</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">                </span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                Slog.e(TAG, <span class="string">"Cancelling a job without a valid verb: "</span> + mVerb);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ... ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果有优先级低的 job 正在运行，那就 stop job，这时 mVerb 会从：VERB_EXECUTING -&gt; VERB_STOPPING.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Already running, need to stop. Will switch &#123;@link #mVerb&#125; from VERB_EXECUTING -&gt;</span><br><span class="line"> * VERB_STOPPING.</span><br><span class="line"> */</span><br><span class="line">private void sendStopMessageH() &#123;</span><br><span class="line">    removeOpTimeOut();</span><br><span class="line">    if (mVerb != VERB_EXECUTING) &#123;</span><br><span class="line">        Slog.e(TAG, &quot;Sending onStopJob for a job that isn&apos;t started. &quot; + mRunningJob);</span><br><span class="line">        closeAndCleanupJobH(false /* reschedule */);</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    try &#123;</span><br><span class="line">        // mVerb 状态变为 VERB_STOPPING！</span><br><span class="line">        mVerb = VERB_STOPPING;</span><br><span class="line">        scheduleOpTimeOut();</span><br><span class="line"></span><br><span class="line">        // binder 通信，调用 JobService 的 stopJob 方法</span><br><span class="line">        service.stopJob(mParams); </span><br><span class="line">    &#125; catch (RemoteException e) &#123;</span><br><span class="line">        Slog.e(TAG, &quot;Error sending onStopJob to client.&quot;, e);</span><br><span class="line">        closeAndCleanupJobH(false /* reschedule */);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里的 service 是一个 IJobService 对象，本质是一个 Binder 对象，对应着应用程序进程中的 JobService！</p>
<h5 id="JobService-stopJob"><a href="#JobService-stopJob" class="headerlink" title="JobService.stopJob"></a>JobService.stopJob</h5><p>注意：这里对于 Binder 机制来说：应用程序的 JobService 所在进程是 Binder 服务端，JobServiceContext 所在的进程 system_server 是 Binder 客户端！也就是说，应用程序定义的 JobService 是被 JobSerivceContext 来 bind 的，所以，你会发现，你无法 override JobService 的 onbind 方法！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">JobInterface</span> <span class="keyword">extends</span> <span class="title">IJobService</span>.<span class="title">Stub</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> WeakReference&lt;JobService&gt; mService;</span><br><span class="line">    JobInterface(JobService service) &#123;</span><br><span class="line">        mService = <span class="keyword">new</span> WeakReference&lt;&gt;(service);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startJob</span><span class="params">(JobParameters jobParams)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        JobService service = mService.get();</span><br><span class="line">        <span class="keyword">if</span> (service != <span class="keyword">null</span>) &#123;</span><br><span class="line">            service.ensureHandler();</span><br><span class="line">            Message m = Message.obtain(service.mHandler, MSG_EXECUTE_JOB, jobParams);</span><br><span class="line">            m.sendToTarget();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stopJob</span><span class="params">(JobParameters jobParams)</span> <span class="keyword">throws</span> RemoteException </span>&#123; </span><br><span class="line">        <span class="comment">// 通过 binder 机制来来调用指定应用的 JobService 的 stopJob 方法！</span></span><br><span class="line">        JobService service = mService.get();</span><br><span class="line">        <span class="keyword">if</span> (service != <span class="keyword">null</span>) &#123;</span><br><span class="line">            service.ensureHandler();</span><br><span class="line">            <span class="comment">// 发送到 JobService 内部的 JobHandler 对象中！</span></span><br><span class="line">            Message m = Message.obtain(service.mHandler, MSG_STOP_JOB, jobParams);</span><br><span class="line">            m.sendToTarget();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里发送了 MSG_STOP_JOB 消息给 JobService.JobHandler，我们去 JobHandler 内部去看看：</p>
<h5 id="JobHandler-MSG-STOP-JOB"><a href="#JobHandler-MSG-STOP-JOB" class="headerlink" title="JobHandler.MSG_STOP_JOB"></a>JobHandler.MSG_STOP_JOB</h5><p>JobHandler 位于应用程序的主线程：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JobHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">    JobHandler(Looper looper) &#123;</span><br><span class="line">        <span class="keyword">super</span>(looper);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 这里获得传递过来的 JobParameters </span></span><br><span class="line">        <span class="keyword">final</span> JobParameters params = (JobParameters) msg.obj;</span><br><span class="line">        <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line"></span><br><span class="line">            ... ... ...</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> MSG_STOP_JOB:</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 调用 JobService onStopJob 方法，把参数传递过去，这里是不是很熟悉，就不多说!</span></span><br><span class="line">                    <span class="comment">// onStopJob 会返回 true / false， true 表示还会 reschedule 这个 job!</span></span><br><span class="line">                    <span class="keyword">boolean</span> ret = JobService.<span class="keyword">this</span>.onStopJob(params);</span><br><span class="line">                    ackStopMessage(params, ret);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    Log.e(TAG, <span class="string">"Application unable to handle onStopJob."</span>, e);</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            ... ... ... ...</span><br><span class="line"></span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                Log.e(TAG, <span class="string">"Unrecognised message received."</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ... ... ... ... ...</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ackStopMessage</span><span class="params">(JobParameters params, <span class="keyword">boolean</span> reschedule)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 这里获得了 IJobCallback 对象，这里显示是 Binder 机制，服务端是 JobServiceContext</span></span><br><span class="line">        <span class="keyword">final</span> IJobCallback callback = params.getCallback();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> jobId = params.getJobId();</span><br><span class="line">        <span class="keyword">if</span> (callback != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 发送消息给 JobServiceContext</span></span><br><span class="line">                callback.acknowledgeStopMessage(jobId, reschedule);</span><br><span class="line">            &#125; <span class="keyword">catch</span>(RemoteException e) &#123;</span><br><span class="line">                Log.e(TAG, <span class="string">"System unreachable for stopping job."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (Log.isLoggable(TAG, Log.DEBUG)) &#123;</span><br><span class="line">                Log.d(TAG, <span class="string">"Attempting to ack a job that has already been processed."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里的 IJobCallback 又是使用了 Binder 机制，Binder 客户端是应用程序的 JobService 所在进程，Binder 服务端是 JobServiceContext 所在的进程，最后调用的是 JobServiceContext.acknowledgeStopMessage 方法：</p>
<h5 id="JobServiceContext-acknowledgeStopMessage"><a href="#JobServiceContext-acknowledgeStopMessage" class="headerlink" title="JobServiceContext.acknowledgeStopMessage"></a>JobServiceContext.acknowledgeStopMessage</h5><p>通过 Binder 机制，将回调信息发回给 JobServiceContext：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">acknowledgeStopMessage</span><span class="params">(<span class="keyword">int</span> jobId, <span class="keyword">boolean</span> reschedule)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!verifyCallingUid()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发送 MSG_CALLBACK 给 JobServiceHandler</span></span><br><span class="line">    mCallbackHandler.obtainMessage(MSG_CALLBACK, jobId, reschedule ? <span class="number">1</span> : <span class="number">0</span>)</span><br><span class="line">            .sendToTarget();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后又会发送 MSG_CALLBACK 给 JobServiceContext.JobServiceHandler，这里我们只看关键代码：</p>
<h5 id="JobServiceHandler-MSG-CALLBACK"><a href="#JobServiceHandler-MSG-CALLBACK" class="headerlink" title="JobServiceHandler.MSG_CALLBACK"></a>JobServiceHandler.MSG_CALLBACK</h5><p>JobServiceHandler 同样的也是位于主线程：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> MSG_CALLBACK:</span><br><span class="line">    <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">        Slog.d(TAG, <span class="string">"MSG_CALLBACK of : "</span> + mRunningJob</span><br><span class="line">                + <span class="string">" v:"</span> + VERB_STRINGS[mVerb]);</span><br><span class="line">    &#125;</span><br><span class="line">    removeOpTimeOut();</span><br><span class="line">    <span class="keyword">if</span> (mVerb == VERB_STARTING) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> workOngoing = message.arg2 == <span class="number">1</span>;</span><br><span class="line">        handleStartedH(workOngoing);</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mVerb == VERB_EXECUTING ||</span><br><span class="line">            mVerb == VERB_STOPPING) &#123; <span class="comment">// 从前面跟代码，可以看出 mVerb 的值为 VERB_STOPPING.</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> reschedule = message.arg2 == <span class="number">1</span>;</span><br><span class="line">        </span><br><span class="line">        handleFinishedH(reschedule);</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">            Slog.d(TAG, <span class="string">"Unrecognised callback: "</span> + mRunningJob);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure></p>
<p>接着，调用 JobServiceContext 的 handleFinishedH 方法：</p>
<h5 id="JobServiceContext-handleFinishedH"><a href="#JobServiceContext-handleFinishedH" class="headerlink" title="JobServiceContext.handleFinishedH"></a>JobServiceContext.handleFinishedH</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleFinishedH</span><span class="params">(<span class="keyword">boolean</span> reschedule)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">switch</span> (mVerb) &#123;</span><br><span class="line">                <span class="keyword">case</span> VERB_EXECUTING:</span><br><span class="line">                <span class="keyword">case</span> VERB_STOPPING: <span class="comment">// 进入这个分支！</span></span><br><span class="line">                    closeAndCleanupJobH(reschedule); <span class="comment">// 调用了 closeAndCleanupJobH</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">、</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    Slog.e(TAG, <span class="string">"Got an execution complete message for a job that wasn't being"</span> +</span><br><span class="line">                            <span class="string">"executed. Was "</span> + VERB_STRINGS[mVerb] + <span class="string">"."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>接着进入 closeAndCleanupJobH 方法，参数 reschedule 表示是否再次执行这个 job！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">closeAndCleanupJobH</span><span class="params">(<span class="keyword">boolean</span> reschedule)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> JobStatus completedJob;</span><br><span class="line">        <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mVerb == VERB_FINISHED) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            completedJob = mRunningJob;</span><br><span class="line">            mJobPackageTracker.noteInactive(completedJob);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                mBatteryStats.noteJobFinish(mRunningJob.getBatteryName(),</span><br><span class="line">                        mRunningJob.getSourceUid());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                <span class="comment">// Whatever.</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (mWakeLock != <span class="keyword">null</span>) &#123;</span><br><span class="line">                mWakeLock.release();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            mContext.unbindService(JobServiceContext.<span class="keyword">this</span>); <span class="comment">// 取消绑定 JobService</span></span><br><span class="line">            mWakeLock = <span class="keyword">null</span>;</span><br><span class="line">            mRunningJob = <span class="keyword">null</span>;</span><br><span class="line">            mParams = <span class="keyword">null</span>;</span><br><span class="line">            mVerb = VERB_FINISHED; <span class="comment">// mVerb 状态置为 VERB_FINISHED；</span></span><br><span class="line">            mCancelled.set(<span class="keyword">false</span>);</span><br><span class="line">            service = <span class="keyword">null</span>;</span><br><span class="line">            mAvailable = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        removeOpTimeOut(); <span class="comment">// 移除已经处理的消息</span></span><br><span class="line">        removeMessages(MSG_CALLBACK);</span><br><span class="line">        removeMessages(MSG_SERVICE_BOUND);</span><br><span class="line">        removeMessages(MSG_CANCEL);</span><br><span class="line">        removeMessages(MSG_SHUTDOWN_EXECUTION);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 调用了 mCompletedListener 的 onJobCompleted 方法!</span></span><br><span class="line">        mCompletedListener.onJobCompleted(completedJob, reschedule);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个方法很简单，就是对当前的 JobSchedulerContext 进行初始化操作，为执行下一个 job 做准备！</p>
<p>这里 mCompletedListener 大家去看 JobServiceContext 的初始化，也就是第二篇，其实就是 JobSchedulerService：</p>
<h5 id="JobSchedulerService-onJobCompleted"><a href="#JobSchedulerService-onJobCompleted" class="headerlink" title="JobSchedulerService.onJobCompleted"></a>JobSchedulerService.onJobCompleted</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onJobCompleted</span><span class="params">(JobStatus jobStatus, <span class="keyword">boolean</span> needsReschedule)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">        Slog.d(TAG, <span class="string">"Completed "</span> + jobStatus + <span class="string">", reschedule="</span> + needsReschedule);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 停止 track 这个 job，如果是周期性 job 不更新本地的 jobs.xml 文件!</span></span><br><span class="line">    <span class="keyword">if</span> (!stopTrackingJob(jobStatus, <span class="keyword">null</span>, !jobStatus.getJob().isPeriodic())) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">            Slog.d(TAG, <span class="string">"Could not find job to remove. Was job removed while executing?"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// We still want to check for jobs to execute, because this job may have</span></span><br><span class="line">        <span class="comment">// scheduled a new job under the same job id, and now we can run it.</span></span><br><span class="line">        mHandler.obtainMessage(MSG_CHECK_JOB_GREEDY).sendToTarget();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 重新 schedule 这个 job，注意这时候</span></span><br><span class="line">    <span class="keyword">if</span> (needsReschedule) &#123;</span><br><span class="line">        JobStatus rescheduled = getRescheduleJobForFailure(jobStatus);</span><br><span class="line">        startTrackingJob(rescheduled, jobStatus);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (jobStatus.getJob().isPeriodic()) &#123;</span><br><span class="line">        JobStatus rescheduledPeriodic = getRescheduleJobForPeriodic(jobStatus);</span><br><span class="line">        startTrackingJob(rescheduledPeriodic, jobStatus);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    reportActive();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发送 MSG_CHECK_JOB_GREEDY 给 JobSchedulerService.JobHandler</span></span><br><span class="line">    mHandler.obtainMessage(MSG_CHECK_JOB_GREEDY).sendToTarget();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里首先调用了 stopTrackingJob 将这个 job 从 JobStore 和 controller 中移除：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">stopTrackingJob</span><span class="params">(JobStatus jobStatus, JobStatus incomingJob,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> writeBack)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 从 JobStore 中移除这个 job，如果 writeback 为 true，还要更新本地的 job.xml 文件!</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> removed = mJobs.remove(jobStatus, writeBack);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (removed &amp;&amp; mReadyToRock) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;mControllers.size(); i++) &#123;</span><br><span class="line">                StateController controller = mControllers.get(i);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 从 Controller 的跟踪队列中移除！</span></span><br><span class="line">                controller.maybeStopTrackingJobLocked(jobStatus, incomingJob, <span class="keyword">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> removed;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>最后是发 MSG_CHECK_JOB_GREEDY 给 JobHandler：</p>
<h5 id="JobHandler-MSG-CHECK-JOB-GREEDY"><a href="#JobHandler-MSG-CHECK-JOB-GREEDY" class="headerlink" title="JobHandler.MSG_CHECK_JOB_GREEDY"></a>JobHandler.MSG_CHECK_JOB_GREEDY</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">JobHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mReadyToRock) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">switch</span> (message.what) &#123;</span><br><span class="line">            ... ... ... ...</span><br><span class="line">            <span class="keyword">case</span> MSG_CHECK_JOB_GREEDY:</span><br><span class="line">                <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 作用和 maybeQueueReadyJobsForExecutionLockedH 一样的都是更新 mPendingJobs 集合！</span></span><br><span class="line">                    queueReadyJobsForExecutionLockedH();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            ... ... ... ...</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 再次执行 mPendingJobs 中的 job</span></span><br><span class="line">        maybeRunPendingJobsH();</span><br><span class="line">        <span class="comment">// Don't remove JOB_EXPIRED in case one came along while processing the queue.</span></span><br><span class="line">        removeMessages(MSG_CHECK_JOB);</span><br><span class="line">    &#125;</span><br><span class="line">    ... ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后继续 maybeRunPendingJobsH，这里又回到了上面的第 6 节了，就不多说了！</p>
<h4 id="6-3-1-4-JSC-prepareForExecutionLocked"><a href="#6-3-1-4-JSC-prepareForExecutionLocked" class="headerlink" title="6.3.1.4 JSC.prepareForExecutionLocked"></a>6.3.1.4 JSC.prepareForExecutionLocked</h4><p>如果不需要优先级取代，取消优先级低的 job，那就直接执行当前的新 job，在执行那个前，调用 prepareForExecutionLocked 做准备工作。</p>
<p>这个方法其实很简单，就是一个抽象类的方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Optionally implement logic here to prepare the job to be executed.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">prepareForExecutionLocked</span><span class="params">(JobStatus jobStatus)</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>表示通知 StateController，做好准备，具体实现是在 Controller 中，我们先看看 ConnectivityController，其他类似：</p>
<h4 id="6-3-1-5-JSC-executeRunnableJob"><a href="#6-3-1-5-JSC-executeRunnableJob" class="headerlink" title="6.3.1.5 JSC.executeRunnableJob"></a>6.3.1.5 JSC.executeRunnableJob</h4><p>这里就是调用 JobSchedulerContext 方法来执行 Job：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">executeRunnableJob</span><span class="params">(JobStatus job)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mAvailable) &#123;</span><br><span class="line">            Slog.e(TAG, <span class="string">"Starting new runnable but context is unavailable &gt; Error."</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        mPreferredUid = NO_PREFERRED_UID;</span><br><span class="line">        <span class="comment">// 保存到 mRunningJob 中</span></span><br><span class="line">        mRunningJob = job;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> isDeadlineExpired =</span><br><span class="line">                job.hasDeadlineConstraint() &amp;&amp;</span><br><span class="line">                        (job.getLatestRunTimeElapsed() &lt; SystemClock.elapsedRealtime());</span><br><span class="line">                        </span><br><span class="line">        Uri[] triggeredUris = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (job.changedUris != <span class="keyword">null</span>) &#123;</span><br><span class="line">            triggeredUris = <span class="keyword">new</span> Uri[job.changedUris.size()];</span><br><span class="line">            job.changedUris.toArray(triggeredUris);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        String[] triggeredAuthorities = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (job.changedAuthorities != <span class="keyword">null</span>) &#123;</span><br><span class="line">            triggeredAuthorities = <span class="keyword">new</span> String[job.changedAuthorities.size()];</span><br><span class="line">            job.changedAuthorities.toArray(triggeredAuthorities);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 创建 job 需要的 JobParamters</span></span><br><span class="line">        mParams = <span class="keyword">new</span> JobParameters(<span class="keyword">this</span>, job.getJobId(), job.getExtras(), isDeadlineExpired,</span><br><span class="line">                triggeredUris, triggeredAuthorities);</span><br><span class="line">                </span><br><span class="line">        mExecutionStartTimeElapsed = SystemClock.elapsedRealtime();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// mVerb 的值变为 VERB_BINDING!</span></span><br><span class="line">        mVerb = VERB_BINDING;</span><br><span class="line"></span><br><span class="line">        scheduleOpTimeOut();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 这里很关键，bind 应用程序中注册的 JobService，并返回结果！</span></span><br><span class="line">        <span class="keyword">final</span> Intent intent = <span class="keyword">new</span> Intent().setComponent(job.getServiceComponent());</span><br><span class="line">        <span class="keyword">boolean</span> binding = mContext.bindServiceAsUser(intent, <span class="keyword">this</span>,</span><br><span class="line">                Context.BIND_AUTO_CREATE | Context.BIND_NOT_FOREGROUND,</span><br><span class="line">                <span class="keyword">new</span> UserHandle(job.getUserId()));</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> (!binding) &#123; <span class="comment">// 如果 bind 失败，异常处理！</span></span><br><span class="line">            <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                Slog.d(TAG, job.getServiceComponent().getShortClassName() + <span class="string">" unavailable."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            mRunningJob = <span class="keyword">null</span>;</span><br><span class="line">            mParams = <span class="keyword">null</span>;</span><br><span class="line">            mExecutionStartTimeElapsed = <span class="number">0L</span>;</span><br><span class="line">            mVerb = VERB_FINISHED;</span><br><span class="line">            removeOpTimeOut();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 记录信息!</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mBatteryStats.noteJobStart(job.getBatteryName(), job.getSourceUid());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            <span class="comment">// Whatever.</span></span><br><span class="line">        &#125;</span><br><span class="line">        mJobPackageTracker.noteActive(job);</span><br><span class="line">        mAvailable = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这便是由 system_server 进程的主线程来执行 bind Service 的方式来拉起的进程，当服务启动后回调到发起端的 onServiceConnected。</p>
<h5 id="6-3-1-5-1-JSC-onServiceConnected"><a href="#6-3-1-5-1-JSC-onServiceConnected" class="headerlink" title="6.3.1.5.1 JSC.onServiceConnected"></a>6.3.1.5.1 JSC.onServiceConnected</h5><p>bind 成功后，JobServiceContext 的 onServiceConnected 方法会执行：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceConnected</span><span class="params">(ComponentName name, IBinder service)</span> </span>&#123;</span><br><span class="line">    JobStatus runningJob;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        runningJob = mRunningJob;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 异常检测，如果 runningJob 为 null 或者 JobService 组件不匹配，发送 MSG_SHUTDOWN_EXECUTION 终止执行！</span></span><br><span class="line">    <span class="keyword">if</span> (runningJob == <span class="keyword">null</span> || !name.equals(runningJob.getServiceComponent())) &#123;</span><br><span class="line">        mCallbackHandler.obtainMessage(MSG_SHUTDOWN_EXECUTION).sendToTarget();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获得了应用程序的 JobService 的代理对象！</span></span><br><span class="line">    <span class="keyword">this</span>.service = IJobService.Stub.asInterface(service);</span><br><span class="line">    <span class="comment">// 申请 wakeLock 锁！</span></span><br><span class="line">    <span class="keyword">final</span> PowerManager pm =</span><br><span class="line">            (PowerManager) mContext.getSystemService(Context.POWER_SERVICE);</span><br><span class="line">    PowerManager.WakeLock wl = pm.newWakeLock(PowerManager.PARTIAL_WAKE_LOCK,</span><br><span class="line">            runningJob.getTag());</span><br><span class="line">    wl.setWorkSource(<span class="keyword">new</span> WorkSource(runningJob.getSourceUid()));</span><br><span class="line">    wl.setReferenceCounted(<span class="keyword">false</span>);</span><br><span class="line">    wl.acquire();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mWakeLock != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Bound new job "</span> + runningJob + <span class="string">" but live wakelock "</span> + mWakeLock</span><br><span class="line">                    + <span class="string">" tag="</span> + mWakeLock.getTag());</span><br><span class="line">            mWakeLock.release();</span><br><span class="line">        &#125;</span><br><span class="line">        mWakeLock = wl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发送 MSG_SERVICE_BOUND 给 JobServiceHandler 中！</span></span><br><span class="line">    mCallbackHandler.obtainMessage(MSG_SERVICE_BOUND).sendToTarget();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看到，这里会发送消息到 JobServiceHandler 中：</p>
<h5 id="6-3-1-5-2-JSC-JobServiceHandler"><a href="#6-3-1-5-2-JSC-JobServiceHandler" class="headerlink" title="6.3.1.5.2 JSC.JobServiceHandler"></a>6.3.1.5.2 JSC.JobServiceHandler</h5><p>JobServiceHandler 方法也是在主线程中！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">JobServiceHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">    JobServiceHandler(Looper looper) &#123;</span><br><span class="line">        <span class="keyword">super</span>(looper);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (message.what) &#123;</span><br><span class="line">            <span class="keyword">case</span> MSG_SERVICE_BOUND: <span class="comment">// 绑定成功！</span></span><br><span class="line">                removeOpTimeOut();</span><br><span class="line">                handleServiceBoundH();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            ... ... ... ...</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> MSG_SHUTDOWN_EXECUTION: <span class="comment">// 绑定是出现异常的消息！</span></span><br><span class="line">                closeAndCleanupJobH(<span class="keyword">true</span> <span class="comment">/* needsReschedule */</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                Slog.e(TAG, <span class="string">"Unrecognised message: "</span> + message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    ... ... ... ...</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>接着我们来分别看一下：</p>
<h6 id="6-3-1-5-2-1-JSS-handleServiceBoundH"><a href="#6-3-1-5-2-1-JSS-handleServiceBoundH" class="headerlink" title="6.3.1.5.2.1 JSS.handleServiceBoundH"></a>6.3.1.5.2.1 JSS.handleServiceBoundH</h6><p>收到这个消息后，调用 handleServiceBoundH 方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Start the job on the service. */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleServiceBoundH</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">        Slog.d(TAG, <span class="string">"MSG_SERVICE_BOUND for "</span> + mRunningJob.toShortString());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mVerb != VERB_BINDING) &#123; <span class="comment">// 状态异常</span></span><br><span class="line">        Slog.e(TAG, <span class="string">"Sending onStartJob for a job that isn't pending. "</span></span><br><span class="line">                + VERB_STRINGS[mVerb]);</span><br><span class="line">        closeAndCleanupJobH(<span class="keyword">false</span> <span class="comment">/* reschedule */</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果 mCancelled.get() 为 true，表示 job 被取消了，那就执行舒适化 JSC，并 return！</span></span><br><span class="line">    <span class="keyword">if</span> (mCancelled.get()) &#123; </span><br><span class="line">        <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">            Slog.d(TAG, <span class="string">"Job cancelled while waiting for bind to complete. "</span></span><br><span class="line">                    + mRunningJob);</span><br><span class="line">        &#125;</span><br><span class="line">        closeAndCleanupJobH(<span class="keyword">true</span> <span class="comment">/* reschedule */</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// mVerb 的值设置为 VERB_STARTING！</span></span><br><span class="line">        mVerb = VERB_STARTING;</span><br><span class="line">        scheduleOpTimeOut();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 这里调用了 JobService 的 startJob 方法</span></span><br><span class="line">        service.startJob(mParams);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        Slog.e(TAG, <span class="string">"Error sending onStart message to '"</span> +</span><br><span class="line">                mRunningJob.getServiceComponent().getShortClassName() + <span class="string">"' "</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里就不细看了！</p>
<h1 id="7-总结"><a href="#7-总结" class="headerlink" title="7 总结"></a>7 总结</h1><h2 id="7-1-schedule-流程"><a href="#7-1-schedule-流程" class="headerlink" title="7.1 schedule 流程"></a>7.1 schedule 流程</h2><p>终于跟完了代码。我们来总结一下，整个流程：</p>
<ul>
<li><p>根据传入的 JobInfo，创建 JobStatus；</p>
</li>
<li><p>如果已经注册过一个相同 uid 和 jobId 的 job，就 cancel 之前注册过的 job；</p>
<ul>
<li>停止监控这个 job：<ul>
<li>从 JobStore 和 controller 的监控队列中移除这个 job，并停止 controller 对这个 job 的监控；</li>
</ul>
</li>
<li>如果这个任务在 mPendingJobs 队列中，移除它；</li>
<li>如果正在运行，取消这个任务；</li>
<li>更新 JSS 的状态！</li>
</ul>
</li>
<li><p>将新 job 加入到 JobStore 中，并通知 controller 开始监控新 schedule 的 job！</p>
<ul>
<li>如果 JobStore 中已经存在相同 uid 和 jobId 的 job，就取代这个 job ，并停止对这个旧 job 的监控！</li>
</ul>
</li>
<li><p>发送 MSG_CHECK_JOB 消息给 JobHandler，进行执行 job 前的检查！</p>
<ul>
<li>清空 mPendingJobs，为本次执行做准备，将 JobStore 中所有准备好的 job，加入到 runnableJobs 可执行列表中，再将 runnableJobs 列表中的所有 job 添加到 mPendingJobs 集合中！</li>
<li>给 mPendingJobs 集合中的 job 分配 JobSchedulerContext！</li>
</ul>
</li>
</ul>
<h2 id="7-2-JSC-和-JS-的关系"><a href="#7-2-JSC-和-JS-的关系" class="headerlink" title="7.2 JSC 和 JS 的关系"></a>7.2 JSC 和 JS 的关系</h2><p>先空着，后续补上！</p>
<h2 id="7-3-JSC-的-Job-分配算法"><a href="#7-3-JSC-的-Job-分配算法" class="headerlink" title="7.3 JSC 的 Job 分配算法"></a>7.3 JSC 的 Job 分配算法</h2><p>这里我们来总结一些 job 的分配算法：</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2016/04/13/Process篇 4 - 进程的 priority 和 oomAdj 简析/">Process篇 4 - 进程的 priority 和 oomAdj 简析</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-04-13</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/AndroidFramework源码分析/">AndroidFramework源码分析</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/AndroidFramework源码分析/Process进程/">Process进程</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/Process进程/">Process进程</a></span><div class="content"><p>基于 <code>Android 7.1.1</code> 源码，分析和总结进程相关的知识！ </p>
<p>本文参考：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//developer.android.com/guide/components/processes-and-threads.html</span></span><br></pre></td></tr></table></figure>
<h1 id="1-进程的重要性层次"><a href="#1-进程的重要性层次" class="headerlink" title="1 进程的重要性层次"></a>1 进程的重要性层次</h1><p>进程的重要性层次一共有 <code>5</code> 级，以下的部分内容截取自 <code>Android Developer Guide</code>！</p>
<blockquote>
<p><strong>From Android Developer Guide</strong></p>
</blockquote>
<p><strong>【前台进程 Foreground Process】</strong></p>
<p><strong>定义：</strong>用户当前操作所必需的进程。</p>
<ul>
<li>如果一个进程满足以下任一条件，即视为前台进程：<ul>
<li>托管用户正在交互的 <code>Activity</code>。（即已调用 <code>Activity</code> 的 <code>onResume()</code> 方法）</li>
<li>托管某个 <code>Service</code>，后者绑定到用户正在交互的 <code>Activity</code>。</li>
<li>托管正在 “前台” 运行的 <code>Service</code>。（服务已调用 <code>startForeground()</code>）</li>
<li>托管正执行一个生命周期回调的 <code>Service</code>。（比如：<code>onCreate()</code>，<code>onStart()</code>或 <code>onDestroy()</code>）</li>
<li>托管正执行其 <code>onReceive()</code> 方法的 <code>BroadcastReceiver</code></li>
</ul>
</li>
</ul>
<p>通常，在任意给定时间前台进程都为数不多。前台进程的优先级最高，只有在内存不足，万不得已的时候，系统才会杀掉他们！</p>
<p><br></p>
<p><strong>【可见进程 Visible Process】</strong></p>
<p><strong>定义：</strong>没有任何前台组件、但仍会影响用户在屏幕上所见内容的进程。</p>
<ul>
<li>如果一个进程满足以下任一条件，即视为可见进程：<ul>
<li>托管不在前台、但仍对用户可见的 <code>Activity</code>（已调用其 <code>onPause()</code> 方法）。<ul>
<li>例如，如果前台 <code>Activity</code> 启动了一个对话框，允许在其后显示上一个 <code>Activity</code>，则有可能会发生这种情况。</li>
</ul>
</li>
<li>托管绑定到可见（或前台）<code>Activity</code> 的 <code>Service</code>。</li>
</ul>
</li>
</ul>
<p>可见进程被视为是极其重要的进程，除非为了维持所有前台进程同时运行而必须终止，否则系统不会终止这些进程。</p>
<p><br></p>
<p><strong>【服务进程 Service Process】</strong></p>
<p><strong>定义：</strong>正在运行已使用 <code>startService()</code> 方法启动的服务且不属于上述两个更高类别进程的进程，那就属于服务进程！</p>
<p>可以看到管服务进程与用户所见内容没有直接关联，但是它们通常在执行一些用户关心的操作（例如，在后台播放音乐或从网络下载数据）。因此，除非内存不足以维持所有前台进程和可见进程同时运行，否则系统会让服务进程保持运行状态。</p>
<p><br></p>
<p><strong>【后台进程 Background Process】</strong></p>
<p><strong>定义：</strong>包含目前对用户不可见的 <code>Activity</code> 的进程（已调用 <code>Activity</code> 的 <code>onStop()</code> 方法）。</p>
<p>这些进程对用户体验没有直接影响，系统可能随时终止它们，以回收内存供前台进程、可见进程或服务进程使用。</p>
<p>通常会有很多后台进程在运行，因此它们会保存在 <code>LRU</code> （最近最少使用）列表中，以确保包含用户最近查看的 <code>Activity</code> 的进程最后一个被终止。</p>
<p>如果某个 <code>Activity</code> 正确实现了生命周期方法，并保存了其当前状态，则终止其进程不会对用户体验产生明显影响，因为当用户导航回该 <code>Activity</code> 时，<code>Activity</code> 会恢复其所有可见状态。</p>
<p><br></p>
<p><strong>【空进程 Empty Process】</strong></p>
<p><strong>定义：</strong>不含任何活动应用组件的进程。</p>
<p>保留这种进程的的唯一目的是用作缓存，以缩短下次在其中运行组件所需的启动时间。为使总体系统资源在进程缓存和底层内核缓存之间保持平衡，系统往往会终止这些进程。</p>
<blockquote>
<p><strong>End From</strong></p>
</blockquote>
<p>通过 <code>Android developer guide</code> 我们能可以知道进程优先级的 <code>5</code> 分类以及其满足的条件，这里我用一张思维导图简单的总结一下：</p>
<p><img src="http://static.zybuluo.com/Coolqi/cv25ynl7eto21cyv9mqwn5r7/aonaotu-download.png" alt="aonaotu-download.png-252.2kB"></p>
<p>注意：这只是一个粗略的划分。其实，在系统的内部实现中，优先级远不止这么五种。</p>
<h1 id="2-进程的优先级和状态"><a href="#2-进程的优先级和状态" class="headerlink" title="2 进程的优先级和状态"></a>2 进程的优先级和状态</h1><p>在 <code>ActivityManager.java</code> 中，我们可以通过一个方法来获得系统中所有正在运行中的应用进程的信息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;RunningAppProcessInfo&gt; <span class="title">getRunningAppProcesses</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ActivityManagerNative.getDefault().getRunningAppProcesses();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该方法会返回一个 <code>List</code> 列表，每一个进程都被封装成了一个 <code>RunningAppProcessInfo</code> 对象，<code>RunningAppProcessInfo</code> 中有几个重要的成员变量，用于表示进程的重要性和状态；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">int</span> importance;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">int</span> processState;</span><br></pre></td></tr></table></figure>
<p>其中，<code>processState</code> 表示的是进程的状态，系统是通过这个值来动态调节进程的优先级的；<code>importance</code> 则是进程的重要级别，它是系统暴露给外部的参数，用于获得自身或者其他一个应用进程的重要性级别，下面我们来看看二者的关系和定义！</p>
<h2 id="2-1-进程的优先级"><a href="#2-1-进程的优先级" class="headerlink" title="2.1 进程的优先级"></a>2.1 进程的优先级</h2><p>首先，来看看 <code>importance</code>，其表示进程的重要性级别，取值有如下的 <code>10</code> 种，定义在 <code>ActivityManager.java</code> 中！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 该进程持有前台 UI 界面，该 UI 界面正在和用户交互！</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> IMPORTANCE_FOREGROUND = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 该进程运行着一个前台服务，比如进程在播放音乐，即使用户没有在应用中，</span></span><br><span class="line"><span class="comment">// 这种状态表明进程正在做一些用户非常关心的事情！</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> IMPORTANCE_FOREGROUND_SERVICE = <span class="number">125</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 该进程虽然用户无法直接感知到，但在某种程度上他们仍然可以察觉到!</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> IMPORTANCE_PERCEPTIBLE = <span class="number">130</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 该进程运行着一个前台 UI 界面，但是由于设备进入了睡眠状态，因此对用户不可见，用户此时无法和其交互！</span></span><br><span class="line"><span class="comment">// 用户也无法感知该进程，但是当用户唤醒设备后，用户又可以与之交互，所以这种状态下的进程也是很重要的！</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> IMPORTANCE_TOP_SLEEPING = <span class="number">150</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 该进程中运行的应用，我们不能保存它的状态，所以当该进程退到后台时，我们不能杀死它！</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> IMPORTANCE_CANT_SAVE_STATE = <span class="number">170</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 该进程运行着一些没有在前台，但是对用户是可见的内容，其内部可能运行着一个在前台 UI 下面的窗口</span></span><br><span class="line"><span class="comment">//（其处于暂停状态，系统将其状态保存了下来，其没有和用户交互，但是一定程度来说对用户是可见的）；</span></span><br><span class="line"><span class="comment">// 其内部也可能运行着在系统控制下的服务！</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> IMPORTANCE_VISIBLE = <span class="number">200</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 服务进程，该进程包含一些在后台运行的服务，这些服务用户是无感知的，所以它们可以由系统相对自由地杀死！</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> IMPORTANCE_SERVICE = <span class="number">300</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 后台进程，用户完全无法感知到进程的存在</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> IMPORTANCE_BACKGROUND = <span class="number">400</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 空进程</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> IMPORTANCE_EMPTY = <span class="number">500</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 此进程不存在</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> IMPORTANCE_GONE = <span class="number">1000</span>;</span><br></pre></td></tr></table></figure>
<h2 id="2-2-进程的状态"><a href="#2-2-进程的状态" class="headerlink" title="2.2 进程的状态"></a>2.2 进程的状态</h2><p>接着，我们来看看 <code>processState</code>，其表示进程的状态，其取值范围有如下的 <code>17</code> 种，同样定义在 <code>ActivityManager.java</code> 中！</p>
<p>进程的状态是从 <code>android</code> 系统管理角度进行的分级，和 <code>lmk</code> 的分级不同！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 进程不存在！</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PROCESS_STATE_NONEXISTENT = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// persist 系统进程</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PROCESS_STATE_PERSISTENT = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// persist 系统进程，并且正在进行 UI 相关的操作！</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PROCESS_STATE_PERSISTENT_UI = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 该进程拥有当前用户可见的 top activity，其他可见的 activity 都在其下面！</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PROCESS_STATE_TOP = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 该进程拥有一个前台服务，该服务是由系统绑定的！</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PROCESS_STATE_BOUND_FOREGROUND_SERVICE = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 该进程拥有一个前台服务！</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PROCESS_STATE_FOREGROUND_SERVICE = <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 该进程拥有当前用户可见的 top activity，和 PROCESS_STATE_TOP 一样！</span></span><br><span class="line"><span class="comment">// 但此时设备处于休眠状态！</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PROCESS_STATE_TOP_SLEEPING = <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 对用户很重要的进程，用户可感知其存在</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PROCESS_STATE_IMPORTANT_FOREGROUND = <span class="number">6</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 对用户很重要的进程，用户不可感知其存在</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PROCESS_STATE_IMPORTANT_BACKGROUND = <span class="number">7</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 后台进程，正在执行备份 / 恢复操作！</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PROCESS_STATE_BACKUP = <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 后台进程，但是我们不能恢复其状态，所以尽量避免杀死该进程</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PROCESS_STATE_HEAVY_WEIGHT = <span class="number">9</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 后台进程，正在运行一个服务，执行某个操作！</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PROCESS_STATE_SERVICE = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 后台进程，正在运行一个广播接收者，处理广播！</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PROCESS_STATE_RECEIVER = <span class="number">11</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 后台进程，桌面 home activity 位于该进程中</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PROCESS_STATE_HOME = <span class="number">12</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 后台进程，拥有上一次显示给用户的 activity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PROCESS_STATE_LAST_ACTIVITY = <span class="number">13</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 缓存进程，供以后使用，内部包含 activity。</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PROCESS_STATE_CACHED_ACTIVITY = <span class="number">14</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 缓存进程，供以后使用，其为另一个内含 activity 的缓存进程的 client 端进程！</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PROCESS_STATE_CACHED_ACTIVITY_CLIENT = <span class="number">15</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 缓存进程，供以后使用，内部为空</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PROCESS_STATE_CACHED_EMPTY = <span class="number">16</span>;</span><br></pre></td></tr></table></figure>
<p>我们知道，每一个进程在系统中都有一个 <code>ProcessRecord</code> 对象与之对应，其内部封装着该进程的数据和组件信息，<code>ProcessRecord</code> 也有一些成员变量，其取值也是上面的这 <code>17</code> 种！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> curProcState = PROCESS_STATE_NONEXISTENT; <span class="comment">// Currently computed process state</span></span><br><span class="line"><span class="keyword">int</span> repProcState = PROCESS_STATE_NONEXISTENT; <span class="comment">// Last reported process state</span></span><br><span class="line"><span class="keyword">int</span> setProcState = PROCESS_STATE_NONEXISTENT; <span class="comment">// Last set process state in process tracker</span></span><br><span class="line"><span class="keyword">int</span> pssProcState = PROCESS_STATE_NONEXISTENT; <span class="comment">// Currently requesting pss for</span></span><br></pre></td></tr></table></figure>
<p><code>ActivityManagerService</code> 就是通过这些变量来设置和调整进程的状态的，这个我们后面再看！</p>
<h2 id="2-3-进程优先级和状态的转换"><a href="#2-3-进程优先级和状态的转换" class="headerlink" title="2.3 进程优先级和状态的转换"></a>2.3 进程优先级和状态的转换</h2><p>在系统中 <code>processState</code> 和 <code>importance</code> 是有相应的映射和转换关系的，其映射方法的定义在 <code>ActivityManager.java</code> 中！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SystemApi</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPackageImportance</span><span class="params">(String packageName)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//【1】获得进程的状态值！</span></span><br><span class="line">        <span class="keyword">int</span> procState = ActivityManagerNative.getDefault().getPackageProcessState(packageName,</span><br><span class="line">                mContext.getOpPackageName());</span><br><span class="line">        <span class="comment">//【2】将进程的状态映射为所属的重要性级别</span></span><br><span class="line">        <span class="keyword">return</span> RunningAppProcessInfo.procStateToImportance(procState);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最终的映射函数在 <code>RunningAppProcessInfo.procStateToImportance</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">procStateToImportance</span><span class="params">(<span class="keyword">int</span> procState)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//【1】将进程的状态转为对应的重要性级别！</span></span><br><span class="line">    <span class="keyword">if</span> (procState == PROCESS_STATE_NONEXISTENT) &#123; <span class="comment">// -1</span></span><br><span class="line">        <span class="keyword">return</span> IMPORTANCE_GONE;</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (procState &gt;= PROCESS_STATE_HOME) &#123; <span class="comment">// 12</span></span><br><span class="line">        <span class="keyword">return</span> IMPORTANCE_BACKGROUND;</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (procState &gt;= PROCESS_STATE_SERVICE) &#123; <span class="comment">// 10</span></span><br><span class="line">        <span class="keyword">return</span> IMPORTANCE_SERVICE;</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (procState &gt; PROCESS_STATE_HEAVY_WEIGHT) &#123; <span class="comment">// 9</span></span><br><span class="line">        <span class="keyword">return</span> IMPORTANCE_CANT_SAVE_STATE;</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (procState &gt;= PROCESS_STATE_IMPORTANT_BACKGROUND) &#123; <span class="comment">// 7</span></span><br><span class="line">        <span class="keyword">return</span> IMPORTANCE_PERCEPTIBLE;</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (procState &gt;= PROCESS_STATE_IMPORTANT_FOREGROUND) &#123; <span class="comment">// 6</span></span><br><span class="line">        <span class="keyword">return</span> IMPORTANCE_VISIBLE;</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (procState &gt;= PROCESS_STATE_TOP_SLEEPING) &#123; <span class="comment">// 5</span></span><br><span class="line">        <span class="keyword">return</span> IMPORTANCE_TOP_SLEEPING;</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (procState &gt;= PROCESS_STATE_FOREGROUND_SERVICE) &#123; <span class="comment">// 4</span></span><br><span class="line">        <span class="keyword">return</span> IMPORTANCE_FOREGROUND_SERVICE;</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> IMPORTANCE_FOREGROUND;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过该方法，我们可以知道，某个应用进程所属的重要性级别了！</p>
<p><strong>这里不解的是，对应关系中忽略掉了一些 <code>IMPORTANCE</code> 级别，不只是为什么！</strong></p>
<h1 id="3-进程的-oomAdj-值"><a href="#3-进程的-oomAdj-值" class="headerlink" title="3 进程的 oomAdj 值"></a>3 进程的 oomAdj 值</h1><p>说到 <code>oomAdj</code>，我们就要谈到 <code>Android</code> 中的一个很重要的机制 <code>Low Memory Killer</code>，也叫做低内存杀手！对于 <code>Low Memory Killer</code>，我后面会单独写一篇文章来分析和总结！</p>
<p><code>Low Memory Killer</code> 基于 <code>Linux</code> 的 <code>OOM</code> 机制，在 <code>Linux</code> 中，内存是以页面为单位分配的，当申请页面分配时如果内存不足会通过以下流程选择 <code>bad</code> 进程来杀掉从而释放内存：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alloc_pages -&gt; out_of_memory() -&gt; select_bad_process() -&gt; badness()</span><br></pre></td></tr></table></figure>
<p>而 <code>Low Memory Killer</code> 杀进程依据就是进程的 <code>oom_adj</code> 值，<code>oom_adj</code> 越小越不容易被杀死，对于 <code>oomAdj</code> 值，定义在 <code>ProcessList.java</code> 中;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 初始化值</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> INVALID_ADJ = -<span class="number">10000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 该值用于用于某些我们还没法确定具体值的地方，一般是指当一个进程要被缓存了，但我们还不知道要给它分配的</span></span><br><span class="line"><span class="comment">// 缓存进程的 adj 的具体值！</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> UNKNOWN_ADJ = <span class="number">1001</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 缓存进程，其 adj 的最大致和最小值，该进程仅托管不可见的 activity，他们容易就会被杀死！</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CACHED_APP_MAX_ADJ = <span class="number">906</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CACHED_APP_MIN_ADJ = <span class="number">900</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// B list 列表中的服务所在进程，该进程中的服务很老旧，使用率小，不像 A list 中的服务那样活跃和使用频繁！</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SERVICE_B_ADJ = <span class="number">800</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用户所在的上一个应用的进程</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PREVIOUS_APP_ADJ = <span class="number">700</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 托管着桌面 HOME 应用的进程，我们要尽量避免杀掉它，即使其退到了后台！因为用户和其交互的频率很高！</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> HOME_APP_ADJ = <span class="number">600</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 托管着应用 Service 的进程，杀掉这类进程对用户不会有太大的影响！</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SERVICE_ADJ = <span class="number">500</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 高权重 "heavy-weight" 应用所在进程，虽然该进程是在后台，但是我们要避免杀掉它</span></span><br><span class="line"><span class="comment">// 该 adj 是 "system/rootdir/init.rc" 在启动时设置的！</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> HEAVY_WEIGHT_APP_ADJ = <span class="number">400</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 正在执行备份 backup 操作的进程，</span></span><br><span class="line"><span class="comment">// 虽然杀掉这类进程不会导致严重问题，但是会导致备份的数据异常，所以杀掉它不是明智之举！</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BACKUP_APP_ADJ = <span class="number">300</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 仅持有用户可感知组件的进程，比如在后台播放音乐，虽然其对用户不是立即可见，但是我们也要比避免杀死它！</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PERCEPTIBLE_APP_ADJ = <span class="number">200</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 持有对用户可见的 activity 的进程，我们也要避免杀死他们！</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> VISIBLE_APP_ADJ = <span class="number">100</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> VISIBLE_APP_LAYER_MAX = PERCEPTIBLE_APP_ADJ - VISIBLE_APP_ADJ - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 运行着当前前台应用的进程，我们不能杀掉这类进程！</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FOREGROUND_APP_ADJ = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 被系统进程或者 persistent 进程绑定的进程！</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PERSISTENT_SERVICE_ADJ = -<span class="number">700</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 系统 persistent 进程，比如 telephony，这种类型的进程系统一定是不会杀死的！</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PERSISTENT_PROC_ADJ = -<span class="number">800</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 系统进程，默认分配！</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SYSTEM_ADJ = -<span class="number">900</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// native 进程，不受系统的管控！</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NATIVE_ADJ = -<span class="number">1000</span>;</span><br></pre></td></tr></table></figure>
<p>我们在前面知道了进程的重要性级别和进程的状态的映射关系，那么对于进程的状态和进程的 <code>oomAdj</code> 之间是否也有一定的联系呢？这里就要谈到 <code>oomAdj</code> 的调度算法，我会单独开一篇文章来分析！</p>
<p>接下来，我介绍下 <code>ProcessRecord</code> 中和 <code>oomAdj</code> 相关的几个重要变量，我们后续分析 <code>oomAdj</code> 的时候会遇到：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> maxAdj;                 <span class="comment">// 该进程最大的 Adj，进程的 adj 的设定不能超过该值</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> curRawAdj;              <span class="comment">// 在第一个过程评估后该进程具有的 adj 值，</span></span><br><span class="line"><span class="keyword">int</span> setRawAdj;              <span class="comment">// 上一次经过第一次评估后该进程具有的 adj 值，curRawAdj 被更新后，旧值会保存到 setRawAdj </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> curAdj;                 <span class="comment">// 进程当前的 adj 值，经过了两个过程评估，这才是进程实际的 adj 值</span></span><br><span class="line"><span class="keyword">int</span> setAdj;                 <span class="comment">// 上一次设置的 adj 值， curAdj 被更新了，旧值会被保存到 setAdj 中！</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> verifiedAdj;            <span class="comment">// The last adjustment that was verified as actually being set</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> curSchedGroup;          <span class="comment">// Currently desired scheduling class</span></span><br><span class="line"><span class="keyword">int</span> setSchedGroup;          <span class="comment">// Last set to background scheduling class</span></span><br></pre></td></tr></table></figure>
<p>对于 <code>low memory killer</code>，当系统的可用内存不够的时候，他会根据一定的策略来杀掉进程，释放内存，针对 <code>low memory killer</code> 我后续也会单独写一篇博文来分析！</p>
<h1 id="4-ActivityManager-相关接口"><a href="#4-ActivityManager-相关接口" class="headerlink" title="4 ActivityManager 相关接口"></a>4 ActivityManager 相关接口</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** <span class="doctag">@hide</span> Should this process state be considered a background state? */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">isProcStateBackground</span><span class="params">(<span class="keyword">int</span> procState)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> procState &gt;= PROCESS_STATE_BACKUP;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该方法用来判断，一个进程是否是后台进程！！</p>
<p><a href="http://melove.net/blog/2017/03/android-daemon-service-1488942411000.html" target="_blank" rel="noopener">http://melove.net/blog/2017/03/android-daemon-service-1488942411000.html</a></p>
<p><a href="http://www.cnblogs.com/angeldevil/category/336548.html" target="_blank" rel="noopener">http://www.cnblogs.com/angeldevil/category/336548.html</a></p>
<p><a href="http://blog.csdn.net/ccjhdopc/article/details/52818012" target="_blank" rel="noopener">http://blog.csdn.net/ccjhdopc/article/details/52818012</a></p>
<p><a href="http://blog.csdn.net/ccjhdopc/article/details/52818012" target="_blank" rel="noopener">http://blog.csdn.net/ccjhdopc/article/details/52818012</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2016/04/03/Serivce 篇 3 - stopService 流程分析/">Serivce 篇 3 - stopService 流程分析</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-04-03</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/AndroidFramework源码分析/">AndroidFramework源码分析</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/AndroidFramework源码分析/Service服务/">Service服务</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/Service服务/">Service服务</a></span><div class="content"><p>本文基于 Android 7.1.1 源码分析，转载请说明出处！</p>
<h1 id="0-综述"><a href="#0-综述" class="headerlink" title="0 综述"></a>0 综述</h1><p>我们通过 <code>startService</code> 启动的服务，需要通过 <code>stopService</code> 来停止：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">context.stopService(intent);</span><br></pre></td></tr></table></figure>
<p>以前我们只是会调用，但是其底层的调用到底是什么样的呢？知其然知其所以然，今天我们就来学习下 <code>stopService</code> 的过程！</p>
<p>如果之前并不了解这块逻辑的话，那该如何去学习呢？ follow the funtion path！</p>
<h1 id="1-发起端进程"><a href="#1-发起端进程" class="headerlink" title="1 发起端进程"></a>1 发起端进程</h1><h2 id="1-1-ContextWrapper-stopService"><a href="#1-1-ContextWrapper-stopService" class="headerlink" title="1.1 ContextWrapper.stopService"></a>1.1 ContextWrapper.stopService</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ContextWrapper</span> <span class="keyword">extends</span> <span class="title">Context</span> </span>&#123;</span><br><span class="line">    Context mBase;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ContextWrapper</span><span class="params">(Context base)</span> </span>&#123;</span><br><span class="line">        mBase = base;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">stopService</span><span class="params">(Intent name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mBase.stopService(name);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>ContextWrapper</code> 提供了两个方法来启动 <code>Service</code>，其中一个是隐藏方法：<code>startServiceAsUser</code>！</p>
<p><code>mBase</code> 是 <code>ContextImpl</code> 对象，继续看！</p>
<h2 id="1-2-ContextImpl-stopService"><a href="#1-2-ContextImpl-stopService" class="headerlink" title="1.2 ContextImpl.stopService"></a>1.2 ContextImpl.stopService</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ContextImpl</span> <span class="keyword">extends</span> <span class="title">Context</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">stopService</span><span class="params">(Intent service)</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 这里判断调用者是否是系统进程；</span></span><br><span class="line">        warnIfCallingFromSystemProcess();</span><br><span class="line">        <span class="comment">//【1】继续停止服务！</span></span><br><span class="line">        <span class="keyword">return</span> stopServiceCommon(service, mUser);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里调用了 <code>warnIfCallingFromSystemProcess</code>，判断是否是系统进程调用！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">warnIfCallingFromSystemProcess</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (Process.myUid() == Process.SYSTEM_UID) &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Calling a method in the system process without a qualified user: "</span></span><br><span class="line">                + Debug.getCallers(<span class="number">5</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>ContextImpl</code> 和 <code>ContextWrapper</code> 的具体关系，请来看另一博文：<code>Android</code> 系统的 <code>Context</code> 分析，这里我们不再详细说明！</p>
<p><code>mUser</code>：表示的是当前的设备 <code>user</code>！</p>
<p>最终，调用了 <code>stopServiceCommon</code> 方法；</p>
<h2 id="1-3-ContextImpl-stopServiceCommon"><a href="#1-3-ContextImpl-stopServiceCommon" class="headerlink" title="1.3 ContextImpl.stopServiceCommon"></a>1.3 ContextImpl.stopServiceCommon</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">stopServiceCommon</span><span class="params">(Intent service, UserHandle user)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        validateServiceIntent(service);</span><br><span class="line">        service.prepareToLeaveProcess(<span class="keyword">this</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【1】进入到系统进程，停止服务！</span></span><br><span class="line">        <span class="keyword">int</span> res = ActivityManagerNative.getDefault().stopService(</span><br><span class="line">            mMainThread.getApplicationThread(), service,</span><br><span class="line">            service.resolveTypeIfNeeded(getContentResolver()), user.getIdentifier());</span><br><span class="line">        <span class="keyword">if</span> (res &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(</span><br><span class="line">                    <span class="string">"Not allowed to stop service "</span> + service);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res != <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>validateServiceIntent 方法用用来校验启动用的 intent 是否安全：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">validateServiceIntent</span><span class="params">(Intent service)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (service.getComponent() == <span class="keyword">null</span> &amp;&amp; service.getPackage() == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (getApplicationInfo().targetSdkVersion &gt;= Build.VERSION_CODES.LOLLIPOP) &#123;</span><br><span class="line">            IllegalArgumentException ex = <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">                    <span class="string">"Service Intent must be explicit: "</span> + service);</span><br><span class="line">            <span class="keyword">throw</span> ex;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Log.w(TAG, <span class="string">"Implicit intents with startService are not safe: "</span> + service</span><br><span class="line">                    + <span class="string">" "</span> + Debug.getCallers(<span class="number">2</span>, <span class="number">3</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如果 <code>intent</code> 既没有设置 <code>component</code> 也没有设置 <code>package</code>，那就要判断一下系统的版本了: </p>
<ul>
<li>如果系统版本不低于 <code>L</code>，那就要抛出异常，提示必须是显示启动；</li>
<li>如果系统版本低于 <code>L</code>，那只提示隐式启动不安全；</li>
</ul>
<p>接着，调用 <code>ActivityManagerNative.getDefault()</code> 方法，获得 <code>AMS</code> 的代理对象 <code>ActivityManagerProxy</code>！</p>
<p><code>ActivityManagerProxy</code> 是 <code>ActivityManagerN</code> 的内部类，通过 <code>getDefault</code> 方法创建了对应的单例模式，保存在 <code>ActivityManagerNative</code> 的类变量 <code>getDefault</code> 中！</p>
<h2 id="1-4-ActivityManagerP-stopService"><a href="#1-4-ActivityManagerP-stopService" class="headerlink" title="1.4 ActivityManagerP.stopService"></a>1.4 ActivityManagerP.stopService</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">stopService</span><span class="params">(IApplicationThread caller, Intent service,</span></span></span><br><span class="line"><span class="function"><span class="params">        String resolvedType, <span class="keyword">int</span> userId)</span> <span class="keyword">throws</span> RemoteException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Parcel data = Parcel.obtain();</span><br><span class="line">    Parcel reply = Parcel.obtain();</span><br><span class="line">    data.writeInterfaceToken(IActivityManager.descriptor);</span><br><span class="line"></span><br><span class="line">    data.writeStrongBinder(caller != <span class="keyword">null</span> ? caller.asBinder() : <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">    service.writeToParcel(data, <span class="number">0</span>);</span><br><span class="line">    data.writeString(resolvedType);</span><br><span class="line">    data.writeInt(userId);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】binder 通信，阻塞式通信！！</span></span><br><span class="line">    mRemote.transact(STOP_SERVICE_TRANSACTION, data, reply, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    reply.readException();</span><br><span class="line">    <span class="keyword">int</span> res = reply.readInt();</span><br><span class="line">    reply.recycle();</span><br><span class="line">    data.recycle();</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过 <code>binder</code> 进程间通信，进入系统进程，参数分析：</p>
<ul>
<li><code>IApplicationThread caller</code>：调用者进程的 <code>ApplicationThread</code> 对象，实现了 <code>IApplicationThread</code> 接口；</li>
<li><code>Intent service</code>：启动的 <code>intent</code>；</li>
<li><code>String resolvedType</code>：这个 <code>intent</code> 的 <code>MIME</code> 类型；</li>
<li><code>String callingPackage</code>：启动者所属包名；</li>
<li><code>int userId</code>：设备用户 <code>id</code>；</li>
</ul>
<h1 id="2-系统进程"><a href="#2-系统进程" class="headerlink" title="2 系统进程"></a>2 系统进程</h1><p>接下来，进入系统进程的 <code>ActivityManagerService</code> 中！</p>
<p>首先要进入 <code>ActivityManagerN.onTransact</code> 方法！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> STOP_SERVICE_TRANSACTION: &#123;</span><br><span class="line">    data.enforceInterface(IActivityManager.descriptor);</span><br><span class="line">    IBinder b = data.readStrongBinder();</span><br><span class="line"></span><br><span class="line">    IApplicationThread app = ApplicationThreadNative.asInterface(b);</span><br><span class="line"></span><br><span class="line">    Intent service = Intent.CREATOR.createFromParcel(data);</span><br><span class="line">    String resolvedType = data.readString();</span><br><span class="line">    <span class="keyword">int</span> userId = data.readInt();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】继续调用 stopService 方法！</span></span><br><span class="line">    <span class="keyword">int</span> res = stopService(app, service, resolvedType, userId);</span><br><span class="line"></span><br><span class="line">    reply.writeNoException();</span><br><span class="line">    reply.writeInt(res);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="2-1-ActivityManagerS-stopService"><a href="#2-1-ActivityManagerS-stopService" class="headerlink" title="2.1 ActivityManagerS.stopService"></a>2.1 ActivityManagerS.stopService</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">stopService</span><span class="params">(IApplicationThread caller, Intent service,</span></span></span><br><span class="line"><span class="function"><span class="params">        String resolvedType, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 隔离进程不能调用这个方法！</span></span><br><span class="line">    enforceNotIsolatedCaller(<span class="string">"stopService"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 不能用 intent 传递文件描述符！</span></span><br><span class="line">    <span class="keyword">if</span> (service != <span class="keyword">null</span> &amp;&amp; service.hasFileDescriptors() == <span class="keyword">true</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"File descriptors passed in Intent"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//【1】进入 ActiveServices </span></span><br><span class="line">        <span class="keyword">return</span> mServices.stopServiceLocked(caller, service, resolvedType, userId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>mServices</code> 是 <code>ActivityManagerService</code> 的一个内部管理对象，用于管理所有的 <code>Service</code>！</p>
<h2 id="2-2-ActiveServices-stopServiceLocked"><a href="#2-2-ActiveServices-stopServiceLocked" class="headerlink" title="2.2 ActiveServices.stopServiceLocked"></a>2.2 ActiveServices.stopServiceLocked</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">stopServiceLocked</span><span class="params">(IApplicationThread caller, Intent service,</span></span></span><br><span class="line"><span class="function"><span class="params">        String resolvedType, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE, <span class="string">"stopService: "</span> + service</span><br><span class="line">            + <span class="string">" type="</span> + resolvedType);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获得调用者所在进程！</span></span><br><span class="line">    <span class="keyword">final</span> ProcessRecord callerApp = mAm.getRecordForAppLocked(caller);</span><br><span class="line">    <span class="keyword">if</span> (caller != <span class="keyword">null</span> &amp;&amp; callerApp == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(</span><br><span class="line">                <span class="string">"Unable to find app for caller "</span> + caller</span><br><span class="line">                + <span class="string">" (pid="</span> + Binder.getCallingPid()</span><br><span class="line">                + <span class="string">") when stopping service "</span> + service);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】查询要停止的服务的信息！</span></span><br><span class="line">    ServiceLookupResult r = retrieveServiceLocked(service, resolvedType, <span class="keyword">null</span>,</span><br><span class="line">            Binder.getCallingPid(), Binder.getCallingUid(), userId, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (r.record != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> origId = Binder.clearCallingIdentity();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">            </span><br><span class="line">                <span class="comment">//【2】继续停止服务！</span></span><br><span class="line">                stopServiceLocked(r.record);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                Binder.restoreCallingIdentity(origId);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-2-1-ActiveServices-retrieveServiceLocked"><a href="#2-2-1-ActiveServices-retrieveServiceLocked" class="headerlink" title="2.2.1 ActiveServices.retrieveServiceLocked"></a>2.2.1 ActiveServices.retrieveServiceLocked</h3><p>根据 <code>intent</code> 来查询被启动服务的 <code>ServiceRecord</code> 对象，参数传递：</p>
<ul>
<li><code>boolean createIfNeeded</code>：传入的是 <code>true</code>；</li>
<li><code>boolean callingFromFg</code>：表示是从前台调用，还是后台调用；</li>
<li><code>boolean isBindExternal</code>：表示 <code>bind</code> 的是否是 <code>isolated</code>, <code>external</code> 类型的服务，我们这里默认为 <code>false</code>；</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> ServiceLookupResult <span class="title">retrieveServiceLocked</span><span class="params">(Intent service,</span></span></span><br><span class="line"><span class="function"><span class="params">        String resolvedType, String callingPackage, <span class="keyword">int</span> callingPid, <span class="keyword">int</span> callingUid, <span class="keyword">int</span> userId,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> createIfNeeded, <span class="keyword">boolean</span> callingFromFg, <span class="keyword">boolean</span> isBindExternal)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    ServiceRecord r = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG_SERVICE)</span><br><span class="line">        Slog.v(TAG_SERVICE, <span class="string">"retrieveServiceLocked: "</span> + service</span><br><span class="line">            + <span class="string">" type="</span> + resolvedType + <span class="string">" callingUid="</span> + callingUid);</span><br><span class="line"></span><br><span class="line">    userId = mAm.mUserController.handleIncomingUser(callingPid, callingUid, userId, <span class="keyword">false</span>,</span><br><span class="line">            ActivityManagerService.ALLOW_NON_FULL_IN_PROFILE, <span class="string">"service"</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从 ActiveServices 的 mServiceMap 中获得设备用户 userId 下的所有服务列表！</span></span><br><span class="line">    ServiceMap smap = getServiceMap(userId);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 如果 intent 有设置组件名，就从 smap.mServicesByName 中获取！</span></span><br><span class="line">    <span class="keyword">final</span> ComponentName comp = service.getComponent();</span><br><span class="line">    <span class="keyword">if</span> (comp != <span class="keyword">null</span>) &#123;</span><br><span class="line">        r = smap.mServicesByName.get(comp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果 intent 没有设置组件名，就从 smap.mServicesByIntent 通过 filter 获得！</span></span><br><span class="line">    <span class="keyword">if</span> (r == <span class="keyword">null</span> &amp;&amp; !isBindExternal) &#123;</span><br><span class="line">        Intent.FilterComparison filter = <span class="keyword">new</span> Intent.FilterComparison(service);</span><br><span class="line">        r = smap.mServicesByIntent.get(filter);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 对于 external 类型的服务，只能限制其应用程序自己 bind！</span></span><br><span class="line">    <span class="keyword">if</span> (r != <span class="keyword">null</span> &amp;&amp; (r.serviceInfo.flags &amp; ServiceInfo.FLAG_EXTERNAL_SERVICE) != <span class="number">0</span></span><br><span class="line">            &amp;&amp; !callingPackage.equals(r.packageName)) &#123;</span><br><span class="line"></span><br><span class="line">        r = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 通过 PMS，查询能够匹配 intent 的服务！</span></span><br><span class="line">            ResolveInfo rInfo = AppGlobals.getPackageManager().resolveService(service,</span><br><span class="line">                    resolvedType, ActivityManagerService.STOCK_PM_FLAGS</span><br><span class="line">                            | PackageManager.MATCH_DEBUG_TRIAGED_MISSING,</span><br><span class="line">                    userId);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 获得服务信息！</span></span><br><span class="line">            ServiceInfo sInfo =</span><br><span class="line">                rInfo != <span class="keyword">null</span> ? rInfo.serviceInfo : <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (sInfo == <span class="keyword">null</span>) &#123;</span><br><span class="line">                Slog.w(TAG_SERVICE, <span class="string">"Unable to start service "</span> + service + <span class="string">" U="</span> + userId +</span><br><span class="line">                      <span class="string">": not found"</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ComponentName name = <span class="keyword">new</span> ComponentName(</span><br><span class="line">                    sInfo.applicationInfo.packageName, sInfo.name);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 如果服务类型是 external 的，那么 bind 时必须加 BIND_EXTERNAL_SERVICE 的标志！</span></span><br><span class="line">            <span class="comment">// 不然会抛出安全异常！</span></span><br><span class="line">            <span class="keyword">if</span> ((sInfo.flags &amp; ServiceInfo.FLAG_EXTERNAL_SERVICE) != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (isBindExternal) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!sInfo.exported) &#123;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// 对于 external  类型的服务，必须要设置 android:exported 的值为 true，不然抛异常！</span></span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"BIND_EXTERNAL_SERVICE failed, "</span> + name +</span><br><span class="line">                                <span class="string">" is not exported"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// 对于 external 类型的服务，必须运行在隔离进程中！</span></span><br><span class="line">                    <span class="keyword">if</span> ((sInfo.flags &amp; ServiceInfo.FLAG_ISOLATED_PROCESS) == <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"BIND_EXTERNAL_SERVICE failed, "</span> + name +</span><br><span class="line">                                <span class="string">" is not an isolatedProcess"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 获得调用者应用的 ApplicationInfo 信息</span></span><br><span class="line">                    ApplicationInfo aInfo = AppGlobals.getPackageManager().getApplicationInfo(</span><br><span class="line">                            callingPackage, ActivityManagerService.STOCK_PM_FLAGS, userId);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (aInfo == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"BIND_EXTERNAL_SERVICE failed, "</span> +</span><br><span class="line">                                <span class="string">"could not resolve client package "</span> + callingPackage);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    sInfo = <span class="keyword">new</span> ServiceInfo(sInfo);</span><br><span class="line">                    sInfo.applicationInfo = <span class="keyword">new</span> ApplicationInfo(sInfo.applicationInfo);</span><br><span class="line">                    sInfo.applicationInfo.packageName = aInfo.packageName;</span><br><span class="line">                    sInfo.applicationInfo.uid = aInfo.uid;</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// 设置 ComponentName 对象！</span></span><br><span class="line">                    name = <span class="keyword">new</span> ComponentName(aInfo.packageName, name.getClassName());</span><br><span class="line">                    service.setComponent(name);</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"BIND_EXTERNAL_SERVICE required for "</span> +</span><br><span class="line">                            name);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isBindExternal) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"BIND_EXTERNAL_SERVICE failed, "</span> + name +</span><br><span class="line">                        <span class="string">" is not an externalService"</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 处理多用户的情况！</span></span><br><span class="line">            <span class="keyword">if</span> (userId &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mAm.isSingleton(sInfo.processName, sInfo.applicationInfo,</span><br><span class="line">                        sInfo.name, sInfo.flags)</span><br><span class="line">                        &amp;&amp; mAm.isValidSingletonCall(callingUid, sInfo.applicationInfo.uid)) &#123;</span><br><span class="line">                    userId = <span class="number">0</span>;</span><br><span class="line">                    smap = getServiceMap(<span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                sInfo = <span class="keyword">new</span> ServiceInfo(sInfo);</span><br><span class="line">                sInfo.applicationInfo = mAm.getAppInfoForUser(sInfo.applicationInfo, userId);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 根据 ComponentName 获得 ServiceRecord 对象！</span></span><br><span class="line">            r = smap.mServicesByName.get(name);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (r == <span class="keyword">null</span> &amp;&amp; createIfNeeded) &#123;</span><br><span class="line"></span><br><span class="line">                Intent.FilterComparison filter</span><br><span class="line">                        = <span class="keyword">new</span> Intent.FilterComparison(service.cloneFilter());</span><br><span class="line">                        </span><br><span class="line">                <span class="comment">// 创建服务重启对象，这是一个 Runnable 对象！！</span></span><br><span class="line">                ServiceRestarter res = <span class="keyword">new</span> ServiceRestarter();</span><br><span class="line"></span><br><span class="line">                BatteryStatsImpl.Uid.Pkg.Serv ss = <span class="keyword">null</span>;</span><br><span class="line">                BatteryStatsImpl stats = mAm.mBatteryStatsService.getActiveStatistics();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">synchronized</span> (stats) &#123;</span><br><span class="line">                    ss = stats.getServiceStatsLocked(</span><br><span class="line">                            sInfo.applicationInfo.uid, sInfo.packageName,</span><br><span class="line">                            sInfo.name);</span><br><span class="line">                &#125;</span><br><span class="line">                 </span><br><span class="line">                <span class="comment">// 创建新的 ServiceRecord 对象！</span></span><br><span class="line">                r = <span class="keyword">new</span> ServiceRecord(mAm, ss, name, filter, sInfo, callingFromFg, res);</span><br><span class="line">                res.setService(r);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 将新的 ServiceRecord 添加到 smap.mServicesByName 和 smap.mServicesByIntent 中！</span></span><br><span class="line">                smap.mServicesByName.put(name, r);</span><br><span class="line">                smap.mServicesByIntent.put(filter, r);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 从 mPendingServices 中移除这个 ServiceRecord！</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i=mPendingServices.size()-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</span><br><span class="line">                    ServiceRecord pr = mPendingServices.get(i);</span><br><span class="line">                    <span class="keyword">if</span> (pr.serviceInfo.applicationInfo.uid == sInfo.applicationInfo.uid</span><br><span class="line">                            &amp;&amp; pr.name.equals(name)) &#123;</span><br><span class="line">                        mPendingServices.remove(i);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">            <span class="comment">// pm is in same process, this will never happen.</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 下面对查询的数据进行封装！</span></span><br><span class="line">    <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mAm.checkComponentPermission(r.permission,</span><br><span class="line">                callingPid, callingUid, r.appInfo.uid, r.exported)</span><br><span class="line">                != PackageManager.PERMISSION_GRANTED) &#123; <span class="comment">// 检查权限如果不授予！</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!r.exported) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Permission Denial: Accessing service "</span> + r.name</span><br><span class="line">                        + <span class="string">" from pid="</span> + callingPid</span><br><span class="line">                        + <span class="string">", uid="</span> + callingUid</span><br><span class="line">                        + <span class="string">" that is not exported from uid "</span> + r.appInfo.uid);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 异常返回，_record 为 null，无法启动！</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> ServiceLookupResult(<span class="keyword">null</span>, <span class="string">"not exported from uid "</span></span><br><span class="line">                        + r.appInfo.uid);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Slog.w(TAG, <span class="string">"Permission Denial: Accessing service "</span> + r.name</span><br><span class="line">                    + <span class="string">" from pid="</span> + callingPid</span><br><span class="line">                    + <span class="string">", uid="</span> + callingUid</span><br><span class="line">                    + <span class="string">" requires "</span> + r.permission);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 异常返回，_record 为 null，无法启动！</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ServiceLookupResult(<span class="keyword">null</span>, r.permission);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (r.permission != <span class="keyword">null</span> &amp;&amp; callingPackage != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> opCode = AppOpsManager.permissionToOpCode(r.permission);</span><br><span class="line">            <span class="keyword">if</span> (opCode != AppOpsManager.OP_NONE &amp;&amp; mAm.mAppOpsService.noteOperation(</span><br><span class="line">                    opCode, callingUid, callingPackage) != AppOpsManager.MODE_ALLOWED) &#123;</span><br><span class="line">                    </span><br><span class="line">                Slog.w(TAG, <span class="string">"Appop Denial: Accessing service "</span> + r.name</span><br><span class="line">                        + <span class="string">" from pid="</span> + callingPid</span><br><span class="line">                        + <span class="string">", uid="</span> + callingUid</span><br><span class="line">                        + <span class="string">" requires appop "</span> + AppOpsManager.opToName(opCode));</span><br><span class="line">                        </span><br><span class="line">                <span class="comment">// 异常返回，无法启动！</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!mAm.mIntentFirewall.checkService(r.name, service, callingUid, callingPid,</span><br><span class="line">                resolvedType, r.appInfo)) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 异常返回，无法启动！</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 返回最终的服务封装类！！</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ServiceLookupResult(r, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个方法的最终目的是返回要启动的服务的信息封装对象 ServiceLookupResult！</p>
<h2 id="2-3-ActiveServices-stopServiceLocked"><a href="#2-3-ActiveServices-stopServiceLocked" class="headerlink" title="2.3 ActiveServices.stopServiceLocked"></a>2.3 ActiveServices.stopServiceLocked</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">stopServiceLocked</span><span class="params">(ServiceRecord service)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【1】如果服务是延迟启动的，但是还没有启动！</span></span><br><span class="line">    <span class="keyword">if</span> (service.delayed) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (DEBUG_DELAYED_STARTS) Slog.v(TAG_SERVICE, <span class="string">"Delaying stop of pending: "</span> + service);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 那就设置 delayedStop 为 true，这样服务在延迟启动时会判断这个变量，如果为 true，就不会启动这个服务！</span></span><br><span class="line">        service.delayedStop = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (service.stats.getBatteryStats()) &#123;</span><br><span class="line">        service.stats.stopRunningLocked();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【2】因为要停止服务了，所以设 startRequested 为 false！</span></span><br><span class="line">    service.startRequested = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (service.tracker != <span class="keyword">null</span>) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 停止监控！</span></span><br><span class="line">        service.tracker.setStarted(<span class="keyword">false</span>, mAm.mProcessStats.getMemFactorLocked(),</span><br><span class="line">                SystemClock.uptimeMillis());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【3】设置 callStart 为 false！</span></span><br><span class="line">    service.callStart = <span class="keyword">false</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【4】停止服务！！</span></span><br><span class="line">    bringDownServiceIfNeededLocked(service, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-4-ActiveServices-bringDownServiceIfNeededLocked"><a href="#2-4-ActiveServices-bringDownServiceIfNeededLocked" class="headerlink" title="2.4 ActiveServices.bringDownServiceIfNeededLocked"></a>2.4 ActiveServices.bringDownServiceIfNeededLocked</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">bringDownServiceIfNeededLocked</span><span class="params">(ServiceRecord r, <span class="keyword">boolean</span> knowConn,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> hasConn)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【1】如果这个服务还被需要，就不能停止！</span></span><br><span class="line">    <span class="keyword">if</span> (isServiceNeeded(r, knowConn, hasConn)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果该服务正在等待其进程启动，就不能停止！</span></span><br><span class="line">    <span class="keyword">if</span> (mPendingServices.contains(r)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】继续停止服务！</span></span><br><span class="line">    bringDownServiceLocked(r);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果这个服务仍然被需要，或者服务所在的进程正在启动，这两种情况下，不能停止服务！</p>
<h3 id="2-4-1-ActiveServices-isServiceNeeded"><a href="#2-4-1-ActiveServices-isServiceNeeded" class="headerlink" title="2.4.1 ActiveServices.isServiceNeeded"></a>2.4.1 ActiveServices.isServiceNeeded</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">isServiceNeeded</span><span class="params">(ServiceRecord r, <span class="keyword">boolean</span> knowConn, <span class="keyword">boolean</span> hasConn)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (r.startRequested) &#123; <span class="comment">// 显然 r.startRequested 已经被置为 false！</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果仍然有自动创建的连接，那就不能 stop 该服务！</span></span><br><span class="line">    <span class="keyword">if</span> (!knowConn) &#123;</span><br><span class="line">        hasConn = r.hasAutoCreateConnections();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (hasConn) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>判断一个服务是否仍被需要，有两种情况：</p>
<ul>
<li>服务已经被请求启动，<code>stopService</code> 前面会被置为 <code>false</code>；</li>
<li>服务被应用通过自动创建的方式绑定，即 <code>bindService</code> 时，<code>flags</code> 为 <code>Context.BIND_AUTO_CREATE</code>；</li>
</ul>
<p>继续来看！</p>
<h2 id="2-5-ActiveServices-bringDownServiceLocked"><a href="#2-5-ActiveServices-bringDownServiceLocked" class="headerlink" title="2.5 ActiveServices.bringDownServiceLocked"></a>2.5 ActiveServices.bringDownServiceLocked</h2><p>我们来看看 bringDownServiceLocked 方法做了什么：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">bringDownServiceLocked</span><span class="params">(ServiceRecord r)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//Slog.i(TAG, "Bring down service:");</span></span><br><span class="line">    <span class="comment">//r.dump("  ");</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】首先，遍历 r.connections 集合，终止所有的 bind 连接</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> conni=r.connections.size()-<span class="number">1</span>; conni&gt;=<span class="number">0</span>; conni--) &#123;</span><br><span class="line"></span><br><span class="line">        ArrayList&lt;ConnectionRecord&gt; c = r.connections.valueAt(conni);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;c.size(); i++) &#123;</span><br><span class="line">            ConnectionRecord cr = c.get(i);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 设置 serviceDead 为 true，表示服务要被 stop 掉，连接断开！</span></span><br><span class="line">            cr.serviceDead = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 1、Binder 调用，进入应用进程触发 ServiceConnection 的 onServiceDisconnected，这是非阻塞的！</span></span><br><span class="line">                <span class="comment">// 这里第二个参数，为 null，所以会触发 onServiceDisconnected！</span></span><br><span class="line">                cr.conn.connected(r.name, <span class="keyword">null</span>);</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Failure disconnecting service "</span> + r.name +</span><br><span class="line">                      <span class="string">" to connection "</span> + c.get(i).conn.asBinder() +</span><br><span class="line">                      <span class="string">" (in "</span> + c.get(i).binding.client.processName + <span class="string">")"</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【2】处理所有的 r.bindings 集合中的 IntentBindRecord 对象！</span></span><br><span class="line">    <span class="keyword">if</span> (r.app != <span class="keyword">null</span> &amp;&amp; r.app.thread != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=r.bindings.size()-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</span><br><span class="line"></span><br><span class="line">            IntentBindRecord ibr = r.bindings.valueAt(i);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE, <span class="string">"Bringing down binding "</span> + ibr</span><br><span class="line">                    + <span class="string">": hasBound="</span> + ibr.hasBound);</span><br><span class="line">                    </span><br><span class="line">            <span class="keyword">if</span> (ibr.hasBound) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// 设置 unbind 超时处理</span></span><br><span class="line">                    bumpServiceExecutingLocked(r, <span class="keyword">false</span>, <span class="string">"bring down unbind"</span>);</span><br><span class="line">                    mAm.updateOomAdjLocked(r.app);</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// 置 IntentBindRecord 对象的 hasBound 为 false，表示 bind 断开；</span></span><br><span class="line">                    ibr.hasBound = <span class="keyword">false</span>;</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">//【2.1】通过 bind 通信，进入服务的应用进程，调用 AT.scheduleUnbindService 方法</span></span><br><span class="line">                    <span class="comment">// ，拉起服务的 onUnbind 方法，接触绑定！</span></span><br><span class="line">                    r.app.thread.scheduleUnbindService(r,</span><br><span class="line">                            ibr.intent.getIntent());</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"Exception when unbinding service "</span></span><br><span class="line">                            + r.shortName, e);</span><br><span class="line"></span><br><span class="line">                    serviceProcessGoneLocked(r);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE, <span class="string">"Bringing down "</span> + r + <span class="string">" "</span> + r.intent);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置服务的销毁时间</span></span><br><span class="line">    r.destroyTime = SystemClock.uptimeMillis();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (LOG_SERVICE_START_STOP) &#123;</span><br><span class="line">        EventLogTags.writeAmDestroyService(</span><br><span class="line">                r.userId, System.identityHashCode(r), (r.app != <span class="keyword">null</span>) ? r.app.pid : -<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> ServiceMap smap = getServiceMap(r.userId);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从 ActiveServices 的 mServiceMap 中移除服务 ServiceRecord 对象！</span></span><br><span class="line">    smap.mServicesByName.remove(r.name);</span><br><span class="line">    smap.mServicesByIntent.remove(r.intent);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 重启参数置为 0</span></span><br><span class="line">    r.totalRestartCount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 取消重启任务</span></span><br><span class="line">    unscheduleServiceRestartLocked(r, <span class="number">0</span>, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从 mPendingServices 列表中移除！</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=mPendingServices.size()-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mPendingServices.get(i) == r) &#123;</span><br><span class="line">            mPendingServices.remove(i);</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE, <span class="string">"Removed pending: "</span> + r);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 取消前台的通知！</span></span><br><span class="line">    cancelForegroudNotificationLocked(r);</span><br><span class="line">    </span><br><span class="line">    r.isForeground = <span class="keyword">false</span>;</span><br><span class="line">    r.foregroundId = <span class="number">0</span>;</span><br><span class="line">    r.foregroundNoti = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 清理启动项集合！</span></span><br><span class="line">    r.clearDeliveredStartsLocked();</span><br><span class="line">    r.pendingStarts.clear();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r.app != <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (r.stats.getBatteryStats()) &#123;</span><br><span class="line">            r.stats.stopLaunchedLocked();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 将服务从其所在进程的 app.services 集合中删除！</span></span><br><span class="line">        r.app.services.remove(r);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (r.whitelistManager) &#123;</span><br><span class="line">            updateWhitelistManagerLocked(r.app);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (r.app.thread != <span class="keyword">null</span>) &#123;</span><br><span class="line">            updateServiceForegroundLocked(r.app, <span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                 </span><br><span class="line">                <span class="comment">// 设置 destroy 超时处理！                   </span></span><br><span class="line">                bumpServiceExecutingLocked(r, <span class="keyword">false</span>, <span class="string">"destroy"</span>);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 将其添加到 AS 的 mDestroyingServices 机和中，表示服务正在销毁！</span></span><br><span class="line">                mDestroyingServices.add(r);</span><br><span class="line">                r.destroying = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">                mAm.updateOomAdjLocked(r.app);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 3、通过 binder 通信，回调 AT 的 scheduleStopService 方法！</span></span><br><span class="line">                r.app.thread.scheduleStopService(r);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Exception when destroying service "</span></span><br><span class="line">                        + r.shortName, e);</span><br><span class="line"></span><br><span class="line">                serviceProcessGoneLocked(r);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(</span><br><span class="line">                TAG_SERVICE, <span class="string">"Removed service that has no process: "</span> + r);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(</span><br><span class="line">            TAG_SERVICE, <span class="string">"Removed service that is not running: "</span> + r);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 清空服务的 bindings 集合！</span></span><br><span class="line">    <span class="keyword">if</span> (r.bindings.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        r.bindings.clear();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将服务的重启任务对象置空！</span></span><br><span class="line">    <span class="keyword">if</span> (r.restarter <span class="keyword">instanceof</span> ServiceRestarter) &#123;</span><br><span class="line">       ((ServiceRestarter)r.restarter).setService(<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> memFactor = mAm.mProcessStats.getMemFactorLocked();</span><br><span class="line">    <span class="keyword">long</span> now = SystemClock.uptimeMillis();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r.tracker != <span class="keyword">null</span>) &#123;</span><br><span class="line">        r.tracker.setStarted(<span class="keyword">false</span>, memFactor, now);</span><br><span class="line">        r.tracker.setBound(<span class="keyword">false</span>, memFactor, now);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (r.executeNesting == <span class="number">0</span>) &#123;</span><br><span class="line">            r.tracker.clearCurrentOwner(r, <span class="keyword">false</span>);</span><br><span class="line">            r.tracker = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    smap.ensureNotStartingBackground(r);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这段代码很简单，主要逻辑如下：</p>
<ul>
<li>首先进入绑定服务的应用进程，回调 ServiceConnection 的 onServiceDisconnected 方法，取消所有进程对该服务的绑定；</li>
<li>接着，进入服务所在的进程，拉起服务的 onUnbind 方法；</li>
<li>最后，拉起服务的 onDestroy 方法，销毁服务；</li>
</ul>
<p>整个过程，还会清空和重置一些关键变量！！</p>
<p>下面我们重点分析一下上面的三个过程！</p>
<h1 id="3-绑定者进程"><a href="#3-绑定者进程" class="headerlink" title="3 绑定者进程"></a>3 绑定者进程</h1><p>系统进程会调用 IServiceConnection.Proxy 代理对象的 connected 方法，通过 binder 调用，进入绑定服务的应用进程，这个是异步调用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cr.conn.connected(r.name, <span class="keyword">null</span>);</span><br></pre></td></tr></table></figure>
<p>我们去看看！</p>
<h2 id="3-1-InnerConnection-connected"><a href="#3-1-InnerConnection-connected" class="headerlink" title="3.1 InnerConnection.connected"></a>3.1 InnerConnection.connected</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">InnerConnection</span> <span class="keyword">extends</span> <span class="title">IServiceConnection</span>.<span class="title">Stub</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> WeakReference&lt;LoadedApk.ServiceDispatcher&gt; mDispatcher;</span><br><span class="line"></span><br><span class="line">    InnerConnection(LoadedApk.ServiceDispatcher sd) &#123;</span><br><span class="line">        mDispatcher = <span class="keyword">new</span> WeakReference&lt;LoadedApk.ServiceDispatcher&gt;(sd);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">connected</span><span class="params">(ComponentName name, IBinder service)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line"></span><br><span class="line">        LoadedApk.ServiceDispatcher sd = mDispatcher.get();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (sd != <span class="keyword">null</span>) &#123;</span><br><span class="line">        </span><br><span class="line">            <span class="comment">// 调用 mDispatcher 对象的 connected，这里的 service 为 null；</span></span><br><span class="line">            sd.connected(name, service);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>继续来看：</p>
<h2 id="3-2-ServiceDispatcher-connected"><a href="#3-2-ServiceDispatcher-connected" class="headerlink" title="3.2 ServiceDispatcher.connected"></a>3.2 ServiceDispatcher.connected</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">connected</span><span class="params">(ComponentName name, IBinder service)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mActivityThread != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mActivityThread.post(<span class="keyword">new</span> RunConnection(name, service, <span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        doConnected(name, service);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看过 bindService 一文的朋友，应该知道，最后都会调用 doConnected 方法：</p>
<h2 id="3-3-ServiceDispatcher-doConnected"><a href="#3-3-ServiceDispatcher-doConnected" class="headerlink" title="3.3 ServiceDispatcher.doConnected"></a>3.3 ServiceDispatcher.doConnected</h2><p>参数 service 这里为 null！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doConnected</span><span class="params">(ComponentName name, IBinder service)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    ServiceDispatcher.ConnectionInfo old;</span><br><span class="line">    ServiceDispatcher.ConnectionInfo info;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (mForgotten) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 获得已有的活跃的 connection 对象！</span></span><br><span class="line">        old = mActiveConnections.get(name);</span><br><span class="line">        <span class="keyword">if</span> (old != <span class="keyword">null</span> &amp;&amp; old.binder == service) &#123; <span class="comment">// 因为 service 为 null，所以这里不会进入该分支！</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (service != <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// A new service is being connected... set it all up.</span></span><br><span class="line">            info = <span class="keyword">new</span> ConnectionInfo();</span><br><span class="line">            info.binder = service;</span><br><span class="line">            info.deathMonitor = <span class="keyword">new</span> DeathMonitor(name, service);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                service.linkToDeath(info.deathMonitor, <span class="number">0</span>);</span><br><span class="line">                mActiveConnections.put(name, info);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// This service was dead before we got it...  just</span></span><br><span class="line">                <span class="comment">// don't do anything with it.</span></span><br><span class="line">                mActiveConnections.remove(name);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// service 为 null，说明是解除绑定，所以要从 mActiveConnections 中移除绑定对象！</span></span><br><span class="line">            mActiveConnections.remove(name);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 取消死亡通知监控器</span></span><br><span class="line">        <span class="keyword">if</span> (old != <span class="keyword">null</span>) &#123;</span><br><span class="line">            old.binder.unlinkToDeath(old.deathMonitor, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 之前是有连接的，所以会进入这分支！！</span></span><br><span class="line">    <span class="keyword">if</span> (old != <span class="keyword">null</span>) &#123;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 拉起服务的 onServiceDisconnected 方法！</span></span><br><span class="line">        mConnection.onServiceDisconnected(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 不进入这个分支！</span></span><br><span class="line">    <span class="keyword">if</span> (service != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mConnection.onServiceConnected(name, service);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里，最后会进入应用的 ServiceConnection 对象！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> ServiceConnection mConnection = <span class="keyword">new</span> ServiceConnection() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceDisconnected</span><span class="params">(ComponentName name)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>注意，onServiceDisconnected 方法是非阻塞的，即，系统进程不会等 onServiceDisconnected 执行完才继续执行！！</p>
<h1 id="4-服务所在进程"><a href="#4-服务所在进程" class="headerlink" title="4 服务所在进程"></a>4 服务所在进程</h1><p>我们先回到系统进程 bringDownServiceLocked 方法中：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 拉起服务的 onUnbind 方法；</span></span><br><span class="line">r.app.thread.scheduleUnbindService(r,</span><br><span class="line">        ibr.intent.getIntent());</span><br><span class="line">        </span><br><span class="line">... ... ... ...</span><br><span class="line"></span><br><span class="line"><span class="comment">// 拉起服务的 onDestroy 方法；</span></span><br><span class="line">r.app.thread.scheduleStopService(r);</span><br></pre></td></tr></table></figure></p>
<p>这两个方法，都通过 ApplicationThreadProxy 对象进行 bind 通信，我们下面来逐个分析：</p>
<h2 id="4-1-ApplicationThread-scheduleUnbindService"><a href="#4-1-ApplicationThread-scheduleUnbindService" class="headerlink" title="4.1 ApplicationThread.scheduleUnbindService"></a>4.1 ApplicationThread.scheduleUnbindService</h2><p>参数 IBinder token 就是 ServiceRecord 对象！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">scheduleUnbindService</span><span class="params">(IBinder token, Intent intent)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line"></span><br><span class="line">    Parcel data = Parcel.obtain();</span><br><span class="line">    data.writeInterfaceToken(IApplicationThread.descriptor);</span><br><span class="line">    data.writeStrongBinder(token);</span><br><span class="line">    intent.writeToParcel(data, <span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 这里也是异步调用 IBinder.FLAG_ONEWAY！</span></span><br><span class="line">    mRemote.transact(SCHEDULE_UNBIND_SERVICE_TRANSACTION, data, <span class="keyword">null</span>, IBinder.FLAG_ONEWAY);</span><br><span class="line"></span><br><span class="line">    data.recycle();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看出 <strong>scheduleUnbindService</strong> 方法的 binder 通信是 <strong>IBinder.FLAG_ONEWAY</strong> 方式！</p>
<h2 id="4-2-ApplicationThreadP-scheduleStopService"><a href="#4-2-ApplicationThreadP-scheduleStopService" class="headerlink" title="4.2 ApplicationThreadP.scheduleStopService"></a>4.2 ApplicationThreadP.scheduleStopService</h2><p>参数 IBinder token 就是 ServiceRecord 对象！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">scheduleStopService</span><span class="params">(IBinder token)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line"></span><br><span class="line">    Parcel data = Parcel.obtain();</span><br><span class="line">    data.writeInterfaceToken(IApplicationThread.descriptor);</span><br><span class="line">    data.writeStrongBinder(token);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 这里也是异步调用 IBinder.FLAG_ONEWAY！</span></span><br><span class="line">    mRemote.transact(SCHEDULE_STOP_SERVICE_TRANSACTION, data, <span class="keyword">null</span>, IBinder.FLAG_ONEWAY);</span><br><span class="line"></span><br><span class="line">    data.recycle();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看出 <strong>scheduleStopService</strong> 方法的 binder 通信是 <strong>IBinder.FLAG_ONEWAY</strong> 方式！</p>
<p>下面是<strong>真正进入了应用程序进程</strong>！</p>
<h2 id="4-3-ApplicationThreadN-onTransact"><a href="#4-3-ApplicationThreadN-onTransact" class="headerlink" title="4.3 ApplicationThreadN.onTransact"></a>4.3 ApplicationThreadN.onTransact</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">case SCHEDULE_UNBIND_SERVICE_TRANSACTION: &#123;</span><br><span class="line"></span><br><span class="line">    data.enforceInterface(IApplicationThread.descriptor);</span><br><span class="line">    IBinder token = data.readStrongBinder();</span><br><span class="line">    Intent intent = Intent.CREATOR.createFromParcel(data);</span><br><span class="line">    </span><br><span class="line">    // 进入 ActivityThread.scheduleUnbindService !</span><br><span class="line">    scheduleUnbindService(token, intent);</span><br><span class="line"></span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">case SCHEDULE_STOP_SERVICE_TRANSACTION:</span><br><span class="line">&#123;</span><br><span class="line">    data.enforceInterface(IApplicationThread.descriptor);</span><br><span class="line">    IBinder token = data.readStrongBinder();</span><br><span class="line">    </span><br><span class="line">    // 进入 ActivityThread.scheduleStopService！</span><br><span class="line">    scheduleStopService(token);</span><br><span class="line"></span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-4-ApplicationThread"><a href="#4-4-ApplicationThread" class="headerlink" title="4.4 ApplicationThread"></a>4.4 ApplicationThread</h2><p>接着，进入 ApplicationThread！！</p>
<h3 id="4-4-1-ApplicationThread-scheduleUnbindService"><a href="#4-4-1-ApplicationThread-scheduleUnbindService" class="headerlink" title="4.4.1 ApplicationThread.scheduleUnbindService"></a>4.4.1 ApplicationThread.scheduleUnbindService</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">scheduleUnbindService</span><span class="params">(IBinder token, Intent intent)</span> </span>&#123;</span><br><span class="line">    BindServiceData s = <span class="keyword">new</span> BindServiceData();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ServiceRecord 对象！</span></span><br><span class="line">    s.token = token;</span><br><span class="line">    s.intent = intent;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发送 msg：H.UNBIND_SERVICE</span></span><br><span class="line">    sendMessage(H.UNBIND_SERVICE, s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-4-2-ApplicationThread-scheduleStopService"><a href="#4-4-2-ApplicationThread-scheduleStopService" class="headerlink" title="4.4.2 ApplicationThread.scheduleStopService"></a>4.4.2 ApplicationThread.scheduleStopService</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">scheduleStopService</span><span class="params">(IBinder token)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发送 msg：H.STOP_SERVICE</span></span><br><span class="line">    sendMessage(H.STOP_SERVICE, token);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-5-ActivityThread-H"><a href="#4-5-ActivityThread-H" class="headerlink" title="4.5 ActivityThread.H"></a>4.5 ActivityThread.H</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">H</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">case</span> UNBIND_SERVICE:</span><br><span class="line">                Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">"serviceUnbind"</span>);</span><br><span class="line">                </span><br><span class="line">                handleUnbindService((BindServiceData)msg.obj);</span><br><span class="line">                </span><br><span class="line">                Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> STOP_SERVICE:</span><br><span class="line">                Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">"serviceStop"</span>);</span><br><span class="line">                </span><br><span class="line">                handleStopService((IBinder)msg.obj);</span><br><span class="line">                maybeSnapshot();</span><br><span class="line">                </span><br><span class="line">                Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">                <span class="keyword">break</span>;        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里很简单，我们继续看：</p>
<h3 id="4-5-1-ActivityThread-handleUnbindService"><a href="#4-5-1-ActivityThread-handleUnbindService" class="headerlink" title="4.5.1 ActivityThread.handleUnbindService"></a>4.5.1 ActivityThread.handleUnbindService</h3><p>首先会拉起 Serivce 的 onUnbind 方法！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleUnbindService</span><span class="params">(BindServiceData data)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从 AT 的托管集合 mServices 获得 Service 对象！</span></span><br><span class="line">    Service s = mServices.get(data.token);</span><br><span class="line">    <span class="keyword">if</span> (s != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            data.intent.setExtrasClassLoader(s.getClassLoader());</span><br><span class="line">            data.intent.prepareToEnterProcess();</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 拉起服务的 onUnbind，onUnbind 的返回值表示，是否重新 rebind 服务，默认返回 false！</span></span><br><span class="line">            <span class="keyword">boolean</span> doRebind = s.onUnbind(data.intent);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (doRebind) &#123;</span><br><span class="line">                </span><br><span class="line">                    <span class="comment">// 如果 doRebind 为 true，进入这里！</span></span><br><span class="line">                    ActivityManagerNative.getDefault().unbindFinished(</span><br><span class="line">                            data.token, data.intent, doRebind);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                </span><br><span class="line">                    <span class="comment">// 默认为 false，进入这里！</span></span><br><span class="line">                    ActivityManagerNative.getDefault().serviceDoneExecuting(</span><br><span class="line">                            data.token, SERVICE_DONE_EXECUTING_ANON, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">                <span class="keyword">throw</span> ex.rethrowFromSystemServer();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mInstrumentation.onException(s, e)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                        <span class="string">"Unable to unbind to service "</span> + s</span><br><span class="line">                        + <span class="string">" with "</span> + data.intent + <span class="string">": "</span> + e.toString(), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果 onUnbind 方法返回 true，并且服务被解绑后没有被销毁，下次被绑定时，会拉起 onRebind 方法！</p>
<h3 id="4-5-2-ActivityThread-handleStopService"><a href="#4-5-2-ActivityThread-handleStopService" class="headerlink" title="4.5.2 ActivityThread.handleStopService"></a>4.5.2 ActivityThread.handleStopService</h3><p>最后，拉起 Serivce 的 onDestroy 方法！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleStopService</span><span class="params">(IBinder token)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 将服务从 AT 的托管集合 mServices 中移除！</span></span><br><span class="line">    Service s = mServices.remove(token);</span><br><span class="line">    <span class="keyword">if</span> (s != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (localLOGV) Slog.v(TAG, <span class="string">"Destroying service "</span> + s);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 拉起 onDestory 方法！</span></span><br><span class="line">            s.onDestroy();</span><br><span class="line"></span><br><span class="line">            Context context = s.getBaseContext();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (context <span class="keyword">instanceof</span> ContextImpl) &#123;</span><br><span class="line">                <span class="keyword">final</span> String who = s.getClassName();</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 执行清理操作！</span></span><br><span class="line">                ((ContextImpl) context).scheduleFinalCleanup(who, <span class="string">"Service"</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            QueuedWork.waitToFinish();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 最后，执行 serviceDoneExecuting 方法！</span></span><br><span class="line">                ActivityManagerNative.getDefault().serviceDoneExecuting(</span><br><span class="line">                        token, SERVICE_DONE_EXECUTING_STOP, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> e.rethrowFromSystemServer();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mInstrumentation.onException(s, e)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                        <span class="string">"Unable to stop service "</span> + s</span><br><span class="line">                        + <span class="string">": "</span> + e.toString(), e);</span><br><span class="line">            &#125;</span><br><span class="line">            Slog.i(TAG, <span class="string">"handleStopService: exception for "</span> + token, e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Slog.i(TAG, <span class="string">"handleStopService: token="</span> + token + <span class="string">" not found."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Slog.i(TAG, "Running services: " + mServices);</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里逻辑很清楚，我们继续来看，接下来，调用 ActivityManagerP 相关的方法！</p>
<h2 id="4-6-ActivityManagerProxy"><a href="#4-6-ActivityManagerProxy" class="headerlink" title="4.6 ActivityManagerProxy"></a>4.6 ActivityManagerProxy</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 对于 onUnbind 返回 true 的情况!</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unbindFinished</span><span class="params">(IBinder token, Intent intent, <span class="keyword">boolean</span> doRebind)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        </span><br><span class="line">    Parcel data = Parcel.obtain();</span><br><span class="line">    Parcel reply = Parcel.obtain();</span><br><span class="line">    data.writeInterfaceToken(IActivityManager.descriptor);</span><br><span class="line">    data.writeStrongBinder(token);</span><br><span class="line">    intent.writeToParcel(data, <span class="number">0</span>);</span><br><span class="line">    data.writeInt(doRebind ? <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// flags 为 0</span></span><br><span class="line">    mRemote.transact(UNBIND_FINISHED_TRANSACTION, data, reply, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    reply.readException();</span><br><span class="line">    data.recycle();</span><br><span class="line">    reply.recycle();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 对于 onUnbind 返回默认 false 的情况</span></span><br><span class="line"><span class="comment">// 和拉起 onDestory 方法后！</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">serviceDoneExecuting</span><span class="params">(IBinder token, <span class="keyword">int</span> type, <span class="keyword">int</span> startId,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> res)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        </span><br><span class="line">    Parcel data = Parcel.obtain();</span><br><span class="line">    Parcel reply = Parcel.obtain();</span><br><span class="line">    data.writeInterfaceToken(IActivityManager.descriptor);</span><br><span class="line">    data.writeStrongBinder(token);</span><br><span class="line">    data.writeInt(type);</span><br><span class="line">    data.writeInt(startId);</span><br><span class="line">    data.writeInt(res);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// flags 为 IBinder.FLAG_ONEWAY，非阻塞式的</span></span><br><span class="line">    mRemote.transact(SERVICE_DONE_EXECUTING_TRANSACTION, data, reply, IBinder.FLAG_ONEWAY);</span><br><span class="line"></span><br><span class="line">    reply.readException();</span><br><span class="line">    data.recycle();</span><br><span class="line">    reply.recycle();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>发送了 <strong>UNBIND_FINISHED_TRANSACTION</strong> 和 <strong>SERVICE_DONE_EXECUTING_TRANSACTION</strong> 消息！</p>
<p>unbindFinished 的 binder 通信是同步的，serviceDoneExecuting 的 binder 通信是异步的！</p>
<h1 id="5-系统进程"><a href="#5-系统进程" class="headerlink" title="5 系统进程"></a>5 系统进程</h1><p>首先会进入 ActivityManagerNative 的 onTransact 方法中：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> UNBIND_FINISHED_TRANSACTION: &#123;</span><br><span class="line"></span><br><span class="line">    data.enforceInterface(IActivityManager.descriptor);</span><br><span class="line">    IBinder token = data.readStrongBinder();</span><br><span class="line">    Intent intent = Intent.CREATOR.createFromParcel(data);</span><br><span class="line">    <span class="keyword">boolean</span> doRebind = data.readInt() != <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 继续来看！</span></span><br><span class="line">    unbindFinished(token, intent, doRebind);</span><br><span class="line"></span><br><span class="line">    reply.writeNoException();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> SERVICE_DONE_EXECUTING_TRANSACTION: &#123;</span><br><span class="line"></span><br><span class="line">    data.enforceInterface(IActivityManager.descriptor);</span><br><span class="line">    IBinder token = data.readStrongBinder();</span><br><span class="line">    <span class="keyword">int</span> type = data.readInt();</span><br><span class="line">    <span class="keyword">int</span> startId = data.readInt();</span><br><span class="line">    <span class="keyword">int</span> res = data.readInt();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 继续来看！</span></span><br><span class="line">    serviceDoneExecuting(token, type, startId, res);</span><br><span class="line"></span><br><span class="line">    reply.writeNoException();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>接下来，进入 AMS!</p>
<h2 id="5-1-ActivityManagerS-unbindFinished"><a href="#5-1-ActivityManagerS-unbindFinished" class="headerlink" title="5.1 ActivityManagerS.unbindFinished"></a>5.1 ActivityManagerS.unbindFinished</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unbindFinished</span><span class="params">(IBinder token, Intent intent, <span class="keyword">boolean</span> doRebind)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 不能通过 intent 传递文件描述符！</span></span><br><span class="line">    <span class="keyword">if</span> (intent != <span class="keyword">null</span> &amp;&amp; intent.hasFileDescriptors() == <span class="keyword">true</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"File descriptors passed in Intent"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 进入 ActiveServices！</span></span><br><span class="line">        mServices.unbindFinishedLocked((ServiceRecord)token, intent, doRebind);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-1-1-ActiveServices-unbindFinishedLocked"><a href="#5-1-1-ActiveServices-unbindFinishedLocked" class="headerlink" title="5.1.1 ActiveServices.unbindFinishedLocked"></a>5.1.1 ActiveServices.unbindFinishedLocked</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">unbindFinishedLocked</span><span class="params">(ServiceRecord r, Intent intent, <span class="keyword">boolean</span> doRebind)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> origId = Binder.clearCallingIdentity();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Intent.FilterComparison filter</span><br><span class="line">                    = <span class="keyword">new</span> Intent.FilterComparison(intent);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 获得绑定 Serivce 的 intent 对应的 IntentBindRecord 对象！</span></span><br><span class="line">            IntentBindRecord b = r.bindings.get(filter);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE, <span class="string">"unbindFinished in "</span> + r</span><br><span class="line">                    + <span class="string">" at "</span> + b + <span class="string">": apps="</span></span><br><span class="line">                    + (b != <span class="keyword">null</span> ? b.apps.size() : <span class="number">0</span>));</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 这里的 inDestroying 的值为 false，因为还没有添加！</span></span><br><span class="line">            <span class="keyword">boolean</span> inDestroying = mDestroyingServices.contains(r);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 显然，这里不会为 null！</span></span><br><span class="line">            <span class="keyword">if</span> (b != <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (b.apps.size() &gt; <span class="number">0</span> &amp;&amp; !inDestroying) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// Applications have already bound since the last</span></span><br><span class="line">                    <span class="comment">// unbind, so just rebind right here.</span></span><br><span class="line">                    <span class="keyword">boolean</span> inFg = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i=b.apps.size()-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</span><br><span class="line">                        ProcessRecord client = b.apps.valueAt(i).client;</span><br><span class="line">                        <span class="keyword">if</span> (client != <span class="keyword">null</span> &amp;&amp; client.setSchedGroup</span><br><span class="line">                                != ProcessList.SCHED_GROUP_BACKGROUND) &#123;</span><br><span class="line">                            inFg = <span class="keyword">true</span>;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        requestServiceBindingLocked(r, b, inFg, <span class="keyword">true</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (TransactionTooLargeException e) &#123;</span><br><span class="line">                        <span class="comment">// Don't pass this back to ActivityThread, it's unrelated.</span></span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 将 doRebind 置为 true！</span></span><br><span class="line">                    b.doRebind = <span class="keyword">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 最后进入 serviceDoneExecutingLocked 方法！</span></span><br><span class="line">            serviceDoneExecutingLocked(r, inDestroying, <span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line"></span><br><span class="line">        Binder.restoreCallingIdentity(origId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接着来看！</p>
<h3 id="5-1-2-ActiveServices-serviceDoneExecutingLocked"><a href="#5-1-2-ActiveServices-serviceDoneExecutingLocked" class="headerlink" title="5.1.2 ActiveServices.serviceDoneExecutingLocked"></a>5.1.2 ActiveServices.serviceDoneExecutingLocked</h3><p>参数传递：</p>
<ul>
<li>boolean inDestroying：传入 false；</li>
<li>boolean finishing：传入 false；</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">serviceDoneExecutingLocked</span><span class="params">(ServiceRecord r, <span class="keyword">boolean</span> inDestroying,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> finishing)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE, <span class="string">"&lt;&lt;&lt; DONE EXECUTING "</span> + r</span><br><span class="line">            + <span class="string">": nesting="</span> + r.executeNesting</span><br><span class="line">            + <span class="string">", inDestroying="</span> + inDestroying + <span class="string">", app="</span> + r.app);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (DEBUG_SERVICE_EXECUTING) Slog.v(TAG_SERVICE_EXECUTING,</span><br><span class="line">            <span class="string">"&lt;&lt;&lt; DONE EXECUTING "</span> + r.shortName);</span><br><span class="line"></span><br><span class="line">    r.executeNesting--;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r.executeNesting &lt;= <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (r.app != <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE,</span><br><span class="line">                    <span class="string">"Nesting at 0 of "</span> + r.shortName);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 从所在进程的 executingServices 中删除该服务！</span></span><br><span class="line">            r.app.execServicesFg = <span class="keyword">false</span>;</span><br><span class="line">            r.app.executingServices.remove(r);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (r.app.executingServices.size() == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_SERVICE || DEBUG_SERVICE_EXECUTING) Slog.v(TAG_SERVICE_EXECUTING,</span><br><span class="line">                        <span class="string">"No more executingServices of "</span> + r.shortName);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 如果进程中没有在执行指定代码逻辑的服务了，就取消超市任务！</span></span><br><span class="line">                mAm.mHandler.removeMessages(ActivityManagerService.SERVICE_TIMEOUT_MSG, r.app);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (r.executeFg) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 如果进程还有在执行指定代码逻辑的服务，并且有服务在前台执行，那就要将进程的 execServicesFg 置为 ture</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i=r.app.executingServices.size()-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (r.app.executingServices.valueAt(i).executeFg) &#123;</span><br><span class="line">                        r.app.execServicesFg = <span class="keyword">true</span>;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (inDestroying) &#123; <span class="comment">// 不进入！</span></span><br><span class="line">                <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE,</span><br><span class="line">                        <span class="string">"doneExecuting remove destroying "</span> + r);</span><br><span class="line">                mDestroyingServices.remove(r);</span><br><span class="line">                r.bindings.clear();</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 更新 oomAdj 值！</span></span><br><span class="line">            mAm.updateOomAdjLocked(r.app);</span><br><span class="line">        &#125;</span><br><span class="line">　　　　</span><br><span class="line">　　　　<span class="comment">// 置服务的 executeFg 为 false；</span></span><br><span class="line">        r.executeFg = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (r.tracker != <span class="keyword">null</span>) &#123;</span><br><span class="line">            r.tracker.setExecuting(<span class="keyword">false</span>, mAm.mProcessStats.getMemFactorLocked(),</span><br><span class="line">                    SystemClock.uptimeMillis());</span><br><span class="line">            <span class="keyword">if</span> (finishing) &#123;</span><br><span class="line">                r.tracker.clearCurrentOwner(r, <span class="keyword">false</span>);</span><br><span class="line">                r.tracker = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (finishing) &#123; <span class="comment">// 不进入这个分支！</span></span><br><span class="line">            <span class="keyword">if</span> (r.app != <span class="keyword">null</span> &amp;&amp; !r.app.persistent) &#123;</span><br><span class="line">                r.app.services.remove(r);</span><br><span class="line">                <span class="keyword">if</span> (r.whitelistManager) &#123;</span><br><span class="line">                    updateWhitelistManagerLocked(r.app);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            r.app = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里就不再详细说了！！</p>
<h2 id="5-2-ActivityManagerS-serviceDoneExecuting"><a href="#5-2-ActivityManagerS-serviceDoneExecuting" class="headerlink" title="5.2 ActivityManagerS.serviceDoneExecuting"></a>5.2 ActivityManagerS.serviceDoneExecuting</h2><p>对于拉起 onDestroy 方法，最后会调用<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">serviceDoneExecuting</span><span class="params">(IBinder token, <span class="keyword">int</span> type, <span class="keyword">int</span> startId, <span class="keyword">int</span> res)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!(token <span class="keyword">instanceof</span> ServiceRecord)) &#123;</span><br><span class="line">            Slog.e(TAG, <span class="string">"serviceDoneExecuting: Invalid service token="</span> + token);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Invalid service token"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 最后，进入 AS！</span></span><br><span class="line">        mServices.serviceDoneExecutingLocked((ServiceRecord)token, type, startId, res);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>接着，进入 ActiveServices！</p>
<h3 id="5-2-1-ActiveServices-serviceDoneExecutingLocked"><a href="#5-2-1-ActiveServices-serviceDoneExecutingLocked" class="headerlink" title="5.2.1 ActiveServices.serviceDoneExecutingLocked"></a>5.2.1 ActiveServices.serviceDoneExecutingLocked</h3><p>根据参数传递：</p>
<ul>
<li><strong>int type</strong>：传入 ActivityThread.SERVICE_DONE_EXECUTING_STOP；</li>
<li><strong>int startId</strong>：传入 0；</li>
<li><strong>int res</strong>：传入 0；</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">serviceDoneExecutingLocked</span><span class="params">(ServiceRecord r, <span class="keyword">int</span> type, <span class="keyword">int</span> startId, <span class="keyword">int</span> res)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 这里的 inDestroying 为 true，因为我们之前已经将该服务添加到 mDestroyingServices！</span></span><br><span class="line">    <span class="keyword">boolean</span> inDestroying = mDestroyingServices.contains(r);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == ActivityThread.SERVICE_DONE_EXECUTING_START) &#123;</span><br><span class="line">            </span><br><span class="line">            ... ... ... <span class="comment">// 这里是和 startService 服务有关，我们这里不看！</span></span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == ActivityThread.SERVICE_DONE_EXECUTING_STOP) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// This is the final call from destroying the service...  we should</span></span><br><span class="line">            <span class="comment">// actually be getting rid of the service at this point.  Do some</span></span><br><span class="line">            <span class="comment">// validation of its state, and ensure it will be fully removed.</span></span><br><span class="line">            <span class="keyword">if</span> (!inDestroying) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Not sure what else to do with this...  if it is not actually in the</span></span><br><span class="line">                <span class="comment">// destroying list, we don't need to make sure to remove it from it.</span></span><br><span class="line">                <span class="comment">// If the app is null, then it was probably removed because the process died,</span></span><br><span class="line">                <span class="comment">// otherwise wtf</span></span><br><span class="line">                <span class="keyword">if</span> (r.app != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Slog.w(TAG, <span class="string">"Service done with onDestroy, but not inDestroying: "</span></span><br><span class="line">                            + r + <span class="string">", app="</span> + r.app);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (r.executeNesting != <span class="number">1</span>) &#123;</span><br><span class="line"></span><br><span class="line">                Slog.w(TAG, <span class="string">"Service done with onDestroy, but executeNesting="</span></span><br><span class="line">                        + r.executeNesting + <span class="string">": "</span> + r);</span><br><span class="line">                <span class="comment">// Fake it to keep from ANR due to orphaned entry.</span></span><br><span class="line">                r.executeNesting = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> origId = Binder.clearCallingIdentity();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 最后，再次调用 serviceDoneExecutingLocked！</span></span><br><span class="line">        serviceDoneExecutingLocked(r, inDestroying, inDestroying);</span><br><span class="line">        Binder.restoreCallingIdentity(origId);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Slog.w(TAG, <span class="string">"Done executing unknown service from pid "</span></span><br><span class="line">                + Binder.getCallingPid());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="5-2-2-ActiveServices-serviceDoneExecutingLocked"><a href="#5-2-2-ActiveServices-serviceDoneExecutingLocked" class="headerlink" title="5.2.2 ActiveServices.serviceDoneExecutingLocked"></a>5.2.2 ActiveServices.serviceDoneExecutingLocked</h3><p>参数传递：</p>
<ul>
<li>boolean inDestroying：传入 true；</li>
<li>boolean finishing：传入 true；</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">serviceDoneExecutingLocked</span><span class="params">(ServiceRecord r, <span class="keyword">boolean</span> inDestroying,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> finishing)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE, <span class="string">"&lt;&lt;&lt; DONE EXECUTING "</span> + r</span><br><span class="line">            + <span class="string">": nesting="</span> + r.executeNesting</span><br><span class="line">            + <span class="string">", inDestroying="</span> + inDestroying + <span class="string">", app="</span> + r.app);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (DEBUG_SERVICE_EXECUTING) Slog.v(TAG_SERVICE_EXECUTING,</span><br><span class="line">            <span class="string">"&lt;&lt;&lt; DONE EXECUTING "</span> + r.shortName);</span><br><span class="line"></span><br><span class="line">    r.executeNesting--;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r.executeNesting &lt;= <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (r.app != <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE,</span><br><span class="line">                    <span class="string">"Nesting at 0 of "</span> + r.shortName);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 从所在进程的 executingServices 中删除该服务！</span></span><br><span class="line">            r.app.execServicesFg = <span class="keyword">false</span>;</span><br><span class="line">            r.app.executingServices.remove(r);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (r.app.executingServices.size() == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (DEBUG_SERVICE || DEBUG_SERVICE_EXECUTING) Slog.v(TAG_SERVICE_EXECUTING,</span><br><span class="line">                        <span class="string">"No more executingServices of "</span> + r.shortName);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 如果进程中没有在执行指定代码逻辑的服务了，就取消超市任务！</span></span><br><span class="line">                mAm.mHandler.removeMessages(ActivityManagerService.SERVICE_TIMEOUT_MSG, r.app);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (r.executeFg) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 如果进程还有在执行指定代码逻辑的服务，并且有服务在前台执行，那就要将进程的 execServicesFg 置为 ture</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i=r.app.executingServices.size()-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (r.app.executingServices.valueAt(i).executeFg) &#123;</span><br><span class="line">                        r.app.execServicesFg = <span class="keyword">true</span>;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (inDestroying) &#123; <span class="comment">// inDestroying 为 true 进入！</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (DEBUG_SERVICE) Slog.v(TAG_SERVICE,</span><br><span class="line">                        <span class="string">"doneExecuting remove destroying "</span> + r);</span><br><span class="line">                        </span><br><span class="line">                <span class="comment">// 从 mDestroyingServices 中删除 ServiceRecord！</span></span><br><span class="line">                mDestroyingServices.remove(r);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 清空其 bindings 集合！</span></span><br><span class="line">                r.bindings.clear();</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 更新 oomAdj 值！</span></span><br><span class="line">            mAm.updateOomAdjLocked(r.app);</span><br><span class="line">        &#125;</span><br><span class="line">　　　　</span><br><span class="line">　　　　<span class="comment">// 置服务的 executeFg 为 false；</span></span><br><span class="line">        r.executeFg = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (r.tracker != <span class="keyword">null</span>) &#123;</span><br><span class="line">            r.tracker.setExecuting(<span class="keyword">false</span>, mAm.mProcessStats.getMemFactorLocked(),</span><br><span class="line">                    SystemClock.uptimeMillis());</span><br><span class="line">                    </span><br><span class="line">            <span class="comment">// 取消对服务的监控！</span></span><br><span class="line">            <span class="keyword">if</span> (finishing) &#123;</span><br><span class="line">                r.tracker.clearCurrentOwner(r, <span class="keyword">false</span>);</span><br><span class="line">                r.tracker = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (finishing) &#123; <span class="comment">// finishing 为 true ，进入这个分支！</span></span><br><span class="line">            <span class="keyword">if</span> (r.app != <span class="keyword">null</span> &amp;&amp; !r.app.persistent) &#123;</span><br><span class="line">            </span><br><span class="line">                <span class="comment">// 如果服务所在的进程不是常驻进程，从进程的 services 中移除这个服务！</span></span><br><span class="line">                r.app.services.remove(r);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (r.whitelistManager) &#123;</span><br><span class="line">                    updateWhitelistManagerLocked(r.app);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            r.app = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>到这里，stopService 的整个过程，就分析完了！！</p>
<h1 id="6-总结"><a href="#6-总结" class="headerlink" title="6 总结"></a>6 总结</h1><p>我们来回顾一下，整个 stopService 的过程，都遇到了那些重要的数据结构！</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2016/04/02/JobScheduler第 2 篇 - JobSchedulerService 的启动/">JobScheduler第 2 篇 - JobSchedulerService 的启动</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2016-04-02</time><span class="article-meta"><span class="article-meta__separator">|</span><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/AndroidFramework源码分析/">AndroidFramework源码分析</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox article-meta__icon" aria-hidden="true"></i><a class="article-meta__categories" href="/categories/AndroidFramework源码分析/JobScheduler任务调度/">JobScheduler任务调度</a></span><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="/tags/JobScheduler任务调度/">JobScheduler任务调度</a></span><div class="content"><p>基于 <code>Android 7.1.1</code> 源码分析，本文为原创，转载请说明出处。。。</p>
<h1 id="0-前言"><a href="#0-前言" class="headerlink" title="0 前言"></a>0 前言</h1><p><code>JobSchedulerService</code> 服务的启动，是在 <code>SystemServer</code> 的 <code>startOtherServices</code> 方法中：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startOtherServices</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  mSystemServiceManager.startService(JobSchedulerService.class);</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个方法首先会调用服务的 <code>Constructer</code>，然后调用服务的 <code>onStart</code> 方法！</p>
<p>同时，在 <code>ActivityManagerService.systemReady</code> 方法中，会调用如下的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 启动当前的设备用户！</span></span><br><span class="line">mSystemServiceManager.startUser(currentUserId);</span><br></pre></td></tr></table></figure>
<p>该方法的细节如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startUser</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> userHandle)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> serviceLen = mServices.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; serviceLen; i++) &#123;</span><br><span class="line">        <span class="keyword">final</span> SystemService service = mServices.get(i);</span><br><span class="line">        Trace.traceBegin(Trace.TRACE_TAG_SYSTEM_SERVER, <span class="string">"onStartUser "</span></span><br><span class="line">                + service.getClass().getName());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 拉起所有 SystemService 的子类的 onStartUser 方法！</span></span><br><span class="line">            service.onStartUser(userHandle);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            Slog.wtf(TAG, <span class="string">"Failure reporting start of user "</span> + userHandle</span><br><span class="line">                    + <span class="string">" to service "</span> + service.getClass().getName(), ex);</span><br><span class="line">        &#125;</span><br><span class="line">        Trace.traceEnd(Trace.TRACE_TAG_SYSTEM_SERVER);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h1 id="1-JobSchedulerService"><a href="#1-JobSchedulerService" class="headerlink" title="1 JobSchedulerService"></a>1 JobSchedulerService</h1><p>我们先来看 <code>JobSchedulerService</code> 的构造器：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">JobSchedulerService</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(context);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建主线程的 looper，创建对应的 Handler</span></span><br><span class="line">    mHandler = <span class="keyword">new</span> JobHandler(context.getMainLooper());</span><br><span class="line">    mConstants = <span class="keyword">new</span> Constants(mHandler);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建 binder 服务端</span></span><br><span class="line">    mJobSchedulerStub = <span class="keyword">new</span> JobSchedulerStub();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化 JobStore 对象！</span></span><br><span class="line">    mJobs = JobStore.initAndGet(<span class="keyword">this</span>);</span><br><span class="line">    <span class="comment">// Create the controllers.</span></span><br><span class="line">    mControllers = <span class="keyword">new</span> ArrayList&lt;StateController&gt;();</span><br><span class="line">    mControllers.add(ConnectivityController.get(<span class="keyword">this</span>));</span><br><span class="line">    mControllers.add(TimeController.get(<span class="keyword">this</span>));</span><br><span class="line">    mControllers.add(IdleController.get(<span class="keyword">this</span>));</span><br><span class="line">    mControllers.add(BatteryController.get(<span class="keyword">this</span>));</span><br><span class="line">    mControllers.add(AppIdleController.get(<span class="keyword">this</span>));</span><br><span class="line">    mControllers.add(ContentObserverController.get(<span class="keyword">this</span>));</span><br><span class="line">    mControllers.add(DeviceIdleJobsController.get(<span class="keyword">this</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里构造器其中，创建了一些很重要的成员变量，其中多个控制器：</p>
<ul>
<li><code>ConnectivityController</code>：用于监听网络连接状态的广播；</li>
<li><code>DeviceIdleJobsController</code>：</li>
<li><code>ContentObserverController</code>：用于监听数据库的变化；</li>
<li><code>AppIdleController</code>：用于监听 <code>app</code> 是否处于空闲状态；</li>
<li><code>BatteryController</code>：用于监听电池是否充电,电量状态的广播；</li>
<li><code>IdleController</code>：用于监听屏幕亮 / 灭，进入 / 退出睡眠，状态改变的广播；</li>
<li><code>TimeController</code>：用于监听 job 时间范围的广播；</li>
</ul>
<p>下图展示了 这几个主要的 <code>Controller</code> 之间的关系：</p>
<p>（图先省略啦，后续补上，哈哈）</p>
<p>可以看到，他们都继承了 <code>StateController</code> 类，我们后面来分析控制器！</p>
<h2 id="1-1-JobStore"><a href="#1-1-JobStore" class="headerlink" title="1.1 JobStore"></a>1.1 JobStore</h2><p><code>JobStore</code> 方法的作用是存储了管理系统中存储的所有注册过的 <code>JobStore</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JobStore</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"JobStore"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DEBUG = JobSchedulerService.DEBUG;</span><br><span class="line">    <span class="comment">/** Threshold to adjust how often we want to write to the db. */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_OPS_BEFORE_WRITE = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">final</span> Object mLock;</span><br><span class="line">    <span class="keyword">final</span> JobSet mJobSet; <span class="comment">// per-caller-uid tracking // 存储 jobs.xml 中的数据</span></span><br><span class="line">    <span class="keyword">final</span> Context mContext;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mDirtyOperations;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Object sSingletonLock = <span class="keyword">new</span> Object();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicFile mJobsFile; <span class="comment">// 只向本地文件: /system/job/jobs.xml</span></span><br><span class="line">    <span class="comment">/** Handler backed by IoThread for writing to disk. */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Handler mIoHandler = IoThread.getHandler();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> JobStore sSingleton;</span><br><span class="line">    <span class="comment">/** Used by the &#123;<span class="doctag">@link</span> JobSchedulerService&#125; to instantiate the JobStore. */</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> JobStore <span class="title">initAndGet</span><span class="params">(JobSchedulerService jobManagerService)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (sSingletonLock) &#123;</span><br><span class="line">            <span class="keyword">if</span> (sSingleton == <span class="keyword">null</span>) &#123;</span><br><span class="line">                sSingleton = <span class="keyword">new</span> JobStore(jobManagerService.getContext(),</span><br><span class="line">                        jobManagerService.getLock(), Environment.getDataDirectory());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> sSingleton;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Construct the instance of the job store. This results in a blocking read from disk.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">JobStore</span><span class="params">(Context context, Object lock, File dataDir)</span> </span>&#123;</span><br><span class="line">        mLock = lock;</span><br><span class="line">        mContext = context;</span><br><span class="line">        mDirtyOperations = <span class="number">0</span>;</span><br><span class="line">        File systemDir = <span class="keyword">new</span> File(dataDir, <span class="string">"system"</span>);</span><br><span class="line">        File jobDir = <span class="keyword">new</span> File(systemDir, <span class="string">"job"</span>);</span><br><span class="line">        jobDir.mkdirs();</span><br><span class="line">        mJobsFile = <span class="keyword">new</span> AtomicFile(<span class="keyword">new</span> File(jobDir, <span class="string">"jobs.xml"</span>));</span><br><span class="line">        mJobSet = <span class="keyword">new</span> JobSet();</span><br><span class="line">        readJobMapFromDisk(mJobSet); <span class="comment">// 从 Jobs.xml 中读取数据，初始化 JobSet！</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>上面是 <code>JobStore</code> 的初始化操作，该方法会创建 <code>job</code> 目录以及 <code>jobs.xml</code> 文件, 以及从文件中读取所有的 <code>JobStatus</code>。</p>
<h3 id="1-1-1-readJobMapFromDisk"><a href="#1-1-1-readJobMapFromDisk" class="headerlink" title="1.1.1 readJobMapFromDisk"></a>1.1.1 readJobMapFromDisk</h3><p>这个方法创建了一个 <code>Runnable</code> 去实现具体的业务！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@VisibleForTesting</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">readJobMapFromDisk</span><span class="params">(JobSet jobSet)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">new</span> ReadJobMapFromDiskRunnable(jobSet).run();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>从 <code>Jobs.xml</code> 文件中读取数据：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">ReadJobMapFromDiskRunnable</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JobSet jobSet;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> jobSet Reference to the (empty) set of JobStatus objects that back the JobStore,</span></span><br><span class="line"><span class="comment">     *               so that after disk read we can populate it directly.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ReadJobMapFromDiskRunnable(JobSet jobSet) &#123;</span><br><span class="line">        <span class="keyword">this</span>.jobSet = jobSet;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            List&lt;JobStatus&gt; jobs;</span><br><span class="line">            FileInputStream fis = mJobsFile.openRead();</span><br><span class="line">            <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">                jobs = readJobMapImpl(fis);</span><br><span class="line">                <span class="keyword">if</span> (jobs != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;jobs.size(); i++) &#123;</span><br><span class="line">                        <span class="keyword">this</span>.jobSet.add(jobs.get(i));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            fis.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (JobSchedulerService.DEBUG) &#123;</span><br><span class="line">                Slog.d(TAG, <span class="string">"Could not find jobs file, probably there was nothing to load."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (XmlPullParserException e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (JobSchedulerService.DEBUG) &#123;</span><br><span class="line">                Slog.d(TAG, <span class="string">"Error parsing xml."</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (JobSchedulerService.DEBUG) &#123;</span><br><span class="line">                Slog.d(TAG, <span class="string">"Error parsing xml."</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ... ... ... ...       </span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以看出，调用了 <code>readJobMapImpl</code> 方法来解析 <code>Jobs.xml</code> ！</p>
<h3 id="1-1-2-readJobMapImpl"><a href="#1-1-2-readJobMapImpl" class="headerlink" title="1.1.2 readJobMapImpl"></a>1.1.2 readJobMapImpl</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> List&lt;JobStatus&gt; <span class="title">readJobMapImpl</span><span class="params">(FileInputStream fis)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</span><br><span class="line">    ... ... ... ...</span><br><span class="line">    String tagName = parser.getName();</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">"job-info"</span>.equals(tagName)) &#123; <span class="comment">// 解析 &lt;job-info&gt; 标签，校验版本是否有问题</span></span><br><span class="line">        <span class="keyword">final</span> List&lt;JobStatus&gt; jobs = <span class="keyword">new</span> ArrayList&lt;JobStatus&gt;();</span><br><span class="line">        <span class="comment">// Read in version info.</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">int</span> version = Integer.parseInt(parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"version"</span>));</span><br><span class="line">            <span class="keyword">if</span> (version != JOBS_FILE_VERSION) &#123;</span><br><span class="line">                Slog.d(TAG, <span class="string">"Invalid version number, aborting jobs file read."</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">            Slog.e(TAG, <span class="string">"Invalid version number, aborting jobs file read."</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        eventType = parser.next();</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="comment">// Read each &lt;job/&gt;</span></span><br><span class="line">            <span class="keyword">if</span> (eventType == XmlPullParser.START_TAG) &#123;</span><br><span class="line">                tagName = parser.getName();</span><br><span class="line">                <span class="comment">// Start reading job.</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="string">"job"</span>.equals(tagName)) &#123;</span><br><span class="line">                    <span class="comment">// 解析&lt;job&gt; 标签，获得每个job 对应的 jobStatus 对象</span></span><br><span class="line">                    JobStatus persistedJob = restoreJobFromXml(parser);</span><br><span class="line">                    <span class="keyword">if</span> (persistedJob != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                            Slog.d(TAG, <span class="string">"Read out "</span> + persistedJob);</span><br><span class="line">                        &#125;</span><br><span class="line">                        jobs.add(persistedJob); <span class="comment">// 加入到缓存集合中，最后返回！</span></span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        Slog.d(TAG, <span class="string">"Error reading job from file."</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            eventType = parser.next();</span><br><span class="line">        &#125; <span class="keyword">while</span> (eventType != XmlPullParser.END_DOCUMENT);</span><br><span class="line">        <span class="keyword">return</span> jobs;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里是通过循环处理 <code>jobs.xml</code> 文件中的标签</p>
<h3 id="1-1-3-restoreJobFromXml"><a href="#1-1-3-restoreJobFromXml" class="headerlink" title="1.1.3 restoreJobFromXml"></a>1.1.3 restoreJobFromXml</h3><p>这个方法负责解析每个<job>标签，返回每个任务对应的 <code>JobStatus</code>。<br>注意这里只有重启设备后需要保留的 <code>Job</code>，才会写入 <code>jobs.xml</code> 文件中，即：这个 <code>Job</code> 是 <code>isPersisted</code> 的！！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> JobStatus <span class="title">restoreJobFromXml</span><span class="params">(XmlPullParser parser)</span> <span class="keyword">throws</span> XmlPullParserException,</span></span><br><span class="line"><span class="function">        IOException </span>&#123;</span><br><span class="line">    JobInfo.Builder jobBuilder;</span><br><span class="line">    <span class="keyword">int</span> uid, sourceUserId;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        jobBuilder = buildBuilderFromXml(parser);</span><br><span class="line">        jobBuilder.setPersisted(<span class="keyword">true</span>);</span><br><span class="line">        <span class="comment">// 解析基本信息: uid、priority、flags 和 sourceUserId ！</span></span><br><span class="line">        uid = Integer.parseInt(parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"uid"</span>));</span><br><span class="line">        String val = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"priority"</span>);</span><br><span class="line">        <span class="keyword">if</span> (val != <span class="keyword">null</span>) &#123;</span><br><span class="line">            jobBuilder.setPriority(Integer.parseInt(val));</span><br><span class="line">        &#125;</span><br><span class="line">        val = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"flags"</span>);</span><br><span class="line">        <span class="keyword">if</span> (val != <span class="keyword">null</span>) &#123;</span><br><span class="line">            jobBuilder.setFlags(Integer.parseInt(val));</span><br><span class="line">        &#125;</span><br><span class="line">        val = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"sourceUserId"</span>);</span><br><span class="line">        sourceUserId = val == <span class="keyword">null</span> ? -<span class="number">1</span> : Integer.parseInt(val);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">        Slog.e(TAG, <span class="string">"Error parsing job's required fields, skipping"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 解析获得 sourcePackageName 和 sourceTag！</span></span><br><span class="line">    String sourcePackageName = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"sourcePackageName"</span>);</span><br><span class="line">    <span class="keyword">final</span> String sourceTag = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"sourceTag"</span>);</span><br><span class="line">    <span class="keyword">int</span> eventType;</span><br><span class="line">    <span class="comment">// Read out constraints tag.</span></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        eventType = parser.next();</span><br><span class="line">    &#125; <span class="keyword">while</span> (eventType == XmlPullParser.TEXT);  <span class="comment">// Push through to next START_TAG.</span></span><br><span class="line">    <span class="keyword">if</span> (!(eventType == XmlPullParser.START_TAG &amp;&amp;</span><br><span class="line">            XML_TAG_PARAMS_CONSTRAINTS.equals(parser.getName()))) &#123;</span><br><span class="line">        <span class="comment">// Expecting a &lt;constraints&gt; start tag.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        buildConstraintsFromXml(jobBuilder, parser);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">        Slog.d(TAG, <span class="string">"Error reading constraints, skipping."</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    parser.next(); <span class="comment">// Consume &lt;/constraints&gt;</span></span><br><span class="line">    <span class="comment">// Read out execution parameters tag.</span></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        eventType = parser.next();</span><br><span class="line">    &#125; <span class="keyword">while</span> (eventType == XmlPullParser.TEXT);</span><br><span class="line">    <span class="keyword">if</span> (eventType != XmlPullParser.START_TAG) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Tuple of (earliest runtime, latest runtime) in elapsed realtime after disk load.</span></span><br><span class="line">    Pair&lt;Long, Long&gt; elapsedRuntimes;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        elapsedRuntimes = buildExecutionTimesFromXml(parser);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">            Slog.d(TAG, <span class="string">"Error parsing execution time parameters, skipping."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> elapsedNow = SystemClock.elapsedRealtime();</span><br><span class="line">    <span class="keyword">if</span> (XML_TAG_PERIODIC.equals(parser.getName())) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String val = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"period"</span>);</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> periodMillis = Long.valueOf(val);</span><br><span class="line">            val = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"flex"</span>);</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> flexMillis = (val != <span class="keyword">null</span>) ? Long.valueOf(val) : periodMillis;</span><br><span class="line">            jobBuilder.setPeriodic(periodMillis, flexMillis);</span><br><span class="line">            <span class="comment">// As a sanity check, cap the recreated run time to be no later than flex+period</span></span><br><span class="line">            <span class="comment">// from now. This is the latest the periodic could be pushed out. This could</span></span><br><span class="line">            <span class="comment">// happen if the periodic ran early (at flex time before period), and then the</span></span><br><span class="line">            <span class="comment">// device rebooted.</span></span><br><span class="line">            <span class="keyword">if</span> (elapsedRuntimes.second &gt; elapsedNow + periodMillis + flexMillis) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">long</span> clampedLateRuntimeElapsed = elapsedNow + flexMillis</span><br><span class="line">                        + periodMillis;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">long</span> clampedEarlyRuntimeElapsed = clampedLateRuntimeElapsed</span><br><span class="line">                        - flexMillis;</span><br><span class="line">                </span><br><span class="line">                ... ... ... ...</span><br><span class="line"></span><br><span class="line">                elapsedRuntimes =</span><br><span class="line">                        Pair.create(clampedEarlyRuntimeElapsed, clampedLateRuntimeElapsed);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">            Slog.d(TAG, <span class="string">"Error reading periodic execution criteria, skipping."</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (XML_TAG_ONEOFF.equals(parser.getName())) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (elapsedRuntimes.first != JobStatus.NO_EARLIEST_RUNTIME) &#123;</span><br><span class="line">                jobBuilder.setMinimumLatency(elapsedRuntimes.first - elapsedNow);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (elapsedRuntimes.second != JobStatus.NO_LATEST_RUNTIME) &#123;</span><br><span class="line">                jobBuilder.setOverrideDeadline(</span><br><span class="line">                        elapsedRuntimes.second - elapsedNow);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">            Slog.d(TAG, <span class="string">"Error reading job execution criteria, skipping."</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">            Slog.d(TAG, <span class="string">"Invalid parameter tag, skipping - "</span> + parser.getName());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Expecting a parameters start tag.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    maybeBuildBackoffPolicyFromXml(jobBuilder, parser);</span><br><span class="line">    parser.nextTag(); <span class="comment">// Consume parameters end tag.</span></span><br><span class="line">    <span class="comment">// Read out extras Bundle.</span></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        eventType = parser.next();</span><br><span class="line">    &#125; <span class="keyword">while</span> (eventType == XmlPullParser.TEXT);</span><br><span class="line">    <span class="keyword">if</span> (!(eventType == XmlPullParser.START_TAG</span><br><span class="line">            &amp;&amp; XML_TAG_EXTRAS.equals(parser.getName()))) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">            Slog.d(TAG, <span class="string">"Error reading extras, skipping."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    PersistableBundle extras = PersistableBundle.restoreFromXml(parser);</span><br><span class="line">    jobBuilder.setExtras(extras);</span><br><span class="line">    parser.nextTag(); <span class="comment">// Consume &lt;/extras&gt;</span></span><br><span class="line">    <span class="comment">// Migrate sync jobs forward from earlier, incomplete representation</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="string">"android"</span>.equals(sourcePackageName)</span><br><span class="line">            &amp;&amp; extras != <span class="keyword">null</span></span><br><span class="line">            &amp;&amp; extras.getBoolean(<span class="string">"SyncManagerJob"</span>, <span class="keyword">false</span>)) &#123;</span><br><span class="line">        sourcePackageName = extras.getString(<span class="string">"owningPackage"</span>, sourcePackageName);</span><br><span class="line">        <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">            Slog.i(TAG, <span class="string">"Fixing up sync job source package name from 'android' to '"</span></span><br><span class="line">                    + sourcePackageName + <span class="string">"'"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// And now we're done</span></span><br><span class="line">    JobStatus js = <span class="keyword">new</span> JobStatus(</span><br><span class="line">            jobBuilder.build(), uid, sourcePackageName, sourceUserId, sourceTag,</span><br><span class="line">            elapsedRuntimes.first, elapsedRuntimes.second);</span><br><span class="line">    <span class="keyword">return</span> js;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></job></p>
<p>这里面以后很多的细节，继续看：</p>
<h4 id="1-1-3-1-buildBuilderFromXml"><a href="#1-1-3-1-buildBuilderFromXml" class="headerlink" title="1.1.3.1 buildBuilderFromXml"></a>1.1.3.1 buildBuilderFromXml</h4><p>用来创建 <code>JobInfo</code>：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> JobInfo.<span class="function">Builder <span class="title">buildBuilderFromXml</span><span class="params">(XmlPullParser parser)</span> <span class="keyword">throws</span> NumberFormatException </span>&#123;</span><br><span class="line">    <span class="comment">// Pull out required fields from &lt;job&gt; attributes.</span></span><br><span class="line">    <span class="keyword">int</span> jobId = Integer.parseInt(parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"jobid"</span>));</span><br><span class="line">    String packageName = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"package"</span>);</span><br><span class="line">    String className = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"class"</span>);</span><br><span class="line">    ComponentName cname = <span class="keyword">new</span> ComponentName(packageName, className);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> JobInfo.Builder(jobId, cname);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里使用了建造者模式：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Builder</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> mJobId;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ComponentName mJobService;</span><br><span class="line">    <span class="keyword">private</span> PersistableBundle mExtras = PersistableBundle.EMPTY;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mPriority = PRIORITY_DEFAULT;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mFlags;</span><br><span class="line">    <span class="comment">// Requirements.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mRequiresCharging;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mRequiresDeviceIdle;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mNetworkType;</span><br><span class="line">    <span class="keyword">private</span> ArrayList&lt;TriggerContentUri&gt; mTriggerContentUris;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> mTriggerContentUpdateDelay = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> mTriggerContentMaxDelay = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mIsPersisted;</span><br><span class="line">    <span class="comment">// One-off parameters.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> mMinLatencyMillis;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> mMaxExecutionDelayMillis;</span><br><span class="line">    <span class="comment">// Periodic parameters.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mIsPeriodic;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mHasEarlyConstraint;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mHasLateConstraint;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> mIntervalMillis;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> mFlexMillis;</span><br><span class="line">    <span class="comment">// Back-off parameters.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> mInitialBackoffMillis = DEFAULT_INITIAL_BACKOFF_MILLIS;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mBackoffPolicy = DEFAULT_BACKOFF_POLICY;</span><br><span class="line">    <span class="comment">/** Easy way to track whether the client has tried to set a back-off policy. */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mBackoffPolicySet = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Builder</span><span class="params">(<span class="keyword">int</span> jobId, ComponentName jobService)</span> </span>&#123;</span><br><span class="line">        mJobService = jobService;</span><br><span class="line">        mJobId = jobId;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ... ... ... ...  </span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>返回了 JobInfo 的内部类 Builder 的对象！</p>
<h4 id="1-1-3-2-buildConstraintsFromXml"><a href="#1-1-3-2-buildConstraintsFromXml" class="headerlink" title="1.1.3.2 buildConstraintsFromXml"></a>1.1.3.2 buildConstraintsFromXml</h4><p>传入参数：JobInfo.Buidlder 和 XmlPullParser ：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">buildConstraintsFromXml</span><span class="params">(JobInfo.Builder jobBuilder, XmlPullParser parser)</span> </span>&#123;</span><br><span class="line">     String val = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"connectivity"</span>);</span><br><span class="line">     <span class="keyword">if</span> (val != <span class="keyword">null</span>) &#123;</span><br><span class="line">         jobBuilder.setRequiredNetworkType(JobInfo.NETWORK_TYPE_ANY);</span><br><span class="line">     &#125;</span><br><span class="line">     val = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"unmetered"</span>);</span><br><span class="line">     <span class="keyword">if</span> (val != <span class="keyword">null</span>) &#123;</span><br><span class="line">         jobBuilder.setRequiredNetworkType(JobInfo.NETWORK_TYPE_UNMETERED);</span><br><span class="line">     &#125;</span><br><span class="line">     val = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"not-roaming"</span>);</span><br><span class="line">     <span class="keyword">if</span> (val != <span class="keyword">null</span>) &#123;</span><br><span class="line">         jobBuilder.setRequiredNetworkType(JobInfo.NETWORK_TYPE_NOT_ROAMING);</span><br><span class="line">     &#125;</span><br><span class="line">     val = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"idle"</span>);</span><br><span class="line">     <span class="keyword">if</span> (val != <span class="keyword">null</span>) &#123;</span><br><span class="line">         jobBuilder.setRequiresDeviceIdle(<span class="keyword">true</span>);</span><br><span class="line">     &#125;</span><br><span class="line">     val = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"charging"</span>);</span><br><span class="line">     <span class="keyword">if</span> (val != <span class="keyword">null</span>) &#123;</span><br><span class="line">         jobBuilder.setRequiresCharging(<span class="keyword">true</span>);</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<p>显然，这个方法也很简单，解析剩下的参数！</p>
<h4 id="1-1-3-3-buildExecutionTimesFromXml"><a href="#1-1-3-3-buildExecutionTimesFromXml" class="headerlink" title="1.1.3.3 buildExecutionTimesFromXml"></a>1.1.3.3 buildExecutionTimesFromXml</h4><p>计算这个 Job 的最早运行时间和最晚的结束时间：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">private</span> Pair&lt;Long, Long&gt; <span class="title">buildExecutionTimesFromXml</span><span class="params">(XmlPullParser parser)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> NumberFormatException </span>&#123;</span><br><span class="line">        <span class="comment">// Pull out execution time data.</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> nowWallclock = System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> nowElapsed = SystemClock.elapsedRealtime();</span><br><span class="line">        <span class="keyword">long</span> earliestRunTimeElapsed = JobStatus.NO_EARLIEST_RUNTIME;</span><br><span class="line">        <span class="keyword">long</span> latestRunTimeElapsed = JobStatus.NO_LATEST_RUNTIME;</span><br><span class="line">        String val = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"deadline"</span>);</span><br><span class="line">        <span class="keyword">if</span> (val != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">long</span> latestRuntimeWallclock = Long.valueOf(val);</span><br><span class="line">            <span class="keyword">long</span> maxDelayElapsed =</span><br><span class="line">                    Math.max(latestRuntimeWallclock - nowWallclock, <span class="number">0</span>);</span><br><span class="line">            latestRunTimeElapsed = nowElapsed + maxDelayElapsed;</span><br><span class="line">        &#125;</span><br><span class="line">        val = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"delay"</span>);</span><br><span class="line">        <span class="keyword">if</span> (val != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">long</span> earliestRuntimeWallclock = Long.valueOf(val);</span><br><span class="line">            <span class="keyword">long</span> minDelayElapsed =</span><br><span class="line">                    Math.max(earliestRuntimeWallclock - nowWallclock, <span class="number">0</span>);</span><br><span class="line">            earliestRunTimeElapsed = nowElapsed + minDelayElapsed;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Pair.create(earliestRunTimeElapsed, latestRunTimeElapsed);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>接着来看：</p>
<h4 id="1-1-3-4-maybeBuildBackoffPolicyFromXml"><a href="#1-1-3-4-maybeBuildBackoffPolicyFromXml" class="headerlink" title="1.1.3.4 maybeBuildBackoffPolicyFromXml"></a>1.1.3.4 maybeBuildBackoffPolicyFromXml</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">maybeBuildBackoffPolicyFromXml</span><span class="params">(JobInfo.Builder jobBuilder, XmlPullParser parser)</span> </span>&#123;</span><br><span class="line">    String val = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"initial-backoff"</span>);</span><br><span class="line">    <span class="keyword">if</span> (val != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">long</span> initialBackoff = Long.valueOf(val);</span><br><span class="line">        val = parser.getAttributeValue(<span class="keyword">null</span>, <span class="string">"backoff-policy"</span>);</span><br><span class="line">        <span class="keyword">int</span> backoffPolicy = Integer.parseInt(val);  <span class="comment">// Will throw NFE which we catch higher up.</span></span><br><span class="line">        jobBuilder.setBackoffCriteria(initialBackoff, backoffPolicy);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接着：</p>
<h4 id="1-1-3-5-PersistableBundle-restoreFromXml"><a href="#1-1-3-5-PersistableBundle-restoreFromXml" class="headerlink" title="1.1.3.5 PersistableBundle.restoreFromXml"></a>1.1.3.5 PersistableBundle.restoreFromXml</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** <span class="doctag">@hide</span> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> PersistableBundle <span class="title">restoreFromXml</span><span class="params">(XmlPullParser in)</span> <span class="keyword">throws</span> IOException,</span></span><br><span class="line"><span class="function">        XmlPullParserException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> outerDepth = in.getDepth();</span><br><span class="line">    <span class="keyword">final</span> String startTag = in.getName();</span><br><span class="line">    <span class="keyword">final</span> String[] tagName = <span class="keyword">new</span> String[<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">int</span> event;</span><br><span class="line">    <span class="keyword">while</span> (((event = in.next()) != XmlPullParser.END_DOCUMENT) &amp;&amp;</span><br><span class="line">            (event != XmlPullParser.END_TAG || in.getDepth() &lt; outerDepth)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (event == XmlPullParser.START_TAG) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> PersistableBundle((ArrayMap&lt;String, Object&gt;)</span><br><span class="line">                    XmlUtils.readThisArrayMapXml(in, startTag, tagName,</span><br><span class="line">                    <span class="keyword">new</span> MyReadMapCallback()));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> EMPTY;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接着：</p>
<h4 id="1-1-3-6-JobInfo-buidler-build"><a href="#1-1-3-6-JobInfo-buidler-build" class="headerlink" title="1.1.3.6 JobInfo.buidler.build"></a>1.1.3.6 JobInfo.buidler.build</h4><p>根据解析的结果，创建 <code>JobInfo</code> 对象，这里调用了 <code>JobInfo.buidler</code> 的 <code>build</code> 方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">... ... ... ...</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">public</span> JobInfo <span class="title">build</span><span class="params">()</span> </span>&#123;</span><br><span class="line">     <span class="comment">// Allow jobs with no constraints - What am I, a database?</span></span><br><span class="line">     <span class="keyword">if</span> (!mHasEarlyConstraint &amp;&amp; !mHasLateConstraint &amp;&amp; !mRequiresCharging &amp;&amp;</span><br><span class="line">             !mRequiresDeviceIdle &amp;&amp; mNetworkType == NETWORK_TYPE_NONE &amp;&amp;</span><br><span class="line">             mTriggerContentUris == <span class="keyword">null</span>) &#123;</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"You're trying to build a job with no "</span> +</span><br><span class="line">                 <span class="string">"constraints, this is not allowed."</span>);</span><br><span class="line">     &#125;</span><br><span class="line">     mExtras = <span class="keyword">new</span> PersistableBundle(mExtras);  <span class="comment">// Make our own copy.</span></span><br><span class="line">     <span class="comment">// Check that a deadline was not set on a periodic job.</span></span><br><span class="line">     <span class="keyword">if</span> (mIsPeriodic &amp;&amp; (mMaxExecutionDelayMillis != <span class="number">0L</span>)) &#123;</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Can't call setOverrideDeadline() on a "</span> +</span><br><span class="line">                 <span class="string">"periodic job."</span>);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">if</span> (mIsPeriodic &amp;&amp; (mMinLatencyMillis != <span class="number">0L</span>)) &#123;</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Can't call setMinimumLatency() on a "</span> +</span><br><span class="line">                 <span class="string">"periodic job"</span>);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">if</span> (mIsPeriodic &amp;&amp; (mTriggerContentUris != <span class="keyword">null</span>)) &#123;</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Can't call addTriggerContentUri() on a "</span> +</span><br><span class="line">                 <span class="string">"periodic job"</span>);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">if</span> (mIsPersisted &amp;&amp; (mTriggerContentUris != <span class="keyword">null</span>)) &#123;</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Can't call addTriggerContentUri() on a "</span> +</span><br><span class="line">                 <span class="string">"persisted job"</span>);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">if</span> (mBackoffPolicySet &amp;&amp; mRequiresDeviceIdle) &#123;</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"An idle mode job will not respect any"</span> +</span><br><span class="line">                 <span class="string">" back-off policy, so calling setBackoffCriteria with"</span> +</span><br><span class="line">                 <span class="string">" setRequiresDeviceIdle is an error."</span>);</span><br><span class="line">     &#125;</span><br><span class="line">     JobInfo job = <span class="keyword">new</span> JobInfo(<span class="keyword">this</span>);</span><br><span class="line">     <span class="keyword">if</span> (job.isPeriodic()) &#123;</span><br><span class="line">         <span class="keyword">if</span> (job.intervalMillis != job.getIntervalMillis()) &#123;</span><br><span class="line">             StringBuilder builder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">             builder.append(<span class="string">"Specified interval for "</span>)</span><br><span class="line">                     .append(String.valueOf(mJobId))</span><br><span class="line">                     .append(<span class="string">" is "</span>);</span><br><span class="line">             formatDuration(mIntervalMillis, builder);</span><br><span class="line">             builder.append(<span class="string">". Clamped to "</span>);</span><br><span class="line">             formatDuration(job.getIntervalMillis(), builder);</span><br><span class="line">             Log.w(TAG, builder.toString());</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">if</span> (job.flexMillis != job.getFlexMillis()) &#123;</span><br><span class="line">             StringBuilder builder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">             builder.append(<span class="string">"Specified flex for "</span>)</span><br><span class="line">                     .append(String.valueOf(mJobId))</span><br><span class="line">                     .append(<span class="string">" is "</span>);</span><br><span class="line">             formatDuration(mFlexMillis, builder);</span><br><span class="line">             builder.append(<span class="string">". Clamped to "</span>);</span><br><span class="line">             formatDuration(job.getFlexMillis(), builder);</span><br><span class="line">             Log.w(TAG, builder.toString());</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">return</span> job;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> ... ... ... ...</span><br></pre></td></tr></table></figure></p>
<p>这里返回了 <code>JobInfo</code> 对象！</p>
<h4 id="1-1-3-7-new-JobStatus"><a href="#1-1-3-7-new-JobStatus" class="headerlink" title="1.1.3.7 new JobStatus"></a>1.1.3.7 new JobStatus</h4><p>最后，根据创建的 <code>JobInfo</code> 对象和前面的解析结果，创建 <code>JobStatus</code> 对象！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">JobStatus</span><span class="params">(JobInfo job, <span class="keyword">int</span> callingUid, String sourcePackageName, <span class="keyword">int</span> sourceUserId,</span></span></span><br><span class="line"><span class="function"><span class="params">        String sourceTag, <span class="keyword">long</span> earliestRunTimeElapsedMillis, <span class="keyword">long</span> latestRunTimeElapsedMillis)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(job, callingUid, sourcePackageName, sourceUserId, sourceTag, <span class="number">0</span>,</span><br><span class="line">            earliestRunTimeElapsedMillis, latestRunTimeElapsedMillis);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个构造器调用了下面这个：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">JobStatus</span><span class="params">(JobInfo job, <span class="keyword">int</span> callingUid, String sourcePackageName,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> sourceUserId, String tag, <span class="keyword">int</span> numFailures, <span class="keyword">long</span> earliestRunTimeElapsedMillis,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">long</span> latestRunTimeElapsedMillis)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.job = job;</span><br><span class="line">    <span class="keyword">this</span>.callingUid = callingUid;</span><br><span class="line">    <span class="keyword">int</span> tempSourceUid = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (sourceUserId != -<span class="number">1</span> &amp;&amp; sourcePackageName != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            tempSourceUid = AppGlobals.getPackageManager().getPackageUid(sourcePackageName, <span class="number">0</span>,</span><br><span class="line">                    sourceUserId);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">            <span class="comment">// Can't happen, PackageManager runs in the same process.</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (tempSourceUid == -<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.sourceUid = callingUid;</span><br><span class="line">        <span class="keyword">this</span>.sourceUserId = UserHandle.getUserId(callingUid);</span><br><span class="line">        <span class="keyword">this</span>.sourcePackageName = job.getService().getPackageName();</span><br><span class="line">        <span class="keyword">this</span>.sourceTag = <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.sourceUid = tempSourceUid;</span><br><span class="line">        <span class="keyword">this</span>.sourceUserId = sourceUserId;</span><br><span class="line">        <span class="keyword">this</span>.sourcePackageName = sourcePackageName;</span><br><span class="line">        <span class="keyword">this</span>.sourceTag = tag;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.batteryName = <span class="keyword">this</span>.sourceTag != <span class="keyword">null</span></span><br><span class="line">            ? <span class="keyword">this</span>.sourceTag + <span class="string">":"</span> + job.getService().getPackageName()</span><br><span class="line">            : job.getService().flattenToShortString();</span><br><span class="line">    <span class="keyword">this</span>.tag = <span class="string">"*job*/"</span> + <span class="keyword">this</span>.batteryName;</span><br><span class="line">    <span class="keyword">this</span>.earliestRunTimeElapsedMillis = earliestRunTimeElapsedMillis;</span><br><span class="line">    <span class="keyword">this</span>.latestRunTimeElapsedMillis = latestRunTimeElapsedMillis;</span><br><span class="line">    <span class="keyword">this</span>.numFailures = numFailures;</span><br><span class="line">    <span class="keyword">int</span> requiredConstraints = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (job.getNetworkType() == JobInfo.NETWORK_TYPE_ANY) &#123;</span><br><span class="line">        requiredConstraints |= CONSTRAINT_CONNECTIVITY;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (job.getNetworkType() == JobInfo.NETWORK_TYPE_UNMETERED) &#123;</span><br><span class="line">        requiredConstraints |= CONSTRAINT_UNMETERED;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (job.getNetworkType() == JobInfo.NETWORK_TYPE_NOT_ROAMING) &#123;</span><br><span class="line">        requiredConstraints |= CONSTRAINT_NOT_ROAMING;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (job.isRequireCharging()) &#123;</span><br><span class="line">        requiredConstraints |= CONSTRAINT_CHARGING;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (earliestRunTimeElapsedMillis != NO_EARLIEST_RUNTIME) &#123;</span><br><span class="line">        requiredConstraints |= CONSTRAINT_TIMING_DELAY;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (latestRunTimeElapsedMillis != NO_LATEST_RUNTIME) &#123;</span><br><span class="line">        requiredConstraints |= CONSTRAINT_DEADLINE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (job.isRequireDeviceIdle()) &#123;</span><br><span class="line">        requiredConstraints |= CONSTRAINT_IDLE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (job.getTriggerContentUris() != <span class="keyword">null</span>) &#123;</span><br><span class="line">        requiredConstraints |= CONSTRAINT_CONTENT_TRIGGER;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.requiredConstraints = requiredConstraints;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>暂时看到这里！</p>
<h2 id="1-2-JobHandler"><a href="#1-2-JobHandler" class="headerlink" title="1.2 JobHandler"></a>1.2 JobHandler</h2><p>接下来，我们来看看 <code>JobHander</code> 的消息处理：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">JobHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JobHandler</span><span class="params">(Looper looper)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(looper);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">            <span class="comment">// 在系统刚刚启动的时候，mReadyToRock 的值为 false，当系统启动到 phase 600，则 mReadyToRock=true.</span></span><br><span class="line">            <span class="keyword">if</span> (!mReadyToRock) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">switch</span> (message.what) &#123;</span><br><span class="line">            <span class="keyword">case</span> MSG_JOB_EXPIRED:</span><br><span class="line">                <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">                    JobStatus runNow = (JobStatus) message.obj;</span><br><span class="line">                    <span class="comment">// runNow can be null, which is a controller's way of indicating that its</span></span><br><span class="line">                    <span class="comment">// state is such that all ready jobs should be run immediately.</span></span><br><span class="line">                    <span class="keyword">if</span> (runNow != <span class="keyword">null</span> &amp;&amp; !mPendingJobs.contains(runNow)</span><br><span class="line">                            &amp;&amp; mJobs.containsJob(runNow)) &#123;</span><br><span class="line">                        mJobPackageTracker.notePending(runNow);</span><br><span class="line">                        mPendingJobs.add(runNow);</span><br><span class="line">                    &#125;</span><br><span class="line">                    queueReadyJobsForExecutionLockedH();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> MSG_CHECK_JOB: <span class="comment">// 检查任务</span></span><br><span class="line">                <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (mReportedActive) &#123;</span><br><span class="line">                        <span class="comment">// if jobs are currently being run, queue all ready jobs for execution.</span></span><br><span class="line">                        queueReadyJobsForExecutionLockedH();</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">// Check the list of jobs and run some of them if we feel inclined.</span></span><br><span class="line">                        maybeQueueReadyJobsForExecutionLockedH();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> MSG_CHECK_JOB_GREEDY:</span><br><span class="line">                <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">                    queueReadyJobsForExecutionLockedH();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> MSG_STOP_JOB: <span class="comment">// 停止任务</span></span><br><span class="line">                cancelJobImpl((JobStatus)message.obj, <span class="keyword">null</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        maybeRunPendingJobsH();</span><br><span class="line">        <span class="comment">// Don't remove JOB_EXPIRED in case one came along while processing the queue.</span></span><br><span class="line">        removeMessages(MSG_CHECK_JOB);</span><br><span class="line">    &#125;</span><br><span class="line">    ... ... ... ...</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ReadyJobQueueFunctor mReadyQueueFunctor = <span class="keyword">new</span> ReadyJobQueueFunctor();</span><br><span class="line">    ... ... ... ...</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MaybeReadyJobQueueFunctor mMaybeQueueFunctor = <span class="keyword">new</span> MaybeReadyJobQueueFunctor();</span><br><span class="line">    ... ... ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这里，我们省略了一些方法，以后再慢慢分析！</p>
<h2 id="1-3-Controllers"><a href="#1-3-Controllers" class="headerlink" title="1.3 Controllers"></a>1.3 Controllers</h2><p>对于控制器，后面会有单独的博文详细分析，这里我们先看看 <code>ConnectivityController</code>!!</p>
<h3 id="1-3-1-ConnectivityController"><a href="#1-3-1-ConnectivityController" class="headerlink" title="1.3.1 ConnectivityController"></a>1.3.1 ConnectivityController</h3><p>我们先来看一个控制器 <code>ConnectivityController</code>，先来看看他的代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConnectivityController</span> <span class="keyword">extends</span> <span class="title">StateController</span> <span class="keyword">implements</span></span></span><br><span class="line"><span class="class">        <span class="title">ConnectivityManager</span>.<span class="title">OnNetworkActiveListener</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"JobScheduler.Conn"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConnectivityManager mConnManager;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> NetworkPolicyManager mNetPolicyManager;</span><br><span class="line">    <span class="meta">@GuardedBy</span>(<span class="string">"mLock"</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ArrayList&lt;JobStatus&gt; mTrackedJobs = <span class="keyword">new</span> ArrayList&lt;JobStatus&gt;();</span><br><span class="line">    <span class="comment">/** Singleton. */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ConnectivityController mSingleton;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Object sCreationLock = <span class="keyword">new</span> Object();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ConnectivityController <span class="title">get</span><span class="params">(JobSchedulerService jms)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (sCreationLock) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mSingleton == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mSingleton = <span class="keyword">new</span> ConnectivityController(jms, jms.getContext(), jms.getLock());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> mSingleton;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">ConnectivityController</span><span class="params">(StateChangedListener stateChangedListener, Context context,</span></span></span><br><span class="line"><span class="function"><span class="params">            Object lock)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(stateChangedListener, context, lock);</span><br><span class="line">        mConnManager = mContext.getSystemService(ConnectivityManager.class);</span><br><span class="line">        mNetPolicyManager = mContext.getSystemService(NetworkPolicyManager.class);</span><br><span class="line">        <span class="comment">// 注册监听网络连接状态的广播，且采用 BackgroundThread 线程</span></span><br><span class="line">        <span class="keyword">final</span> IntentFilter intentFilter = <span class="keyword">new</span> IntentFilter(ConnectivityManager.CONNECTIVITY_ACTION);</span><br><span class="line">        mContext.registerReceiverAsUser(</span><br><span class="line">                mConnectivityReceiver, UserHandle.SYSTEM, intentFilter, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">        mNetPolicyManager.registerListener(mNetPolicyListener);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>当监听到 <code>CONNECTIVITY_ACTION</code> 广播，<code>onReceive</code> 方法的执行位于 <code>“android.bg”</code> 线程。<br>其他的控制器很类似，我们在后面的文章中，会集中分析这些控制器！</p>
<h2 id="1-4-JobSchedulerStub"><a href="#1-4-JobSchedulerStub" class="headerlink" title="1.4 JobSchedulerStub"></a>1.4 JobSchedulerStub</h2><p><code>JobSchedulerStub</code> 继承了 <code>IJobScheduler.Stub</code>，作为 <code>Binder</code> 机制的服务端的桩对象，为 <code>Binder</code> 客户端提供服务！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">JobSchedulerStub</span> <span class="keyword">extends</span> <span class="title">IJobScheduler</span>.<span class="title">Stub</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SparseArray&lt;Boolean&gt; mPersistCache = <span class="keyword">new</span> SparseArray&lt;Boolean&gt;();</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">enforceValidJobRequest</span><span class="params">(<span class="keyword">int</span> uid, JobInfo job)</span> </span>&#123;</span><br><span class="line">        ... ... ... ... ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">canPersistJobs</span><span class="params">(<span class="keyword">int</span> pid, <span class="keyword">int</span> uid)</span> </span>&#123;</span><br><span class="line">        ... ... ... ... ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// IJobScheduler implementation</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">schedule</span><span class="params">(JobInfo job)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        ... ... ... ... ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">scheduleAsPackage</span><span class="params">(JobInfo job, String packageName, <span class="keyword">int</span> userId, String tag)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        ... ... ... ... ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;JobInfo&gt; <span class="title">getAllPendingJobs</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        ... ... ... ... ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JobInfo <span class="title">getPendingJob</span><span class="params">(<span class="keyword">int</span> jobId)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        ... ... ... ... ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancelAll</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        ... ... ... ... ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancel</span><span class="params">(<span class="keyword">int</span> jobId)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        ... ... ... ... ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * "dumpsys" infrastructure</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dump</span><span class="params">(FileDescriptor fd, PrintWriter pw, String[] args)</span> </span>&#123;</span><br><span class="line">        ... ... ... ... ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onShellCommand</span><span class="params">(FileDescriptor in, FileDescriptor out, FileDescriptor err,</span></span></span><br><span class="line"><span class="function"><span class="params">            String[] args, ResultReceiver resultReceiver)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        ... ... ... ... ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>我们简单的分析下上面的方法：</p>
<h3 id="1-4-1-enforceValidJobRequest"><a href="#1-4-1-enforceValidJobRequest" class="headerlink" title="1.4.1 enforceValidJobRequest"></a>1.4.1 enforceValidJobRequest</h3><p>当一个应用想通过 <code>JobScheduler</code> 来注册一个任务的时候，需要实现一个服务：<code>JobService</code>，当任务注册到 <code>JobScheduler</code> 后，<code>JobScheduler</code> 通过注册时，设置的条件，当满足条件时，就调用 <code>onJobStart</code> 方法拉起 <code>JobService</code> 来执行任务；当不满足条件，就调用 <code>onJobStop</code> 方法，挂起 <code>JobService</code> 来停止任务！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">enforceValidJobRequest</span><span class="params">(<span class="keyword">int</span> uid, JobInfo job)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> IPackageManager pm = AppGlobals.getPackageManager();</span><br><span class="line">    <span class="keyword">final</span> ComponentName service = job.getService();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ServiceInfo si = pm.getServiceInfo(service,</span><br><span class="line">                PackageManager.MATCH_DIRECT_BOOT_AWARE</span><br><span class="line">                        | PackageManager.MATCH_DIRECT_BOOT_UNAWARE,</span><br><span class="line">                UserHandle.getUserId(uid));</span><br><span class="line">        <span class="keyword">if</span> (si == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"No such service "</span> + service);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (si.applicationInfo.uid != uid) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"uid "</span> + uid +</span><br><span class="line">                    <span class="string">" cannot schedule job in "</span> + service.getPackageName());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!JobService.PERMISSION_BIND.equals(si.permission)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Scheduled service "</span> + service</span><br><span class="line">                    + <span class="string">" does not require android.permission.BIND_JOB_SERVICE permission"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="comment">// Can't happen; the Package Manager is in this same process</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这个方法主要的作用是校验如下几项：<br>1、是否有这个 <code>JobService</code>，<br>2、<code>JobService</code> 的 <code>uid</code> 是否等于调用者的 <code>uid</code>，就是说，这个 <code>JobService</code> 是否属于这个应用！<br>2、<code>JobService</code> 是否在 <code>AndroidManifest.xml</code> 文件中配置了相应的权限：</p>
<h3 id="1-4-2-canPersistJobs"><a href="#1-4-2-canPersistJobs" class="headerlink" title="1.4.2 canPersistJobs"></a>1.4.2 canPersistJobs</h3><p>判断应用是否有 <code>android.Manifest.permission.RECEIVE_BOOT_COMPLETED</code> 的权限，如果有这个权限的话，设备重启后，能够保留该应用的任务！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">canPersistJobs</span><span class="params">(<span class="keyword">int</span> pid, <span class="keyword">int</span> uid)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> canPersist;</span><br><span class="line">    <span class="keyword">synchronized</span> (mPersistCache) &#123;</span><br><span class="line">        Boolean cached = mPersistCache.get(uid);</span><br><span class="line">        <span class="keyword">if</span> (cached != <span class="keyword">null</span>) &#123;</span><br><span class="line">            canPersist = cached.booleanValue();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Persisting jobs is tantamount to running at boot, so we permit</span></span><br><span class="line">            <span class="comment">// it when the app has declared that it uses the RECEIVE_BOOT_COMPLETED</span></span><br><span class="line">            <span class="comment">// permission</span></span><br><span class="line">            <span class="keyword">int</span> result = getContext().checkPermission(</span><br><span class="line">                    android.Manifest.permission.RECEIVE_BOOT_COMPLETED, pid, uid);</span><br><span class="line">            canPersist = (result == PackageManager.PERMISSION_GRANTED);</span><br><span class="line">            mPersistCache.put(uid, canPersist);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> canPersist;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>最终的结果会保存在 <code>mPersistCache</code> 集合中！</p>
<h3 id="1-4-3-schedule"><a href="#1-4-3-schedule" class="headerlink" title="1.4.3 schedule"></a>1.4.3 schedule</h3><p>这个方法是我们最常用的，来注册Job的！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 我们是实际上调用的是这个方法！</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">schedule</span><span class="params">(JobInfo job)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">        Slog.d(TAG, <span class="string">"Scheduling job: "</span> + job.toString());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获得调用方的 pid 和 uid！</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> pid = Binder.getCallingPid();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> uid = Binder.getCallingUid();</span><br><span class="line">    <span class="comment">// 校验操作</span></span><br><span class="line">    enforceValidJobRequest(uid, job);</span><br><span class="line">    <span class="comment">// 如果这个Job是重启后可保留的，检查权限！</span></span><br><span class="line">    <span class="keyword">if</span> (job.isPersisted()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!canPersistJobs(pid, uid)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Error: requested job be persisted without"</span></span><br><span class="line">                    + <span class="string">" holding RECEIVE_BOOT_COMPLETED permission."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">long</span> ident = Binder.clearCallingIdentity();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> JobSchedulerService.<span class="keyword">this</span>.schedule(job, uid);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Binder.restoreCallingIdentity(ident);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>最后 调用服务端的 <code>schedule</code> 方法继续注册！</p>
<h3 id="1-4-4-scheduleAsPackage"><a href="#1-4-4-scheduleAsPackage" class="headerlink" title="1.4.4 scheduleAsPackage"></a>1.4.4 scheduleAsPackage</h3><p>接下来，我们来看一个和 schedule 方法很类似的方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">scheduleAsPackage</span><span class="params">(JobInfo job, String packageName, <span class="keyword">int</span> userId, String tag)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> callerUid = Binder.getCallingUid();</span><br><span class="line">    <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">        Slog.d(TAG, <span class="string">"Caller uid "</span> + callerUid + <span class="string">" scheduling job: "</span> + job.toString()</span><br><span class="line">                + <span class="string">" on behalf of "</span> + packageName);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (packageName == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"Must specify a package for scheduleAsPackage()"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> mayScheduleForOthers = getContext().checkCallingOrSelfPermission(</span><br><span class="line">            android.Manifest.permission.UPDATE_DEVICE_STATS);</span><br><span class="line">    <span class="keyword">if</span> (mayScheduleForOthers != PackageManager.PERMISSION_GRANTED) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"Caller uid "</span> + callerUid</span><br><span class="line">                + <span class="string">" not permitted to schedule jobs for other apps"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((job.getFlags() &amp; JobInfo.FLAG_WILL_BE_FOREGROUND) != <span class="number">0</span>) &#123;</span><br><span class="line">        getContext().enforceCallingOrSelfPermission(</span><br><span class="line">                android.Manifest.permission.CONNECTIVITY_INTERNAL, TAG);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">long</span> ident = Binder.clearCallingIdentity();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> JobSchedulerService.<span class="keyword">this</span>.scheduleAsPackage(job, callerUid,</span><br><span class="line">                packageName, userId, tag);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Binder.restoreCallingIdentity(ident);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>最后 调用服务端的 <code>scheduleAsPackage</code> 方法继续注册！</p>
<h3 id="1-4-5-getXXXPendingJobs"><a href="#1-4-5-getXXXPendingJobs" class="headerlink" title="1.4.5 getXXXPendingJobs"></a>1.4.5 getXXXPendingJobs</h3><p>下面来看这两个方法：<br><code>getAllPendingJobs</code>：获得应用注册的所有的正在等待的 <code>Job</code>！<br><code>getPendingJob</code>：获得应用程序注册的 <code>jobId</code> 指定的正在等待的 <code>Job</code>！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;JobInfo&gt; <span class="title">getAllPendingJobs</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> uid = Binder.getCallingUid();</span><br><span class="line">    <span class="keyword">long</span> ident = Binder.clearCallingIdentity();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> JobSchedulerService.<span class="keyword">this</span>.getPendingJobs(uid);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Binder.restoreCallingIdentity(ident);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> JobInfo <span class="title">getPendingJob</span><span class="params">(<span class="keyword">int</span> jobId)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> uid = Binder.getCallingUid();</span><br><span class="line">    <span class="keyword">long</span> ident = Binder.clearCallingIdentity();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> JobSchedulerService.<span class="keyword">this</span>.getPendingJob(uid, jobId);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Binder.restoreCallingIdentity(ident);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>最后 调用服务端的 <code>scheduleAsPackage</code> 方法!</p>
<h3 id="1-4-6-cancelXXX"><a href="#1-4-6-cancelXXX" class="headerlink" title="1.4.6 cancelXXX"></a>1.4.6 cancelXXX</h3><p>接着是取消任务的相关方法：</p>
<ul>
<li><code>cancelAll</code>：取消应用注册的所有任务！</li>
<li><code>cancel</code>：取消 <code>jobId</code> 对应的任务！</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancelAll</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> uid = Binder.getCallingUid();</span><br><span class="line">    <span class="keyword">long</span> ident = Binder.clearCallingIdentity();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        JobSchedulerService.<span class="keyword">this</span>.cancelJobsForUid(uid, <span class="keyword">true</span>);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Binder.restoreCallingIdentity(ident);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cancel</span><span class="params">(<span class="keyword">int</span> jobId)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> uid = Binder.getCallingUid();</span><br><span class="line">    <span class="keyword">long</span> ident = Binder.clearCallingIdentity();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        JobSchedulerService.<span class="keyword">this</span>.cancelJob(uid, jobId);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Binder.restoreCallingIdentity(ident);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后分别调用的是客户端的 <code>cancelJobForUid</code> 方法和 <code>cancelJob</code> 方法！</p>
<h3 id="1-4-7-dump"><a href="#1-4-7-dump" class="headerlink" title="1.4.7 dump"></a>1.4.7 dump</h3><p>这个方法是用来为控制台 <code>dumpsys</code> 命令提供数据的：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dump</span><span class="params">(FileDescriptor fd, PrintWriter pw, String[] args)</span> </span>&#123;</span><br><span class="line">    getContext().enforceCallingOrSelfPermission(android.Manifest.permission.DUMP, TAG);</span><br><span class="line">    <span class="keyword">long</span> identityToken = Binder.clearCallingIdentity();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        JobSchedulerService.<span class="keyword">this</span>.dumpInternal(pw, args);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Binder.restoreCallingIdentity(identityToken);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>接着看：</p>
<h3 id="1-4-8-onShellCommand"><a href="#1-4-8-onShellCommand" class="headerlink" title="1.4.8 onShellCommand"></a>1.4.8 onShellCommand</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onShellCommand</span><span class="params">(FileDescriptor in, FileDescriptor out, FileDescriptor err,</span></span></span><br><span class="line"><span class="function"><span class="params">        String[] args, ResultReceiver resultReceiver)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        (<span class="keyword">new</span> JobSchedulerShellCommand(JobSchedulerService.<span class="keyword">this</span>)).exec(</span><br><span class="line">                <span class="keyword">this</span>, in, out, err, args, resultReceiver);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="2-onStart"><a href="#2-onStart" class="headerlink" title="2 onStart"></a>2 onStart</h1><p>在 <code>onStart</code> 方法中，又调用了如下的方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    publishLocalService(JobSchedulerInternal.class, <span class="keyword">new</span> LocalService());</span><br><span class="line">    publishBinderService(Context.JOB_SCHEDULER_SERVICE, mJobSchedulerStub);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>主要有两个作用：</p>
<ul>
<li>公开本地服务：<code>LocalService</code>，类型为 <code>JobSchedulerInternal.class</code>，只能被系统进程访问。</li>
<li>公开 <code>Binder</code> 通信服务，名称为：<code>jobscheduler</code>，服务的实体对象是：<code>mJobSchedulerStub</code>，实现了 <code>IJobScheduler.Stub</code> 接口，其实就是将 <code>JobSchedulerService</code> 自身注册进 <code>SystemManager</code> 中，是其能被其他服务和应用访问到！</li>
</ul>
<p>接下来，我们一个一个来看：</p>
<h2 id="2-1-publishLocalService"><a href="#2-1-publishLocalService" class="headerlink" title="2.1 publishLocalService"></a>2.1 publishLocalService</h2><p>这个方法是继承自 SystemService 的：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">publishLocalService</span><span class="params">(Class&lt;T&gt; type, T service)</span> </span>&#123;</span><br><span class="line">    LocalServices.addService(type, service);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>调用了 <code>LocalServices</code>的静态方法，<code>addService</code>：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">LocalServices</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">LocalServices</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ArrayMap&lt;Class&lt;?&gt;, Object&gt; sLocalServiceObjects =</span><br><span class="line">            <span class="keyword">new</span> ArrayMap&lt;Class&lt;?&gt;, Object&gt;();</span><br><span class="line"></span><br><span class="line">    ... ... ... ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">addService</span><span class="params">(Class&lt;T&gt; type, T service)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (sLocalServiceObjects) &#123;</span><br><span class="line">            <span class="keyword">if</span> (sLocalServiceObjects.containsKey(type)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Overriding service registration"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            sLocalServiceObjects.put(type, service);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ... ... ... ...</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>接着来看：</p>
<h2 id="2-2-publishBinderService"><a href="#2-2-publishBinderService" class="headerlink" title="2.2 publishBinderService"></a>2.2 publishBinderService</h2><p>这个方法也是继承了 <code>SystemServer</code> 的方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">publishBinderService</span><span class="params">(String name, IBinder service)</span> </span>&#123;</span><br><span class="line">    publishBinderService(name, service, <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">publishBinderService</span><span class="params">(String name, IBinder service,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> allowIsolated)</span> </span>&#123;</span><br><span class="line">    ServiceManager.addService(name, service, allowIsolated);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>其实就是将自身加入到 <code>SystemManager</code> 中去！</p>
<h1 id="3-onBootPhase"><a href="#3-onBootPhase" class="headerlink" title="3 onBootPhase"></a>3 onBootPhase</h1><p>我们知道，设备在开机的时候，会处于不同的状态，在每个状态时，都要通知服务，服务会根据不同的状态，进行不同是开始初始化操作！！</p>
<h2 id="3-1-SystemServiceM-startBootPhase"><a href="#3-1-SystemServiceM-startBootPhase" class="headerlink" title="3.1 SystemServiceM.startBootPhase"></a>3.1 SystemServiceM.startBootPhase</h2><p>具体的调用在这里：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startBootPhase</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> phase)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (phase &lt;= mCurrentPhase) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Next phase must be larger than previous"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    mCurrentPhase = phase;</span><br><span class="line"></span><br><span class="line">    Slog.i(TAG, <span class="string">"Starting phase "</span> + mCurrentPhase);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Trace.traceBegin(Trace.TRACE_TAG_SYSTEM_SERVER, <span class="string">"OnBootPhase "</span> + phase);</span><br><span class="line">        <span class="comment">// 遍历所有的系统服务！</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> serviceLen = mServices.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; serviceLen; i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> SystemService service = mServices.get(i);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//【1】调用服务的 onBootPhase 方法！</span></span><br><span class="line">                service.onBootPhase(mCurrentPhase);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Failed to boot service "</span></span><br><span class="line">                        + service.getClass().getName()</span><br><span class="line">                        + <span class="string">": onBootPhase threw an exception during phase "</span></span><br><span class="line">                        + mCurrentPhase, ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Trace.traceEnd(Trace.TRACE_TAG_SYSTEM_SERVER);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>对于 <code>JobSchedulerService</code> 服务，他需要在如下的 <code>2</code> 个阶段进行初始化！<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// 表示系统服务已经准备好了！</span><br><span class="line">public static final int PHASE_SYSTEM_SERVICES_READY = 500;</span><br><span class="line">// 表示第三方应用已经可以启动了！</span><br><span class="line">public static final int PHASE_THIRD_PARTY_APPS_CAN_START = 600;</span><br></pre></td></tr></table></figure></p>
<p>我们来看看 <code>JobSchedulerService</code> 在不同的状态下做了什么初始化：</p>
<h2 id="3-2-JobSchedulerS-onBootPhase"><a href="#3-2-JobSchedulerS-onBootPhase" class="headerlink" title="3.2 JobSchedulerS.onBootPhase"></a>3.2 JobSchedulerS.onBootPhase</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onBootPhase</span><span class="params">(<span class="keyword">int</span> phase)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//【1】500，表示系统服务准备就绪。</span></span><br><span class="line">    <span class="keyword">if</span> (PHASE_SYSTEM_SERVICES_READY == phase) &#123; </span><br><span class="line">        mConstants.start(getContext().getContentResolver());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【1.1】注册第一个 BroadcastReceiver，监听 package 的操作！</span></span><br><span class="line">        <span class="keyword">final</span> IntentFilter filter = <span class="keyword">new</span> IntentFilter();</span><br><span class="line">        filter.addAction(Intent.ACTION_PACKAGE_REMOVED);</span><br><span class="line">        filter.addAction(Intent.ACTION_PACKAGE_CHANGED);</span><br><span class="line">        filter.addAction(Intent.ACTION_PACKAGE_RESTARTED);</span><br><span class="line">        filter.addAction(Intent.ACTION_QUERY_PACKAGE_RESTART);</span><br><span class="line">        filter.addDataScheme(<span class="string">"package"</span>);</span><br><span class="line">        getContext().registerReceiverAsUser(</span><br><span class="line">                mBroadcastReceiver, UserHandle.ALL, filter, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//【1.2】注册第二个 BroadcastReceiver，监听 user 的移除操作！</span></span><br><span class="line">        <span class="keyword">final</span> IntentFilter userFilter = <span class="keyword">new</span> IntentFilter(Intent.ACTION_USER_REMOVED);</span><br><span class="line">        getContext().registerReceiverAsUser(</span><br><span class="line">                mBroadcastReceiver, UserHandle.ALL, userFilter, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        mPowerManager = (PowerManager)getContext().getSystemService(Context.POWER_SERVICE);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 注册 uid 观察者，用于回调！</span></span><br><span class="line">            ActivityManagerNative.getDefault().registerUidObserver(mUidObserver,</span><br><span class="line">                    ActivityManager.UID_OBSERVER_PROCSTATE | ActivityManager.UID_OBSERVER_GONE</span><br><span class="line">                    | ActivityManager.UID_OBSERVER_IDLE);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            <span class="comment">// ignored; both services live in system_server</span></span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//【2】600，表示三方应用已经可以被启动了！</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (phase == PHASE_THIRD_PARTY_APPS_CAN_START) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">            <span class="comment">// JobSchedulerService 已经准备好了！</span></span><br><span class="line">            mReadyToRock = <span class="keyword">true</span>; </span><br><span class="line">            mBatteryStats = IBatteryStats.Stub.asInterface(ServiceManager.getService(</span><br><span class="line">                    BatteryStats.SERVICE_NAME));</span><br><span class="line">            <span class="comment">// 获得本地设备控制器!</span></span><br><span class="line">            mLocalDeviceIdleController</span><br><span class="line">                    = LocalServices.getService(DeviceIdleController.LocalService.class);</span><br><span class="line">            <span class="comment">// Create the "runners".</span></span><br><span class="line">            <span class="comment">//【2.1】初始化 JobServiceContext，最多允许一次执行 16 个任务！</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; MAX_JOB_CONTEXTS_COUNT; i++) &#123;</span><br><span class="line">                <span class="comment">// 需要被执行的任务，都会保存到 JobServiceContext 对象中！</span></span><br><span class="line">                mActiveServices.add(</span><br><span class="line">                        <span class="keyword">new</span> JobServiceContext(<span class="keyword">this</span>, mBatteryStats, mJobPackageTracker,</span><br><span class="line">                                getContext().getMainLooper()));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Attach jobs to their controllers.</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 将每个任务绑定到对应的控制器中。</span></span><br><span class="line">            mJobs.forEachJob(<span class="keyword">new</span> JobStatusFunctor() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(JobStatus job)</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> controller = <span class="number">0</span>; controller &lt; mControllers.size(); controller++) &#123;</span><br><span class="line">                        <span class="keyword">final</span> StateController sc = mControllers.get(controller);</span><br><span class="line">                        sc.maybeStartTrackingJobLocked(job, <span class="keyword">null</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//【2.2】发送 MSG_CHECK_JOB 消息给 JobHandler，检查并执行任务！</span></span><br><span class="line">            mHandler.obtainMessage(MSG_CHECK_JOB).sendToTarget();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的是根据开机的阶段，进行不同的初始化操作，这里我们来看看 <code>JobServiceContext</code>！</p>
<h2 id="3-3-JobServiceContext"><a href="#3-3-JobServiceContext" class="headerlink" title="3.3 JobServiceContext"></a>3.3 JobServiceContext</h2><p>创建 <code>JobServiceContext</code> 对象，参数传递：</p>
<ul>
<li><code>Context context</code>：                        <code>JobSchedulerService.getContext</code>。</li>
<li><code>Object lock</code>：                            <code>JobSchedulerService.getObject</code>。</li>
<li><code>IBatteryStats batteryStats</code>：             <code>JobSchedulerService.mBatteryStats</code>。</li>
<li><code>JobPackageTracker tracker</code>：              <code>JobSchedulerService.tracker</code>。</li>
<li><code>JobCompletedListener completedListener</code>： <code>JobSchedulerService</code>，其本身实现了这个接口。</li>
<li><code>Looper looper</code>：                          <code>getContext().getMainLooper()</code>，<code>JobSchedulerService</code> 所在主线程的 <code>Looper</code>。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">JobServiceContext(JobSchedulerService service, IBatteryStats batteryStats,</span><br><span class="line">        JobPackageTracker tracker, Looper looper) &#123;</span><br><span class="line">    <span class="keyword">this</span>(service.getContext(), service.getLock(), batteryStats, tracker, service, looper);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@VisibleForTesting</span></span><br><span class="line">JobServiceContext(Context context, Object lock, IBatteryStats batteryStats,</span><br><span class="line">        JobPackageTracker tracker, JobCompletedListener completedListener, Looper looper) &#123;</span><br><span class="line">    mContext = context;</span><br><span class="line">    mLock = lock;</span><br><span class="line">    mBatteryStats = batteryStats;</span><br><span class="line">    mJobPackageTracker = tracker;</span><br><span class="line">    mCallbackHandler = <span class="keyword">new</span> JobServiceHandler(looper);</span><br><span class="line">    mCompletedListener = completedListener;</span><br><span class="line">    mAvailable = <span class="keyword">true</span>;</span><br><span class="line">    mVerb = VERB_FINISHED;</span><br><span class="line">    mPreferredUid = NO_PREFERRED_UID;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此处的 <code>JobServiceHandler</code> 绑定的是 <code>system_server</code> 进程的主线程。</p>
<h3 id="3-3-1-JobServiceHandler"><a href="#3-3-1-JobServiceHandler" class="headerlink" title="3.3.1 JobServiceHandler"></a>3.3.1 JobServiceHandler</h3><p>每一个 <code>JobServiceContext</code> 都有一个 <code>JobServiceHandler</code> 对象，<code>JobSchedulerService</code> 通过这个 <code>handler</code> 对象向 <code>JSC</code> 发送消息！<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">JobServiceHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">    JobServiceHandler(Looper looper) &#123;</span><br><span class="line">        <span class="keyword">super</span>(looper);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (message.what) &#123;</span><br><span class="line">            <span class="keyword">case</span> MSG_SERVICE_BOUND: <span class="comment">// 绑定 jobService 服务！</span></span><br><span class="line">                removeOpTimeOut();</span><br><span class="line">                handleServiceBoundH();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> MSG_CALLBACK: <span class="comment">// job 周期变化的回调！</span></span><br><span class="line">                <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                    Slog.d(TAG, <span class="string">"MSG_CALLBACK of : "</span> + mRunningJob</span><br><span class="line">                            + <span class="string">" v:"</span> + VERB_STRINGS[mVerb]);</span><br><span class="line">                &#125;</span><br><span class="line">                removeOpTimeOut();</span><br><span class="line">                <span class="keyword">if</span> (mVerb == VERB_STARTING) &#123;</span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">boolean</span> workOngoing = message.arg2 == <span class="number">1</span>;</span><br><span class="line">                    handleStartedH(workOngoing);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mVerb == VERB_EXECUTING ||</span><br><span class="line">                        mVerb == VERB_STOPPING) &#123;</span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">boolean</span> reschedule = message.arg2 == <span class="number">1</span>;</span><br><span class="line">                    handleFinishedH(reschedule);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                        Slog.d(TAG, <span class="string">"Unrecognised callback: "</span> + mRunningJob);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> MSG_CANCEL: <span class="comment">// 取消 job！</span></span><br><span class="line">                <span class="keyword">if</span> (mVerb == VERB_FINISHED) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                        Slog.d(TAG,</span><br><span class="line">                               <span class="string">"Trying to process cancel for torn-down context, ignoring."</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                mParams.setStopReason(message.arg1);</span><br><span class="line">                <span class="keyword">if</span> (message.arg1 == JobParameters.REASON_PREEMPT) &#123;</span><br><span class="line">                    mPreferredUid = mRunningJob != <span class="keyword">null</span> ? mRunningJob.getUid() :</span><br><span class="line">                            NO_PREFERRED_UID;</span><br><span class="line">                &#125;</span><br><span class="line">                handleCancelH();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> MSG_TIMEOUT: <span class="comment">// job 超时！</span></span><br><span class="line">                handleOpTimeoutH();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> MSG_SHUTDOWN_EXECUTION:</span><br><span class="line">                closeAndCleanupJobH(<span class="keyword">true</span> <span class="comment">/* needsReschedule */</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                Slog.e(TAG, <span class="string">"Unrecognised message: "</span> + message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ... ... ... ... ...</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>对于 <code>JobServiceHandler</code> 的细节，我们在后续的分析中会详细介绍，这里就不多说了！</p>
<h1 id="4-startUser"><a href="#4-startUser" class="headerlink" title="4 startUser"></a>4 startUser</h1><p>我们来看看 <code>startUser</code> 方法中的细节：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStartUser</span><span class="params">(<span class="keyword">int</span> userHandle)</span> </span>&#123;</span><br><span class="line">    mStartedUsers = ArrayUtils.appendInt(mStartedUsers, userHandle);</span><br><span class="line">    <span class="comment">// Let's kick any outstanding jobs for this user.</span></span><br><span class="line">    mHandler.obtainMessage(MSG_CHECK_JOB).sendToTarget();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>目的就是：为当前的用户执行 <code>job</code>！</p>
<h1 id="5-总结"><a href="#5-总结" class="headerlink" title="5 总结"></a>5 总结</h1><ol>
<li><code>JSS.JobHandler</code>：运行在 <code>system_server</code> 进程的主线程；</li>
<li><code>JobServiceContext.JobServiceHandler</code>：运行在 <code>system_server</code> 进程的主线程；</li>
<li><code>JobSchedulerStub</code>：作为实现接口 <code>IJobScheduler</code> 的 <code>binder</code> 服务端； </li>
<li><code>JobStore</code>：其成员变量 <code>mIoHandler</code> 运行在 <code>android.io</code> 线程； </li>
<li><code>JobStatus</code>：<code>JSS</code> 从 <code>/data/system/job/jobs.xml</code> 文件中读取每个 <code>JobInfo</code>，再解析成 <code>JobStatus</code> 对象，添加到 <code>mJobSet</code>。</li>
</ol>
<p>可见 <code>JobSchedulerService</code> 启动过程，最主要工作是从 <code>jobs.xml</code> 文件收集所有的需要重启保留的 <code>jobs</code>，放入到 <code>JobStore</code> 的成员变量 <code>mJobSet</code>。</p>
<p>我们来先简单的看看 <code>JobSchedulerService</code> 的类关系图：</p>
<p><img src="http://static.zybuluo.com/Coolqi/c61slx2h77tm99fmv0fo5g63/JobSchedulerService%E7%B1%BB%E5%9B%BE.png" alt="JobSchedulerService类图.png-1360.8kB"></p>
<p>哈哈，是不是蒙圈了呢？后面我会陆续分析的，这一篇就到这里，累死我了！ </p>
</div><hr></div><nav id="pagination"><div class="pagination"><a class="extend prev" rel="prev" href="/page/5/"><i class="fa fa-chevron-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/7/"><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2019 By Coolqi.Li</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv"><i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span><span></span></span><span class="footer-separator">|</span><span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.5.6"></script><script src="/js/fancybox.js?version=1.5.6"></script><script src="/js/sidebar.js?version=1.5.6"></script><script src="/js/copy.js?version=1.5.6"></script><script src="/js/fireworks.js?version=1.5.6"></script><script src="/js/transition.js?version=1.5.6"></script><script src="/js/scroll.js?version=1.5.6"></script><script src="/js/head.js?version=1.5.6"></script><script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"live2d-widget-model-hijiki"},"display":{"position":"right","width":110,"height":220},"mobile":{"show":false},"log":false});</script></body></html>